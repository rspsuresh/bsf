<link rel="stylesheet" href="<?php echo $this->basePath() . '/css/mms.css';?>"/>

<style>
    .mar_30{margin-top:30px;}
    .jqx-widget-content {z-index:999 !important;}
    .jqx-grid-header {height:40px !important;}
    .ovrcls .list-icon {
        border-radius: 100%;
        font-size: 32px;
        display:block;
        height: 60px;
        line-height: 55px;
        margin: auto;
        text-align: center;
        width: 60px;
        background:#fff;
    }
    .ovrcls:hover .oval1 { background: #2aabd2;color:#fff;}
    .ovrcls:hover .oval2 { background: #265a88;color:#fff;}
    .ovrcls:hover .oval3 { background: #419641;color:#fff;}
    .ovrcls:hover .oval4 { background: #cb3d39 ;color:#fff;}
    .ovrcls:hover .oval5 { background:	#ec9923 ;color:#fff;}
    .ovrcls:hover .oval6 { background:	#35f9a9 ;color:#fff;}
    .clrrndtxt					{font-size:15px; color:#1e1e1e;}
    .ovrcls .oval1 {border: 1px solid #2aabd2; color: #2aabd2;}
    .ovrcls .oval2{border: 1px solid #265a88; color: #265a88;}
    .ovrcls .oval3{border: 1px solid #419641 ;color: #419641;}
    .ovrcls .oval4{border: 1px solid #cb3d39;color: #cb3d39;}
    .ovrcls .oval5{border: 1px solid #ec9923;color: #ec9923;}
    .ovrcls .oval6{border: 1px solid #35f9a9;color: #35f9a9;}
    ul,li{list-style:none;}
    /*-----------------------inner module tab-----------------*/
    .innermdl_tabs												{background-color:#e7e9ec; border-bottom:1px solid #2d74b4 !important;border:0px;}
    .innermdl_tabs li											{margin:0px !important;width:16%!important;}
    .innermdl_tabs li a											{color:#212121;text-align:center;padding:10px 22px 8px 22px; font-size:13px; font-weight:600;display:block;border-radius: 0px;margin:0px;border-bottom:3px solid #e7e9ec;border-top:0px !important; border-right:0px !important;border-left:0px !important;}
    .innermdl_tabs li a:after									{content:''; width:1px; height:20px; background-color:#bccae7; position:absolute; right:0px;}
    .innermdl_tabs li:last-child a:after						{content:''; width:0px;}
    .innermdl_tabs li ul li a									{text-align:left;font-size:13px;border-bottom:0px !important;}
    .innermdl_tabs li ul li a:after								{background:none !important;}
    .innermdl_tabs>li>a:hover,.innermdl_tabs>li.active>a,.innermdl_tabs>li.active>a:focus,.innermdl_tabs>li.active>a:hover{background-color:#e1e3e7 !important;color:#3f6ac3;font-weight:600;border-bottom:3px solid #2d74b4 !important;border-top:0px !important; border-right:0px !important;border-left:0px !important;}
    .innermdl_tabs li a span									{color:#3f6ac3;padding:0px 10px 0px 0px;}

    /*---------------------Responsive css---------------------*/
    @media screen and (max-width:1280px)						         {
    }
    @media only screen and (min-width : 769px) and (max-width : 800px) {
    }
    @media screen and (min-width : 361px) and (max-width : 768px){
        .innermdl_tabs li				{margin:0px !important;width:100%!important;}
    }
    @media only screen and (min-width : 321px) and (max-width : 360px)	{
        .innermdl_tabs li				{margin:0px !important; width:100%!important;}
    }
    @media only screen and (width : 320px)  {
        .innermdl_tabs li				{ margin:0px !important;width:100%!important;}
    }
    @media only screen and (width : 480px)  {
        .innermdl_tabs li				{margin:0px !important; width:100%!important;}
    }
    @media only screen and (width : 640px)  {
        .innermdl_tabs li				{ margin:0px !important;}
    }
    @media only screen and (min-width : 320px) and (max-width : 1199px) 		{
        .innermdl_tabs li				{margin:0px !important;margin:0px !important;}
    }
    @media only screen and (min-width : 981px) and (max-width : 1024px) {
    }

    .innermdl_tabs li {width: 20%!important;}
</style>
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/library/jqwidgets/jqxgrid.grouping.js"></script>
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/library/jqwidgets/jqxgrid.aggregates.js"></script>
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/library/jqwidgets/jqx-all.js"></script>

<div class="col-lg-12 padlr0 " style="z-index: 999!important;">
    <nav class="navbar inrmdltab_navbar navbar-default">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle mdlnvbr_tgl collapsed ripple" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand inrmdl_navbrand ripple" href="javascript:void(0);">Select Menus</a>
        </div>
        <div id="navbar" class="navbar-collapse padlr0 collapse">
            <ul class="nav nav-tabs innermdl_tabs">
                <li id="potab" class="active"><a href="#dts" class="ripple" data-toggle="tab">Decision-PO Details</a></li>
                <li id="transtab" onclick="trtabclick();" ><a href="#whst" class="ripple" data-toggle="tab">Decision-Transfer Details</a></li>

            </ul>
        </div>
    </nav>
</div>

<div class="tab-content">

    <div class="tab-pane active" id="dts">
        <div class="col-lg-12 clear padlr0">
            <div class="table-responsive clear">
                <div style='margin-top:10px;' id="grdpodetails"> </div>
            </div>
        </div>
    </div>

    <div class="tab-pane active" id="whst">
        <div class="col-lg-12 clear">
            <div class="table-responsive clear">
                <div style='margin-top:10px;' id="grdtrdetails"> </div>
            </div>
        </div>
    </div>

</div>

<form method="post" action="<?php echo $this->basePath(); ?>/mms/purchase/order-entry/2/0" id="formWrapper">
    <div id="requestTransInputsWrapper" class="hide"></div>
    <input type="hidden" name="frm_index" value="1"/>
</form>

<form method="post" action="<?php echo $this->basePath(); ?>/mms/transfer/tventry/1/0" id="formWrapper1">
    <div id="requestTransInputsWrapper1" class="hide"></div>
    <input type="hidden" name="from_project" id="from_project" value=""/>
    <input type="hidden" name="frm_index" value="1"/>
</form>

<script type="text/javascript">
    var arr_Lists = <?php echo (isset($decDetails)) ? json_encode($decDetails) : '[]';?>;
    var arr_Lists1 = <?php echo (isset($dTransDetails)) ? json_encode($dTransDetails) : '[]';?>;
    var arr_transfer = <?php echo (isset($trsDetails)) ? json_encode($trsDetails) : '[]';?>;
    $(document).ready(function () {
        // details grid start
        $('#grdtrdetails').hide();
        var source = {
            localdata: arr_Lists,
            datatype: "json",
            pagesize:6,
            datafields:
                [
                    { name: "DecisionId", type: "string" },
                    { name: "ReqTransId", type: "string" },
                    { name: "ResourceName", type: "string" },
                    { name: "UnitName", type: "string" },
                    { name: "PODecisionQty", type: "string" },
                    { name: "POQty", type: "string" },
                    { name: "BalPODecQty", type: "string"}

                ]
        };
        var dataAdapter = new $.jqx.dataAdapter(source);
        $("#grdpodetails").jqxGrid({

            width: "100%",
            source: dataAdapter,
            pageable: true,
            columnsresize: true,
            autoheight: true,
            sortable: true,
            altrows: true,
            enabletooltips: true,
            showfilterrow: false,
            filterable: true,
            groupable: true,
            showstatusbar: true,
            statusbarheight: 35,
            showaggregates: true,
            autorowheight: true,
            columns: [
                {text: 'DecisionId', datafield: 'DecisionId',  hidden: true, filterable: false},
                {text: 'ReqTransId', datafield: 'ReqTransId',  hidden: true, filterable: false},
                {text: 'Resource', dataField: 'ResourceName', align: 'left', cellsalign: 'left', width: '30%'},
                {text: 'Unit', dataField: 'UnitName', align: 'left', cellsalign: 'left', width: '10%'},
                {text: 'Decision Qty', dataField: 'PODecisionQty', align: 'left', cellsalign: 'left', width: '15%'},
                {text: 'PO Qty', dataField: 'POQty', align: 'centre', cellsalign: 'right', width: '15%'},
                {text: 'Bal Qty', dataField: 'BalPODecQty', align: 'centre', cellsalign: 'right', width: '15%'},
                { text: 'Action', sortable: false, filterable: false, cellsalign: 'center',width:'15%',
                    cellsrenderer: function (row) {
                     return editLink = '<a title="Go to PO" href="javascript: void(0);" onclick="checkForm(this)" style="padding-left: 15px; margin-top:8px;"><i class="fa fa-sign-in reg-icon"></i></a>';
                    }
                }
            ]
        });

        $("#grdpodetails").jqxGrid('showgroupsheader', false);
        //Print option
        $("#excelExport").click(function () {
            $("#grdpodetails").jqxGrid('exportdata', 'xls', 'jqxGrid');
        });
        $("#csvExport").click(function () {
            $("#grdpodetails").jqxGrid('exportdata', 'csv', 'jqxGrid');
        });
        $("#htmlExport").click(function () {
            $("#grdpodetails").jqxGrid('exportdata', 'html', 'jqxGrid');
        });

        $("#print").click(function () {
            var gridContent = $("#grdpodetails").jqxGrid('exportdata', 'html');
            var newWindow = window.open('', '', 'width=800, height=500'),
                document = newWindow.document.open(),
                pageContent =
                    '<!DOCTYPE html>\n' +
                    '<html>\n' +
                    '<head>\n' +
                    '<meta charset="utf-8" />\n' +
                    '<title>Pending Po</title>\n' +
                    '<h1>Pending Po</h1>\n' +
                    '</head>\n' +
                    '<body>\n' + gridContent + '\n</body>\n</html>';
            document.write(pageContent);
            document.close();
            newWindow.print();
        });
        $("#grdpodetails").bind('rowselect', function (event) {
            var row = event.args.rowindex;
            var datarow = $("#grdpodetails").jqxGrid('getrowdata', row);

        });

        // end of decision -po

        //decision trans grid start
        var trsource = {
            datafields:
                [
                    { name: "DecisionId", type: "string" },
                    { name: "ReqTransId", type: "string" },
                    { name: "ResourceName", type: "string" },
                    { name: "UnitName", type: "string" },
                    { name: "TransferDecisionQty", type: "string" },
                    { name: "TransferQty", type: "string" },
                    { name: "BalTransDecQty", type: "string" }
                ],
            localdata: arr_Lists1,
            id: 'ReqTransId',
            datatype: "json"
        };

        var dataAdapter1 = new $.jqx.dataAdapter(trsource);
        // create nested grid.
            var nestedSource =
            {
                datafields: [
                    { name: "CostCentreId", type: "string" },
                    { name: "CostCentreName", type: "string" },
                    { name: "ToCostCentreId", type: "string" },
                    { name: "Qty", type: "string" },
                    { name: "TransId", type: "string" },
                    { name: "ReqTransId", type: "string" },
                    { name: "DecTransId", type: "string" }
                ],
                datatype: 'json',
                localdata: arr_transfer
            };
            var nestedAdapter = new $.jqx.dataAdapter(nestedSource, { autoBind: true });
            orders = nestedAdapter.records;
            var nestedGrids = new Array();

            // create nested grid.
            var initrowdetails12 = function (index, parentElement, gridElement, record) {

                var id = record.uid.toString();
                var grid = $($(parentElement).children()[0]);
                $(grid).attr('id', 'nestedGrid_' + id);
                nestedGrids[index] = grid;
                var filtergroup = new $.jqx.filter();
                var filter_or_operator = 1;
                var filtervalue = id;
                var filtercondition = 'equal';
                var filter = filtergroup.createfilter('stringfilter', filtervalue, filtercondition);
                // fill the orders depending on the id.
                var ordersbyid = [];
                for (var m = 0; m < orders.length; m++) {
                    var result = filter.evaluate(orders[m]["DecTransId"]);
                    if (result)
                        ordersbyid.push(orders[m]);
                }

                var orderssource = {
                    datafields: [
                        {name: "CostCentreId", type: "string"},
                        {name: "CostCentreName", type: "string"},
                        {name: "ToCostCentreId", type: "string"},
                        {name: "Qty", type: "string"},
                        {name: "TransId", type: "string"},
                        {name: "ReqTransId", type: "string"},
                        {name: "DecTransId", type: "string"}
                    ],
                    id: 'ReqTransId',
                    localdata: ordersbyid
                };
                var nestedGridAdapter = new $.jqx.dataAdapter(orderssource);

                if (grid != null) {
                    //  grid.parentRowIndex = index;
                    grid.jqxGrid({
                        source: nestedGridAdapter,
                        width: "100%",
                        pageable: true,
                        autoheight: true,
                        sortable: true,
                        rowdetails: false,
                        filterable: true,
                        columnsresize: true,
                        columnsreorder: true,
                        columns: [
                            {text: 'ReqTransId', dataField: 'ReqTransId', hidden: true},
                            {text: 'DecTransId', dataField: 'DecTransId', hidden: true},
                            {text: 'CostCentreId', dataField: 'CostCentreId', hidden: true},
                            {text: 'ToCostCentreId', dataField: 'ToCostCentreId', hidden: true},
                            {text: 'TransId', dataField: 'TransId', hidden: true},
                            {text: 'CostCentre Name', dataField: 'CostCentreName', align: 'left', cellsalign: 'left', width: '50%'},
                            {text: 'Qty', dataField: 'Qty', align: 'left', cellsalign: 'left', width: '25%'},
                            { text: 'Action', sortable: false, filterable: false, cellsalign: 'center',width:'25%',
                                cellsrenderer: function (row) {
                                    return editLink = '<a title="Go to Transfer" href="javascript: void(0);" onclick="checkForm1(this)" style="padding-left: 15px; margin-top:8px;"><i class="fa fa-sign-in reg-icon"></i></a>';
                                }
                            }

                        ]
                    });
                    // bind to rowclick of nested grid.
                    grid.on('rowclick', function(event) {
                        var row = event.args.rowindex;
                        var datarow = grid.jqxGrid('getrowdata', row);
                       checkForm1(datarow);
                    });
                }
            };
        // create grid
        $("#grdtrdetails").jqxGrid(
            {
            width: '100%',
            autoheight:true,
            source: dataAdapter1,
            sortable: true,
            //editable:true,
            filterable: true,
            pageable: true,
            rowdetails: true,
            rowsheight: 35,
            columnsresize: true,
            columnsreorder: true,
            initrowdetails: initrowdetails12,
                rowdetailstemplate: {
                    rowdetails: "<div style='height:auto;overflow:visible; border:2px solid #5bc0de;'></div>",
                    rowdetailsheight:400
                },
                ready: function () {
                    $("#grdtrdetails").jqxGrid('showrowdetails', 1);
                },
                columns: [
                    { text: 'DecisionId', datafield: 'DecisionId', hidden: true},
                    { text: 'ReqTransId', dataField: 'ReqTransId', hidden: true},
                    { text: 'ResourceName', dataField: 'ResourceName', align: 'left', cellsalign: 'left',width:'30%'},
                    { text: 'UnitName', dataField: 'UnitName', align: 'left', cellsalign: 'left',width:'10%'},
                    { text: 'TransferDecision Qty', dataField: 'TransferDecisionQty', align: 'left', cellsalign: 'left',width:'20%'},
                    { text: 'Transfer Qty', dataField: 'TransferQty', align: 'left', cellsalign: 'left',width:'20%'},
                    { text: 'BalTransDec Qty', dataField: 'BalTransDecQty', align: 'left', cellsalign: 'left',width:'20%'}
                ]
            });
        $("#grdtrdetails").jqxGrid('showgroupsheader', false);
        //Print option
        $("#excelExport").click(function () {
            $("#grdtrdetails").jqxGrid('exportdata', 'xls', 'jqxGrid');
        });
        $("#csvExport").click(function () {
            $("#grdtrdetails").jqxGrid('exportdata', 'csv', 'jqxGrid');
        });
        $("#htmlExport").click(function () {
            $("#grdtrdetails").jqxGrid('exportdata', 'html', 'jqxGrid');
        });

        $("#print").click(function () {
            var gridContent = $("#grdtrdetails").jqxGrid('exportdata', 'html');
            var newWindow = window.open('', '', 'width=800, height=500'),
                document = newWindow.document.open(),
                pageContent =
                    '<!DOCTYPE html>\n' +
                    '<html>\n' +
                    '<head>\n' +
                    '<meta charset="utf-8" />\n' +
                    '<title>WareHouse Stock</title>\n' +
                    '<h1>WareHouse Stock</h1>\n' +
                    '</head>\n' +
                    '<body>\n' + gridContent + '\n</body>\n</html>';
            document.write(pageContent);
            document.close();
            newWindow.print();

        });

        $("#grdtrdetails").bind('rowselect', function (event) {
            var row = event.args.rowindex;
            var datarow = $("#grdtrdetails").jqxGrid('getrowdata', row);
        });

        //decision grid end

    });
    function trtabclick() {
        $('#grdtrdetails').show();
    }
    var errorflag = 0;
    function checkForm(){
        var displayedRows =  $("#grdpodetails").jqxGrid('getboundrows');
        var $inputs = '';
            $.each(displayedRows, function (i, o) {
                if(o.BalPODecQty > 0){
                    $inputs += '<input type="hidden" name="requestTransIds[]" class="requestTransIds" value="' + o.ReqTransId + '"/>';
                    errorflag = 2;
                }
            });
            if(errorflag == 2){
                $('#requestTransInputsWrapper').html($inputs);
                $('#formWrapper').submit();
            } else {
                alert("BalanceQty is zero");
                return false;
            }
    }
    function checkForm1(data){
        var displayedRows =  $("#grdtrdetails").jqxGrid('getboundrows');
        var dRows1 =  data;
        var $inputs1 = '';
        var cost = dRows1.ToCostCentreId;
        $.each(displayedRows, function (i, o) {
            if (o.BalTransDecQty > 0){
                $inputs1 += '<input type="hidden" name="requestTransIds[]" class="requestTransIds" value="' + o.ReqTransId + '"/>';
                errorflag = 4;
            }
        });
        if(errorflag == 4){
            $('#requestTransInputsWrapper1').html($inputs1);
            $('#from_project').val(cost);
            $('#formWrapper1').submit();
        } else {
            alert("BalanceQty is zero");
            return false;
        }

    }
    </script>