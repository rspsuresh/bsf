<style>
#allResource .jqx-grid-header 	{height:75px !important;}
#allResourceList .jqx-grid-header 	{height:75px !important;}

.jqx-grid-column-header .jqx-checkbox-default{
	display:none;
}
#sequentialView tr th{
	width:auto !important;
}
.input-group-addon{
	background-color:#fff !important;
	border:none !important;
}
.error{
	border-color:red;
	background-color:red !important;
}
.nav-list{padding-right:15px;padding-left:15px;margin-bottom:0;}
.nav-list-main{padding-left:0px;padding-right:0px;margin-bottom:0;}
span.nav-toggle-icon{font-size:7px !important;top:-2px !important;color:#888 !important;}
</style>
<div class="content_wrapper padlr0">
	<div class="container-fluid">
		<div class="col-lg-12 clear">
			<form class="form-horizontal" method="post">
				<input type="hidden" name="decisionId" id="decisionId" value="<?php echo $requestDecId; ?>">
				<div class="row" id="firstStep">
					<h1 class="txt_center form_main_h1 frmwrk_h1">Request Decision<?php echo ($genType) ? '-' : ''; ?><?php echo $decisionResult[0]['RDecisionNo']; ?></h1>
					<div class="form-group">
						<div class="col-lg-4 col-lg-offset-4 col-md-6 col-md-offset-3 col-sm-8 col-sm-offset-2">
							<div class="row" style="<?php echo ($genType) ? 'display:none' : ''; ?>">
								<div class="form-group req_flds col-lg-12">
									<input type="text" name="voucherNo" id="voucherNo" class="form-control lbl_move" label="Enter voucherNo" value="<?php echo $decisionResult[0]['RDecisionNo'];; ?>" >
									<!--<input type="text" id="autocomplete-ajax-x" disabled="disabled" class="form-control" style="color: #CCC; position: static; background: transparent; z-index: 1;">-->
									<div class="error_message"><p>Please enter VoucherNo...</p> </div> 
								</div>
							</div>
							<div class="row">
								<div class="form-group req_flds col-lg-12">
									<select class="form-control selectpicker show-tick" name="decision_type" id="decision_type" disabled>
									<?php
										$type = array("0"=>"Select Decision", "2"=>"Material", "3"=>"Asset");
										foreach($type as $key=>$value){
											echo "<option value='".$key."' ".(($key==$decisionResult[0]['RequestType'])?'selected':'').">".$value."</option>";
										}
									?>
									</select>
									<div class="error_message"><p>Please select Decision type...</p> </div> 
								</div>
							</div>
							<div class="row">   
								<div class="form-group req_flds col-lg-12">
									<span class="date_icon"><i class="fa fa-calendar"></i></span>
									<input type="text" name="decision_date" id="decision_date" class="form-control lbl_move datepickerinput" value="<?php echo date("d-m-Y", strtotime($decisionResult[0]['DecDate'])); ?>" class="form-control lbl_move datepickerinput" label="Request date" value='<?php echo Date('d-m-Y'); ?>' />									
									<div class="error_message"><p>Please enter decision date...</p> </div> 
								</div>
							</div>
						</div>
					</div>
				</div>			
				<div class="row" id="excludeFirst" style="display:none;">
				   <div class="col-lg-12">
						<h1>Request Decision-<span id="VoucherSpan"><?php echo $decisionResult[0]['RDecisionNo']; ?></span></h1> 
						<div class="col-lg-12 clear" style="margin:10px;">
							<div class="col-lg-6 col-md-6">
								<div class="row">
									<div class=" col-lg-6 col-md-6 col-sm-6 col-xs-6"><p class="space_p">Decision Date<span class="colon_r">:</span></p></div>
									<div class="col-lg-6 col-md-6 col-sm-6 col-xs-6"><p class="space_p" id="dateSpan"><?php echo date("d-m-Y", strtotime($decisionResult[0]['DecDate'])); ?></p></div> 
								</div>
								<div class="row">
									<div class=" col-lg-6 col-md-6 col-sm-6 col-xs-6"><p class="space_p">Selected Type<span class="colon_r">:</span></p></div>
									<div class="col-lg-6 col-md-6 col-sm-6 col-xs-6"><p class="space_p" id="materialSpan"><?php echo $type[$decisionResult[0]['RequestType']]; ?></p></div> 
							   </div>
							</div>
							 
						</div>
					</div>
				</div>				
				<div class="row" id="secondStep" style="display:none;">
					<input type="hidden" name="requestId" id="requestId">
					<div class="col-lg-12">
						<nav class="navbar inrmdltab_navbar navbar-default">
							<div class="navbar-header">
								<button type="button" class="navbar-toggle mdlnvbr_tgl collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
									<span class="icon-bar"></span>
									<span class="icon-bar"></span>
									<span class="icon-bar"></span>
								</button>
								<a class="navbar-brand inrmdl_navbrand" href="javascript:void(0);">Select Menus</a>
							</div>
							<div id="navbar" class="navbar-collapse padlr0 collapse">
								<ul class="nav nav-tabs innermdl_tabs">
									<li class="active"><a href="#allrequests" data-toggle="tab">All Request</a></li>
								</ul>
							</div>
						</nav>
						<div class="tab-content">
							<div class="tab-pane fade in active" id="allrequests">
								<div class="table-responsive">
									<div id="jqxWidget">
										<div id="allResource" style="width:100%;">
										</div>
									</div>
								</div>
							</div>
						</div>								
					</div>
				</div>	
				<div class="row" id="secondStepList" style="display:none;">
					<input type="hidden" name="resourceId" id="resourceId">
					<div class="col-lg-12">
						<nav class="navbar inrmdltab_navbar navbar-default">
							<div class="navbar-header">
								<button type="button" class="navbar-toggle mdlnvbr_tgl collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
									<span class="icon-bar"></span>
									<span class="icon-bar"></span>
									<span class="icon-bar"></span>
								</button>
								<a class="navbar-brand inrmdl_navbrand" href="javascript:void(0);">Select Menus</a>
							</div>
							<div id="navbar" class="navbar-collapse padlr0 collapse">
								<ul class="nav nav-tabs innermdl_tabs">
									<li class="active"><a href="#allresources" data-toggle="tab">All Resource</a></li>
								</ul>
							</div>
						</nav>
						<div class="tab-content">
							<div class="tab-pane fade in active" id="allresources">
								<div class="table-responsive">
									<div id="jqxWidget">
										<div id="allResourceList" style="width:100%;">
										</div>
									</div>
								</div>
							</div>
						</div>								
					</div>
				</div>					
				<div class="row" id="thirdStep" style="display:none;">
					<div class="col-lg-2 col-lg-offset-10">
						<div class="form-group">
							<ul class="grid_change">
								<li><a class="addresorce_vendor" id="addRequest" href="javascript:void(0)"><span><i class="fa fa-plus"></i>Add Request</span></a></li>
							</ul>
						</div>		
					</div>					
					<div class="col-lg-12">
                        <div class="form-group" style="margin-top:20px;" id="sequentialViewDiv">
                            <div>
                                <div class="col-lg-12 clear">
                                    <div class="table-responsive clear">						
										<table id="sequentialView" class="table table-bordered tableView" style="width:100%;">
											<thead>
												<tr>
													<th>Code</th>
													<th>Resource name</th>
													<th>Unit name</th>
												</tr>
											</thead>
											<tbody class="appendData">
											<?php 
											$data = json_decode($resp, true);
											foreach($data as $resource){
											?>	
												<tr class="mainTr deleteTr_<?php echo $resource['ResourceId']; ?>" tid="<?php echo $resource['ResourceId']; ?>">
													<td><?php echo $resource['Code']; ?></td>
													<td><?php echo $resource['ResourceName']; ?></td>
													<td><?php echo $resource['UnitName']; ?></td>
												</tr>
											<?php			
											} 
											?>											
											</tbody>
										</table>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="row" style="display:none;">
					<div class="col-lg-12">
                        <div class="form-group" style="margin-top:20px;">
                            <div>
                                <div class="col-lg-12 clear">
                                    <div class="table-responsive clear">						
										<table id="subTableView" class="table table-bordered tableView" style="margin-top:20px;">
											<thead>
												<tr>
													<th>Sample</th>
												</tr>
											</thead>
											<tbody class="appendDataMatrix">
											<?php 
											$json = array();
											foreach($data as $resource){
												$sample = array();
												$sample['resId'] = $resource['ResourceId'];
											?>		
												<tr class="subTr_<?php echo $resource["ResourceId"]; ?> deleteTr_<?php echo $resource["ResourceId"]; ?>">
													<td colspan=3>
														<div class="subDiv">
															<table class="table table-bordered">
																<thead>
																	<tr>
																		<th>Request No</th>
																		<th>Request Date</th>
																		<th>Cost centre</th>
																		<th>Bal Qty</th>
																		<th>PO Qty</th>
																		<th>Transfer</th>
																		<th>Production</th>
																	</tr>
																</thead>
																<tbody>
																<?php
																$sample["reqTransId"] = array();
																foreach($resource["request"] as $request){
																	$reqTransId = array();
																	$reqTransId["reqTransId"] = $request["RequestTransId"];
																	$reqTransId["reqAHTransId"] = array_column($request["wbsResults"], "RequestAHTransId");
																?>	
																	<tr style="background-color:#f0f2f2;" id="requestTr_<?php echo $request["RequestTransId"]; ?>" jsonVal='<?php echo json_encode($reqTransId); ?>'>
																		<td><?php echo $request["RequestNo"]; ?>
																			<!--hidden value-->
																			<input type="hidden" readonly class="form-control" oldVal="<?php echo $request["HideIApproveQty"]; ?>" name="poQtyH_<?php echo $request["RequestTransId"]; ?>" value="<?php echo $request["HideIApproveQty"]; ?>">
																			<input type="hidden" readonly class="form-control" oldVal="<?php echo $request["HideTApproveQty"]; ?>" name="transferH_<?php echo $request["RequestTransId"]; ?>" value="<?php echo $request["HideTApproveQty"]; ?>">
																			<input type="hidden" readonly class="form-control" oldVal="<?php echo $request["HidePApproveQty"]; ?>" name="productionH_<?php echo $request["RequestTransId"]; ?>" value="<?php echo $request["HidePApproveQty"]; ?>">
																			<!--hidden value end-->																									
																		</td>
																		<td><?php echo $request["ReqDate"]; ?></td>
																		<td><?php echo $request["CostCentreName"]; ?></td>
																		<td><?php echo $request["BalQty"]; ?></td>
																		<td class="tbl_input_td"><input type="text" <?php echo ((count($request["wbsResults"])>0)?"readonly":""); ?> class="parent_txts tbl_input" oldVal="<?php echo $request["IndentApproveQty"]; ?>" name="poQty_<?php echo $request["RequestTransId"]; ?>" value="<?php echo $request["IndentApproveQty"]; ?>"></td>
																		<td class="tbl_input_td"><input type="text" <?php echo ((count($request["wbsResults"])>0)?"readonly":""); ?> class="parent_txts tbl_input" oldVal="<?php echo $request["TransferApproveQty"]; ?>" name="transfer_<?php echo $request["RequestTransId"]; ?>" value="<?php echo $request["TransferApproveQty"]; ?>"></td>
																		<td class="tbl_input_td"><input type="text" <?php echo ((count($request["wbsResults"])>0)?"readonly":""); ?> class="parent_txts tbl_input" oldVal="<?php echo $request["ProductionApproveQty"]; ?>" name="production_<?php echo $request["RequestTransId"]; ?>" value="<?php echo $request["ProductionApproveQty"]; ?>"></td>
																	</tr>
																	<?php	
																	if((count($request["wbsResults"])>0)){
																	?>	
																		<tr class="backgroundtr_vendor">
																			<td colspan=7>
																				<div class="subDiv">
																					<table class="table">
																						<thead>
																							<tr>
																								<th width="8%" style="border-left:none !important; border-top:none !important; border-bottom:none !important; background-color:#eefdfe !important; border-right:1px solid #ddd !important;"></th>
																								<th class="vendor_entrytableborder">WBS Name</th>
																								<th class="vendor_entrytableborder">Quantity</th>
																								<th class="vendor_entrytableborder">Bal qty</th>
																								<th class="vendor_entrytableborder">PO qty</th>
																								<th class="vendor_entrytableborder">Transfer</th>
																								<th class="vendor_entrytableborder">Production</th>
																							</tr>
																						</thead>
																						<tbody>
																						<?php
																						foreach($request["wbsResults"] as $wbs){
																						?>	
																							<tr>
																								<td width="8%" class="vendor_entryfortable"></td>
																								<td class="vendor_entrytableborder"><?php echo $wbs["WbsName"]; ?>
																									<input type="hidden" class="form-control noVal" name="wbsName_<?php echo $wbs["RequestAHTransId"]; ?>" value="<?php echo $wbs["AnalysisId"]; ?>">
																									<!--hidden value-->
																									<input type="hidden" oldVal="<?php echo $wbs["HiddenIApproveQty"]; ?>" class="form-control quantityVal" eleName="poQtyH_<?php echo $wbs["ReqTransId"]; ?>" name="poWbsQtyH_<?php echo $wbs["RequestAHTransId"]; ?>" value="<?php echo $wbs["HiddenIApproveQty"]; ?>">
																									<input type="hidden" oldVal="<?php echo $wbs["HiddenTApproveQty"]; ?>" class="form-control quantityVal" eleName="transferH_<?php echo $wbs["ReqTransId"]; ?>" name="transferWbsH_<?php echo $wbs["RequestAHTransId"]; ?>" value="<?php echo $wbs["HiddenTApproveQty"]; ?>">
																									<input type="hidden" oldVal="<?php echo $wbs["HiddenPApproveQty"]; ?>" class="form-control quantityVal" eleName="productionH_<?php echo $wbs["ReqTransId"]; ?>" name="productionWbsH_<?php echo $wbs["RequestAHTransId"]; ?>" value="<?php echo $wbs["HiddenPApproveQty"]; ?>">
																									<!--hidden value end-->																																
																								</td>
																								<td class="vendor_entrytableborder"><?php echo $wbs["Quantity"]; ?></td>
																								<td class="vendor_entrytableborder"><?php echo $wbs["BalQty"]; ?></td>
																								<td class="tbl_input_td vendor_entrytableborder"><input type="text" class-name='poQty' class="parent_txts tbl_input quantityVal poQty" eleName="poQty_<?php echo $request["RequestTransId"]; ?>" name="poWbsQty_<?php echo $wbs["RequestAHTransId"]; ?>"  value="<?php echo $wbs["IndentApproveQty"]; ?>" data-toggle="tooltip" data-title="" data-trigger="focus"></td>
																								<td class="tbl_input_td vendor_entrytableborder"><input type="text" class-name='transferQty' class="parent_txts tbl_input quantityVal transferQty" eleName="transfer_<?php echo $request["RequestTransId"]; ?>" name="transferWbs_<?php echo $wbs["RequestAHTransId"]; ?>"  value="<?php echo $wbs["TransferApproveQty"]; ?>" data-toggle="tooltip" data-title="" data-trigger="focus"></td>
																								<td class="tbl_input_td vendor_entrytableborder"><input type="text" class-name='productionQty' class="parent_txts tbl_input quantityVal productionQty" eleName="production_<?php echo $request["RequestTransId"]; ?>" name="productionWbs_<?php echo $wbs["RequestAHTransId"]; ?>"  value="<?php echo $wbs["ProductionApproveQty"]; ?>" data-toggle="tooltip" data-title="" data-trigger="focus"></td>
																							</tr>
																						<?php			
																						}
																						?>	
																						</tbody>
																					</table>
																				</div>
																			</td>
																		</tr>
																<?php		
																	}
																	array_push($sample["reqTransId"], $reqTransId);
																}
																array_push($json, $sample);
																?>	
																</tbody>
															</table>
														</div>
													</td>
												</tr>
											<?php		
											} 
											?>												
											</tbody>
										</table>
										<table id="cloneTable" class="table table-bordered tableView" style="margin-top:20px;">
										</table>										
										<input type="text" name="totTrans" id="totTrans" value='<?php echo json_encode($json); ?>'>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>	
			</form>
		</div>
	</div>
</div>
<div class="col-lg-12 savebtn_area">
    <ul>
        <li id="continueButton" class="dropdown save_btn float_r">
            <a href="javascript:void(0);" class="ripple">Continue</a>
        </li>
        <li id="backButton" class="cancel_btn float_r" style="display:none;"><a href="javascript:void(0);" class="ripple">back</a></li>
    </ul>
</div>

<script>

	var totTrans=[];
	var resId=[];
	var resIdOld=[];
	var reqId=[];
	var reqIdOld=[];
	var reqResId = [];
	var resRowId=[];
	var loadRes = false;
	var editRequest = [];
	var orgVal = '';
	$("#cloneTable").html($("#subTableView").html());
	$('input[data-toggle="tooltip"]').tooltip();
	$(".error_message").hide();
	$("#voucherNo").blur(function(){
		$("#VoucherSpan").text($(this).val());
	});
	/* $("#decision_type").change(function(){
		$("#materialSpan").text($("#decision_type option:selected").text());
	}); */
	
	function arrequal(arr1, arr2){
		var is_equal = arr1.length==arr2.length && arr1.every(function(v,i) { return ($.inArray(v,arr2) != -1)});
		return is_equal;
	}
	
	$('.datepickerinput').datepicker({
		format: "dd-mm-yyyy",
		todayBtn: true,
		orientation: "top auto",
		autoclose: true
	}).on("changeDate", function(e){
		$("#dateSpan").text($(this).val());
	});	
	$('.date_icon').click(function() {
		var input = $(this).parent().find('input').datepicker('show');
	});
	var oTable = $("#sequentialView").dataTable({"aLengthMenu": [[1, 5, 10], [1, 5, 10]], "order": [],
		"initComplete": function(settings, json) {
			$("select[name=sequentialView_length]").addClass("show-tick").selectpicker();
		},	
		"drawCallback": function( settings ){
			//alert($(this).find(".datepickerinput").attr("class"))
			$(this).find("tr.mainTr").trigger('click');
			if($('#sequentialView_next').hasClass('disabled') && $('#thirdStep').is(':visible'))
				$("#continueButton a").text("Submit");
			else
				$("#continueButton a").text("Continue");			
		}	
	});
	 
	 
	/*Resourcelist grid start*/	
	var resSource = {
		localData: [],
		dataType: "json",
		dataFields:
		[
			{ name: 'Code', type: 'string' },
			{ name: 'ResourceName', type: 'string' },
		],
		id:'ResourceId'
	};

	var dataAdapterRes = new $.jqx.dataAdapter(resSource,{
		autoBind: true,
		loadComplete: function (data) {
			
		},
		loadError: function (xhr, status, error) {
			
		}
	});


	$("#allResourceList").jqxGrid({
		width: '100%',
		pageable: true,
		selectionMode: 'singleRow',
		pagerButtonsCount: 6,
		autoheight:true,
		//rowsheight:60,
		autorowheight: true,
		filterable: true,
		sortable: true,
		//filtermode: 'advanced',				
		columnsResize: true,
		showfilterrow: true,
		ready: function(){
			var localizationobj = {};
			localizationobj.emptydatastring = "No resource to display";
			$("#allResourceList").jqxGrid('localizestrings', localizationobj);
		},			
		selectionmode: 'checkbox',						
		source: dataAdapterRes,
		columns: [
			  { text: 'Code', editable: false,datafield: 'Code'},
			  { text: 'ResourceName', editable: false,datafield: 'ResourceName'},
		]
	});
	$('#allResourceList').on('rowselect', function (event){
		// event arguments.
		var args = event.args;
		// row's bound index.
		var rowBoundIndex = args.rowindex;
		// row's data. The row's data object or null(when all rows are being selected or unselected with a single action). If you have a datafield called "firstName", to access the row's firstName, use var firstName = rowData.firstName;
		var rowData = args.row;
	});	
	$('#allResourceList').on('rowunselect', function (event){
		// event arguments.
		var args = event.args;
		// row's bound index.
		var rowBoundIndex = args.rowindex;
		// row's data. The row's data object or null(when all rows are being selected or unselected with a single action). If you have a datafield called "firstName", to access the row's firstName, use var firstName = rowData.firstName;
		var rowData = args.row;
	});	
		
	$('#allResourceList').on('rowclick', function (event){
		var args = event.args;
		// row's bound index.
		var boundIndex = args.rowindex;
		var index = $('#allResourceList').jqxGrid('selectedrowindexes'); 
		//alert($.inArray(boundIndex, index))
		if($.inArray(boundIndex, index) == -1)
			$('#allResourceList').jqxGrid('selectrow', boundIndex);
		else
			$('#allResourceList').jqxGrid('unselectrow', boundIndex);
	});	
	/*Resourcelist grid end*/	
	function trimNumber(s){
	  while (s.substr(0,1) == '0' && s.length>1) { s = s.substr(1,9999); }
	  return s;
	}
	function changePage(){
		$(".quantityVal").unbind();
		$(".quantityVal").bind('focusin', function(e){
			var totWbsVal = $(this).closest("tr").find("td:nth-child(4)").text();
			var wbsVal = $(this).val();
			$(this).closest("tr").find("input:hidden, input:text").each(function(){
				if($(this).attr("type") == 'text' && name!= $(this).attr("name"))
					totWbsVal = parseFloat(totWbsVal) - parseFloat($(this).val());
				else if($(this).attr("type") == 'hidden' && !$(this).hasClass("noVal"))
					totWbsVal = parseFloat(totWbsVal) + parseFloat($(this).val());
			});
			var total = parseFloat(totWbsVal) + parseFloat(wbsVal);			
			$(this).attr('data-original-title', 'Enter the value less than or equal to '+total);
			$(this).tooltip('show');
		});
		$(".quantityVal").bind('keyup keydown', function(e){
			var key = e.which || e.keyCode;
			var name = $(this).attr("name");
			var classname = $(this).attr('class-name');
			var eleName = $(this).attr('eleName');
			if(key != 9){
				var sum = 0;
				if($(this).val().indexOf(' ') > -1){
					$(this).val($(this).val().trim());
				}				
				if (isNaN($(this).val())){
					this.value = this.value.replace(/[^0-9\.]/g,'');
					if($(this).val().indexOf('.') > -1){
						var index = $(this).val().indexOf( '.' );
						this.value = this.value.substr( 0, index + 1 ) + this.value.slice( index ).replace( /\./g, '' );
					}
				}
				var ex = /^\d*(\.\d{0,6})?$/;
				if(!ex.test($(this).val())){
					$(this).val($(this).val().substring(0,$(this).val().length-1));
				}
				
				/*Total value validation*/	
				var totWbsVal = $(this).closest("tr").find("td:nth-child(4)").text();
				var wbsVal = $(this).val();
				 $(this).closest("tr").find("input:hidden, input:text").each(function(){
					if($(this).attr("type") == 'text' && name!= $(this).attr("name"))
						totWbsVal = parseFloat(totWbsVal) - parseFloat($(this).val());
					else if($(this).attr("type") == 'hidden' && !$(this).hasClass("noVal"))
						totWbsVal = parseFloat(totWbsVal) + parseFloat($(this).val());
				 });
				
				if(totWbsVal < wbsVal){
					 $(this).val(orgVal);
				}
				else{
					orgVal = $(this).val();
					$(this).closest('table').find("."+classname).each(function() {
						//add only if the value is number
						if (!isNaN(this.value) && this.value.length != 0) {
							sum += parseFloat(this.value);
						}
					});
					$("input[name="+eleName+"]").val(sum.toFixed(6));					
				}
			}
		});
		$(".quantityVal").bind('blur', function(){
			var name = $(this).attr("name");
			var classname = $(this).attr('class-name');
			var eleName = $(this).attr('eleName');

			var sum = 0;
			if (!isNaN($(this).val()) && $(this).val().length != 0) {

			}
			else{
				$(this).val($(this).val().substring(0,$(this).val().length-1));
			}
			var ex = /^\d*(\.\d{0,6})?$/;
			if(!ex.test($(this).val())){
				$(this).val($(this).val().substring(0,$(this).val().length-1));
			}
			
			/*Total value validation*/	
			var totWbsVal = $(this).closest("tr").find("td:nth-child(4)").text();
			var wbsVal = $(this).val();
			$(this).closest("tr").find("input:hidden, input:text").each(function(){
				if($(this).attr("type") == 'text' && name!= $(this).attr("name"))
					totWbsVal = parseFloat(totWbsVal) - parseFloat($(this).val());
				else if($(this).attr("type") == 'hidden' && !$(this).hasClass("noVal"))
					totWbsVal = parseFloat(totWbsVal) + parseFloat($(this).val());
			});
			
			if(totWbsVal < wbsVal){
				  $(this).val(orgVal);
			}
			else{
				orgVal = $(this).val();
				$(this).closest('table').find("."+classname).each(function() {
					//add only if the value is number
					if (!isNaN(this.value) && this.value.length != 0) {
						sum += parseFloat(this.value);
					}
				});
				$("input[name="+eleName+"]").val(sum.toFixed(6));					
			}
			
			//$(this).val(parseInput($(this).val()));
			var val = '0';
			if($(this).val() == '' || $(this).val() == 0){
				val = val +'.000000'; 
			}
			else{
				$(this).val(trimNumber($(this).val()));
				val1 = $(this).val();
				var str = '000000';
				var splitVal = val1.split('.');
				var len = 6;
				if(splitVal[1]){
					len -= splitVal[1].length;
				}
				if(len == 6)
					val = val1+'.000000';
				else if(len < 0)
					val = splitVal[0]+'.'+splitVal[1].substring(0,6);
				else
					val = val1+str.substring(0,len);
				
				if(val.substring(0,1) == '.')
					val = '0' + val;				
			}
			
			$("input[name="+name+"]").attr("value", val);
			$("input[name="+name+"]").val(val);	
		});
	}
	
	
	function trClick(){
		oTable.$("tr.mainTr").unbind();
		oTable.$("tr.mainTr").bind('click', function(){
			if(!($(this).next("tr").hasClass("duplicateTr"))){
				$(this).after("<tr class='duplicateTr'>"+$(".subTr_"+$(this).attr("tid")).html()+"</tr>");
				changePage();
			}
		});
	}
	trClick();
	$("#addRequest").click(function(){
		$("#thirdStep").hide();
		$("#secondStep").show();
		$("#backButton").hide();	
		$("#continueButton a").text("Continue");
	});
	$("#continueButton").click(function(){
		$(".error_message").hide();
		if($("#firstStep").is(":visible")){
			if($("#voucherNo").val().trim().length == 0){
				$("#voucherNo").closest(".req_flds").find(".error_message").show();
				$("#voucherNo").focus();
			}
			else if($("#decision_date").val().trim().length == 0){
				$("#decision_date").closest(".req_flds").find(".error_message").show();
				$("#decision_date").focus();
			}
			else{
				$("#firstStep").hide();
				$("#thirdStep").show();
				$("#backButton").show();	
				$("#excludeFirst").show();
				$("#continueButton a").text("Submit");
				oTable.$("tr.mainTr").trigger("click");	
			}
		}
		else if($("#secondStep").is(":visible")){
			var index = $('#allResource').jqxGrid('getselectedrowindex');
			if(index==-1){
				alert('Please select atleast one request to proceed further');
			}
			else{
				reqId=[];
				var index = $("#allResource").jqxGrid("getselectedrowindexes");
				for(var i in index){
					reqId.push($("#allResource").jqxGrid("getrowid", index[i]));
				}
				$("#requestId").val(reqId);
				$("#secondStep").hide();
				$("#secondStepList").show();
				$("#backButton").show();
				if(!arrequal(reqId, reqIdOld))
					loadResource();
			}			
		}
		else if($("#secondStepList").is(":visible")){
			var index = $('#allResourceList').jqxGrid('getselectedrowindex');
			if(index==-1){
				alert('Please select atleast one resource to proceed further');
			}
			else{
				resId=[];
				var index = $("#allResourceList").jqxGrid("getselectedrowindexes");
				for(var i in index){
					resId.push($("#allResourceList").jqxGrid("getrowid", index[i]));
				}
				
				$("#backButton").show();
				$("#resourceId").val(resId);				
				$("#secondStepList").hide();
				$("#thirdStep").show();
				$("#continueButton a").text("Submit");
				if(!arrequal(resId, resIdOld) || !arrequal(reqId, reqResId))
					loadDetailGrid();
			}			
		}
		else if($("#thirdStep").is(":visible")){
			if(!$('#sequentialView_next').hasClass('disabled')){
				$('#sequentialView_next').trigger('click');
				if($('#sequentialView_next').hasClass('disabled'))
					$("#continueButton a").text("Submit");
			}
			else{			
				reqId=[];
				var index = $("#allResource").jqxGrid("getselectedrowindexes");
				for(var i in index){
					reqId.push($("#allResource").jqxGrid("getrowid", index[i]));
				}
				$("#requestId").val(reqId);			
				$("form").submit();
			}			
		}
	});

	$("#backButton").click(function(){
		if($("#secondStep").is(":visible")){
			$("#secondStep").hide();
			$("#firstStep").show();
			$("#backButton").hide();
			$("#excludeFirst").hide();
		}
		else if($("#secondStepList").is(":visible")){
			$("#backButton").hide();
			$("#secondStep").show();
			$("#secondStepList").hide();
		}
		else if($("#thirdStep").is(":visible")){
			$("#excludeFirst").hide();
			$("#backButton").hide();
			$("#continueButton a").text("Continue");
			$("#thirdStep").hide();
			$("#firstStep").show();
		}
	});

   /*Load Resources*/
	function loadResource(){
		//alert(formData)
		$("#allResourceList").jqxGrid("showloadelement");
		$.ajax({
			url:getBaseURL()+"ats/decision/request-decision",
			type:"post",
			data:"reqId="+reqId+"&mode=resourcePickList",
			dataType:"json",
			success:function(data, textStatus, jqXHR){
				//console.log(JSON.stringify(data))
				var index1 = $('#allResourceList').jqxGrid('selectedrowindexes'); 
				for(var i in index1){
					resRowId.push($('#allResourceList').jqxGrid('getrowid', index1[i]));
				}
				//$("#allResourceList").jqxGrid("clear");
				resSource.localdata = data;
				dataAdapterRes.dataBind();
				$('#allResourceList').jqxGrid({ source: dataAdapterRes });
				
				var index1 = $('#allResourceList').jqxGrid('selectedrowindexes'); 
				if(index1.length > 0)
					$('#allResourceList').jqxGrid('clearselection');
				
				if(!loadRes){
					$.each(<?php echo json_encode($resResult); ?>, function(i,v){
						resIdOld.push(v.ResourceId);
						reqResId = reqId;
						var mindex = $('#allResourceList').jqxGrid('getrowboundindexbyid', v.ResourceId);
						if(mindex!=-1)
							$('#allResourceList').jqxGrid('selectrow', mindex);
					});					
					loadRes = true;						
				}
				else{
					for(var id in resRowId){
						var ind = $('#allResourceList').jqxGrid('getrowboundindexbyid', resRowId[id]);
						if(ind != -1)
							$('#allResourceList').jqxGrid('selectrow', ind);
					}					
				}
			},
			complete:function(data){
				reqIdOld = reqId.slice(0);
				$("#allResourceList").jqxGrid("hideloadelement");
			},	
			error:function(jqXHR, textStatus, errorThrown){
				alert(textStatus+"-----"+errorThrown);
			}		
	
		});		
	}
	function loadDetailGrid(){
		oTable.fnClearTable();
		$("#cloneTable").html($("#subTableView").html());
		$("#subTableView tbody:first").html("");
		$.ajax({
			url:getBaseURL()+"ats/decision/editrequest-decision",
			type:"post",
			data:"reqId="+reqId+"&resId="+resId+"&mode=editSecondStep&requestDecId=<?php echo $requestDecId; ?>",
			dataType:"json",
			success:function(data, textStatus, jqXHR){
				var json = [];
				$.each(data, function(i,v){
					var rid = v.ResourceId;
					//reqTransId=[];
					var jsonObj = {};
					jsonObj.resId = rid;
					var ai = oTable.fnAddData([v.Code,
												v.ResourceName,
												v.UnitName
											]);
					
					var n = oTable.fnSettings().aoData[ai[0]].nTr;
					n.setAttribute('tid', v.ResourceId);
					n.setAttribute('class', "mainTr deleteTr_"+rid);
					var name = 'Production';
					if($('#decision_type').val() == '3')
						name = 'Hire';
					
					$("#subTableView tbody:first").append("<tr class='subTr_"+v.ResourceId+" deleteTr_"+rid+"'>"+
																		"<td colspan=3>"+
																			"<div class='subDiv'>"+
																				"<table class='table table-bordered'>"+
																					"<thead>"+
																						"<tr>"+
																							"<th>Request No</th>"+
																							"<th>Request Date</th>"+
																							"<th>Cost centre</th>"+
																							"<th>Bal Qty</th>"+
																							"<th>PO Qty</th>"+
																							"<th>Transfer</th>"+
																							"<th>"+name+"</th>"+
																						"</tr>"+
																					"</thead>"+
																					"<tbody>");
					reqTransId=[];
					$.each(v.request, function(reqi,reqv){
						reqTransIdObj = {};
						reqTransIdObj.reqTransId = reqv.RequestTransId;
						if($.inArray(reqv.RequestId, reqResId) == -1 || $.inArray(v.ResourceId, resIdOld) == -1){
												$("#subTableView .subTr_"+v.ResourceId+" tbody:first").append("<tr style='background-color:#f0f2f2;'  id='requestTr_"+reqv.RequestTransId+"'>"+
																													"<td>"+reqv.RequestNo+
																														"<input type='hidden' readonly class='form-control' name='poQtyH_"+reqv.RequestTransId+"' value='"+reqv.HideIApproveQty+"'>"+
																														"<input type='hidden' readonly class='form-control' name='transferH_"+reqv.RequestTransId+"' value='"+reqv.HideTApproveQty+"'>"+
																														"<input type='hidden' readonly class='form-control' name='productionH_"+reqv.RequestTransId+"' value='"+((name='Production')?reqv.HidePApproveQty:reqv.HideHApproveQty)+"'>"+
																													"</td>"+
																													"<td>"+reqv.ReqDate+"</td>"+
																													"<td>"+reqv.CostCentreName+"</td>"+
																													"<td>"+reqv.BalQty+"</td>"+
																													"<td class='tbl_input_td'><input type='text' "+((reqv.wbsResults.length>0)?'readonly':'')+" class='parent_txts tbl_input' oldVal='"+reqv.HideIApproveQty+"' name='poQty_"+reqv.RequestTransId+"' value='"+reqv.HideIApproveQty+"'></td>"+
																													"<td class='tbl_input_td'><input type='text' "+((reqv.wbsResults.length>0)?'readonly':'')+" class='parent_txts tbl_input' oldVal='"+reqv.HideTApproveQty+"' name='transfer_"+reqv.RequestTransId+"' value='"+reqv.HideTApproveQty+"'></td>"+
																													"<td class='tbl_input_td'><input type='text' "+((reqv.wbsResults.length>0)?'readonly':'')+" class='parent_txts tbl_input' oldVal='"+((name='Production')?reqv.HidePApproveQty:reqv.HideHApproveQty)+"' name='production_"+reqv.RequestTransId+"' value='"+((name='Production')?reqv.HidePApproveQty:reqv.HideHApproveQty)+"'></td>"+
																												"</tr>");
							if(reqv.wbsResults.length>0){

										$("#subTableView .subTr_"+v.ResourceId+" tbody:first").append("<tr class='backgroundtr_vendor'>"+
																				"<td colspan=7>"+
																					"<div class='subDiv'>"+
																						"<table class='table'>"+
																							"<thead>"+
																								"<tr>"+
																									"<th width='8%' style='border-left:none !important; border-top:none !important; border-bottom:none !important; background-color:#eefdfe !important; border-right:1px solid #ddd !important;'></th>"+
																									"<th class='vendor_entrytableborder'>WBS Name</th>"+
																									"<th class='vendor_entrytableborder'>Quantity</th>"+
																									"<th class='vendor_entrytableborder'>Bal qty</th>"+
																									"<th class='vendor_entrytableborder'>PO qty</th>"+
																									"<th class='vendor_entrytableborder'>Transfer</th>"+
																									"<th class='vendor_entrytableborder'>"+name+"</th>"+
																								"</tr>"+
																							"</thead>"+
																							"<tbody>");
						
						
							reqTransIdObj.reqAHTransId = [];
							$.each(reqv.wbsResults, function(wbsi,wv){
								reqTransIdObj.reqAHTransId.push(wv.RequestAHTransId);
													$("#subTableView tbody:last").append("<tr>"+
																						"<td width='8%' class='vendor_entryfortable'></td>"+
																						"<td class='vendor_entrytableborder'>"+wv.WbsName+" <input type='hidden' class='form-control noVal' name='wbsName_"+wv.RequestAHTransId+"' value='"+wv.AnalysisId+"'>"+
																							"<input type='hidden' readonly class='form-control' name='poWbsQtyH_"+wv.RequestAHTransId+"' value='"+wv.HiddenIApproveQty+"'>"+
																							"<input type='hidden' readonly class='form-control' name='transferWbsH_"+wv.RequestAHTransId+"' value='"+wv.HiddenTApproveQty+"'>"+
																							"<input type='hidden' readonly class='form-control' name='productionWbsH_"+wv.RequestAHTransId+"' value='"+((name='Production')?wv.HiddenPApproveQty:wv.HiddenHApproveQty)+"'>"+
																						"</td>"+
																						"<td class='vendor_entrytableborder'>"+wv.Quantity+"</td>"+
																						"<td class='vendor_entrytableborder'>"+wv.BalQty+"</td>"+
																						"<td class='tbl_input_td vendor_entrytableborder'><input type='text' class-name='poQty' class='parent_txts tbl_input quantityVal poQty' eleName='poQty_"+reqv.RequestTransId+"' name='poWbsQty_"+wv.RequestAHTransId+"' value='"+wv.HiddenIApproveQty+"' autocomplete='off' data-toggle='tooltip' data-title='zsdfzdf' data-placement='top' data-trigger=''></td>"+
																						"<td class='tbl_input_td vendor_entrytableborder'><input type='text' class-name='transferQty' class='parent_txts tbl_input quantityVal transferQty' eleName='transfer_"+reqv.RequestTransId+"' name='transferWbs_"+wv.RequestAHTransId+"' value='"+wv.HiddenTApproveQty+"' autocomplete='off' data-toggle='tooltip' data-title='zsdfzdf' data-placement='top' data-trigger=''></td>"+
																						"<td class='tbl_input_td vendor_entrytableborder'><input type='text' class-name='productionQty' class='parent_txts tbl_input quantityVal productionQty' eleName='production_"+reqv.RequestTransId+"' name='productionWbs_"+wv.RequestAHTransId+"' value='"+((name='Production')?wv.HiddenPApproveQty:wv.HiddenHApproveQty)+"' autocomplete='off' data-toggle='tooltip' data-title='zsdfzdf' data-placement='top' data-trigger=''></td>"+
																					"</tr>");
							});
							
												$("#subTableView tbody:last").append("</tbody>"+
																				"</table>"+
																			"</div>"+
																			"</td>"+
																		"</tr>");
							}
							reqTransId.push(reqTransIdObj);
							$("#requestTr_"+reqv.RequestTransId).attr("jsonVal", JSON.stringify(reqTransIdObj));
						}
						else{
							$("#subTableView .subTr_"+v.ResourceId+" tbody:first").append($("#cloneTable #requestTr_"+reqv.RequestTransId).clone());
							$("#subTableView .subTr_"+v.ResourceId+" tbody:first").append($("#cloneTable #requestTr_"+reqv.RequestTransId).next("tr").clone());
							reqTransId.push($.parseJSON($("#cloneTable #requestTr_"+reqv.RequestTransId).attr("jsonVal")));
						}
					});
					jsonObj.reqTransId = reqTransId;
					
																		$(".subTr_"+v.ResourceId+" tbody:first").append("</tbody>"+
																				"</table>"+
																			"</div>"+
																		"</td>"+
																	"</tr>");
					json.push(jsonObj)
				});
				$("#totTrans").val(JSON.stringify(json));
				trClick();
			},
			complete:function(data){
				oTable.$("tr.mainTr").trigger("click");	
				resIdOld = resId.slice(0);
				reqResId = reqId;
				$("#cloneTable").html('');
				$('input[data-toggle="tooltip"]').tooltip();
			},
			error:function(jqXHR, textStatus, errorThrown){
				alert(textStatus+"-----"+errorThrown);
			}
		});			
	}

	/*1.allResource*/
	var initGrid = function () {				
		var source =
		{
			localData: <?php echo json_encode($allRequest); ?>,
			dataType: "json",
			dataFields:
			[
				{ name: 'RequestDate', type: 'string', type: "date", format: 'MM/dd/yyyy' },
				{ name: 'RequestNo', type: 'string' },
				{ name: 'CostCentreName', type: 'string' },
				{ name: 'Sel', type: 'string' }
			],
			id:'RequestId'
		};

		var dataAdapter = new $.jqx.dataAdapter(source,{
			loadComplete: function (data) {
				//alert("1");
			},
			loadError: function (xhr, status, error) {
				
			}
		});
   
		$("#allResource").jqxGrid({
			width: '100%',
			pageable: true,
			selectionMode: 'singleRow',
			pagerButtonsCount: 6,
			autoheight:true,
			//rowsheight:60,
			autorowheight: true,
			filterable: true,
			sortable: true,
			//filtermode: 'advanced',				
			columnsResize: true,
			showfilterrow: true,
			ready: function(){
				var localizationobj = {};
				localizationobj.emptydatastring = "No request to display";
				$("#allResource").jqxGrid('localizestrings', localizationobj);
			},							
			selectionmode: 'checkbox',						
			source: dataAdapter,
			columns: [
				  { text: 'RequestDate', filtertype: 'date', cellsformat: 'dd-MM-yyyy', editable: false, datafield: 'RequestDate'},
				  { text: 'RequestNo', editable: false,datafield: 'RequestNo'},
				  { text: 'CostCentreName', editable: false,datafield: 'CostCentreName'},
				  { text: 'Sel', editable: false,datafield: 'Sel', hidden:true},
			]
		});
		reqId=[];
		
		$.each(<?php echo json_encode($allRequest); ?>, function(i,v){
			var rid = v.RequestId;
			if(v.Sel == 1){
				editRequest.push(rid);
				var mindex = $('#allResource').jqxGrid('getrowboundindexbyid', rid);
				if(mindex!=-1)
					$('#allResource').jqxGrid('selectrow', mindex);
			}
		});
		
		$('#allResource').on('rowclick', function (event){
			var args = event.args;
			// row's bound index.
			var boundIndex = args.rowindex;
			var index = $('#allResource').jqxGrid('selectedrowindexes'); 
			//alert($.inArray(boundIndex, index))
			if($.inArray(boundIndex, index) == -1)
				$('#allResource').jqxGrid('selectrow', boundIndex);
			else
				$('#allResource').jqxGrid('unselectrow', boundIndex);
		});	
		
		$('#allResource').on('rowselect', function(event){
			// event arguments.
			var args = event.args;
			// row's bound index.
			var rowBoundIndex = args.rowindex;
			// row's data. The row's data object or null(when all rows are being selected or unselected with a single action). If you have a datafield called "firstName", to access the row's firstName, use var firstName = rowData.firstName;
			var rowData = args.row;
		});	
		$('#allResource').on('rowunselect', function(event){
			// event arguments.
			var args = event.args;
			// row's bound index.
			var rowBoundIndex = args.rowindex;
			// row's data. The row's data object or null(when all rows are being selected or unselected with a single action). If you have a datafield called "firstName", to access the row's firstName, use var firstName = rowData.firstName;
			var rowData = args.row;
		});
	
	}
	initGrid();
	
</script>