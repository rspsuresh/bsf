<!--STYLE-->
<link rel="stylesheet" href="<?php echo $this->basePath() . '/css/workorder.css';?>"/>
<link rel="stylesheet" href="<?php echo $this->basePath() . '/css/wpm.css';?>"/>
<!--STYLE-->
<style>
    .panel {
        border-radius:0px !important;
    }
    .panel-info {
        border:none;
        border-top:none;
    }
</style>

<!--content-->
<div class="content_wrapper padlr0">
    <div class="container-fluid">
        <div class="row">
            <form method="post" id="formWrapper" action="<?php echo $this->basePath(); ?>/ats/index/sampleent">
                <input type="hidden" id="CostCentre" name="CostCenterId" value="<?php echo (isset($CostCentre)) ? $CostCentre : '';?>">
                <input type="hidden" name="RequestType" value="<?php echo (isset($RequestType)) ? $RequestType : '';?>">
                <input type="hidden" name="ReqNo" value="<?php echo (isset($ReqNo)) ? $ReqNo : '';?>">
                <input type="hidden" name="ReqDate" value="<?php echo (isset($ReqDate)) ? $ReqDate : '';?>">
                <div class="col-lg-12">
                    <h1>Request Entry</h1>
                </div>
                <div class="col-lg-12">
                    <div class="col-lg-4">
                        <div class="panel-box">
                            <ul>
                                <li>
                                    <label>Cost Centre</label>
                                    <span><?php echo (isset($costcenter)) ? $costcenter['CostCentreName'] : '';?></span>
                                </li>

                                <li>
                                    <label>Request Type</label>
                                    <span><?php echo (isset($RequestType)) ? ucfirst($RequestType) : '';?></span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="panel-box box2th">
                            <ul>
                                <li>
                                    <label>Request Date</label>
                                    <span><input type="text" placeholder="DD-MM-YYYY" class="date_picker" name="ReqDate" value="<?php echo (isset($ReqDate)) ? $ReqDate : date('d-m-Y');?>" readonly/></span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="panel-box box3th">
                            <ul>
                                <li>
                                    <label>Request No.</label>
                                    <span><input type="text" placeholder="xxxxx" name="RequestNo" value="<?php echo (isset($ReqNo)) ? $ReqNo : '';?>" readonly/></span>
                                </li>
                                <li>
                                    <label>CCRequest No.</label>
                                    <span><input type="text" placeholder="xxxxx" name="CCReqNo" value="<?php echo (isset($CCReqNo)) ? $CCReqNo : '';?>"/></span>
                                </li>
                                <li>
                                    <label>CRequest No.</label>
                                    <span><input type="text" placeholder="xxxxx" name="CReqNo" value="<?php echo (isset($CReqNo)) ? $CReqNo : '';?>"/></span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="clearfix"></div>
                <div class="col-lg-12 clear top-20">
                    <div id="accordion" class="panel-group">
                        <!-------------------------------Bill of Quantities------------------------------->
                        <div class="panel panel-info">
                            <div data-target="#collapseOne" data-parent="#accordion" data-toggle="collapse" class="panel-heading collapsed panel_heads" id="panelheading-1">
                                <h4 class="panel-title accordion-toggle defa_panels">Enter Request Quantity</h4>
                            </div>
                            <div class="panel-collapse collapse" id="collapseOne" style="height: 0px;">
                                <div class="panel-body bgcolr">
                                    <div class="col-lg-12">
                                        <div class="table-responsive top-30">
                                            <table class="table" style=" margin-bottom:0px;" id="workorderTable">
                                                <thead>
                                                <tr>
                                                    <th>Code</th>
                                                    <th>Description</th>
                                                    <th>Unit</th>
                                                    <th>Required Date</th>
                                                    <th>Remarks</th>
                                                    <th>Qty</th>
                                                </tr>
                                                </thead>
                                                <tbody class="main"></tbody>
                                            </table>
                                            <input type="hidden" name="rowid" id="rowid" value="0"/>
                                        </div>
                                        <div class="cont_bt col-lg-5 col-lg-offset-7 col-md-9 col-md-offset-3 col-sm-7 col-sm-offset-5 col-xs-7 col-xs-offset-5">
                                            <ul>
                                                <li><a href="javascript:nextAccordian(2)">Continue &nbsp;<i class="fa fa-chevron-circle-right"></i></a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-------------------------------Bill of Quantities end------------------------------->
                        <!-------------------------------Terms and Condition------------------------------->
                        <div class="panel panel-info">
                            <div data-target="#collapseTwo" data-parent="#accordion" data-toggle="collapse" class="panel-heading collapsed panel_heads" id="panelheading-2">
                                <h4 class="panel-title accordion-toggle defa_panels">Other Details</h4>
                            </div>
                            <div class="panel-collapse collapse" id="collapseTwo" style="height: 0px;">
                                <div class="panel-body bgcolr">
                                    <div class="clearfix"></div>
                                    <div class="col-lg-12">
                                        <div class="card">
                                            <ul class="nav nav-tabs">
                                                <li><a href="#Note" aria-controls="settings" role="tab" data-toggle="tab">Narration</a></li>
                                            </ul>
                                            <div class="tab-pane" id="Note">
                                                <p>
                                                <div class="col-lg-12">
                                                    <textarea class="exp-tex" name="Narration" id="Narration"> <?php echo (isset($Narration)) ? $Narration : '';?> </textarea>
                                                </div>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-------------------------------Terms and Condition------------------------------->
                </div>
        </div>
        <div class="clearfix"></div>

    </div>
</div>
</div>
<div class="col-lg-12 savebtn_area">
    <ul>
        <li class="dropdown save_btn float_r"><input type="submit" data-toggle="tooltip" class="ripple" name="Submit" title="Submit" value="Submit"/>
        <li class="cancel_btn float_r"><a href="<?php echo $this->basePath();?>/ats/index/sample" data-toggle="tooltip" class="ripple" title="Go back!">Back</a></li>
    </ul>
</div>
</form>
<script id="resource-template"  type="text/template" class="hide">
    <tr>
        <td width="10%"><input class="parent_text border-none" type="text" name="code__" id="code__" readonly/></td>
        <td width="25%">
            <input class="parent_text resourceSuggest" type="text" name="desc__" id="desc__" onfocus="checkResourceUsed(this);"/>
            <input type="hidden" name="resourceid__" id="resourceid__"/>
            <input type="hidden" name="itemid__" id="itemid__"/>
        </td>
        <td width="10%">
            <input class="parent_text border-none" type="text" name="unitname__" id="unitname__" readonly/>
            <input type="hidden" name="unitid__" id="unitid__"/>
        </td>
        <td width="15%">
            <div class='form-group col-lg-12'>
                <span class='date_icon'><i class='fa fa-calendar'></i></span>
                <input type="text" name="reqdate__" id="reqdate__" class='tbl_input datepickerinput' value='<?php echo Date('d/m/Y'); ?>' />
            </div>
        </td>
        <td width="20%"><input class="tbl_input changeVal" type="text" name="remarks__" id="remarks__" /></td>
        <td width="20%"><input class="tbl_input changeVal" type="text" name="qty__" id="qty__"  /></td>


        <td width="15%" align="center" class="action_btns_td">
            <ul class="action_btns">
                <li> <a href="#"  id="deleteTr__" style="display:none;"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                <li> <a href="#" class="mainTr" id="expandTr__" style="display:none;"> <i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="left" data-original-title="Add lines" ></i></a> </li>
            </ul>
        </td>
    </tr>
    <tr style="display:none;" class="subTr">
        <td colspan="9" style="padding:0px !important; "><div class="subDiv" style="display:none;">
                <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"> </div>
                <div class="col-lg-12">
                    <div class="table-responsive topsp">
                        <table class="table" style="margin-bottom:0px;" id="iowTable__">
                            <thead>
                            <tr>
                                <th>Wbs Name</th>
                                <th>Qty</th>
                            </tr>
                            </thead>
                            <tbody class="main"></tbody>
                            <tbody class="total">
                            <tr>
                                <td colspan="3"></td>
                                <td align="right" class="rate_pri">Total Qty</td>
                                <td width="10%"><input class="parent_text border-none" type="text" name="totalqty__" id="totalqty__" readonly/></td>
                            </tr>
                            </tbody>
                            <input type="hidden" name="iow___rowid" id="iow___rowid" value="0"/>
                        </table>
                    </div>
                </div>
            </div>
        </td>
    </tr>
</script>
<script id="iow-template"  type="text/template" class="hide">
    <tr>
        <td width="30%">
            <input type="hidden"  name="iow___wbsid_0" id="iow___wbsid_0" readonly/>
            <input class="parent_text border-none" type="text" name="iow___wbsname_0" id="iow___wbsname_0" readonly/>
        </td>
        <td width="25%"><input class="parent_text" type="text" name="iow___qty_0" id="iow___qty_0" onkeypress="return isNumberKey(event,this)" onchange="calcQuantity(this);"/></td>
    </tr>
</script>



<script type="text/javascript">
var arr_resources = <?php echo (isset($arr_resources)) ? json_encode($arr_resources) : '[]';?>;
var tmp_arr_resources = arr_resources;
var arr_requestResources = <?php echo (isset($arr_requestResources)) ? json_encode($arr_requestResources) : '[]';?>;
var arr_resource_iows = <?php echo (isset($arr_resource_iows)) ? json_encode($arr_resource_iows) : '[]';?>;

$(function () {
    var $rowid = $('#rowid');
    var template = $('#resource-template').html();
    var iowtemplate = $('#iow-template').html();
    var rowid = 0;
    var $tbody = $('#workorderTable').find('> tbody.main');
    if(arr_requestResources.length != 0) {
        $.each(arr_requestResources, function(i, o) {
            rowid += 1;
            $tbody.append(template.replace(/__/g, '_' + rowid));

            $('#code_' + rowid).val(o.Code).addClass('border-none').prop('disabled', false);
            $('#desc_' + rowid).val(o.ResourceName).addClass('border-none').prop('disabled', false);
            $('#resourceid_' + rowid).val(o.ResourceId);
            $('#resourceid_' + rowid).val(o.ResourceId);
            $('#itemid_' + rowid).val(o.ItemId);
            $('#unitname_' + rowid).val(o.UnitName);
            $('#unitid_' + rowid).val(o.UnitId);
            $('#expandTr_' + rowid).show();
            $('#deleteTr_' + rowid).show();

            $.each(arr_resource_iows, function(j, l) {
            if(l.ResourceId != o.ResourceId && l.ItemId != o.ItemId) {
                return;

                var iowrowid = parseInt($('#iow_'+rowid+'_rowid').val()) + 1;
                $('#iowTable_' + rowid).find('tbody.main').append(iowtemplate.replace(/__/g, '_' + rowid).replace(/_0/g, '_' + iowrowid));
                $('#iow_'+rowid+'_rowid').val(iowrowid);
                $('#iow_'+ rowid +'_wbsid_'+ iowrowid).val(l.WBSId);
                $('#iow_'+ rowid +'_wbsname_'+ iowrowid).val(l.WbsName);
                $('#iow_'+ rowid +'_qty_'+ iowrowid).val(l.Qty)
            });
        });
    }
    rowid += 1;
    $tbody.append(template.replace(/__/g, '_' + rowid));
    $rowid.val(rowid);
    bindResourceAutocomplete();

    $('.content_wrapper').on('click','.mainTr',function(e){
        e.preventDefault();
        if(!$(this).closest("tr").next(".subTr").is(":visible")){
            $(this).closest("tr").next(".subTr").show();
            $(this).closest("tr").next(".subTr").find(".subDiv").slideDown("slow");
            $(this).find("i").addClass("tform");
        }
        else{
            $(this).closest("tr").next(".subTr").find(".subDiv").slideUp("slow");
            $(this).closest("tr").next(".subTr").slideUp("slow");
            $(this).find("i").removeClass("tform");
        }
    });

    nextAccordian(1);
});

function bindResourceAutocomplete() {
    // bind resource autocomplete
    $('#workorderTable .resourceSuggest').autocomplete({
        lookup: tmp_arr_resources,
        lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
            if (queryLowerCase == '*') {
                return suggestion.value;
            } else {
                var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                return re.test(suggestion.value);
            }
        }, onSelect: function (suggestion) {

            if (suggestion) {
                var $this = $(this);
                var rowid = $this[0].id.split('_')[1];
                $this.prop('readonly', true).addClass('border-none');
                $('#resourceid_' + rowid).val(suggestion.data);
                $('#unitname_' + rowid).val(suggestion.UnitName);
                $('#code_' + rowid).val(suggestion.Code);
                $('#unitid_' + rowid).val(suggestion.UnitId);
                $('#expandTr_' + rowid).show();
                bindResourceIOW($this);
                addNewResourceRow($this);
            }
        }, onSearchStart: function (suggestion) {
            var rowid = $(this)[0].id.split('_')[1];
            $('#unitname_' + rowid).val('');
            $('#rate_' + rowid).val('');
        }, onSearchComplete: function (query, suggestions) {
            if(!suggestions.length) {
                var rowid = $(this)[0].id.split('_')[1];
                $('#unitname_' + rowid).val('');
                $('#rate_' + rowid).val('');
            }
        }
    });
}

function bindResourceIOW(x) {
    var rowid = $(x)[0].id.split('_')[1];
    var $iowrowid = $('#iow_' + rowid + '_rowid');
    var resourceId = $('#resourceid_' + rowid).val();
    var costcentre=$('#CostCentre').val();
    $('.loading_area').show();
    $.ajax({
        url: getBaseURL() + 'ats/index/entry-sample',
        type: "post",
        data: {'Type': 'getwbsdetails', 'ResourceId': resourceId, 'CostCentre': costcentre},
        async: false,
        success: function (data, textStatus, jqXHR) {
            if(jqXHR.status == 200) {
                data = JSON.parse(data);
                var iowtemplate = $('#iow-template').html();
                $.each(data, function (i,l) {
                    var iowrowid = parseInt($iowrowid.val()) + 1;
                    $('#iowTable_' + rowid).find('tbody.main').append(iowtemplate.replace(/__/g, '_' + rowid).replace(/_0/g, '_' + iowrowid));
                    $iowrowid.val(iowrowid);
                    $('#iow_' + rowid + '_wbsname_' + iowrowid).val(l.WbsName);
                    $('#iow_' + rowid + '_wbsid_' + iowrowid).val(l.WBSId);
                    $('#iow_' + rowid + '_qty_' + iowrowid).val();
                });
            }
            $('.loading_area').hide();
        }, error: function (jqXHR, textStatus, errorThrown) {
            $('.loading_area').hide();
        }
    });
}

function addNewResourceRow(x) {
    var $tr = $(x).closest('tr');
    if ($tr.next('tr:not(.subTr)').length != 0)
        return;

    var $rowid = $('#rowid'),
        rowid = parseInt($rowid.val()),
        $tbody = $('#workorderTable').find('> tbody.main');

    $('#deleteTr_' + rowid).show();
    var count = rowid + 1,
        template = $('#resource-template').html();

    template = template.replace(/__/g, '_' + count);
    $tbody.append(template);

    $rowid.val(count);
    bindResourceAutocomplete();
}

function checkResourceUsed(x) {
    var id = $(x)[0].id.split('_')[1];
    var reskeyid = $('input[id*=resourceid_]');
    tmp_arr_resources = arr_resources;
    tmp_arr_resources = $.grep(arr_resources, function (element, index) {
        var is_selected = true;
        $.each(reskeyid, function (i, obj) {
            var $this = $(this),
                name = $this[0].id;
            var arrname = name.split('_');
            var key1 = arrname[1];
            if (key1 != id) {
                if (element.data == $this.val()) {
                    is_selected = false;
                    return false;
                }
            }
        });
        return is_selected;
    });
    bindResourceAutocomplete();
}

function nextAccordian(id) {
    $('#panelheading-' + id).trigger('click');
}

function calcQuantity(x) {
    var $x = $(x);
    var ids = $x[0].id.split('_');
    var rowid = ids[1];

    // calc total qty
    var totalQty=0;
    $.each($('input[id^=iow_'+rowid+'_qty_'), function (i,o) {
        var qty = parseInt($(this).val());
        if(isNaN(qty))
            qty = 0;

        totalQty += qty;
    });

    $('#qty_'+rowid).val(sanitizeNumber(totalQty,0));

    // calc total amount
    var rate = parseFloatVal($('#rate_'+rowid).val());
    $('#amount_'+rowid).val(sanitizeNumber(totalQty * rate));
    calcTotal();
}

function calcTotal() {
    var total = 0;
    $.each($('input[id^=amount_]'), function (i,o) {
        total += parseFloatVal($(this).val());
    });
    $('#total').val(sanitizeNumber(total));
}
function validate() {
    form.submit();
}
</script>
