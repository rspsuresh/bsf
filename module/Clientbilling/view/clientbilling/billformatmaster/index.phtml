<!--STYLE-->
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/js/tableHeadFixers.js"></script>
<link rel="stylesheet" href="<?php echo $this->basePath() . '/css/workorder.css';?>"/>
<link rel="stylesheet" href="<?php echo $this->basePath() . '/css/wpm.css';?>"/>
<!--STYLE-->
<style>
.butclr {float:left; padding:5px; margin-top:3px; ba}
.sam-up{ color:#fff;}
.fixTable tr th{ z-index:999 !important; border-bottom:3px solid #5D9BB6 !important;}
</style>
<!--content-->
<div class="content_wrapper padlr0">
  <form id="formWrapper" method="post">
    <div class="container-fluid">
      <div class="col-lg-4 col-lg-offset-0 col-md-4 col-md-offset-0 col-sm-4 col-sm-offset-0">
        <h1>Bill Format</h1>
      </div>
      <div class="col-lg-8">
      <label class="col-lg-3 col-lg-offset-0 col-md-3 col-md-offset-0 col-sm-3 col-sm-offset-0 control-label text-right">Cost Centre</label>
        <div class="col-lg-5 col-lg-offset-0 col-md-5 col-md-offset-0 col-sm-5 col-sm-offset-0 form-group">
          <select class="form-control single_dropdown lbl_move" name="costCentreId" id="costCentreId"  style="width:100%;">
            <option></option>
            <?php if(isset($arr_costcenter)):
                            foreach($arr_costcenter as $costcenter):?>
            <option value="<?php echo $costcenter['CostCentreId'];?>"><?php echo $costcenter['CostCentreName'];?></option>
            <?php endforeach;
                        endif; ?>
          </select>
        </div>
        <div class="col-lg-4"> <span class="butclr btn-file" id="copyformat" onclick="showBillFormat()"> <i class="fa fa-folder-open sap"></i>
          <p class="sam-up" >Format Copy From</p>
          </span> <span class="butclr btn-file" id="bill-format-clear"> <i class="fa fa-remove sap"></i>
          <p class="sam-up" >Clear All</p>
          </span> </div>
      </div>
      
      <div class="col-lg-12 clear animated fadeInUp">
        <div class="table-responsive topsp parent-scroll">
          <table class="table fixTable" style=" margin-bottom:0px;" id="billFormatTable">
            <thead>
              <tr>
                <th>&nbsp;</th>
                <th>Sl No</th>
                <th>Description</th>
                <th>Type Name</th>
                <th>Formula</th>
                <th>&nbsp;</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
          <input type="hidden" name="billformatrowid" id="billformatrowid" value="0"/>
          <input type="hidden"  name="billformatrowdeleteids" id="billformatrowdeleteids" value="0"/>
        </div>
      </div>
    </div>
  </form>
</div>
<div class="col-lg-12 savebtn_area">
  <ul>
    <li class="dropdown save_btn float_r"><a onclick="submitForm(); return false;" data-toggle="tooltip" class="ripple" title="Submit">Submit</a>
    <li class="cancel_btn float_r"><a href="<?php echo $this->basePath(); ?>/clientbilling/billformatmaster/index" data-toggle="tooltip" class="ripple">Cancel</a></li>
  </ul>
</div>

<!--BillFormatModal-->
<div id="billformatmodal" class="modal fade" role="dialog" data-backdrop="static" data-keyboard="false ">
  <div class="modal-dialog"  style="width:1024px;">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><i class="fa fa-times-circle-o clpot"></i></button>
        <h1>Bill Format</h1>
      </div>
      <div class="modal-body">
        <div class="col-lg-5 col-lg-offset-0 col-md-5 col-md-offset-0 col-sm-5 col-sm-offset-0 col-xs-3 col-xs-offset-0">
          <input type="hidden" name="wgrowid" id="wgrowid">
          <div class="col-lg-12">
            <div id="wojqxGrid"> </div>
          </div>
        </div>
        <div class="col-lg-7 col-lg-offset-0 col-md-7 col-md-offset-0 col-sm-7 col-sm-offset-0 col-xs-5 col-xs-offset-0">
          <div class="topsp">
            <table class="table tableWithFloatingHeader" style=" margin-bottom:0px;" id="vtabillformat" >
              <thead>
                <tr>
                  <th>&nbsp;</th>
                  <th>S/No</th>
                  <th>Description</th>
                  <th>Type Name</th>
                  <th>Formula</th>
                </tr>
              </thead>
              <tbody>
                <tr class="padi05" id="vrowid_1">
                  <td width="1%" style="padding:0px !important;"><input class="text-reon" type="text" name="vrowname_1" id="vrowname_1" readonly/></td>
                  <td width="1%" style="padding:0px !important;"><input class="text-reon" type="text" name="vslno_1" id="vslno_1" readonly/></td>
                  <td width="4%" style="padding:0px !important;"><input class="text-reon" type="text" name="vdescription_1" id="vdescription_1"  readonly/></td>
                  <td width="4%" style="padding:0px !important;"><input class="text-reon" type="text" name="vtypename_1" id="vtypename_1"  readonly/></td>
                  <td width="2%" style="padding:0px !important;"><input class="text-reon" type="text" name="vformula_1" id="vformula_1" readonly/></td>
                  <input type="hidden" name="vbillformatid_1" id="vbillformatid_1"/>
                  <input type="hidden" name="vbillformatsortid_1" id="vbillformatsortid_1"/>
                  <input type="hidden" name="vbold_1" id="vbold_1"/>
                  <input type="hidden" name="vitalic_1" id="vitalic_1"/>
                  <input type="hidden" name="vunderline_1" id="vunderline_1"/>
                </tr>
              </tbody>
            </table>
            <input type="hidden" name="vbillformatrowid" id="vbillformatrowid" value="1"/>
          </div>
        </div>
      </div>
      <div class="clearfix"></div>
      <div class="modal-footer">
        <div class="col-lg-12"> <a href="#" class="md_cance" data-dismiss="modal" style="position: relative; overflow: hidden;">Cancel<span class="ripple-wrapper"></span><span class="ripple-wrapper"></span></a>
          <button type="button" class="md_ok" onclick="copyBillFormat()">Paste</button>
        </div>
      </div>
    </div>
  </div>
</div>
<script type="text/template" id="templateBillFormat">
    <tr id="billformatrowid__">
        <input type="hidden" name="transId__" id="transId__" value="0"/>
        <input type="hidden" name="updateRow__" id="updateRow__" value="0"/>
        <td width="3%"><label id="rowname__"></label></td>
        <td width="5%"><input class="parent_text" type="text" name="slno__" id="slno__"/></td>
        <td width="12%"><div class="on-focus clearfix" style="position:relative;">
                <textarea name="billformatdesc__" id="billformatdesc__" class="parent_texts" onchange="addNewBillformatRow(this)"></textarea>
                <div class="tool-tip slideIn ch-b">
                    <div class="bin">
                        <ul>
                            <li>
                          <span class="checked-b">
                              <label>
                                  <input type="checkbox" name="textbold__" id="textbold__" onchange="return boldBillFormat(this.id)"/>
                                  <span>Bold</span>
                              </label>
                             </span>
                            </li>
                            <li>
                           <span class="checked-b">
                            <label>
                                <input type="checkbox" name="textitalic__" id="textitalic__" onchange="return italicBillFormat(this.id)"/>
                                <span>Italic</span>
                            </label>
                             </span>
                            </li>
                            <li>
                           <span class="checked-b">
                             <label>
                                 <input type="checkbox" name="textunderline__" id="textunderline__" onchange="return underlineBillFormat(this.id)"/>
                                 <span>Underline</span>
                             </label>
                          </span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div></td>
        <td width="10%"><input class="parent_text" type="text" name="typename__" id="typename__" onfocus="return checkFormatUsed(this)" />
            <input type="hidden" name="billformatid__" id="billformatid__" />
            <input type="hidden" name="billformatsortid__" id="billformatsortid__" />
        </td>
        <td width="5%"><input class="parent_text" type="text" name="formula__" id="formula__" onkeypress="return isFormula(event);" onfocus="formulaToggleReadonly(this);" readonly/></td>
        <td width="1%">
            <ul class="action_btns">
                <li>
                    <a id="billformatdelete__" onclick="deletebillformat(this, event, true);" style="display: none;"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete" ></i></a>
                </li>
            </ul>
        </td>
    </tr>
</script> 
<script type="text/template" id="templateWOBillFormat">
    <tr class="padi05" id="vrowid__">
        <td width="1%" style="padding:0px !important;"><input class="text-reon" type="text" name="vrowname__" id="vrowname__"  readonly/></td>
        <td width="1%" style="padding:0px !important;"><input class="text-reon" type="text" name="vslno__" id="vslno__"  readonly/></td>
        <td width="4%" style="padding:0px !important;"><input class="text-reon" type="text" name="vdescription__" id="vdescription__"  readonly/></td>
        <td width="4%" style="padding:0px !important;"><input class="text-reon" type="text" name="vtypename__" id="vtypename__" readonly/></td>
        <td width="2%" style="padding:0px !important;"><input class="text-reon" type="text" name="vformula__" id="vformula__"  readonly/></td>
        <input type="hidden" name="vbillformatid__" id="vbillformatid__"/>
        <input type="hidden" name="vbillformatsortid__" id="vbillformatsortid__" value="1" />
        <input type="hidden" name="vbold__" id="vbold__"/>
        <input type="hidden" name="vitalic__" id="vitalic__"/>
        <input type="hidden" name="vunderline__" id="vunderline__"/>
    </tr>
</script> 
<script type="text/javascript">
    var arr_billformats = <?php echo (isset($arr_billformats)) ? json_encode($arr_billformats) : '[]'?>;
    var arr_billformatmaster = <?php echo (isset($arr_billformatmaster)) ? json_encode($arr_billformatmaster) : '[]';?>;
    var tmp_arr_billformatmaster = arr_billformatmaster;

    var arr_billwoformattemplates = <?php echo (isset($arr_wobillformattemplates)) ? json_encode($arr_wobillformattemplates) : '[]'?>;
    arr_billwoformattemplates.push({'WorkOrderId': '0', 'WONo': 'Default', 'ProjectName': 'Default'});
    $(function () {
        var template = $('#templateBillFormat').html();
        var $tbody  = $('#billFormatTable tbody');
        var rowCount = 0;
        if(arr_billformats.length != 0) {
            $.each(arr_billformats, function (i, o) {
                rowCount++;
                $tbody.append(template.replace(/__/g, '_' + rowCount));
                $('#billformatsortid_' + rowCount).val(rowCount);
            });
            $('#copyformat').hide();
            $('#bill-format-clear').show();
        } else {
            $('#copyformat').show();
            $('#bill-format-clear').hide();
        }

        // add new row
        rowCount++;
        $tbody.append(template.replace(/__/g, '_'+rowCount));
        $('#billformatsortid_' + rowCount).val(rowCount);
        $('#billformatrowid').val(rowCount);
        bindBillFormatAutoComplete();
        bindMixSortablefn(true);
        if(rowCount == 1)
            $('#bill-format-clear').hide();

        // wo bill format templates start
        var $wojqxGrid = $("#wojqxGrid");
        var source = {
            localdata: arr_billwoformattemplates,
            async: false,
            dataType: "json",
            dataFields: [
                { name: 'WorkOrderId', type: 'number' },
                { name: 'WONo', type: 'number' },
                { name: 'ProjectName', type: 'string' }
            ],
            id: 'WorkOrderId'
        };
        var dataAdapter = new $.jqx.dataAdapter(source);
        $wojqxGrid.jqxGrid({
            width: "100%",
            source: dataAdapter,
            sortable: true,
            pagerButtonsCount: 6,
            filterable:true,
            pageable:true,
            rowDetails: true,
            autoheight: true,
            selectionmode: 'singlerow',
            showfilterrow: true,
            editable: false,
            enabletooltips: true,
            columns: [
                { text: 'WorkOrderId', datafield: 'WorkOrderId', hidden: true, filterable: false},
                { text: 'WO No.', dataField: 'WONo'},
                { text: 'ProjectName', dataField: 'ProjectName'}
            ]
        });
        $wojqxGrid.bind('rowselect', function(event)  {
            var current_index = event.args.rowindex;
            var datarow = $wojqxGrid.jqxGrid('getrowdata', current_index);
            var iwoid = datarow['WorkOrderId'];
            $.post( getBaseURL() + 'clientbilling/billformatmaster/index', {'type': 'billformat', 'woId':iwoid}, function( data ) {
                data = $.parseJSON(data);
                var k=0;
                var template = $("#templateWOBillFormat").html();
                $('#vtabillformat tr:gt(1)').remove();

                $('#vrowid_1').removeClass('text_bold text_italic text_underline');
                $('#vrowname_1').val('');
                $('#vslno_1').val('');
                $('#vdescription_1').val('');
                $('#vtypename_1').val('');
                $('#vformula_1').val('');
                $('#vbillformatid_1').val('');
                $('#vbillformatsortid_1').val('');
                $('#vbold_1').val('');
                $('#vitalic_1').val('');
                $('#vunderline_1').val('');
                $('#vbillformatrowid').val(1);

                for (var j = 0; j < data.length; j++) {
                    k++;
                    if (k != 1)
                        $("#vtabillformat tbody").append(template.replace(/__/g, '_'+k));

                    if (data[j]['Bold']=='1') $('#vrowid_' + k).addClass('text_bold');
                    if (data[j]['Italic']=='1') $('#vrowid_' + k).addClass('text_italic');
                    if (data[j]['Underline']=='1') $('#vrowid_' + k).addClass('text_underline');

                    $('#vrowname_' + k).val(data[j]['RowName']);
                    $('#vslno_' + k).val(data[j]['Slno']);
                    $('#vdescription_' + k).val(data[j]['Description']);
                    $('#vtypename_' + k).val(data[j]['TypeName']);
                    $('#vformula_' + k).val(data[j]['Formula']);
                    $('#vbillformatid_' + k).val(data[j]['BillFormatId']);
                    $('#vbillformatsortid_' + k).val(data[j]['SortId']);

                    $('#vbold_' + k).val(data[j]['Bold']);
                    $('#vitalic_' + k).val(data[j]['Italic']);
                    $('#vunderline_' + k).val(data[j]['Underline']);
                    $('#vbillformatrowid').val(k);
                }
            });
        });
        // wo bill format templates end

        $('#bill-format-clear').on('click', function (e) {
            e.preventDefault();
            //reset boq table
            var $tbody = $('#billFormatTable tbody:not(.total)');
            $tbody.html('');
            var $boqrowid = $('#billformatrowid');
            $tbody.append(template.replace(/__/g, '_1'));
            $('#billformatsortid_' + rowCount).val(1);
            $boqrowid.val(1);
            $('#billformatrowdeleteids').val(0);

            if($('#deleteBillFormats').length == 0) {
                $boqrowid.after('<input type="hidden" name="deleteBillFormats" id="deleteBillFormats" value="1"/>');
            }

            bindBillFormatAutoComplete();
            bindMixSortablefn(true);

            $('#copyformat').show();
            $(this).hide();
            return false;
        });

        $('#costCentreId').on('change', function () {
            var costCentreId = isNullCheck($(this).val(), 'number');
            if(costCentreId == 0) {
                $('#billFormatTable tbody').html($('#templateBillFormat').html().replace(/__/g, '_'+1));
                $('#billformatsortid_' + 1).val(1);
                $('#billformatrowid').val(1);
                bindBillFormatAutoComplete();
                bindMixSortablefn(true);
                $('#copyformat').show();
                $('#bill-format-clear').hide();
                return;
            }

            $.ajax({
                url:getBaseURL()+'clientbilling/billformatmaster/index',
                type:"post",
                data:{'CostCentreId':costCentreId, 'type': 'billformattrans'},
                success:function(data, textStatus, jqXHR){
                    if(jqXHR.status != 200 )
                        return;

                    data = JSON.parse(data);
                    var template = $('#templateBillFormat').html();
                    var rowCount = 0;
                    var $tbody  = $('#billFormatTable tbody');
                    $tbody.html('');
                    $.each(data, function (i, o) {
                        rowCount++;
                        $tbody.append(template.replace(/__/g, '_' + rowCount));
                        if(o.BillFormatId != '0' && o.BillFormatId != '')
                            $('#rowname_' + rowCount).html('R' + o.BillFormatId);

                        $('#billformatdelete_' + rowCount).show();
                        $('#transId_'+ rowCount).val(o.BillFormatTransId);
                        $('#slno_'+ rowCount).val(o.Slno);
                        $('#billformatdesc_'+ rowCount).val(o.Description);
                        $('#typename_'+ rowCount).val(o.TypeName);
                        $('#billformatid_'+ rowCount).val(o.BillFormatId);
                        $('#billformatsortid_'+ rowCount).val(o.SortId);
                        $('#formula_'+ rowCount).val(o.Formula);

                        if (isNullCheck($('#billformatid_'+ rowCount).val(),'number') !=0) {
                            $('#typename_' + rowCount).prop('readonly', true);
                        }

                        if (o.Bold == '1') {
                            $('#textbold_' + rowCount).prop("checked", true);
                            $('#billformatrowid_' + rowCount).addClass("text_bold")
                        } else {
                            $('#textbold_' + rowCount).prop("checked", false);
                            $('#billformatrowid_' + rowCount).removeClass("text_bold")
                        }

                        if (o.Italic == '1') {
                            $('#textitalic_' + rowCount).prop("checked", true);
                            $('#billformatrowid_' + rowCount).addClass("text_italic")
                        } else {
                            $('#textitalic_' + rowCount).prop("checked", false);
                            $('#billformatrowid_' + rowCount).removeClass("text_italic")
                        }

                        if (o.Underline == '1') {
                            $('#textunderline_' + rowCount).prop("checked", true);
                            $('#billformatrowid_' + rowCount).addClass("text_underline")
                        } else {
                            $('#textunderline_' + rowCount).prop("checked", false);
                            $('#billformatrowid_' + rowCount).removeClass("text_underline")
                        }
                    });

                    // add new row
                    rowCount++;
                    $tbody.append(template.replace(/__/g, '_'+rowCount));
                    $('#billformatsortid_' + rowCount).val(rowCount);
                    $('#billformatrowid').val(rowCount);
                    bindBillFormatAutoComplete();
                    bindMixSortablefn(true);
                    if(data.length != 0) {
                        $('#copyformat').hide();
                        $('#bill-format-clear').show();
                    } else {
                        $('#copyformat').show();
                        $('#bill-format-clear').hide();
                    }
                },error: function(jqXHR, textStatus, errorThrown) {

                }
            });
        });
    });
    function deletebillformat(x,e,deleteFlag) {
        e.preventDefault();
        var $x = $(x),
            key = $x[0].id.split('_')[1];
//            formatTransId = $('#transId_' + key).val();
//
//        if(checkBillFormatUsage(formatTransId)) {
//            alert('Cannot delete this format, Since it has been used in  billing!');
//            return false;
//        }

        if (!confirm('Do you want to Delete'))
            return false;

        var $tr = $x.closest('tr');

        if(typeof deleteFlag != 'undefined' && deleteFlag) {
            var $ids = $('#billformatrowdeleteids');
            $ids.val($ids.val() + ',' + $('#transId_'+key).val());
        }

        $tr.next('tr.subTr').remove();
        $tr.remove();

        // check and display copyFrom option
        if($('#billFormatTable').find('tbody tr').length == 1 && $('#billformatid_' + $('#billformatrowid').val()).val().length == 0) {
            $('#copyformat').show();
        }

        if($('#billFormatTable').find('tbody tr').length > 1 )
            $('#bill-format-clear').show();
        else
            $('#bill-format-clear').hide();

        return false;
    }

    var validFormats = ['1','2','3','4','5','7','8','18','19'];
    function bindBillFormatAutoComplete() {
        var $typename = $('input[id^=typename_]');
        $.each($typename, function () {
            var $this = $(this),
                name = $this[0].id;
            if (name.indexOf('__') != -1 || name.indexOf('excel') != -1) return;

            $this.unbind('autocomplete');
            var arrname = name.split('_');
            var key1 = arrname[1];
            checkFormatUsed($this);
            $this.autocomplete({
                lookup: tmp_arr_billformatmaster,
                lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                    if (queryLowerCase == '*') {
                        return suggestion.value;
                    } else {
                        var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                        return re.test(suggestion.value);
                    }
                }, onSelect: function(suggestion) {
                    if(suggestion) {
                        var $el = $("#billformatid_" + key1);
                        $el.val(suggestion.data);
                        var $formula = $("#formula_" + key1);
                        if($.inArray(suggestion.data, validFormats) != -1) {
                            $formula.prop('readonly', true);
                        } else
                            $formula.prop('readonly', false);

                        // set formula
                        if(suggestion.data == '5')
                            $formula.val('(R1+R2)');

                        // set formula
                        if(suggestion.data == '9')
                            $formula.val('(R1+R2)');

                        $("#rowname_" + key1).html(suggestion.rowname);
                        removeError($(this));
                        addNewBillformatRow($(this));
                    }
                }, onSearchStart: function(suggestion) {
                    $("#billformatid_" + key1).val(0);
                }, onSearchComplete: function (query, suggestions) {
                    if(!suggestions.length  && query.length > 1){
                        showError($(this), 'Required');
                        $("#billformatid_" + key1).val(0);
                    } else
                        removeError($(this));
                }
            });
        });
    }

    function checkFormatUsed(x) {
        var id = $(x)[0].id.split('_')[1];
        var reskeyid = $('input[id*=billformatid_]');
        tmp_arr_billformatmaster = arr_billformatmaster;
        tmp_arr_billformatmaster = $.grep(arr_billformatmaster, function (element, index) {
            var is_selected = true;
            $.each(reskeyid, function (i, obj) {
                var $this = $(this),
                    name = $this[0].id;
                var arrname = name.split('_');
                var key1 = arrname[1];
                if (key1 != id) {
                    if (element.data == $this.val()) {
                        is_selected = false;
                    }
                }
            });
            return is_selected;
        });
    }

    function addNewBillformatRow(x) {
        var $x = $(x),
            $tr = $x.closest('tr'),
            key = $x[0].id.split('_')[1];

        if ($tr.next('tr').length != 0)
            return;

        if (isNullCheck($('#billformatid_' + key).val(),'number') == 0)
            return;

        var $rowid = $('#billformatrowid'),
            rowid = parseInt($rowid.val());
        $('#billformatdelete_' + rowid).show();

        var count = rowid + 1,
            template = $('#templateBillFormat').html();
        $tr.parent('tbody:not(.total)').append(template.replace(/__/g, '_' + count));
        $('#billformatsortid_' + count).val(count);
        $rowid.val(count);

        if (count > 1) {
            $('#copyformat').hide();
        }

        $('#bill-format-clear').show();

        bindBillFormatAutoComplete();
        bindMixSortablefn(true);
    }

    function formulaToggleReadonly(x) {
        var $formula = $(x),
            key1 = $formula[0].id.split('_')[1],
            formatId = $("#billformatid_" + key1).val();
        if($.inArray(formatId, validFormats) != -1 || formatId == '9') {
            $formula.prop('readonly', true);
        } else
            $formula.prop('readonly', false);
    }

    var fixHelperModified = function(e, tr) {
            var $originals = tr.children();
            var $helper = tr.clone();
            $helper.children().each(function(index) {
                $(this).width($originals.eq(index).width())
            });
            return $helper;
        },
        updateIndex = function(e, ui) {
            $('td.index', ui.item.parent()).each(function (i) {
                $(this).html(i + 1);
            });
        };

    function SortOrderBillFormat(iRowid) {
        var rows = $('tr[id*=billformatrowid_]');
        var irefid=1;
        $.each(rows, function() {
            var id = $(this)[0].id;
            var irow = id.split("_")[1];
            $('#billformatsortid_'+ irow).val(irefid);
            irefid = + irefid+1;
        });
    }
    function bindMixSortablefn(reset) {
        // ReadyMix sortable function
        var $rBody = $('#billFormatTable tbody:not(.total)');
        $.each($rBody, function(i, obj){
            if ($(this).parent('table')[0].id.indexOf('__') != -1) {
                $rBody.splice(i, 1);
            }
        });
        var $sRTable = $rBody.find('tr');

        if (typeof reset !== 'undefined' && reset === true) {
            $sRTable.unbind('click', 'dblclick', 'select', 'sortable');
            $rBody.unbind('sortable');
        }
        $sRTable.on( 'dblclick', function () {
            var $this = $(this);
            if ($this.hasClass('selected') == true) $this.toggleClass('selected', false);
            else $this.toggleClass('selected', true);
        });
        $rBody.sortable({
            helper: fixHelperModified,
            stop: updateIndex,
            axis: 'y',
            distance: 40,
            update: function( event, ui ) {
                var ifrow = event.target.children[0].id.split("_")[1];
                SortOrderBillFormat(ifrow);
            }
        });
    }

    function showBillFormat() {
        $("#billformatmodal").modal('show');
    }

    function copyBillFormat() {
        var iRowid = $('#vbillformatrowid').val();
        var count=1;
        var $rowid = $('#billformatrowid');
        var template = $('#templateBillFormat').html();
        for (var j = 1; j <= iRowid; j++) {
            if (count !=1)
                $('#billFormatTable tbody:not(.total)').append(template.replace(/__/g, '_' + count));

            $('#billformatdelete_' + j).show();
            $('#rowname_'+ count).html($('#vrowname_' + j).val());
            $('#slno_'+ count).val($('#vslno_' + j).val());
            $('#billformatdesc_'+ count).val($('#vdescription_' + j).val());
            $('#typename_'+ count).val($('#vtypename_' + j).val());
            $('#billformatid_'+ count).val($('#vbillformatid_' + j).val());
            $('#billformatsortid_'+ count).val($('#vbillformatsortid_' + j).val());
            $('#formula_'+ count).val($('#vformula_' + j).val());

            if (isNullCheck($('#billformatid_'+ count).val(),'number') !=0) {
                $('#typename_' + count).prop('readonly', true);
            }

            if ($('#vbold_' + j).val() == '1') {
                $('#textbold_' + count).prop("checked", true);
                $('#billformatrowid_' + count).addClass("text_bold")
            } else {
                $('#textbold_' + count).prop("checked", false);
                $('#billformatrowid_' + count).removeClass("text_bold")
            }

            if ($('#vitalic_' + j).val() == '1') {
                $('#textitalic_' + count).prop("checked", true);
                $('#billformatrowid_' + count).addClass("text_italic")
            } else {
                $('#textitalic_' + count).prop("checked", false);
                $('#billformatrowid_' + count).removeClass("text_italic")
            }
            if ($('#vunderline_' + j).val() == '1') {
                $('#textunderline_' + count).prop("checked", true);
                $('#billformatrowid_' + count).addClass("text_underline")
            } else {
                $('#textunderline_' + count).prop("checked", false);
                $('#billformatrowid_' + count).removeClass("text_underline")
            }
            count++;
        }
        $('#billFormatTable tbody:not(.total)').append(template.replace(/__/g, '_' + count));
        $rowid.val(count);

        bindBillFormatAutoComplete();
        bindMixSortablefn(true);
        $('#RetentionPercent').trigger('change');
        $('#MobilisationRecovery').trigger('change');
        $('#billformatmodal').modal('toggle');

        $('#bill-format-clear').show();
        $('#copyformat').hide();
    }

    function boldBillFormat(id) {
        var key1 = id.split('_')[1];
        if ($('#'+id).is(':checked') == true) {
            $('#billformatrowid_' + key1).addClass('text_bold')
        } else {
            $('#billformatrowid_' + key1).removeClass('text_bold')
        }
    }
    function italicBillFormat(id) {
        var key1 = id.split('_')[1];
        if ($('#'+id).is(':checked') == true) {
            $('#billformatrowid_' + key1).addClass('text_italic')
        } else {
            $('#billformatrowid_' + key1).removeClass('text_italic')
        }
    }
    function underlineBillFormat(id) {
        var key1 = id.split('_')[1];
        if ($('#'+id).is(':checked') == true) {
            $('#billformatrowid_' + key1).addClass('text_underline')
        } else {
            $('#billformatrowid_' + key1).removeClass('text_underline')
        }
    }

    function submitForm() {
        var costCentre = $('#costCentreId');
        var billformatrowid = $('#billformatrowid').val();
        if(costCentre.val() == 0) {
            showError(costCentre, 'Required');
            return false;
        } else {
            removeError(costCentre);
        }

        if(billformatrowid == 1) {
            alert('Please fill atleast a format!');
            return false;
        }

        $('.loading_area').show();
        $('#formWrapper').submit();
    }
</script> 
