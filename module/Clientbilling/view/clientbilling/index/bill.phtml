<script type="text/javascript" src="<?php echo $this->basePath(); ?>/js/jquery.bootstrap-responsive-tabs.min.js"></script>
<link rel="stylesheet" href="<?php echo $this->basePath() . '/css/workorder.css';?>"/>

<!--select2 plugin-->
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/js/select2.full.min.js"></script>
<link type="text/css" rel="stylesheet" href="<?php echo $this->basePath(); ?>/css/select2.min.css" />

<!--Handson Table plugin-->
<link type="text/css" rel="stylesheet" href="<?php echo $this->basePath(); ?>/library/handsontable/css/handsontable.full.min.css">
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/library/handsontable/js/handsontable.full.js"></script>
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/library/handsontable/js/RuleJS/lodash.js"></script>
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/library/handsontable/js/RuleJS/underscore.string.js"></script>
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/library/handsontable/js/RuleJS/numeral.js"></script>
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/library/handsontable/js/RuleJS/numeric.js"></script>
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/library/handsontable/js/formula.js"></script>
<script type="text/javascript"src="<?php echo $this->basePath(); ?>/library/handsontable/js/parser.js"></script>
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/library/handsontable/js/ruleJS.all.full.js"></script>
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/library/handsontable/js/handsontable.formula.js"></script>
<!--Handson Table Plugin-->

<!--Google Address Plugin-->
<script src="http://maps.googleapis.com/maps/api/js?sensor=false&amp;libraries=places"></script>
<style type="text/css">
.val-view						{ position:relative;}
.qtyshow 						{position:absolute;right:-15px;top:18px;}
.qtyshow a						{width:20px; height:20px; }
.qtyshow .qtyshow_toggle p		{color:#fff; font-size:12px;}
.qtyshow .qtyshow_toggle p span	{width:50%; display:inline-block;}
.qtyshow .qtyshow_toggle 		{padding:5px 10px;position:absolute;left:20px;width:150px;background-color:#555;display: none; z-index:999;}
.qtyshow:hover .qtyshow_toggle 	{display: block;}
.qtyshow .qtyshow_toggle:after  {position:absolute;top:5px;left:-5px;margin-left:-7px;content:' ';height:0px;width:0px;border:6px solid transparent;border-right-color:#555; }
</style>
<style type="text/css">
.form-control {
	box-shadow:none !important
}
.panel {
	border-radius:0px !important;
}
.panel-info {
	border:none;
	border-top:none;
}
.input-grouping > .polymer-form {
	width: 50%;
	float: left;
}
.input-grouping > .input-group-btn {
	width: 30%;
	top: 2px;
}
.input-grouping > .input-group-btn > select.parent_text {
	padding: 5px 4px 6px 4px;
}
.input-grouping > input.parent_text {
	width: 60%;
	float: left;
}
.opt-listed ul li p {
	height:25px !important;
	padding-top:0px !important;
}
.opt-listed ul {
	width:100% !important;
	margin-left:0% !important;
}
#HandsonTableWrapper {height: 100%; width: 100%; overflow: hidden; }
#HandsonWrapper {display: none;}
.tabs-content{ width:100%; float:left; position:relative !important; height:100%; min-height: 300px;}
.md-popup{ height:100%; width:100%; float:left;}
.HandsonModalBtns { float: right; margin: 20px 0;}
.hei-43 + .select2-container { height:43px;}
</style>
<style type="text/css">
.td_title_div                                	{width:100%; min-height:80px; float:left;}
.td_title_div .td_title_inner_l                	{width:40px; width:40px; height:40px; border:1px solid #cedceb;float:left;}
.td_title_div .td_title_inner_l span       		{width:34px; height:34px;margin:2px; line-height:34px; font-size:100%; text-align:center; font-weight:600; color:#6d8aa9; background-color:#e3eaf3; display:inline-block;}
.td_title_div .td_title_inner_r                 {float:left; width:85%; padding-left:10px;}
.td_title_div .td_title_inner_r textarea    	{width:100%; height:52px;font-size:15px;resize:none; color:#404040; background:none; border:0px; overflow: auto !important;}
.td_title_div .td_title_inner_r p            	{color:#999999; font-size:13px; overflow: hidden;text-overflow: ellipsis;white-space: nowrap;width: 400px;}

@media only screen and (min-width : 320px) and (max-width : 767px) {
.td_title_div                               	{width:400px;}
}
</style>
<?php $isBillEditable = (($billinfo['TransType'] == 'S' && $billinfo['IsSubmittedBill'] == '1') || ($billinfo['TransType'] == 'C' && $billinfo['IsCertifiedBill'] == '1')) ? FALSE : TRUE;?>
<div class="content_wrapper padlr0">
  <div class="container-fluid">
    <div class="row">
      <form  id="formWrapper"  method="post" enctype="multipart/form-data">
        <input type="hidden" name="mode" id="mode" value="<?php echo (isset($mode)) ? $mode  : 'add'; ?>"/>
        <input type="hidden" name="WOId" id="WOId" value="<?php echo (isset($billinfo)) ? $billinfo['WORegisterId'] : 0; ?>"/>
        <input type="hidden" name="BillId" id="BillId" value="<?php echo (isset($billid)) ? $billid : 0; ?>"/>
        <input type="hidden" name="BillType" id="BillType" value="<?php echo (isset($billinfo)) ? $billinfo['TransType'] : '';?>"/>
        <input type="hidden" id="SubmittedDate" value="<?php echo (isset($billinfo) && !is_null($billinfo['SubmittedDate'])) ? date('d-m-Y', strtotime($billinfo['SubmittedDate'])) : '';?>"/>
        <!--content-->
        <div class="col-lg-12">
          <h1 id="MW_ProjectName">Project Name</h1>
        </div>
        <div class="clearfix"></div>
        <div class="col-lg-12 col-lg-offset-0">
        	<div class="tagcrd">
                <ul>
                    <li class="mnimumwidthres90">
                        <div class="tagcardhdng pnl-overflow crmbrdrclr1">
                            <div class="icon-bg"><i class="fa fa-qrcode i-text-111"></i></div>
                            <h2 class="comtex commargin_bottom_5 crmbrdrclrhed1 comnelips" style="font-weight:600 !important;">Bill No.</h2>
                            <h5 class="tetmuted tet-clr11 comnelips" id="MW_BillNo"><?php echo (isset($billinfo)) ? $billinfo['BillNo'] : '';?></h5>
                        </div>
                    </li>
                    <li class="mnimumwidthres90">
                        <div class="tagcardhdng pnl-overflow crmbrdrclr2">
                            <div class="icon-bg"><i class="fa fa-calendar i-text-111"></i></div>
                            <h2 class="comtex commargin_bottom_5 crmbrdrclrhed2 comnelips" style="font-weight:600 !important;">Bill Date</h2>
                            <h5 class="tetmuted tet-clr11 comnelips" id="MW_BillDate"><?php echo (isset($billinfo)) ? $billinfo['BillDate'] : '';?></h5>
                        </div>
                    </li>
                    <li class="mnimumwidthres90">
                        <div class="tagcardhdng pnl-overflow crmbrdrclr3">
                            <div class="icon-bg"><i class="fa fa-sliders  i-text-111"></i></div>
                            <h2 class="comtex commargin_bottom_5 crmbrdrclrhed3 comnelips" style="font-weight:600 !important;">Bill Type</h2>
                            <h5 class="tetmuted tet-clr11 comnelips" id="MW_BillType"><?php echo (isset($billinfo)) ? (($billinfo['TransType'] == 'S') ? 'Submit Bill' : 'Certified Bill') : '';?></h5>
                        </div>
                    </li>
                    <li class="mnimumwidthres90">
                        <div class="tagcardhdng pnl-overflow crmbrdrclr4">
                            <div class="icon-bg"><i class="fa fa-user i-text-111"></i></div>
                            <h2 class="comtex commargin_bottom_5 crmbrdrclrhed4 comnelips" style="font-weight:600 !important;">Client Name</h2>
                            <h5 class="tetmuted tet-clr11 comnelips" id="MW_VendorName"><?php echo (isset($billinfo)) ? $billinfo['ClientName'] : '';?></h5>
                        </div>
                    </li>
                    <li class="mnimumwidthres90">
                        <div class="tagcardhdng pnl-overflow crmbrdrclr5">
                            <div class="icon-bg"><i class="fa fa-list-alt i-text-111"></i></div>
                            <h2 class="comtex commargin_bottom_5 crmbrdrclrhed5 comnelips" style="font-weight:600 !important;">Work Order</h2>
                            <h5 class="tetmuted tet-clr11 comnelips" id="MW_WorkOrderNo"><?php echo (isset($billinfo)) ? $billinfo['WONo'] : '';?></h5>
                        </div>
                    </li>
                    <li class="mnimumwidthres90">
                        <div class="tagcardhdng pnl-overflow crmbrdrclr7">
                            <div class="icon-bg"><i class="fa fa-commenting-o i-text-111"></i></div>
                            <h2 class="comtex commargin_bottom_5 crmbrdrclrhed7 comnelips" style="font-weight:600 !important;">Status</h2>
                            <h5 class="tetmuted tet-clr11 comnelips" id="MW_BillType">
							<?php if(($billinfo['TransType'] == 'S' && $billinfo['IsSubmittedBill'] == '1')) {
                                echo 'Submitted';
                            } else if(($billinfo['TransType'] == 'C' && $billinfo['IsCertifiedBill'] == '1')) {
                                echo 'Certified';
                            } else {
                                echo 'Work In Progress';
                            } ?>
                            </h5>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
        <div class="clearfix"></div>
        <!--table start-->
        <div class="col-lg-12 col-lg-offset-0">
          <div class="table-responsive topsp" style="animation-delay: 0.2s;">
            <table class="table highlightTable" style=" margin-bottom:0px;" id="EntryTable">
              <thead>
                <tr>
                  <th>&nbsp;</th>
                  <th>Description</th>
                  <th class="text-right">Cumulative</th>
                  <th class="text-right">Previous</th>
                  <th class="text-right">Current</th>
                  <th>&nbsp; </th>
                </tr>
              </thead>
              <tbody class="main">
                <?php $i=1;
                $TotalCumAmount=0;
                $TotalPrevAmount=0;
                $TotalCurAmount=0;
                $AdvanceFormats=array('1','2','3','5','7','8','18','19','6', '21');
                if(isset($BillFormat)):
                foreach($BillFormat as $Format):
                    if($Format['BillFormatId'] != '' && $Format['BillFormatId'] != 0) {
                        if($Format['Sign'] == '-') {
                            $TotalCurAmount -= $Format[ 'CurAmount' ];
                            $TotalCumAmount -= $Format['CumAmount'];
                            $TotalPrevAmount -= $Format['PrevAmount'];
                        } else {
                            $TotalCurAmount += $Format[ 'CurAmount' ];
                            $TotalCumAmount += $Format['CumAmount'];
                            $TotalPrevAmount += $Format['PrevAmount'];
                        }
                    }?>
                <tr class="padi05 <?php echo ($Format['Bold']) ? 'text_bold': '';echo ($Format['Italic']) ? ' text_italic' : '';echo ($Format['Underline']) ? ' text_underline' : '';?>">
                  <td width="3%"><p class="ra-t" name="RowName_<?php echo $i; ?>" id="RowName_<?php echo $i; ?>"><?php echo $Format['RowName'];?></p></td>
                  <?php if($Format['BillFormatId'] == 0 || $Format['BillFormatId'] == ''): ?>
                      <td colspan="3"><p class="dec-ptr" name="TypeName_<?php echo $i; ?>" id="TypeName_<?php echo $i; ?>"><?php echo $Format['TypeName'];?></p></td>
                      <td width="10%" style="display: none;"><input class="parent_padi05 text-right" type="text" name="CumAmount_<?php echo $i; ?>" id="CumAmount_<?php echo $i; ?>" readonly value="<?php echo $this->commonHelper()->sanitizeNumber($Format['CumAmount'],2, true, true);?>"/></td>
                      <td width="10%" style="display: none;"><input class="parent_padi05 text-right" type="text" name="PrevAmount_<?php echo $i; ?>" id="PrevAmount_<?php echo $i; ?>" readonly value="<?php echo $this->commonHelper()->sanitizeNumber($Format['PrevAmount'],2, true, true);?>"/></td>
                  <?php else: ?>
                      <td width="10%" ><p class="dec-ptr" name="TypeName_<?php echo $i; ?>" id="TypeName_<?php echo $i; ?>"><?php echo $Format['TypeName'];?></p></td>
                      <td width="10%" ><input class="parent_padi05 text-right" type="text" name="CumAmount_<?php echo $i; ?>" id="CumAmount_<?php echo $i; ?>" readonly value="<?php echo $this->commonHelper()->sanitizeNumber($Format['CumAmount'],2, true, true);?>"/></td>
                      <td width="10%"><input class="parent_padi05 text-right" type="text" name="PrevAmount_<?php echo $i; ?>" id="PrevAmount_<?php echo $i; ?>" readonly value="<?php echo $this->commonHelper()->sanitizeNumber($Format['PrevAmount'],2, true, true);?>"/></td>
                  <?php endif; ?>
                  <td width="10%">
                      <?php if(in_array($Format['BillFormatId'], $AdvanceFormats)): ?>
                        <input class="parent_padi05 text-right" type="text" name="CurAmount_<?php echo $i; ?>" id="CurAmount_<?php echo $i; ?>" readonly onchange="calcBillAbstract();" value="<?php echo $this->commonHelper()->sanitizeNumber($Format['CurAmount'], 2, true, true);?>" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 2, true)"/>
                      <?php elseif($Format['BillFormatId'] == 0 || $Format['BillFormatId'] == ''): ?>
                          <input class="parent_text text-right" type="text" name="CurAmount_<?php echo $i; ?>" id="CurAmount_<?php echo $i; ?>" readonly onchange="calcBillAbstract();" value="<?php echo $this->commonHelper()->sanitizeNumber($Format['CurAmount'], 2, true, true);?>" onfocus="showFormulaModal(this.id, true)" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 2, true)"/>
                      <?php else: ?>
                          <input class="parent_text text-right" type="text" name="CurAmount_<?php echo $i; ?>" id="CurAmount_<?php echo $i; ?>" onchange="calcBillAbstract();" value="<?php echo $this->commonHelper()->sanitizeNumber($Format['CurAmount'], 2, true, true);?>" onfocus="showFormulaModal(this.id)" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 2, true)"/>
                      <?php endif; ?>
                  </td>
                  <td width="3%" align="center" class="action_btns_td"><?php if (in_array($Format['BillFormatId'], $AdvanceFormats)): ?>
                    <ul class="action_btns">
                      <li> <a href="#" class="mainTr EntryExpand_<?php echo $i; ?>"> <i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="top" data-original-title="Add lines" ></i></a> </li>
                    </ul>
                    <?php endif; ?>
                    <input type="hidden" name="BillFormatId_<?php echo $i; ?>" id="BillFormatId_<?php echo $i; ?>" value="<?php echo $Format['BillFormatId'];?>"/>
                    <input type="hidden" name="FormatTypeId_<?php echo $i; ?>" id="FormatTypeId_<?php echo $i; ?>" value="<?php echo $Format['FormatTypeId'];?>"/>
                    <input type="hidden" name="Sign_<?php echo $i; ?>" id="Sign_<?php echo $i; ?>" value="<?php echo $Format['Sign'];?>"/>
                    <input type="hidden" name="Formula_<?php echo $i; ?>" id="Formula_<?php echo $i; ?>" value="<?php echo $Format['Formula'];?>"/>
                    <input type="hidden" name="BillAbsId_<?php echo $i; ?>" id="BillAbsId_<?php echo $i; ?>" value="<?php echo $Format['BillAbsId'];?>"/></td>
                </tr>
                <?php switch($Format['BillFormatId']):
        case '1': ;?>
                <!--Agreement-->
                <tr style="display:none;" class="subTr">
                  <td colspan="9" style="padding:0px !important; ">
                      <div class="subDiv" style="display:none;">
                      <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"> </div>
                      <div class="col-lg-12">
                        <div class="table-responsive topsp">
                          <table class="table" style="margin-bottom:0px;" id="boqTable">
                            <thead>
                              <tr>
                                <th style="width:400px;">Specification</th>
                                <th>Unit</th>
                                <th class="text-right">Qty</th>
                                <th class="text-right">Rate</th>
                                <th class="text-right">Amount</th>
                                <th>&nbsp; </th>
                              </tr>
                            </thead>
                            <tbody class="main" data-rowid="<?php echo $i; ?>">
                              <?php $j=1; $boqtotal=0;
                                        foreach($Format['AddRow'] as $BOQ):
                                            $boqtotal += $BOQ['CurAmount'];?>
                                  <tr class="padi05">
                                    <input type="hidden" name="BillBOQId_<?php echo $j;?>" id="BillBOQId_<?php echo $j;?>" value="<?php echo $BOQ['BillBOQId'];?>"/>
                                    <input type="hidden" name="UpdateBOQRow_<?php echo $j;?>" id="UpdateBOQRow_<?php echo $j;?>" value="0"/>
                                    <td width="8%" style="vertical-align:top!important">
                                        <textarea class="parent_texts" name="Spec_<?php echo $j;?>" id="Spec_<?php echo $j;?>" readonly><?php echo $BOQ['SerialNo'] .' '.$BOQ['Specification'];?></textarea>
                                        <input type="hidden" name="WOBOQId_<?php echo $j;?>" id="WOBOQId_<?php echo $j;?>" value="<?php echo $BOQ['WOBOQId'];?>"/>
                                    </td>
                                    <td width="5%" style="vertical-align:top!important"><input class="parent_padi05" type="text" name="Unit_<?php echo $j;?>" id="Unit_<?php echo $j;?>" value="<?php echo $BOQ['UnitName'];?>" readonly/>
                                      <input type="hidden" name="UnitId_<?php echo $j;?>" id="UnitId_<?php echo $j;?>" value="<?php echo $BOQ['UnitId'];?>"/></td>
                                    <td width="5%" style="vertical-align:top!important" class="val-view">
                                        <input class="parent_text text-right" type="text" name="Qty_<?php echo $j;?>" id="Qty_<?php echo $j;?>" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" maxlength="12" onchange="validateAgtQty(this);addNewBOQRow(this, true)" value="<?php echo $this->commonHelper()->sanitizeNumber($BOQ['CurQty'],3);?>" onfocus="showHandsonTableModal(this);"/>
                                        <div class="qtyshow" style="width:20%; float:right;">
                                            <a class="float_r ripple" href="javascript:void(0);"><span><i class="fa fa-question"></i></span></a>
                                            <div class="qtyshow_toggle">
                                                <p><span>Total Qty</span><span id="AgtTotalQty_<?php echo $j;?>"><?php echo $this->commonHelper()->sanitizeNumber($BOQ['TotalQty']);?></span></p>
                                                <p><span>Prev Qty</span><span id="AgtPrevQty_<?php echo $j;?>"><?php echo $this->commonHelper()->sanitizeNumber($BOQ['CumQty']);?></span></p>
                                                <p><span>Bal Qty </span><span id="AgtBalQty_<?php echo $j;?>"><?php echo $this->commonHelper()->sanitizeNumber($BOQ['BalQty']);?></span></p>
                                            </div>
                                        </div>
                                      <input type="hidden" name="Measurement_<?php echo $j;?>" id="Measurement_<?php echo $j;?>" value="<?php echo htmlentities($BOQ['Measurement']);?>"/>
                                      <input type="hidden" name="CellName_<?php echo $j;?>" id="CellName_<?php echo $j;?>" value="<?php echo $BOQ['CellName'];?>"/>
                                      <input type="hidden" name="SelectedColumns_<?php echo $j;?>" id="SelectedColumns_<?php echo $j;?>" value="<?php echo $BOQ['SelectedColumns'];?>"/></td>
                                    <td width="6%" style="vertical-align:top!important"><input class="parent_padi05 text-right" type="text" name="Rate_<?php echo $j;?>" id="Rate_<?php echo $j;?>" readonly value="<?php echo $this->commonHelper()->sanitizeNumber($BOQ['Rate'],2,true,true);?>"/></td>
                                    <td width="5%" style="vertical-align:top!important"><input class="parent_padi05 text-right" type="text" name="Amount_<?php echo $j;?>" id="Amount_<?php echo $j;?>" readonly value="<?php echo $this->commonHelper()->sanitizeNumber($BOQ['CurAmount'],2,true,true);?>"/></td>
                                    <td width="3%" align="center" class="action_btns_td" style="vertical-align:top!important"><ul class="action_btns">
                                        <li> <a href="#" class="BOQDeleteTr_<?php echo $j;?>" onclick="deleteBOQ(this, event, true);"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                                      </ul>
                                    </td>
                                  </tr>
                              <?php $j=$j+1; endforeach; ?>
                              <?php if($isBillEditable): ?>
                                  <tr class="padi05">
                                    <input type="hidden" name="BillBOQId_<?php echo $j;?>" id="BillBOQId_<?php echo $j;?>" value="0"/>
                                    <input type="hidden" name="UpdateBOQRow_<?php echo $j;?>" id="UpdateBOQRow_<?php echo $j;?>" value="0"/>
                                    <td width="8%" style="vertical-align:middle !important">
                                        <input class="parent_text" type="text" name="Spec_<?php echo $j;?>" id="Spec_<?php echo $j;?>" onfocus="return checkBoqSpec(this.id)"/>
                                        <input type="hidden" name="WOBOQId_<?php echo $j;?>" id="WOBOQId_<?php echo $j;?>"/>
                                    </td>
                                    <td width="5%" style="vertical-align:top!important"><input class="parent_padi05" type="text" name="Unit_<?php echo $j;?>" id="Unit_<?php echo $j;?>" readonly/>
                                      <input type="hidden" name="UnitId_<?php echo $j;?>" id="UnitId_<?php echo $j;?>"/></td>
                                    <td width="5%" style="vertical-align:top!important" class="val-view">
                                    	<input class="parent_text text-right" type="text" name="Qty_<?php echo $j;?>" id="Qty_<?php echo $j;?>" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" maxlength="12" onchange="validateAgtQty(this);addNewBOQRow(this)" onfocus="showHandsonTableModal(this);"/>
                                        <div class="qtyshow" style="width:20%; float:right;">
                                            <a class="float_r ripple" href="javascript:void(0);"><span><i class="fa fa-question"></i></span></a>
                                            <div class="qtyshow_toggle">
                                                <p><span>Total Qty</span><span id="AgtTotalQty_<?php echo $j;?>"></span></p>
                                                <p><span>Prev Qty</span><span id="AgtPrevQty_<?php echo $j;?>"></span></p>
                                                <p><span>Bal Qty </span><span id="AgtBalQty_<?php echo $j;?>"></span></p>
                                            </div>
                                        </div>
                                      <input type="hidden" name="Measurement_<?php echo $j;?>" id="Measurement_<?php echo $j;?>"/>
                                      <input type="hidden" name="CellName_<?php echo $j;?>" id="CellName_<?php echo $j;?>"/>
                                      <input type="hidden" name="SelectedColumns_<?php echo $j;?>" id="SelectedColumns_<?php echo $j;?>"/></td>
                                    <td width="6%" style="vertical-align:top!important"><input class="parent_padi05 text-right" type="text" name="Rate_<?php echo $j;?>" id="Rate_<?php echo $j;?>" readonly/></td>
                                    <td width="5%" style="vertical-align:top!important"><input class="parent_padi05 text-right" type="text" name="Amount_<?php echo $j;?>" id="Amount_<?php echo $j;?>" readonly/></td>
                                    <td width="3%" align="center" class="action_btns_td" style="vertical-align:top!important"><ul class="action_btns">
                                        <li> <a href="#" class="BOQDeleteTr_<?php echo $j;?>" onclick="deleteBOQ(this, event);" style="display: none;"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                                      </ul></td>
                                  </tr>
                              <?php endif; ?>
                            </tbody>
                            <tbody class="total">
                              <tr class="padi05">
                                <td colspan="3"></td>
                                <td align="right" class="rate_pri">Total</td>
                                <td width="5%"><input class="parent_padi05 text-right" type="text" name="BOQTotal" id="BOQTotal" value="<?php echo $this->commonHelper()->sanitizeNumber($boqtotal);?>" readonly/></td>
                                <td>&nbsp;</td>
                              </tr>
                            </tbody>
                          </table>
                          <input type="hidden" name="boqrowid" id="boqrowid" value="<?php echo $j;?>"/>
                          <input type="hidden" name="boqrowdeleteids" id="boqrowdeleteids" value="0"/>
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                <?php break;
        case '2': ?>
                <!--Non-Agreement-->
                <tr style="display:none;" class="subTr">
                  <td colspan="9" style="padding:0px !important; "><div class="subDiv" style="display:none;">
                      <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"> </div>
                      <div class="col-lg-12">
                        <div class="table-responsive topsp">
                          <table class="table" style="margin-bottom:0px;" id="boqTable-2">
                            <thead>
                              <tr>
                                <th>Specification</th>
                                <th>Unit</th>
                                <th class="text-right">Qty</th>
                                <th class="text-right">Rate</th>
                                <th class="text-right">Amount</th>
                                <th>&nbsp; </th>
                              </tr>
                            </thead>
                            <tbody class="main" data-rowid="<?php echo $i; ?>">
                              <?php $j=1; $boqtotal=0;
                                    foreach($Format['AddRow'] as $BOQ):
                                        $boqtotal += $BOQ['CurAmount'];?>
                              <tr class="padi05">
                                <input type="hidden" name="NABillBOQId_<?php echo $j;?>" id="NABillBOQId_<?php echo $j;?>" value="<?php echo $BOQ['BillBOQId'];?>"/>
                                <input type="hidden" name="NAUpdateBOQRow_<?php echo $j;?>" id="NAUpdateBOQRow_<?php echo $j;?>" value="0"/>
                                <td width="15%"><textarea class="parent_texts parent_padi05" name="NASpec_<?php echo $j;?>" id="NASpec_<?php echo $j;?>" readonly><?php echo $BOQ['SlNo'] .' '. $BOQ['Specification'];?></textarea>
                                  <input type="hidden" class="NABOQIdInputs" name="NABOQId_<?php echo $j;?>" id="NABOQId_<?php echo $j;?>" value="<?php echo $BOQ['NonBOQId'];?>"/></td>
                                <td width="5%"><input class="parent_padi05" type="text" name="NAUnit_<?php echo $j;?>" id="NAUnit_<?php echo $j;?>" value="<?php echo $BOQ['UnitName'];?>" onchange="addNewNABOQRow(this, true)" readonly/>
                                  <input type="hidden" name="NAUnitId_<?php echo $j;?>" id="NAUnitId_<?php echo $j;?>" value="<?php echo $BOQ['UnitId'];?>"/></td>
                                <td width="5%"><input class="parent_text text-right" type="text" name="NAQty_<?php echo $j;?>" id="NAQty_<?php echo $j;?>" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" maxlength="12" onchange="addNewNABOQRow(this, true)" value="<?php echo $this->commonHelper()->sanitizeNumber($BOQ['CurQty'],3);?>" onfocus="showHandsonTableModal(this);"/>
                                  <input type="hidden" name="NAMeasurement_<?php echo $j;?>" id="NAMeasurement_<?php echo $j;?>" value="<?php echo htmlentities($BOQ['Measurement']);?>"/>
                                  <input type="hidden" name="NACellName_<?php echo $j;?>" id="NACellName_<?php echo $j;?>" value="<?php echo $BOQ['CellName'];?>"/>
                                  <input type="hidden" name="NASelectedColumns_<?php echo $j;?>" id="NASelectedColumns_<?php echo $j;?>" value="<?php echo $BOQ['SelectedColumns'];?>"/></td>
                                <td width="6%"><input class="parent_padi05 text-right" type="text" name="NARate_<?php echo $j;?>" id="NARate_<?php echo $j;?>" onchange="addNewNABOQRow(this, true)" value="<?php echo $this->commonHelper()->sanitizeNumber($BOQ['Rate'],2,true,true);?>" readonly/></td>
                                <td width="5%"><input class="parent_padi05 text-right" type="text" name="NAAmount_<?php echo $j;?>" id="NAAmount_<?php echo $j;?>" value="<?php echo $this->commonHelper()->sanitizeNumber($BOQ['CurAmount'],2,true,true);?>" readonly/></td>
                                <td width="3%" align="center" class="action_btns_td"><ul class="action_btns">
                                    <li> <a href="#" class="NABOQDeleteTr_<?php echo $j;?>" onclick="deleteNABOQ(this, event, true);"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                                  </ul></td>
                              </tr>
                              <?php $j=$j+1; endforeach; ?>
                              <?php if($isBillEditable): ?>
                              <tr class="padi05">
                                <input type="hidden" name="NABillBOQId_<?php echo $j;?>" id="NABillBOQId_<?php echo $j;?>" value="0"/>
                                <input type="hidden" name="NAUpdateBOQRow_<?php echo $j;?>" id="NAUpdateBOQRow_<?php echo $j;?>" value="0"/>
                                <td width="15%"><input class="parent_text" type="text" name="NASpec_<?php echo $j;?>" id="NASpec_<?php echo $j;?>" onchange="addNewNABOQRow(this)" onfocus="return checkNonAgtBoqSpec(this.id)"/>
                                  <input type="hidden" class="NABOQIdInputs" name="NABOQId_<?php echo $j;?>" id="NABOQId_<?php echo $j;?>"/></td>
                                <td width="5%"><input class="parent_padi05" type="text" name="NAUnit_<?php echo $j;?>" id="NAUnit_<?php echo $j;?>" readonly/>
                                  <input type="hidden" name="NAUnitId_<?php echo $j;?>" id="NAUnitId_<?php echo $j;?>"/></td>
                                <td width="5%"><input class="parent_text text-right" type="text" name="NAQty_<?php echo $j;?>" id="NAQty_<?php echo $j;?>" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" maxlength="12" onchange="addNewNABOQRow(this)" onfocus="showHandsonTableModal(this);"/>
                                  <input type="hidden" name="NAMeasurement_<?php echo $j;?>" id="NAMeasurement_<?php echo $j;?>"/>
                                  <input type="hidden" name="NACellName_<?php echo $j;?>" id="NACellName_<?php echo $j;?>"/>
                                  <input type="hidden" name="NASelectedColumns_<?php echo $j;?>" id="NASelectedColumns_<?php echo $j;?>"/></td>
                                <td width="6%"><input class="parent_padi05 text-right" type="text" name="NARate_<?php echo $j;?>" id="NARate_<?php echo $j;?>" onchange="addNewNABOQRow(this)" readonly/></td>
                                <td width="5%"><input class="parent_padi05 text-right" type="text" name="NAAmount_<?php echo $j;?>" id="NAAmount_<?php echo $j;?>" readonly/></td>
                                <td width="3%" align="center" class="action_btns_td">
                                    <ul class="action_btns">
                                        <li> <a href="#" class="NABOQDeleteTr_<?php echo $j;?>" onclick="deleteNABOQ(this, event);" style="display: none;"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                                    </ul>
                                </td>
                              </tr>
                              <?php endif; ?>
                            </tbody>
                            <tbody class="total">
                              <tr class="padi05">
                                <td colspan="3"></td>
                                <td align="right" class="rate_pri">Total</td>
                                <td width="5%"><input class="parent_padi05 text-right" type="text" name="NABOQTotal" id="NABOQTotal" value="<?php echo $this->commonHelper()->sanitizeNumber($boqtotal,2,true,true);?>" readonly/></td>
                                <td>&nbsp;</td>
                              </tr>
                            </tbody>
                          </table>
                          <input type="hidden" name="naboqrowid" id="naboqrowid" value="<?php echo $j;?>"/>
                          <input type="hidden" name="naboqrowdeleteids" id="naboqrowdeleteids" value="0"/>
                        </div>
                      </div>
                    </div></td>
                </tr>
                <?php break;
        case '3': ?>
                <!--Material Advance-->
                <tr style="display:none;" class="subTr">
                  <td colspan="9" style="padding:0px !important; "><div class="subDiv" style="display:none;">
                      <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"> </div>
                      <div class="col-lg-12">
                        <div class="table-responsive topsp">
                          <table class="table" style="margin-bottom:0px;">
                            <thead>
                              <tr>
                                <th>Material Name</th>
                                <th>Unit</th>
                                <th class="text-right">Qty</th>
                                <th class="text-right">Rate</th>
                                <th class="text-right">Amount</th>
                                <th class="text-right">Advance %</th>
                                <th class="text-right">Adv. Amount</th>
                                <th>&nbsp; </th>
                              </tr>
                            </thead>
                            <tbody class="main" data-rowid="<?php echo $i; ?>">
                              <?php $j=1;
                                    foreach($Format['AddRow'] as $MAdvance):?>
                              <tr class="padi05">
                                <input type="hidden" name="MAdvUpdateRow_<?php echo $j;?>" id="MAdvUpdateRow_<?php echo $j;?>" value="0"/>
                                <input type="hidden" name="MAdvTransId_<?php echo $j;?>" id="MAdvTransId_<?php echo $j;?>" value="<?php echo $MAdvance['MTransId'];?>" />
                                <td width="13%"><input class="parent_padi05" type="text" name="MaterialName_<?php echo $j;?>" id="MaterialName_<?php echo $j;?>" value="<?php echo $MAdvance['MaterialName'];?>" readonly/>
                                  <input type="hidden" name="MaterialId_<?php echo $j;?>" id="MaterialId_<?php echo $j;?>" value="<?php echo $MAdvance['MaterialId'];?>"/></td>
                                <td width="5%"><input class="parent_padi05" type="text" name="MUnit_<?php echo $j;?>" id="MUnit_<?php echo $j;?>" readonly value="<?php echo $MAdvance['UnitName'];?>"/>
                                  <input type="hidden" name="MUnitId_<?php echo $j;?>" id="MUnitId_<?php echo $j;?>" value="<?php echo $MAdvance['UnitId'];?>"/></td>
                                <td width="5%"><input class="parent_padi05 text-right" type="text" name="MQty_<?php echo $j;?>" id="MQty_<?php echo $j;?>" onchange="addNewMAdvRow(this)" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" maxlength="12" readonly value="<?php echo $this->commonHelper()->sanitizeNumber($MAdvance['Qty'],3);?>"/></td>
                                <td width="6%"><input class="parent_padi05 text-right" type="text" name="MRate_<?php echo $j;?>" id="MRate_<?php echo $j;?>" readonly value="<?php echo $this->commonHelper()->sanitizeNumber($MAdvance['Rate']);?>"/></td>
                                <td width="5%"><input class="parent_padi05 text-right" type="text" name="MAmount_<?php echo $j;?>" id="MAmount_<?php echo $j;?>" readonly value="<?php echo $this->commonHelper()->sanitizeNumber($MAdvance['Amount']);?>"/></td>
                                <td width="10%"><input class="parent_padi05 text-right" type="text" name="MAdvancePer_<?php echo $j;?>" id="MAdvancePer_<?php echo $j;?>" readonly value="<?php echo $this->commonHelper()->sanitizeNumber($MAdvance['AdvPercent']);?>"/></td>
                                <td width="10%"><input class="parent_padi05 text-right" type="text" name="MAdvAmount_<?php echo $j;?>" id="MAdvAmount_<?php echo $j;?>" readonly value="<?php echo $this->commonHelper()->sanitizeNumber($MAdvance['AdvAmount']);?>"/></td>
                                <td width="5%" align="center" class="action_btns_td"><ul class="action_btns">
                                    <li> <a href="#" class="mainTr"> <i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="top" data-original-title="Add lines" ></i></a> </li>
                                    <li> <a href="#" class="MaterialDeleteTr_<?php echo $j;?>" onclick="deleteMaterial(this, event,true);"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                                  </ul></td>
                              </tr>
                              <tr style="display:none;" class="subTr">
                                <td colspan="9" style="padding:0px !important; "><div class="subDiv" style="display:none;">
                                    <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"> </div>
                                    <div class="col-lg-12">
                                      <div class="table-responsive topsp">
                                        <table class="table" style="margin-bottom:0px;">
                                          <thead>
                                            <tr>
                                              <th>Bill Date</th>
                                              <th>Bill No</th>
                                              <th>Vendor Name</th>
                                              <th class="text-right">Qty</th>
                                              <th class="text-right">Rate</th>
                                              <th class="text-right">Amount</th>
                                              <th>&nbsp; </th>
                                            </tr>
                                          </thead>
                                          <tbody class="submain">
                                            <?php $k=1;
                                                $qtyTotal = 0;
                                                $rateTotal = 0;
                                                $amtTotal = 0;
                                            foreach($MAdvance['BillTrans'] as $Bill):
                                                $qtyTotal += $Bill['Qty'];
                                                $rateTotal += $Bill['Rate'];
                                                $amtTotal += $Bill['Amount'];?>
                                            <tr class="padi05">
                                              <input type="hidden" name="MBill_<?php echo $j;?>_PBillTransId_<?php echo $k;?>" id="MBill_<?php echo $j;?>_PBillTransId_<?php echo $k;?>" value="<?php echo $Bill['MBillTransId'];?>"/>
                                              <input type="hidden" name="MBill_<?php echo $j;?>_UpdateMBillRow_<?php echo $k;?>" id="MBill_<?php echo $j;?>_UpdateMBillRow_<?php echo $k;?>" value="0"/>
                                              <td width="5%"><input class="parent_text date_picker" type="text" name="MBill_<?php echo $j;?>_BillDate_<?php echo $k;?>" id="MBill_<?php echo $j;?>_BillDate_<?php echo $k;?>" onkeypress="return isDate(event);" onchange="validateDate(this);addNewMaterialAdvBillRow(this,true)" value="<?php echo $Bill['BillDate'];?>"/></td>
                                              <td width="5%"><input class="parent_text" type="text" name="MBill_<?php echo $j;?>_MBillNo_<?php echo $k;?>" id="MBill_<?php echo $j;?>_MBillNo_<?php echo $k;?>" onchange="addNewMaterialAdvBillRow(this,true)" value="<?php echo $Bill['BillNo'];?>"/></td>
                                              <td width="10%"><input class="parent_text VendorNameInputs" type="text" name="MBill_<?php echo $j;?>_MVendorName_<?php echo $k;?>" id="MBill_<?php echo $j;?>_MVendorName_<?php echo $k;?>" onchange="addNewMaterialAdvBillRow(this,true)" value="<?php echo $Bill['VendorName'];?>"/>
                                                <input type="hidden" class="VendorIdInputs" name="MBill_<?php echo $j;?>_MVendorId_<?php echo $k;?>" id="MBill_<?php echo $j;?>_MVendorId_<?php echo $k;?>" value="<?php echo $Bill['VendorId'];?>"/></td>
                                              <td width="5%"><input class="parent_text text-right" type="text" name="MBill_<?php echo $j;?>_MBillQty_<?php echo $k;?>" id="MBill_<?php echo $j;?>_MBillQty_<?php echo $k;?>" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" maxlength="12" onchange="addNewMaterialAdvBillRow(this,true)" value="<?php echo $this->commonHelper()->sanitizeNumber($Bill['Qty'],3);?>"/></td>
                                              <td width="6%"><input class="parent_text text-right" type="text" name="MBill_<?php echo $j;?>_MBillRate_<?php echo $k;?>" id="MBill_<?php echo $j;?>_MBillRate_<?php echo $k;?>" onchange="addNewMaterialAdvBillRow(this,true)" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)" maxlength="18" value="<?php echo $this->commonHelper()->sanitizeNumber($Bill['Rate']);?>"/></td>
                                              <td width="5%"><input class="parent_padi05 text-right" type="text" name="MBill_<?php echo $j;?>_MBillAmount_<?php echo $k;?>" id="MBill_<?php echo $j;?>_MBillAmount_<?php echo $k;?>" onchange="addNewMaterialAdvBillRow(this,true)" readonly value="<?php echo $this->commonHelper()->sanitizeNumber($Bill['Amount']);?>"/></td>
                                              <td width="5%" align="center" class="action_btns_td"><ul class="action_btns">
                                                  <li style="float:left;">
                                                    <a class="pull-left" href="<?php echo (trim($Bill['URL']) == '')?'#': $this->basePath(). $Bill['URL'];?>" <?php if(trim($Bill['URL']) != ''): ?> target="_blank" download="" <?php endif; ?>>
                                                    <?php if(trim($Bill['URL']) == ''): ?>
                                                    <span  class="btn-file butclr_imp"> <i class="fa fa-paperclip dcm_atch"></i>
                                                    <input type="file" name="MBill_<?php echo $j;?>_DocFile_<?php echo $k;?>" id="MBill_<?php echo $j;?>_DocFile_<?php echo $k;?>" onchange="addNewMaterialAdvBillRow(this,true);">
                                                    </span>
                                                    <?php else: ?>
                                                    <i class="fa fa-file-o" data-toggle="tooltip" data-placement="left" data-original-title="Download Attachment"></i>
                                                    <input type="hidden" name="MBill_<?php echo $j;?>_DocFile_<?php echo $k;?>" id="MBill_<?php echo $j;?>_DocFile_<?php echo $k;?>" value="<?php echo $Bill['URL'];?>">
                                                    <?php endif; ?>
                                                    </a>
                                                    <?php if(trim($Bill['URL']) != ''): ?>
                                                        <i class="fa fa-chain-broken brkn" onclick="removeAttachment($(this), true);"></i>
                                                    <?php endif; ?>
                                                  </li>
                                                  <li> <a href="#" class="MBill_<?php echo $j;?>_DeleteTr_<?php echo $k;?>" onclick="deleteMaterialBill(this, event,true);"> <i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                                                </ul></td>
                                            </tr>
                                            <?php $k+=1; endforeach; ?>
                                            <?php if($isBillEditable): ?>
                                                <tr class="padi05">
                                                  <input type="hidden" name="MBill_<?php echo $j;?>_PBillTransId_<?php echo $k;?>" id="MBill_<?php echo $j;?>_PBillTransId_<?php echo $k;?>" value="0"/>
                                                  <input type="hidden" name="MBill_<?php echo $j;?>_UpdateMBillRow_<?php echo $k;?>" id="MBill_<?php echo $j;?>_UpdateMBillRow_<?php echo $k;?>" value="0"/>
                                                  <td width="5%"><input class="parent_text date_picker" type="text" name="MBill_<?php echo $j;?>_BillDate_<?php echo $k;?>" id="MBill_<?php echo $j;?>_BillDate_<?php echo $k;?>" onkeypress="return isDate(event);" onchange="validateDate(this);addNewMaterialAdvBillRow(this)"/></td>
                                                  <td width="5%"><input class="parent_text" type="text" name="MBill_<?php echo $j;?>_MBillNo_<?php echo $k;?>" id="MBill_<?php echo $j;?>_MBillNo_<?php echo $k;?>" onchange="addNewMaterialAdvBillRow(this)"/></td>
                                                  <td width="10%"><input class="parent_text VendorNameInputs" type="text" name="MBill_<?php echo $j;?>_MVendorName_<?php echo $k;?>" id="MBill_<?php echo $j;?>_MVendorName_<?php echo $k;?>" onchange="addNewMaterialAdvBillRow(this)" />
                                                    <input type="hidden" class="VendorIdInputs" name="MBill_<?php echo $j;?>_MVendorId_<?php echo $k;?>" id="MBill_<?php echo $j;?>_MVendorId_<?php echo $k;?>"/></td>
                                                  <td width="5%"><input class="parent_text text-right" type="text" name="MBill_<?php echo $j;?>_MBillQty_<?php echo $k;?>" id="MBill_<?php echo $j;?>_MBillQty_<?php echo $k;?>" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" maxlength="12" onchange="addNewMaterialAdvBillRow(this)"/></td>
                                                  <td width="6%"><input class="parent_text text-right" type="text" name="MBill_<?php echo $j;?>_MBillRate_<?php echo $k;?>" id="MBill_<?php echo $j;?>_MBillRate_<?php echo $k;?>" onchange="addNewMaterialAdvBillRow(this)" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)" maxlength="18"/></td>
                                                  <td width="5%"><input class="parent_padi05 text-right" type="text" name="MBill_<?php echo $j;?>_MBillAmount_<?php echo $k;?>" id="MBill_<?php echo $j;?>_MBillAmount_<?php echo $k;?>" onchange="addNewMaterialAdvBillRow(this)" readonly/></td>
                                                  <td width="5%" align="center" class="action_btns_td"><ul class="action_btns">
                                                      <li style="float:left;"> <a href="#"> <span   class="btn-file butclr_imp"> <i class="fa fa-paperclip dcm_atch"></i>
                                                        <input type="file" name="MBill_<?php echo $j;?>_DocFile_<?php echo $k;?>" id="MBill_<?php echo $j;?>_DocFile_<?php echo $k;?>">
                                                        </span> </a> </li>
                                                      <li> <a href="#" class="MBill_<?php echo $j;?>_DeleteTr_<?php echo $k;?>" onclick="deleteMaterialBill(this, event);" style="display: none;"> <i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                                                    </ul></td>
                                                </tr>
                                            <?php endif; ?>
                                          </tbody>
                                          <tbody class="subtotal">
                                            <tr class="padi05">
                                              <td width="5%">&nbsp;</td>
                                              <td width="5%">&nbsp;</td>
                                              <td width="10%" class="rate_pri" align="right">Total</td>
                                              <td width="6%"><input class="parent_padi05 text-right" type="text" name="MBillTotalQty_<?php echo $j;?>" id="MBillTotalQty_<?php echo $j;?>" value="<?php echo $this->commonHelper()->sanitizeNumber($qtyTotal,3);?>" readonly/></td>
                                              <td width="6%"><input class="parent_padi05 text-right" type="text" name="MBillTotalRate_<?php echo $j;?>" id="MBillTotalRate_<?php echo $j;?>" value="<?php echo $this->commonHelper()->sanitizeNumber($rateTotal);?>" readonly/></td>
                                              <td width="8%"><input class="parent_padi05 text-right" type="text" name="MBillTotalAmount_<?php echo $j;?>" id="MBillTotalAmount_<?php echo $j;?>" value="<?php echo $this->commonHelper()->sanitizeNumber($amtTotal);?>" readonly/></td>
                                              <td width="1%">&nbsp;</td>
                                            </tr>
                                          </tbody>
                                        </table>
                                        <input type="hidden" name="materialadvbillrowid_<?php echo $j;?>" id="materialadvbillrowid_<?php echo $j;?>" value="<?php echo $k;?>"/>
                                      </div>
                                    </div>
                                  </div></td>
                              </tr>
                              <tr class="total padi05">
                                <td width="13%">&nbsp;</td>
                                <td class="nt-am" align="right" width="5%"><span>Total Purchased Qty</span></td>
                                <td width="8%"><input class="parent_padi05 text-right" type="text" name="MaterialTotalPurQty_<?php echo $j;?>" id="MaterialTotalPurQty_<?php echo $j;?>" value="<?php echo $this->commonHelper()->sanitizeNumber($MAdvance['PurchaseQty'],3);?>" readonly/></td>
                                <td class="nt-am" align="right" width="3%"><span>Total Consumed Qty</span></td>
                                <td width="8%"><input class="parent_text text-right" type="text" name="MaterialTotalConQty_<?php echo $j;?>" id="MaterialTotalConQty_<?php echo $j;?>" value="<?php echo $this->commonHelper()->sanitizeNumber($MAdvance['ConsumeQty'],3);?>" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" maxlength="18" onchange="changeMAdvTotalQty(this,true)"/></td>
                                <td class="nt-am" align="right" width="5%"><span>Stock @ Site</span></td>
                                <td width="8%"><input class="parent_padi05 text-right" type="text" name="MaterialTotalStock_<?php echo $j;?>" id="MaterialTotalStock_<?php echo $j;?>" value="<?php echo $this->commonHelper()->sanitizeNumber($MAdvance['PurchaseQty']-$MAdvance['ConsumeQty'],3);?>" readonly/></td>
                                <td width="4%">&nbsp;</td>
                              </tr>
                              <?php  $j=$j+1; endforeach; ?>
                              <?php if($isBillEditable): ?>
                                  <tr class="padi05">
                                    <input type="hidden" name="MAdvUpdateRow_<?php echo $j;?>" id="MAdvUpdateRow_<?php echo $j;?>" value="0"/>
                                    <input type="hidden" name="MAdvTransId_<?php echo $j;?>" id="MAdvTransId_<?php echo $j;?>" value="0"/>
                                    <td width="13%"><input class="parent_text" type="text" name="MaterialName_<?php echo $j;?>" id="MaterialName_<?php echo $j;?>" onfocus="checkMaterialAdv(this.id);"/>
                                      <input type="hidden" name="MaterialId_<?php echo $j;?>" id="MaterialId_<?php echo $j;?>"/></td>
                                    <td width="5%"><input class="parent_padi05" type="text" name="MUnit_<?php echo $j;?>" id="MUnit_<?php echo $j;?>" readonly/>
                                      <input type="hidden" name="MUnitId_<?php echo $j;?>" id="MUnitId_<?php echo $j;?>"/></td>
                                    <td width="5%"><input class="parent_padi05 text-right" type="text" name="MQty_<?php echo $j;?>" id="MQty_<?php echo $j;?>" onchange="addNewMAdvRow(this)" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" maxlength="12" readonly/></td>
                                    <td width="6%"><input class="parent_padi05 text-right" type="text" name="MRate_<?php echo $j;?>" id="MRate_<?php echo $j;?>" readonly/></td>
                                    <td width="5%"><input class="parent_padi05 text-right" type="text" name="MAmount_<?php echo $j;?>" id="MAmount_<?php echo $j;?>" readonly/></td>
                                    <td width="10%"><input class="parent_padi05 text-right" type="text" name="MAdvancePer_<?php echo $j;?>" id="MAdvancePer_<?php echo $j;?>" readonly/></td>
                                    <td width="10%"><input class="parent_padi05 text-right" type="text" name="MAdvAmount_<?php echo $j;?>" id="MAdvAmount_<?php echo $j;?>" readonly/></td>
                                    <td width="5%" align="center" class="action_btns_td"><ul class="action_btns">
                                        <li> <a href="#" class="mainTr"> <i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="top" data-original-title="Add lines" ></i></a> </li>
                                        <li> <a href="#" class="MaterialDeleteTr_<?php echo $j;?>" onclick="deleteMaterial(this, event);" style="display: none;"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                                      </ul></td>
                                  </tr>
                                  <tr style="display:none;" class="subTr">
                                    <td colspan="9" style="padding:0px !important; "><div class="subDiv" style="display:none;">
                                        <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"> </div>
                                        <div class="col-lg-12">
                                          <div class="table-responsive topsp">
                                            <table class="table" style="margin-bottom:0px;">
                                              <thead>
                                                <tr>
                                                  <th>Bill Date</th>
                                                  <th>Bill No</th>
                                                  <th>Vendor Name</th>
                                                  <th class="text-right">Qty</th>
                                                  <th class="text-right">Rate</th>
                                                  <th class="text-right">Amount</th>
                                                  <th>&nbsp; </th>
                                                </tr>
                                              </thead>
                                              <tbody class="submain">
                                                <?php $k = 1;?>
                                                <tr class="padi05">
                                                  <input type="hidden" name="MBill_<?php echo $j;?>_PBillTransId_<?php echo $k;?>" id="MBill_<?php echo $j;?>_PBillTransId_<?php echo $k;?>" value="0"/>
                                                  <input type="hidden" name="MBill_<?php echo $j;?>_UpdateMBillRow_<?php echo $k;?>" id="MBill_<?php echo $j;?>_UpdateMBillRow_<?php echo $k;?>" value="0"/>
                                                  <td width="5%"><input class="parent_text date_picker" type="text" name="MBill_<?php echo $j;?>_BillDate_<?php echo $k;?>" id="MBill_<?php echo $j;?>_BillDate_<?php echo $k;?>" onkeypress="return isDate(event);" onchange="validateDate(this);addNewMaterialAdvBillRow(this)"/></td>
                                                  <td width="5%"><input class="parent_text" type="text" name="MBill_<?php echo $j;?>_MBillNo_<?php echo $k;?>" id="MBill_<?php echo $j;?>_MBillNo_<?php echo $k;?>" onchange="addNewMaterialAdvBillRow(this)"/></td>
                                                  <td width="10%"><input class="parent_text VendorNameInputs" type="text" name="MBill_<?php echo $j;?>_MVendorName_<?php echo $k;?>" id="MBill_<?php echo $j;?>_MVendorName_<?php echo $k;?>" onchange="addNewMaterialAdvBillRow(this)"/>
                                                    <input type="hidden" class="VendorIdInputs" name="MBill_<?php echo $j;?>_MVendorId_<?php echo $k;?>" id="MBill_<?php echo $j;?>_MVendorId_<?php echo $k;?>"/></td>
                                                  <td width="5%"><input class="parent_text text-right" type="text" name="MBill_<?php echo $j;?>_MBillQty_<?php echo $k;?>" id="MBill_<?php echo $j;?>_MBillQty_<?php echo $k;?>" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" maxlength="12" onchange="addNewMaterialAdvBillRow(this)"/></td>
                                                  <td width="6%"><input class="parent_text text-right" type="text" name="MBill_<?php echo $j;?>_MBillRate_<?php echo $k;?>" id="MBill_<?php echo $j;?>_MBillRate_<?php echo $k;?>" onchange="addNewMaterialAdvBillRow(this)" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)" maxlength="18"/></td>
                                                  <td width="5%"><input class="parent_padi05 text-right" type="text" name="MBill_<?php echo $j;?>_MBillAmount_<?php echo $k;?>" id="MBill_<?php echo $j;?>_MBillAmount_<?php echo $k;?>" onchange="addNewMaterialAdvBillRow(this)" readonly/></td>
                                                  <td width="5%" align="center" class="action_btns_td"><ul class="action_btns">
                                                      <li style="float:left;"> <a href="#"> <span   class="btn-file butclr_imp"> <i class="fa fa-paperclip dcm_atch"></i>
                                                        <input type="file" name="MBill_<?php echo $j;?>_DocFile_<?php echo $k;?>" id="MBill_<?php echo $j;?>_DocFile_<?php echo $k;?>">
                                                        </span> </a> </li>
                                                      <li> <a href="#" class="MBill_<?php echo $j;?>_DeleteTr_<?php echo $k;?>" onclick="deleteMaterialBill(this, event);" style="display: none;"> <i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                                                    </ul></td>
                                                </tr>
                                              </tbody>
                                              <tbody class="subtotal">
                                                <tr class="padi05">
                                                  <td width="5%">&nbsp;</td>
                                                  <td width="5%">&nbsp;</td>
                                                  <td width="10%" class="rate_pri" align="right">Total</td>
                                                  <td width="6%"><input class="parent_padi05 text-right" type="text" name="MBillTotalQty_<?php echo $j;?>" id="MBillTotalQty_<?php echo $j;?>" readonly/></td>
                                                  <td width="6%"><input class="parent_padi05 text-right" type="text" name="MBillTotalRate_<?php echo $j;?>" id="MBillTotalRate_<?php echo $j;?>" readonly/></td>
                                                  <td width="8%"><input class="parent_padi05 text-right" type="text" name="MBillTotalAmount_<?php echo $j;?>" id="MBillTotalAmount_<?php echo $j;?>" readonly/></td>
                                                  <td width="1%">&nbsp;</td>
                                                </tr>
                                              </tbody>
                                            </table>
                                            <input type="hidden" name="materialadvbillrowid_<?php echo $j;?>" id="materialadvbillrowid_<?php echo $j;?>" value="<?php echo $k;?>"/>
                                          </div>
                                        </div>
                                      </div></td>
                                  </tr>
                                  <tr class="total padi05">
                                    <td width="13%">&nbsp;</td>
                                    <td class="nt-am" align="right" width="5%"><span>Total Purchased Qty</span></td>
                                    <td width="8%"><input class="parent_padi05 text-right" type="text" name="MaterialTotalPurQty_<?php echo $j;?>" id="MaterialTotalPurQty_<?php echo $j;?>" readonly/></td>
                                    <td class="nt-am" align="right" width="3%"><span>Total Consumed Qty</span></td>
                                    <td width="8%"><input class="parent_text text-right" type="text" name="MaterialTotalConQty_<?php echo $j;?>" id="MaterialTotalConQty_<?php echo $j;?>" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" maxlength="18" onchange="changeMAdvTotalQty(this)"/></td>
                                    <td class="nt-am" align="right" width="5%"><span>Stock @ Site</span></td>
                                    <td width="8%"><input class="parent_padi05 text-right" type="text" name="MaterialTotalStock_<?php echo $j;?>" id="MaterialTotalStock_<?php echo $j;?>" readonly/></td>
                                    <td width="4%">&nbsp;</td>
                                  </tr>
                              <?php endif; ?>
                            </tbody>
                          </table>
                          <input type="hidden" name="materialadvrowid" id="materialadvrowid" value="<?php echo $j;?>"/>
                          <input type="hidden" name="materialadvdeleteids" id="materialadvdeleteids" value="0"/>
                          <input type="hidden" name="materialadvbilldeleteids" id="materialadvbilldeleteids" value="0"/>
                        </div>
                      </div>
                    </div></td>
                </tr>
                <?php break;
        case '18': ?>
                <!--Price Escalation-->
                <tr style="display:none;" class="subTr">
                  <td colspan="9" style="padding:0px !important; "><div class="subDiv" style="display:none;">
                      <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"> </div>
                      <div class="col-lg-12">
                        <div class="table-responsive topsp">
                          <table class="table" style="margin-bottom:0px;">
                            <thead>
                              <tr>
                                <th>Material Name</th>
                                <th>Unit</th>
                                <th class="text-right">Qty</th>
                                <th class="text-right">Base Rate</th>
                                <th class="text-right">Escalation %</th>
                                <th class="text-right">Esc. Rate</th>
                                <th class="text-right">Amount</th>
                                <th>&nbsp; </th>
                              </tr>
                            </thead>
                            <tbody class="main" data-rowid="<?php echo $i; ?>">
                              <?php $j=1;
                                    foreach($Format['AddRow'] as $PEscalation):?>
                              <tr class="padi05">
                                <input type="hidden" name="EUpdateRow_<?php echo $j;?>" id="EUpdateRow_<?php echo $j;?>" value="0"/>
                                <input type="hidden" name="ETransId_<?php echo $j;?>" id="ETransId_<?php echo $j;?>" value="<?php echo $PEscalation['MTransId'];?>" />
                                <td width="13%"><input class="parent_padi05" type="text" name="EMaterialName_<?php echo $j;?>" id="EMaterialName_<?php echo $j;?>" value="<?php echo $PEscalation['MaterialName'];?>" readonly/>
                                  <input type="hidden" name="EMaterialId_<?php echo $j;?>" id="EMaterialId_<?php echo $j;?>" value="<?php echo $PEscalation['MaterialId'];?>"/>
                                  <input type="hidden" name="ERateCondition_<?php echo $j;?>" id="ERateCondition_<?php echo $j;?>" value="<?php echo $PEscalation['RateCondition'];?>"/>
                                  <input type="hidden" name="EORate_<?php echo $j;?>" id="EORate_<?php echo $j;?>" value="<?php echo $PEscalation['ORate'];?>"/></td>
                                <td width="5%"><input class="parent_padi05" type="text" name="EMUnit_<?php echo $j;?>" id="EMUnit_<?php echo $j;?>" value="<?php echo $PEscalation['UnitName'];?>" readonly/>
                                  <input type="hidden" name="EMUnitId_<?php echo $j;?>" id="EMUnitId_<?php echo $j;?>" value="<?php echo $PEscalation['UnitId'];?>"/></td>
                                <td width="5%"><input class="parent_text text-right" type="text" name="EMQty_<?php echo $j;?>" id="EMQty_<?php echo $j;?>" onchange="addNewEMRow(this,true)" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" maxlength="12" value="<?php echo $this->commonHelper()->sanitizeNumber($PEscalation['Qty'],3);?>"/></td>
                                <td width="6%"><input class="parent_padi05 text-right" type="text" name="EMRate_<?php echo $j;?>" id="EMRate_<?php echo $j;?>" value="<?php echo $this->commonHelper()->sanitizeNumber($PEscalation['BaseRate'],2,true,true);?>" readonly/></td>
                                <td width="5%"><input class="parent_padi05 text-right" type="text" name="EMEscPercent_<?php echo $j;?>" id="EMEscPercent_<?php echo $j;?>" value="<?php echo $this->commonHelper()->sanitizeNumber($PEscalation['EscalationPer']);?>" readonly/></td>
                                <td width="10%"><input class="parent_padi05 text-right" type="text" name="EMAdvancePer_<?php echo $j;?>" id="EMAdvancePer_<?php echo $j;?>" value="<?php echo $this->commonHelper()->sanitizeNumber($PEscalation['ActualRate']);?>" readonly/></td>
                                <td width="10%"><input class="parent_padi05 text-right" type="text" name="EMAmount_<?php echo $j;?>" id="EMAmount_<?php echo $j;?>" value="<?php echo $this->commonHelper()->sanitizeNumber($PEscalation['Amount'],2,true,true);?>" readonly /></td>
                                <td width="5%" align="center" class="action_btns_td"><ul class="action_btns">
                                    <li> <a href="#" class="mainTr"> <i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="top" data-original-title="Add lines" ></i></a> </li>
                                    <li> <a href="#" class="EMaterialDeleteTr_<?php echo $j;?>" onclick="deleteEMaterial(this, event, true);"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                                  </ul></td>
                              </tr>
                              <tr style="display:none;" class="subTr">
                                <td colspan="9" style="padding:0px !important; "><div class="subDiv" style="display:none;">
                                    <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"> </div>
                                    <div class="col-lg-12">
                                      <div class="table-responsive topsp">
                                        <table class="table" style="margin-bottom:0px;">
                                          <thead>
                                            <tr>
                                              <th>Bill Date</th>
                                              <th>Bill No</th>
                                              <th>Vendor Name</th>
                                              <th class="text-right">Qty</th>
                                              <th class="text-right">Rate</th>
                                              <th class="text-right">Amount</th>
                                              <th>&nbsp; </th>
                                            </tr>
                                          </thead>
                                          <tbody class="submain">
                                            <?php $k=1;
                                                $qtyTotal = 0;
                                                $rateTotal = 0;
                                                $amtTotal = 0;
                                                foreach($PEscalation['BillTrans'] as $Bill):
                                                    $qtyTotal += $Bill['Qty'];
                                                    $rateTotal += $Bill['Rate'];
                                                    $amtTotal += $Bill['Amount'];?>
                                            <tr class="padi05">
                                              <input type="hidden" name="EMBill_<?php echo $j;?>_PBillTransId_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_PBillTransId_<?php echo $k;?>" value="<?php echo $Bill['PBillTransId'];?>"/>
                                              <input type="hidden" name="EMBill_<?php echo $j;?>_UpdateMBillRow_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_UpdateMBillRow_<?php echo $k;?>" value="0"/>
                                              <td width="5%"><input class="parent_text date_picker" type="text" name="EMBill_<?php echo $j;?>_PBillDate_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_PBillDate_<?php echo $k;?>" onkeypress="return isDate(event);" onchange="validateDate(this);addNewEMBillRow(this,true)" value="<?php echo $Bill['BillDate'];?>"/></td>
                                              <td width="5%"><input class="parent_text" type="text" name="EMBill_<?php echo $j;?>_PBillNo_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_PBillNo_<?php echo $k;?>" onchange="addNewEMBillRow(this,true)" value="<?php echo $Bill['BillNo'];?>"/></td>
                                              <td width="10%"><input class="parent_text VendorNameInputs" type="text" name="EMBill_<?php echo $j;?>_PVendorName_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_PVendorName_<?php echo $k;?>" onchange="addNewEMBillRow(this,true)" value="<?php echo $Bill['VendorName'];?>"/>
                                                <input type="hidden" class="VendorIdInputs" name="EMBill_<?php echo $j;?>_PVendorId_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_PVendorId_<?php echo $k;?>" value="<?php echo $Bill['VendorId'];?>"/></td>
                                              <td width="5%"><input class="parent_text text-right" type="text" name="EMBill_<?php echo $j;?>_PBillQty_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_PBillQty_<?php echo $k;?>" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" maxlength="12" onchange="addNewEMBillRow(this,true)" value="<?php echo $this->commonHelper()->sanitizeNumber($Bill['Qty'],3);?>"/></td>
                                              <td width="6%"><input class="parent_text text-right" type="text" name="EMBill_<?php echo $j;?>_PBillRate_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_PBillRate_<?php echo $k;?>" onchange="addNewEMBillRow(this,true)" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)" maxlength="18" value="<?php echo $this->commonHelper()->sanitizeNumber($Bill['Rate']);?>"/></td>
                                              <td width="5%"><input class="parent_padi05 text-right" type="text" name="EMBill_<?php echo $j;?>_PBillAmount_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_PBillAmount_<?php echo $k;?>" onchange="addNewEMBillRow(this,true)" readonly value="<?php echo $this->commonHelper()->sanitizeNumber($Bill['Amount']);?>"/></td>
                                              <td width="5%" align="center" class="action_btns_td"><ul class="action_btns">
                                                  <li style="float:left;"> <a class="pull-left" href="<?php echo (trim($Bill['URL']) == '')?'#': $this->basePath(). $Bill['URL'];?>" <?php if(trim($Bill['URL']) != ''): ?> target="_blank" download="" <?php endif; ?>>
                                                    <?php if(trim($Bill['URL']) == ''): ?>
                                                    <span  class="btn-file butclr_imp"> <i class="fa fa-paperclip dcm_atch"></i>
                                                    <input type="file" name="EMBill_<?php echo $j;?>_DocFile_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_DocFile_<?php echo $k;?>" onchange="addNewEMBillRow(this,true);">
                                                    </span>
                                                    <?php else: ?>
                                                    <i class="fa fa-file-o" data-toggle="tooltip" data-placement="left" data-original-title="Download Attachment"></i>
                                                    <input type="hidden" name="EMBill_<?php echo $j;?>_DocFile_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_DocFile_<?php echo $k;?>" value="<?php echo $Bill['URL'];?>">
                                                    <?php endif; ?>
                                                    </a>
                                                    <?php if(trim($Bill['URL']) != ''): ?>
                                                      <i class="fa fa-chain-broken brkn" onclick="removeAttachment($(this), true);"></i>
                                                    <?php endif; ?>
                                                  </li>
                                                  <li> <a href="#" class="EMBill_<?php echo $j;?>_DeleteTr_<?php echo $k;?>" onclick="deleteEMaterialBill(this, event, true);"> <i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                                                </ul></td>
                                            </tr>
                                            <?php $k+=1; endforeach; ?>
                                            <?php if($isBillEditable): ?>
                                                <tr class="padi05">
                                                  <input type="hidden" name="EMBill_<?php echo $j;?>_PBillTransId_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_PBillTransId_<?php echo $k;?>" value="0"/>
                                                  <input type="hidden" name="EMBill_<?php echo $j;?>_UpdateMBillRow_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_UpdateMBillRow_<?php echo $k;?>" value="0"/>
                                                  <td width="5%"><input class="parent_text date_picker" type="text" name="EMBill_<?php echo $j;?>_PBillDate_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_PBillDate_<?php echo $k;?>" onkeypress="return isDate(event);" onchange="validateDate(this);addNewEMBillRow(this)"/></td>
                                                  <td width="5%"><input class="parent_text" type="text" name="EMBill_<?php echo $j;?>_PBillNo_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_PBillNo_<?php echo $k;?>" onchange="addNewEMBillRow(this)"/></td>
                                                  <td width="10%"><input class="parent_text VendorNameInputs" type="text" name="EMBill_<?php echo $j;?>_PVendorName_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_PVendorName_<?php echo $k;?>" onchange="addNewEMBillRow(this)"/>
                                                    <input type="hidden" class="VendorIdInputs" name="EMBill_<?php echo $j;?>_PVendorId_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_PVendorId_<?php echo $k;?>"/></td>
                                                  <td width="5%"><input class="parent_text text-right" type="text" name="EMBill_<?php echo $j;?>_PBillQty_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_PBillQty_<?php echo $k;?>" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" maxlength="12" onchange="addNewEMBillRow(this)"/></td>
                                                  <td width="6%"><input class="parent_text text-right" type="text" name="EMBill_<?php echo $j;?>_PBillRate_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_PBillRate_<?php echo $k;?>" onchange="addNewEMBillRow(this)" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)" maxlength="18"/></td>
                                                  <td width="5%"><input class="parent_padi05 text-right" type="text" name="EMBill_<?php echo $j;?>_PBillAmount_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_PBillAmount_<?php echo $k;?>" onchange="addNewEMBillRow(this)" readonly/></td>
                                                  <td width="5%" align="center" class="action_btns_td"><ul class="action_btns">
                                                      <li style="float:left;"> <a href="#" class="pull-left"> <span   class="btn-file butclr_imp"> <i class="fa fa-paperclip dcm_atch"></i>
                                                        <input type="file" name="EMBill_<?php echo $j;?>_DocFile_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_DocFile_<?php echo $k;?>">
                                                        </span> </a> </li>
                                                      <li> <a href="#" class="EMBill_<?php echo $j;?>_DeleteTr_<?php echo $k;?>" onclick="deleteEMaterialBill(this, event);" style="display: none;"> <i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                                                    </ul></td>
                                                </tr>
                                            <?php endif; ?>
                                          </tbody>
                                          <tbody class="subtotal">
                                            <tr class="padi05">
                                              <td width="5%">&nbsp;</td>
                                              <td width="5%">&nbsp;</td>
                                              <td width="10%" class="rate_pri" align="right">Total</td>
                                              <td width="6%"><input class="parent_padi05 text-right" type="text" name="EMBillTotalQty_<?php echo $j;?>" id="EMBillTotalQty_<?php echo $j;?>" value="<?php echo $this->commonHelper()->sanitizeNumber($qtyTotal,3);?>" readonly/></td>
                                              <td width="6%"><input class="parent_padi05 text-right" type="text" name="EMBillTotalRate_<?php echo $j;?>" id="EMBillTotalRate_<?php echo $j;?>" value="<?php echo $this->commonHelper()->sanitizeNumber($rateTotal);?>" readonly/></td>
                                              <td width="8%"><input class="parent_padi05 text-right" type="text" name="EMBillTotalAmount_<?php echo $j;?>" id="EMBillTotalAmount_<?php echo $j;?>" value="<?php echo $this->commonHelper()->sanitizeNumber($amtTotal);?>" readonly/></td>
                                              <td width="1%">&nbsp;</td>
                                            </tr>
                                          </tbody>
                                        </table>
                                        <input type="hidden" name="embillrowid_<?php echo $j;?>" id="embillrowid_<?php echo $j;?>" value="<?php echo $k;?>"/>
                                      </div>
                                    </div>
                                  </div></td>
                              </tr>
                              <tr class="total padi05">
                                <td class="nt-am" align="right" width="5%"><span>Purchase Rate</span></td>
                                <td width="8%"><input class="parent_padi05 text-right" type="text" name="EMaterialTotalPurRate_<?php echo $j;?>" id="EMaterialTotalPurRate_<?php echo $j;?>" value="<?php echo $this->commonHelper()->sanitizeNumber($rateTotal);?>" readonly/></td>
                                <td class="nt-am" align="right" width="3%"><span>Base Rate</span></td>
                                <td width="8%"><input class="parent_padi05 text-right" type="text" name="EMaterialTotalBaseRate_<?php echo $j;?>" id="EMaterialTotalBaseRate_<?php echo $j;?>" value="<?php echo $this->commonHelper()->sanitizeNumber($PEscalation['BaseRate']);?>" readonly/></td>
                                <td class="nt-am" align="right" width="5%"><span>Escalation %</span></td>
                                <td width="8%"><input class="parent_padi05 text-right" type="text" name="EMaterialTotalEscPer_<?php echo $j;?>" id="EMaterialTotalEscPer_<?php echo $j;?>" value="<?php echo $this->commonHelper()->sanitizeNumber($PEscalation['EscalationPer']);?>" readonly/></td>
                                <td class="nt-am" align="right" width="5%"><span>Esc. Rate</span></td>
                                <td width="8%"><input class="parent_padi05 text-right" type="text" name="EMaterialTotalActRate_<?php echo $j;?>" id="EMaterialTotalActRate_<?php echo $j;?>"  value="<?php echo $this->commonHelper()->sanitizeNumber($PEscalation['ActualRate']);?>" readonly/></td>
                              </tr>
                              <?php $j=$j+1; endforeach; ?>
                              <?php if($isBillEditable): ?>
                                  <tr class="padi05">
                                    <input type="hidden" name="EUpdateRow_<?php echo $j;?>" id="EUpdateRow_<?php echo $j;?>" value="0"/>
                                    <input type="hidden" name="ETransId_<?php echo $j;?>" id="ETransId_<?php echo $j;?>" value="0" />
                                    <td width="13%"><input class="parent_text" type="text" name="EMaterialName_<?php echo $j;?>" id="EMaterialName_<?php echo $j;?>" onfocus="checkPriceEscMaterial(this.id)"/>
                                      <input type="hidden" name="EMaterialId_<?php echo $j;?>" id="EMaterialId_<?php echo $j;?>"/>
                                      <input type="hidden" name="ERateCondition_<?php echo $j;?>" id="ERateCondition_<?php echo $j;?>"/>
                                      <input type="hidden" name="EORate_<?php echo $j;?>" id="EORate_<?php echo $j;?>"/></td>
                                    <td width="5%"><input class="parent_padi05" type="text" name="EMUnit_<?php echo $j;?>" id="EMUnit_<?php echo $j;?>" readonly/>
                                      <input type="hidden" name="EMUnitId_<?php echo $j;?>" id="EMUnitId_<?php echo $j;?>"/></td>
                                    <td width="5%"><input class="parent_text text-right" type="text" name="EMQty_<?php echo $j;?>" id="EMQty_<?php echo $j;?>" onchange="addNewEMRow(this)" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" maxlength="12"/></td>
                                    <td width="6%"><input class="parent_padi05 text-right" type="text" name="EMRate_<?php echo $j;?>" id="EMRate_<?php echo $j;?>" readonly/></td>
                                    <td width="5%"><input class="parent_padi05 text-right" type="text" name="EMEscPercent_<?php echo $j;?>" id="EMEscPercent_<?php echo $j;?>" readonly/></td>
                                    <td width="10%"><input class="parent_padi05 text-right" type="text" name="EMAdvancePer_<?php echo $j;?>" id="EMAdvancePer_<?php echo $j;?>" readonly/></td>
                                    <td width="10%"><input class="parent_padi05 text-right" type="text" name="EMAmount_<?php echo $j;?>" id="EMAmount_<?php echo $j;?>" readonly /></td>
                                    <td width="5%" align="center" class="action_btns_td"><ul class="action_btns">
                                        <li> <a href="#" class="mainTr"> <i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="top" data-original-title="Add lines" ></i></a> </li>
                                        <li> <a href="#" class="EMaterialDeleteTr_<?php echo $j;?>" onclick="deleteEMaterial(this, event);" style="display: none;"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                                      </ul></td>
                                  </tr>
                                  <tr style="display:none;" class="subTr">
                                    <td colspan="9" style="padding:0px !important; "><div class="subDiv" style="display:none;">
                                        <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"> </div>
                                        <div class="col-lg-12">
                                          <div class="table-responsive topsp">
                                            <table class="table" style="margin-bottom:0px;">
                                              <thead>
                                                <tr>
                                                  <th>Bill Date</th>
                                                  <th>Bill No</th>
                                                  <th>Vendor Name</th>
                                                  <th class="text-right">Qty</th>
                                                  <th class="text-right">Rate</th>
                                                  <th class="text-right">Amount</th>
                                                  <th>&nbsp; </th>
                                                </tr>
                                              </thead>
                                              <tbody class="submain">
                                                <?php $k=1;?>
                                                <tr class="padi05">
                                                  <input type="hidden" name="EMBill_<?php echo $j;?>_PBillTransId_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_PBillTransId_<?php echo $k;?>" value="0"/>
                                                  <input type="hidden" name="EMBill_<?php echo $j;?>_UpdateMBillRow_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_UpdateMBillRow_<?php echo $k;?>" value="0"/>
                                                  <td width="5%"><input class="parent_text date_picker" type="text" name="EMBill_<?php echo $j;?>_PBillDate_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_PBillDate_<?php echo $k;?>" onkeypress="return isDate(event);" onchange="validateDate(this);addNewEMBillRow(this)"/></td>
                                                  <td width="5%"><input class="parent_text" type="text" name="EMBill_<?php echo $j;?>_PBillNo_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_PBillNo_<?php echo $k;?>" onchange="addNewEMBillRow(this)"/></td>
                                                  <td width="10%"><input class="parent_text VendorNameInputs" type="text" name="EMBill_<?php echo $j;?>_PVendorName_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_PVendorName_<?php echo $k;?>" onchange="addNewEMBillRow(this)"/>
                                                    <input type="hidden" class="VendorIdInputs" name="EMBill_<?php echo $j;?>_PVendorId_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_PVendorId_<?php echo $k;?>"/></td>
                                                  <td width="5%"><input class="parent_text text-right" type="text" name="EMBill_<?php echo $j;?>_PBillQty_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_PBillQty_<?php echo $k;?>" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" maxlength="12" onchange="addNewEMBillRow(this)"/></td>
                                                  <td width="6%"><input class="parent_text text-right" type="text" name="EMBill_<?php echo $j;?>_PBillRate_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_PBillRate_<?php echo $k;?>" onchange="addNewEMBillRow(this)" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)" maxlength="18"/></td>
                                                  <td width="5%"><input class="parent_padi05 text-right" type="text" name="EMBill_<?php echo $j;?>_PBillAmount_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_PBillAmount_<?php echo $k;?>" onchange="addNewEMBillRow(this)" readonly/></td>
                                                  <td width="5%" align="center" class="action_btns_td"><ul class="action_btns">
                                                      <li style="float:left;"> <a href="#" class="pull-left"> <span   class="btn-file butclr_imp"> <i class="fa fa-paperclip dcm_atch"></i>
                                                        <input type="file" name="EMBill_<?php echo $j;?>_DocFile_<?php echo $k;?>" id="EMBill_<?php echo $j;?>_DocFile_<?php echo $k;?>">
                                                        </span> </a> </li>
                                                      <li> <a href="#" class="EMBill_<?php echo $j;?>_DeleteTr_<?php echo $k;?>" onclick="deleteEMaterialBill(this, event);" style="display: none;"> <i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                                                    </ul></td>
                                                </tr>
                                              </tbody>
                                              <tbody class="subtotal">
                                                <tr class="padi05">
                                                  <td width="5%">&nbsp;</td>
                                                  <td width="5%">&nbsp;</td>
                                                  <td width="10%" class="rate_pri" align="right">Total</td>
                                                  <td width="6%"><input class="parent_padi05 text-right" type="text" name="EMBillTotalQty_<?php echo $j;?>" id="EMBillTotalQty_<?php echo $j;?>" readonly/></td>
                                                  <td width="6%"><input class="parent_padi05 text-right" type="text" name="EMBillTotalRate_<?php echo $j;?>" id="EMBillTotalRate_<?php echo $j;?>" readonly/></td>
                                                  <td width="8%"><input class="parent_padi05 text-right" type="text" name="EMBillTotalAmount_<?php echo $j;?>" id="EMBillTotalAmount_<?php echo $j;?>" readonly/></td>
                                                  <td width="1%">&nbsp;</td>
                                                </tr>
                                              </tbody>
                                            </table>
                                            <input type="hidden" name="embillrowid_<?php echo $j;?>" id="embillrowid_<?php echo $j;?>" value="<?php echo $k;?>"/>
                                          </div>
                                        </div>
                                      </div></td>
                                  </tr>
                                  <tr class="total padi05">
                                    <td class="nt-am" align="right" width="5%"><span>Purchase Rate</span></td>
                                    <td width="8%"><input class="parent_padi05 text-right" type="text" name="EMaterialTotalPurRate_<?php echo $j;?>" id="EMaterialTotalPurRate_<?php echo $j;?>" readonly/></td>
                                    <td class="nt-am" align="right" width="3%"><span>Base Rate</span></td>
                                    <td width="8%"><input class="parent_padi05 text-right" type="text" name="EMaterialTotalBaseRate_<?php echo $j;?>" id="EMaterialTotalBaseRate_<?php echo $j;?>" readonly/></td>
                                    <td class="nt-am" align="right" width="5%"><span>Escalation %</span></td>
                                    <td width="8%"><input class="parent_padi05 text-right" type="text" name="EMaterialTotalEscPer_<?php echo $j;?>" id="EMaterialTotalEscPer_<?php echo $j;?>" readonly/></td>
                                    <td class="nt-am" align="right" width="5%"><span>Esc. Rate</span></td>
                                    <td width="8%"><input class="parent_padi05 text-right" type="text" name="EMaterialTotalActRate_<?php echo $j;?>" id="EMaterialTotalActRate_<?php echo $j;?>" readonly/></td>
                                  </tr>
                              <?php endif; ?>
                            </tbody>
                          </table>
                          <input type="hidden" name="priceescalationrowid" id="priceescalationrowid" value="<?php echo $j;?>"/>
                          <input type="hidden" name="priceescalationdeleteids" id="priceescalationdeleteids" value="0"/>
                          <input type="hidden" name="priceescalationbilldeleteids" id="priceescalationbilldeleteids" value="0"/>
                        </div>
                      </div>
                    </div></td>
                </tr>
                <?php break;
        case '5': ?>
                <!--MobAdvance Recovery-->
                <tr style="display:none;" class="subTr">
                  <td colspan="9" style="padding:0px !important; "><div class="subDiv" style="display:none;">
                      <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"> </div>
                      <div class="col-lg-12">
                        <div class="table-responsive topsp">
                          <table class="table" style="margin-bottom:0px;" id="AbsSubTable-<?php echo $i; ?>">
                            <thead>
                              <tr>
                                <th>Ref No.</th>
                                <th>Date</th>
                                <th>Description</th>
                                <th class="text-right">Total Advance</th>
                                <th class="text-right">Recovered</th>
                                <th class="text-right">Balance</th>
                                <th class="text-right">Current</th>
<!--                                <th>&nbsp;</th>-->
                              </tr>
                            </thead>
                            <tbody class="main" data-rowid="<?php echo $i; ?>">
                              <?php $j=1;
                                    $total = 0;
                                    foreach($Format['Receipt'] as $ARReceipt):
                                        $total += $ARReceipt['CurAmount'];?>
                              <tr class="padi05">
                                <input type="hidden" name="mobAdvRecoveryReceiptId_<?php echo $j; ?>" id="mobAdvRecoveryReceiptId_<?php echo $j; ?>" value="<?php echo $ARReceipt['ReceiptId'];?>"/>
                                <input type="hidden" name="mobAdvRecoveryBillFormatId_<?php echo $j; ?>" id="mobAdvRecoveryBillFormatId_<?php echo $j; ?>" value="0"/>
                                <td width="5%"><input class="parent_padi05" type="text" id="mobAdvRecoveryRef_<?php echo $j; ?>" value="<?php echo $ARReceipt['ReceiptNo'];?>" readonly/></td>
                                <td width="7%"><input class="parent_padi05" type="text" id="mobAdvRecoveryDate_<?php echo $j; ?>" value="<?php echo $ARReceipt['ReceiptDate'];?>" readonly/></td>
                                <td width="8%"><input class="parent_padi05" type="text" id="mobAdvRecoveryDesc_<?php echo $j; ?>" value="Receipt" readonly/></td>
                                <td width="5%"><input class="parent_padi05 text-right" type="text" id="mobAdvRecoveryTotalAdvance_<?php echo $j; ?>" value="<?php echo $this->commonHelper()->sanitizeNumber($ARReceipt['Amount']);?>" readonly/></td>
                                <td width="5%"><input class="parent_padi05 text-right" type="text" id="mobAdvRecoveryRecovered_<?php echo $j; ?>" value="<?php echo $this->commonHelper()->sanitizeNumber($ARReceipt['PreAmount']);?>" readonly/></td>
                                <td width="5%"><input class="parent_padi05 text-right" type="text" id="mobAdvRecoveryBalance_<?php echo $j; ?>" value="<?php echo $this->commonHelper()->sanitizeNumber($ARReceipt['Balance']);?>" readonly/></td>
                                <td width="5%"><input class="parent_text text-right" type="text" name="mobAdvRecoveryCurrent_<?php echo $j; ?>" id="mobAdvRecoveryCurrent_<?php echo $j; ?>" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)" maxlength="18" onchange="calcMobAdvRecoveryTotal(this)" value="<?php echo $this->commonHelper()->sanitizeNumber($ARReceipt['CurAmount']);?>"/></td>
<!--                                <td width="1%" align="center" class="action_btns_td">-->
<!--                                    <ul class="action_btns">-->
<!--                                        <li> <a href="#" class="mobAdvRecoveryDeleteTr_--><?php //echo $j; ?><!--" onclick="deleteMobAdvRecovery(this, event);"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>-->
<!--                                    </ul>-->
<!--                                </td>-->
                              </tr>
                              <?php $j+=1; endforeach; ?>
                            </tbody>
                            <tbody class="total">
                              <tr class="padi05">
                                <td colspan="5"></td>
                                <td align="right" class="rate_pri">Total</td>
                                <td width="5%"><input class="parent_padi05 text-right" type="text" name="mobAdvRecoveryCurrentTotal" id="mobAdvRecoveryCurrentTotal" value="<?php echo $this->commonHelper()->sanitizeNumber($total);?>" readonly/></td>
<!--                                <td>&nbsp;</td>-->
                              </tr>
                            </tbody>
                          </table>
                          <input type="hidden" name="mobadvrecoveryrowid" id="mobadvrecoveryrowid" value="<?php echo $j; ?>"/>
                        </div>
                      </div>
                    </div></td>
                </tr>
                <?php break;
        case '6': ?>
                <!--Advance Recovery-->
                <tr style="display:none;" class="subTr">
                  <td colspan="9" style="padding:0px !important; "><div class="subDiv" style="display:none;">
                      <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"> </div>
                      <div class="col-lg-12">
                        <div class="table-responsive topsp">
                          <table class="table" style="margin-bottom:0px;" id="AbsSubTable-<?php echo $i; ?>">
                            <thead>
                              <tr>
                                <th>Ref No.</th>
                                <th>Date</th>
                                <th>Description</th>
                                <th class="text-right">Total Advance</th>
                                <th class="text-right">Recovered</th>
                                <th class="text-right">Balance</th>
                                <th class="text-right">Current</th>
<!--                                <th>&nbsp;</th>-->
                              </tr>
                            </thead>
                            <tbody class="main" data-rowid="<?php echo $i; ?>">
                              <?php $j=1;
                                    $total = 0;
                                    foreach($Format['Receipt'] as $ARReceipt):
                                        $total += $ARReceipt['CurAmount'];?>
                              <tr class="padi05">
                                <input type="hidden" name="AdvRecoveryReceiptId_<?php echo $j; ?>" id="AdvRecoveryReceiptId_<?php echo $j; ?>" value="<?php echo $ARReceipt['ReceiptId'];?>"/>
                                <input type="hidden" name="AdvRecoveryBillFormatId_<?php echo $j; ?>" id="AdvRecoveryBillFormatId_<?php echo $j; ?>" value="0"/>
                                <td width="5%"><input class="parent_padi05" type="text" id="AdvRecoveryRef_<?php echo $j; ?>" value="<?php echo $ARReceipt['ReceiptNo'];?>" readonly/></td>
                                <td width="7%"><input class="parent_padi05" type="text" id="AdvRecoveryDate_<?php echo $j; ?>" value="<?php echo $ARReceipt['ReceiptDate'];?>" readonly/></td>
                                <td width="8%"><input class="parent_padi05" type="text" id="AdvRecoveryDesc_<?php echo $j; ?>" value="Receipt" readonly/></td>
                                <td width="5%"><input class="parent_padi05 text-right" type="text" id="AdvRecoveryTotalAdvance_<?php echo $j; ?>" value="<?php echo $this->commonHelper()->sanitizeNumber($ARReceipt['Amount']);?>" readonly/></td>
                                <td width="5%"><input class="parent_padi05 text-right" type="text" id="AdvRecoveryRecovered_<?php echo $j; ?>" value="<?php echo $this->commonHelper()->sanitizeNumber($ARReceipt['PreAmount']);?>" readonly/></td>
                                <td width="5%"><input class="parent_padi05 text-right" type="text" id="AdvRecoveryBalance_<?php echo $j; ?>" value="<?php echo $this->commonHelper()->sanitizeNumber($ARReceipt['Balance']);?>" readonly/></td>
                                <td width="5%"><input class="parent_text text-right" type="text" name="AdvRecoveryCurrent_<?php echo $j; ?>" id="AdvRecoveryCurrent_<?php echo $j; ?>" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)" maxlength="18" onchange="calcAdvRecoveryTotal(this)" value="<?php echo $this->commonHelper()->sanitizeNumber($ARReceipt['CurAmount']);?>"/></td>
<!--                                <td width="1%" align="center" class="action_btns_td">-->
<!--                                    <ul class="action_btns">-->
<!--                                        <li> <a href="#" class="AdvRecoveryDeleteTr_--><?php //echo $j; ?><!--" onclick="deleteAdvRecovery(this, event);"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>-->
<!--                                    </ul>-->
<!--                                </td>-->
                              </tr>
                              <?php $j+=1; endforeach; ?>
                            </tbody>
                            <tbody class="total">
                              <tr class="padi05">
                                <td colspan="5"></td>
                                <td align="right" class="rate_pri">Total</td>
                                <td width="5%"><input class="parent_padi05 text-right" type="text" name="AdvRecoveryCurrentTotal" id="AdvRecoveryCurrentTotal" value="<?php echo $this->commonHelper()->sanitizeNumber($total);?>" readonly/></td>
<!--                                <td>&nbsp;</td>-->
                              </tr>
                            </tbody>
                          </table>
                          <input type="hidden" name="advrecoveryrowid" id="advrecoveryrowid" value="<?php echo $j; ?>"/>
                        </div>
                      </div>
                    </div></td>
                </tr>
                <?php break;
        case '21': ?>
                <!--Material Advance Recovery-->
                <tr style="display:none;" class="subTr">
                  <td colspan="9" style="padding:0px !important; "><div class="subDiv" style="display:none;">
                      <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"> </div>
                      <div class="col-lg-12">
                        <div class="table-responsive topsp">
                          <table class="table" style="margin-bottom:0px;" id="MAbsSubTable-<?php echo $i; ?>">
                            <thead>
                              <tr>
                                <th>Ref No.</th>
                                <th>Date</th>
                                <th>Description</th>
                                <th class="text-right">Total Advance</th>
                                <th class="text-right">Recovered</th>
                                <th class="text-right">Balance</th>
                                <th class="text-right">Current</th>
<!--                                <th>&nbsp;</th>-->
                              </tr>
                            </thead>
                            <tbody class="main" data-rowid="<?php echo $i; ?>">
                              <?php $j=1;
                                    $total = 0; ?>
                              <?php foreach($Format['BillAbstract'] as $ARBillAbstract):
                                        $total += $ARBillAbstract['CurAmount'];?>
                              <tr class="padi05">
                                <input type="hidden" name="MAdvRecoveryBillId_<?php echo $j; ?>" id="MAdvRecoveryBillId_<?php echo $j; ?>" value="<?php echo $ARBillAbstract['BillId'];?>"/>
                                <input type="hidden" name="MAdvRecoveryBillFormatId_<?php echo $j; ?>" id="MAdvRecoveryBillFormatId_<?php echo $j; ?>" value="<?php echo $ARBillAbstract['BillFormatId'];?>"/>
                                <td width="5%"><input class="parent_padi05" type="text" id="MAdvRecoveryRef_<?php echo $j; ?>" value="<?php echo $ARBillAbstract['BillNo'];?>" readonly/></td>
                                <td width="7%"><input class="parent_padi05" type="text" id="MAdvRecoveryDate_<?php echo $j; ?>" value="<?php echo $ARBillAbstract['BillDate'];?>" readonly/></td>
                                <td width="8%"><input class="parent_padi05" type="text" id="MAdvRecoveryDesc_<?php echo $j; ?>" value="Bill" readonly/></td>
                                <td width="5%"><input class="parent_padi05 text-right" type="text" id="MAdvRecoveryTotalAdvance_<?php echo $j; ?>" value="<?php echo $this->commonHelper()->sanitizeNumber($ARBillAbstract['Amount']);?>" readonly/></td>
                                <td width="5%"><input class="parent_padi05 text-right" type="text" id="MAdvRecoveryRecovered_<?php echo $j; ?>" value="<?php echo $this->commonHelper()->sanitizeNumber($ARBillAbstract['PreAmount']);?>" readonly/></td>
                                <td width="5%"><input class="parent_padi05 text-right" type="text" id="MAdvRecoveryBalance_<?php echo $j; ?>" value="<?php echo $this->commonHelper()->sanitizeNumber($ARBillAbstract['Balance']);?>" readonly/></td>
                                <td width="5%"><input class="parent_text text-right" type="text" name="MAdvRecoveryCurrent_<?php echo $j; ?>" id="MAdvRecoveryCurrent_<?php echo $j; ?>" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)" maxlength="18" onchange="calcMAdvRecoveryTotal(this)" value="<?php echo $this->commonHelper()->sanitizeNumber($ARBillAbstract['CurAmount']);?>"/></td>
<!--                                <td width="1%" align="center" class="action_btns_td">-->
<!--                                    <ul class="action_btns">-->
<!--                                    <li> <a href="#" class="AdvRecoveryDeleteTr_--><?php //echo $j; ?><!--"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>-->
<!--                                  </ul>-->
<!--                                </td>-->
                              </tr>
                              <?php $j+=1; endforeach; ?>
                            </tbody>
                            <tbody class="total">
                              <tr class="padi05">
                                <td colspan="5"></td>
                                <td align="right" class="rate_pri">Total</td>
                                <td width="5%"><input class="parent_padi05 text-right" type="text" name="MAdvRecoveryCurrentTotal" id="MAdvRecoveryCurrentTotal" value="<?php echo $this->commonHelper()->sanitizeNumber($total);?>" readonly/></td>
<!--                                <td>&nbsp;</td>-->
                              </tr>
                            </tbody>
                          </table>
                          <input type="hidden" name="madvrecoveryrowid" id="madvrecoveryrowid" value="<?php echo $j; ?>"/>
                        </div>
                      </div>
                    </div></td>
                </tr>				
                <?php break;
        case '8': ?>
                <!--Material Recovery-->
                <tr style="display:none;" class="subTr">
                  <td colspan="9" style="padding:0px !important; "><div class="subDiv" style="display:none;">
                      <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"> </div>
                      <div class="col-lg-12">
                        <div class="table-responsive topsp">
                          <table class="table" style="margin-bottom:0px;">
                            <thead>
                              <tr>
                                <th>Material Name</th>
                                <th>Unit</th>
                                <th class="text-right">Qty</th>
                                <th class="text-right">Rate</th>
                                <th class="text-right">Amount</th>
                                <th>&nbsp; </th>
                              </tr>
                            </thead>
                            <tbody class="main" data-rowid="<?php echo $i; ?>">
                              <?php $j=1;
                                    $total = 0;
                                    foreach($Format['AddRow'] as $MRecovery):
                                        $total += $MRecovery['Amount'];?>
                              <tr class="padi05">
                                <td width="13%"><input class="parent_padi05" type="text" name="RMaterialName_<?php echo $j; ?>" id="RMaterialName_<?php echo $j; ?>" value="<?php echo $MRecovery['MaterialName'];?>" readonly/>
                                  <input type="hidden" name="RMaterialId_<?php echo $j; ?>" id="RMaterialId_<?php echo $j; ?>" value="<?php echo $MRecovery['MaterialId'];?>"/></td>
                                <td width="5%"><input class="parent_padi05" type="text" name="RMUnit_<?php echo $j; ?>" id="RMUnit_<?php echo $j; ?>" value="<?php echo $MRecovery['UnitName'];?>" readonly/>
                                  <input type="hidden" name="RMUnitId_<?php echo $j; ?>" id="RMUnitId_<?php echo $j; ?>" value="<?php echo $MRecovery['UnitId'];?>"/></td>
                                <td width="5%"><input class="parent_text text-right" type="text" name="RMQty_<?php echo $j; ?>" id="RMQty_<?php echo $j; ?>" onchange="addNewRMRow(this)" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" maxlength="12" value="<?php echo $this->commonHelper()->sanitizeNumber($MRecovery['Qty'],3);?>"/></td>
                                <td width="6%"><input class="parent_padi05 text-right" type="text" name="RMRate_<?php echo $j; ?>" id="RMRate_<?php echo $j; ?>" readonly value="<?php echo $this->commonHelper()->sanitizeNumber($MRecovery['Rate']);?>"/></td>
                                <td width="5%"><input class="parent_padi05 text-right" type="text" name="RMAmount_<?php echo $j; ?>" id="RMAmount_<?php echo $j; ?>" readonly value="<?php echo $this->commonHelper()->sanitizeNumber($MRecovery['Amount']);?>"/></td>
                                <td width="4%" align="center" class="action_btns_td"><ul class="action_btns">
                                    <li> <a href="#" class="RMaterialDeleteTr_<?php echo $j; ?>" onclick="deleteRMaterial(this, event);"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                                  </ul></td>
                              </tr>
                              <?php $j+=1; endforeach; ?>
                              <tr class="padi05">
                                <td width="13%"><input class="parent_text" type="text" name="RMaterialName_<?php echo $j; ?>" id="RMaterialName_<?php echo $j; ?>" onfocus="checkMaterialRec(this.id);"/>
                                  <input type="hidden" name="RMaterialId_<?php echo $j; ?>" id="RMaterialId_<?php echo $j; ?>" /></td>
                                <td width="5%"><input class="parent_padi05" type="text" name="RMUnit_<?php echo $j; ?>" id="RMUnit_<?php echo $j; ?>" readonly/>
                                  <input type="hidden" name="RMUnitId_<?php echo $j; ?>" id="RMUnitId_<?php echo $j; ?>"/></td>
                                <td width="5%"><input class="parent_text text-right" type="text" name="RMQty_<?php echo $j; ?>" id="RMQty_<?php echo $j; ?>" onchange="addNewRMRow(this)" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" maxlength="12"/></td>
                                <td width="6%"><input class="parent_padi05 text-right" type="text" name="RMRate_<?php echo $j; ?>" id="RMRate_<?php echo $j; ?>" readonly/></td>
                                <td width="5%"><input class="parent_padi05 text-right" type="text" name="RMAmount_<?php echo $j; ?>" id="RMAmount_<?php echo $j; ?>" readonly/></td>
                                <td width="4%" align="center" class="action_btns_td"><ul class="action_btns">
                                    <li> <a href="#" class="RMaterialDeleteTr_<?php echo $j; ?>" onclick="deleteRMaterial(this, event);" style="display: none;"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                                  </ul></td>
                              </tr>
                            </tbody>
                            <tbody class="total">
                              <tr class="padi05">
                                <td colspan="3"></td>
                                <td align="right" class="rate_pri">Total</td>
                                <td width="5%"><input class="parent_padi05 text-right" type="text" name="RMAmountTotal" id="RMAmountTotal"  value="<?php echo $this->commonHelper()->sanitizeNumber($total);?>" readonly/></td>
                                <td>&nbsp;</td>
                              </tr>
                            </tbody>
                          </table>
                          <input type="hidden" name="mrecoveryrowid" id="mrecoveryrowid" value="<?php echo $j; ?>"/>
                        </div>
                      </div>
                    </div></td>
                </tr>
                <?php break;
        case '7': ?>
                <!--Bill Deduction-->
                <tr style="display:none;" class="subTr">
                  <td colspan="9" style="padding:0px !important; "><div class="subDiv" style="display:none;">
                      <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"> </div>
                      <div class="col-lg-12">
                        <div class="table-responsive topsp">
                          <table class="table" style="margin-bottom:0px;">
                            <thead>
                              <tr>
                                <th>Bill Date</th>
                                <th>Bill No.</th>
                                <th>Vendor Name</th>
                                <th class="text-right">Amount</th>
                                <th>&nbsp; </th>
                              </tr>
                            </thead>
                            <tbody class="main" data-rowid="<?php echo $i; ?>">
                              <?php $j=1;
                                        $total = 0;
                                    foreach($Format['AddRow'] as $VBill):
                                        $total += $VBill['Amount'];?>
                              <tr>
                                <input type="hidden" name="DBillTransId_<?php echo $j; ?>" id="DBillTransId_<?php echo $j; ?>" value="<?php echo $VBill['TransId'];?>"/>
                                <input type="hidden" name="UpdateDBillRow_<?php echo $j;?>" id="UpdateDBillRow_<?php echo $j;?>" value="0"/>
                                <td width="5%"><input class="parent_text date_picker" type="text" name="DBillDate_<?php echo $j; ?>" id="DBillDate_<?php echo $j; ?>" onkeypress="return isDate(event);" onchange="validateDate(this);addNewBillDeductionRow(this,true)" value="<?php echo $VBill['BillDate'];?>"/></td>
                                <td width="5%"><input class="parent_text" type="text" name="DBillNo_<?php echo $j; ?>" id="DBillNo_<?php echo $j; ?>" onchange="addNewBillDeductionRow(this,true)" value="<?php echo $VBill['BillNo'];?>"/></td>
                                <td width="5%"><input class="parent_text VendorNameInputs" type="text" name="DVendorName_<?php echo $j; ?>" id="DVendorName_<?php echo $j; ?>" value="<?php echo $VBill['VendorName'];?>" onchange="addNewBillDeductionRow(this,true)"/>
                                  <input type="hidden" class="VendorIdInputs" name="DVendorId_<?php echo $j; ?>" id="DVendorId_<?php echo $j; ?>" value="<?php echo $VBill['VendorId'];?>"/></td>
                                <td width="5%"><input class="parent_text text-right" type="text" name="DAmount_<?php echo $j; ?>" id="DAmount_<?php echo $j; ?>" onchange="addNewBillDeductionRow(this,true)" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)" maxlength="18" value="<?php echo $this->commonHelper()->sanitizeNumber($VBill['Amount']);?>"/></td>
                                <td width="2%" align="center" class="action_btns_td"><ul class="action_btns">
                                    <li style="float:left;">
                                      <a class="pull-left" href="<?php echo (trim($VBill['URL']) == '')?'#': $this->basePath(). $VBill['URL'];?>" <?php if(trim($VBill['URL']) != ''): ?> target="_blank" download="" <?php endif; ?>>
                                          <?php if(trim($VBill['URL']) == ''): ?>
                                          <span class="btn-file butclr_imp"> <i class="fa fa-paperclip dcm_atch"></i>
                                          <input type="file" name="DDocFile_<?php echo $j;?>" id="DDocFile_<?php echo $j;?>" onchange="addNewBillDeductionRow(this,true);">
                                          </span>
                                          <?php else: ?>
                                          <i class="fa fa-file-o" data-toggle="tooltip" data-placement="left" data-original-title="Download Attachment"></i>
                                          <input type="hidden" name="DDocFile_<?php echo $j;?>" id="DDocFile_<?php echo $j;?>" value="<?php echo $VBill['URL'];?>">
                                          <?php endif; ?>
                                      </a>
                                      <?php if(trim($VBill['URL']) != ''): ?>
                                          <i class="fa fa-chain-broken brkn" onclick="removeAttachment($(this), true);"></i>
                                      <?php endif; ?>
                                    </li>
                                    <li><a href="#" class="BillDeductionDeleteTr_<?php echo $j; ?>" onclick="deleteBillDeduction(this, event,true);" ><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                                  </ul></td>
                              </tr>
                              <?php $j+=1; endforeach; ?>
                              <?php if($isBillEditable): ?>
                                  <tr>
                                    <input type="hidden" name="DBillTransId_<?php echo $j; ?>" id="DBillTransId_<?php echo $j; ?>" value="0"/>
                                    <input type="hidden" name="UpdateDBillRow_<?php echo $j;?>" id="UpdateDBillRow_<?php echo $j;?>" value="0"/>
                                    <td width="5%"><input class="parent_text date_picker" type="text" name="DBillDate_<?php echo $j; ?>" id="DBillDate_<?php echo $j; ?>" onkeypress="return isDate(event);" onchange="validateDate(this);addNewBillDeductionRow(this)"/></td>
                                    <td width="5%"><input class="parent_text" type="text" name="DBillNo_<?php echo $j; ?>" id="DBillNo_<?php echo $j; ?>" onchange="addNewBillDeductionRow(this)"/></td>
                                    <td width="5%"><input class="parent_text VendorNameInputs" type="text" name="DVendorName_<?php echo $j; ?>" id="DVendorName_<?php echo $j; ?>"/>
                                      <input type="hidden" class="VendorIdInputs" name="DVendorId_<?php echo $j; ?>" id="DVendorId_<?php echo $j; ?>"/></td>
                                    <td width="5%"><input class="parent_text text-right" type="text" name="DAmount_<?php echo $j; ?>" id="DAmount_<?php echo $j; ?>" onchange="addNewBillDeductionRow(this)" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)" maxlength="18"/></td>
                                    <td width="2%" align="center" class="action_btns_td"><ul class="action_btns">
                                        <li style="float:left;">
                                            <a  class="pull-left" href="#"> <span   class="btn-file butclr_imp"> <i class="fa fa-paperclip dcm_atch"></i>
                                          <input type="file" name="DDocFile_<?php echo $j;?>" id="DDocFile_<?php echo $j;?>"  onchange="addNewBillDeductionRow(this);">
                                          </span> </a>
                                        </li>
                                        <li><a href="#" class="BillDeductionDeleteTr_<?php echo $j; ?>" onclick="deleteBillDeduction(this, event);" style="display: none;"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                                      </ul></td>
                                  </tr>
                              <?php endif; ?>
                            </tbody>
                            <tbody class="total">
                              <tr class="padi05">
                                <td colspan="2"></td>
                                <td align="right" class="rate_pri">Total</td>
                                <td width="5%"><input class="parent_padi05 text-right" type="text" name="DAmountTotal" id="DAmountTotal" value="<?php echo $this->commonHelper()->sanitizeNumber($total);?>" readonly/></td>
                                <td>&nbsp;</td>
                              </tr>
                            </tbody>
                          </table>
                          <input type="hidden" name="billdeductionrowid" id="billdeductionrowid" value="<?php echo $j; ?>"/>
                          <input type="hidden" name="billdeductiondeleteids" id="billdeductiondeleteids" value="0"/>
                        </div>
                      </div>
                    </div></td>
                </tr>
                <?php break;
        case '19': ?>
                <!--Free Supply Material-->
                <tr style="display:none;" class="subTr">
                  <td colspan="9" style="padding:0px !important; "><div class="subDiv" style="display:none;">
                      <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"> </div>
                      <div class="col-lg-12">
                        <div class="table-responsive topsp">
                          <table class="table" style="margin-bottom:0px;">
                            <thead>
                              <tr>
                                <th>Material Name</th>
                                <th>Unit</th>
                                <th class="text-right">Qty</th>
                                <th class="text-right">Rate</th>
                                <th class="text-right">Amount</th>
                                <th>&nbsp; </th>
                              </tr>
                            </thead>
                            <tbody class="main" data-rowid="<?php echo $i; ?>">
                              <?php $j=1;
                                    $total = 0;
                                    foreach($Format['AddRow'] as $FSMaterial):
                                        $total += $FSMaterial['Amount'];?>
                              <tr class="padi05">
                                <td width="13%"><input class="parent_padi05" type="text" name="FSMaterialName_<?php echo $j; ?>" id="FSMaterialName_<?php echo $j; ?>" value="<?php echo $FSMaterial['MaterialName'];?>" readonly/>
                                  <input type="hidden" name="FSMaterialId_<?php echo $j; ?>" id="FSMaterialId_<?php echo $j; ?>" value="<?php echo $FSMaterial['MaterialId'];?>"/></td>
                                <td width="5%"><input class="parent_padi05" type="text" name="FSMUnit_<?php echo $j; ?>" id="FSMUnit_<?php echo $j; ?>" value="<?php echo $FSMaterial['UnitName'];?>" readonly/>
                                  <input type="hidden" name="FSMUnitId_<?php echo $j; ?>" id="FSMUnitId_<?php echo $j; ?>" value="<?php echo $FSMaterial['UnitId'];?>"/></td>
                                <td width="5%"><input class="parent_text text-right" type="text" name="FSMQty_<?php echo $j; ?>" id="FSMQty_<?php echo $j; ?>" onchange="addNewFSMRow(this)" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" maxlength="12" value="<?php echo $this->commonHelper()->sanitizeNumber($FSMaterial['Qty'],3);?>"/></td>
                                <td width="6%"><input class="parent_padi05 text-right" type="text" name="FSMRate_<?php echo $j; ?>" id="FSMRate_<?php echo $j; ?>" readonly value="<?php echo $this->commonHelper()->sanitizeNumber($FSMaterial['Rate'],2,true,true);?>"/></td>
                                <td width="5%"><input class="parent_padi05 text-right" type="text" name="FSMAmount_<?php echo $j; ?>" id="FSMAmount_<?php echo $j; ?>" readonly value="<?php echo $this->commonHelper()->sanitizeNumber($FSMaterial['Amount'],2,true,true);?>"/></td>
                                <td width="4%" align="center" class="action_btns_td"><ul class="action_btns">
                                    <li> <a href="#" class="FSMaterialDeleteTr_<?php echo $j; ?>" onclick="deleteFSMaterial(this, event);"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                                  </ul></td>
                              </tr>
                              <?php $j+=1; endforeach; ?>
                              <?php if($isBillEditable): ?>
                                  <tr class="padi05">
                                    <td width="13%"><input class="parent_text" type="text" name="FSMaterialName_<?php echo $j; ?>" id="FSMaterialName_<?php echo $j; ?>" onfocus="checkFSMaterial(this.id)"/>
                                      <input type="hidden" name="FSMaterialId_<?php echo $j; ?>" id="FSMaterialId_<?php echo $j; ?>"/></td>
                                    <td width="5%"><input class="parent_padi05" type="text" name="FSMUnit_<?php echo $j; ?>" id="FSMUnit_<?php echo $j; ?>" readonly/>
                                      <input type="hidden" name="FSMUnitId_<?php echo $j; ?>" id="FSMUnitId_<?php echo $j; ?>"/></td>
                                    <td width="5%"><input class="parent_text text-right" type="text" name="FSMQty_<?php echo $j; ?>" id="FSMQty_<?php echo $j; ?>" onchange="addNewFSMRow(this)" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" maxlength="12"/></td>
                                    <td width="6%"><input class="parent_padi05 text-right" type="text" name="FSMRate_<?php echo $j; ?>" id="FSMRate_<?php echo $j; ?>" readonly/></td>
                                    <td width="5%"><input class="parent_padi05 text-right" type="text" name="FSMAmount_<?php echo $j; ?>" id="FSMAmount_<?php echo $j; ?>" readonly/></td>
                                    <td width="4%" align="center" class="action_btns_td"><ul class="action_btns">
                                        <li> <a href="#" class="FSMaterialDeleteTr_<?php echo $j; ?>" onclick="deleteFSMaterial(this, event);" style="display: none;"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                                      </ul></td>
                                  </tr>
                              <?php endif; ?>
                            </tbody>
                            <tbody class="total">
                              <tr class="padi05">
                                <td colspan="3"></td>
                                <td align="right" class="rate_pri">Total</td>
                                <td width="5%"><input class="parent_padi05 text-right" type="text" name="FSMAmountTotal" id="FSMAmountTotal" value="<?php echo $this->commonHelper()->sanitizeNumber($total);?>" readonly/></td>
                                <td>&nbsp;</td>
                              </tr>
                            </tbody>
                          </table>
                          <input type="hidden" name="fsmaterialrowid" id="fsmaterialrowid" value="<?php echo $j; ?>"/>
                        </div>
                      </div>
                    </div></td>
                </tr>
                <?php break;
        endswitch; ?>
                <?php $i=$i+1; endforeach; endif; ?>
              </tbody>
              <tbody class="total">
                <tr class="padi05">
                  <td>&nbsp;</td>
                  <td width="10%" align="right" class="nt-am"><b>Net Amount</b></td>
                  <td width="10%" ><input class="parent_text input-lbl text-right" type="text" name="TotalCumAmount" id="TotalCumAmount" value="<?php echo $this->commonHelper()->sanitizeNumber($TotalCumAmount);?>" readonly/></td>
                  <td width="10%"><input class="parent_text input-lbl text-right" type="text" name="TotalPrevAmount" id="TotalPrevAmount" value="<?php echo $this->commonHelper()->sanitizeNumber($TotalPrevAmount);?>" readonly/></td>
                  <td width="10%">
                      <input class="parent_text input-lbl text-right" type="text" name="TotalCurAmount" id="TotalCurAmount" value="<?php echo $this->commonHelper()->sanitizeNumber($TotalCurAmount);?>" readonly/>
                  </td>
                  <td>&nbsp;</td>
                </tr>
              </tbody>
            </table>
            <input type="hidden" name="entryrowid" id="entryrowid" value="<?php echo $i-1;?>"/>
          </div>
        </div>
        <div class="clearfix"></div>
        <!--table end-->
        <?php if(isset($billinfo)): ?>
        <div class="col-lg-12">
          <ul class="listed-dis">
            <?php if($billinfo['TransType'] == 'S'):?>
            <li>
              <div class="radio_check">
                <p>
                  <input type="checkbox" name="isSubCer" id="isSubCer" value="1" <?php echo ($billinfo['IsSubmittedBill'] == '1') ? 'checked' : '';?>>
                  <label class="ripple" for="isSubCer" id="lblIsSubCer">Submitted</label>
                </p>
              </div>
            </li>
            <li style="position:relative;">
            <span>Date </span>
            <!--<span class="date_icon icon-da"><i class="fa fa-calendar"></i></span>-->
              <input <?php echo ($isBillEditable)? 'class="date_picker"' : '';?> type="text" id="date" name="date" value="<?php echo ($billinfo['SubmittedDate'] != '') ? date('d-m-Y', strtotime($billinfo['SubmittedDate'])) : '';?>" disabled />
            </li>
            <li>
              <span>Remarks </span>
              <textarea class="parent_texts" id="remarks" name="remarks" disabled><?php echo $billinfo['SubmittedRemarks']; ?></textarea>
            </li>
            <?php elseif($billinfo['TransType'] == 'C'):?>
            <li>
              <div class="radio_check">
                <p>
                  <input type="checkbox" name="isSubCer" id="isSubCer" value="1" <?php echo ($billinfo['IsCertifiedBill'] == '1') ? 'checked' : '';?>>
                  <label class="ripple" for="isSubCer" id="lblIsSubCer">Certified</label>
                </p>
              </div>
            </li>
            <li style="position:relative;">
                <span>Date </span>
<!--                <span class="date_icon icon-da"><i class="fa fa-calendar"></i></span>-->
                <input <?php echo ($isBillEditable)? 'class="date_picker"' : '';?> type="text" id="date" name="date" value="<?php echo ($billinfo['CertifiedDate'] != '') ? date('d-m-Y', strtotime($billinfo['CertifiedDate'])) : '';?>" disabled />
            </li>
            <li>
                <span>Remarks </span>
                <textarea class="parent_texts" id="remarks" name="remarks" disabled><?php echo $billinfo['CertifiedRemarks']; ?></textarea>
            </li>
            <?php endif; ?>
          </ul>
          <div class="notefic">
<!--            <h1><i class="fa fa-sticky-note-o"></i> Notes</h1>-->
            <ul>
                <li><p>Bills once checked as <?php echo ($billinfo['TransType'] == 'S') ? 'submitted' : 'certified';?> cannot be modified, to be checked only as a final level of validation.</p></li>
            </ul>
          </div>
        </div>
        <?php endif; ?>
         <div class="clearfix"></div>
        <div class="col-lg-12"> 
          <!--Receipt Details-->
          <div class="panel panel-info">
            <div data-target="#collapseTwo" data-parent="#accordion" data-toggle="collapse" class="panel-heading collapsed panel_heads">
              <h4 class="panel-title accordion-toggle defa_panels">Receipt Details</h4>
            </div>
            <div class="panel-collapse collapse" id="collapseTwo" style="height: 0px;">
              <div class="panel-body bgcolr bg-bdy">
                <div class="deft_act">
                  <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0">
                    <div class="table-responsive topsp" style="animation-delay: 0.2s;">
                      <table class="table" style=" margin-bottom:0px;" id="ReceiptDetailsTable">
                        <thead>
                          <tr>
                            <th>Date</th>
                            <th>Mode of Payment</th>
                            <th>Transaction No</th>
                            <th>Payment Description</th>
                            <th class="text-right">Amount</th>
                          </tr>
                        </thead>
                        <tbody class="main">
                          <?php $total=0;
                                    $arr_RAgainsts = array('B' => 'Bill', 'M' => 'Mobilization Advance', 'A' => 'Adhoc Advance', 'R' => 'Retention', 'W' => 'With held', 'O' => 'Others');
                                    if(isset($ReceiptDetails)):
                                    foreach($ReceiptDetails as $Receipt):
                                        $total += $Receipt['Amount'];?>
                          <tr>
                            <td width="5%"><?php echo  $Receipt['ReceiptDate'];?></td>
                            <td width="5%"><?php echo  $Receipt['ReceiptMode'];?></td>
                            <td width="8%"><?php echo  $Receipt['ReceiptNo'];?></td>
                            <td width="8%"><?php echo  $arr_RAgainsts[$Receipt['ReceiptAgainst']];?></td>
                            <td width="3%" align="right"><?php echo $this->commonHelper()->sanitizeNumber($Receipt['Amount']);?></td>
                          </tr>
                          <?php endforeach; endif;?>
                        </tbody>
                        <tbody class="total">
                          <tr>
                            <td width="5%" colspan="3"></td>
                            <td width="8%" class="rate_pri" align="right">Total</td>
                            <td width="3%" align="right" id="ReceiptDetailsTotal" style="font-weight:600 !important; font-size:14px;"><?php echo $this->commonHelper()->sanitizeNumber($total);?></td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!--Receipt Details--> 
        </div>
        <input type="hidden" name="NewVendorRowId" id="NewVendorRowId" value="0" >
        <!--New Non Agt Item-->
        <table  id="newnonagtwrapper" style="display: none;">
          <tr>
            <td ><a href="#" id ="butnewnonagt" class="btn btn-link" onclick="return ShowNonAgtItem(this.id); return false;" >New Non-Agreement Item(s) Created <span class='badge badge_count'>0</span></a></td>
          </tr>
        </table>
        <table class="table" id ="newnonagt" style="display: none; width:50%; border:1px solid #ccc;">
          <thead>
            <tr>
              <th style="border-right:1px solid #ccc;">Specification</th>
              <th class="text-center">&nbsp;</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
        <input type="hidden" name="newnonagtrowid" id="newnonagtrowid" value="0" >
        <!--content--> 
        <!--accordion end-->
 
        <div class="col-lg-12 savebtn_area">
          <ul>
            <?php if(isset($billinfo) && ($billinfo['TransType'] == 'S' && $billinfo['IsSubmittedBill'] != '1') || ($billinfo['TransType'] == 'C' && $billinfo['IsCertifiedBill'] != '1')): ?>
                <li class="dropdown save_btn float_r"><a href="#" onclick="submitForm(); return false;" data-toggle="tooltip" class="ripple" title="Save">Save</a>
              <?php endif; ?>
            <li class="can_btn float_l" style="padding-bottom:10px;"><a href="<?php echo $this->basePath(); ?>/clientbilling/index/billselection">Cancel</a></li>
          </ul>
        </div>
      </form>

      <!--Handson Table-->
        <div class="col-lg-12" id="HandsonWrapper">
            <div class="md-popup">
                <div id="HandsonTableModal">
                    <h1>Measurement Sheet</h1>
                    <?php if(isset($billinfo) && ($billinfo['TransType'] == 'S' && $billinfo['IsSubmittedBill'] != '1') || ($billinfo['TransType'] == 'C' && $billinfo['IsCertifiedBill'] != '1')): ?>
                        <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0 excel-tbs" style="padding-left:0px !important;">
                       <div class="col-lg-4 col-lg-offset-0 col-md-4 col-md-offset-0 col-sm-4 col-sm-offset-0">
                           <div class="form-group">
                                <select id="ExcelTemplate" onChange="getExcelTemplate(this);"  style="width:100%;" class="form-control single_dropdown lbl_move hei-43" data-size="5" label="Chooose a Template">
                                    <option></option>
                                    <?php if($exceltemplates):
                                      foreach($exceltemplates as $template):?>
                                        <option value="<?php echo $template['TemplateId']; ?>"><?php echo $template['TemplateName']; ?></option>
                                      <?php endforeach; endif; ?>
                                </select>
                           </div>
                       </div>
    <!--<li><label>Cell Name</label><input type="text" id="ExcelCellName" onChange="setExcelCellVal()"></li>-->
    <!--<li><label>Cell Value</label><input type="text" id="ExcelCellValue"  readonly></li>-->
                         <div class="col-lg-4 col-lg-offset-0 col-md-4 col-md-offset-0 col-sm-4 col-sm-offset-0">
                            <div class="form-group">
                                <select name="columns[]" id="totalcolumns"  style="width:100%;" class="form-control single_dropdown lbl_move sel-mul" data-size="5" label="Choose Column(s)" multiple onchange="summationColumns(true);">
                                    <option></option>
                                </select>
                            </div>
                          </div>
                          <div class="col-lg-4 col-lg-offset-0 col-md-4 col-md-offset-0 col-sm-4 col-sm-offset-0">
                          <div class="form-group  remove-bt">

                                <a onClick="removeMSheet(); return false;">Remove Measurement Sheet</a>
                            </div></div>
                        </div>
                        <div class="clearfix"></div>
                    <?php endif; ?>
                  <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0">
                    <div class="tabs-content" style="margin-top:20px;">
                        <div id="HandsonTableWrapper" class="hot handsontable"></div>
                    </div>
                    </div>
                </div>
                <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0">
                    <div class="btn-group toal-disgr" data-toggle="buttons" id="summationColumnsWrapper"></div>
                </div>
                <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0">
                    <div class="HandsonModalBtns">
                        <?php if(isset($billinfo) && ($billinfo['TransType'] == 'S' && $billinfo['IsSubmittedBill'] != '1') || ($billinfo['TransType'] == 'C' && $billinfo['IsCertifiedBill'] != '1')): ?>
                            <button type="button" class="md_cance" onClick="return hideHandsonWrapper()">Cancel</button>
                            <button type="button" class="md_ok" onClick="return updateMSheet()">Update</button>
                        <?php else: ?>
                            <button type="button" class="md_cance" onClick="return hideHandsonWrapper()">Close</button>
                        <?php endif; ?>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </div>
</div>
     
<!--Dummy Receipt Details-->
<table id="dummy-receipt-details" style="display: none;">
  <tbody>
    <tr>
      <td width="5%">@ReceiptDate</td>
      <td width="5%">@ReceiptMode</td>
      <td width="8%">@ReceiptNo</td>
      <td width="8%">@ReceiptAgainst</td>
      <td width="3%" align="right">@Amount</td>
    </tr>
  </tbody>
</table>
<!--Dummy Non Agt New Row-->
<table id="dummy-new-nonagt" style="display: none;">
  <tbody>
    <tr class="padi05">
      <td style="border-right:1px solid #ccc;"><input type="text" class="parent_padi05" name="newnonagtslspec__1" id="newnonagtslspec__1" align="right" readonly></td>
      <td width="3%"><button type="button" value = "Show Details" id="newnonagtspecedit__1" onclick="return EditNonAgtItem(this.id)" style="margin:0;" ><i class="fa fa-pencil-square-o ctlss"></i></button></td>
      <input type="hidden" name="newnonagtslno__1" id="newnonagtslno__1" >
      <input type="hidden" name="newnonagtspec__1" id="newnonagtspec__1" >
      <input type="hidden" name="newnonagtid__1" id="newnonagtid__1" >
<!--      <input type="hidden" name="newnonagtwg__1" id="newnonagtwg__1" >-->
<!--      <input type="hidden" name="newnonagtwgid__1" id="newnonagtwgid__1" >-->
      <input type="hidden" name="newnonagtunitid__1" id="newnonagtunitid__1" >
      <input type="hidden" name="newnonagtunitname__1" id="newnonagtunitname__1" >
      <input type="hidden" name="newnonagtrate__1" id="newnonagtrate__1" >
    </tr>
  </tbody>
</table>
<!--Dummy Rows-->
<table id="dummy-entry" style="display: none;">
  <tbody>
    <tr class="padi05">
      <td width="3%"><b class="ra-t" name="RowName__1" id="RowName__1">R1</b></td>
      <td width="10%"><p class="dec-ptr" name="TypeName__1" id="TypeName__1">Agreement Items</p></td>
      <td width="10%" ><input class="parent_padi05 text-right" type="text" name="CumAmount__1" id="CumAmount__1" onblur="return FormatNum(this, 2, true)" onkeypress="return isDecimal(event,this)" maxlength="18" readonly/></td>
      <td width="10%"><input class="parent_padi05 text-right" type="text" name="PrevAmount__1" id="PrevAmount__1" onblur="return FormatNum(this, 2, true)" onkeypress="return isDecimal(event,this)" maxlength="18" readonly/></td>
      <td width="10%"><input class="parent_padi05 text-right" type="text" name="CurAmount__1" id="CurAmount__1" onblur="return FormatNum(this, 2, true)" onkeypress="return isDecimal(event,this)" maxlength="18" readonly onchange="calcBillAbstract();" onfocus="showFormulaModal(this.id)"/></td>
      <td width="3%" align="center" class="action_btns_td"><ul class="action_btns">
          <li> <a href="#" class="mainTr EntryExpand__1"> <i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="top" data-original-title="Add lines" ></i></a> </li>
          <li> <a href="#" class="EntryDeleteTr__1" onclick="deleteEntry(this, event);" style="display: none;"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
        </ul>
        <input type="hidden" name="BillFormatId__1" id="BillFormatId__1"/>
        <input type="hidden" name="FormatTypeId__1" id="FormatTypeId__1"/>
        <input type="hidden" name="Sign__1" id="Sign__1"/>
        <input type="hidden" name="Formula__1" id="Formula__1"/></td>
    </tr>
  </tbody>
</table>
<!--BOQ Type-1-->
<table id="dummy-billformat-boq" style="display: none;">
  <tbody>
    <tr style="display:none;" class="subTr">
      <td colspan="9" style="padding:0px !important; "><div class="subDiv" style="display:none;">
          <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"> </div>
          <div class="col-lg-12">
            <div class="table-responsive topsp">
              <table class="table" style="margin-bottom:0px;" id="boqTable">
                <thead>
                  <tr>
                    <th>Specification</th>
                    <th>Unit</th>
                    <th class="text-right">Qty</th>
                    <th class="text-right">Rate</th>
                    <th class="text-right">Amount</th>
                    <th>&nbsp; </th>
                  </tr>
                </thead>
                <tbody class="main" data-rowid="@ROWID">
                  <tr class="padi05">
                    <input type="hidden" name="BillBOQId__1" id="BillBOQId__1" value="0"/>
                    <input type="hidden" name="UpdateBOQRow__1" id="UpdateBOQRow__1" value="0"/>
                    <td width="8%" style="vertical-align:top!important">
                        <input class="parent_text" type="text" name="Spec__1" id="Spec__1" onfocus="return checkBoqSpec(this.id)"/>
                        <input type="hidden" name="WOBOQId__1" id="WOBOQId__1"/>
                    </td>
                    <td width="5%" style="vertical-align:top!important"><input class="parent_padi05" type="text" name="Unit__1" id="Unit__1" readonly/>
                      <input type="hidden" name="UnitId__1" id="UnitId__1"/></td>
                    <td width="5%" style="vertical-align:top!important" class="val-view">
                        <input class="parent_text text-right" type="text" name="Qty__1" id="Qty__1" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" maxlength="12" onchange="validateAgtQty(this);addNewBOQRow(this)" onfocus="showHandsonTableModal(this);"/>
                        <div class="qtyshow" style="width:20%; float:right;">
                            <a class="float_r ripple" href="javascript:void(0);"><span><i class="fa fa-question"></i></span></a>
                            <div class="qtyshow_toggle">
                                <p><span>Total Qty</span><span id="AgtTotalQty__1"></span></p>
                                <p><span>Prev Qty</span><span id="AgtPrevQty__1"></span></p>
                                <p><span>Bal Qty </span><span id="AgtBalQty__1"></span></p>
                            </div>
                        </div>
                        <input type="hidden" name="Measurement__1" id="Measurement__1"/>
                        <input type="hidden" name="CellName__1" id="CellName__1"/>
                        <input type="hidden" name="SelectedColumns__1" id="SelectedColumns__1"/>
                    </td>
                    <td width="6%" style="vertical-align:top!important"><input class="parent_padi05 text-right" type="text" name="Rate__1" id="Rate__1" readonly/></td>
                    <td width="5%" style="vertical-align:top!important"><input class="parent_padi05 text-right" type="text" name="Amount__1" id="Amount__1" readonly/></td>
                    <td width="3%" align="center" class="action_btns_td" style="vertical-align:top!important"><ul class="action_btns">
                        <li> <a href="#" class="BOQDeleteTr__1" onclick="deleteBOQ(this, event);" style="display: none;"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                      </ul></td>
                  </tr>
                </tbody>
                <tbody class="total">
                  <tr>
                    <td colspan="3"></td>
                    <td align="right" class="rate_pri">Total</td>
                    <td width="5%"><input class="parent_padi05 text-right" type="text" name="BOQTotal" id="BOQTotal" readonly/></td>
                    <td>&nbsp;</td>
                  </tr>
                </tbody>
              </table>
              <input type="hidden" name="boqrowid" id="boqrowid" value="1"/>
            </div>
          </div>
        </div></td>
    </tr>
  </tbody>
</table>
<!--BOQ Type-2-->
<table id="dummy-billformat-boq-2" style="display: none;">
  <tbody>
    <tr style="display:none;" class="subTr">
      <td colspan="9" style="padding:0px !important; "><div class="subDiv" style="display:none;">
          <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"> </div>
          <div class="col-lg-12">
            <div class="table-responsive topsp">
              <table class="table" style="margin-bottom:0px;" id="boqTable-2">
                <thead>
                  <tr>
                    <th>Specification</th>
                    <th>Unit</th>
                    <th class="text-right">Qty</th>
                    <th class="text-right">Rate</th>
                    <th class="text-right">Amount</th>
                    <th>&nbsp; </th>
                  </tr>
                </thead>
                <tbody class="main" data-rowid="@ROWID">
                  <tr class="padi05">
                    <input type="hidden" name="NABillBOQId__1" id="NABillBOQId__1" value="0"/>
                    <input type="hidden" name="NAUpdateBOQRow__1" id="NAUpdateBOQRow__1" value="0"/>
                    <td width="15%"><input class="parent_text" type="text" name="NASpec__1" id="NASpec__1" onchange="addNewNABOQRow(this, true)" onfocus="return checkNonAgtBoqSpec(this.id)"/>
                      <input type="hidden" class="NABOQIdInputs" name="NABOQId__1" id="NABOQId__1"/></td>
                    <td width="5%"><input class="parent_padi05" type="text" name="NAUnit__1" id="NAUnit__1" readonly/>
                      <input type="hidden" name="NAUnitId__1" id="NAUnitId__1"/></td>
                    <td width="5%"><input class="parent_text text-right" type="text" name="NAQty__1" id="NAQty__1" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" maxlength="12" onchange="addNewNABOQRow(this)" onfocus="showHandsonTableModal(this);"/>
                      <input type="hidden" name="NAMeasurement__1" id="NAMeasurement__1"/>
                      <input type="hidden" name="NACellName__1" id="NACellName__1"/>
                      <input type="hidden" name="NASelectedColumns__1" id="NASelectedColumns__1"/></td>
                    <td width="6%"><input class="parent_padi05 text-right" type="text" name="NARate__1" id="NARate__1" onchange="addNewNABOQRow(this)" readonly/></td>
                    <td width="5%"><input class="parent_padi05 text-right" type="text" name="NAAmount__1" id="NAAmount__1" readonly/></td>
                    <td width="3%" align="center" class="action_btns_td"><ul class="action_btns">
                        <li> <a href="#" class="NABOQDeleteTr__1" onclick="deleteNABOQ(this, event);" style="display: none;"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                      </ul></td>
                  </tr>
                </tbody>
                <tbody class="total">
                  <tr class="padi05">
                    <td colspan="3"></td>
                    <td align="right" class="rate_pri">Total</td>
                    <td width="5%"><input class="parent_padi05 text-right" type="text" name="NABOQTotal" id="NABOQTotal" readonly/></td>
                    <td>&nbsp;</td>
                  </tr>
                </tbody>
              </table>
              <input type="hidden" name="naboqrowid" id="naboqrowid" value="1"/>
            </div>
          </div>
        </div></td>
    </tr>
  </tbody>
</table>
<!--Material-->
<table id="dummy-material-adv" style="display: none;">
  <tbody>
    <tr style="display:none;" class="subTr">
      <td colspan="9" style="padding:0px !important; "><div class="subDiv" style="display:none;">
          <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"> </div>
          <div class="col-lg-12">
            <div class="table-responsive topsp">
              <table class="table" style="margin-bottom:0px;">
                <thead>
                  <tr>
                    <th>Material Name</th>
                    <th>Unit</th>
                    <th class="text-right">Qty</th>
                    <th class="text-right">Rate</th>
                    <th class="text-right">Amount</th>
                    <th class="text-right">Advance %</th>
                    <th class="text-right">Adv. Amount</th>
                    <th>&nbsp; </th>
                  </tr>
                </thead>
                <tbody class="main" data-rowid="@ROWID">
                  <tr class="padi05">
                    <input type="hidden" name="MAdvUpdateRow__1" id="MAdvUpdateRow__1" value="0"/>
                    <input type="hidden" name="MAdvTransId__1" id="MAdvTransId__1" value="0"/>
                    <td width="13%"><input class="parent_text" type="text" name="MaterialName__1" id="MaterialName__1" onfocus="checkMaterialAdv(this.id);"/>
                      <input type="hidden" name="MaterialId__1" id="MaterialId__1"/></td>
                    <td width="5%"><input class="parent_padi05" type="text" name="MUnit__1" id="MUnit__1" readonly/>
                      <input type="hidden" name="MUnitId__1" id="MUnitId__1"/></td>
                    <td width="5%"><input class="parent_padi05 text-right" type="text" name="MQty__1" id="MQty__1" onchange="addNewMAdvRow(this)" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" maxlength="12" readonly/></td>
                    <td width="6%"><input class="parent_padi05 text-right" type="text" name="MRate__1" id="MRate__1" readonly/></td>
                    <td width="5%"><input class="parent_padi05 text-right" type="text" name="MAmount__1" id="MAmount__1" readonly/></td>
                    <td width="10%"><input class="parent_padi05 text-right" type="text" name="MAdvancePer__1" id="MAdvancePer__1" readonly/></td>
                    <td width="10%"><input class="parent_padi05 text-right" type="text" name="MAdvAmount__1" id="MAdvAmount__1" readonly /></td>
                    <td width="4%" align="center" class="action_btns_td"><ul class="action_btns">
                        <li> <a href="#" class="mainTr"> <i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="top" data-original-title="Add lines" ></i></a> </li>
                        <li> <a href="#" class="MaterialDeleteTr__1" onclick="deleteMaterial(this, event);" style="display: none;"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                      </ul></td>
                  </tr>
                  <tr style="display:none;" class="subTr">
                    <td colspan="9" style="padding:0px !important; "><div class="subDiv" style="display:none;">
                        <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"> </div>
                        <div class="col-lg-12">
                          <div class="table-responsive topsp">
                            <table class="table" style="margin-bottom:0px;">
                              <thead>
                                <tr>
                                  <th>Bill Date</th>
                                  <th>Bill No</th>
                                  <th>Vendor Name</th>
                                  <th class="text-right">Qty</th>
                                  <th class="text-right">Rate</th>
                                  <th class="text-right">Amount</th>
                                  <th>&nbsp; </th>
                                </tr>
                              </thead>
                              <tbody class="submain">
                                <tr class="padi05">
                                  <input type="hidden" name="MBill__1_UpdateMBillRow__9" id="MBill__1_UpdateMBillRow__9" value="0"/>
                                  <input type="hidden" name="MBill__1_PBillTransId__9" id="MBill__1_PBillTransId__9" value="0"/>
                                  <td width="5%"><input class="parent_text date_picker" type="text" name="MBill__1_BillDate__9" id="MBill__1_BillDate__9" onkeypress="return isDate(event);" onchange="validateDate(this);addNewMaterialAdvBillRow(this)"/></td>
                                  <td width="5%"><input class="parent_text" type="text" name="MBill__1_MBillNo__9" id="MBill__1_MBillNo__9" onchange="addNewMaterialAdvBillRow(this)"/></td>
                                  <td width="8%"><input class="parent_text VendorNameInputs" type="text" name="MBill__1_MVendorName__9" id="MBill__1_MVendorName__9" onchange="addNewMaterialAdvBillRow(this)"/>
                                    <input type="hidden" class="VendorIdInputs" name="MBill__1_MVendorId__9" id="MBill__1_MVendorId__9"/></td>
                                  <td width="5%"><input class="parent_text text-right" type="text" name="MBill__1_MBillQty__9" id="MBill__1_MBillQty__9" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" maxlength="12" onchange="addNewMaterialAdvBillRow(this)"/></td>
                                  <td width="6%"><input class="parent_text text-right" type="text" name="MBill__1_MBillRate__9" id="MBill__1_MBillRate__9" onchange="addNewMaterialAdvBillRow(this)" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)" maxlength="18"/></td>
                                  <td width="5%"><input class="parent_padi05 text-right" type="text" name="MBill__1_MBillAmount__9" id="MBill__1_MBillAmount__9" onchange="addNewMaterialAdvBillRow(this)" readonly/></td>
                                  <td width="2%" align="center" class="action_btns_td"><ul class="action_btns">
                                      <li style="float:left;"> <a href="#" class="pull-left"> <span   class="btn-file butclr_imp"> <i class="fa fa-paperclip dcm_atch"></i>
                                        <input type="file" name="MBill__1_DocFile__9" id="MBill__1_DocFile__9">
                                        </span> </a> </li>
                                      <li> <a href="#" class="MBill__1_DeleteTr__9" onclick="deleteMaterialBill(this, event);" style="display: none;"> <i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                                    </ul></td>
                                </tr>
                              </tbody>
                              <tbody class="subtotal">
                                <tr class="padi05">
                                  <td width="5%">&nbsp;</td>
                                  <td width="5%">&nbsp;</td>
                                  <td width="8%" class="rate_pri" align="right">Total</td>
                                  <td width="6%"><input class="parent_padi05 text-right" type="text" name="MBillTotalQty__1" id="MBillTotalQty__1" readonly/></td>
                                  <td width="6%"><input class="parent_padi05 text-right" type="text" name="MBillTotalRate__1" id="MBillTotalRate__1" readonly/></td>
                                  <td width="8%"><input class="parent_padi05 text-right" type="text" name="MBillTotalAmount__1" id="MBillTotalAmount__1" readonly/></td>
                                  <td width="1%">&nbsp;</td>
                                </tr>
                              </tbody>
                            </table>
                            <input type="hidden" name="materialadvbillrowid__1" id="materialadvbillrowid__1" value="1"/>
                          </div>
                        </div>
                      </div></td>
                  </tr>
                  <tr class="total padi05">
                    <td width="13%">&nbsp;</td>
                    <td class="nt-am" align="right" width="5%"><span>Total Purchased Qty</span></td>
                    <td width="8%"><input class="parent_padi05 text-right" type="text" name="MaterialTotalPurQty__1" id="MaterialTotalPurQty__1" readonly/></td>
                    <td class="nt-am" align="right" width="3%"><span>Total Consumed Qty</span></td>
                    <td width="8%"><input class="parent_text text-right" type="text" name="MaterialTotalConQty__1" id="MaterialTotalConQty__1" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" maxlength="18" onchange="changeMAdvTotalQty(this)"/></td>
                    <td class="nt-am" align="right" width="5%"><span>Stock @ Site</span></td>
                    <td width="8%"><input class="parent_padi05 text-right" type="text" name="MaterialTotalStock__1" id="MaterialTotalStock__1" readonly/></td>
                    <td width="4%">&nbsp;</td>
                  </tr>
                </tbody>
              </table>
              <input type="hidden" name="materialadvrowid" id="materialadvrowid" value="1"/>
              <input type="hidden" name="materialadvdeleteids" id="materialadvdeleteids" value="0"/>
              <input type="hidden" name="materialadvbilldeleteids" id="materialadvbilldeleteids" value="0"/>
            </div>
          </div>
        </div></td>
    </tr>
  </tbody>
</table>
<!--Price Escalation-->
<table id="dummy-price-escalation" style="display: none;">
  <tbody>
    <tr style="display:none;" class="subTr">
      <td colspan="9" style="padding:0px !important; "><div class="subDiv" style="display:none;">
          <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"> </div>
          <div class="col-lg-12">
            <div class="table-responsive topsp">
              <table class="table" style="margin-bottom:0px;">
                <thead>
                  <tr>
                    <th>Material Name</th>
                    <th>Unit</th>
                    <th class="text-right">Qty</th>
                    <th class="text-right">Base Rate</th>
                    <th class="text-right">Escalation %</th>
                    <th class="text-right">Esc. Rate</th>
                    <th class="text-right">Amount</th>
                    <th>&nbsp; </th>
                  </tr>
                </thead>
                <tbody class="main" data-rowid="@ROWID">
                  <tr class="padi05">
                    <input type="hidden" name="EUpdateRow__1" id="EUpdateRow__1" value="0"/>
                    <input type="hidden" name="ETransId__1" id="ETransId__1" value="0" />
                    <td width="13%"><input class="parent_text" type="text" name="EMaterialName__1" id="EMaterialName__1" onfocus="checkPriceEscMaterial(this.id)"/>
                      <input type="hidden" name="EMaterialId__1" id="EMaterialId__1"/>
                      <input type="hidden" name="ERateCondition__1" id="ERateCondition__1"/>
                      <input type="hidden" name="EORate__1" id="EORate__1"/></td>
                    <td width="5%"><input class="parent_padi05" type="text" name="EMUnit__1" id="EMUnit__1" readonly/>
                      <input type="hidden" name="EMUnitId__1" id="EMUnitId__1"/></td>
                    <td width="5%"><input class="parent_text text-right" type="text" name="EMQty__1" id="EMQty__1" onchange="addNewEMRow(this)" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" maxlength="12"/></td>
                    <td width="6%"><input class="parent_padi05 text-right" type="text" name="EMRate__1" id="EMRate__1" readonly/></td>
                    <td width="5%"><input class="parent_padi05 text-right" type="text" name="EMEscPercent__1" id="EMEscPercent__1" readonly/></td>
                    <td width="10%"><input class="parent_padi05 text-right" type="text" name="EMAdvancePer__1" id="EMAdvancePer__1" readonly/></td>
                    <td width="10%"><input class="parent_padi05 text-right" type="text" name="EMAmount__1" id="EMAmount__1" readonly /></td>
                    <td width="4%" align="center" class="action_btns_td"><ul class="action_btns">
                        <li> <a href="#" class="mainTr"> <i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="top" data-original-title="Add lines" ></i></a> </li>
                        <li> <a href="#" class="EMaterialDeleteTr__1" onclick="deleteEMaterial(this, event);" style="display: none;"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                      </ul></td>
                  </tr>
                  <tr style="display:none;" class="subTr">
                    <td colspan="9" style="padding:0px !important; "><div class="subDiv" style="display:none;">
                        <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"> </div>
                        <div class="col-lg-12">
                          <div class="table-responsive topsp">
                            <table class="table" style="margin-bottom:0px;">
                              <thead>
                                <tr>
                                  <th>Bill Date</th>
                                  <th>Bill No</th>
                                  <th>Vendor Name</th>
                                  <th class="text-right">Qty</th>
                                  <th class="text-right">Rate</th>
                                  <th class="text-right">Amount</th>
                                  <th>&nbsp; </th>
                                </tr>
                              </thead>
                              <tbody class="submain">
                                <tr class="padi05">
                                  <input type="hidden" name="EMBill__1_PBillTransId__9" id="EMBill__1_PBillTransId__9" value="0"/>
                                  <input type="hidden" name="EMBill__1_UpdateMBillRow__9" id="EMBill__1_UpdateMBillRow__9" value="0"/>
                                  <td width="5%"><input class="parent_text date_picker" type="text" name="EMBill__1_PBillDate__9" id="EMBill__1_PBillDate__9" onkeypress="return isDate(event);" onchange="validateDate(this);addNewEMBillRow(this)"/></td>
                                  <td width="5%"><input class="parent_text" type="text" name="EMBill__1_PBillNo__9" id="EMBill__1_PBillNo__9" onchange="addNewEMBillRow(this)"/></td>
                                  <td width="10%"><input class="parent_text VendorNameInputs" type="text" name="EMBill__1_PVendorName__9" id="EMBill__1_PVendorName__9" onchange="addNewEMBillRow(this)"/>
                                    <input type="hidden" class="VendorIdInputs" name="EMBill__1_PVendorId__9" id="EMBill__1_PVendorId__9"/></td>
                                  <td width="5%"><input class="parent_text text-right" type="text" name="EMBill__1_PBillQty__9" id="EMBill__1_PBillQty__9" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" maxlength="12" onchange="addNewEMBillRow(this)"/></td>
                                  <td width="6%"><input class="parent_text text-right" type="text" name="EMBill__1_PBillRate__9" id="EMBill__1_PBillRate__9" onchange="addNewEMBillRow(this)" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)" maxlength="18"/></td>
                                  <td width="5%"><input class="parent_padi05 text-right" type="text" name="EMBill__1_PBillAmount__9" id="EMBill__1_PBillAmount__9" onchange="addNewEMBillRow(this)" readonly/></td>
                                  <td width="2%" align="center" class="action_btns_td"><ul class="action_btns">
                                      <li style="float:left;"> <a href="#" class="pull-left"> <span   class="btn-file butclr_imp"> <i class="fa fa-paperclip dcm_atch"></i>
                                        <input type="file" name="EMBill__1_DocFile__9" id="EMBill__1_DocFile__9">
                                        </span> </a> </li>
                                      <li> <a href="#" class="EMBill__1_DeleteTr__9" onclick="deleteEMaterialBill(this, event);" style="display: none;"> <i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                                    </ul></td>
                                </tr>
                              </tbody>
                              <tbody class="subtotal">
                                <tr class="padi05">
                                  <td width="5%">&nbsp;</td>
                                  <td width="5%">&nbsp;</td>
                                  <td width="10%" class="rate_pri" align="right">Total</td>
                                  <td width="6%"><input class="parent_padi05 text-right" type="text" name="EMBillTotalQty__1" id="EMBillTotalQty__1" readonly/></td>
                                  <td width="6%"><input class="parent_padi05 text-right" type="text" name="EMBillTotalRate__1" id="EMBillTotalRate__1" readonly/></td>
                                  <td width="8%"><input class="parent_padi05 text-right" type="text" name="EMBillTotalAmount__1" id="EMBillTotalAmount__1" readonly/></td>
                                  <td width="1%">&nbsp;</td>
                                </tr>
                              </tbody>
                            </table>
                            <input type="hidden" name="embillrowid__1" id="embillrowid__1" value="1"/>
                          </div>
                        </div>
                      </div></td>
                  </tr>
                  <tr class="total padi05">
                    <td class="nt-am" align="right" width="5%"><span>Purchase Rate</span></td>
                    <td width="8%"><input class="parent_padi05 text-right" type="text" name="EMaterialTotalPurRate__1" id="EMaterialTotalPurRate__1" readonly/></td>
                    <td class="nt-am" align="right" width="3%"><span>Base Rate</span></td>
                    <td width="8%"><input class="parent_padi05 text-right" type="text" name="EMaterialTotalBaseRate__1" id="EMaterialTotalBaseRate__1" readonly/></td>
                    <td class="nt-am" align="right" width="5%"><span>Escalation %</span></td>
                    <td width="8%"><input class="parent_padi05 text-right" type="text" name="EMaterialTotalEscPer__1" id="EMaterialTotalEscPer__1" readonly/></td>
                    <td class="nt-am" align="right" width="5%"><span>Esc. Rate</span></td>
                    <td width="8%"><input class="parent_padi05 text-right" type="text" name="EMaterialTotalActRate__1" id="EMaterialTotalActRate__1" readonly/></td>
                  </tr>
                </tbody>
              </table>
              <input type="hidden" name="priceescalationrowid" id="priceescalationrowid" value="1"/>
              <input type="hidden" name="priceescalationdeleteids" id="priceescalationdeleteids" value="0"/>
              <input type="hidden" name="priceescalationbilldeleteids" id="priceescalationbilldeleteids" value="0"/>
            </div>
          </div>
        </div></td>
    </tr>
  </tbody>
</table>
<!--MobAdvance Recovery-->
<table id="dummy-mobadv-recovery" style="display: none;">
  <tbody>
    <tr style="display:none;" class="subTr">
      <td colspan="9" style="padding:0px !important; "><div class="subDiv" style="display:none;">
          <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"> </div>
          <div class="col-lg-12">
            <div class="table-responsive topsp">
              <table class="table" style="margin-bottom:0px;" id="AbsSubTable-@ROWID">
                <thead>
                  <tr>
                    <th>Ref No.</th>
                    <th>Date</th>
                    <th>Description</th>
                    <th class="text-right">Total Advance</th>
                    <th class="text-right">Recovered</th>
                    <th class="text-right">Balance</th>
                    <th class="text-right">Current</th>
                    <th>&nbsp;</th>
                  </tr>
                </thead>
                <tbody class="main" data-rowid="@ROWID">
                  <tr class="padi05">
                    <input type="hidden" name="mobAdvRecoveryReceiptId__1" id="mobAdvRecoveryReceiptId__1" value="0"/>
                    <input type="hidden" name="mobAdvRecoveryBillFormatId__1" id="mobAdvRecoveryBillFormatId__1" value="0"/>
                    <td width="5%"><input class="parent_padi05" type="text" id="mobAdvRecoveryRef__1" readonly/></td>
                    <td width="7%"><input class="parent_padi05" type="text" id="mobAdvRecoveryDate__1" readonly/></td>
                    <td width="8%"><input class="parent_padi05" type="text" id="mobAdvRecoveryDesc__1" readonly/></td>
                    <td width="5%"><input class="parent_padi05 text-right" type="text" id="mobAdvRecoveryTotalAdvance__1" readonly/></td>
                    <td width="5%"><input class="parent_padi05 text-right" type="text" id="mobAdvRecoveryRecovered__1" readonly/></td>
                    <td width="5%"><input class="parent_padi05 text-right" type="text" id="mobAdvRecoveryBalance__1" readonly/></td>
                    <td width="5%"><input class="parent_text text-right" type="text" name="mobAdvRecoveryCurrent__1" id="mobAdvRecoveryCurrent__1" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)" maxlength="18" onchange="calcMobAdvRecoveryTotal(this)"/></td>
                    <td width="1%" align="center" class="action_btns_td"><ul class="action_btns">
                        <li> <a href="#" class="mobAdvRecoveryDeleteTr__1" onclick="deleteMobAdvRecovery(this, event);" style="display: none;"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                      </ul></td>
                  </tr>
                </tbody>
                <tbody class="total">
                  <tr class="padi05">
                    <td colspan="5"></td>
                    <td align="right" class="rate_pri">Total</td>
                    <td width="5%"><input class="parent_padi05 text-right" type="text" name="mobAdvRecoveryCurrentTotal" id="mobAdvRecoveryCurrentTotal" readonly/></td>
                    <td>&nbsp;</td>
                  </tr>
                </tbody>
              </table>
              <input type="hidden" name="mobadvrecoveryrowid" id="mobadvrecoveryrowid" value="1"/>
            </div>
          </div>
        </div></td>
    </tr>
  </tbody>
</table>
<!--Advance Recovery-->
<table id="dummy-adv-recovery" style="display: none;">
  <tbody>
    <tr style="display:none;" class="subTr">
      <td colspan="9" style="padding:0px !important; "><div class="subDiv" style="display:none;">
          <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"> </div>
          <div class="col-lg-12">
            <div class="table-responsive topsp">
              <table class="table" style="margin-bottom:0px;" id="AbsSubTable-@ROWID">
                <thead>
                  <tr>
                    <th>Ref No.</th>
                    <th>Date</th>
                    <th>Description</th>
                    <th class="text-right">Total Advance</th>
                    <th class="text-right">Recovered</th>
                    <th class="text-right">Balance</th>
                    <th class="text-right">Current</th>
                    <th>&nbsp;</th>
                  </tr>
                </thead>
                <tbody class="main" data-rowid="@ROWID">
                  <tr class="padi05">
                    <input type="hidden" name="AdvRecoveryReceiptId__1" id="AdvRecoveryReceiptId__1" value="0"/>
                    <input type="hidden" name="AdvRecoveryBillFormatId__1" id="AdvRecoveryBillFormatId__1" value="0"/>
                    <td width="5%"><input class="parent_padi05" type="text" id="AdvRecoveryRef__1" readonly/></td>
                    <td width="7%"><input class="parent_padi05" type="text" id="AdvRecoveryDate__1" readonly/></td>
                    <td width="8%"><input class="parent_padi05" type="text" id="AdvRecoveryDesc__1" readonly/></td>
                    <td width="5%"><input class="parent_padi05 text-right" type="text" id="AdvRecoveryTotalAdvance__1" readonly/></td>
                    <td width="5%"><input class="parent_padi05 text-right" type="text" id="AdvRecoveryRecovered__1" readonly/></td>
                    <td width="5%"><input class="parent_padi05 text-right" type="text" id="AdvRecoveryBalance__1" readonly/></td>
                    <td width="5%"><input class="parent_text text-right" type="text" name="AdvRecoveryCurrent__1" id="AdvRecoveryCurrent__1" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)" maxlength="18" onchange="calcAdvRecoveryTotal(this)"/></td>
                    <td width="1%" align="center" class="action_btns_td"><ul class="action_btns">
                        <li> <a href="#" class="AdvRecoveryDeleteTr__1" onclick="deleteAdvRecovery(this, event);" style="display: none;"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                      </ul></td>
                  </tr>
                </tbody>
                <tbody class="total">
                  <tr class="padi05">
                    <td colspan="5"></td>
                    <td align="right" class="rate_pri">Total</td>
                    <td width="5%"><input class="parent_padi05 text-right" type="text" name="AdvRecoveryCurrentTotal" id="AdvRecoveryCurrentTotal" readonly/></td>
                    <td>&nbsp;</td>
                  </tr>
                </tbody>
              </table>
              <input type="hidden" name="advrecoveryrowid" id="advrecoveryrowid" value="1"/>
            </div>
          </div>
        </div></td>
    </tr>
  </tbody>
</table>
<!--Material Recovery-->
<table id="dummy-material-recovery" style="display: none;">
  <tbody>
    <tr style="display:none;" class="subTr">
      <td colspan="9" style="padding:0px !important; "><div class="subDiv" style="display:none;">
          <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"> </div>
          <div class="col-lg-12">
            <div class="table-responsive topsp">
              <table class="table" style="margin-bottom:0px;">
                <thead>
                  <tr>
                    <th>Material Name</th>
                    <th>Unit</th>
                    <th class="text-right">Qty</th>
                    <th class="text-right">Rate</th>
                    <th class="text-right">Amount</th>
                    <th>&nbsp; </th>
                  </tr>
                </thead>
                <tbody class="main" data-rowid="@ROWID">
                  <tr class="padi05">
                    <td width="13%"><input class="parent_text" type="text" name="RMaterialName__1" id="RMaterialName__1" onfocus="checkMaterialRec(this.id);"/>
                      <input type="hidden" name="RMaterialId__1" id="RMaterialId__1"/></td>
                    <td width="5%"><input class="parent_padi05" type="text" name="RMUnit__1" id="RMUnit__1" readonly/>
                      <input type="hidden" name="RMUnitId__1" id="RMUnitId__1"/></td>
                    <td width="5%"><input class="parent_text text-right" type="text" name="RMQty__1" id="RMQty__1" onchange="addNewRMRow(this)" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" maxlength="12"/></td>
                    <td width="6%"><input class="parent_padi05 text-right" type="text" name="RMRate__1" id="RMRate__1" readonly/></td>
                    <td width="5%"><input class="parent_padi05 text-right" type="text" name="RMAmount__1" id="RMAmount__1" readonly/></td>
                    <td width="4%" align="center" class="action_btns_td"><ul class="action_btns">
                        <li> <a href="#" class="RMaterialDeleteTr__1" onclick="deleteRMaterial(this, event);" style="display: none;"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                      </ul></td>
                  </tr>
                </tbody>
                <tbody class="total">
                  <tr class="padi05">
                    <td colspan="3"></td>
                    <td align="right" class="rate_pri">Total</td>
                    <td width="5%"><input class="parent_padi05 text-right" type="text" name="RMAmountTotal" id="RMAmountTotal" readonly/></td>
                    <td>&nbsp;</td>
                  </tr>
                </tbody>
              </table>
              <input type="hidden" name="mrecoveryrowid" id="mrecoveryrowid" value="1"/>
            </div>
          </div>
        </div></td>
    </tr>
  </tbody>
</table>
<!--Free Supply Material-->
<table id="dummy-free-supply-material" style="display: none;">
  <tbody>
    <tr style="display:none;" class="subTr">
      <td colspan="9" style="padding:0px !important; "><div class="subDiv" style="display:none;">
          <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"> </div>
          <div class="col-lg-12">
            <div class="table-responsive topsp">
              <table class="table" style="margin-bottom:0px;">
                <thead>
                  <tr>
                    <th>Material Name</th>
                    <th>Unit</th>
                    <th class="text-right">Qty</th>
                    <th class="text-right">Rate</th>
                    <th class="text-right">Amount</th>
                    <th>&nbsp; </th>
                  </tr>
                </thead>
                <tbody class="main" data-rowid="@ROWID">
                  <tr class="padi05">
                    <td width="13%"><input class="parent_text" type="text" name="FSMaterialName__1" id="FSMaterialName__1" onfocus="checkFSMaterial(this.id)"/>
                      <input type="hidden" name="FSMaterialId__1" id="FSMaterialId__1"/></td>
                    <td width="5%"><input class="parent_padi05" type="text" name="FSMUnit__1" id="FSMUnit__1" readonly/>
                      <input type="hidden" name="FSMUnitId__1" id="FSMUnitId__1"/></td>
                    <td width="5%"><input class="parent_text text-right" type="text" name="FSMQty__1" id="FSMQty__1" onchange="addNewFSMRow(this)" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" maxlength="12"/></td>
                    <td width="6%"><input class="parent_padi05 text-right" type="text" name="FSMRate__1" id="FSMRate__1" readonly/></td>
                    <td width="5%"><input class="parent_padi05 text-right" type="text" name="FSMAmount__1" id="FSMAmount__1" readonly/></td>
                    <td width="4%" align="center" class="action_btns_td"><ul class="action_btns">
                        <li> <a href="#" class="FSMaterialDeleteTr__1" onclick="deleteFSMaterial(this, event);" style="display: none;"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                      </ul></td>
                  </tr>
                </tbody>
                <tbody class="total">
                  <tr class="padi05">
                    <td colspan="3"></td>
                    <td align="right" class="rate_pri">Total</td>
                    <td width="5%"><input class="parent_padi05 text-right" type="text" name="FSMAmountTotal" id="FSMAmountTotal" readonly/></td>
                    <td>&nbsp;</td>
                  </tr>
                </tbody>
              </table>
              <input type="hidden" name="fsmaterialrowid" id="fsmaterialrowid" value="1"/>
            </div>
          </div>
        </div></td>
    </tr>
  </tbody>
</table>
<!--Bills Deductions -->
<table id="dummy-bill-deduction" style="display: none;">
  <tbody>
    <tr style="display:none;" class="subTr">
      <td colspan="9" style="padding:0px !important; "><div class="subDiv" style="display:none;">
          <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"> </div>
          <div class="col-lg-12">
            <div class="table-responsive topsp">
              <table class="table" style="margin-bottom:0px;">
                <thead>
                  <tr>
                    <th>Bill Date</th>
                    <th>Bill No.</th>
                    <th>Vendor Name</th>
                    <th class="text-right">Amount</th>
                    <th>&nbsp; </th>
                  </tr>
                </thead>
                <tbody class="main" data-rowid="@ROWID">
                  <tr>
                    <input type="hidden" name="DBillTransId__1" id="DBillTransId__1" value="0"/>
                    <input type="hidden" name="UpdateDBillRow__1" id="UpdateDBillRow__1" value="0"/>
                    <td width="3%"><input class="parent_text date_picker" type="text" name="DBillDate__1" id="DBillDate__1" onkeypress="return isDate(event);" onchange="validateDate(this);addNewBillDeductionRow(this)"/></td>
                    <td width="3%"><input class="parent_text" type="text" name="DBillNo__1" id="DBillNo__1" onchange="addNewBillDeductionRow(this)"/></td>
                    <td width="8%"><input class="parent_text VendorNameInputs" type="text" name="DVendorName__1" id="DVendorName__1"/>
                      <input type="hidden" class="VendorIdInputs" name="DVendorId__1" id="DVendorId__1"/></td>
                    <td width="4%"><input class="parent_text text-right" type="text" name="DAmount__1" id="DAmount__1" onchange="addNewBillDeductionRow(this)" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)" maxlength="18"/></td>
                    <td width="3%" align="center" class="action_btns_td"><ul class="action_btns">
                        <li style="float:left;">
                            <a href="#"  class="pull-left"> <span class="btn-file butclr_imp"> <i class="fa fa-paperclip dcm_atch"></i>
                          <input type="file" name="DDocFile__1" id="DDocFile__1"  onchange="addNewBillDeductionRow(this);">
                          </span> </a>
                        </li>
                        <li><a href="#" class="BillDeductionDeleteTr__1" onclick="deleteBillDeduction(this, event);" style="display: none;"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                      </ul></td>
                  </tr>
                </tbody>
                <tbody class="total">
                  <tr class="padi05">
                    <td colspan="2"></td>
                    <td align="right" class="rate_pri">Total</td>
                    <td width="5%"><input class="parent_padi05 text-right" type="text" name="DAmountTotal" id="DAmountTotal" readonly/></td>
                    <td>&nbsp;</td>
                  </tr>
                </tbody>
              </table>
              <input type="hidden" name="billdeductionrowid" id="billdeductionrowid" value="1"/>
            </div>
          </div>
        </div></td>
    </tr>
  </tbody>
</table>
<!--Excel Modal-->
<div id="excelmodal" class="modal fade" role="dialog" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog modal-lg" style="width: 75%">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><i class="fa fa-times-circle-o clpot"></i></button>
        <h1>Resource Group Import Sheet</h1>
      </div>
      <div class="clearfix"></div>
      <div class="modal-body">
        <div class="table-responsive topsp" style="overflow:visible;animation-delay: 0.2s;">
          <table class="table" style=" margin-bottom:0px;" id="excelTable">
            <thead>
              <tr>
                <th class="th-modal">Specification</th>
                <th class="th-modal">Unit</th>
                <th class="th-modal text-right">Qty</th>
                <th class="th-modal text-right">Rate</th>
                <th class="th-modal text-right" >Amount</th>
                <th class="th-modal"></th>
              </tr>
            </thead>
            <tbody >
              <tr id="excelrowid_1" class="padi05">
                <td width="10%"><input type="text" class="parent_padi05" id="excelspec_1" onfocus="checkExcelBoqSpec(this.id);"/>
                  <input type="hidden" id="excelwoboqid_1"/></td>
                <td width="5%"><input type="text" class="parent_padi05" id="excelunit_1" readonly/>
                  <input type="hidden" id="excelunitid_1"/></td>
                <td width="3%"><input class="parent_padi05 text-right" type="text" id="excelqty_1" readonly/></td>
                <td width="4%"><input class="parent_padi05 text-right" type="text" id="excelrate_1" readonly/></td>
                <td width="4%"><input class="parent_padi05 text-right" type="text" id="excelamt_1" readonly/></td>
                <td width="1%" align="center"><ul class="action_btns">
                    <li> <a href="#" class="excelboqdelete" onclick="exceldeleteboqTr(this, event);"> <i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete" ></i> </a> </li>
                  </ul></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer"> <a href="#" class="md_cance" data-dismiss="modal" style="position: relative; overflow: hidden;">Cancel<span class="ripple-wrapper"></span><span class="ripple-wrapper"></span></a>
        <button type="button" class="md_ok" onclick="return BOQUpdate()">Apply</button>
      </div>
    </div>
  </div>
</div>
<!--Formula Modal-->
<div id="FormulaModal" class="modal fade" role="dialog" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><i class="fa fa-times-circle-o clpot"></i></button>
        <h1>Formula</h1>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Formula Expression</label>
          <input type="text" class="parent_text" name="FormulaExpression" id="FormulaExpression" onchange="return FormulaCalc()" >
        </div>
        <div class="form-group">
          <input type="text" class="parent_text text-right" name="FormulaVal" id="FormulaVal" readonly >
        </div>
      </div>
      <div class="modal-footer">
        <?php if(($billinfo['TransType'] == 'S' && $billinfo['IsSubmittedBill'] != '1') || ($billinfo['TransType'] == 'C' && $billinfo['IsCertifiedBill'] != '1')):?>
            <button type="button" id="btnRemoveFormula" class="md_cance" onclick="return RemoveFormula()" data-dismiss="modal" data-toggle="tooltip" data-original-title="Remove Formula">Remove Formula</button>
            <button type="button" class="md_ok" onclick="return ApplyFormula();" data-toggle="tooltip" data-original-title="Apply">Apply</button>
        <?php endif; ?>
      </div>
    </div>
  </div>
</div>
<!--Non AgtItem Modal-->
<div id="nonagtmodal" class="modal fade" role="dialog" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><i class="fa fa-times-circle-o clpot"></i></button>
        <h1 id="nonagtmodalheader">Create Non-Agreement Item</h1>
      </div>
      <div class="modal-body">
        <input type="hidden" name="nonagtrowid" id="nonagtrowid">
        <div class="col-lg-12">
          <div class="form-group">
            <label style="margin-bottom: 10px;">Sl No.</label>
            <input type="text" class="parent_text tex-po" name="nonSlNo" id="nonSlNo">
          </div>
          <div class="form-group">
            <label style="margin-bottom: 10px;">Specification</label>
            <input type="text" class="parent_text tex-po" name="nonSpec" id="nonSpec" onchange="checkNonAgtSpecName(this)">
          </div>
<!--          <div class="form-group">-->
<!--            <input type="text" name="nonworkgroupName" id="nonworkgroupName" class="form-control lbl_move" label="Work Group"/>-->
<!--            <input type="hidden" name="nonworkgroupId" id="nonworkgroupId"  class="form-control" />-->
<!--          </div>-->
          <div class="form-group">
            <input type="text" name="nonunitName" id="nonunitName" class="form-control lbl_move" label="Unit"/>
            <input type="hidden" name="nonunitId" id="nonunitId"  class="form-control" />
          </div>
          <div class="form-group">
            <label style="margin-bottom: 10px;">Rate</label>
            <input type="text" class="parent_text tex-po" name="nonRate" id="nonRate" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 2, true)">
          </div>
        </div>
      </div>
      <div class="modal-footer clear">
        <div class="col-lg-12"> <a href="#" class="md_cance" data-dismiss="modal" style="position: relative; overflow: hidden;">Cancel<span class="ripple-wrapper"></span><span class="ripple-wrapper"></span></a>
          <button type="button" id="btn-nonagt" class="md_ok" onclick="return NonAgtItmUpdate()">Create</button>
        </div>
      </div>
    </div>
  </div>
</div>
<script type="text/javascript">
// UI Script
$('.responsive-tabs').responsiveTabs({
    accordionOn: ['xs', 'sm']
});

var isBillEditable = <?php echo (($billinfo['TransType'] == 'S' && $billinfo['IsSubmittedBill'] == '1') || ($billinfo['TransType'] == 'C' && $billinfo['IsCertifiedBill'] == '1')) ? 'false' : 'true';?>;

var arr_vendors = <?php echo (isset($vendors)) ? json_encode($vendors) : '[]';?>;
var arr_units = <?php echo (isset($units)) ? json_encode($units) : '[]';?>;

var boqAutoCompleteData = [],
    tmpboqAutoCompleteData = [],
    boqAutoNonBOQData = [],
    tmpboqAutoNonBOQData = [],
    MAdvAutoCompleteData = [],
    tmpMAdvAutoCompleteData = [],
    MRecAutoCompleteData = [],
    tmpMRecAutoCompleteData = [],
    FSMaterialAutoCompleteData = [],
    tmpFSMaterialAutoCompleteData = [],
    PriceEscMaterialAutoCompleteData = [],
    tmpPriceEscMaterialAutoCompleteData = [],
    workgrouplist = null;

var $nonagtmodal = $("#nonagtmodal"),
    $nonagtrowid = $('#nonagtrowid'),
    $nonSlNo = $('#nonSlNo'),
    $nonSpec = $('#nonSpec'),
    $nonunitName = $('#nonunitName'),
    $nonunitId = $('#nonunitId'),
    $nonRate = $('#nonRate'),
    $btnnonagt = $("#btn-nonagt"),
    $nonagtmodalheader = $('#nonagtmodalheader'),
    $newnonagtwrapper = $('#newnonagtwrapper');

var $confirmToolTipTemplate = '<div class="on-focus clearfix" style="position:relative;" id="FormulaConfirmationToolTip">'
            + '<div class="top-tip">'
            + '<span>Do You Need Formula?</span>'
            + '<a href="#" onclick="setFormula(); return false;" class="colgreen"><i class="fa fa-check"></i> Yes</a>'
            + '<a href="#" onclick="removeTooltip(); return false;" class="colred"><i class="fa fa-times"></i> No</a>'
            + '</div>'
        +'</div>';
var $mSheetConfirmToolTipTemplate = '<div class="on-focus clearfix" style="position:relative;" id="MSheetConfirmationToolTip">'
    + '<div class="top-tip">'
    + '<span>Do You Need Measurement Sheet?</span>'
    + '<a href="#" onclick="setMSheet(); return false;" class="colgreen"><i class="fa fa-check"></i> Yes</a>'
    + '<a href="#" onclick="removeTooltip(); return false;" class="colred"><i class="fa fa-times"></i> No</a>'
    + '</div>'
    +'</div>';
var $HandsonWrapper = $('#HandsonWrapper'),
    $formWrapper = $('#formWrapper');

$(function () {
    // bind boq fns
    boqAutoCompleteData = <?php echo (isset($boq_lists)) ? json_encode($boq_lists) : '[]';?>;
    tmpboqAutoCompleteData = <?php echo (isset($boq_lists)) ? json_encode($boq_lists) : '[]';?>;
    boqAutoNonBOQData = <?php echo (isset($nonboq_lists)) ? json_encode($nonboq_lists) : '[]';?>;
    tmpboqAutoNonBOQData = <?php echo (isset($nonboq_lists)) ? json_encode($nonboq_lists) : '[]';?>;
    MAdvAutoCompleteData = <?php echo (isset($materialadv_lists)) ? json_encode($materialadv_lists) : '[]';?>;
    tmpMAdvAutoCompleteData = <?php echo (isset($materialadv_lists)) ? json_encode($materialadv_lists) : '[]';?>;
    MRecAutoCompleteData = <?php echo (isset($recoverymaterial_lists)) ? json_encode($recoverymaterial_lists) : '[]';?>;
    FSMaterialAutoCompleteData = <?php echo (isset($freesupplymaterial_lists)) ? json_encode($freesupplymaterial_lists) : '[]';?>;
    tmpFSMaterialAutoCompleteData = <?php echo (isset($freesupplymaterial_lists)) ? json_encode($freesupplymaterial_lists) : '[]';?>;
    PriceEscMaterialAutoCompleteData = <?php echo (isset($priceescmaterial_lists)) ? json_encode($priceescmaterial_lists) : '[]';?>;
    tmpPriceEscMaterialAutoCompleteData = <?php echo (isset($priceescmaterial_lists)) ? json_encode($priceescmaterial_lists) : '[]';?>;
    workgrouplist = <?php echo (isset($workgroup_lists)) ? json_encode($workgroup_lists) : '[]';?>;

    bindBOQAutoComplete();
    bindNonBOQAutoComplete();
    bindMaterialAdvAutoComplete();
    bindMAdvVendorAutoComplete();
    bindDatePicker();
    bindMaterialRecAutoComplete();
    bindPriceEscAutoComplete();
    bindPriceEscVendorAutoComplete();
    bindVendorAutoComplete();
    bindNAUnitAutoComplete();
//    bindNAWorkGroupAutoComplete();
    bindFSMaterialAutoComplete();
    calculateFormula();

    // calcBillAbstract();
    // calcBOQTotal();
    // calcBillDeducTotal();
    // calcMaterialRecTotal();
    // calcFSMaterialTotal();
    // calcPriceEscBillTotal();
    // calcPriceEscTotal();
    // calcMaterialAdvTotal();
    // calcMAdvTotal();

    bindDocAttached();

    // prompt dialog on page navigation
    initPageChangeFn();

    bindExpandTrFn();

    // readonly css
    $.each($('input[id^=CurAmount_]'),function() {
        var $this = $(this);
        if(!$this.is('[readonly]'))
            $(this).removeClass('parent_padi05').addClass('parent_text');
    });

    // selectpicker initialize
    $(".single_dropdown").select2({
        placeholder: ""
    });
    $('#totalcolumns').select2({
        maximumSelectionLength: 4,
        placeholder: ""
    });

    // disable all inputs and remove style
    if(!isBillEditable) {
        $('input:not(.date_picker):not([type=checkbox]):not([type=radio]):not([type=hidden]),textarea').prop('readonly', true).addClass('red-non');
        $('.parent_padi05').removeClass('parent_padi05').addClass('parent_text');
        $('.fa-trash-o,.fa-paperclip').parents('a').css('display', 'none');
        $('.fa-chain-broken').css('display', 'none');
        $('.date_picker,input[type=checkbox], input[type=radio]').prop('disabled', true).addClass('red-non');
        $('#remarks').removeClass('red-non');
        $('#date').removeClass('red-non').prop('readonly', true);
    }

    $('#isSubCer').on('change', function() {
        if($(this).is(':checked')) {
            $('#date').prop('disabled', false);
            $('#remarks').prop('disabled', false);
        } else {
            $('#date').prop('disabled', true);
            $('#remarks').prop('disabled', true);
        }
    }).trigger('change');
});

function bindDocAttached() {
    var $docFiles = $('input[id*=DocFile_]');
    $docFiles.unbind('change');
    $docFiles.on('change', function() {
        var $this = $(this);
        var $tarEl = $this.siblings('i');
        var $tooltip = $tarEl.parent('span');
        var $tarA = $tarEl.closest('a');
        if($this.val() != '') {
            $tarEl.removeClass('fa-paperclip').addClass('fa-file-o');
            $tooltip.attr('data-original-title', 'Document Attached');

            if($tarA.next('i.brkn').length == 0)
                $('<i class="fa fa-chain-broken brkn" onclick="removeAttachment($(this));"></i>').insertAfter($tarA);
        } else {
            $tarA.next('i.brkn').remove();
            $tarEl.addClass('fa-paperclip').removeClass('fa-file-o');
            $tooltip.attr('data-original-title', 'Click to attach documents');
        }
    });
}

function submitForm() {
    // validate date and remarks
    if($('#isSubCer').is(':checked')) {
        var $date = $('#date');
        if($.trim($date.val()).length == 0) {
            showError($date, "Required");
            return false;
        } else {
            removeError($date);
        }

        // validate certification date
        if($('#BillType').val() == 'C') {
            var submittedDate = $('#SubmittedDate').val();
            if(!checkDateRange(submittedDate, $date.val())) {
                showError($date, 'To date should be greater than Submitted Date ('+submittedDate+')');
                return false;
            } else
                removeError($date);
        }

        var $remarks = $('#remarks');
        if($.trim($remarks.val()).length == 0) {
            showError($remarks, "Required");
            return false;
        } else {
            removeError($remarks);
        }
    }

    // check for error(s)
    var $err_inputs = $('.error');
    if($err_inputs.length != 0) {
        alert('Kindly notice the errors');
        $.each($err_inputs, function () {
            var $this = $(this),
                $subTr = $this.closest('.subTr'),
                $subDivTr = $subTr.closest('.subDiv').parents('.subTr');
            
            if(!$subTr.is(':visible')) {
                $subTr.prev('tr').find('.mainTr').trigger('click');
            }

            // SubDivs Parent
            if($subDivTr.length != 0 && !$subDivTr.is(':visible')) {
                $subDivTr.prev('tr').find('.mainTr').trigger('click');
            }
        });
        return false;
    }

    setPageChanges(false);
    $('#formWrapper').submit();
}

function addAdvRecoveryRow(id) {
    var $tbody = $('#AbsSubTable-'+id +' tbody.main'),
        template = $('#dummy-adv-recovery tbody table tbody.main').html(),
        $advrowid = $('#advrecoveryrowid'),
        rowid = parseInt($advrowid.val());

    $('.AdvRecoveryDeleteTr_' + rowid).show();
    var count = rowid + 1;

    $tbody.append(template.replace(/__1/g, '_' + count));
    $advrowid.val(count);
}

function addMobAdvRecoveryRow(id) {
    var $tbody = $('#AbsSubTable-'+id +' tbody.main'),
        template = $('#dummy-mobadv-recovery tbody table tbody.main').html(),
        $advrowid = $('#mobadvrecoveryrowid'),
        rowid = parseInt($advrowid.val());

    $('.mobAdvRecoveryDeleteTr_' + rowid).show();
    var count = rowid + 1;

    $tbody.append(template.replace(/__1/g, '_' + count));
    $advrowid.val(count);
}

function bindDatePicker() {
    $('.date_picker').datepicker({
        'format': 'dd-mm-yyyy'
    }).on('changeDate', function() {
        $('.datepicker').hide();
    }).data('datepicker');
}

// Bill Deduction fns
function bindVendorAutoComplete() {
    var $vendorName = $('input[id^=DVendorName_]');
    $.each($vendorName, function () {
        var $this = $(this),
            name = $this[0].id;
        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1) return;
        var arrname = name.split('_');
        var key1 = arrname[1];
        $this.unbind('autocomplete');
        $this.autocomplete({
            lookup: arr_vendors,
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            }, onSelect: function(suggestion) {
                if(suggestion) {
                    $("#DVendorId_" + key1).val(suggestion.data);
                    removeError($(this));

                    $(this).prop('disabled', true);
                    addNewBillDeductionRow($(this));
                }
            }, onSearchStart: function(suggestion) {
                $("#DVendorId_" + key1).val(0);
            }, onSearchComplete: function (query, suggestions) {
                if(!suggestions.length && query.length > 1){
                    showError($(this), 'Required');
                    $("#DVendorId_" + key1).val(0);
                } else
                    removeError($(this));
            }
        });
    });
}
function calcBillDeducTotal() {
    var $amt = $('input[id^=DAmount_]'),
        gTotal = 0;
    $.each($amt, function () {
        var $this = $(this),
            name = $this[0].id;
        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1) return;
        gTotal += parseFloatVal($this.val());

        $('#CurAmount_' + $this.parents('tbody.main').data('rowid')).val(sanitizeNumber(gTotal,2,true,true));
        //var cumamt = parseFloatVal($('#CumAmount_' + $this.parents('tbody.main').data('rowid')).val());
        //$('#PrevAmount_' + $this.parents('tbody.main').data('rowid')).val(sanitizeNumber(cumamt - gTotal));
		var prevamt = parseFloatVal($('#PrevAmount_' + $this.parents('tbody.main').data('rowid')).val());
        $('#CumAmount_' + $this.parents('tbody.main').data('rowid')).val(sanitizeNumber((prevamt + gTotal),2,true,true));
    });
    $('#DAmountTotal').val(sanitizeNumber(gTotal));

}

function addNewBillDeductionRow(x,updateFlag) {
    calcBillDeducTotal();

    var $x = $(x),
        $tr = $x.closest('tr'),
        key = $x[0].id.split('_')[1];

    if(typeof updateFlag != 'undefined' && updateFlag) {
        $('#UpdateDBillRow_' + key).val(1);
    }

    if ($tr.next('tr').length != 0)
        return;

    if ($('#DBillDate_' + key).val().length == 0 || $('#DBillDate_' + key).hasClass('error') || $('#DBillNo_' + key).val().length == 0 || $('#DVendorName_' + key).val().length == 0
        || $('#DVendorId_' + key).val().length == 0 || $('#DVendorId_' + key).val() == 0 || $('#DAmount_' + key).val().length == 0)
        return;

    var $rowid = $('#billdeductionrowid'),
        rowid = parseInt($rowid.val());
    $('.BillDeductionDeleteTr_' + rowid).show();
    var count = rowid + 1,
        template = $('#dummy-bill-deduction tbody table tbody.main').html();

    template = template.replace(/__1/g, '_' + count);
    $tr.parent('tbody.main').append(template);
    $rowid.val(count);
    bindVendorAutoComplete();
    bindDatePicker();
}

function deleteBillDeduction(x,e, deleteFlag) {
    e.preventDefault();
    if (!confirm('Do you want to Delete'))
        return false;

    var $x = $(x),
        $tr = $x.closest('tr'),
        key = $x[0].className.split('_')[1],
        $tbody = $tr.parent('tbody');

    if ($tbody.find('> tr').length == 1) {
        var template = $('#dummy-bill-deduction tbody table tbody.main').html();
        template = template.replace(/__1/g, '_' + 1);
        $tbody.append(template);
        $('#billdeductionrowid').val(1);
    }

    if(typeof deleteFlag != 'undefined' && deleteFlag) {
        var $ids = $('#billdeductiondeleteids');
        $ids.val($ids.val() + ',' + $('#DBillTransId_'+key).val());
    }

    $tr.remove();
    setPageChanges(true);

    calcBillDeducTotal();
    bindVendorAutoComplete();
    return false;
}

function removeAttachment($tarEl, updateFlag) {

    if (!confirm('Do you want to Remove')) {
        return false;
    }

    var $tarLi = $tarEl.closest('li'),
        $tarA = $tarLi.find('a'),
        $tarI = $tarA.find('i.fa-file-o'),
        $tarIp = $tarLi.find('input[type="hidden"]');

    if(typeof updateFlag != 'undefined' && updateFlag) {
        $tarLi.parents('tr').find('> input[type=hidden][name*=Update]').val(1);
    }

    $tarIp.attr('type', 'file').removeAttr('value');
    $tarA.attr('href', '#').removeAttr('download').removeAttr('target');
    $tarI.addClass('fa-paperclip dcm_atch').removeClass('fa-file-o');
    $tarA.html('<span class="btn-file butclr_imp">' + $tarA.html() + '</span>');
    bindDocAttached();

    $tarEl.remove();
}

// BOQ Fns
function bindBOQAutoComplete() {
    var $boqSpec = $('input[id^=Spec_]');
    $.each($boqSpec, function () {
        var $this = $(this),
            name = $this[0].id;
        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1) return;
        var arrname = name.split('_');
        var key1 = arrname[1];
        checkBoqSpec(name);
        $this.unbind('autocomplete');
        $this.autocomplete({
            lookup: tmpboqAutoCompleteData,
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            }, onSelect: function(suggestion) {
                if(suggestion) {
                    $("#WOBOQId_" + key1).val(suggestion.data);
                    $('#Unit_' + key1).val(suggestion.UnitName);
                    $('#UnitId_' + key1).val(suggestion.UnitId);
                    $('#Rate_' + key1).val(sanitizeNumber(suggestion.Rate,2,true,true));

                    // display qty
                    $('#AgtTotalQty_' + key1).html(sanitizeNumber(suggestion.TotalQty));
                    $('#AgtPrevQty_' + key1).html(0);
                    $('#AgtBalQty_' + key1).html(sanitizeNumber(suggestion.TotalQty));

                    removeError($(this));

                    var $this = $(this);
                    $this.before('<textarea class="parent_texts" name="'+$this[0].name+'" id="'+$this[0].id+'" readonly>'+$this.val()+'</textarea>');
                    $this.remove();
                    addNewBOQRow($this);
                }
            }, onSearchStart: function(suggestion) {
                $("#WOBOQId_" + key1).val(0);
                removeError($(this));
            }, onSearchComplete: function (query, suggestions) {
                if(!suggestions.length && query.length > 1){
                    showError($(this), 'Required');
                    $("#WOBOQId_" + key1).val(0);
                } else
                    removeError($(this));
            }
        });
    });
}
function checkBoqSpec(x) {
    var arrname = x.split('_'),
        id= arrname[1],
        woboqid = $('input[id^=WOBOQId_]');
    tmpboqAutoCompleteData = boqAutoCompleteData;
    tmpboqAutoCompleteData = $.grep(boqAutoCompleteData, function (element, index) {
        var is_selected = true;
        $.each(woboqid, function (i, obj) {
            var $this = $(this),
                key = $this[0].id.split('_')[1];
            if (key != id) {
                if (element.data == $this.val()) {
                    is_selected = false;
                }
            }
        });
        return is_selected;
    });
}
function bindNonBOQAutoComplete() {
    var $boqSpec = $('input[id^=NASpec_]');
    $.each($boqSpec, function () {
        var $this = $(this),
            name = $this[0].id;
        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1) return;
        var arrname = name.split('_');
        var key1 = arrname[1];
        checkNonAgtBoqSpec(name);
        $this.unbind('autocomplete');
        $this.autocomplete({
            lookup: tmpboqAutoNonBOQData,
            showNoSuggestionNotice:true,
            noSuggestionNotice: 'Do you want to Create New <input type="button" style="font-weight:bold" class="btn btn-link" id="matadvnew_' + key1+'" value="Item" onclick="return AddNewAgtItem(this.id)">',
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            }, onSelect: function(suggestion) {
                if(suggestion) {
                    $("#NABOQId_" + key1).val(suggestion.data);
                    $('#NAUnit_' + key1).val(suggestion.UnitName);
                    $('#NAUnitId_' + key1).val(suggestion.UnitId);
                    $('#NARate_' + key1).val(suggestion.Rate);
                    removeError($(this));

                    var $this = $(this);
                    $this.before('<textarea class="parent_texts parent_padi05" name="'+$this[0].name+'" id="'+$this[0].id+'" readonly>'+$this.val()+'</textarea>');
                    $this.remove();
                    addNewNABOQRow($(this));
                }
            }, onSearchStart: function(suggestion) {
                $("#NABOQId_" + key1).val(0);
            }, onSearchComplete: function (query, suggestions) {
                if(!suggestions.length && query.length > 1){
                    showError($(this), 'Required');
                    $("#NABOQId_" + key1).val(0);
                } else
                    removeError($(this));
            }
        });
    });
}
function checkNonAgtBoqSpec(x) {
    var arrname = x.split('_'),
        id= arrname[1],
        woboqid = $('input[id^=NABOQId_]');
    tmpboqAutoNonBOQData = boqAutoNonBOQData;
    tmpboqAutoNonBOQData = $.grep(boqAutoNonBOQData, function (element, index) {
        var is_selected = true;
        $.each(woboqid, function (i, obj) {
            var $this = $(this),
                key = $this[0].id.split('_')[1];
            if (key != id) {
                if (element.data == $this.val()) {
                    is_selected = false;
                }
            }
        });
        return is_selected;
    });
}
function AddNewAgtItem(x) {
    var key = x.split('_')[1];
    $nonagtmodalheader.html('Create Non-Agreement Item');
    $btnnonagt.html('Create');

    $nonagtmodal.find('input').val(''); // reset modal inputs
    $nonSpec.val($('#NASpec_'+ key).val()).trigger('change');
    $('.autocomplete-suggestions').hide();
    $nonagtmodal.data('mode','add').data('id',key).modal('show');
}

function NonAgtItmUpdate() {
    var Spec = $nonSpec.val(),
        SlNo = $nonSlNo.val(),
        unitName = $nonunitName.val(),
        unitId = $nonunitId.val(),
        rate = $nonRate.val();

    if($nonSpec.hasClass('error')) // if already exitst
        return false;

    if(SlNo.length == 0)  {
        showError($nonSlNo, 'SlNo is Required!');
        return false;
    } else
        removeError($nonSlNo);

    if(Spec.length == 0) {
        showError($nonSpec, 'Specification is Required!');
        return false;
    } else
        removeError($nonSpec);

    if(unitName.length == 0 || unitId.length == 0 || unitId == 0) {
        showError($nonunitName, 'Unit is Required!');
        return false;
    } else
        removeError($nonunitName);

    if(rate.length == 0) {
        showError($nonRate, 'Rate is Required!');
        return false;
    } else
        removeError($nonRate);

    // add new non agt to array and form
    var $newnonagtrowid = $('#newnonagtrowid'),
        rowid = parseFloatVal($newnonagtrowid.val()),
        nonAgtId = '';

    if($nonagtmodal.data('mode') == 'add') {
        rowid += 1;
        $('#newnonagt').find('tbody').append($('#dummy-new-nonagt tbody').html().replace(/__1/g, '_' + rowid));
        $newnonagtrowid.val(rowid);
        nonAgtId = 'New' + rowid;
        boqAutoNonBOQData.push({
            data: nonAgtId,
            value: SlNo + ' ' + Spec,
            UnitName: unitName,
            UnitId: unitId,
            Rate: rate
        });
        $newnonagtwrapper.find('.badge').html(rowid);

        $('#NASpec_' + $nonagtmodal.data('id')).val(SlNo + ' ' + Spec);
    } else {
        var oldSpecName = $('#newnonagtslspec_' + $nonagtmodal.data('id')).val(),
            index = getJsonArrayIndex(boqAutoNonBOQData, 'value', oldSpecName);

        if(index != -1) {
            boqAutoNonBOQData[index].value = SlNo + ' ' + Spec;
            boqAutoNonBOQData[index].UnitName = unitName;
            boqAutoNonBOQData[index].UnitId = unitId;
            boqAutoNonBOQData[index].Rate = rate;

            nonAgtId = boqAutoNonBOQData[index].data;
            updateNonAgtInputs(nonAgtId, boqAutoNonBOQData[index]);
        }
        rowid = $nonagtmodal.data('id');
    }

    $('#newnonagtslspec_'+ rowid).val(SlNo + ' ' + Spec);
    $('#newnonagtslno_'+ rowid).val(SlNo);
    $('#newnonagtspec_'+ rowid).val(Spec);
    $('#newnonagtid_'+ rowid).val(nonAgtId);
//    $('#newnonagtwg_'+ rowid).val($nonworkgroupName.val());
//    $('#newnonagtwgid_'+ rowid).val($nonworkgroupId.val());
    $('#newnonagtunitname_'+ rowid).val(unitName);
    $('#newnonagtunitid_'+ rowid).val(unitId);
    $('#newnonagtrate_'+ rowid).val(rate);

    bindNonBOQAutoComplete();
    $('#NASpec_' + $nonagtmodal.data('id')).triggerHandler('focus');

    $newnonagtwrapper.show();
    $nonagtmodal.modal('hide');
}

function EditNonAgtItem(id) {
    var rowid = id.split('_')[1];

    $nonagtmodalheader.html('Edit Non-Agreement Item');
    $btnnonagt.html('Update');
    $nonagtmodal.find('input').val(''); // reset modal inputs

    $nonagtrowid.val(rowid);
    $nonSlNo.val($('#newnonagtslno_'+ rowid).val());
    $nonSpec.val($('#newnonagtspec_'+ rowid).val());
//    $nonworkgroupName.val($('#newnonagtwg_'+ rowid).val());
//    $nonworkgroupId.val($('#newnonagtwgid_'+ rowid).val());
    $nonunitName.val($('#newnonagtunitname_'+ rowid).val());
    $nonunitId.val($('#newnonagtunitid_'+ rowid).val());
    $nonRate.val($('#newnonagtrate_'+ rowid).val());

    $nonagtmodal.data('mode','edit').data('id',rowid).modal('show');
}
function ShowNonAgtItem() {
    var $newnonagt = $('#newnonagt');
    if ($newnonagt.is(":hidden"))
        $newnonagt.show();
    else
        $newnonagt.hide();

    return false;
}
function updateNonAgtInputs(id, obj) {
    $.each($('.NABOQIdInputs[value="'+id+'"]'),function () {
        var key = $(this)[0].id.split('_')[1];
        $('#NASpec_' + key).val(obj.value);
        $('#NABOQId_' + key).val(obj.data);
        $('#NAUnit_' + key).val(obj.UnitName);
        $('#NAUnitId_' + key).val(obj.UnitId);
        $('#NARate_' + key).val(obj.Rate);
        $('#NAQty_' + key).trigger('change');
    });
}
function checkNonAgtSpecName(x){
    var $x = $(x),
        key = $x[0].id.split('_')[1],
        spec = $x.val();

    if(spec == '')
        return;

    removeError($x);

    $.ajax({
        url:getBaseURL()+ 'clientbilling/index/checknonagtitem',
        type:"post",
        data: {'Spec': spec},
        async: false,
        success:function(data, textStatus, jqXHR){
            if(data == 'Y')
                showError($x, 'Specification Already Exists!');
        }, error:function(jqXHR, textStatus, errorThrown){
            showError($x, 'Specification Already Exists!');
            return false;
        }
    });
}
function calcBOQTotal() {
    var $boqQty = $('input[id^=Qty_]'),
        gTotal = 0;
    $.each($boqQty, function () {
        var $this = $(this),
            name = $this[0].id;
        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1) return;
        var key1 = name.split('_')[1],
            qty = parseFloatVal($this.val()),
            rate = parseFloatVal($('#Rate_' + key1).val());

        var total = qty*rate;
        gTotal += total;
        $('#Amount_' + key1).val(sanitizeNumber(total,2,true,true));

        $('#CurAmount_' + $this.parents('tbody.main').data('rowid')).val(sanitizeNumber(gTotal,2,true,true));
        //var cumamt = parseFloatVal($('#CumAmount_' + $this.parents('tbody.main').data('rowid')).val());
        //$('#PrevAmount_' + $this.parents('tbody.main').data('rowid')).val(sanitizeNumber(cumamt - gTotal));
		var prevamt = parseFloatVal($('#PrevAmount_' + $this.parents('tbody.main').data('rowid')).val());
        $('#CumAmount_' + $this.parents('tbody.main').data('rowid')).val(sanitizeNumber((prevamt + gTotal),2,true,true));

    });
    $('#BOQTotal').val(sanitizeNumber(gTotal));
    calcBillAbstract();
}

function addNewBOQRow(x,updateFlag) {

    calcBOQTotal();
    calcBillAbstract();
    calcMobAdvRecoveryAuto();


    var $x = $(x),
        $tr = $x.closest('tr'),
        key = $x[0].id.split('_')[1];

    if(typeof updateFlag != 'undefined' && updateFlag) {
        $('#UpdateBOQRow_' + key).val(1);
    }

    if ($tr.next('tr').length != 0)
        return;

    console.log('kk');
    if ($('#Spec_' + key).val().length == 0 || $('#WOBOQId_' + key).val().length == 0 || $('#WOBOQId_' + key).val() == 0)
        return;

    console.log('kk1');
    var $rowid = $('#boqrowid'),
        rowid = parseInt($rowid.val());
    $('.BOQDeleteTr_' + rowid).show();
    var count = rowid + 1,
        template = $('#dummy-billformat-boq tbody table tbody.main').html();

    template = template.replace(/__1/g, '_' + count);
    $tr.parent('tbody.main').append(template);
    $rowid.val(count);
    bindBOQAutoComplete();
}

function validateAgtQty(x) {
    var $x = $(x),
        key = $x[0].id.split('_')[1],
        qty = parseFloatVal($x.val()),
        balQty = parseFloatVal($('#AgtBalQty_' + key).html());

    if(qty == 0)
        return;
}

function deleteBOQ(x,e,deleteFlag) {
    e.preventDefault();
    var $x = $(x),
        key = $x[0].className.split('_')[1],
        woboqid = $('#WOBOQId_' + key).val(),
        is_deleteable = true;

    // check if boq is used in previous bills and has qty <> 0
    if(woboqid.length != 0 && woboqid != '0') {
        $.ajax({
            url:getBaseURL()+ 'clientbilling/index/checkboqfound',
            type:"post",
            data: {'woboqid': woboqid, 'billid': $('#BillId').val(),'woid': $('#WOId').val()},
            async: false,
            success:function(data, textStatus, jqXHR){
                if(data == 'Y') {
                    is_deleteable = false;
                    alert('This BOQ item cannot be deleted, since it was been used in previous bill(s)');
                }
            }, error:function(jqXHR, textStatus, errorThrown){
                is_deleteable = false;
                alert('This BOQ item cannot be deleted, since it was been used in previous bill(s)');
            }
        });
    }

    if(!is_deleteable)
        return false;

    if (!confirm('Do you want to Delete'))
        return false;

    var $tr = $x.closest('tr'),
        $tbody = $tr.parent('tbody');

    if ($tbody.find('> tr').length == 1) {
        var template = $('#dummy-billformat-boq tbody table tbody.main').html();
        template = template.replace(/__1/g, '_' + 1);
        $tbody.append(template);
        $('#boqrowid').val(1);
    }

    if(typeof deleteFlag != 'undefined' && deleteFlag) {
        var $ids = $('#boqrowdeleteids');
        $ids.val($ids.val() + ',' + $('#BillBOQId_'+key).val());
    }

    $tr.remove();
    setPageChanges(true);
    bindBOQAutoComplete();
    calcBOQTotal();
    calcBillAbstract();

    return false;
}
// Material Adv Fns
function bindMAdvVendorAutoComplete() {
    var $MVendors = $('input[id*=_MVendorName_]');
    $.each($MVendors, function () {
        var $this = $(this),
            name = $this[0].id;
        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1) return;
        var arrname = name.split('_');
        var key1 = arrname[1],
            key2 = arrname[3];
        $this.unbind('autocomplete');
        $this.autocomplete({
            lookup: arr_vendors,
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            }, onSelect: function(suggestion) {
                if(suggestion) {
                    $("#MBill_"+key1+"_MVendorId_" + key2).val(suggestion.data);
                    removeError($(this));
                }
            }, onSearchStart: function(suggestion) {
                $("#MBill_"+key1+"_MVendorId_" + key2).val(0);
            }, onSearchComplete: function (query, suggestions) {
                if(!suggestions.length && query.length > 1){
                    showError($(this), 'Required');
                    $("#MBill_"+key1+"_MVendorId_" + key2).val(0);
                } else
                    removeError($(this));
            }
        });
    });
}

function bindMaterialAdvAutoComplete() {
    var $materialName = $('input[id^=MaterialName_]');
    $.each($materialName, function () {
        var $this = $(this),
            name = $this[0].id;
        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1) return;
        var arrname = name.split('_');
        var key1 = arrname[1];
        checkMaterialAdv(name);
        $this.unbind('autocomplete');
        $this.autocomplete({
            lookup: tmpMAdvAutoCompleteData,
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            }, onSelect: function(suggestion) {
                if(suggestion) {
                    $("#MaterialId_" + key1).val(suggestion.data);
                    $('#MUnit_' + key1).val(suggestion.UnitName);
                    $('#MUnitId_' + key1).val(suggestion.UnitId);
                    $('#MAdvancePer_' + key1).val(suggestion.AdvPercent);
                    removeError($(this));

                    $(this).prop('disabled', true);
                    addNewMAdvRow($(this));
                }
            }, onSearchStart: function(suggestion) {
                $("#MaterialId_" + key1).val(0);
            }, onSearchComplete: function (query, suggestions) {
                if(!suggestions.length && query.length > 1){
                    showError($(this), 'Required');
                    $("#MaterialId_" + key1).val(0);
                } else
                    removeError($(this));
            }
        });
    });
}
function checkMaterialAdv(x) {
    var arrname = x.split('_'),
        id= arrname[1],
        materialid = $('input[id^=MaterialId_]');
    tmpMAdvAutoCompleteData = MAdvAutoCompleteData;
    tmpMAdvAutoCompleteData = $.grep(MAdvAutoCompleteData, function (element, index) {
        var is_selected = true;
        $.each(materialid, function (i, obj) {
            var $this = $(this),
                key = $this[0].id.split('_')[1];
            if (key != id) {
                if (element.data == $this.val()) {
                    is_selected = false;
                }
            }
        });
        return is_selected;
    });
}
// Material Recovery fns
function bindMaterialRecAutoComplete() {
    var $materialName = $('input[id^=RMaterialName_]');
    $.each($materialName, function () {
        var $this = $(this),
            name = $this[0].id;
        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1) return;
        var arrname = name.split('_');
        var key1 = arrname[1];
        checkMaterialRec(name);
        $this.unbind('autocomplete');
        $this.autocomplete({
            lookup: tmpMRecAutoCompleteData,
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            }, onSelect: function(suggestion) {
                if(suggestion) {
                    $("#RMaterialId_" + key1).val(suggestion.data);
                    $('#RMUnit_' + key1).val(suggestion.UnitName);
                    $('#RMUnitId_' + key1).val(suggestion.UnitId);
                    $('#RMRate_' + key1).val(suggestion.Rate);
                    removeError($(this));

                    $(this).prop('disabled', true);
                    addNewRMRow($(this));
                }
            }, onSearchStart: function(suggestion) {
                $("#RMaterialId_" + key1).val(0);
            }, onSearchComplete: function (query, suggestions) {
                if(!suggestions.length && query.length > 1){
                    showError($(this), 'Required');
                    $("#RMaterialId_" + key1).val(0);
                } else
                    removeError($(this));
            }
        });
    });
}
function checkMaterialRec(x) {
    var arrname = x.split('_'),
        id= arrname[1],
        materialid = $('input[id^=RMaterialId_]');
    tmpMRecAutoCompleteData = MRecAutoCompleteData;
    tmpMRecAutoCompleteData = $.grep(MRecAutoCompleteData, function (element, index) {
        var is_selected = true;
        $.each(materialid, function (i, obj) {
            var $this = $(this),
                key = $this[0].id.split('_')[1];
            if (key != id) {
                if (element.data == $this.val()) {
                    is_selected = false;
                }
            }
        });
        return is_selected;
    });
}
function addNewRMRow(x) {
    calcMaterialRecTotal();

    var $x = $(x),
        $tr = $x.closest('tr'),
        key = $x[0].id.split('_')[1];

    if ($tr.next('tr:not(.subTr)').length != 0)
        return;

    if ($('#RMQty_' + key).val().length == 0 || $('#RMaterialName_' + key).val().length == 0
        || $('#RMaterialId_' + key).val().length == 0 || $('#RMaterialId_' + key).val() == 0)
        return;

    var $rowid = $('#mrecoveryrowid'),
        rowid = parseInt($rowid.val());
    $('.RMaterialDeleteTr_' + rowid).show();
    var count = rowid + 1,
        template = $('#dummy-material-recovery tbody table tbody.main').html();

    template = template.replace(/__1/g, '_' + count);
    $tr.parent('tbody.main').append(template);
    $rowid.val(count);
    bindMaterialRecAutoComplete();
}

function deleteRMaterial(x,e) {
    e.preventDefault();
    if (!confirm('Do you want to Delete'))
        return false;

    var $tr = $(x).closest('tr'),
        $tbody = $tr.parent('tbody');

    if ($tbody.find('> tr').length == 1) {
        var template = $('#dummy-material-recovery tbody table tbody.main').html();
        template = template.replace(/__1/g, '_' + 1);
        $tbody.append(template);
        $('#mrecoveryrowid').val(1);
    }

    $tr.remove();
    setPageChanges(true);
    calcMaterialRecTotal();
    bindMaterialRecAutoComplete();
    return false;
}

function calcMaterialRecTotal() {
    var $mQty = $('input[id^=RMQty_]'),
        amtTotal = 0;
    $.each($mQty, function () {
        var $this = $(this),
            name = $this[0].id;
        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1) return;
        var key1 = name.split('_')[1],
            qty = parseFloatVal($this.val()),
            rate = parseFloatVal($('#RMRate_' + key1).val());

        var total = qty*rate;
        amtTotal += total;
        $('#RMAmount_' + key1).val(sanitizeNumber(total));
        $('#CurAmount_' + $this.parents('tbody.main').data('rowid')).val(sanitizeNumber(amtTotal,2,true,true));
        //var cumamt = parseFloatVal($('#CumAmount_' + $this.parents('tbody.main').data('rowid')).val());
        //$('#PrevAmount_' + $this.parents('tbody.main').data('rowid')).val(sanitizeNumber(cumamt - amtTotal));
		var prevamt = parseFloatVal($('#PrevAmount_' + $this.parents('tbody.main').data('rowid')).val());
        $('#CumAmount_' + $this.parents('tbody.main').data('rowid')).val(sanitizeNumber((prevamt + amtTotal),2,true,true));
    });
    $('#RMAmountTotal').val(sanitizeNumber(amtTotal));
}
// Free Supply Material fns
function bindFSMaterialAutoComplete() {
    var $materialName = $('input[id^=FSMaterialName_]');
    $.each($materialName, function () {
        var $this = $(this),
            name = $this[0].id;
        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1) return;
        var arrname = name.split('_');
        var key1 = arrname[1];
        checkFSMaterial(name);
        $this.unbind('autocomplete');
        $this.autocomplete({
            lookup: tmpFSMaterialAutoCompleteData,
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            }, onSelect: function(suggestion) {
                if(suggestion) {
                    $("#FSMaterialId_" + key1).val(suggestion.data);
                    $('#FSMUnit_' + key1).val(suggestion.UnitName);
                    $('#FSMUnitId_' + key1).val(suggestion.UnitId);
                    $('#FSMRate_' + key1).val(sanitizeNumber(suggestion.Rate,2,true,true));
                    removeError($(this));

                    $(this).prop('disabled', true);
                    addNewFSMRow($(this));
                }
            }, onSearchStart: function(suggestion) {
                $("#FSMaterialId_" + key1).val(0);
            }, onSearchComplete: function (query, suggestions) {
                if(!suggestions.length && query.length > 1){
                    showError($(this), 'Required');
                    $("#FSMaterialId_" + key1).val(0);
                } else
                    removeError($(this));
            }
        });
    });
}
function checkFSMaterial(x) {
    var arrname = x.split('_'),
        id= arrname[1],
        materialid = $('input[id^=FSMaterialId_]');
    tmpFSMaterialAutoCompleteData = FSMaterialAutoCompleteData;
    tmpFSMaterialAutoCompleteData = $.grep(FSMaterialAutoCompleteData, function (element, index) {
        var is_selected = true;
        $.each(materialid, function (i, obj) {
            var $this = $(this),
                key = $this[0].id.split('_')[1];
            if (key != id) {
                if (element.data == $this.val()) {
                    is_selected = false;
                }
            }
        });
        return is_selected;
    });
}
function addNewFSMRow(x) {
    calcFSMaterialTotal();

    var $x = $(x),
        $tr = $x.closest('tr'),
        key = $x[0].id.split('_')[1];

    if ($tr.next('tr:not(.subTr)').length != 0)
        return;

    if ($('#FSMQty_' + key).val().length == 0 || $('#FSMaterialName_' + key).val().length == 0
        || $('#FSMaterialId_' + key).val().length == 0 || $('#FSMaterialId_' + key).val() == 0)
        return;

    var $rowid = $('#fsmaterialrowid'),
        rowid = parseInt($rowid.val());
    $('.FSMaterialDeleteTr_' + rowid).show();
    var count = rowid + 1,
        template = $('#dummy-free-supply-material tbody table tbody.main').html();

    template = template.replace(/__1/g, '_' + count);
    $tr.parent('tbody.main').append(template);
    $rowid.val(count);
    bindFSMaterialAutoComplete();
}

function deleteFSMaterial(x,e) {
    e.preventDefault();
    if (!confirm('Do you want to Delete'))
        return false;

    var $tr = $(x).closest('tr'),
        $tbody = $tr.parent('tbody');

    if ($tbody.find('> tr').length == 1) {
        var template = $('#dummy-free-supply-material tbody table tbody.main').html();
        template = template.replace(/__1/g, '_' + 1);
        $tbody.append(template);
        $('#fsmaterialrowid').val(1);
    }

    $tr.remove();
    setPageChanges(true);
    calcFSMaterialTotal();
    bindFSMaterialAutoComplete();
    return false;
}

function calcFSMaterialTotal() {
    var $mQty = $('input[id^=FSMQty_]'),
        amtTotal = 0;
    $.each($mQty, function () {
        var $this = $(this),
            name = $this[0].id;
        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1) return;
        var key1 = name.split('_')[1],
            qty = parseFloatVal($this.val()),
            rate = parseFloatVal($('#FSMRate_' + key1).val());

        var total = qty*rate;
        amtTotal += total;
        $('#FSMAmount_' + key1).val(sanitizeNumber(total,2,true,true));
        $('#CurAmount_' + $this.parents('tbody.main').data('rowid')).val(sanitizeNumber(amtTotal,2,true,true));
        //var cumamt = parseFloatVal($('#CumAmount_' + $this.parents('tbody.main').data('rowid')).val());
        //$('#PrevAmount_' + $this.parents('tbody.main').data('rowid')).val(sanitizeNumber(cumamt - amtTotal));
		var prevamt = parseFloatVal($('#PrevAmount_' + $this.parents('tbody.main').data('rowid')).val());
        $('#CumAmount_' + $this.parents('tbody.main').data('rowid')).val(sanitizeNumber((prevamt + amtTotal),2,true,true));
    });
    $('#FSMAmountTotal').val(sanitizeNumber(amtTotal));
}
// Price Escavation fns
function bindPriceEscAutoComplete() {
    var $materialName = $('input[id^=EMaterialName_]');
    $.each($materialName, function () {
        var $this = $(this),
            name = $this[0].id;
        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1) return;
        var arrname = name.split('_');
        var key1 = arrname[1];
        checkPriceEscMaterial(name);
        $this.unbind('autocomplete');
        $this.autocomplete({
            lookup: tmpPriceEscMaterialAutoCompleteData,
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            }, onSelect: function(suggestion) {
                if(suggestion) {
                    $("#EMaterialId_" + key1).val(suggestion.data);
                    $('#EMUnit_' + key1).val(suggestion.UnitName);
                    $('#EMUnitId_' + key1).val(suggestion.UnitId);
                    $('#EMRate_' + key1).val(sanitizeNumber(suggestion.Rate,2,true,true));
                    $('#EMEscPercent_' + key1).val(suggestion.EscalationPer);
                    $('#ERateCondition_' + key1).val(suggestion.RateCondition);
                    $('#EORate_' + key1).val(sanisuggestion.ActualRate);

                    removeError($(this));

                    $(this).removeClass('parent_text').addClass('parent_padi05').prop('disabled', true);
                    addNewEMRow($(this));
                }
            }, onSearchStart: function(suggestion) {
                $("#EMaterialId_" + key1).val(0);
            }, onSearchComplete: function (query, suggestions) {
                if(!suggestions.length && query.length > 1){
                    showError($(this), 'Required');
                    $("#EMaterialId_" + key1).val(0);
                } else
                    removeError($(this));
            }
        });
    });
}
function checkPriceEscMaterial(x) {
    var arrname = x.split('_'),
        id= arrname[1],
        materialid = $('input[id^=EMaterialId_]');
    tmpPriceEscMaterialAutoCompleteData = PriceEscMaterialAutoCompleteData;
    tmpPriceEscMaterialAutoCompleteData = $.grep(PriceEscMaterialAutoCompleteData, function (element, index) {
        var is_selected = true;
        $.each(materialid, function (i, obj) {
            var $this = $(this),
                key = $this[0].id.split('_')[1];
            if (key != id) {
                if (element.data == $this.val()) {
                    is_selected = false;
                }
            }
        });
        return is_selected;
    });
}

function bindPriceEscVendorAutoComplete() {
    var $PVendors = $('input[id*=_PVendorName_]');
    $.each($PVendors, function () {
        var $this = $(this),
            name = $this[0].id;
        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1) return;
        var arrname = name.split('_');
        var key1 = arrname[1],
            key2 = arrname[3];
        $this.unbind('autocomplete');
        $this.autocomplete({
            lookup: arr_vendors,
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            }, onSelect: function(suggestion) {
                if(suggestion) {
                    $("#EMBill_"+key1+"_PVendorId_" + key2).val(suggestion.data);
                    removeError($(this));
                }
            }, onSearchStart: function(suggestion) {
                $("#EMBill_"+key1+"_PVendorId_" + key2).val(0);
            }, onSearchComplete: function (query, suggestions) {
                if(!suggestions.length && query.length > 1){
                    showError($(this), 'Required');
                    $("#EMBill_"+key1+"_PVendorId_" + key2).val(0);
                } else
                    removeError($(this));
            }
        });
    });
}

function addNewEMBillRow(x,updateFlag) {
    calcPriceEscBillTotal();
    calcPriceEscTotal();

    var $x = $(x),
        $tr = $x.closest('tr'),
        keys = $x[0].id.split('_'),
        key = keys[3],
        rowno = keys[1];

    if(typeof updateFlag != 'undefined' && updateFlag) {
        $('#EMBill_'+rowno+'_UpdateMBillRow_' + key).val(1);
        $('#EUpdateRow_' +rowno).val(1);
    }

    if ($tr.next('tr').length != 0)
        return;

    if ($('#EMBill_'+rowno+'_PBillDate_' + key).val().length == 0 || $('#EMBill_'+rowno+'_PBillNo_' + key).val().length == 0
        || $('#EMBill_'+rowno+'_PVendorId_' + key).val().length == 0 || $('#EMBill_'+rowno+'_PVendorId_' + key).val() == 0
        || $('#EMBill_'+rowno+'_PVendorName_' + key).val().length == 0
        || $('#EMBill_'+rowno+'_PBillQty_' + key).val().length == 0 || $('#EMBill_'+rowno+'_PBillRate_' + key).val().length == 0
        || $('#EMBill_'+rowno+'_PBillAmount_' + key).val().length == 0)
        return;

    var $rowid = $('#embillrowid_'+ rowno),
        rowid = parseInt($rowid.val());
    $('.EMBill_'+rowno+'_DeleteTr_' + rowid).show();
    var count = rowid + 1,
        template = $('#dummy-price-escalation tbody table tbody.main table tbody.submain').html();

    template = template.replace(/__9/g, '_' + count).replace(/__1/g, '_' + rowno);
    $tr.parent('tbody.submain').append(template);
    $rowid.val(count);
    bindPriceEscVendorAutoComplete();
    bindDatePicker();
}

function calcPriceEscTotal() {
    var $pQty = $('input[id^=EMQty_]'),
        baseTotal = 0,
        escTotal = 0,
        acuTotal = 0,
        curTotal = 0,
        tempkey = 1;
    $.each($pQty, function () {
        var $this = $(this),
            name = $this[0].id,
            rowid = $this.closest('tbody.main').data('rowid');

        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1) return;

        var key1 = name.split('_')[1];
        if(tempkey != key1) {
            tempkey = key1;
            baseTotal = 0;
            escTotal = 0;
            acuTotal = 0;
        }

        var qty = parseFloatVal($this.val()),
            acurate = parseFloatVal($('#EMAdvancePer_'+key1).val()),
            escrate = parseFloatVal($('#EMEscPercent_'+key1).val()),
            billTotalRate = parseFloatVal($('#EMBillTotalRate_' + key1).val());

        var total = qty*acurate;
        baseTotal += qty;
        escTotal += escrate;
        acuTotal += acurate;
        curTotal += total;

        $('#EMAmount_'+key1).val(sanitizeNumber(total));
        $('#CurAmount_'+ rowid).val(sanitizeNumber(curTotal,2,true,true)).trigger('change');
        $('#EMaterialTotalBaseRate_' + key1).val($('#EMRate_' + key1).val());
        $('#EMaterialTotalEscPer_' + key1).val(sanitizeNumber(escTotal,2,true,true));
        $('#EMaterialTotalActRate_' + key1).val(sanitizeNumber(acuTotal,2,true,true));
        $('#EMaterialTotalPurRate_' + key1).val(sanitizeNumber(billTotalRate,2,true,true));

        var dbaseRate =  parseFloatVal($('#EMRate_' + key1).val());
        var dPer = $('#EMEscPercent_' + key1).val();
        var dORate = $('#EORate_' + key1).val();
        var sRateCondition = $('#ERateCondition_'+key1).val();
        var dpurRate= billTotalRate;

        var dActualRate=0;
        if (dpurRate != dbaseRate && dbaseRate !=0) {
            var divPer = ((dpurRate-dbaseRate)/dbaseRate) *100;
            if (sRateCondition == '>') { if (divPer > dPer) { if (dORate==0) dActualRate=dpurRate-dbaseRate; else dActualRate=dbaseRate-dORate; } }
            if (sRateCondition == '<') { if (divPer < dPer) { if (dORate==0) dActualRate=dbaseRate-dpurRate; else dActualRate=dbaseRate-dORate; } }
        }
        $('#EMAdvancePer_'+key1).val(sanitizeNumber(dActualRate));
    });
}

function calcPriceEscBillTotal() {
    var $pQty = $('input[id*=_PBillQty_]');
    var qtyTotal = 0,
        rateTotal = 0,
        amtTotal = 0,
        tempkey = 1;
    $.each($pQty, function () {
        var $this = $(this),
            name = $this[0].id;
        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1) return;
        var key1 = name.split('_')[1],
            key2 = name.split('_')[3],
            qty = parseFloatVal($this.val()),
            rate = parseFloatVal($('#EMBill_'+key1+'_PBillRate_' + key2).val());

        if(tempkey != key1) {
            tempkey = key1;
            qtyTotal = 0;
            rateTotal = 0;
            amtTotal = 0;
        }

        var $qtyTotal = $('#EMBillTotalQty_' + key1),
            $rateTotal = $('#EMBillTotalRate_' + key1),
            $amtTotal = $('#EMBillTotalAmount_' + key1);

        var total = qty*rate;
        qtyTotal += qty;
        amtTotal += total;
        $('#EMBill_'+key1+'_PBillAmount_' + key2).val(sanitizeNumber(total));

        if (qtyTotal !=0) { rateTotal = amtTotal /qtyTotal; }

        $qtyTotal.val(sanitizeNumber(qtyTotal,3));
        $rateTotal.val(sanitizeNumber(rateTotal));
        $amtTotal.val(sanitizeNumber(amtTotal));
    });

    calcPriceEscTotal();
}

function deleteEMaterialBill(x,e,deleteFlag) {
    e.preventDefault();
    if (!confirm('Do you want to Delete'))
        return false;

    var $x = $(x),
        $tr = $x.closest('tr'),
        keys = $x[0].className.split('_'),
        key = keys[3],
        rowno = keys[1],
        $tbody = $tr.parent('tbody.submain');

    if ($tbody.find('> tr').length == 1) {
        var template = $('#dummy-price-escalation tbody table tbody.main table tbody.submain').html();
        template = template.replace(/__9/g, '_' + count).replace(/__1/g, '_' + rowno);
        $tbody.append(template);
        $('#embillrowid_'+ rowno).val(1);
    }

    if(typeof deleteFlag != 'undefined' && deleteFlag) {
        var $ids = $('#priceescalationbilldeleteids');
        $ids.val($ids.val() + ',' + $('#EMBill_'+rowno+'_PBillTransId_'+key).val());
    }

    $tr.remove();
    setPageChanges(true);
    calcPriceEscBillTotal();
    calcPriceEscTotal();
    return false;
}

function addNewEMRow(x,updateFlag) {
    calcPriceEscTotal();

    var $x = $(x),
        $tr = $x.closest('tr'),
        key = $x[0].id.split('_')[1];

    if(typeof updateFlag != 'undefined' && updateFlag) {
        $('#EUpdateRow_'+ key).val(1);
    }

    if ($tr.nextAll('tr:not(.subTr):not(.total)').length != 0)
        return;

    if ($('#EMQty_' + key).val().length == 0 || $('#EMaterialName_' + key).val().length == 0
        || $('#EMaterialId_' + key).val().length == 0 || $('#EMaterialId_' + key).val() == 0)
        return;

    var $rowid = $('#priceescalationrowid'),
        rowid = parseInt($rowid.val());
    $('.EMaterialDeleteTr_' + rowid).show();
    var count = rowid + 1,
        template = $('#dummy-price-escalation tbody table tbody.main').html();

    template = template.replace(/__1/g, '_' + count).replace(/__9/g, '_1');
    $tr.parent('tbody.main').append(template);
    $rowid.val(count);

    bindPriceEscAutoComplete();
    bindPriceEscVendorAutoComplete();
    bindDatePicker();
    bindExpandTrFn();
}

function deleteEMaterial(x,e,deleteFlag) {
    e.preventDefault();
    if (!confirm('Do you want to Delete'))
        return false;

    var $x = $(x),
        $tr = $x.closest('tr'),
        key = $x[0].className.split('_')[1],
        $tbody = $tr.parent('tbody');

    if ($tbody.find('> tr').length == 1) {
        var template = $('#dummy-price-escalation tbody table tbody.main').html();
        template = template.replace(/__1/g, '_' + 1);
        $tbody.append(template);
        $('#priceescalationrowid').val(1);
    }

    if(typeof deleteFlag != 'undefined' && deleteFlag) {
        var $ids = $('#priceescalationdeleteids');
        $ids.val($ids.val() + ',' + $('#ETransId_'+key).val());
    }

    $tr.next('.subTr').next('.total').remove();
    $tr.next('.subTr').remove();
    $tr.remove();
    setPageChanges(true);
    calcPriceEscTotal();
    bindPriceEscAutoComplete();
    return false;
}
// Material Adv Bill
function calcMaterialAdvBillTotal(key1) {
    var $mQty = $('input[id^=MBill_'+key1+'_MBillQty_]'),
        qtyTotal = 0,
        rateTotal = 0,
        amtTotal = 0;
    $.each($mQty, function () {
        var $this = $(this),
            name = $this[0].id;
        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1) return;
        var key1 = name.split('_')[1],
            key2 = name.split('_')[3],
            qty = parseFloat($this.val()),
            rate = parseFloat($('#MBill_'+key1+'_MBillRate_' + key2).val());

        if (isNaN(qty))
            qty = 0;
        if (isNaN(rate))
            rate = 0;

        var total = qty*rate;
        qtyTotal += qty;
        rateTotal += rate;
        amtTotal += total;
        $('#MBill_'+key1+'_MBillAmount_' + key2).val(sanitizeNumber(total));

        $('#MBillTotalQty_' + key1).val(sanitizeNumber(qtyTotal,3));
        $('#MBillTotalRate_' + key1).val(sanitizeNumber(rateTotal));
        $('#MBillTotalAmount_' + key1).val(sanitizeNumber(amtTotal));
        $('#MRate_' + key1).val(sanitizeNumber(rateTotal));
    });
    calcMaterialAdvTotal();
}

function addNewMaterialAdvBillRow(x,updateFlag) {

    var $x = $(x),
        $tr = $x.closest('tr'),
        keys = $x[0].id.split('_'),
        key = keys[3],
        rowno = keys[1];

    if(typeof updateFlag != 'undefined' && updateFlag) {
        $('#MBill_'+rowno+'_UpdateMBillRow_' + key).val(1);
        $('#MAdvUpdateRow_' + rowno).val(1);
    }

    calcMaterialAdvBillTotal(rowno);
    calcMAdvTotal();

    if ($tr.next('tr').length != 0)
        return;

    if ($('#MBill_'+rowno+'_BillDate_' + key).val().length == 0 || $('#MBill_'+rowno+'_MBillNo_' + key).val().length == 0
        || $('#MBill_'+rowno+'_MVendorId_' + key).val().length == 0 || $('#MBill_'+rowno+'_MVendorId_' + key).val() == 0
        || $('#MBill_'+rowno+'_MVendorName_' + key).val().length == 0
        || $('#MBill_'+rowno+'_MBillQty_' + key).val().length == 0 || $('#MBill_'+rowno+'_MBillRate_' + key).val().length == 0
        || $('#MBill_'+rowno+'_MBillAmount_' + key).val().length == 0)
        return;

    var $rowid = $('#materialadvbillrowid_'+ rowno),
        rowid = parseInt($rowid.val());
    $('.MBill_'+rowno+'_DeleteTr_' + rowid).show();
    var count = rowid + 1,
        template = $('#dummy-material-adv tbody table tbody.main table tbody.submain').html();

    template = template.replace(/__9/g, '_' + count).replace(/__1/g, '_' + rowno);
    $tr.parent('tbody.submain').append(template);
    $rowid.val(count);
    bindMAdvVendorAutoComplete();
    bindDatePicker();
}

function deleteMaterialBill(x,e,deleteFlag) {
    e.preventDefault();
    if (!confirm('Do you want to Delete'))
        return false;

    var $x = $(x),
        $tr = $x.closest('tr'),
        keys = $x[0].className.split('_'),
        key = keys[3],
        rowno = keys[1],
        $tbody = $tr.parent('tbody.submain');

    if ($tbody.find('> tr').length == 1) {
        var template = $('#dummy-material-adv tbody table tbody.main table tbody.submain').html();
        template = template.replace(/__9/g, '_' + key).replace(/__1/g, '_' + rowno);
        $tbody.append(template);
        $('#materialadvbillrowid_'+ rowno).val(1);
    }

    if(typeof deleteFlag != 'undefined' && deleteFlag) {
        var $ids = $('#materialadvbilldeleteids');
        $ids.val($ids.val() + ',' + $('#MBill_'+rowno+'_PBillTransId_'+key).val());
    }

    $tr.remove();
    setPageChanges(true);
    calcMaterialAdvBillTotal(rowno);
    calcMAdvTotal();
    bindMAdvVendorAutoComplete();
    return false;
}

function changeMAdvTotalQty(x,updateFlag) {
    if(typeof updateFlag != 'undefined' && updateFlag) {
        var $x = $(x),
            key = $x[0].id.split('_')[1];

        $('#MAdvUpdateRow_' + key).val(1);
    }

    calcMAdvTotal();
}
function calcMAdvTotal() {
    var $mQty = $('input[id^=MaterialTotalPurQty_]'),
        qtyTotal = 0;
    $.each($mQty, function () {
        var $this = $(this),
            name = $this[0].id;
        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1) return;
        var key = name.split('_')[1],
            purQty = parseFloatVal($('#MBillTotalQty_' + key).val()),
            $conQty = $('#MaterialTotalConQty_' + key),
            conQty = parseFloatVal($conQty.val());

        if(conQty > purQty)
            showError($conQty, 'Qty should be lesser or equal to Purchase Qty!');
        else
            removeError($conQty);

        $('#MaterialTotalPurQty_' + key).val(sanitizeNumber(purQty,3));
        var totalStock = purQty-conQty;
        $('#MaterialTotalStock_' + key).val(sanitizeNumber(totalStock));
        $('#MQty_' + key).val(sanitizeNumber(totalStock,3));
    });

    calcMaterialAdvTotal();
}

function addNewMAdvRow(x) {
    calcMaterialAdvTotal();

    var $x = $(x),
        $tr = $x.closest('tr'),
        key = $x[0].id.split('_')[1];

    if ($tr.nextAll('tr:not(.subTr):not(.total)').length != 0)
        return;

    if ($('#MaterialName_' + key).val().length == 0 || $('#MaterialId_' + key).val().length == 0 || $('#MaterialId_' + key).val() == 0)
        return;

    var $rowid = $('#materialadvrowid'),
        rowid = parseInt($rowid.val());
    $('.MaterialDeleteTr_' + rowid).show();
    var count = rowid + 1,
        template = $('#dummy-material-adv tbody table tbody.main').html();

    template = template.replace(/__1/g, '_' + count).replace(/__9/g, '_1');
    $tr.parent('tbody.main').append(template);
    $rowid.val(count);
    bindMaterialAdvAutoComplete();
    bindExpandTrFn();
    bindMAdvVendorAutoComplete();
    bindDatePicker();
}

function deleteMaterial(x,e, deleteFlag) {
    e.preventDefault();
    if (!confirm('Do you want to Delete'))
        return false;

    var $x = $(x),
        $tr = $x.closest('tr'),
        key = $x[0].className.split('_')[1],
        $tbody = $tr.parent('tbody');

    if ($tbody.find('> tr').length == 1) {
        var template = $('#dummy-material-adv tbody table tbody.main').html();
        template = template.replace(/__1/g, '_' + 1);
        $tbody.append(template);
        $('#materialadvrowid').val(1);
    }

    if(typeof deleteFlag != 'undefined' && deleteFlag) {
        var $ids = $('#materialadvdeleteids');
        $ids.val($ids.val() + ',' + $('#MAdvTransId_'+key).val());
    }

    $tr.next('.subTr').next('.total').remove();
    $tr.next('.subTr').remove();
    $tr.remove();
    setPageChanges(true);
    calcMaterialAdvTotal();
    bindMaterialAdvAutoComplete();
    return false;
}

function calcMaterialAdvTotal() {
    var $mQty = $('input[id^=MQty_]'),
        qtyTotal = 0,
        advAmtTotal = 0;
    $.each($mQty, function () {
        var $this = $(this),
            name = $this[0].id;
        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1) return;
        var key1 = name.split('_')[1],
            qty = parseFloatVal($this.val()),
            rate = parseFloatVal($('#MRate_' + key1).val()),
            advAmt = parseFloatVal($('#MAdvancePer_' + key1).val());

        qtyTotal += qty;
        var total = (qty*rate);

        advAmtTotal += (total*(advAmt / 100));
        $('#MAmount_' + key1).val(sanitizeNumber(total));
        $('#MAdvAmount_' + key1).val(sanitizeNumber((total*(advAmt / 100))));
        $('#MaterialTotalPurQty'+key1).val(sanitizeNumber(qtyTotal,3));

        $('#CurAmount_' + $this.parents('tbody.main').data('rowid')).val(sanitizeNumber(advAmtTotal,2,true,true));
    });

    calcBillAbstract();
}

function calcBillAbstract() {
    calculateFormula();

    var $cumAmt = $('input[id^=CumAmount_]'),
        cumTotal = 0,
        curTotal = 0,
        prevTotal = 0;
    $.each($cumAmt, function () {
        var $this = $(this),
            name = $this[0].id;
        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1) return;

        var key = name.split('_')[1],
            prevAmt = parseFloatVal($('#PrevAmount_' + key).val()),
            curAmt = parseFloatVal($('#CurAmount_' + key).val()),
            sign = $.trim($('#Sign_' + key).val()),
            cumAmt = prevAmt+curAmt;
        $('#CumAmount_' + key).val(sanitizeNumber(cumAmt,2,true,true));

        if(parseFloatVal($('#BillFormatId_' + key).val()) != 0) {
            if(sign == '-') {
                cumTotal -= cumAmt;
                curTotal -= curAmt;
                prevTotal -= prevAmt;
            } else {
                cumTotal += cumAmt;
                curTotal += curAmt;
                prevTotal += prevAmt;
            }
        }
    });
    $('#TotalCumAmount').val(sanitizeNumber(cumTotal));
    $('#TotalPrevAmount').val(sanitizeNumber(prevTotal));
    $('#TotalCurAmount').val(sanitizeNumber(curTotal));
}

// Advance Recovery
function calcAdvRecoveryTotal(x) {
    var $x = $(x),
        key = $x[0].id.split('_')[1],
        $tr = $x.closest('tr'),
        $advrowid = $('#advrecoveryrowid');

    // check required
    var cAmt = $x.val(),
        bAmt = parseFloatVal($('#AdvRecoveryBalance_' + key).val());
    if(cAmt == '' && $tr.next('tr').length != 0)
        showError($x, 'Required');
    else
        removeError($x);

    // check value equ or grt
    if(parseFloatVal(cAmt) != 0 && cAmt > bAmt)
        showError($x, 'Amount should be equal to or less than Balance Amt!');
    else
        removeError($x);

    //calc total
    var $advRecCur = $('input[id^=AdvRecoveryCurrent_]'),
        gTotal = 0;
    $.each($advRecCur, function () {
        var $this = $(this),
            name = $this[0].id;
        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1) return;

        var total = parseFloatVal($this.val());
        gTotal += total;

        $('#CurAmount_' + $this.parents('tbody.main').data('rowid')).val(sanitizeNumber(gTotal,2,true,true));
        //var cumamt = parseFloatVal($('#CumAmount_' + $this.parents('tbody.main').data('rowid')).val());
        //$('#PrevAmount_' + $this.parents('tbody.main').data('rowid')).val(sanitizeNumber(cumamt - gTotal));
		var prevamt = parseFloatVal($('#PrevAmount_' + $this.parents('tbody.main').data('rowid')).val());
        $('#CumAmount_' + $this.parents('tbody.main').data('rowid')).val(sanitizeNumber((prevamt + gTotal),2,true,true));
    });

    $('#AdvRecoveryCurrentTotal').val(sanitizeNumber(gTotal));
}
function deleteAdvRecovery(x,e) {
    e.preventDefault();
    if (!confirm('Do you want to Delete'))
        return false;

    var $tr = $(x).closest('tr'),
        $tbody = $tr.parent('tbody');

    if ($tbody.find('> tr').length == 1) {
        var template = $('#dummy-adv-recovery tbody table tbody.main').html();
        template = template.replace(/__1/g, '_' + 1);
        $tbody.append(template);
        $('#advrecoveryrowid').val(1);
    }

    $tr.remove();
    setPageChanges(true);
    calcAdvRecoveryTotal(x);
    return false;
}

// Mob Adv Recovery
function calcMobAdvRecoveryAuto() {
    var $type = $('input[value=5][id^=FormatTypeId_]');

    if($type.length == 0)
        return;

    var key = $type[0].id.split('_')[1],
        $curAmount = $('#CurAmount_' + key),
        curAmount = parseFloatVal($curAmount.val());

    var $recBalance = $('input[type=text][id^=mobAdvRecoveryBalance_]');
    if($recBalance.length == 0)
        return;

    var totalBalance = 0;
    $.each($recBalance, function(i, obj) {
        var key1 = $(this)[0].id.split('_')[1],
            balAmt = parseFloatVal($(this).val()),
            $curAmt = $('#mobAdvRecoveryCurrent_' + key1);

        if (balAmt > curAmount) {
            $curAmt.val(sanitizeNumber(curAmount,2,true,true)).trigger('change');
            curAmount = 0;
        } else {
            $curAmt.val(sanitizeNumber(balAmt,2,true,true)).trigger('change');
            curAmount = curAmount - balAmt;
        }
    });
}
function calcMobAdvRecoveryTotal(x) {
    var $x = $(x),
        key = $x[0].id.split('_')[1],
        $tr = $x.closest('tr'),
        $advrowid = $('#mobadvrecoveryrowid');

    // check required
    var cAmt = $x.val(),
        bAmt = parseFloatVal($('#mobAdvRecoveryBalance_' + key).val());
    if(cAmt == '' && $tr.next('tr').length != 0)
        showError($x, 'Required');
    else
        removeError($x);

    // check value equ or grt
    if(parseFloatVal(cAmt) != 0 && cAmt > bAmt)
        showError($x, 'Amount should be equal to or less than Balance Amt!');
    else
        removeError($x);

    //calc total
    var $advRecCur = $('input[id^=mobAdvRecoveryCurrent_]'),
        gTotal = 0;
    $.each($advRecCur, function () {
        var $this = $(this),
            name = $this[0].id;
        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1) return;

        var total = parseFloatVal($this.val());
        gTotal += total;

        $('#CurAmount_' + $this.parents('tbody.main').data('rowid')).val(sanitizeNumber(gTotal,2,true,true));
        //var cumamt = parseFloatVal($('#CumAmount_' + $this.parents('tbody.main').data('rowid')).val());
        //$('#PrevAmount_' + $this.parents('tbody.main').data('rowid')).val(sanitizeNumber(cumamt - gTotal));
		var prevamt = parseFloatVal($('#PrevAmount_' + $this.parents('tbody.main').data('rowid')).val());
        $('#CumAmount_' + $this.parents('tbody.main').data('rowid')).val(sanitizeNumber((prevamt + gTotal),2,true,true));
    });

    $('#mobAdvRecoveryCurrentTotal').val(sanitizeNumber(gTotal));
}
function deleteMobAdvRecovery(x,e) {
    e.preventDefault();
    if (!confirm('Do you want to Delete'))
        return false;

    var $tr = $(x).closest('tr'),
        $tbody = $tr.parent('tbody');

    if ($tbody.find('> tr').length == 1) {
        var template = $('#dummy-mobadv-recovery tbody table tbody.main').html();
        template = template.replace(/__1/g, '_' + 1);
        $tbody.append(template);
        $('#mobadvrecoveryrowid').val(1);
    }

    $tr.remove();
    setPageChanges(true);
    calcMobAdvRecoveryTotal(x);
    return false;
}

// Material Advance Recovery
function calcMAdvRecoveryTotal(x) {
    var $x = $(x),
        key = $x[0].id.split('_')[1],
        $tr = $x.closest('tr'),
        $advrowid = $('#madvrecoveryrowid');

    // check required
    var cAmt = $x.val(),
        bAmt = parseFloatVal($('#MAdvRecoveryBalance_' + key).val());
    if(cAmt == '' && $tr.next('tr').length != 0)
        showError($x, 'Required');
    else
        removeError($x);

    // check value equ or grt
    if(parseFloatVal(cAmt) != 0 && cAmt > bAmt)
        showError($x, 'Amount should be equal to or less than Balance Amt!');
    else
        removeError($x);

    //calc total
    var $advRecCur = $('input[id^=MAdvRecoveryCurrent_]'),
        gTotal = 0;
    $.each($advRecCur, function () {
        var $this = $(this),
            name = $this[0].id;
        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1) return;

        var total = parseFloatVal($this.val());
        gTotal += total;

        $('#CurAmount_' + $this.parents('tbody.main').data('rowid')).val(sanitizeNumber(gTotal,2,true,true));
        var prevamt = parseFloatVal($('#PrevAmount_' + $this.parents('tbody.main').data('rowid')).val());
        $('#CumAmount_' + $this.parents('tbody.main').data('rowid')).val(sanitizeNumber((prevamt + gTotal),2,true,true));
    });

    $('#MAdvRecoveryCurrentTotal').val(sanitizeNumber(gTotal));
}

// Non Agreement BOQ Fns
function calcNABOQTotal() {
    var $boqQty = $('input[id^=NAQty_]'),
        gTotal = 0;
    $.each($boqQty, function () {
        var $this = $(this),
            name = $this[0].id;
        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1) return;
        var key1 = name.split('_')[1],
            qty = parseFloatVal($this.val()),
            rate = parseFloatVal($('#NARate_' + key1).val());

        var total = qty*rate;
        gTotal += total;
        $('#NAAmount_' + key1).val(sanitizeNumber(total,2,true,true));

        $('#CurAmount_' + $this.parents('tbody.main').data('rowid')).val(sanitizeNumber(gTotal,2,true,true));
        //var cumamt = parseFloatVal($('#CumAmount_' + $this.parents('tbody.main').data('rowid')).val());
        //$('#PrevAmount_' + $this.parents('tbody.main').data('rowid')).val(sanitizeNumber(cumamt - gTotal));
		var prevamt = parseFloatVal($('#PrevAmount_' + $this.parents('tbody.main').data('rowid')).val());
        $('#CumAmount_' + $this.parents('tbody.main').data('rowid')).val(sanitizeNumber((prevamt + gTotal),2,true,true));
    });
    $('#NABOQTotal').val(sanitizeNumber(gTotal,2,true,true));
}

function addNewNABOQRow(x,updateFlag) {
    calcNABOQTotal();
    calcBillAbstract();

    var $x = $(x),
        $tr = $x.closest('tr'),
        key = $x[0].id.split('_')[1];

    if(typeof updateFlag != 'undefined' && updateFlag) {
        $('#NAUpdateBOQRow_' + key).val(1);
    }

    if ($tr.next('tr').length != 0)
        return;

    if ($('#NASpec_' + key).val().length == 0 || $('#NAUnit_' + key).val().length == 0 || $('#NAUnitId_' + key).val().length == 0
        || $('#NAUnitId_' + key).val() == 0 || $('#NAQty_' + key).val().length == 0 || $('#NARate_' + key).val().length == 0)
        return;

    var $rowid = $('#naboqrowid '),
        rowid = parseInt($rowid.val());
    $('.NABOQDeleteTr_' + rowid).show();
    var count = rowid + 1,
        template = $('#dummy-billformat-boq-2 tbody table tbody.main').html();

    template = template.replace(/__1/g, '_' + count);
    $tr.parent('tbody.main').append(template);
    $rowid.val(count);

    bindNonBOQAutoComplete();
}

function bindNAUnitAutoComplete() {
    $('#nonunitName').autocomplete({
        lookup: arr_units,
        showNoSuggestionNotice: false,
        lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
            if (queryLowerCase == '*') {
                return suggestion.value;
            } else {
                var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                return re.test(suggestion.value);
            }
        }, onSelect: function (suggestion) {
            if (suggestion) {
                $("#nonunitId").val(suggestion.data);
                $(this).removeClass('error');
            }
        }, onSearchStart: function (suggestion) {
            $("#nonunitId").val(0);
        }, onSearchComplete: function (query, suggestions) {
            if (!suggestions.length) {
                $("#nonunitId").val(0);
                $(this).addClass('error');
            } else $(this).removeClass('error');
        }
    });
}

//function bindNAWorkGroupAutoComplete() {
//    $('#nonworkgroupName').autocomplete({
//        lookup: workgrouplist,
//        showNoSuggestionNotice: false,
//        lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
//            if (queryLowerCase == '*') {
//                return suggestion.value;
//            } else {
//                var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
//                return re.test(suggestion.value);
//            }
//        }, onSelect: function (suggestion) {
//            if (suggestion) {
//                $("#nonworkgroupId").val(suggestion.data);
//                $(this).removeClass('error');
//            }
//        }, onSearchStart: function (suggestion) {
//            $("#nonunitId").val(0);
//        }, onSearchComplete: function (query, suggestions) {
//            if (!suggestions.length) {
//                $("#nonworkgroupId").val(0);
//                $(this).addClass('error');
//            } else $(this).removeClass('error');
//        }
//    });
//}

function deleteNABOQ(x,e,deleteFlag) {
    e.preventDefault();
    if (!confirm('Do you want to Delete'))
        return false;

    var $x = $(x),
        $tr = $x.closest('tr'),
        key = $x[0].className.split('_')[1],
        $tbody = $tr.parent('tbody');

    if ($tbody.find('> tr').length == 1) {
        var template = $('#dummy-billformat-boq-2 tbody table tbody.main').html();
        template = template.replace(/__1/g, '_' + 1);
        $tbody.append(template);
        $('#naboqrowid').val(1);
    }

    if(typeof deleteFlag != 'undefined' && deleteFlag) {
        var $ids = $('#naboqrowdeleteids');
        $ids.val($ids.val() + ',' + $('#NABillBOQId_'+key).val());
    }

    $tr.remove();
    setPageChanges(true);
    calcNABOQTotal();
    calcBillAbstract();
    bindNonBOQAutoComplete();
    return false;
}

function bindExpandTrFn() {
    // expand tr
    var $mainTr = $(".mainTr");
    $mainTr.unbind('click');
    $mainTr.click(function(e){
        e.preventDefault();
        if(!$(this).closest("tr").next(".subTr").is(":visible")){
            $(this).closest("tr").next(".subTr").show();
            $(this).closest("tr").next(".subTr").find(".subDiv").slideDown("slow");
            $(this).find("i").addClass("tform");
        }
        else{
            $(this).closest("tr").next(".subTr").find(".subDiv").slideUp("slow");
            $(this).closest("tr").next(".subTr").slideUp("slow");
            $(this).find("i").removeClass("tform");
        }
    });
}

// Import from excel
function fileupload(x) {
    var bValid=true,
        formData = new FormData(),
        type = $(x)[0].id;

    formData.append('file', $(x).prop("files")[0]);
    $.ajax({
        url: getBaseURL() +"clientbilling/index/uploadboqdata",
        async: false,
        dataType: 'script',
        cache: false,
        contentType: false,
        processData: false,
        data: formData,
        type: 'post',
        success: function(data,status, xhr) {
            var obj = jQuery.parseJSON(data);
            var key1=1;
            if (obj[0].Valid==true) {
                $('#excelTable tr:gt(1)').remove();
                var $excelspecs = $('input[id^=excelspec_]');
                $.each($excelspecs, function (i, obj) {
                    var $this = $(this),
                        name = $this[0].id;
                    key1 = name.split('_')[1];
                });
                var irow = key1;
                $("#excelspec_"+irow).val('').prop('readonly', false);
                $("#excelunit_"+irow).val('');
                $("#excelqty_"+irow).val('');
                $("#excelrate_"+irow).val('');
                $("#excelamt_"+irow).val('');
                for (var i = 0; i < obj.length; i++) {
                    if (irow != key1)  {
                        $("#excelTable tbody tr:last").after('<tr id="excelrowid_'+irow+'" class="padi05">' + $("#excelTable tbody tr:first").html() + "</tr>");
                        var $tr = $("#excelTable tbody tr:last");
                        $tr.find("input:text").each(function () {
                            $(this).attr("id", $(this).attr("id").replace( "_" + key1, "_" + irow));
                        });
                        $tr.find("input:hidden").each(function () {
                            $(this).attr("id", $(this).attr("id").replace( "_" + key1, "_" + irow));
                        });
                    }
                    var  qty = parseFloatVal(obj[i].Qty),
                        rate = parseFloatVal(obj[i].Rate),
                        amt = qty * rate;

                    if(type == 'file-boq-2')
                        $("#excelspec_"+irow).val(obj[i].Spec).attr('onfocus', 'checkExcelNonAgtBoqSpec(this.id);');
                    else
                        $("#excelspec_"+irow).val(obj[i].Spec).attr('onfocus', 'checkExcelBoqSpec(this.id);');

                    $("#excelunitid_"+irow).val(obj[i].UnitId);
                    $("#excelunit_"+irow).val(obj[i].Unit);
                    $("#excelqty_"+irow).val(qty.toFixed(3));
                    $("#excelrate_"+irow).val(rate.toFixed(2));
                    $("#excelamt_"+irow).val(amt.toFixed(3));
                    $('#excelboqdelete_'+irow).show();
                    irow = +irow + 1;
                }
            } else
                bValid=false;

            if (bValid==true)
                $("#excelmodal").attr('data-type', type).modal('show');
            else
                alert("Invalid File Format");

            //bind fns
            if(type == 'file-boq-2')
                bindExcelNonBOQAutoComplete();
            else
                bindExcelBOQAutoComplete();
        },
        error: function(xhr, status, errorThrown) {
            if (xhr.status == 400)
                alert(xhr.responseText);
            else
                alert(errorThrown);
        }
    });
    clearInputFile($(x));
}
var tmpexcelboqAutoCompleteData = [];
function bindExcelBOQAutoComplete() {
    var $boqSpec = $('input[id^=excelspec_]');
    $.each($boqSpec, function () {
        var $this = $(this),
            name = $this[0].id;
        if (name.indexOf('excel') == -1) return;
        var arrname = name.split('_'),
            key1 = arrname[1];
        checkExcelBoqSpec(name);
        initExcelboqAutoComplete($this, key1);
        $this.triggerHandler('focus');
    });
}
function initExcelboqAutoComplete($el, key1) {
    $el.unbind('autocomplete');
    $el.autocomplete({
        lookup: tmpexcelboqAutoCompleteData,
        lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
            if (queryLowerCase == '*') {
                return suggestion.value;
            } else {
                var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                return re.test(suggestion.value);
            }
        }, onSelect: function(suggestion) {
            if(suggestion) {
                $("#excelwoboqid_" + key1).val(suggestion.data);
                $('#excelunit_' + key1).val(suggestion.UnitName);
                $('#excelunitid_' + key1).val(suggestion.UnitId);
                $('#excelrate_' + key1).val(sanitizeNumber(suggestion.Rate));
                removeError($(this));

                $(this).prop('readonly', true).addClass('parent_padi05');
            }
        }, onSearchStart: function(suggestion) {
            $("#excelwoboqid_" + key1).val(0);
            removeError($(this));
        }, onSearchComplete: function (query, suggestions) {
            if(!suggestions.length){
                showError($(this), 'Required');
                $(this).removeClass('parent_padi05').addClass('parent_text');
                $("#excelwoboqid_" + key1).val(0);
            } else {
                removeError($(this));
            }
        }
    });
}
function checkExcelBoqSpec(x) {
    var arrname = x.split('_'),
        id= arrname[1],
        woboqid = $('input[id^=excelwoboqid_]');
    tmpexcelboqAutoCompleteData = tmpboqAutoCompleteData;
    tmpexcelboqAutoCompleteData = $.grep(tmpboqAutoCompleteData, function (element, index) {
        var is_selected = true;
        $.each(woboqid, function (i, obj) {
            var $this = $(this),
                key = $this[0].id.split('_')[1];
            if (key != id) {
                if (element.id == $this.val()) {
                    is_selected = false;
                }
            }
        });
        return is_selected;
    });
    initExcelboqAutoComplete($('#'+x), id);
}
var tmpexcelboqAutoNonBOQData = [];
function bindExcelNonBOQAutoComplete() {
    var $boqSpec = $('input[id^=excelspec_]');
    $.each($boqSpec, function () {
        var $this = $(this),
            name = $this[0].id;
        if (name.indexOf('excel') == -1) return;
        var arrname = name.split('_'),
            key1 = arrname[1];
        checkExcelNonAgtBoqSpec(name);
        initExcelNonboqAutoComplete($this, key1);
        $this.triggerHandler('focus');
    });
}
function initExcelNonboqAutoComplete($el, key1) {
    $el.unbind('autocomplete');
    $el.autocomplete({
        lookup: tmpexcelboqAutoNonBOQData,
        lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
            if (queryLowerCase == '*') {
                return suggestion.value;
            } else {
                var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                return re.test(suggestion.value);
            }
        }, onSelect: function(suggestion) {
            if(suggestion) {
                $("#excelwoboqid_" + key1).val(suggestion.data);
                $('#excelunit_' + key1).val(suggestion.UnitName);
                $('#excelunitid_' + key1).val(suggestion.UnitId);
                $('#excelrate_' + key1).val(sanitizeNumber(suggestion.Rate));
                removeError($(this));

                $(this).prop('readonly', true).addClass('parent_padi05');
            }
        }, onSearchStart: function(suggestion) {
            $("#excelwoboqid_" + key1).val(0);
            removeError($(this));
        }, onSearchComplete: function (query, suggestions) {
            if(!suggestions.length){
                showError($(this), 'Required');
                $(this).removeClass('parent_padi05').addClass('parent_text');
                $("#excelwoboqid_" + key1).val(0);
            } else {
                removeError($(this));
            }
        }
    });
}
function checkExcelNonAgtBoqSpec(x) {
    var arrname = x.split('_'),
        id= arrname[1],
        woboqid = $('input[id^=excelwoboqid_]');
    tmpexcelboqAutoNonBOQData = tmpboqAutoNonBOQData;
    tmpexcelboqAutoNonBOQData = $.grep(tmpboqAutoNonBOQData, function (element, index) {
        var is_selected = true;
        $.each(woboqid, function (i, obj) {
            var $this = $(this),
                key = $this[0].id.split('_')[1];
            if (key != id) {
                if (element.data == $this.val()) {
                    is_selected = false;
                }
            }
        });
        return is_selected;
    });
}
function exceldeleteboqTr(x,e) {
    e.preventDefault();
    if (!confirm('Do you want to Delete'))
        return false;

    var $tr = $(x).closest('tr');
    $tr.next('tr.subTr').remove();
    $tr.remove();
    setPageChanges(true);
    return false;
}
function BOQUpdate() {
    if($('#excelTable .error').length != 0) {
        alert('Kindly notice the error(s)!');
        return false;
    }

    var $modal  = $('#excelmodal'),
        type = $modal.attr('data-type'),
        $rowId = $('#boqrowid'),
        prefix = '',
        $dummy = $('#dummy-billformat-boq tbody table tbody.main'),
        $boqTable = $('#boqTable > tbody:not(.total) tr:last');

    if(type == 'file-boq-2') {
        $rowId = $('#naboqrowid');
        prefix = 'NA';
        $dummy = $('#dummy-billformat-boq-2 tbody table tbody.main');
        $boqTable = $('#boqTable-2 > tbody:not(.total) tr:last');
    }

    var iMRowId = $rowId.val(),
        $excelspecs = $('input[id^=excelspec_]');
    $.each($excelspecs, function (i, obj) {
        var $this = $(this),
            name = $this[0].id;
        var key1 = name.split('_')[1],
            $spec = $('#' + prefix + 'Spec_' + iMRowId);

        if ($spec.length > 0 && $spec.val() != "")
            iMRowId = + iMRowId+1;

        if ($spec.length == 0){
            var sStr = $dummy.html();
            sStr = sStr.replace(/__1/g, '_' + iMRowId);
            $boqTable.after(sStr);
        }

        var $Spec = $('#' + prefix + "Spec_"+iMRowId),
            $qty = $('#' + prefix + "Qty_"+iMRowId);
        $Spec.val($("#excelspec_"+key1).val());
        $('#' + prefix + "Unit_"+iMRowId).val($("#excelunit_"+key1).val());
        $('#' + prefix + "Unitid_"+iMRowId).val($("#excelunitid_"+key1).val());
        $qty.val($("#excelqty_"+key1).val());
        $('#' + prefix + "Rate_"+iMRowId).val(sanitizeNumber($("#excelrate_"+key1).val(),2,true,true));
        $('#' + prefix + "Amount_"+iMRowId).val(sanitizeNumber($("#excelamt_"+key1).val(),2,true,true));
        $('.' + prefix +'BOQDeleteTr_' + iMRowId).show();
        $rowId.val(iMRowId);
        iMRowId=+iMRowId+1;
        $Spec.trigger('change');
        $qty.trigger('change');

        if(type == 'file-boq-2') {
            bindNonBOQAutoComplete();
        } else {
            bindBOQAutoComplete();
            $Spec.removeClass('parent_text').addClass('parent_padi05');
        }
    });

    $modal.modal('toggle');
}

function showFormulaModal(id, isForceShow) {
    var key = id.split('_')[1],
        formartId = parseFloatVal($('#FormatTypeId_' + key).val()),
        arr_excluded = [1,2,3,5,6,7,8,18,19];

    var $curAmt = $('#CurAmount_' + key),
        curAmt = parseFloatVal($curAmt.val()),
        formula = $.trim($('#Formula_' + key).val());

    if(typeof isForceShow != 'undefined' && isForceShow && isBillEditable) {
        $('#btnRemoveFormula').hide();
        $('#FormulaModal').data('rowid', key).modal('show');
        $('#FormulaExpression').val(formula);
        $('#FormulaVal').val(curAmt);
        return;
    }

    if ($.inArray(formartId, arr_excluded) != -1)
        return false;

    // if submitted or certified remove tooltip
    if(formula.length == 0 && isBillEditable) {
        removeTooltip();
        $curAmt.prop('readonly', false);
        $curAmt.after($confirmToolTipTemplate);
        $('#FormulaConfirmationToolTip').data('id', key);
        return;
    } else if (formula.length == 0 && !isBillEditable) {
        return;
    }

    $curAmt.prop('readonly', true);
    $('#btnRemoveFormula').show();
    $('#FormulaModal').data('rowid', key).modal('show');
    $('#FormulaExpression').val(formula);
    $('#FormulaVal').val(curAmt);
}

function calculateFormula() {
    var rows = $('#entryrowid').val();
    for (var i = 1; i <= rows; i++) {
        var sFormula = $.trim($('#Formula_' + i).val());
        if (sFormula.length > 0) {
            for (var j = rows; j >= 1; j--) {
                var sRef = $('#RowName_' + j).html().trim(),
                    dAmt = parseFloatVal($('#CurAmount_' + j).val());

                if(sRef != '')
                    sFormula = sFormula.replace(new RegExp(sRef + '(?![0-9]+)', 'gi'), dAmt);
            }
            sFormula = sFormula.replace(/R[0-9]+/gi, 0); // replace 0 for R(X) values not found
            sFormula = sFormula.replace(/%/gi, '/100'); // replace % to / 100

            $('#CurAmount_' + i).val(sanitizeNumber(computeEval(sFormula),2,true,true));
        }
    }
}

function FormulaCalc() {
    var $FExpression = $("#FormulaExpression"),
        sFormula = $FExpression.val(),
        fvalue= 0,
        rows = $('#entryrowid').val(),
        key = $('#FormulaModal').data('rowid'),
        $Formula =  $.trim($('#Formula_' + key));
    if (sFormula.length > 0) {
        $Formula.val(sFormula);
        for (var j = rows; j >= 1; j--) {
            var sRef = $.trim($('#RowName_' + j).html()),
                dAmt = parseFloatVal($('#CurAmount_' + j).val());

            if(sRef != '')
                sFormula = sFormula.replace(new RegExp(sRef + '(?![0-9]+)', 'gi'), dAmt);
        }
        sFormula = sFormula.replace(/R[0-9]+/gi, 0); // replace 0 for R(X) values not found
        sFormula = sFormula.replace(/%/gi, '/100'); // replace % to / 100
        fvalue = computeEval(sFormula);

        if(typeof fvalue !== 'number') {
            showError($FExpression, 'Invalid expression');
            $("#FormulaVal").val('N/A');
            return false;
        } else
            removeError($FExpression);

        $('#CurAmount_' + key).val(sanitizeNumber(fvalue,2,true,true));
    }
    $("#FormulaVal").val(sanitizeNumber(fvalue));
}

function ApplyFormula() {
    FormulaCalc();

    if($('#FormulaExpression').hasClass('error')) {
        alert('Invalid expression');
        return false;
    }

    calcBillAbstract();
    $('#FormulaModal').modal('hide');
}
function RemoveFormula() {
    var key = $('#FormulaModal').data('rowid');
    $('#CurAmount_' + key).val('');
    $('#Formula_' + key).val('');

    $('#FormulaModal').modal('hide');
    $('#CurAmount_' + key).trigger('change').focus();
}

function computeEval(formula) {
    try {
        with (document.forms) {
            with (Math) {
                A = eval((formula));
            }
        }
        return A;
    } catch(e) {}
}

// formula toptip
function setFormula() {
    var id = '#Formula_' + $('#FormulaConfirmationToolTip').data('id');
    $(id).val(0);
    showFormulaModal(id);
    removeTooltip();
}
function removeTooltip() {
    $('#FormulaConfirmationToolTip').remove();
    $('#MSheetConfirmationToolTip').remove();
}

<!--Handson Script-->
var handsonTableData =  [[]],
    handsonTable = null,
    $HandsonTableWrapper = document.getElementById('HandsonTableWrapper'),
    HandsonTableSettings = {
        colHeaders:true,
        rowHeaders: true,
        contextMenu: true,
        minRows: 25,
        minCols: 10,
        minSpareRows: 1,
        stretchH: 'all',
        formulas: true,
        manualColumnResize: true,
        fixedRowsTop: 1,
        fixedRowsBottom: 1,
        manualRowResize: true,
        fillHandle: true,
        data: handsonTableData,
        beforeChange: function(changes, source) {
            if(source == 'paste') {
                var changesJSON = JSON.parse(JSON.stringify(changes));
                for(var i=0; i<changesJSON.length; i++) {
                    var row = changesJSON[i][0],
                        value = changesJSON[i][3];

                    if(value.indexOf('=') == -1)
                        return;

                    changes[i][3] = value.replace(/\d+/g, function(n){return  parseInt(row + 1, 10); });
                }
            }
        },
        afterRender: function() {
            summationColumns();
        },
        cells: function (row, col, prop) {
            var cellProperties = {};

            if (row === 0) {
                cellProperties.renderer = firstRowRenderer;
            }

            return cellProperties;
        }
    };
function firstRowRenderer(instance, td, row, col, prop, value, cellProperties) {
    Handsontable.renderers.TextRenderer.apply(this, arguments);
    td.style.fontWeight = 'bold';
}
var summationColumn = '',
    selColumns = [],
    tempSelectedCol = [];
function showHandsonTableModal(x, forceShowTable) {
    var $x = $(x),
        spilts = $x[0].id.split('_'),
        elName = spilts[0],
        el_type = '',
        key = spilts[1];

    if(elName.indexOf('NA') != -1)
        el_type = 'NA';

    var measurement = $.trim($('#' +el_type+'Measurement_' + key).val());
    // if bill not editable and measurement empty
    if(typeof forceShowTable == 'undefined' && measurement == '' && !isBillEditable) {
        return;
    }

    if(typeof forceShowTable == 'undefined' && measurement == '' && isBillEditable) {
        $x.prop('readonly', false);
        var $qty = $('#'+el_type +'Qty_'+key);
        // show prompt
        if (parseFloatVal(isNullCheck($qty.val(),'number')) ==0)
        {
            removeTooltip();
            $qty.prop('readonly', false);
            $qty.after($mSheetConfirmToolTipTemplate);
            $('#MSheetConfirmationToolTip').data('id', key).data('type', el_type);
        }
    } else {
        $x.prop('readonly', true);
        if(measurement == '')
            handsonTableData = [[]];
        else
            handsonTableData = $.parseJSON(measurement);

        summationColumn = $.trim($('#' +el_type+'CellName_' + key).val());
        selColumns = ($.trim($('#' +el_type+'SelectedColumns_' + key).val())).split(',');
        tempSelectedCol = [];
        renderHandsonTable();

        $('#ExcelTemplate').find('option:first-child').prop('selected', true).siblings('option').removeAttr('selected');
        $formWrapper.hide();
        $HandsonWrapper.data('type', el_type).data('rowid', key).fadeIn();
    }
}
// Measurement Sheet toptip
function setMSheet() {
    var $tooltip = $('#MSheetConfirmationToolTip'),
        key = $tooltip.data('id'),
        el_type = $tooltip.data('type'),
        id = '#' + el_type +'Measurement_' + key;
    showHandsonTableModal(id, true);
    removeTooltip();
    handsonTableData  = [[]];
    renderHandsonTable();
}
function removeMSheet() {
    var key = $HandsonWrapper.data('rowid'),
        el_type = $HandsonWrapper.data('type'),
        $qty = $('#'+el_type+'Qty_' + key);
    $qty.val('');
    $('#'+el_type+'Measurement_' + key).val('');
    $HandsonWrapper.hide();
    $formWrapper.fadeIn();
    $qty.focus();
}
document.addEventListener("DOMContentLoaded", function() {
    handsonTable = new Handsontable($HandsonTableWrapper, HandsonTableSettings);
});

function updateMSheet() {
    var $totalcolumns = $('#totalcolumns'),
        columns = $totalcolumns.val();

    if(columns == null) {
        alert('Choose aleast one Column!');
        return false;
    }

    var $checkedColumn = $('input[type=radio][name=summationColumns]:checked');
    if($checkedColumn.length == 0) {
        alert('Summation Column is Required!');
        return false;
    }

    var selColumn = $checkedColumn.val(),
        total = $checkedColumn.data('total');


    var key = $HandsonWrapper.data('rowid'),
        el_type = $HandsonWrapper.data('type'),
        data = filterArray(handsonTable.getData()),
        jsonData = JSON.stringify(data);
    if(jsonData == '[]')
        jsonData = '[[]]';

    $('#'+el_type+'Measurement_' + key).val(jsonData);
    $('#'+el_type+'Qty_' + key).val(total).trigger('change');
    $('#'+el_type+'CellName_' + key).val(selColumn);
    $('#'+el_type+'SelectedColumns_' + key).val(columns.join());
    $HandsonWrapper.hide();
    $formWrapper.fadeIn();
}

function hideHandsonWrapper(){
    $HandsonWrapper.hide();
    $formWrapper.fadeIn();
}
// Filter all empty rows
function filterArray(arr) {
    var checkNull = true;
    arr =  $.grep($(arr).toArray().reverse(), function (n,i) {
        var isValid = false;

        if(!checkNull)
            return true;

        $.each(n, function(j,obj) {
            if(obj != null) {
                isValid = true;
                checkNull = false;
                return false;
            }
        });

        return isValid;
    });
    return arr.reverse();
}

function getExcelTemplate(x) {
    var templateId = $(x).val();
    $.ajax({
        url:getBaseURL()+ 'clientbilling/index/getexceltemplate',
        type:"post",
        data: {'TemplateId': templateId},
        async: false,
        success:function(data, textStatus, jqXHR){
            if(data != '') {
                var json_data = $.parseJSON(data);
                handsonTableData = $.parseJSON(json_data.Description);
                selColumns = ($.trim(json_data.SelectedColumns)).split(',');
                summationColumn = json_data.CellName;
            } else {
                handsonTableData = [[]];
                selColumns = [];
                summationColumn = '';
            }

            renderHandsonTable();
        }, error:function(jqXHR, textStatus, errorThrown){
            return false;
        }
    });
}

function renderHandsonTable() {
    if(typeof handsonTableData != 'object')
        handsonTableData  = [[]];

    handsonTable.loadData(handsonTableData);
    handsonTable.render();

    summationColumns();
}

function summationColumns(calcOnly) {
    if(handsonTable == null)
        return;

    var $totalColumns = $('#totalcolumns'),
        rowCount = handsonTable.countRows();

    if(typeof calcOnly == 'undefined') {
        //set columns header
        var options = '';
        $.each(handsonTable.getDataAtRow (0), function (i, obj) {
            var value = $.trim(obj),
                sel = '';
            if (value.length == 0 || value == "" || value.indexOf('=') != -1)
                return;

            var colName = handsonTable.getColHeader(i);
            if($.inArray(colName, tempSelectedCol) != -1 || $.inArray(colName, selColumns) != -1)
                sel = 'selected';

            options += '<option value="' + colName + '" '+sel +'>' + value + '</option>';
        });
        $totalColumns.html(options).triggerHandler('change');
    }

    // calculate columns
    var arr_columns = $totalColumns.find(':selected');
    if(arr_columns.length == 0) {
        $('#summationColumnsWrapper').html('');
        return;
    }

    // selected summation columns
    tempSelectedCol = [];
    var totalLabels = '';
    $.each(arr_columns, function(i, obj) {
        var $this = $(this),
            col = $this.val(),
            columnData = handsonTable.plugin.helper.cellRangeValue(col+'1',col+ rowCount),
            total = 0;

        // push to temp sel col
        tempSelectedCol.push(col);

        // selected columns datas
        $.each(columnData[0], function(j, val) {
            if(/^[0-9\.]+$/.test(val) == false)
                return;

            total += parseFloatVal(val);
        });

        if(total == '')
            total = 0;

        if(col == summationColumn) {
            totalLabels += '<label class="btn btn-primary tot-dis active">'
            + '<input type="radio" name="summationColumns" autocomplete="off" value="'+col+'" data-total="'+total+'" checked><label>'+ $this.html() +' </label><p>'+total+'</p>'
            + '</label>';
        } else {
            totalLabels += '<label class="btn btn-primary tot-dis">'
            + '<input type="radio" name="summationColumns" autocomplete="off" value="'+col+'" data-total="'+total+'"><label>'+ $this.html() +' </label><p>'+total+'</p>'
            + '</label>';
        }
    });
    $('#summationColumnsWrapper').html(totalLabels);
}

function calcSetMobAdvRecovery() {
    var $input = $('input[id^=BillFormatId_][value=5]');
    if($input.length == 0)
        return false;

    var key = $input[0].id.split('_')[1],
        forumula  = $.trim($('#Formula_' + key).val());
    if(forumula.length == 0)
        return false;

    var rows = $('#entryrowid').val();
    for (var j = rows; j >= 1; j--) {
        var sRef = $('#RowName_' + j).html().trim(),
            dAmt = parseFloatVal($('#CurAmount_' + j).val());

        if(sRef != '')
            forumula = forumula.replace(new RegExp(sRef, 'gi'), dAmt);
    }
    $('#CurAmount_' + key).val(sanitizeNumber(computeEval(forumula),2,true,true));
}

$(function () {
    $('.highlightTable').on( 'focus', 'tbody:not(.total) tr input,textarea', function () {
        var $this = $(this);
        $('tr.highlighted').removeClass("highlighted");
        $this.closest('tr').addClass('highlighted');
    });
});
</script>