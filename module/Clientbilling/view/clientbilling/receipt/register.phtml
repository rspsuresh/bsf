<!--STYLE-->
<link rel="stylesheet" href="<?php echo $this->basePath() . '/css/workorder.css';?>"/>
<style>
    .pagination-lg > li > a, .pagination-lg > li > span {
        font-size:15px !important;
        padding:5px 15px !important;
    }
	
	#treeGrid .jqx-grid-header 	{
		height:75px !important;
	}
</style>
<?php echo $this->headScript()
    ->appendFile($this->basePath() . '/library/amcharts/amcharts.js')
    ->appendFile($this->basePath() . '/library/amcharts/pie.js')
    ->appendFile($this->basePath() . '/library/amcharts/serial.js')
    ->appendFile($this->basePath() . '/library/amcharts/themes/light.js');
?>
<div class="content_wrapper padlr0">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-12 top-btm">
                <h1>Receipt Register</h1>
            </div>
            <div class="col-lg-12 top_ct">
                <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0 clear">
                	<div class="col-lg-12 clear padlr0">
                        <div class="col-lg-3 col-md-6 col-sm-6 col-xs-6 mnimumwidthres">
                            <div class="cbpln cbpln-default bx-wte cbpln-status cbpln-status3">
                                <div class="padding-none">
                                    <div class="row">
                                        <div class="col-xs-3">
                                            <i class="fa fa-thumbs-up fa-5x cbpln-status-icon"></i>
                                        </div>
                                        <div class="col-xs-9 text-right">
                                            <div class="cbhuge comnelips fntwt600"><?php echo (isset($submitvalue)) ? 'Rs.'.$this->commonHelper()->sanitizeNumber($submitvalue['submitAmount'],2,true) : '';?></div>
                                            <div class="cbhuge comnelips">Bill Submitted</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-6 col-xs-6 mnimumwidthres">
                            <div class="cbpln cbpln-default bx-wte cbpln-status cbpln-status4">
                                <div class="padding-none">
                                    <div class="row">
                                        <div class="col-xs-3">
                                            <i class="fa fa-certificate fa-5x cbpln-status-icon"></i>
                                        </div>
                                        <div class="col-xs-9 text-right">
                                            <div class="cbhuge comnelips fntwt600"><?php echo (isset($certifyvalue)) ? 'Rs.'.$this->commonHelper()->sanitizeNumber($certifyvalue['certifyAmount'],2,true) : '';?></div>
                                            <div class="cbhuge comnelips">Bill Certified</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-6 col-xs-6 mnimumwidthres">
                            <div class="cbpln cbpln-default  bx-wte cbpln-status cbpln-status1">
                                <div class="padding-none">
                                    <div class="row">
                                        <div class="col-xs-3">
                                            <i class="fa fa-retweet fa-5x cbpln-status-icon"></i>
                                        </div>
                                        <div class="col-xs-9 text-right">
                                            <div class="cbhuge comnelips fntwt600"><?php echo (isset($retvalue)) ? 'Rs.'.$this->commonHelper()->sanitizeNumber($retvalue['Amount'],2,true) : '';?></div>
                                            <div class="cbhuge comnelips">Retention/Withheld</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-6 col-xs-6 mnimumwidthres">
                            <div class="cbpln cbpln-default  bx-wte cbpln-status cbpln-status2">
                                <div class="padding-none">
                                    <div class="row">
                                        <div class="col-xs-3">
                                            <i class="fa fa-check-square-o fa-5x cbpln-status-icon"></i>
                                        </div>
                                        <div class="col-xs-9 text-right">
                                            <div class="cbhuge comnelips fntwt600"><?php echo (isset($receivedvalue)) ? 'Rs.'.$this->commonHelper()->sanitizeNumber($receivedvalue['receiptAmount'],2,true) : '0';?></div>
                                            <div class="cbhuge comnelips">Payment Received</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-12 clear padlr0">
                        <div class="col-lg-3 col-md-6 col-sm-6 col-xs-6 mnimumwidthres ">
                            <div class="cbpln cbpln-default  bx-wte cbpln-status cbpln-status5">
                                <div class="padding-none">
                                    <div class="row">
                                        <div class="col-xs-3">
                                            <i class="fa fa-registered fa-5x cbpln-status-icon"></i>
                                        </div>
                                        <div class="col-xs-9 text-right">
                                            <div class="cbhuge comnelips fntwt600"><?php echo (isset($advancevalue)) ? 'Rs.'.$this->commonHelper()->sanitizeNumber($advancevalue['Amount'],2,true) : '';?></div>
                                            <div class="cbhuge comnelips">Advance Received</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-6 col-xs-6 mnimumwidthres ">
                            <div class="cbpln cbpln-default  bx-wte cbpln-status cbpln-status6">
                                <div class="padding-none">
                                    <div class="row">
                                        <div class="col-xs-3">
                                            <i class="fa fa-gavel fa-5x cbpln-status-icon"></i>
                                        </div>
                                        <div class="col-xs-9 text-right">
                                            <div class="cbhuge comnelips fntwt600"><?php echo (isset($advancedeductvalue)) ? 'Rs.'.$this->commonHelper()->sanitizeNumber($advancedeductvalue['Amount'],2,true) : '';?></div>
                                            <div class="cbhuge comnelips">Advance Deducted</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-6 col-xs-6 mnimumwidthres ">
                            <div class="cbpln cbpln-default bx-wte cbpln-status cbpln-status7">
                                <div class="padding-none">
                                    <div class="row">
                                        <div class="col-xs-3">
                                            <i class="fa fa-usd fa-5x cbpln-status-icon"></i>
                                        </div>
                                        <div class="col-xs-9 text-right">
                                            <?php $totAmt = (isset($advancevalue) && (isset($advancedeductvalue))) ? (double)$advancevalue['Amount']-(double)$advancedeductvalue['Amount'] : 0; ?>
                                            <div class="cbhuge comnelips fntwt600">Rs.<?php echo $this->commonHelper()->sanitizeNumber(abs((double)$totAmt),2,true);?></div>
                                            <div class="cbhuge comnelips">Advance Payable</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-6 col-xs-6 mnimumwidthres ">
                            <div class="cbpln cbpln-default bx-wte cbpln-status cbpln-status8">
                                <div class="padding-none">
                                    <div class="row">
                                        <div class="col-xs-2">
                                            <i class="fa fa-share fa-5x cbpln-status-icon"></i>
                                        </div>
                                        <div class="col-xs-10 text-right">
                                            <?php $paymentReceivable = ((double)$certifyvalue['certifyAmount']+(double)$retvalue['Amount']) - (double) $receivedvalue['receiptAmount'];?>
                                            <div class="cbhuge comnelips fntwt600"><?php echo 'Rs.'.$this->commonHelper()->sanitizeNumber($paymentReceivable,2,true); ?></div>
                                            <div class="cbhuge comnelips">Payment Receivable</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="clearfix"></div>
                <div class="col-lg-12 col-lg-offset-0 tmss">
                    <div class="table-responsive clear">
                        <div id="treeGrid"> </div>
                    </div>
                </div>
                <div class="clearfix"></div>
                <div class="col-lg-12 commargin_ttop_20">
                    <section class="pnnal">
                        <header class="pnnal-heading"><i class="fa fa-pie-chart"></i> Client wise Receipts </header>
                        <div class="pnnal-body">
                            <div id="cbfrstchartdiv"></div>
                        </div>
                    </section>
                </div>
                <div class="col-lg-12 commargin_ttop_20">
                    <section class="pnnal">
                        <header class="pnnal-heading"><i class="fa fa-line-chart"></i> Payment Received</header>
                        <div class="pnnal-body">
                            <div id="cbsecchartdiv"></div>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="DeleteModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header"> 
            	<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            	<h1>Why do you want to delete Receipt No : <span id="delEntryName" class="bld-txt"></span>?</h1>
            </div>
            <div class="modal-body">
            	<div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1 col-sm-10 col-sm-offset-1">
            		<form class="form-horizontal">
                    <div class="row m_tb40">
                        <div class="form-group col-lg-12 req_flds">
                            <textarea id="remarks" maxlength="250" class="form-control lbl_move" label="Remarks"/></textarea>
                        </div>
                    </div>
            		</form>
            	</div>
            </div>
            <div class="modal-footer clear">
                <div class="col-lg-12 savebtn_area no_border">
                    <ul>
                        <li class="save_btn float_r">
                            <a href="javascript:void(0);" id="btnDeleteYes" class="ripple">Delete</a>
                        </li>
                        <li class="cancel_btn float_r"><a href="javascript:void(0);" aria-hidden="true" data-dismiss="modal" class="ripple">Cancel</a></li>
                    </ul>
                </div>
			</div>
        </div>
    </div>
</div>

<script type="text/javascript">
    var data = <?php echo (isset($receipts)) ? json_encode($receipts) : ''?>,
        $treeGrid = $("#treeGrid"),
        $deleteModal = $('#DeleteModal'),
        $remarks = $('#remarks');
    $(function () {
        var source = {
            localdata:data,
            dataType: "json",
            dataFields: [
                { name: 'ReceiptId', type: 'number' },
                { name: 'WORegisterId', type: 'number' },
                { name: 'ReceiptNo', type: 'string' },
                { name: 'ReceiptDate', type: 'string' },
                { name: 'ClientName', type: 'string' },
                { name: 'CostCentreName', type: 'string' },
                { name: 'ReceiptMode', type: 'string' },
                { name: 'ReceiptAgainst', type: 'string' },
//                { name: 'TransactionNo', type: 'string' },
//                { name: 'TransactionDate', type: 'string' },
//                { name: 'TransactionRemarks', type: 'string' },
                { name: 'Amount', type: 'string' }
            ],
            id: 'ReceiptId'
        };

        var dataAdapter = new $.jqx.dataAdapter(source);
        $treeGrid.jqxGrid({
            width: "100%",
            source: dataAdapter,
            sortable: true,
            pagerButtonsCount: 6,
            showfilterrow: true,
            filterable: true,
            pageable:true,
            rowDetails: true,
            autoheight: true,
            selectionmode: 'singlerow',
            editable: false,
            altrows: true,
            enabletooltips: true,
            columns: [
                { text: 'ReceiptId', datafield: 'ReceiptId', hidden: true, filterable: false},
                { text: 'WORegisterId', datafield: 'WORegisterId', hidden: true, filterable: false},
                { text: 'Receipt No.', dataField: 'ReceiptNo',width:'10%'},
                { text: 'Date', dataField: 'ReceiptDate',width:'8%'},
                { text: 'Client Name', dataField: 'ClientName', width:'19%'},
                { text: 'Cost Centre', dataField: 'CostCentreName', width:'19%'},
                { text: 'Receipt Mode', dataField: 'ReceiptMode',width:'12%'},
                { text: 'Against', dataField: 'ReceiptAgainst', width:'12%',
                    cellsrenderer: function (row) {
                        var type = 'N/A';
                        switch ($treeGrid.jqxGrid('getCellValue', row, 'ReceiptAgainst')) {
                            case 'B':
                                type = 'Bill';
                                break;
                            case 'A':
                                type = 'Adhoc Advance';
                                break;
                            case 'O':
                                type = 'Others';
                                break;
                            case 'M':
                                type = 'Mobilization Advance';
                                break;
                            case 'R':
                                type = 'Retention';
                                break;
                            case 'W':
                                type = 'Withheld';
                                break;
                            default:
                                type = 'N/A';
                                break;
                        }
                        return '<div style="overflow: hidden; text-overflow: ellipsis; margin-right: 2px; margin-left: 10px; margin-top: 9.5px;">' + type + '</div>';
                    }
                },
                { text: 'Amount', dataField: 'Amount',width:'10%', cellsalign: 'right',
                    cellsrenderer: function (row) {
                        return '<div class="text-right" style="overflow: hidden; text-overflow: ellipsis; margin-right: 2px; margin-left: 10px; margin-top: 9.5px;">' + sanitizeNumber($treeGrid.jqxGrid('getCellValue', row, 'Amount'),2,true) + '</div>';
                    }},
                { text: 'Action', sortable: false, filterable: false, align: 'left', width:'10%',
                    cellsrenderer: function (row) {
                        var ReceiptAgainst = $treeGrid.jqxGrid('getCellValue', row, 'ReceiptAgainst'),
                            ReceiptId = $treeGrid.jqxGrid('getCellValue', row, 'ReceiptId'),
                            WORegisterId = $treeGrid.jqxGrid('getCellValue', row, 'WORegisterId'),
                            editLink = '<a title="Edit" href="'+ getBaseURL() + 'clientbilling/receipt/index/'+ReceiptId+'/edit" style="padding-left: 15px; margin-top:8px;"><i class="fa fa-pencil-square-o reg-icon"></i></a>';
							editLink += "&nbsp;&nbsp;" + '<button style="background: transparent;" title="Delete" onclick="receiptDelete('+row+')"><i class="fa fa-trash-o reg-icon"></i></button>';
						return editLink += "&nbsp;&nbsp;" + '<a title="Report" href="'+ getBaseURL() + 'clientbilling/report/receiptdetreport/'+ReceiptId+'"><i class="fa fa-file-text-o reg-icon-file"></i></a>';
                    }
                }
            ]
        });

        $('#btnDeleteYes').on('click', function () {
            var remarks = $remarks.val();
            if(remarks.length == 0) {
                showError($remarks, 'Required!');
                return;
            } else
                removeError($remarks);

            $deleteModal.modal('hide');
            var rowData = $treeGrid.jqxGrid('getrowdata', $deleteModal.data('row'));
            $.ajax({
                url: getBaseURL() + 'clientbilling/receipt/deletereceipt',
                type: 'POST',
                data: {"ReceiptId": rowData.ReceiptId, "Remarks": remarks},
                success:function(data, textStatus, jqXHR){
                    if (jqXHR.status == 200)
                        $treeGrid.jqxGrid("deleterow", rowData.uid);
                    else
                        alert('Failed to delete the receipt!');
                },
                error:function(jqXHR, textStatus, errorThrown){
                    if (jqXHR.status == 403)
                        alert(jqXHR.responseText);
                    else
                        alert('Failed to delete the receipt!');
                }
            });
            $remarks.val('');
        });
    });

    function receiptDelete(row) {
		var rowData = $treeGrid.jqxGrid('getrowdata', row);
        $deleteModal.data('row', row).modal('show');
		$('#delEntryName').html(rowData.ReceiptNo);
		$("#remarks").val('');
    }

    var clientReceipts = <?php echo $clientreceipts;?>;
    var chart1 = AmCharts.makeChart("cbfrstchartdiv", {
        "type": "pie",
        "theme": "light",
        "innerRadius": "40%",
        "gradientRatio": [-0.4, -0.4, -0.4, -0.4, -0.4, -0.4, 0, 0.1, 0.2, 0.1, 0, -0.2, -0.5],
        "dataProvider": clientReceipts,
        "balloonText": "[[value]]",
        "valueField": "Amount",
        "titleField": "ClientName",
        "balloon": {
            "drop": true,
            "adjustBorderColor": false,
            "color": "#FFFFFF",
            "fontSize": 16
        }
    });

    var chart2 = AmCharts.makeChart("cbsecchartdiv", {
        "theme": "light",
        "type": "serial",
        "marginRight": 80,
        "autoMarginOffset": 20,
        "marginTop":20,
        "dataProvider": <?php echo $monreceipt;?>,
        "valueAxes": [{
            "id": "v1",
            "axisAlpha": 0.1
        }],
        "graphs": [{
            "useNegativeColorIfDown": true,
            "balloonText": "[[category]]<br><b>value: [[value]]</b>",
            "bullet": "round",
            "bulletBorderAlpha": 1,
            "bulletBorderColor": "#FFFFFF",
            "hideBulletsCount": 50,
            "lineThickness": 2,
            "lineColor": "#fdd400",
            "negativeLineColor": "#67b7dc",
            "valueField": "Amount"
        }],
        "chartCursor": {
            "valueLineEnabled": true,
            "valueLineBalloonEnabled": true
        },
        "categoryField": "Mondata",
        "categoryAxis": {
            "axisAlpha": 0,
            "minHorizontalGap": 60
        }
    });
</script>
