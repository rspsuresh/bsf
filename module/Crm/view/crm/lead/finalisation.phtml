<?php
function nonZeroNumber($number) {
    if(!isset($number) || !is_numeric($number) || $number <= 0) {
        return '';
    } else {
        return round($number, 2);
    }
}
?>
<link rel="stylesheet" type="text/css" href="<?php echo $this->basePath(); ?>/css/project.css" />
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/js/select2.full.min.js"></script>
<link type="text/css" rel="stylesheet" href="<?php echo $this->basePath(); ?>/css/select2.min.css"/>
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/js/bootstrap-datetimepicker.min.js"></script>
<link rel="stylesheet" href="<?php echo $this->basePath() . '/css/bootstrap-datetimepicker.min.css';?>"/>
<link rel="stylesheet" href="<?php echo $this->basePath(); ?>/css/workorder.css"/>
<style type="text/css">
    .downarrow_span	 				{float:right; padding:0px 5px;}
    .downarrow_span span	 		{font-size:18px;}
    .downarrow_span_div				{display:none;}
    .downarrow_span_div.open		{display:block;}
    .totalright{font-weight:600; color:green; font-size:14px;}
</style>
<script id="coApp-row"  type="text/template" class="hide">
    <div class="form-group padtop10 empty-coApp coApp__">
        <input type="text" name="coApp_name__" id="coApp_name__" onkeypress="addNewRow(this);" class="form-control lbl_move"
               placeholder="Co-Applicant--" value=""/>
    </div>
</script>
<div class="content_wrapper padlr0">
    <div class="container-fluid padlr0">
        <div class="col-lg-12">
            <h1>Finalisation</h1>
        </div>
        <div class="col-lg-12 clear">
            <div class="col-lg-12 clear">
                <div class="kickoff_area col-lg-12 clear">
                    <div class="col-lg-12 clear padlr0">
                        <div class="col-lg-12 col-md-12 col-sm-12 cnt_sliders padlr0">
                            <?php if(isset($leadId) || isset($unitBooking)|| isset($saveproj)): ?>
                                <form id="finalisation-form" method="post">
                                    <input type="hidden" name="booking_id" id="booking_id" value="<?php echo (isset($unitBooking)) ? $unitBooking['BookingId'] : '0'; ?>">
                                    <input type="hidden" name="mode" id="mode" value="<?php echo (isset($mode)) ? $mode : 'add'; ?>">
                                    <input type="hidden" name="csrf" value="<?php echo isset($csrf) ? $csrf : ''; ?>">
                                    <input type="hidden" name="lead_id" id= "lead_id" value="<?php echo (isset($leadId))?$leadId:''; ?>">
                                    <input type="hidden" name="CallTypeId" value="<?php if(isset($CallTypeId)){ echo $CallTypeId ;}?>">
                                    <input type="hidden" name="checkreceipt" id= "checkreceipt" value="">
                                    <div id="carousel" class="carousel slide" data-ride="carousel">
                                        <!-- Wrapper for slides -->
                                        <div class="carousel-inner" role="listbox">
                                            <!--step 1-->
                                            <div class="item active" id="arrow">
                                                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
                                                    <div class="">
                                                        <label for="booking_no" class="bk_lbl bk_lbl_inpt">Booking No <span class="colon_r">:</span></label>
                                                        <input type="text" class="bk_lbl_inpt bk_inpt1" name="booking_no" id="booking_no" value="<?php echo (isset($unitBooking)) ? $unitBooking['BookingNo'] : $svNo; ?>" <?php echo ($genType) ? 'readonly' : '';?> />
                                                    </div>
                                                </div>
                                                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
                                                    <div class="col-lg-offset-1">
                                                        <label for="booking_date" class="bk_lbl bk_lbl_inpt"><span class="bkspan_calendar"><i class="fa fa-calendar-o"></i></span> Booking Date <span class="colon_r">:</span></label>
                                                        <input type="text" class="date_picker bk_lbl_inpt bk_inpt" name="booking_date" id="booking_date" value="<?php echo (isset($BookingDate))?$BookingDate: ''; echo (isset($unitBooking)) ? date('d-m-Y', strtotime($unitBooking['BookingDate'])) : ''; echo (!isset($unitBooking) && !isset($BookingDate)) ? date('d-m-Y') : '';?>" disabled />
                                                    </div>
                                                </div>
                                                <div class="col-lg-6 m_tb10 clear">
                                                    <div class="col-lg-8 col-lg-offset-2">
                                                        <div class="row">
                                                            <div class="form-group m_top20 col-lg-12 padtop20">
                                                                <?php  if(isset($result)){ ?>
                                                                    <input type="text" name="lead_name" class="form-control lbl_move"  data-bsfshare="LeadName" label="Select Lead" value="<?php echo $result['LeadName']; ?>" disabled>
                                                                    <input type="hidden" name="leadid" id="leadid" value="<?php echo $result['LeadId']; ?>">
                                                                <?php } else {?>
                                                                    <select id="leadid" name="leadid" class="form-control single_dropdown lbl_move" label="Select Lead..."style="width:100%;">
																	<option value=""></option>
                                                                    <?php foreach($resultLeads as $type){?>
                                                                    <option value="<?php echo $type['LeadId']; ?>"><?php echo $type['LeadName']; ?></option>
                                                                  <?php  }?>
                                                                </select>
                                                                <?php }?>
                                                            </div>
															<div class="form-group col-lg-12 padtop20">
                                                                <?php  if(isset($unitBooking)){?>
                                                                    <input type="text" name="project_name" class="form-control lbl_move"  data-bsfshare="ProjectName" label="Project Name" value="<?php echo $unitBooking['ProjectName']; ?>" disabled>
                                                                    <input type="hidden" name="project_id" id="project_id" value="<?php echo $unitBooking['ProjectId']; ?>">
                                                                    <?php }
                                                                    else if(isset($saveproj)){  ?>
                                                                    <input type="text" name="project_name" class="form-control lbl_move"  data-bsfshare="ProjectName" label="Project Name" value="<?php echo $saveproj['ProjectName']; ?>" disabled>
                                                                    <input type="hidden" name="project_id" id="project_id" value="<?php echo $saveproj['ProjectId']; ?>">
                                                                     <?php } else {   ?>
                                                                    <select id="project_id" name="project_id" class="form-control single_dropdown lbl_move" label="Select Project..." style="width:100%;">
                                                                        <option value=""></option>
                                                                        <?php if (isset($arrProjects)): ?>
                                                                            <?php foreach ($arrProjects as $project): ?>
                                                                                <option value="<?php echo $project['ProjectId']; ?>"><?php echo $project['ProjectName']; ?></option>
                                                                            <?php endforeach; ?>
                                                                        <?php endif; ?>
                                                                    </select>
                                                                <?php }?>


                                                                </div>
                                                            <div id="unitno-wrapper" class="form-group col-lg-12 padtop20 animated fadeInUp <?php echo (!isset($unitBooking)) ? 'hide' : ''?>">
                                                                <?php if(isset($unitBooking)){ ?>
                                                                    <input type="text" name="unit_no" class="form-control lbl_move" data-bsfshare="UnitNo" label="Unit No" value="<?php echo $unitBooking['UnitNo']; ?>" disabled>
                                                                    <input type="hidden" name="unit_id" id="unit_id" value="<?php echo $unitBooking['UnitId']; ?>">
                                                                    <?php } else if(isset($saveproj)){?>

                                                                    <input type="text" name="unit_no" class="form-control lbl_move"  data-bsfshare="UnitNo" label="Unit No" value="<?php echo $saveproj['UnitNo']; ?>" disabled>
                                                                    <input type="hidden" name="unit_id" id="unit_id" value="<?php echo $saveproj['UnitId']; ?>">

                                                                    <?php } else { ?>
                                                                    <select id="unit_no" name="unit_no" class="form-control single_dropdown lbl_move" label="Select Unit No..." style="width:100%;"></select>
                                                                <?php }?>
                                                            </div>
                                                            <div id="buyer-wrapper" class="form-group col-lg-12 animated fadeInUp <?php if(isset($unitBooking) || isset( $saveproj)){ echo '';} else {echo 'hide';} ?>">
                                                                <div class="radio_check col-lg-11 col-lg-offset-1 col-md-8 col-md-offset-2">
                                                                    <p class="col-lg-6">
                                                                        <input type="radio" name="buyer_investor" id="buyer" value="B" <?php echo (isset($unitBooking) && $unitBooking['CustomerType'] == 'B')?'checked':''; echo (!isset($unitBooking)) ?  'checked' : '';?>>
                                                                        <label for="buyer">Buyer</label>
                                                                    </p>
                                                                    <p class="col-lg-6">
                                                                        <input type="radio" name="buyer_investor" id="investor" value="I" <?php echo (isset($unitBooking) && $unitBooking['CustomerType'] == 'I')?'checked':'';?>>
                                                                        <label for="investor">Investor</label>
                                                                    </p>
                                                                </div>
                                                            </div>
                                                            <div id="unitprice-wrapper" class="form-group col-lg-12 padtop10 animated fadeInUp clear <?php if(isset($unitBooking) || isset( $saveproj)){ echo '';} else {echo 'hide';} ?>">
                                                                <input type="text" name="unit_rate" id="unit_rate" class="form-control lbl_move" label="Unit Rate (Per Sq.ft)" readonly value="<?php echo (isset($unitBooking)) ? $unitBooking['Rate'] : ''; ?>"/>
                                                            </div>

                                                            <div id="other_cost_wrapper" class="form-group col-lg-12 clear <?php if(isset($unitBooking) || isset( $saveproj)){ echo '';} else {echo 'hide';} ?>">
                                                                <select name="OtherCost[]" id="OtherCost" class="form-control multiple_dropdown lbl_move"  multiple="multiple" label="Select OtherCost" style="width:100%;"></select>
                                                            </div>
                                                            <div id="predis-wrapper" class="form-group col-lg-12 clear" style="display:none;" >
                                                                <input type="text" name="prediscount" id="prediscount" class="form-control lbl_move" readonly
                                                                       label="Previous Discount" onkeypress="return isDecimal(event, this)"/>
                                                            </div>
                                                            <div id="discount_based_wrapper" class="form-group col-lg-12 clear <?php if(isset($unitBooking) || isset( $saveproj)){ echo '';} else {echo 'hide';} ?>">
                                                                <label class="txt_left control-label">Discount based on</label>
                                                                <div class="radio_check col-lg-11 col-lg-offset-1 col-md-8 col-md-offset-2">
                                                                    <p class="col-lg-4">
                                                                        <input type="radio" name="discount_based" id="normal" value="N" <?php echo (isset($unitBooking) && $unitBooking['DiscountBased'] == 'N')?'checked':''; echo (!isset($unitBooking)) ? 'checked' : '';?> >
                                                                        <label for="normal">Normal</label>
                                                                    </p>
                                                                    <p class="col-lg-4">
                                                                        <input type="radio" name="discount_based" id="plan" value="P" <?php echo (isset($unitBooking) && $unitBooking['DiscountBased'] == 'P')?'checked':''; ?>>
                                                                        <label for="plan">Plan</label>
                                                                    </p>
                                                                    <p class="col-lg-4">
                                                                        <input type="radio" name="discount_based" id="referal" value="R" <?php echo (isset($unitBooking) && $unitBooking['DiscountBased'] == 'N' && $unitBooking['ReferalType'] !='')?'checked':''; ?>>
                                                                        <label for="referal">Referal</label>
                                                                    </p>
                                                                </div>
                                                            </div>
                                                            <div id="plan-list-wrapper" class="form-group col-lg-12 padtop10 clear" <?php if(isset($unitBooking)) { if($unitBooking['DiscountBased']=='P') { echo "style='display:block;'"; } else { echo "style='display:none;'"; } } ?><?php echo (!isset($unitBooking)) ? 'style="display:none;"' : ''?>>
                                                                <select id="plan_list" name="plan_list" class="form-control single_dropdown lbl_move"
                                                                        label="Select Plan" style="width:100%;" onchange="planDetails($(this).val());">
                                                                    <option value=""></option>
                                                                    <?php if(isset($planList)) {
                                                                        foreach ($planList as $planDetails) { ?>
                                                                            <option value="<?php echo $planDetails['PlanId']; ?>" ><?php echo $planDetails['PlanName']; ?></option>
                                                                        <?php }
                                                                    }?>
                                                                </select>
                                                            </div>
                                                            <div id="divreferalType" class="form-group col-lg-12 padtop10 clear" <?php if(isset($unitBooking)) { if($unitBooking['ReferalType']!='') { echo "style='display:block;'"; } else { echo "style='display:none;'"; } } ?><?php echo (!isset($unitBooking)) ? 'style="display:none;"' : ''?>>
                                                                <label class="txt_left control-label">Referal Type</label>
                                                                <div class="radio_check col-lg-11 col-lg-offset-1 col-md-8 col-md-offset-2">
                                                                    <p class="col-lg-6">
                                                                        <input type="radio" name="referalType" id="Buyer" value="B" <?php echo (isset($unitBooking) && $unitBooking['ReferalType'] == 'B')?'checked':''; ?><?php echo (!isset($unitBooking)) ? 'checked' : '';?>>
                                                                        <label for="Buyer">Buyer</label>
                                                                    </p>
                                                                    <p class="col-lg-6">
                                                                        <input type="radio" name="referalType" id="Employee" value="E" <?php echo (isset($unitBooking) && $unitBooking['ReferalType'] == 'E')?'checked':''; ?>>
                                                                        <label for="Employee">Employee</label>
                                                                    </p>
                                                                </div>
                                                            </div>
                                                            <div id="divBuyer" class="form-group col-lg-12 padtop10 clear" <?php if(isset($unitBooking)) { if($unitBooking['ReferalType']=='B') { echo "style='display:block;'"; } else { echo "style='display:none;'"; } } ?><?php echo (!isset($unitBooking)) ? 'style="display:none;"' : ''?>>
                                                                <select id="buyerName" name="buyerName" onchange="showNormal()" class="form-control single_dropdown lbl_move"
                                                                        label="Select Buyer" style="width:100%;" >
                                                                    <option value=""></option>
                                                                    <?php if(isset($buyerList)) {
                                                                        foreach ($buyerList as $buyerDetails) { ?>
                                                                            <option value="<?php echo $buyerDetails['BuyerId']; ?>" <?php if(isset($unitBooking)) { if($unitBooking['ReferalTypeId']==$buyerDetails['BuyerId']) { echo "selected"; } else { echo ""; } } ?> ><?php echo $buyerDetails['LeadName'].' - '.$buyerDetails['Mobile']; ?></option>
                                                                        <?php }
                                                                    }?>
                                                                </select>
                                                            </div>
                                                            <div id="divEmployee" class="form-group col-lg-12 padtop10 clear" <?php if(isset($unitBooking)) { if($unitBooking['ReferalType']=='E') { echo "style='display:block;'"; } else { echo "style='display:none;'"; } } ?><?php echo (!isset($unitBooking)) ? 'style="display:none;"' : ''?>>
                                                                <select id="employeeName" name="employeeName" onchange="showNormal()" class="form-control single_dropdown lbl_move"
                                                                        label="Select Employee" style="width:100%;" >
                                                                    <option value=""></option>
                                                                    <?php if(isset($employeeList)) {
                                                                        foreach ($employeeList as $employeeDetails) { ?>
                                                                            <option value="<?php echo $employeeDetails['UserId']; ?>" <?php if(isset($unitBooking)) { if($unitBooking['ReferalTypeId']==$employeeDetails['UserId']) { echo "selected"; } else { echo ""; } } ?> ><?php echo $employeeDetails['EmployeeName'].' - '.$employeeDetails['Mobile']; ?></option>
                                                                        <?php }
                                                                    }?>
                                                                </select>
                                                            </div>
                                                            <div id="discount-type-wrapper" class="form-group col-lg-12 padtop10 animated fadeInUp clear <?php if(isset($unitBooking) || isset( $saveproj)){ echo '';} else {echo 'hide';} ?>">
                                                                <select id="discount_type" name="discount_type" class="form-control single_dropdown lbl_move plan_disabled"
                                                                        label="Select Discount Type" style="width:100%;">
                                                                    <option value=""></option>
                                                                    <option value="R" <?php echo (isset($unitBooking) && trim($unitBooking['DiscountType']) == 'R')?'selected':''; ?>>Rate/Sq.ft</option>
                                                                    <option value="L" <?php echo (isset($unitBooking) && trim($unitBooking['DiscountType']) == 'L')?'selected':''; ?>>Lumpsum</option>
                                                                    <option value="P" <?php echo (isset($unitBooking) && trim($unitBooking['DiscountType']) == 'P')?'selected':''; ?>>Percentage</option>
                                                                </select>
                                                            </div>
                                                            <div id="lumpsum-type-wrapper" class="form-group col-lg-12 padtop10 animated fadeInUp clear <?php echo (isset($unitBooking) && $unitBooking['DiscountType'] != 'L' && $unitBooking['DiscountType'] != 'P')?'hide':''; ?><?php echo (!isset($unitBooking)) ? 'hide' : ''?>">
                                                                <div class="radio_check col-lg-11 col-lg-offset-1 col-md-8 col-md-offset-2">
                                                                    <p class="col-lg-6">
                                                                        <input type="radio" class="plan_disabled" name="lumpsum_type" id="lumpsum_type_overall" value="O" <?php echo (isset($unitBooking) && $unitBooking['LumpsumReceiptId'] == 0)?'checked':''; ?>>
                                                                        <label for="lumpsum_type_overall">OverAll</label>
                                                                    </p>

                                                                    <p class="col-lg-6">
                                                                        <input type="radio" class="plan_disabled" name="lumpsum_type" id="lumpsum_type_receiptwise" value="R" <?php echo (isset($unitBooking) && $unitBooking['LumpsumReceiptId'] != 0)?'checked':''; ?>>
                                                                        <label for="lumpsum_type_receiptwise">Receipt wise</label>
                                                                    </p>
                                                                </div>
                                                            </div>
                                                            <div id="lumpsum-receipt-wise-wrapper" class="form-group col-lg-12 padtop10 animated fadeInUp clear <?php echo (isset($unitBooking) && $unitBooking['LumpsumReceiptId'] == 0)?'hide':''; ?><?php echo (!isset($unitBooking)) ? 'hide' : ''?>">
                                                                <select id="lumpsum_receipt_wise" name="lumpsum_receipt_wise" class="form-control single_dropdown lbl_move plan_disabled"
                                                                        label="Select Receipt Type" style="width:100%;">
                                                                    <option value=""></option>
                                                                    <?php if(isset($arrReceiptTypes)) { foreach($arrReceiptTypes as $receipt): ?>
                                                                        <option value="<?php echo $receipt['ReceiptTypeId']; ?>" data-type="<?php echo $receipt['Type']; ?>" <?php echo (isset($unitBooking) && $unitBooking['LumpsumReceiptId'] == $receipt['ReceiptTypeId'])?'selected':''; ?>><?php echo $receipt['ReceiptTypeName']; ?></option>
                                                                    <?php endforeach; } ?>
                                                                </select>
                                                            </div>
                                                            <div id="discount-wrapper" class="form-group col-lg-12 padtop10 animated fadeInUp clear <?php echo (isset($unitBooking) && trim($unitBooking['DiscountType']) == '')?'hide':''; ?><?php echo (!isset($unitBooking)) ? 'hide' : ''?>">
                                                                <input type="text" name="discount" id="discount" class="form-control lbl_move plan_disabled special" label="Discount"
                                                                       value="<?php echo (isset($unitBooking) && $unitBooking['Discount'] > 0) ? $unitBooking['Discount']:'0'; ?>"/>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div id="unit-detail-wrapper" class="col-lg-6 m_tb10 hide">
                                                    <div class="form-group stginner_cnt">
                                                        <div class="col-lg-12">
                                                            <div class="row">
                                                                <div class="stginner_h5">
                                                                    <h5>Unit Detail</h5>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-lg-12">
                                                                    <label class="col-lg-5 padlr0 col-md-5 col-sm-5 txt_left control-label">Unit Type</label>
                                                                    <div class="col-lg-7 col-md-7 col-sm-7 padlr0">
                                                                        <p id="unitdetail_UnitTypeName"></p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-lg-12">
                                                                    <label class="col-lg-5 padlr0 col-md-5 col-sm-5 txt_left control-label">Block Name</label>

                                                                    <div class="col-lg-7 col-md-7 col-sm-7 padlr0">
                                                                        <p id="unitdetail_BlockName"></p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-lg-12">
                                                                    <label
                                                                        class="col-lg-5 padlr0 col-md-5 col-sm-5 col-md-4 txt_left control-label">Level</label>

                                                                    <div class="col-lg-7 col-md-7 col-sm-7 padlr0">
                                                                        <p id="unitdetail_FloorName"></p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-lg-12">
                                                                    <label class="col-lg-5 padlr0 col-md-5 col-sm-5 col-md-4 txt_left control-label">Facing</label>
                                                                    <div class="col-lg-7 col-md-7 col-sm-7 padlr0">
                                                                        <p id="unitdetail_Facing"></p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-lg-12">
                                                                    <label class="col-lg-5 padlr0 col-md-5 col-sm-5 txt_left control-label">UDS Land Area</label>

                                                                    <div class="col-lg-7 col-md-7 col-sm-7 padlr0">
                                                                        <p id="unitdetail_UDSLandArea"></p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-lg-12">
                                                                    <label class="col-lg-5 padlr0 col-md-5 col-sm-5 txt_left control-label">Area</label>

                                                                    <div class="col-lg-7 col-md-7 col-sm-7 padlr0">
                                                                        <p><span id="unitdetail_UnitArea"></span> Sq.ft</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-lg-12">
                                                                    <label class="col-lg-5 padlr0 col-md-5 col-sm-5 txt_left control-label">Rate</label>

                                                                    <div class="col-lg-7 col-md-7 col-sm-7 padlr0">
                                                                        <p id="unitdetail_Rate"></p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-lg-12">
                                                                    <label class="col-lg-5 padlr0 col-md-5 col-sm-5 txt_left control-label">Base Amount</label>

                                                                    <div class="col-lg-7 col-md-7 col-sm-7 padlr0">
                                                                        <p id="unitdetail_BaseAmt"></p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-lg-12">
                                                                    <label class="col-lg-5 padlr0 col-md-5 col-sm-5 txt_left control-label">Advance Amount</label>

                                                                    <div class="col-lg-7 col-md-7 col-sm-7 padlr0">
                                                                        <p id="unitdetail_AdvAmount"></p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="liner"></div>
                                                            <div class="row">
                                                                <div class="col-lg-12">
                                                                    <label class="col-lg-5 padlr0 col-md-5 col-sm-5 txt_left control-label">Land Amount</label>
                                                                    <div class="col-lg-7 col-md-7 col-sm-7 padlr0">
                                                                        <p id="unitdetail_LandAmount"></p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-lg-12">
                                                                    <label class="col-lg-5 padlr0 col-md-5 col-sm-5 txt_left control-label">Construction Amount</label>

                                                                    <div class="col-lg-7 col-md-7 col-sm-7 padlr0">
                                                                        <p id="unitdetail_ConstructionAmount"></p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-lg-12">
                                                                    <label class="col-lg-5 padlr0 col-md-5 col-sm-5 txt_left control-label">Other Cost Amount</label>
                                                                    <div class="col-lg-7 col-md-7 col-sm-7 padlr0">
                                                                        <p><span id="unitdet_OtherAmount"></span>
                                                                            <!--                        <a href="#" class="otherTr_--><?php //echo $i; ?><!--">-->
                                                                            <!--                            <span data-original-title="Add lines" data-placement="left" data-toggle="tooltip"><i class="fa fa-chevron-circle-down"></i></span>-->
                                                                            <!--                                    </a>-->
                                                                            &nbsp;&nbsp;
                                                                            <span id="arrOtherCost" data-placement="top" data-toggle="tooltip" data-html="true"
                                                                                  data-original-title=""><i class="fa fa-briefcase" aria-hidden="true"></i></span>
                                                                        </p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-lg-12">
                                                                    <label class="col-lg-5 padlr0 col-md-5 col-sm-5 txt_left control-label">Gross Amont</label>

                                                                    <div class="col-lg-7 col-md-7 col-sm-7 padlr0">
                                                                        <p id="unitdetail_GrossAmount"></p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-lg-12">
                                                                    <label class="col-lg-5 padlr0 col-md-5 col-sm-5 txt_left control-label">Qualifier Amont</label>
                                                                    <div class="col-lg-7 col-md-7 col-sm-7 padlr0">
                                                                        <p><span id="unitdet_QualAmt"></span> &nbsp;&nbsp;
                                                                                                                                                                                                                    <span id="arrQualAmt" data-placement="top" data-toggle="tooltip" data-html="true"
                                                                                                                                                                                                                          data-original-title=""><i class="fa fa-briefcase" aria-hidden="true"></i></span>
                                                                        </p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="row hide" id="lndcnst">
                                                                <div class="col-lg-12">
                                                                    <label class="col-lg-5 padlr0 col-md-5 col-sm-5 txt_left control-label">Land and construction reg amount</label>
                                                                    <div class="col-lg-7 col-md-7 col-sm-7 padlr0">
                                                                        <p id="landconst"></p>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <!--            <div class="row">-->
                                                            <!--                <div class="col-lg-12">-->
                                                            <!--                    <label class="col-lg-5 padlr0 col-md-5 col-sm-5 txt_left control-label">Qualifier Amount</label>-->
                                                            <!---->
                                                            <!--                    <div class="col-lg-7 col-md-7 col-sm-7 padlr0">-->
                                                            <!--                        <p id="unitdetail_QualifierAmount"></p>-->
                                                            <!--                    </div>-->
                                                            <!--                </div>-->
                                                            <!--            </div>-->
                                                            <div class="net_amnt">
                                                                <h2>Net Amount</h2>
                                                                <h1>Rs. <span id="unitdetail_NetAmt"></span></h1>
                                                            </div>
                                                            <input type="hidden" name="bookRate" id="bookRate" value="">
                                                            <input type="hidden" name="bookBaseAmt" id="bookBaseAmt" value="">
                                                            <input type="hidden" name="bookLandAmt" id="bookLandAmt" value="">
                                                            <input type="hidden" name="bookConstructionAmt" id="bookConstructionAmt" value="">
                                                            <input type="hidden" name="bookOthercostAmt" id="bookOthercostAmt" value="">
                                                            <input type="hidden" name="bookqualAmt" id="bookqualAmt"  value="">
                                                            <input type="hidden" name="booknetAmt" id="booknetAmt" value="">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-lg-12 savebtn_area padlr0 marg0 clear">
                                                    <ul>
                                                        <li class="save_btn float_l">
                                                            <a href="<?php echo $this->basePath(); ?>/crm/lead/followup<?php echo (isset($leadId))?'/'.$leadId:'-entry'; ?>" class="ripple steps_btn">Back</a>
                                                        </li>
                                                        <li class="save_btn float_r">
                                                            <a href="#" data-slide="next" data-stepno="2" class="ripple carousel-next-btn">Next</a>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                            <!--step 2-->
                                            <div class="item">
                                                <div class="col-lg-12 padlr0">
                                                    <!--                <div id="other-cost-wrapper" class="animated fadeInUp">-->
                                                    <!--                    <div class="col-lg-6 col-md-8 clear">-->
                                                    <!--                        <p class="heading_checkbox">Select Other Cost</p>-->
                                                    <!---->
                                                    <!--                        <div class="card">-->
                                                    <!--                            <div class="card-body" style="min-height:50px; max-height:310px;">-->
                                                    <!--                                <ul id="unCheckedUl" class="list ui-sortable other-cost" data-sortable="true"></ul>-->
                                                    <!--                            </div>-->
                                                    <!--                        </div>-->
                                                    <!--                    </div>-->
                                                    <!--                    <div class="col-lg-6 col-md-8">-->
                                                    <!--                        <p class="heading_checkbox">Selected Other Cost</p>-->
                                                    <!---->
                                                    <!--                        <div class="card">-->
                                                    <!--                            <div class="card-body" style="min-height:50px; max-height:310px;">-->
                                                    <!--                                <ul class="list ui-sortable other-cost" data-sortable="true" id="checkedUl"></ul>-->
                                                    <!--                            </div>-->
                                                    <!--                        </div>-->
                                                    <!--                    </div>-->
                                                    <!--                    <div class="clearfix"></div>-->
                                                    <!--                </div>-->
                                                    <div class="col-lg-6 col-lg--offset-3 col-md-6 col-md-offset-3 col-sm-8 col-sm-offset-2 padlr0">
                                                        <div class="form-group m_top20 col-lg-12">
                                                            <select id="payment_schedule" name="payment_schedule" class="form-control single_dropdown lbl_move" label="Select Payment Schedule..." style="width:100%;">
                                                                <?php if(isset($arrPaymentSchedules)): ?>
                                                                    <option value="-1"></option>
                                                                    <?php foreach($arrPaymentSchedules as $paymentSchedule): ?>
                                                                        <option value="<?php echo $paymentSchedule['PaymentScheduleId']; ?>" data-typeid="<?php echo $paymentSchedule['ScheduleTypeId']; ?>"
                                                                            <?php echo ($paymentSchedule['PaymentScheduleId'] == $unitBooking['PaymentScheduleId'])?'selected':''; ?>
                                                                            ><?php echo $paymentSchedule['PaymentSchedule']; ?></option>
                                                                    <?php endforeach; ?>
                                                                <?php endif; ?>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div id="payment-schedule-container" class="col-lg-12 hide animated fadeInUp">
                                                        <h1 class="txt_center form_main_h1"><i class="fa fa-chevron-circle-left pull-left" id="backToCustSchForm" style="display: none;" data-toggle="tooltip" data-placement="top" data-original-title="Back"></i>Payment Schedule</h1>
                                                        <div class="clearfix"></div>
                                                        <div id="payment-schedule-wrapper" class="table-responsive m_btm20" style="min-height:200px;">
                                                            <?php if(isset($arrPaymentScheduleDetails)): ?>
                                                                <table class="table payment-schedule" data-id="<?php echo $unitBooking['PaymentScheduleId']; ?>">
                                                                    <thead>
                                                                    <tr>
                                                                        <th>Description</th>
                                                                        <th>Date</th>
                                                                        <th>Round Off</th>
                                                                        <th>Schedule %</th>
                                                                        <th>Schedule Amount</th>
                                                                        <th>Tax</th>
                                                                        <th>Net Amount</th>
                                                                        <th></th>
                                                                    </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                    <?php $i = 0;
                                                                    foreach($arrPaymentScheduleDetails as $paymentSchedule):
                                                                        $isReceiptsFound = isset($paymentSchedule['arrReceiptTypes'])?TRUE:FALSE;
                                                                        ?>
                                                                        <tr class="mainTr">
                                                                            <td><?php echo $paymentSchedule['StageName']; ?></td>
                                                                            <td><?php echo date('d-m-Y', strtotime($paymentSchedule['SchDate'])); ?></td>
                                                                            <td><?php echo nonZeroNumber($paymentSchedule['RoundOff']); ?></td>
                                                                            <td><?php echo nonZeroNumber($paymentSchedule['Percentage']); ?>%</td>
                                                                            <td><input type="text" class="tbl_input txt_right" value="<?php echo nonZeroNumber($paymentSchedule['Amount']); ?>" disabled="disabled"></td>
                                                                            <td><input type="text" class="tbl_input sch-tax txt_right" value="<?php echo nonZeroNumber($paymentSchedule['QualAmount']); ?>" disabled="disabled"></td>
                                                                            <td><input type="text" class="tbl_input sch-net-amt txt_right" value="<?php echo nonZeroNumber($paymentSchedule['NetAmount']); ?>" disabled="disabled"></td>
                                                                            <td>
                                                                                <?php if($isReceiptsFound): ?>
                                                                                    <ul class="action_btns">
                                                                                        <li><a href="#" class="subTr"><i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="top" data-original-title="Expand"></i></a></li>
                                                                                    </ul>
                                                                                <?php endif; ?>
                                                                            </td>
                                                                        </tr>
                                                                        <?php if($isReceiptsFound): ?>

                                                                        <tr style="display: none;" class="subTr">
                                                                            <td colspan="11" style="padding:0px !important; ">
                                                                                <div class="subDiv" style="display: none;">
                                                                                    <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"></div>
                                                                                    <div class="col-lg-12">
                                                                                        <div class="table-responsive topsp">
                                                                                            <table class="table receipt-type-table" style="margin-bottom:0px;">
                                                                                                <thead>
                                                                                                <tr>
                                                                                                    <th>Receipt Type</th>
                                                                                                    <th>Amount</th>
                                                                                                    <th>Tax</th>
                                                                                                    <th>Net Amount</th>
                                                                                                    <th></th>
                                                                                                </tr>
                                                                                                </thead>
                                                                                                <tbody>
                                                                                                <?php $j = 0; $recAmtTot = 0; $recTaxTot = 0;
                                                                                                foreach($paymentSchedule['arrReceiptTypes'] as $receipt):
                                                                                                    $recAmtTot += $receipt['Amount'];
                                                                                                    $recTaxTot += $receipt['QualAmount'];
                                                                                                    $isHavingQualifier = isset($receipt['qualHtmlTag'])?TRUE:FALSE;
                                                                                                    ?>
                                                                                                    <tr>
                                                                                                        <td><?php echo $receipt['ReceiptName']; ?></td>
                                                                                                        <td>
                                                                                                            <input type="text" id="BillAbs_<?php echo $i; ?>_CurAmt_<?php echo $j; ?>" class="sch-amt tbl_input txt_right" value="<?php echo nonZeroNumber($receipt['Amount']); ?>" disabled="disabled">
                                                                                                        </td>
                                                                                                        <td>
                                                                                                            <input type="text" class="sch-tax tbl_input txt_right" value="<?php echo nonZeroNumber($receipt['QualAmount']); ?>" disabled="disabled">
                                                                                                        </td>
                                                                                                        <td>
                                                                                                            <input type="text" class="sch-net-amt tbl_input txt_right" value="<?php echo nonZeroNumber($receipt['NetAmount']); ?>" disabled="disabled">
                                                                                                        </td>
                                                                                                        <td width="3%" align="center" class="action_btns_td">
                                                                                                            <?php if($isHavingQualifier): ?>
                                                                                                                <ul class="action_btns">
                                                                                                                    <li><a href="#" class="rqualmainTr"><i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="top" data-original-title="Expand"></i></a></li>
                                                                                                                </ul>
                                                                                                            <?php endif; ?>
                                                                                                            <input type="hidden" class="qualRefId" id="BillAbs_<?php echo $i; ?>_QualRefId_<?php echo $j; ?>" disabled="disabled">
                                                                                                        </td>
                                                                                                    </tr>
                                                                                                    <?php if($isHavingQualifier): ?>
                                                                                                    <tr class="subTr qualmainTr" style="display:none;">
                                                                                                        <td colspan="5"><div class="subDiv"><?php echo $receipt['qualHtmlTag']; ?></div></td>
                                                                                                    </tr>
                                                                                                <?php endif; ?>
                                                                                                    <?php $j++;
                                                                                                endforeach; ?>
                                                                                                <tr>
                                                                                                    <td class="text-right rate_pri">Total</td>
                                                                                                    <td><input type="text" class="rec-tot-amt tbl_input txt_right" value="<?php echo $recAmtTot; ?>"></td>
                                                                                                    <td><input type="text" class="rec-tot-amt tbl_input txt_right" value="<?php echo $recTaxTot; ?>"></td>
                                                                                                    <td><input type="text" class="rec-tot-amt tbl_input txt_right" value="<?php echo ($recAmtTot + $recTaxTot); ?>"></td>
                                                                                                    <td></td>
                                                                                                </tr>
                                                                                                </tbody>
                                                                                            </table>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </td>
                                                                        </tr>
                                                                    <?php endif; ?>
                                                                        <?php $i++;
                                                                    endforeach; ?>
                                                                    </tbody>
                                                                </table>
                                                            <?php endif; ?>
                                                            <?php if (isset($arrCustomPaymentScheduleDetails)): ?>
                                                                <table class="table custom-schedule">
                                                                    <thead>
                                                                    <tr>
                                                                        <th>Date</th>
                                                                        <th>Description</th>
                                                                        <th>Amount</th>
                                                                        <th></th>
                                                                    </tr>
                                                                    </thead>
                                                                    <tbody class="main">
                                                                    <?php $i=0;
                                                                    $total =0;
                                                                    foreach($arrCustomPaymentScheduleDetails as $detail):
                                                                        $total+=$detail['Amount'];?>
                                                                        <tr class="mainTr">
                                                                            <td><input type="text" class="tbl_input" name="sch_cust_date_<?php echo $i; ?>" id="sch_cust_date_<?php echo $i; ?>" value="<?php echo $detail['SchDate'];?>" readonly></td>
                                                                            <td><input type="text" class="tbl_input txt_right" name="sh_cust_desc_<?php echo $i; ?>" id="sh_cust_desc_<?php echo $i; ?>" value="<?php echo $detail['TermDescription'];?>" maxlength="250"></td>
                                                                            <td><input type="text" class="tbl_input txt_right" name="sh_cust_amount_<?php echo $i; ?>" id="sh_cust_amount_<?php echo $i; ?>" value="<?php echo $this->commonHelper()->sanitizeNumber($detail['Amount'],2,true);?>" readonly></td>
                                                                            <td>
                                                                                <ul class="action_btns">
                                                                                    <li><a href="#" class="subTr"><i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="top" data-original-title="Expand"></i></a></li>
                                                                                </ul>
                                                                            </td>
                                                                        </tr>
                                                                        <tr class="subTr" style="display: none;">
                                                                            <td colspan="11" style="padding:0px !important; ">
                                                                                <div class="subDiv" style="display: none;">
                                                                                    <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"></div>
                                                                                    <div class="col-lg-12">
                                                                                        <div class="table-responsive topsp">
                                                                                            <table class="table receipt-type-table" style="margin-bottom:0px;" id="sch_cust_receipttable_<?php echo $i; ?>">
                                                                                                <thead>
                                                                                                <tr>
                                                                                                    <th>Receipt Type</th>
                                                                                                    <th>Amount</th>
                                                                                                </tr>
                                                                                                </thead>
                                                                                                <tbody class="main">
                                                                                                <?php foreach($detail['Receipts'] as $receipts):?>
                                                                                                    <tr>
                                                                                                        <td><?php echo $receipts['TypeName']?></td>
                                                                                                        <td>
                                                                                                            <input type="text" name="sch_cust__0_receiptamount__" id="sch_cust__0_receiptamount__" class="sch-amt tbl_input txt_right" value="{{Amount}}" readonly>
                                                                                                            <input type="hidden" name="sch_cust__0_receipttypeid__" id="sch_cust__0_receipttypeid__" value="{{TypeId}}">
                                                                                                            <input type="hidden" name="sch_cust__0_receipttype__" id="sch_cust__0_receipttype__" value="{{Type}}">
                                                                                                        </td>
                                                                                                    </tr>
                                                                                                <?php endforeach;?>
                                                                                                </tbody>
                                                                                                <tbody class="total">
                                                                                                <tr>
                                                                                                    <td class="text-right rate_pri">Total</td>
                                                                                                    <td>
                                                                                                        <input type="text" class="rec-tot-amt tbl_input txt_right" name="sh_cust_receiptAmtTotal_<?php echo $i; ?>" id="sh_cust_receiptAmtTotal_<?php echo $i; ?>" readonly>
                                                                                                    </td>
                                                                                                </tr>
                                                                                                </tbody>
                                                                                            </table>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </td>
                                                                        </tr>
                                                                        <?php $i++;endforeach; ?>
                                                                    </tbody>
                                                                    <tbody class="total">
                                                                    <tr class="mainTr">
                                                                        <td></td>
                                                                        <td class="text-right rate_pri">Total</td>
                                                                        <td><input type="text" class="rec-tot-tax tbl_input txt_right totalright" id="sch_cust_total" name="sch_cust_total" value="<?php echo $this->commonHelper()->sanitizeNumber($total,2,true)?>"readonly></td>
                                                                    </tr>
                                                                    </tbody>
                                                                </table>
                                                                <input type="hidden" name="sch_cust_terms" id="sch_cust_terms" value="<?php echo count($arrCustomPaymentScheduleDetails);?>"/>
                                                            <?php endif; ?>
                                                        </div>
                                                        <div id="payment-schedule-form-wrapper" class="m_btm20 padtop20 col-lg-6 col-lg-offset-3 col-md-8 col-md-offset-2 col-sm-6 col-sm-offset-3 animated fadeInUp" style="display: none;">
                                                            <div class="row">
                                                                <div class="form-group col-lg-12">
                                                                    <select name="sch-period" id="sch-period" class="form-control single_dropdown lbl_move" label="Period" style="width:100%;">
                                                                        <option value=""></option>
                                                                        <option value="M" <?php echo (isset($paymentScheduleFormDetail) && $paymentScheduleFormDetail['Period'] == 'M') ? 'selected' : '';?>>Monthly</option>
                                                                        <option value="B" <?php echo (isset($paymentScheduleFormDetail) && $paymentScheduleFormDetail['Period'] == 'B') ? 'selected' : '';?>>Bimonthly</option>
                                                                        <option value="Q" <?php echo (isset($paymentScheduleFormDetail) && $paymentScheduleFormDetail['Period'] == 'Q') ? 'selected' : '';?>>Quaterly</option>
                                                                        <option value="H" <?php echo (isset($paymentScheduleFormDetail) && $paymentScheduleFormDetail['Period'] == 'H') ? 'selected' : '';?>>Half Yearly</option>
                                                                        <option value="Y" <?php echo (isset($paymentScheduleFormDetail) && $paymentScheduleFormDetail['Period'] == 'Y') ? 'selected' : '';?>>Yearly</option>
                                                                    </select>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="form-group col-lg-12">
                                                                    <span class="date_icon"><i class="fa fa-calendar"></i></span>
                                                                    <input type="text" name="sch-from-month" id="sch-from-month" class="form-control lbl_move" label="From Month" value="<?php echo (isset($paymentScheduleFormDetail)) ? $paymentScheduleFormDetail['FromMonth'] : '';?>"readonly/>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="form-group col-lg-12">
                                                                    <input type="text" name="sch-no-terms" id="sch-no-terms" class="form-control lbl_move" label="No.of Terms" value="<?php echo (isset($paymentScheduleFormDetail)) ? $paymentScheduleFormDetail['NoOfTerms'] : '';?>" onkeypress="return isNumberKey(event);"/>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="form-group col-lg-12">
                                                                    <input type="text" name="sch-day" id="sch-day" class="form-control lbl_move" label="Day" value="<?php echo (isset($paymentScheduleFormDetail)) ? $paymentScheduleFormDetail['Day'] : '';?>" onkeypress="return isNumberKey(event);"/>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="form-group col-lg-12">
                                                                    <a id="customPS" class="ripple apply_btn float_r"><span><i class="fa fa-check-square"></i></span> Apply</a>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-lg-12 savebtn_area padlr0 marg0 clear">
                                                    <ul>
                                                        <li class="save_btn float_l">
                                                            <a href="#carousel" data-slide="prev" data-stepno="1" class="ripple steps_btn">Back</a>
                                                        </li>
                                                        <li class="save_btn float_r">
                                                            <a href="#" data-slide="next" data-stepno="3" class="ripple carousel-next-btn">Next</a>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                            <!--step 3-->
                                            <div class="item">
                                                <div class="col-lg-6 col-lg-offset-3 col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 padlr0 m_btm20 unit_kickoff">
                                                    <div class="unitkkoff_topimg"></div>
                                                    <div class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 padlr0 m_btm20">
                                                        <div class="form-group padtop20">
                                                            <h1 class="txt_center">Finalising through Broker?</h1>

                                                            <div class="radio_check col-lg-11 col-lg-offset-1 col-md-8 col-md-offset-2 m_btm20">
                                                                <p class="col-lg-6">
                                                                    <input type="radio" name="buyer_yes_no" id="buyer_yes" value="buyer_yes" <?php echo (isset($unitBooking) && $unitBooking['BrokerId'] > 0)?'checked':''; ?>>
                                                                    <label for="buyer_yes">Yes</label>
                                                                </p>

                                                                <p class="col-lg-6">
                                                                    <input type="radio" name="buyer_yes_no" id="buyer_no" value="buyer_no" <?php echo (isset($unitBooking) && $unitBooking['BrokerId'] <= 0)?'checked':''; ?>>
                                                                    <label for="buyer_no">No</label>
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <div id="broker-info-wrapper" class="animated fadeInUp hide">
                                                            <div class="form-group padtop20 clear">
                                                                <input type="text" name="broker_name" id="broker_name" class="form-control lbl_move"
                                                                       label="Broker Name" value="<?php echo (isset($unitBooking)) ? $unitBooking['BrokerName'] : ''; ?>"/>
                                                                <input type="hidden" name="broker_id" id="broker_id" value="<?php echo (isset($unitBooking)) ? $unitBooking['BrokerId'] : ''; ?>">
                                                            </div>
                                                            <div class="form-group padtop10">
                                                                <input type="text" name="commission" id="commission" maxlength="3" class="form-control lbl_move"
                                                                       label="Commission %" onkeypress="return isDecimal(event, this)" value="<?php echo (isset($unitBooking)) ? $unitBooking['CommissionPercent']: ''; ?>"/>
                                                            </div>
                                                            <div class="form-group padtop10">
                                                                <input type="text" name="amount" id="amount" class="form-control lbl_move" label="Amount" value="<?php echo (isset($unitBooking)) ? $unitBooking['Commission']: ''; ?>" readonly/>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-12 savebtn_area padlr0 marg0 clear">
                                                        <ul>
                                                            <li class="save_btn float_l">
                                                                <a href="#carousel" data-slide="prev" data-stepno="2" class="ripple steps_btn">Back</a>
                                                            </li>
                                                            <li class="save_btn float_r">
                                                                <a href="#" data-slide="next" data-stepno="4" class="ripple carousel-next-btn">Continue</a>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                            <!--step 4-->
                                            <div class="item">
                                                <div class="col-lg-6 col-lg-offset-3 col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 padlr0 m_btm20 unit_kickoff">
                                                    <div class="unitkkoff_topimg"></div>
                                                    <div class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 padlr0 m_btm20">
                                                        <div class="form-group padtop20">
                                                            <h1 class="txt_center">Applying for Loan?</h1>

                                                            <div class="radio_check col-lg-11 col-lg-offset-1 col-md-8 col-md-offset-2 m_btm20">
                                                                <p class="col-lg-6">
                                                                    <input type="radio" name="loan_yes_no" id="loan_yes" value="loan_yes" <?php echo (isset($unitBooking) && $unitBooking['PaymentOption'] == 'L')?'checked':''; ?>>
                                                                    <label for="loan_yes">Yes</label>
                                                                </p>

                                                                <p class="col-lg-6">
                                                                    <input type="radio" name="loan_yes_no" id="loan_no" value="loan_no" <?php echo (isset($unitBooking) && $unitBooking['PaymentOption'] != 'L')?'checked':''; ?>>
                                                                    <label for="loan_no">No</label>
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <div id="loan-approved-wrapper" class="form-group padtop20 animated fadeInUp  <?php echo (isset($unitBooking)&& $unitBooking['PaymentOption'] != 'L')?'hide':''; ?><?php echo (!isset($unitBooking)) ? 'hide' : ''?>">
                                                            <h1 class="txt_center">Did Loan got Approved / Sanctioned ?</h1>

                                                            <div class="radio_check col-lg-11 col-lg-offset-1 col-md-8 col-md-offset-2 m_btm20">
                                                                <p class="col-lg-6">
                                                                    <input type="radio" name="loan_approved_yes_no" id="loan_approved_yes" value="loan_approved_yes"
                                                                        <?php echo (isset($unitBooking) && $unitBooking['LoanApproval'] == 1)?'checked':''; ?>>
                                                                    <label for="loan_approved_yes">Yes</label>
                                                                </p>

                                                                <p class="col-lg-6">
                                                                    <input type="radio" name="loan_approved_yes_no" id="loan_approved_no" value="loan_approved_no"
                                                                        <?php echo (isset($unitBooking) && $unitBooking['LoanApproval'] == 0)?'checked':''; ?>>
                                                                    <label for="loan_approved_no">No</label>
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <div id="loan-approved-info-wrapper" class="animated fadeInUp <?php echo (isset($unitBooking) && ($unitBooking['PaymentOption'] != 'L' || $unitBooking['LoanApproval'] == 0))?'hide':''; ?><?php echo (!isset($unitBooking)) ? 'hide' : ''?>">
                                                            <div class="form-group padtop20 clear">
                                                                <input type="text" name="proposal_no" id="proposal_no" class="form-control lbl_move"
                                                                       label="Proposal No" value="<?php echo (isset($unitBooking)) ?$unitBooking['LoanProposalNo']: ''; ?>"/>
                                                            </div>
                                                            <div class="form-group padtop10">
                                                                <input type="text" name="bank_name" id="bank_name" class="form-control lbl_move" label="Bank Name"
                                                                       value="<?php echo (isset($unitBooking)) ?$unitBooking['BankName']: ''; ?>"/>
                                                            </div>
                                                            <div class="form-group padtop10">
                                                                <input type="text" name="loan_amount" id="loan_amount" class="form-control lbl_move" label="Amount"
                                                                       onkeypress="return isDecimal(event, this)" value="<?php echo (isset($unitBooking)) ? $unitBooking['LoanAmt'] : ''; ?>"/>
                                                            </div>
                                                            <div class="form-group padtop10">
                                                                <div class="col-lg-12 padlr0">
                                                                    <span class="date_icon"><i class="fa fa-calendar"></i></span>
                                                                    <input type="text" name="sanction_date" id="sanction_date" readonly="readonly"
                                                                           class="form-control date_picker lbl_move" label="Sanction Date"
                                                                           value="<?php echo (isset($unitBooking) && strtotime($unitBooking['SanctionDate'])) ? date('d-m-Y', strtotime($unitBooking['SanctionDate'])):date('d-m-Y'); ?>"/>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-12 savebtn_area padlr0 marg0 clear">
                                                        <ul>
                                                            <li class="save_btn float_l">
                                                                <a href="#carousel" data-slide="prev" data-stepno="3" class="ripple steps_btn">Back</a>
                                                            </li>
                                                            <li class="save_btn float_r">
                                                                <a href="#" data-slide="next" data-stepno="5" class="ripple carousel-next-btn">Continue</a>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                            <!--step 5-->
                                            <div class="item">
                                                <div class="col-lg-12">
                                                    <h1>Check List</h1>
                                                    <div class="table-responsive m_btm20" style="min-height:200px;">
                                                        <table id="check-list-table" class="table table-hover">
                                                            <thead>
                                                            <tr>
                                                                <th width="4%">Select</th>
                                                                <th>Description</th>
                                                                <th>Date</th>
                                                                <th>Executive Name</th>
                                                            </tr>
                                                            </thead>
                                                            <tbody>
                                                            <?php if(isset($arrCheckList)): ?>
                                                                <?php foreach($arrCheckList as $checkList):
                                                                    $isChecked = ($checkList['Checked'] == 'Checked')?TRUE:FALSE;?>
                                                                    <tr>
                                                                        <td class="tbl_input_td">
                                                                            <div class="radio_check">
                                                                                <p>
                                                                                    <input type="checkbox" value="<?php echo $checkList['CheckListId']; ?>" id="check_list_<?php echo $checkList['CheckListId']; ?>" name="check_list[]" <?php echo $checkList['Checked']; ?>/>
                                                                                    <label for="check_list_<?php echo $checkList['CheckListId']; ?>" class="ripple"></label>
                                                                                </p>
                                                                            </div>
                                                                        </td>
                                                                        <td><?php echo $checkList['CheckListName']; ?></td>
                                                                        <td>
                                                                            <div style="width: 200px; height: 40px; position:relative;">
                                                                                <span class="date_icon <?php echo ($isChecked)?'':'hide'; ?>"><i class="fa fa-calendar"></i></span>
                                                                                <input type="text" class="form-control date_picker <?php echo ($isChecked)?'':'hide'; ?>" onchange="validateDate(this)"
                                                                                       name="check_list_date_<?php echo $checkList['CheckListId']?>"
                                                                                       value="<?php echo ($isChecked)?$checkList['SubmittedDate']:''; ?>"
                                                                                    <?php echo ($isChecked)?'':'disabled'; ?>>
                                                                        </td>
                                                                        <td>
                                                                            <div style="width: 400px;">
                                                                                <input type="text" class="form-control executive-name <?php echo ($isChecked)?'':'hide'; ?>"
                                                                                       name="check_list_executive_name_<?php echo $checkList['CheckListId']?>" <?php echo ($isChecked)?'':'disabled'; ?>
                                                                                       value="<?php echo ($isChecked)?$checkList['ExecutiveName']:''; ?>">
                                                                                <input type="hidden" class="executive-id" value="<?php echo ($isChecked)?$checkList['ExecutiveId']:''; ?>"
                                                                                       name="check_list_executive_id_<?php echo $checkList['CheckListId']?>" <?php echo ($isChecked)?'':'disabled'; ?>>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                <?php endforeach; ?>
                                                            <?php endif; ?>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                                <div class="col-lg-12 savebtn_area padlr0 marg0 clear">
                                                    <ul>
                                                        <li class="save_btn float_l">
                                                            <a href="#carousel" data-slide="prev" data-stepno="4" class="ripple steps_btn">Back</a>
                                                        </li>
                                                        <li class="save_btn float_r">

                                                            <a href="#" data-slide="next" data-stepno="6" class="ripple carousel-next-btn">Continue</a>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                            <!--step 6-->
                                            <div class="item">
                                                <div class="col-lg-6 col-lg-offset-3 col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 padlr0 m_btm20 unit_kickoff">
                                                    <div class="unitkkoff_topimg"></div>
                                                    <div class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 padlr0 m_btm20">
                                                        <div class="form-group m_top20 padtop20 clear">
                                                            <input type="text" name="nature_name" id="nature_name" class="form-control lbl_move" label="Nature" value="<?php echo (isset($leadFollowUp)) ? $leadFollowUp['NatureName'] : '';?>" <?php echo (isset($leadFollowUp)) ? 'disabled' : '';?>/>
                                                            <input type="hidden" name="nature_id" id="nature_id" value="<?php echo (isset($leadFollowUp)) ? $leadFollowUp['NatureId'] : '';?>"/>
                                                        </div>

                                                        <div class="form-group padtop10" id="time">
                                                            <div class="datetimepicker">
                                                                <span class="add-on datetimepicker_icon"></span>
                                                                <input type="text" id="nextCallDate" data-format="dd/MM/yyyy HH:mm:ss PP" name="nextCallDate" readonly="readonly" data-bsfshare="Next Call Date and Time" class="form-control lbl_move date_time_icon" label="Next Call Date and Time" value="<?php echo (isset($leadFollowUp)) ? date('d/m/Y h:i:s a', strtotime($leadFollowUp['NextCallDate'])) : '';?>" <?php echo (isset($leadFollowUp)) ? 'disabled' : '';?> />
                                                            </div>
                                                            <script type="text/javascript">
                                                                $('.date_time_icon').click(function() {
                                                                    $('.datetimepicker_icon').trigger('click');
                                                                });
                                                                var dt=new Date();
                                                                $(function() {
                                                                    $('.datetimepicker').datetimepicker({
                                                                        language: 'en',
                                                                        pick12HourFormat: true,
                                                                        startDate:dt,
                                                                        todayBtn: true
                                                                    }).on('changeDate', function() {

                                                                    });
                                                                });

                                                            </script>
                                                        </div>
                                                        <div class="form-group m_top20 padtop20 clear">
                                                            <select id="nextfollow_name" name="nextfollow_name" class="form-control single_dropdown lbl_move" style="width:100%;" label="Choose Next Followup Type" <?php echo (isset($leadFollowUp)) ? 'disabled' : '';?>>
                                                                <option value=""></option>
                                                                <?php
                                                                foreach($arrCall as $type){ ?>
                                                                    <option value="<?php echo $type['data'] ?>" <?php echo (isset($leadFollowUp) && $leadFollowUp['NextCallDate']) ? 'selected' : '';?>><?php echo $type['value'] ?></option>
                                                                <?php } ?>
                                                            </select>
                                                        </div>
                                                        <div class="form-group m_top20 padtop20 clear" id="requ">
                                                            <label for="buyer" class="col-lg-6 txt_left col-md-6 control-label">Vehicle Required?</label>
                                                            <div class="radio_check">
                                                                <p class="col-lg-6">
                                                                    <input type="radio" name="vehicleAllocation" id="allo_yes" value="1" <?php echo (isset($leadFollowUp)) ? 'disabled' : '';?>>
                                                                    <label for="allo_yes">Yes</label>
                                                                    <input type="radio" name="vehicleAllocation" id="allo_no" value="0" <?php echo (isset($leadFollowUp)) ? 'disabled' : '';?>>
                                                                    <label for="allo_no">No</label>
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <div class="form-group m_top20 padtop20 clear" id="timep">
                                                            <input type="text" name="pickUpTime" id="pickUpTime"  class="form-control lbl_move time_picker" readonly label="PickUp Time" value="<?php echo (isset($leadFollowUp)) ? $leadFollowUp['PickUpTime'] : '';?>" <?php echo (isset($leadFollowUp)) ? 'disabled' : '';?>/>
                                                        </div>
                                                        <div class="form-group m_top20 padtop20 clear" id="addr">
                                                            <input type="text" name="pickUpAddress" id="pickUpAddress"  class="form-control lbl_move"label="PickUp Address" value="<?php echo (isset($leadFollowUp)) ? $leadFollowUp['PickUpAddress'] : '';?>" <?php echo (isset($leadFollowUp)) ? 'disabled' : '';?>/>
                                                        </div>
                                                        <div class="form-group m_top20 padtop20 clear">
                                                            <textarea name="nextfollowremarks" id="nextfollowremarks"  class="form-control lbl_move" label="Next Followup Remarks" <?php echo (isset($leadFollowUp)) ? 'disabled' : '';?>><?php echo (isset($leadFollowUp)) ? $leadFollowUp['NextFollowupRemarks'] : '';?></textarea>
                                                        </div>
                                                        <div class="form-group m_top20 padtop20 clear">
                                                            <textarea name="remarks" id="remarks"  class="form-control lbl_move" label="Remarks" <?php echo (isset($leadFollowUp)) ? 'disabled' : '';?>><?php echo (isset($leadFollowUp)) ? $leadFollowUp['Remarks'] : '';?></textarea>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-12 savebtn_area padlr0 marg0 clear">
                                                        <ul>
                                                            <li class="save_btn float_l">
                                                                <a href="#carousel" data-slide="prev" data-stepno="5" class="ripple steps_btn">Back</a>
                                                            </li>
                                                            <li class="save_btn float_r">
                                                                <a href="#" data-slide="next" data-stepno="7" class="ripple carousel-next-btn">Continue</a>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>

                                            <!--step 7-->
                                            <div class="item">
                                                <div class="col-lg-6 col-lg-offset-3 col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 padlr0 m_btm20 unit_kickoff">
                                                    <div class="unitkkoff_topimg"></div>
                                                    <div id="content_all" class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 padlr0 m_btm20">
                                                        <div class="form-group m_top20 padtop20 clear coApp_0">
                                                            <input type="text" name="registration_name" id="registration_name" class="form-control lbl_move"
                                                                   label="Registration Name" value="<?php echo (isset($unitBooking)) ? $unitBooking['BookingName'] : '';?>">
                                                        </div>
                                                        <?php if(isset($coAppDetails)){
                                                            $i=1;
                                                            foreach($coAppDetails as $coAppDetail): ?>
                                                                <div class="form-group padtop10 coApp_<?php echo $i;?>">
                                                                    <input type="text" name="coApp_name_<?php echo $i;?>" id="coApp_name_<?php echo $i;?>" onkeypress="addNewRow(this);" class="form-control lbl_move"
                                                                           placeholder="Co-Applicant-<?php echo $i;?>" value="<?php echo $coAppDetail['CoApplicantName'];?>"/>
                                                                </div>
                                                                <?php $i++;endforeach; ?>
                                                            <div class="form-group padtop10 empty-coApp coApp_<?php echo $i;?>">
                                                                <input type="text" name="coApp_name_<?php echo $i;?>" id="coApp_name_<?php echo $i;?>" onkeypress="addNewRow(this);" class="form-control lbl_move"
                                                                       placeholder="Co-Applicant-<?php echo $i;?>"/>
                                                            </div>
                                                            <input type="hidden" id="coApp_count" name="coApp_count" value="<?php echo $i;?>" />
                                                        <?php } else {
                                                            if(isset($dCoApp)) {
                                                                $i = 1;
                                                                foreach ($dCoApp as $dApp): ?>
                                                                    <div class="form-group padtop10 coApp_<?php echo $i; ?>">
                                                                        <input type="text" name="coApp_name_<?php echo $i; ?>" id="coApp_name_<?php echo $i; ?>"
                                                                               onkeypress="addNewRow(this);" class="form-control lbl_move"
                                                                               placeholder="Co-Applicant-<?php echo $i; ?>"
                                                                               value="<?php echo $dApp['CoApplicantName']; ?>"/>
                                                                    </div>
                                                                    <?php $i++;
                                                                endforeach; ?>
                                                            <?php  }?>
                                                            <input type="hidden" id="coApp_count" name="coApp_count" value="<?php echo (isset($dCoApp)) ? count($dCoApp) : 0; ?>" />
                                                        <?php } ?>
                                                        <div class="form-group padtop10">
                                                            <input type="text" name="executive_name" id="executive_name" class="form-control lbl_move"
                                                                   label="Post Sale Executive" value="<?php echo (isset($unitBooking)) ? $unitBooking['ExecutiveName'] : '';?>"/>
                                                            <input type="hidden" name="post_executive_id" id="post_executive_id" value="<?php echo (isset($unitBooking)) ? $unitBooking['PostExecutiveId'] : '0';?>"/>
                                                        </div>
                                                        <div id="advhide">
                                                            <div class="form-group padtop10" style="display:none;" id="prebooking">
                                                                <input type="text" name="pre_amount" id="pre_amount" class="form-control lbl_move" label="PreBook Advance Amount Paid" onkeypress="return isDecimal(event, this)" value="" readonly />
                                                            </div>
                                                        </div>
                                                            <div class="form-group padtop10">
                                                                <input type="text" name="adv_amount" id="adv_amount" class="form-control lbl_move" label="Advance Amount" onkeypress="return isDecimal(event, this)" value="<?php echo (isset($unitBooking)) ? $unitBooking['AdvAmount'] : '';?>"/>
                                                            </div>

                                                        <?php if(!isset($unitBooking)):?>
                                                            <div class="form-group padtop20 hide" id="receiptshow">
                                                                <h1 class="txt_center">Do you want make a receipt?</h1>

                                                                <div class="radio_check col-lg-11 col-lg-offset-1 col-md-8 col-md-offset-2 m_btm20">
                                                                    <p class="col-lg-6">
                                                                        <input type="radio" name="receipt_yes_no" id="receipt_yes" value="1" checked>
                                                                        <label for="receipt_yes">Yes</label>
                                                                    </p>

                                                                    <p class="col-lg-6">
                                                                        <input type="radio" name="receipt_yes_no" id="receipt_no" value="0">
                                                                        <label for="receipt_no">No</label>
                                                                    </p>
                                                                </div>
                                                            </div>
                                                        <?php endif;?>
                                                    </div>

                                                    <div class="col-lg-12 savebtn_area padlr0 marg0 clear">
                                                        <ul>
                                                            <li class="save_btn float_l">
                                                                <a href="#carousel" data-slide="prev" data-stepno="6" class="ripple steps_btn">Back</a>
                                                            </li>
                                                            <li class="save_btn float_r">
                                                                <a id="finalise-btn" href="#" class="ripple">Finalise</a>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            <?php elseif(isset($err)): ?>
                                <h1 class="text-center" style="margin: 150px auto;">Error: <?php echo $err; ?></h1>
                            <?php endif; ?>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script id="payment-schedule-template" type="text/template">
            <table class="table payment-schedule" data-id="payment_schedule_id__">
                <thead>
                <tr>
                    <th>Description</th>
                    <th>Date</th>
                    <th>Round Off</th>
                    <th>Schedule %</th>
                    <th>Schedule Amount</th>
                    <th>Tax</th>
                    <th>Net Amount</th>
                    <th></th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </script>
        <script type="text/javascript">
            var custom_payment_schedule_details = null;
            $(document).ready(function(){
                $('.downarrow_span').click(function(){
                    $('.downarrow_span_div').toggleClass('open');
                });
                var ldId=  '<?php echo (isset($leadId)) ? $leadId : '0' ?>';

                if(ldId=='0'){
                    $("#leadid").prop('disabled',false);
                }
                else{
                    $("#leadid").prop('disabled',true);
                }
            });
            $(document).ready(function(){
                Date.isLeapYear = function (year) {
                    return (((year % 4 === 0) && (year % 100 !== 0)) || (year % 400 === 0));
                };

                Date.getDaysInMonth = function (year, month) {
                    return [31, (Date.isLeapYear(year) ? 29 : 28), 31, 30, 31, 30, 31, 31, 30, 31, 30, 31][month];
                };

                Date.prototype.isLeapYear = function () {
                    return Date.isLeapYear(this.getFullYear());
                };

                Date.prototype.getDaysInMonth = function () {
                    return Date.getDaysInMonth(this.getFullYear(), this.getMonth());
                };

                Date.prototype.addMonths = function (value) {
                    var n = this.getDate();
                    this.setDate(1);
                    this.setMonth(this.getMonth() + value);
                    this.setDate(Math.min(n, this.getDaysInMonth()));
                    return this;
                };
                $('input[type=radio][name=discount_based]').on('change',function() {

                    if($(this).val()=="N") {

                        $('#divreferalType').hide();
                        $('#divBuyer').hide();
                        $('#buyerName').val('').trigger('change');
                        $('#divEmployee').hide();
                        $('#employeeName').val('').trigger('change');
                        $("#plan-list-wrapper").hide();
                        $("#plan_list").val('').trigger('change');
                        $("#discount_type").val('').trigger('change');
                        $('.plan_disabled').prop("disabled",false);
                        $("#discount-type-wrapper").show();
                        $("#discount").val('').trigger('change');

                    } else if($(this).val()=="P") {
                        $('#divreferalType').hide();
                        $('#divBuyer').hide();
                        $('#buyerName').val('').trigger('change');
                        $('#divEmployee').hide();
                        $('#employeeName').val('').trigger('change');
                        $("#discount-type-wrapper").hide();
                        $("#discount_type").val('').trigger('change');
                        $("#plan-list-wrapper").show();
                        $("#discount").val('').trigger('change');

                    } else if($(this).val()=="R") {
                        $("#plan-list-wrapper").hide();
                        $("#plan_list").val('').trigger('change');
                        $("#discount-type-wrapper").hide();
                        $("#discount_type").val('').trigger('change');
                        $('.plan_disabled').prop("disabled",false);
                        $('#divreferalType').show();
                        $('#divBuyer').show();
                    }
                });
                $('input[type=radio][name=referalType]').on('change',function() {
                    if($(this).val()=="B") {
                        $('#divEmployee').hide();
                        $('#employeeName').val('').trigger('change');
                        $("#discount-type-wrapper").hide();
                        $("#discount_type").val('').trigger('change');
                        $('#divBuyer').show();
                    } else if($(this).val()=="E") {
                        $('#divBuyer').hide();
                        $('#buyerName').val('').trigger('change');
                        $("#discount-type-wrapper").hide();
                        $("#discount_type").val('').trigger('change');
                        $('#divEmployee').show();
                    }
                });
            });
            function showNormal() {
                $("#discount-type-wrapper").show();
            }

            function planDetails(pId) {
                if(pId!="" && pId !=null) {
                    $.ajax({
                        url: getBaseURL() + 'crm/lead/finalisation-edit',
                        data: {csrf: "<?php echo isset($csrf)?$csrf:''; ?>", PlanId: pId},
                        type: 'POST',
                        success: function (data, status, xhr) {
                            if (xhr.status == 200) {
                                var planDetails = JSON.parse(data);
                                if(planDetails!=false) {
                                   // $('.plan_disabled').prop("disabled",true);
                                    removeError($('#lumpsum_receipt_wise'));
                                    $('#discount_type').val(planDetails.DiscountType).trigger('change');
                                    $('#discount-type-wrapper').show();
                                    if(planDetails.DiscountType=="L" || planDetails.DiscountType=="P") {
                                        $("input[name=lumpsum_type][value=" + planDetails.LumpsumType + "]").prop('checked', true).trigger('change');
                                    }
                                    if(planDetails.ReceiptType==0) {
                                        $('#lumpsum_receipt_wise').val('').trigger('change');
                                    } else {
                                        $('#lumpsum_receipt_wise').val(planDetails.ReceiptType).trigger('change');
                                    }
                                    $('#discount').val(planDetails.Discount).trigger('change');
                                    $('#discount-wrapper').removeClass('hide');
                                }
                            }
                        },
                        error: function (xhr, status, error) {
                            alert(xhr.responseText);
                        }
                    });
                } else {
                    $('#discount-type-wrapper').hide();
                    $('#discount_type').val('').trigger('change');

                }

            }

            $(function () {
                var mode = '<?php echo (isset($mode)) ? $mode : 'add';?>';
                var discountLimit = '<?php echo (isset($discountLimit)) ? json_encode($discountLimit) : '[]';?>';
                discountLimit=JSON.parse(discountLimit);
                if(mode == 'add' ||mode == 'save' ) {
                    addNewRow($('<div id="coApp_name__"></div>'));
                }
                var $project_id = $('#project_id'),
                    $unit_no = $('#unit_no'),
                    $lead_id = $('#leadid'),
                    $unitnoWrapper = $('#unitno-wrapper'),
                    $buyerWrapper = $('#buyer-wrapper'),
                    $unitpriceWrapper = $('#unitprice-wrapper'),
                    $discountWrapper = $('#discount-wrapper'),
                    $unit_rate = $('#unit_rate'),
                    $discount = $('#discount'),
                    $unitDetailWrapper = $('#unit-detail-wrapper'),
                    $carousel = $('#carousel'),
                    $payment_schedule = $('#payment_schedule'),
                    $otherCostWrapper = $('#other-cost-wrapper'),
                    $unCheckedUI = $('#unCheckedUl'),
                    $checkedUI = $('#checkedUl'),
                    $paymentScheduleContainer = $('#payment-schedule-container'),
                    $paymentScheduleWrapper = $('#payment-schedule-wrapper'),
                    $backToCustSchForm = $('#backToCustSchForm'),
                    $paymentScheduleForm = $('#payment-schedule-form-wrapper'),
                    $buyer_no = $('#buyer_no'),
                    $buyer_yes_no = $('input[name="buyer_yes_no"]'),
                    $brokerInfoWrapper = $('#broker-info-wrapper'),
                    $broker_name = $('#broker_name'),
                    $broker_id = $('#broker_id'),
                    $commission = $('#commission'),
                    $amount = $('#amount'),
                    $unitdetail_NetAmt = $('#unitdetail_NetAmt'),
                    $loan_no = $('#loan_no'),
                    $loanApprovedWrapper = $('#loan-approved-wrapper'),
                    $loanApprInfoWrapper = $('#loan-approved-info-wrapper'),
                    $loanApprNo = $('#loan_approved_no'),
                    $loanApprYes = $('#loan_approved_yes'),
                    $proposal_no = $('#proposal_no'),
                    $bank_name = $('#bank_name'),
                    $loan_amt = $('#loan_amount'),
                    $sanction_date = $('#sanction_date'),
                    $checkListTable = $('#check-list-table'),
                    $executive_name = $('#executive_name'),
                    $post_executive_id = $('#post_executive_id'),
                    $registration_name = $('#registration_name'),
                    $adv_amount = $('#adv_amount'),
                    $finaliseBtn = $('#finalise-btn'),
                    $booking_date = $('#booking_date'),
                    $booking_no = $('#booking_no'),
                    $paymentScheduleTemplate = $('#payment-schedule-template'),
                    $discountTypeWrapper = $('#discount-type-wrapper'),
                    $discount_type = $('#discount_type'),
                    $unit_id = $('#unit_id'),
                    $lumpsum_receipt_wise = $('#lumpsum_receipt_wise'),
                    $lumpsumTypeWrapper = $('#lumpsum-type-wrapper'),
                    $lumpsumReceiptWiseWrapper = $('#lumpsum-receipt-wise-wrapper'),
                    $lumpsumType = $lumpsumTypeWrapper.find('input[name="lumpsum_type"]'),
                    $constructionAmt = $('#unitdetail_ConstructionAmount'),
                    $landAmt = $('#unitdetail_LandAmount'),
                    $unitdetail_UnitArea = $('#unitdetail_UnitArea'),
                    $unitdetail_Rate = $('#unitdetail_Rate'),
                    $unitdetail_BaseAmt = $('#unitdetail_BaseAmt'),
                    $unitdetail_GrossAmt = $('#unitdetail_GrossAmount'),
                    $unitdetail_OtherCostAmt = $('#unitdet_OtherAmount'),
                //followup details//
                    $nature_name=$('#nature_name'),
                    $nature_id=$('#nature_id'),
                    $nextfollow_name=$('#nextfollow_name'),
                    $nextfollow_id=$('#nextfollow_id'),
                    $nextCallDate=$('#nextCallDate'),
                    $vehicleAllocation=$('#vehicleAllocation'),
                    $pickUpTime=$('#pickUpTime'),
                    $pickUpAddress=$('#pickUpAddress'),
                    $nextfollowremarks=$('#nextfollowremarks'),
                    $actionRequiredBy=$('#actionRequiredBy'),
                    $OtherCost = $('#OtherCost'),
                    arrOtherCost = [],
                    ansTax =false,
                    $remarks=$('#remarks');

                //followup Details//

                init();

                bindBookingNo_onChange();

                bindProject_onChange();
                bindUnit_onChange();
                bindDiscount_onChange();
                bindOtherCostchange();

                bindNextBtn_onClick();

                bindPaymentSchedule_onChange();

                bindBroker_onChange();
                bindBrokerCommission_onChange();

                bindApplyLoan_onChange();
                bindLoanApproved_onChange();
                bindnextfollowup_onChange();
                bindBrokerName_autoComplete();
                bindExecutiveName_autoComplete();
                bindNature_autoComplete();
                bindyes_onChange();
                bindFinalise_onClick();

                bindDiscountType_onChange();
                bindBookingDate_onChange();

                bindLumpsumType_onChange();
                bindLumpsumReceiptWise_onChange();

                function init() {
                    $carousel.carousel({
                        interval: false
                    });

                    <?php if(isset($saveproj)){?>
                    $unitnoWrapper.removeClass('hide');
                    load_unitDetails(function(){

                        var discount = parseFloat($discount.val()),
                            $unitdetail_UnitArea = $('#unitdetail_UnitArea'),
                            area = parseFloat($unitdetail_UnitArea.attr('data-original-value')),
                            rate = parseFloat($unitdetail_Rate.attr('data-original-value')),
                            baseAmt = parseFloat($unitdetail_BaseAmt.attr('data-original-value')),
                            grossAmt = 0,
                            netAmt = parseFloat($unitdetail_NetAmt.attr('data-original-value')),
                            otherCostAmt = parseFloat($unitdetail_OtherCostAmt.text());

                        if (!isNaN(otherCostAmt)) {
                            grossAmt = baseAmt + otherCostAmt;
                            netAmt = grossAmt;
                        }

                        $unitdetail_NetAmt.text(sanitizeNumber(netAmt,2,true));

                        $discount.trigger('change');
                        $unitDetailWrapper.removeClass('hide');
                    });
                    <?php  } ?>

                    <?php if(isset($unitBooking)):?>
                    var $tarPSTable = $paymentScheduleWrapper.find('.payment-schedule[data-id="'+$payment_schedule.val()+'"]');
                    fillRowRefEditMode();
                    calcTaxForPaymentSchedule($tarPSTable);

                    load_unitDetails(function(){
                        var discount = parseFloat($discount.val()),
                            $unitdetail_UnitArea = $('#unitdetail_UnitArea'),
                            area = parseFloat($unitdetail_UnitArea.attr('data-original-value')),
                            rate = parseFloat($unitdetail_Rate.attr('data-original-value')),
                            baseAmt = parseFloat($unitdetail_BaseAmt.attr('data-original-value')),
                            grossAmt = 0,
                            netAmt = parseFloat($unitdetail_NetAmt.attr('data-original-value')),
                            otherCostAmt = parseFloat($unitdetail_OtherCostAmt.text());

                        if (!isNaN(otherCostAmt)) {
                            grossAmt = baseAmt + otherCostAmt;
                            netAmt = grossAmt;
                        }

                        $unitdetail_NetAmt.text(sanitizeNumber(netAmt,2,true));

                        $discount.trigger('change');
                        $unitDetailWrapper.removeClass('hide');
                    });
                    <?php endif;?>
//        $project_id.select2();
//        $unit_no.select2();
//        $payment_schedule.select2();
//        $discount_type.select2();
//        $lumpsum_receipt_wise.select2();
//        $nextfollow_name.select2();

                    $("#sch-from-month").datepicker({
                        changeYear: false,
                        format: "M-yyyy",
                        viewMode: "months",
                        minViewMode: "months",
                        maxViewMode: "months"
                    }).on('changeDate', function() {
                        $('.datepicker').hide();
                    });

                    $backToCustSchForm.on('click', function () {
                        $paymentScheduleForm.show();
                        $backToCustSchForm.hide();
                        $paymentScheduleWrapper.hide();
//            $('.savebtn_area').hide();
                    });
                }

                function bindBookingNo_onChange() {
                    $booking_no.on('change', function() {

                        checkBookingNo(function(isSuccess, msg) {
                            if(isSuccess == false) {
                                alert(msg);
                                $booking_no.focus();
                            }
                        });
                    });

                }

                function bindyes_onChange() {
                    $('input[name="vehicleAllocation"]').on('change', function () {
                        if ($('#allo_no').is(':checked')) {
                            $('#timep').hide().find('text').val('');
                            $('#addr').hide().find('textarea').val('');
                        } else {
                            $('#timep').show();
                            $('#addr').show();
                        }
                    });
                }

                $('#customPS').on('click', function (ev) {
                    ev.preventDefault();
                    paymentScheduleCustom();
                });


                function bindnextfollowup_onChange() {
                    $nextfollow_name.on('change', function() {
                        var sname =$("#nextfollow_name option:selected").text();

                        if(sname=='Site Visit'){
                            $('#requ').show();

                        } else {
                            $('#requ').hide().find('radio').val('');
                            $('#addr').hide().find('textarea').val('');
                            $('#timep').hide().find('text').val('');
                        }
                    }).change();
                }


                function checkBookingNo(callback) {
                    var booking_no = $booking_no.val().trim();
                    if(booking_no.length <= 0) {
                        callback(false, 'Booking No is required!');
                        return false;
                    } else {
                        $.ajax({
                            url: getBaseURL() + 'crm/lead/check-booking-no',
                            data: {csrf: "<?php echo isset($csrf)?$csrf:''; ?>", BookingNo: booking_no},
                            type: 'POST',
                            success: function (data, status, xhr) {

                                if (data.unit_booking == false) {
                                    $booking_no.addClass('already-exists');
                                    callback(data.unit_booking, 'Booking No Already exists!');
                                    return data.unit_booking;
                                } else {
                                    $booking_no.removeClass('already-exists');
                                    callback(true);
                                    return true;
                                }
                            },
                            error: function (xhr, status, error) {
                                alert(xhr.responseText);
                                $booking_no.addClass('already-exists');
                            }
                        });
                    }
                }

                function bindApplyLoan_onChange() {
                    $('input[name="loan_yes_no"]').on('change', function () {
                        if ($loan_no.is(':checked')) {
                            $loanApprInfoWrapper.addClass('hide');
                            $loanApprovedWrapper.addClass('hide');
                            resetLoanData();
                        } else {
                            //$loanApprInfoWrapper.removeClass('hide');
                            $loanApprovedWrapper.removeClass('hide');

                            $('input[name="loan_approved_yes_no"]').trigger('change');
                        }
                    });
                }

                function bindLoanApproved_onChange() {
                    $('input[name="loan_approved_yes_no"]').on('change', function () {
                        if ($loanApprNo.is(':checked')) {
                            $loanApprInfoWrapper.addClass('hide');
                            resetLoanData();
                        } else if($loanApprYes.is(':checked')){
                            $loanApprInfoWrapper.removeClass('hide');
                        }
                    });
                }

                function resetLoanData() {
                    $proposal_no.val('');
                    $bank_name.val('');
                    $loan_amt.val('');
                    $sanction_date.val('');
                }

                function bindBroker_onChange() {
                    $buyer_yes_no.on('change', function () {

                        if ($buyer_no.is(':checked')) {
                            $brokerInfoWrapper.addClass('hide');
                            $broker_name.val('');
                            $broker_id.val('');
                            $commission.val('');
                            $amount.val('');
                        } else {
                            $brokerInfoWrapper.removeClass('hide');
                        }
                    });
                }

                function bindBrokerCommission_onChange() {
                    $commission.on('change', function () {
                        var commission = parseFloatVal($commission.val());

                        if (isNaN(commission)) {
                            return;
                        }

                        var amount = (parseFloatVal($unitdetail_NetAmt.text()) * commission) / 100;
                        $amount.val(amount.toFixed(2));
                    });
                }

                function bindPaymentSchedule_onChange() {
                    $payment_schedule.on('change', function () {
                        var payment_schedule = $payment_schedule.val();

                        removeError($payment_schedule);

                        showPaymentScheduleDetails(function() {
                            $paymentScheduleContainer.removeClass('hide');
                        });

                    });
                }

                function bindOtherCost_checkList() {
                    $('.other-cost input:checkbox').bind('change', function () {
                        var current = $(this).closest('li');
                        if (current.find("input:checkbox").is(':checked')) {
                            var prependToDiv = $('#checkedUl');
                            current.animate({
                                top: -30,
                                left: prependToDiv.offset().left
                            }, 200, function () {
                                current.prependTo(prependToDiv).css({
                                    top: 'auto',
                                    left: 'auto'
                                });
                            });
                        } else {
                            current.animate({
                                top: -30,
                                left: -$unCheckedUI.offset().left
                            }, 200, function () {
                                current.prependTo($unCheckedUI).css({
                                    top: 'auto',
                                    left: 'auto'
                                });
                            });
                        }

                        $paymentScheduleWrapper.html('');
                        $payment_schedule.trigger('change');
                    });
                }

                function bindExecutiveName_autoComplete() {

                    $executive_name.autocomplete({
                        lookup: <?php echo (isset($arrExecutives))?json_encode($arrExecutives):'[]'; ?>,
                        lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                            if (queryLowerCase == '*') {
                                return suggestion.value;
                            } else {
                                var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                                return re.test(suggestion.value);
                            }
                        }, onSelect: function (suggestion) {
                            if (suggestion) {
                                $post_executive_id.val(suggestion.data);

                                removeError($(this));
                            }
                        }, onSearchStart: function (suggestion) {
                            $post_executive_id.val('');
                        }, onSearchComplete: function (query, suggestions) {
                            if (!suggestions.length) {
                                $post_executive_id.val('');
                                showError($(this), 'Executive Name not found!');
                            } else {
                                removeError($(this));
                            }
                        }
                    });
                }

                function bindBrokerName_autoComplete() {
                    $broker_name.autocomplete({
                        lookup: <?php echo (isset($arrBrokers))?json_encode($arrBrokers):'[]'; ?>,
                        lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                            if (queryLowerCase == '*') {
                                return suggestion.value;
                            } else {
                                var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                                return re.test(suggestion.value);
                            }
                        }, onSelect: function (suggestion) {
                            if (suggestion) {
                                $broker_id.val(suggestion.data);

                                removeError($(this));
                            }
                        }, onSearchStart: function (suggestion) {
                            $broker_id.val('');
                        }, onSearchComplete: function (query, suggestions) {
                            if (!suggestions.length) {
                                $broker_id.val('');
                                showError($(this), 'Broker Name not found!');
                            } else {
                                removeError($(this));
                            }
                        }
                    });
                }
                function bindNature_autoComplete() {
                    $nature_name.autocomplete({
                        lookup: <?php echo (isset($arrNature))?json_encode($arrNature):'[]'; ?>,
                        lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                            if (queryLowerCase == '*') {
                                return suggestion.value;
                            } else {
                                var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                                return re.test(suggestion.value);
                            }
                        }, onSelect: function (suggestion) {
                            if (suggestion) {
                                $nature_id.val(suggestion.data);

                                removeError($(this));
                            }
                        }, onSearchStart: function (suggestion) {
                            $nature_id.val('');
                        }, onSearchComplete: function (query, suggestions) {
                            if (!suggestions.length) {
                                $nature_id.val('');
                                showError($(this), 'Status not found!');
                            } else {
                                removeError($(this));
                            }
                        }
                    });
                }

                function bindFinalise_onClick() {
                    $finaliseBtn.on('click', function (ev) {
                        ev.preventDefault();

                        validate(function (isSuccess) {
                            if (isSuccess) {
                                updatebookingValue();

                                $('.plan_disabled').prop("disabled",false);
                                $('#finalisation-form').submit();
                            }
                        });
                    });

                    function validate(callback) {

                        var reg_name = $registration_name.val().trim(),
                            exe_name = $executive_name.val().trim(),
                            exe_id = $post_executive_id.val().trim(),
                            adv_amt = parseFloatVal($adv_amount.val()),
                            othercost= parseFloatVal($('#unitdetail_OtherAmount').text()),
                            net_amount = parseFloatVal($('#unitdetail_NetAmt').text()),
                            net_amt= othercost + net_amount;

                        removeError($registration_name);
                        removeError($executive_name);
                        removeError($adv_amount);
                        removeError($post_executive_id);

                        if (reg_name.length <= 0) {
                            showError($registration_name, 'Registration Name is required!');
                            callback(false);
                            return false;
                        }
                        if (exe_id.length== 0){
                            showError($executive_name, 'Executive Name is required!');
                            callback(false);
                            return false;
                        }
//           if (exe_name.length <= 0) {
//                showError($executive_name, 'Executive Name is required!');
//                callback(false);
//                return false;
//            }
                        else if (isNaN(exe_id)) {
                            showError($executive_name, 'Invalid Executive Name!');
                            callback(false);
                            return false;
                        } else if (isNaN(adv_amt)) {
                            showError($adv_amount, 'Advance amount is required!');
                            callback(false);
                            return false;
                        } else if(adv_amt > net_amt) {
                            showError($adv_amount, 'Advance amount should not exceed net amount!');
                            callback(false);
                            return false;
                        } else {
                            callback(true);
                            return true;
                        }
                    }
                }


                function updatebookingValue() {
                    $('#bookRate').val(parseFloatVal(isNullCheck($('#unitdetail_Rate').text(),'number')));
                    $('#bookBaseAmt').val(parseFloatVal(isNullCheck($('#unitdetail_BaseAmt').text(),'number')));
                    $('#bookLandAmt').val(parseFloatVal(isNullCheck($landAmt.text(),'number')));
                    $('#bookConstructionAmt').val(parseFloatVal(isNullCheck($constructionAmt.text(),'number')));
                    $('#bookOthercostAmt').val(parseFloatVal(isNullCheck($('#unitdet_OtherAmount').text(),'number')));
                    $('#bookqualAmt').val(parseFloatVal(isNullCheck($('#unitdet_QualAmt').text(),'number')));
                    $('#booknetAmt').val(parseFloatVal(isNullCheck($('#unitdetail_NetAmt').text(),'number')));
                }

                function bindNextBtn_onClick() {
                    $('.carousel-next-btn').on('click', function (ev) {
                        ev.preventDefault();

                        var stepno = parseInt($(this).attr('data-stepno'));

                        switch (stepno) {
                            case 2:
                                validate_step1(function (isSuccess) {
                                    if (isSuccess) {
                                        var netAmt = parseFloatVal(isNullCheck($unitdetail_NetAmt.text(),'number')),
                                            baseAmt = parseFloatVal(isNullCheck($unitdetail_BaseAmt.text(),'number')),
                                            otherCostAmt = parseFloatVal(isNullCheck($unitdetail_OtherCostAmt.text(),'number')),
                                            qualAmt = parseFloatVal(isNullCheck($('#unitdet_QualAmt').text(),'number')),
                                        landcost = parseFloatVal(isNullCheck($('#landconst').text(),'number'));

                                        netAmt =  baseAmt+otherCostAmt+qualAmt+landcost;
                                        $unitdetail_NetAmt.text(sanitizeNumber(netAmt,2,true));
                                        if(mode == 'add' || mode == 'save') {
                                            //console.log(mode);
                                            load_paymentSchedules(function () {
//                                load_otherCosts(function () {
//                                    //bindOtherCost_checkList();
//                                });
                                                $carousel.carousel('next');
                                            });
                                        } else {
                                            $carousel.carousel('next');
                                        }
                                    }
                                });
                                break;
                            case 3:
                                validate_step2(function (isSuccess) {
                                    if (isSuccess) {
                                        $carousel.carousel('next');
                                    }
                                });
                                break;
                            case 4:
                                validate_step3(function (isSuccess) {
                                    if (isSuccess) {
                                        $carousel.carousel('next');
                                    }
                                });
                                break;
                            case 5:
                                validate_step4(function (isSuccess) {
                                    if (isSuccess && (mode == 'add' || mode == 'save')) {
                                        load_checkList(function () {
                                            $carousel.carousel('next');
                                        });
                                    } else if (isSuccess) {
                                        bindCheckList_datePicker();
                                        bindCheckListExecutiveName_autoComplete();
                                        bindCheckList_onSelect();
                                        $carousel.carousel('next');
                                    }
                                });
                                break;
                            case 6:
                                validate_step5(function (isSuccess) {
                                    if (isSuccess) {
                                        $carousel.carousel('next');
                                    }
                                });
                                break;
                            case 7:
                                validate_step6(function (isSuccess) {
                                    if (isSuccess) {
                                        $carousel.carousel('next');
                                    }
                                });
                                break;
                        }
                    });
                }

                function validate_step1(callback) {
                    var project_id = parseInt($project_id.val()),
                        unit_no = parseInt($unit_no.val()),
                        lead_id = parseInt($lead_id.val()),
                        booking_no = $booking_no.val().trim(),
                        booking_date = $booking_date.val().trim(),
                        unitRate = parseFloatVal($unit_rate.val()),
                        discount = parseFloatVal($discount.val()),
                        discount_type = $discount_type.val();
                    removeError($project_id);
                    removeError($unit_no);

                    $discount.trigger('change');
                    if(booking_no.length <= 0) {
                        alert('Booking No is required!');
                        $booking_no.focus();

                        callback(false);
                        return false;
                    } else if($booking_no.hasClass('already-exists')) {
                        alert('Booking No already exists!');
                        $booking_no.focus();

                        callback(false);
                        return false;
                    } else if(booking_date.length <= 0) {
                        alert('Booking Date is required!');
                        $booking_date.focus();

                        callback(false);
                        return false;
                    } else if ((mode == 'add') && isNaN(project_id)) {
                        showError($project_id, 'Project is required!');

                        callback(false);
                        return false;
                    } else if ((mode == 'save') && isNaN(lead_id)) {
                        showError($lead_id, 'LeadName is required!');

                        callback(false);
                        return false;
                    }
                    else if ((mode == 'add') &&  isNaN(unit_no)) {
                        showError($unit_no, 'Unit is required!');

                        callback(false);
                        return false;
                    } else if($('input[type=radio][name=discount_based]:checked').val()=="P" && $('#plan_list').val()=="") {
                        showError($('#plan_list'), 'Plan is required!');
                        $('#plan_list').focus();
                        callback(false);
                        return false;
                    } else if(discount_type != '' && isNaN(discount)) {
                        showError($discount, 'Discount is required!');
                        $discount.focus();
                        callback(false);
                        return false;
                    }  else if($discount_type.val() == 'P' && discount > 100) {
                        showError($discount, 'Percentage Discount should not be > 100');
                        $discount.focus();
                        callback(false);
                        return false;
                    }  else if($discount_type.val() == 'R' && parseFloat(discountLimit.Rate) < discount) {
                        showError($discount, 'Maximum discount eligibility for you is ' + parseFloat(discountLimit.Rate).toFixed(2));
                        $discount.focus();
                        callback(false);
                        return false;
                    } else if($discount_type.val() == 'L' && parseFloat(discountLimit.Lumpsum) < discount) {
                        showError($discount, 'Maximum discount eligibility for you is ' + parseFloat(discountLimit.Lumpsum).toFixed(2));
                        $discount.focus();
                        callback(false);
                        return false;
                    } else if($discount_type.val() == 'P' && parseFloat(discountLimit.Percentage) < discount) {
                        showError($discount, 'Maximum discount eligibility for you is ' + parseFloat(discountLimit.Percentage).toFixed(2)+ " %");
                        $discount.focus();
                        callback(false);
                        return false;
                    } else if($discount.hasClass('error')) {
                        callback(false);
                        return false;
                    } else {
                        callback(true);
                        return true;
                    }
                }

                function validate_step2(callback) {
                    var payment_schedule = parseInt($payment_schedule.val());

                    removeError($payment_schedule);
                    if (isNaN(payment_schedule)) {
                        showError($payment_schedule, 'Project schedule is required!');

                        callback(false);
                        return false;
                    } else {
                        callback(true);
                        return true;
                    }
                }

                function validate_step3(callback) {

                    if ($buyer_no.is(':checked')) {
                        callback(true);
                        return true;
                    } else {
                        var broker_name = $broker_name.val().trim(),
                            broker_id = parseInt($broker_id.val()),
                            commission = parseFloatVal($commission.val()),
                            amount = parseFloatVal($amount.val());

                        removeError($broker_name);
                        removeError($commission);
                        removeError($amount);
                        if (broker_name.length <= 0) {
                            showError($broker_name, 'Broker Name is required!');

                            callback(false);
                            return false;
                        }
                        else if (isNaN(broker_id)) {
                            showError($broker_name, 'Invalid Broker Name!');

                            callback(false);
                            return false;
                        } else if(isNaN(commission)) {
                            showError($commission, 'Commission is required!');

                            callback(false);
                            return false;
                        }
                        else if(commission > 100) {
                            showError($commission, 'commission should be less than equal to 100!');
                            callback(false);
                            return false;
                        }else if (isNaN(amount)) {
                            showError($amount, 'Amount is required!');

                            callback(false);
                            return false;
                        } else {
                            callback(true);
                            return true;
                        }
                    }
                }

                function validate_step4(callback) {
                    if ($loan_no.is(':checked') || $loanApprNo.is(':checked')) {
                        callback(true);
                        return true;
                    } else {
                        var proposal_no = $proposal_no.val().trim(),
                            bank_name = $bank_name.val().trim(),
                            loan_amt = parseFloatVal($loan_amt.val()),
                            sanction_date = $sanction_date.val();

                        removeError($proposal_no);
                        removeError($bank_name);
                        removeError($loan_amt);
                        removeError($sanction_date);
                        if (proposal_no.length <= 0) {
                            showError($proposal_no, 'Proposal No is required!');
                            callback(false);
                            return false;
                        } else if (bank_name.length <= 0) {
                            showError($bank_name, 'Bank Name is required!');
                            callback(false);
                            return false;
                        } else if (isNaN(loan_amt)) {
                            showError($loan_amt, 'Amount is required!');
                            callback(false);
                            return false;
                        } else if (sanction_date.length <= 0) {
                            showError($sanction_date, 'Sanction date is required!');
                            callback(false);
                            return false;
                        } else {
                            callback(true);
                            return true;
                        }
                    }
                }
                function validate_step5(callback) {

                    callback(true);
                    return;

                }
                function validate_step6(callback) {
                    var nextcalldate=$nextCallDate.val(),
                        nature=$nature_name.val(),
                        nextfollow=$nextfollow_name.val(),
                        vehicle=$vehicleAllocation.val(),
                        timepic	=$pickUpTime.val(),
                        addrpic	=$pickUpAddress.val(),
                        nremarks=$nextfollowremarks.val(),
                        remark=$remarks.val();

                        if($("#stageType_"+1).val()=='A') {

                          if(parseFloatVal($("#NetAmt_"+1).val())>0){

                          $("#advhide").hide();
                            $("#receiptshow").removeClass('hide');
                        $("#checkreceipt").val("A");
                        $("#pre_amount").val(0);
                        $("#adv_amount").val(sanitizeNumber(parseFloatVal($("#NetAmt_"+1).val()), 2, true));
                     }}


                    removeError($nextCallDate);
                    removeError($nature_name);
                    removeError($nextfollow_name);
                    removeError($vehicleAllocation);
                    removeError($pickUpTime);
                    removeError($pickUpAddress);
                    removeError($nextfollowremarks);
                    removeError($remarks);


                    if  (nature.length <= 0) {
                        showError($nature_name, 'nature is required!');
                        callback(false);
                        return false;
                    }
                    else if (nextcalldate.length <= 0) {
                        showError($nextCallDate, 'nextcalldate is required!');
                        callback(false);
                        return false;
                    }
                    else if  (nextfollow.length <= 0) {
                        showError($nextfollow_name, 'next followup type is required!');
                        callback(false);
                        return false;
                    }
                    else if(nextfollow == 5 && $('#allo_yes').is(':checked')){

                        if(timepic.length <= 0) {
                            showError($pickUpTime, 'time is required!');
                            callback(false);
                            return false;
                        }
                        else if(addrpic.length <= 0) {
                            showError($pickUpAddress, 'address is required!');
                            callback(false);
                            return false;
                        }
                        else if(nremarks.length <= 0) {
                            showError($nextfollowremarks, 'followpremarks is required!');
                            callback(false);
                            return false;
                        }

                        else if(remarks.length <= 0) {
                            showError($remarks, 'remarks is required!');
                            callback(false);
                            return false;
                        }
                        else{
                            callback(true);
                            return;
                        }
                    }
                    else if  (nremarks.length <= 0) {
                        showError($nextfollowremarks, 'followpremarks is required!');
                        callback(false);
                        return false;
                    }

                    else if  (remarks.length <= 0) {
                        showError($remarks, 'remarks is required!');
                        callback(false);
                        return false;
                    }
                    else{

                        callback(true);
                        return;
                    }
                }

                function bindOtherCostchange() {
                    $OtherCost.on('change', function () {
                        var sOC = isNullCheck($OtherCost.val(),'string');
                        var sothercost ="", dOthercost=0;
                        if (sOC != "") {
                            var arrOC = sOC.toString().split(",");

                            $.each(arrOtherCost, function (i, val) {
                                if(jQuery.inArray(arrOtherCost [i]['OtherCostId'], arrOC) !== -1) {

                                    sothercost = sothercost +  arrOtherCost [i]['OtherCostName'] + ': ' + sanitizeNumber(arrOtherCost [i]['Amount'], 2, true) + '<br/>';
                                    dOthercost = dOthercost + parseFloatVal(isNullCheck(arrOtherCost [i]['Amount'],'number'));
                                }
                            });
                        }

                        $unitdetail_OtherCostAmt.text(sanitizeNumber(dOthercost, 2, true));
                        $('#arrOtherCost').attr('data-original-title',sothercost);

                        if (ansTax==false) getTax();
                        if(mode == 'add' ||mode == 'save') {
                            $paymentScheduleWrapper.html('');
                            $payment_schedule.trigger('change');
                        }
                    });
                }

                function bindDiscount_onChange() {
                    $discount.on('change', function () {

                        removeError($discount);

                        var discount = parseFloatVal($discount.val()),
                            area = parseFloatVal($unitdetail_UnitArea.attr('data-original-value')),
                            rate = parseFloatVal($unitdetail_Rate.attr('data-original-value')),
                            baseAmt = parseFloatVal($unitdetail_BaseAmt.attr('data-original-value')),
                            grossAmt = parseFloatVal($unitdetail_GrossAmt.attr('data-original-value')),
                            netAmt = parseFloatVal($unitdetail_NetAmt.attr('data-original-value')),
                            otherCostAmt = parseFloatVal($unitdetail_OtherCostAmt.text());

                        $constructionAmt.text(sanitizeNumber(parseFloatVal($constructionAmt.attr('data-original-value')),2,true));
                        $landAmt.text(sanitizeNumber(parseFloatVal($landAmt.attr('data-original-value')),2,true));
                        $unitdetail_Rate.text(sanitizeNumber(rate,2,true));
                        $unitdetail_BaseAmt.text(sanitizeNumber(baseAmt,2,true));
                        $unitdetail_GrossAmt.text(sanitizeNumber(grossAmt,2,true));
                        //     $unitdetail_NetAmt.text(sanitizeNumber(netAmt,2,true));

                        //   $paymentScheduleWrapper.html('');
                        if ($discount_type.val() == 'L') {
                            // lumpsum
                            var lumpsumType = $lumpsumType.filter(':checked').val();
                            if (lumpsumType == 'O') {
                                // overall
                                if(discount > baseAmt) {
                                    showError($discount, 'Discount should be lesser than Base Amount!');
                                    return;
                                }

                                baseAmt = baseAmt - discount;
                                grossAmt = baseAmt;
                                netAmt = grossAmt;
                                var landAmt = parseFloatVal($landAmt.attr('data-original-value'));
                                var constAmt = baseAmt-landAmt;
                                $constructionAmt.text(sanitizeNumber(constAmt,2,true));
                            } else {
                                // receipt wise
                                var receiptType = $lumpsum_receipt_wise.val();
                                if(receiptType.length <= 0) {
                                    showError($lumpsum_receipt_wise, 'Select Receipt Type!');
                                    return;
                                }

                                var $selReceiptType = $lumpsum_receipt_wise.find('option:selected'),
                                    selReceipt = $selReceiptType.attr('data-type');

                                if(selReceipt == 'C') {
                                    var constAmt = parseFloatVal($constructionAmt.attr('data-original-value'));
                                    if(discount > constAmt) {
                                        showError($discount, 'Discount should be lesser than Construction Amount!');
                                        return;
                                    }
                                    constAmt -= discount;
                                    $constructionAmt.text(sanitizeNumber(constAmt,2,true));
                                } else if(selReceipt == 'L') {
                                    var landAmt = parseFloatVal($landAmt.attr('data-original-value'));
                                    if(discount > landAmt) {
                                        showError($discount, 'Discount should be lesser than Land Amount!');
                                        return;
                                    }
                                    landAmt -= discount;
                                    $landAmt.text(sanitizeNumber(landAmt,2,true));
                                }

                                baseAmt -= discount;
                            }
                        } else if ($discount_type.val() == 'R') {
                            // unit rate
                            if (discount > rate) {
                                showError($discount, 'Discount should be lesser than Unit rate!');
                                return;
                            } else {
                                rate = rate - discount;
                                baseAmt = rate * area;
                                var landAmt = parseFloatVal($landAmt.attr('data-original-value'));
                                var constAmt = baseAmt-landAmt;
                                $constructionAmt.text(sanitizeNumber(constAmt,2,true));
                            }
                        } else if($discount_type.val() =='P') {
                            var lumpsumType = $lumpsumType.filter(':checked').val();
                            if (lumpsumType == 'O') {
                                // overall
                                discount=baseAmt * (discount/100);

                                baseAmt = baseAmt - discount;
                                grossAmt = baseAmt;
                                netAmt = grossAmt;
                                var landAmt = parseFloatVal($landAmt.attr('data-original-value'));
                                var constAmt = baseAmt-landAmt;
                                $constructionAmt.text(sanitizeNumber(constAmt,2,true));
                            } else {
                                // receipt wise
                                var receiptType = $lumpsum_receipt_wise.val();

                                if(receiptType.length <= 0 ) {
                                    showError($lumpsum_receipt_wise, 'Select Receipt Type!');
                                    return;
                                }

                                var $selReceiptType = $lumpsum_receipt_wise.find('option:selected'),
                                    selReceipt = $selReceiptType.attr('data-type');

                                if(selReceipt == 'C') {
                                    var constAmt = parseFloatVal($constructionAmt.attr('data-original-value'));
                                    discount=constAmt * (discount/100);

                                    constAmt -= discount;
                                    $constructionAmt.text(sanitizeNumber(constAmt,2,true));
                                } else if(selReceipt == 'L') {
                                    var landAmt = parseFloatVal($landAmt.attr('data-original-value'));
                                    discount=landAmt * (discount/100);

                                    landAmt -= discount;
                                    $landAmt.text(sanitizeNumber(landAmt,2,true));
                                }

                                baseAmt -= discount;
                            }
                        }
                        grossAmt = baseAmt;
                        netAmt = grossAmt;
                        if (!isNaN(otherCostAmt)) {
                            grossAmt = baseAmt + otherCostAmt;
                            netAmt = grossAmt;
                        }

                        $unitdetail_Rate.text(sanitizeNumber(rate,2,true));
                        $unitdetail_BaseAmt.text(sanitizeNumber(baseAmt,2,true));
                        $unitdetail_GrossAmt.text(sanitizeNumber(grossAmt,2,true));


                        if (ansTax==false) getTax();
                        $paymentScheduleWrapper.html('');
                        if($("#landconst").text()!='' || $("#landconst").text()!=0.00) {
                            var netamt= parseFloatVal($unitdetail_NetAmt.text()) + parseFloatVal($("#landconst").text());
                            $unitdetail_NetAmt.text(sanitizeNumber(netamt,2,true));
                        }
                        $payment_schedule.trigger('change');
                    });
                }

                function bindBookingDate_onChange() {
                    $booking_date.on('change', function() {
                        //$paymentScheduleWrapper.html('');
                    });
                }

                function bindUnit_onChange() {
                    $unit_no.on('change', function () {

                        removeError($unit_no);

                        load_unitDetails(function () {
                            $unitDetailWrapper.removeClass('hide');
                            $unit_no.removeAttr('disabled');
                            $('#discount_based_wrapper').removeClass('hide');
                            $('#other_cost_wrapper').removeClass('hide');
                            $buyerWrapper.removeClass('hide');
                            $unitpriceWrapper.removeClass('hide');
                            $discountTypeWrapper.removeClass('hide');
                            var  netAmt = parseFloatVal($unitdetail_NetAmt.attr('data-original-value')),
                                baseAmt = parseFloatVal($unitdetail_BaseAmt.attr('data-original-value')),
                                otherCostAmt = parseFloatVal($unitdetail_OtherCostAmt.text());

//                if (!isNaN(otherCostAmt)) {
//                    grossAmt = baseAmt + otherCostAmt;
//                    netAmt = grossAmt;
//                }
                            //$unitdetail_NetAmt.text(sanitizeNumber(netAmt,2,true));
                            $discount.trigger('change');
                        });

                    });
                }

                function bindDiscountType_onChange() {
                    $discount_type.on('change', function() {

                        var discountType = $discount_type.val().trim();

                        $discountWrapper.addClass('hide');
                        $lumpsumTypeWrapper.addClass('hide');
                        $lumpsumReceiptWiseWrapper.addClass('hide');

                        $discount.trigger('change');
                        $lumpsumType.removeAttr('checked');
                        if(discountType.length > 0 ) {
                            if(discountType == 'L' || discountType=='P') {
                                $lumpsumTypeWrapper.removeClass('hide');
                            } else {
                                $discountWrapper.removeClass('hide');
                            }
                        }
                    });
                }

                function bindLumpsumType_onChange() {
                    $lumpsumType.on('change', function() {

                        var lumpsumType = $(this).val();
                        if(lumpsumType == 'O') {
                            $discountWrapper.removeClass('hide');
                            $lumpsumReceiptWiseWrapper.addClass('hide');
                        } else {
                            $discountWrapper.addClass('hide');
                            $lumpsumReceiptWiseWrapper.removeClass('hide');
                        }
                        $lumpsum_receipt_wise.find('option').removeAttr('selected');
                        $discount.val('').trigger('change');
                    });
                }

                function bindLumpsumReceiptWise_onChange() {
                    $lumpsum_receipt_wise.on('change', function() {
                        var receiptWise = $(this).val();
                        if(receiptWise.length > 0) {
                            $discountWrapper.removeClass('hide');
                        } else {
                            $discountWrapper.addClass('hide');
                        }
                        $discount.val('').trigger('change');
                    });
                }

                function load_unitDetails(callback) {


                    var unit_id = $unit_no.val();

                    if(mode == 'edit' ||mode == 'save' ) {


                        unit_id = $unit_id.val();
                    }

                    ansTax=true;
                    var lead_id = $('#lead_id').val();
                    if (/^\d+$/.test(unit_id) === false) {
                        return;
                    }

                    $unit_no.attr('disabled', true);
                    arrOtherCost=[];
                    $('#OtherCost').html("");
                    var ajaxData = {csrf: "<?php echo isset($csrf)?$csrf:''; ?>", UnitId: unit_id,LeadId:lead_id,payment_schedule_id:$payment_schedule.val()};
                    if(mode == 'add' || mode == 'save') {
                        ajaxData.lead = lead_id;
                        ajaxData.RequestFrom =  'finalisation';
                        ajaxData.payment_schedule_id = $payment_schedule.val();
                    }

                    $.ajax({
                        url: getBaseURL() + 'crm/lead/unitdetail',
                        data: ajaxData,
                        type: 'POST',
                        async: false,
                        success: function (data, status, xhr) {
                            var othercost= 0,
                                sothercost='';

                            $.each(data.unitamt, function (index, other) {

                                if (other.Amount==null) {
                                    othercost=0;
                                }
                                else {
                                    othercost += parseFloatVal(other.Amount);
                                    sothercost = sothercost +  other.OtherCostName + ': ' + sanitizeNumber(other.Amount, 2, true) + '<br/>';

                                    $('<option/>').val(other.OtherCostId).html(other.OtherCostName).appendTo('#OtherCost');
                                    $('#OtherCost option[value="'+other.OtherCostId+'"]').attr("selected", true).trigger('change');

                                    arrOtherCost.push({
                                        OtherCostId: other.OtherCostId,
                                        OtherCostName:other.OtherCostName,
                                        Amount: other.Amount,
                                        'Area': other.Area,
                                        'Rate': other.Rate
                                    });

                                }
                            });
                            if(data.land!='' || data.land!=0.00) {
                                $("#landconst").text(sanitizeNumber(data.land,2,true));
                                $("#lndcnst").removeClass('hide');

                            }

                            $unitdetail_OtherCostAmt.text(sanitizeNumber(othercost, 2, true));
                            $('#arrOtherCost').attr('data-original-title',sothercost);

                            $.each(data.unit_detail, function (index, detail) {
                                var $tarDetail = $unitDetailWrapper.find('#unitdetail_' + index);

                                if (detail == 0 || detail == null || detail.trim() == '') {
                                    $tarDetail.closest('.row').addClass('hide');
                                } else {
                                    $tarDetail.closest('.row').removeClass('hide');
                                    if(index!="NetAmt" && index != 'AdvAmount') {
                                        $tarDetail.text(sanitizeNumber(detail,2,true)).attr('data-original-value', detail);
                                    } else {
                                        $tarDetail.text(sanitizeNumber(detail,2,true)).attr('data-original-value', detail);
                                    }
                                }
                            });

                            $unit_rate.val(data.unit_detail.Rate).trigger('change');
                            var disType = $.trim(data.unit_detail.DiscountType);
                            if(disType != "") {
                                $('#discount_type  option[value="'+disType+'"]').attr("selected", true).trigger('change');
                                if(disType=="L") {
                                    var lumId = parseInt($.trim(data.unit_detail.LumpsumReceiptId));
                                    var lumData ="";
                                    if(lumId==0) {
                                        lumData="O";
                                    } else {
                                        lumData="R";
                                    }
                                    $('input[name="lumpsum_type"][value="' + lumData + '"]')
                                        .prop('checked', true)
                                        .trigger('change');
                                    if(lumData=="R"){
                                        $('#lumpsum_receipt_wise  option[value="'+lumId+'"]').attr("selected", true).trigger('change');
                                    }
                                }
                            }
                            $adv_amount.val(sanitizeNumber(data.unit_detail.AdvAmount,2,true));
                            console.log($adv_amount.val());
                            if($adv_amount.val()==0 ||$adv_amount.val()==''){

                                $("#receiptshow").addClass('hide');
                            }
                            $discount.val(sanitizeNumber(data.unit_detail.RateDiscount,2,true));
                            $discount.trigger('change');
                            $discount.closest('div').addClass('dirty');

                            var prename=data.prebook.Name;
                            var prebook=parseFloatVal(data.prebook.AdvAmount);
                            var prebookdis=parseFloatVal(data.prebook.Discount);
                            var prebookdistype=data.prebook.DiscountType;

                            var dist='';
                            if(prename=='prebook'){
                                $("#prediscount").attr('label','PreBook Discount');
                            }
                            else if(prename=='block'){
                                $("#prediscount").attr('label','Block Discount');
                            }
                            else if(prename=='proposal'){
                                $("#prediscount").attr('label','Proposal Discount');
                            }
                            if(prebookdistype!=0||prebookdistype!=''){
                                if(prebookdistype=='R'){
                                    dist='Rate';
                                }
                                else{
                                    dist='Lumpsum';
                                }
                            }


                            if(prebookdis!=0||prebookdis!=''){
                                var predis=prebookdis+'('+dist+')';
                                $("#prediscount").val(predis);
                                $("#predis-wrapper").show();
                            }
                            else{
                                $("#predis-wrapper").hide();
                            }


                            if(prebook>0 || prebook!=0){
                                $("#pre_amount").val(sanitizeNumber(prebook,2,true));
                                var adv_amount=parseFloatVal(data.unit_detail.AdvAmount);
                                if(adv_amount > prebook){
                                    adv_amount= adv_amount-prebook;
                                    $("#receiptshow").removeClass('hide');

                                }else{
                                    adv_amount= 0;
                                    $("#receipt_no").attr('Checked',true);
                                    $("#receiptshow").addClass('hide');

                                }
                                $adv_amount.val(sanitizeNumber(adv_amount,2,true));
                                console.log($adv_amount.val());

                                $("#prebooking").show();
                            }


                            if (callback) {
                                callback();
                            }
                        },
                        error: function (xhr, status, error) {
                            alert(xhr.responseText);

                            $unit_no.removeAttr('disabled');
                        }
                    });
                    getTax();
                    ansTax = false;

                    if($("#landconst").text()!='' || $("#landconst").text()!=0.00) {

                     var netamt= parseFloatVal($unitdetail_NetAmt.text()) + parseFloatVal($("#landconst").text());
                        $unitdetail_NetAmt.text(sanitizeNumber(netamt,2,true));
                    }



                }

                function bindProject_onChange() {

                    $project_id.on('change', function () {


                        removeError($project_id);

                        resetUnitData();

                        load_units(function () {

                            $unitnoWrapper.removeClass('hide');
                        });
                    });
                }

                function resetUnitData() {
                    $buyerWrapper.addClass('hide');
                    $unitpriceWrapper.addClass('hide');
                    $('#other_cost_wrapper').addClass('hide');
                    $discountWrapper.addClass('hide');
                    $discountTypeWrapper.addClass('hide');
                    $unitDetailWrapper.addClass('hide');

                    $unit_rate.val('');
                    $discount.val('');

                    $unit_no.select2('val', '');
                }

                function load_units(callback) {

                    var project_id = $project_id.val();
                    var lead_Id = $('#lead_id').val();
                    if (/^\d+$/.test(project_id) === false) {
                        return;
                    }

                    $unit_no.attr('disabled', true);

                    $.ajax({
                        url: getBaseURL() + 'crm/lead/units',
                        data: {csrf: "<?php echo isset($csrf)?$csrf:''; ?>", ProjectId: project_id,Lead_Id:lead_Id,'mode':'final'},
                        type: 'POST',
                        success: function (data, status, xhr) {
                            if (data.units.length > 0) {
                                var opHtml = '<option value=""></option>';
                                $.each(data.units, function (index, unit) {
                                    opHtml += '<option value="' + unit.UnitId + '">' + unit.UnitNo + '</option>';
                                });
                                $unit_no.html(opHtml);
                            }

                            $unit_no.removeAttr('disabled');

                            if (callback) {
                                callback();
                            }
                        },
                        error: function (xhr, status, error) {
                            alert(xhr.responseText);
                        }
                    });
                }

                function getTax() {

                    var arrCost = [],dGrossAmt=0;
                    var landAmt = parseFloatVal(isNullCheck($landAmt.text(),'number')),
                        constructionAmt = parseFloatVal(isNullCheck($constructionAmt.text(),'number'));

                    dGrossAmt = landAmt+ constructionAmt;

                    arrCost.push({
                        ReceiptType:'S',
                        TypeId: 1,
                        Amount: landAmt
                    });
                    arrCost.push({
                        ReceiptType:'S',
                        TypeId: 2,
                        Amount: constructionAmt
                    });

                    var sOC = isNullCheck($OtherCost.val(),'string');
                    var sothercost ="", dOthercost=0;
                    if (sOC != "") {
                        var arrOC = sOC.toString().split(",");
                        $.each(arrOtherCost, function (i, val) {
                            if(jQuery.inArray(arrOtherCost [i]['OtherCostId'], arrOC) !== -1) {
                                arrCost.push({
                                    ReceiptType:'O',
                                    TypeId: arrOtherCost [i]['OtherCostId'],
                                    Amount: arrOtherCost [i]['Amount']
                                });
                                dGrossAmt = dGrossAmt + parseFloat(isNullCheck(arrOtherCost [i]['Amount'],'number'));
                            }
                        });
                    }

                    $unitdetail_GrossAmt.text(sanitizeNumber(dGrossAmt,2,true));

//        $.each(arrOtherCost , function(i, val) {
//            arrCost.push({
//                ReceiptType:'O',
//                TypeId: arrOtherCost [i]['OtherCostId'],
//                Amount: arrOtherCost [i]['Amount']
//            });
//            dGrossAmt = dGrossAmt + parseFloat(isNullCheck(arrOtherCost [i]['Amount'],'number'));
//        });

                    var dDate = new Date();
                    var arrCost = JSON.stringify(arrCost);

                    $.ajax({
                        url: getBaseURL() + 'crm/lead/getTax',
                        data: {csrf: "<?php echo isset($csrf)?$csrf:''; ?>",arrReceipt:arrCost, GrossAmt:dGrossAmt,shDate:dDate},
                        async: false,
                        type: 'POST',
                        success: function (data, status, xhr) {

                            var dTax= 0,sTax='';
                            $.each(data.arrTax, function (index, tax) {
                                var dTaxAmt = parseFloatVal(isNullCheck(tax.Amount,'number'));
                                if (dTaxAmt !=0) {
                                    dTax = dTax+dTaxAmt;
                                    sTax = sTax +  tax.QualifierName + ': ' + sanitizeNumber(dTaxAmt, 2, true) + '<br/>';
                                }
                            });

                            $('#unitdet_QualAmt').text(sanitizeNumber(dTax, 2, true));
                            $('#arrQualAmt').attr('data-original-title',sTax);

                            $('#unitdetail_NetAmt').text(sanitizeNumber(dGrossAmt+dTax, 2, true));
                        },
                        error: function (xhr, status, error) {
                            alert(xhr.responseText);
                        }
                    });

                    updatebookingValue();
                }

                function load_otherCosts(callback) {

                    var project_id = $project_id.val();
                    if (/^\d+$/.test(project_id) === false) {
                        return;
                    }

                    $.ajax({
                        url: getBaseURL() + 'crm/lead/othercost',
                        data: {csrf: "<?php echo isset($csrf)?$csrf:''; ?>", ProjectId: project_id},
                        type: 'POST',
                        success: function (data, status, xhr) {
                            if (data.other_costs.length > 0) {
                                var opHtml = '';
                                $.each(data.other_costs, function (index, other_cost) {
                                    opHtml += '<li class="tile ui-sortable-handle">'
                                    + '<div class="checkbox checkbox-styled tile-text vendor_checkboxborder_gray">'
                                    + '<label>'
                                    + '<input type="checkbox" name="other_cost[]" value="' + other_cost.OtherCostId + '">'
                                    + '<span>' + other_cost.OtherCostName + '</span>'
                                    + '</label>'
                                    + '</div>'
                                    + '</li>';
                                });
                                $unCheckedUI.html(opHtml);
                            }
                            $checkedUI.html('');

                            if (callback) {
                                callback();
                            }
                        },
                        error: function (xhr, status, error) {
                            alert(xhr.responseText);
                        }
                    });
                }

                function load_checkList(callback) {

                    var project_id = $project_id.val();
                    if (/^\d+$/.test(project_id) === false) {
                        return;
                    }

                    $.ajax({
                        url: getBaseURL() + 'crm/lead/checklist',
                        data: {csrf: "<?php echo isset($csrf)?$csrf:''; ?>", ProjectId: project_id},
                        type: 'POST',
                        success: function (data, status, xhr) {
                            if (data.check_lists.length > 0) {
                                var opHtml = '';
                                $.each(data.check_lists, function (index, check_list) {
                                    opHtml += '<tr>'
                                    + '<td class="tbl_input_td">'
                                    + '<div class="radio_check">'
                                    + '<p>'
                                    + '<input type="checkbox" value="' + check_list.CheckListId + '" id="check_list_' + check_list.CheckListId + '" name="check_list[]" />'
                                    + '<label for="check_list_' + check_list.CheckListId + '" class="ripple"></label>'
                                    + '</p>'
                                    + '</div>'
                                    + '</td>'
                                    + '<td>' + check_list.CheckListName + '</td>'
                                    + '<td>'
                                    + '<div style="width: 200px; height: 40px; position:relative;">'
                                    + '<span class="date_icon hide"><i class="fa fa-calendar"></i></span>'
                                    + '<input type="text" class="form-control date_picker hide" onchange="validateDate(this)" name="check_list_date_' + check_list.CheckListId + '" readonly />'
                                    + '</div>'
                                    + '</td>'
                                    + '<td>'
                                    + '<div style="width: 400px;">'
                                    + '<input type="text" class="form-control executive-name hide" name="check_list_executive_name_' + check_list.CheckListId + '" disabled />'
                                    + '<input type="hidden" class="executive-id" name="check_list_executive_id_' + check_list.CheckListId + '" disabled />'
                                    + '</div>'
                                    + '</td>'
                                    + '</tr>';
                                });
                                $checkListTable.find('tbody').html(opHtml);

                                bindCheckList_datePicker();
                                bindCheckListExecutiveName_autoComplete();
                                bindCheckList_onSelect();
                            }

                            if (callback) {
                                callback();
                            }
                        },
                        error: function (xhr, status, error) {
                            alert(xhr.responseText);
                        }
                    });
                }

                function bindCheckList_onSelect() {
                    $checkListTable.on('change', 'tr td input[type="checkbox"]', function() {
                        var $this = $(this),
                            $tarTr = $this.closest('tr');

                        if($this.is(':checked')) {
                            $tarTr.find('input[type="text"]').removeAttr('disabled').removeClass('hide');
                            $tarTr.find('input[type="hidden"]').removeAttr('disabled');
                            $tarTr.find('.date_icon').removeClass('hide');
                        } else {
                            $tarTr.find('input[type="text"]').attr('disabled', true).val('').addClass('hide');
                            $tarTr.find('input[type="hidden"]').attr('disabled', true).val('');
                            $tarTr.find('.date_icon').addClass('hide');
                        }
                    });
                }

                function bindCheckList_datePicker() {
                    $checkListTable.find('tr td .date_picker').datepicker({
                        'format': 'dd-mm-yyyy'
                    }).on('changeDate', function() {
                        $('.datepicker').hide();
                    }).data('datepicker');

                    $checkListTable.find('tr td .date_icon').click(function() {

                        if($(this).hasClass('disable')) {
                            return;
                        } else {
                            $(this).parent().find('input').datepicker('show');
                        }
                    });
                }

                function bindCheckListExecutiveName_autoComplete() {

                    $checkListTable.find('tr td .executive-name').autocomplete({
                        lookup: <?php echo (isset($arrExecutives))?json_encode($arrExecutives):'[]'; ?>,
                        lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                            if (queryLowerCase == '*') {
                                return suggestion.value;
                            } else {
                                var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                                return re.test(suggestion.value);
                            }
                        }, onSelect: function (suggestion) {
                            if (suggestion) {
                                $(this).closest('td').find('.executive-id').val(suggestion.data);

                                removeError($(this));
                            }
                        }, onSearchStart: function (suggestion) {
                            $(this).closest('td').find('.executive-id').val('');
                        }, onSearchComplete: function (query, suggestions) {
                            if (!suggestions.length) {
                                $(this).closest('td').find('.executive-id').val('');
                                showError($(this), 'Executive Name not found!');
                            } else {
                                removeError($(this));
                            }
                        }
                    });
                }

                function load_paymentSchedules(callback) {

                    var project_id = $project_id.val();

                    if (/^\d+$/.test(project_id) === false) {
                        return;
                    }

                    var iSchId = parseInt(isNullCheck($payment_schedule.val(),'number'));
                    if (iSchId !=0) {
                        if (callback) {
                            callback();
                        }
                        return;
                    }

                    $.ajax({
                        url: getBaseURL() + 'crm/lead/paymentschedules',
                        data: {csrf: "<?php echo isset($csrf)?$csrf:''; ?>", ProjectId: project_id},
                        type: 'POST',
                        success: function (data, status, xhr) {
                            var opHtml = '<option value=""></option>';
                            if (data.payment_schedules.length > 0) {
                                $.each(data.payment_schedules, function (index, payment_schedule) {
                                    opHtml += '<option value="' + payment_schedule.PaymentScheduleId + '" data-typeid="'+payment_schedule.ScheduleTypeId+'">' + payment_schedule.PaymentSchedule + '</option>';
                                });
                            }
                            $payment_schedule.html(opHtml);
                            $payment_schedule.select2();

                            $paymentScheduleContainer.addClass('hide');

                            if (callback) {
                                callback();
                            }
                        },
                        error: function (xhr, status, error) {
                            alert(xhr.responseText);
                        }
                    });
                }

                function showPaymentScheduleDetails(callback) {

                    var payment_schedule_id = $payment_schedule.val();
                    if (/^\d+$/.test(payment_schedule_id) === false) {
                        return;
                    }

                    //$paymentScheduleWrapper.html('');

                    var $tarPSTable = $paymentScheduleWrapper.find('.payment-schedule[data-id="'+payment_schedule_id+'"]');
                    if ($tarPSTable.length > 0) {
                        $tarPSTable.removeClass('hide').siblings('.payment-schedule').addClass('hide');
                        callback();
                    } else {
                        $paymentScheduleWrapper.find('.payment-schedule:not(.hide)').addClass('hide');
                        load_paymentScheduleDetail(function() {
                            callback();
                        });
                    }

                }
                function load_paymentScheduleDetail(callback) {

                    var payment_schedule_id = $payment_schedule.val();
                    var $sel_payment_schedule = $payment_schedule.find('option:selected');

                    if($sel_payment_schedule.length == 0)
                        return;

                    var project_id = $project_id.val();
                    if (/^\d+$/.test(project_id) === false) {
                        return;
                    }

                    var unit_id = $unit_no.val();
                    if(mode == 'edit' || mode=='save' ) {
                        unit_id = $('#unit_id').val();
                    }
                    if (/^\d+$/.test(unit_id) === false) {
                        return;
                    }

                    var landAmt = parseFloatVal(isNullCheck($landAmt.text(),'number')),
                        constructionAmt = parseFloatVal(isNullCheck($constructionAmt.text(),'number')),
                        othcostAmt = parseFloatVal(isNullCheck($('#unitdet_OtherAmount').text(),'number'));


                    var othCost = $('#OtherCost').val();

                    var grossAmt = landAmt+constructionAmt+othcostAmt;

                    //var grossAmt = parseFloatVal(isNullCheck($unitdetail_GrossAmt.text,'number'));

                    $backToCustSchForm.hide();
                    if($sel_payment_schedule.attr('data-typeid') == '2') {
//            $('.savebtn_area').hide();
                        $paymentScheduleContainer.removeClass('hide');
                        $paymentScheduleWrapper.html('').hide();
                        $paymentScheduleForm.show();
                        $('.loading_area').show();
                        $.ajax({
                            url: getBaseURL() + 'crm/lead/paymentscheduledetail',
                            async: false,
                            data: {
                                csrf: "<?php echo isset($csrf)?$csrf:''; ?>",
                                ProjectId: project_id,
                                GrossAmt:grossAmt,
                                PaymentScheduleId: payment_schedule_id,
                                BookingDate: $booking_date.val(),
                                UnitId: unit_id,
                                OtherCostIds:  othCost,
                                Type: 'custom'
                            },
                            type: 'POST',
                            success: function (data, status, xhr) {
                                if(data.payment_schedule_detail.length != 0) {
                                    custom_payment_schedule_details=data.payment_schedule_detail;
                                    othercostadd=data.othercostadd;



                                } else {
                                    custom_payment_schedule_details=null;
                                }
                                $('.loading_area').hide();
                            }, error: function (xhr, status, error) {
                                custom_payment_schedule_details=null;
                                $('.loading_area').hide();
                            }
                        });
                    } else {
//            $('.savebtn_area').show();
                        $paymentScheduleWrapper.html('').show();
                        $paymentScheduleForm.hide();
                        var baseAmt = parseFloatVal($unitdetail_BaseAmt.text());
                        $.ajax({
                            url: getBaseURL() + 'crm/lead/paymentscheduledetail',
                            data: {
                                csrf: "<?php echo isset($csrf)?$csrf:''; ?>",
                                ProjectId: project_id,
                                GrossAmt:grossAmt,
                                PaymentScheduleId: payment_schedule_id,
                                BookingDate: $booking_date.val(),
                                OtherCostIds:  othCost,
                                UnitId: unit_id
                            },
                            type: 'POST',
                            success: function (data, status, xhr) {
                                if (data.payment_schedule_detail.length > 0) {
                                    var opHtml = $paymentScheduleTemplate.html();
                                    opHtml = opHtml.replace(/payment_schedule_id__/g, payment_schedule_id);
                                    $paymentScheduleWrapper.append(opHtml);
                                    var $tarPSTable = $paymentScheduleWrapper.find('.payment-schedule[data-id="' + payment_schedule_id + '"]');
                                    var sumPercent = 0;
                                    var rowHtml = '', i = 0;
                                    //var other = parseFloatVal(isNullCheck($unitdetail_OtherCostAmt.text(),'number'));
                                    var other = 0;
                                    var sumshAmt=0;

                                    $.each(data.other, function (index, otherval) {

                                        other += parseFloatVal(otherval.Amount);

                                    });

                                    baseAmt += other;

                                    $.each(data.payment_schedule_detail, function (j, ps_detail) {

                                        i += 1;
                                        var baseAmount = 0;
                                        var scheduleAmt = 0;
                                        var schPercent = parseFloatVal(isNullCheck(ps_detail.Percentage,'number'));
                                        if (ps_detail.StageType != 'O')  sumPercent += schPercent;

                                        if (ps_detail.StageType == 'A') {

                                            if (schPercent != 0) {
                                                scheduleAmt = (baseAmt * schPercent) / 100;
                                            } else {
                                                scheduleAmt = parseFloatVal(ps_detail.Amount);
                                                baseAmt -= scheduleAmt;
                                            }

                                        } else if (ps_detail.StageType == 'O') {
                                            scheduleAmt = parseFloatVal(ps_detail.schedule_amt);
                                        } else {
                                            scheduleAmt = (baseAmt * parseFloatVal(ps_detail.Percentage)) / 100;
                                        }

                                        var roundOff = parseFloatVal(ps_detail.RoundOff);
                                        if (roundOff == 0) {
                                            roundOff = '';
                                        } else {
                                            scheduleAmt = Math.round(scheduleAmt / roundOff) * roundOff;
                                        }

                                        var schDate = '';
                                        if (ps_detail.PaymentScheduleDate != null) {
                                            schDate = ps_detail.PaymentScheduleDate;
                                        }
                                        rowHtml += '<tr class="mainTr">'
                                        + '<td>' + ps_detail.StageName + '</td>'
                                        + '<td>' + schDate + '</td>'
                                        + '<td id="round_' + j + '" >' + roundOff + '</td>';

                                        if (isNaN(schPercent) || schPercent == 0) {
                                            schPercent = '';
                                        } else {
                                            schPercent += '%';
                                        }

                                        if (ps_detail.StageType == 'O') schPercent ='';

                                        sumshAmt += scheduleAmt;
                                        var isReceiptFound = true;
                                        if (ps_detail.hasOwnProperty('arrReceiptTypes') == false
                                            || ps_detail.arrReceiptTypes.length <= 0) {
                                            isReceiptFound = false;
                                        }
                                        rowHtml += '<td><input type="text" name="shPer_' + i + '" class="tbl_input txt_right" value="' + schPercent + '">'+ '</td>'
                                        + '<td><input type="text" name="CurAmt_' + i + '" class="tbl_input txt_right" value="' + sanitizeNumber(scheduleAmt,2,true) + '"></td>'
                                        + '<td><input type="text" name="TaxAmt_' + i + '" class="tbl_input sch-tax schtax txt_right"></td>'
                                        + '<td><input type="text" name="NetAmt_' + i + '" id="NetAmt_' + i + '" class="tbl_input sch-net-amt schnet txt_right" value="' + sanitizeNumber(scheduleAmt,2,true) + '"></td>'
                                        + '<input type="hidden" name="stageId_' + i + '"  value = "' + ps_detail.StageId + '"/>'
                                        + '<input type="hidden" id="stageType_' + i + '" name="stageType_' + i + '" value = "' + ps_detail.StageType + '"/>'
                                        + '<input type="hidden" name="schDate_' + i + '" value = "' + ps_detail.schDate + '"/>'
                                        + '<input type="hidden" name="schRound_' + i + '" value = "' + roundOff + '"/>'
                                        + '<input type="hidden" name="schSortId_' + i + '" value = "' + ps_detail.SortId + '"/>'
                                        + '<td>';

                                        if (isReceiptFound) {
                                            rowHtml += '<ul class="action_btns">'
                                            + '<li><a href="#" class="subTr"><i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="top" data-original-title="Expand"></i></a></li>'
                                            + '</ul>';
                                        }
                                        rowHtml += '</td>'
                                        + '</tr>';

                                        if (isReceiptFound) {
                                            rowHtml += '<tr style="display: none;" class="subTr">'
                                            + '<td colspan="11" style="padding:0px !important; ">'
                                            + '<div class="subDiv">'
                                            + '<div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"></div>'
                                            + '<div class="col-lg-12">'
                                            + '<div class="table-responsive topsp">'
                                            + '<table class="table receipt-type-table" style="margin-bottom:0px;">'
                                            + '<thead>'
                                            + '<tr>'
                                            + '<th>Receipt Type</th>'
                                            + '<th>Amount</th>'
                                            + '<th>Tax</th>'
                                            + '<th>Net Amount</th>'
                                            + '<th></th>'
                                            + '</tr>'
                                            + '</thead>'
                                            + '<tbody>';
                                            var curReceiptType = '',
                                                otherCostAmt = 0, j = 0;

                                            $.each(ps_detail.arrReceiptTypes, function (index, receipt) {

                                                var curAmt = 0;
                                                if (curReceiptType == '') {
                                                    curReceiptType = receipt.TypeId;
                                                    if (curReceiptType == 'O') {
                                                        otherCostAmt = 0;

                                                        $.each(arrOtherCost , function(i, val) {
                                                            if (arrOtherCost[i]['OtherCostId'] == receipt.ReceiptTypeId) otherCostAmt = arrOtherCost [i]['Amount'];

                                                        });
                                                    }
                                                }


                                                switch (curReceiptType) {
                                                    case 'L' :

                                                        if (landAmt <= 0) {
                                                            curAmt = 0;
                                                            curReceiptType = '';

                                                        } else if (scheduleAmt <= landAmt) {
                                                            curAmt = scheduleAmt;
                                                            landAmt -= scheduleAmt;
                                                            scheduleAmt = 0;

                                                        } else if (scheduleAmt > landAmt) {
                                                            curAmt = landAmt;
                                                            scheduleAmt -= landAmt;
                                                            landAmt = 0;
                                                            curReceiptType = '';

                                                        }

                                                        break;
                                                    case 'C':
                                                        if (constructionAmt <= 0) {

                                                            curAmt = 0;
                                                            curReceiptType = '';

                                                        } else if (scheduleAmt <= constructionAmt) {

                                                            curAmt = scheduleAmt;
                                                            constructionAmt -= scheduleAmt;
                                                            scheduleAmt = 0;
                                                        } else if (scheduleAmt > constructionAmt) {

                                                            curAmt = constructionAmt;
                                                            scheduleAmt -= constructionAmt;
                                                            constructionAmt = 0;
                                                            curReceiptType = '';

                                                        }

                                                        break;
                                                    default:
                                                        if (otherCostAmt <= 0) {
                                                            curAmt = 0;
                                                            curReceiptType = '';
                                                        } else if (scheduleAmt <= otherCostAmt) {

                                                            curAmt = scheduleAmt;
                                                            otherCostAmt -= scheduleAmt;
                                                            scheduleAmt = 0;
                                                        } else if (scheduleAmt > otherCostAmt) {

                                                            curAmt = otherCostAmt;
                                                            scheduleAmt -= otherCostAmt;
                                                            otherCostAmt = 0;
                                                            curReceiptType = '';
                                                        }
                                                        break;
                                                }

//                                    if (ps_detail.StageType == 'O') {
//                                        curAmt = parseFloatVal(ps_detail.schedule_amt);
//                                    }


                                                 if(receipt.TypeId=='O' &&  receipt.ReceiptName=='Land Registration') {
                                                     curAmt = parseFloatVal(isNullCheck(data.land,'number'));

                                                 }
                                               else if(receipt.TypeId=='O' &&  receipt.ReceiptName=='Construction Registration') {
                                                    curAmt = parseFloatVal(isNullCheck(data.const,'number'));
                                                }

                                                curAmt = parseFloatVal(isNullCheck(curAmt,'number'));


                                                if (curAmt !=0) {
                                                    j += 1;

                                                    rowHtml += '<tr><td>' + receipt.ReceiptName + '</td>'
                                                    + '<td><input type="text" name="BillAbs_' + i + '_CurAmt_' + j + '" id="BillAbs_' + i + '_CurAmt_' + j + '" class="sch-amt tbl_input txt_right" value="' + sanitizeNumber(curAmt, 2, true) + '"></td>'
                                                    + '<td><input type="text" name="BillAbs_' + i + '_TaxAmt_' + j + '" class="sch-tax tbl_input txt_right" ></td>'
                                                    + '<td><input type="text" name="BillAbs_' + i + '_NetAmt_' + j + '" class="sch-net-amt tbl_input txt_right" value="' + sanitizeNumber(curAmt, 2, true) + '"></td>'
                                                    + '<input type="hidden" name="BillAbs_' + i + '_TypeId_' + j + '" value = "' + receipt.ReceiptTypeId + '"/>'
                                                    + '<input type="hidden" name="BillAbs_' + i + '_Type_' + j + '" value = "' + receipt.TypeId + '"/>'
                                                    + '<td width="3%" align="center" class="action_btns_td">';

                                                    if (receipt.hasOwnProperty('HtmlTag') && receipt.HtmlTag.length > 0 && curAmt != '') {

                                                        rowHtml += '<ul class="action_btns">'
                                                        + '<li><a href="#" class="rqualmainTr"><i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="top" data-original-title="Expand"></i></a></li>'
                                                        + '</ul>';
                                                    }

                                                    rowHtml += '<input type="hidden" class="qualRefId"  name="BillAbs_' + i + '_QualRefId_' + j + '" id="BillAbs_' + i + '_QualRefId_' + j + '" />'
                                                    + '</td>'
                                                    + '</tr>';

                                                    if (receipt.hasOwnProperty('HtmlTag') && receipt.HtmlTag.length > 0) {
                                                        rowHtml += '<tr class="subTr qualmainTr">'
                                                        + '<td colspan="5">'
                                                        + '<div class="subDiv">'
                                                        + receipt.HtmlTag
                                                        + '</div></td>'
                                                        + '</tr>';
                                                    }
                                                }
                                            });
                                            rowHtml += '<tr>'
                                            + '<td class="text-right rate_pri">Total</td>'
                                            + '<td><input type="text" class="rec-tot-amt tbl_input txt_right"></td>'
                                            + '<td><input type="text" class="rec-tot-tax tbl_input txt_right"></td>'
                                            + '<td><input type="text" class="rec-tot-net tbl_input txt_right"></td>'
                                            + '<td></td></tr>'
                                            + '</tbody>'
                                            + '</table>'
                                            + '<input type="hidden" name="refRowId_' + i + '" id="refRowId_' + i + '" value = "' + j + '"/>'
                                            + '</div>'
                                            + '</div>'
                                            + '</div>'
                                            + '</td>'
                                            + '</tr>';
                                        }
                                    });
                                    sumPercent = parseInt(sumPercent)+'%';
                                    rowHtml += '<tr class="mainTr">'
                                    + '<td></td>'
                                    + '<td></td>'
                                    + '<input type="hidden" name="shRowId" id="shRowId" value = "' + i + '"/>'
                                    + '<td class="text-right rate_pri">Total</td>'
                                    + '<td><input type="text" class="rec-tot-tax tbl_input txt_right totalright" value="' + sumPercent + '" /></td>'
                                    + '<td><input type="text" class="rec-tot-tax tbl_input txt_right totalright" value="' + sanitizeNumber(sumshAmt,2,true) + '" /></td>'
                                    + '<td><input type="text" class="rec-tot-tax tbl_input txt_right totalright" id="nettax" value="0" /></td>'
                                    + '<td><input type="text" class="rec-tot-tax tbl_input txt_right totalright" id="netTotal" value="0" /></td>' +
                                    '</tr>';

                                    $tarPSTable.find('tbody').html(rowHtml);
                                    fillRowRefEditMode();
                                    calcTaxForPaymentSchedule($tarPSTable);
                                    $paymentScheduleWrapper.find('input').attr('readonly', true);
                                    $('.schnet').each(function (i, o) {
                                        var net = $(this).val();
                                        var round = $('#round_' + i).text();
                                        if (!isNaN(round)) {
                                            net = Math.round(net / round) * round

                                        }

                                    });
                                }

                                if (callback) {
                                    callback();
                                }
                            },
                            error: function (xhr, status, error) {
                            }
                        });
                    }
                }



                function paymentScheduleCustom() {
                    var $terms = $('#sch-no-terms'),
                        $from_month = $('#sch-from-month'),
                        $day = $('#sch-day'),
                        $period = $('#sch-period');

                    var terms = parseInt($terms.val()),
                        from_month = $from_month.val(),
                        day = parseInt($day.val()),
                        period = $period.val();


                    if(period.length == 0) {
                        showError($period,'Required');
                        return false;
                    } else
                        removeError($period);

                    if(from_month.length == 0) {
                        showError($from_month,'Required');
                        return false;
                    } else
                        removeError($from_month);

                    if(isNaN(terms) ||terms.length == 0) {
                        showError($terms,'Required');
                        return false;
                    } else
                        removeError($terms);

                    if(isNaN(day) || day.length == 0) {
                        showError($day,'Required');
                        return false;
                    } else if(day > 31) {
                        showError($day,'Day should be less than or equal 31!');
                        return false;
                    } else
                        removeError($day);

                    $('.loading_area').show();

                    var $payment_schedule_wrapper = $('#payment-schedule-wrapper');
                    var $payment_schedule_form_wrapper = $('#payment-schedule-form-wrapper');

                    var month = $from_month.datepicker('getDate').getMonth() + 1;
                    var year = $from_month.datepicker('getDate').getFullYear();
                    var template = $('#schedule-custom-template-tr').html();
                    var receipttemplate = $('#schedule-custom-receipt-type-tr').html();
                    $payment_schedule_wrapper.html($('#schedule-custom-template').html().replace(/\{\{scheduleid\}\}/g, $('#payment_schedule').val()));
                    var sumMonths = 0;
                    switch(period) {
                        case 'M'://monthly
                            sumMonths=1;
                            break;
                        case 'B'://bimonthly
                            sumMonths=2;
                            break;
                        case 'Q'://quaterly
                            sumMonths=3;
                            break;
                        case 'H'://half yearly
                            sumMonths=6;
                            break;
                        case 'Y'://yearly
                            sumMonths=12;
                            break;
                    }

                    var totalLandAmount = parseFloatVal($('#unitdetail_LandAmount').text());
                    var totalConstructionAmount = parseFloatVal($('#unitdetail_ConstructionAmount').text());
                    var totalOtherAmount = parseFloatVal($('#unitdet_OtherAmount').text());

                    sumothrcst=0;

                    $.each(othercostadd, function (j, o) {
                        sumothrcst += parseFloatVal(o.Amount);
                    });


                    if(totalOtherAmount > sumothrcst ){
                        var resttotamt=totalOtherAmount-sumothrcst;}
                    else{
                        var resttotamt=sumothrcst-totalOtherAmount;
                    }

                    var totalAmount = totalLandAmount + totalConstructionAmount + resttotamt;

                    var amount = sanitizeNumber(totalAmount / terms,2);
                    var landAmount = totalLandAmount;
                    var constructionAmount = totalConstructionAmount;
                    var otherAmount = totalOtherAmount;

                    var totCalcAmount = 0;
                    var totReceiptAmount = 0;
                    var qualCount = 0;
                    // set dates and amount
                    for(var i=0;i<terms;i++) {
                        if(i != 0)
                            month+=sumMonths;

                        if(month > 12) {
                            month = month - 12;
                            year+=1;
                        }

                        totCalcAmount += parseFloatVal(amount);
                        if(i == (terms-1)) {
                            var diff = totCalcAmount - totalAmount;
                            amount = amount - diff;
                        }

                        var startDate = new Date(month+'/'+ day+'/'+year);
                        var endDate = $.datepicker.formatDate('dd-mm-yy', startDate);
                        $('#payment-schedule-wrapper > .custom-schedule > tbody.main').append(template.replace(/__/g,'_'+i)
                            .replace(/\{\{date\}\}/g,endDate)
                            .replace(/\{\{terms\}\}/g, 'Term-' + (i+1))
                            .replace(/\{\{amount\}\}/g,sanitizeNumber(amount,2,true)));

                        if(custom_payment_schedule_details != null) {
                            var receiptAmount = 0;
                            var scheduleAmt = amount;
                            var typed=0;
                            var typeamount=0;

                            $.each(custom_payment_schedule_details, function (j, o) {
                                var receiptAmt= 0;
                                if (o.Type == 'O') {
                                    otherAmount = 0;
                                    $.each(arrOtherCost , function(x, val) {
                                        if (arrOtherCost[x]['OtherCostId'] == o.TypeId) {
                                           // console.log();
                                           // console.log(o.TypeId,typed);

                                            otherAmount = parseFloatVal(isNullCheck(arrOtherCost[x]['Amount'],'number'));


                                        }
                                    });
                                }

                                switch (o.Type) {
                                    case 'L' :
                                        if (landAmount <= 0) {
                                            receiptAmt = 0;
                                        } else if (scheduleAmt <= landAmount) {
                                            receiptAmt = scheduleAmt;
                                            landAmount -= scheduleAmt;
                                            scheduleAmt = 0;
                                        } else if (scheduleAmt > landAmount) {
                                            receiptAmt = landAmount;
                                            scheduleAmt -= landAmount;
                                            landAmount = 0;
                                        }
                                        break;
                                    case 'C':
                                        if (constructionAmount <= 0) {
                                            receiptAmt = 0;
                                        } else if (scheduleAmt <= constructionAmount) {
                                            receiptAmt = scheduleAmt;
                                            constructionAmount -= scheduleAmt;
                                            scheduleAmt = 0;
                                        } else if (scheduleAmt > constructionAmount) {
                                            receiptAmt = constructionAmount;
                                            scheduleAmt -= constructionAmount;
                                            constructionAmount = 0;
                                        }
                                        break;
                                    default:
                                        if (otherAmount <= 0) {
                                            receiptAmt = 0;
                                        } else if (scheduleAmt <= otherAmount) {
                                            receiptAmt = scheduleAmt;
                                            otherAmount -= scheduleAmt;
                                            scheduleAmt = 0;
                                        } else if (scheduleAmt > otherAmount) {
                                            receiptAmt = otherAmount;
                                            scheduleAmt -= otherAmount;
                                            otherAmount = 0;
                                        }
                                        break;
                                        typeamount = otherAmount;
                                }
                                if(receiptAmt == 0)
                                    return;

                                receiptAmt = sanitizeNumber(receiptAmt,2);

                                if(i == (terms-1) && j == (custom_payment_schedule_details.length - 1) && receiptAmt != 0) {
                                    var diff = scheduleAmt - parseFloatVal(receiptAmt);
                                    receiptAmt = sanitizeNumber((receiptAmt + diff),2);
                                }

                                var sHtml = isNullCheck(o.HtmlTag,'string');

                                qualCount = qualCount + 1;
                                if (sHtml.length >0) {
                                    sHtml = sHtml.replace(/__1/g, '_' + qualCount);
                                }

                                $('#sch_cust_receipttable_' + i + ' > tbody.main').append(receipttemplate.replace(/__0/g,'_'+i)
                                        .replace(/__/g,'_'+j)
                                        .replace(/\{\{TypeName\}\}/g, o.TypeName)
                                        .replace(/\{\{Amount\}\}/g, sanitizeNumber(receiptAmt,2,true))
                                        .replace(/\{\{TypeId\}\}/g, o.TypeId )
                                        .replace(/\{\{Type\}\}/g, o.Type )
                                        .replace(/\{\{AbsQualRef\}\}/g, qualCount )
                                );
                                $('#sch_cust_'+i+'_qualwrapper_' + j).html(sHtml);
                                receiptAmount += parseFloatVal(receiptAmt);
                                totReceiptAmount += parseFloatVal(receiptAmt);
                                typed=o.TypeId;
                                //typed=o.Type;
                            });
                            $('#sh_cust_receiptAmtTotal_'+i).val(sanitizeNumber(receiptAmount,2,true));
                        }
                    }
                    $('#sch_cust_terms').val(terms);
                    $('#sch_cust_receipts').val(custom_payment_schedule_details.length);
                    $('#sch_cust_total').val(sanitizeNumber(totalAmount,2,true));

                    bindCustomQualRef();


                    if(othercostadd.length > 0) {
                        var l=terms;


                        $.each(othercostadd, function (j, o) {
                            l +=1;


                            $('#payment-schedule-wrapper > .custom-schedule > tbody.main').append(template.replace(/__/g, '_' + l)
                                .replace(/\{\{date\}\}/g, endDate)
                                .replace(/\{\{terms\}\}/g, o.StageName)
                                .replace(/\{\{amount\}\}/g, sanitizeNumber(o.Amount, 2, true)));

                            var isReceiptFound = true;
                            if ( o.hasOwnProperty('arrReceiptTypes') == false
                                || o.arrReceiptTypes.length <= 0) {
                                isReceiptFound = false;
                            }

                            if (isReceiptFound) {
                                var curReceiptType = '',
                                    otherCostAmt = 0;
                                var scheduleAmt = sumothrcst;



                                $.each(o.arrReceiptTypes, function (j, k) {
                                    var curAmt = 0;

                                    curReceiptType = k.TypeId;
                                    otherCostAmt = o.Amount;


                                    switch (curReceiptType) {

                                        default:
                                            if (otherCostAmt <= 0) {

                                                curReceiptType = '';
                                            } else if (scheduleAmt <= otherCostAmt) {

                                                curAmt = scheduleAmt;
                                                otherCostAmt -= scheduleAmt;
                                                scheduleAmt = 0;
                                            } else if (scheduleAmt > otherCostAmt) {

                                                curAmt = otherCostAmt;
                                                scheduleAmt -= otherCostAmt;
                                                otherCostAmt = 0;
                                                curReceiptType = '';
                                            }
                                            break;
                                    }
                                    curAmt = parseFloatVal(isNullCheck(curAmt, 'number'));

                                    var sHtml = isNullCheck(k.HtmlTag, 'string');
                                    qualCount = qualCount + 1;
                                    if (sHtml.length > 0) {
                                        sHtml = sHtml.replace(/__1/g, '_' + qualCount);
                                    }
                                    j == (othercostadd.length - 1);


//                                      var reAmt = 0;
//                                   $.each(o.arrReceiptTypes, function (j, k) {
//                                    var otheramt = o.Amount;
//
//                                    if (otheramt <= 0) {
//                                        reAmt = 0;
//                                    } else if (schamt <= otheramt) {
//                                        reAmt = schamt;
//                                        otheramt = otheramt - schamt;
//                                        schamt = 0;
//                                    } else if (schamt > otheramt) {
//                                        reAmt = otheramt;
//                                        schamt -= otheramt;
//                                        otheramt = 0;
//                                    }
//
//                                    if (reAmt == 0) {
//                                        return;
//                                    }
//
//                                    reAmt = sanitizeNumber(reAmt, 2);
//
//                                    if (j == (othercostadd.length - 1) && reAmt != 0) {
//                                        var diff = scheduleAmt - parseFloatVal(reAmt);
//                                        reAmt = sanitizeNumber((reAmt + diff), 2);
//                                    }
//
//                                    var sHtml = isNullCheck(k.HtmlTag, 'string');
//
//                                    qualCount = qualCount + 1;
//                                    if (sHtml.length > 0) {
//                                        sHtml = sHtml.replace(/__1/g, '_' + qualCount);
//                                    }
//
//
                                    $('#sch_cust_receipttable_' + l + ' > tbody.main').append(receipttemplate.replace(/__0/g, '_' + l)
                                            .replace(/__/g, '_' + j)
                                            .replace(/\{\{TypeName\}\}/g, k.ReceiptName)
                                            .replace(/\{\{Amount\}\}/g, sanitizeNumber(curAmt, 2, true))
                                            .replace(/\{\{TypeId\}\}/g, k.TypeId)
                                            .replace(/\{\{Type\}\}/g, k.Type)
                                            .replace(/\{\{AbsQualRef\}\}/g, qualCount)
                                    );
                                    $('#sch_cust_' + l + '_qualwrapper_' + j).html(sHtml);
                                    curAmt += parseFloatVal(curAmt);

                                    totReceiptAmount += parseFloatVal(curAmt);
                                    $('#sh_cust_receiptAmtTotal_' + l).val(sanitizeNumber(curAmt, 2, true));
                                });
                            }
                            // console.log(receiptAmt);


                        });
                        $('#sch_cust_terms').val(l);
                        $('#sch_cust_receipts').val(othercostadd.length);
                        $('#sch_cust_total').val(sanitizeNumber(totalAmount, 2, true));

                        bindCustomQualRef();
                    }




//    $('.savebtn_area').show();
                    $payment_schedule_wrapper.show();
                    $payment_schedule_form_wrapper.hide();
                    $('#backToCustSchForm').show();
                    $('.loading_area').hide();
                }


                bindExpandMainTr();
                bindExpandMainTrInput();

                function bindExpandMainTr() {
                    $paymentScheduleWrapper.on('click', '.mainTr', function(e){
                        e.preventDefault();
                        if (!$(this).closest("tr").next(".subTr").is(":visible")) {
                            closeMainTr();
                            $(this).closest("tr").next(".subTr").show();
                            $(this).closest("tr").next(".subTr").find(".subDiv").slideDown("slow");
                            $(this).find("i").addClass("tform");
                        }
                        else {
                            $(this).closest("tr").next(".subTr").find(".subDiv").slideUp("slow");
                            $(this).closest("tr").next(".subTr").slideUp("slow");
                            $(this).find("i").removeClass("tform");
                        }
                    });
                }
                function bindExpandMainTrInput() {
                    $paymentScheduleWrapper.on('focus', '.mainTrInput', function() {
                        if (!$(this).closest("tr").next(".subTr").is(":visible")) {
                            closeMainTr();
                            $(this).closest("tr").next(".subTr").show();
                            $(this).closest("tr").next(".subTr").find(".subDiv").slideDown("slow");
                        }
                    });
                }

                function closeMainTr() {
                    var $mainTr = $(".mainTr");
                    $.each($mainTr, function () {
                        $(this).find('.tform').removeClass('tform');
                        $(this).closest("tr").next(".subTr").find(".subDiv").slideUp("slow");
                        $(this).closest("tr").next(".subTr").slideUp("slow");
                    });
                }

                // Qaulifier TR
                bindRQualExpandTr();
                bindRQualExpandTrInput();
                bindQualExpandTr();
                bindQualExpandTrInput();

                function bindRQualExpandTr() {
                    $paymentScheduleWrapper.on('click', '.rqualmainTr', function (e) {
                        e.preventDefault();
                        if (!$(this).closest("tr").next(".qualmainTr").is(":visible")) {
                            closeRQualTr();
                            $(this).closest("tr").next(".qualmainTr").show();
                            $(this).closest("tr").next(".qualmainTr").find(".subDiv").slideDown("slow");
                            $(this).find("i").addClass("tform");
                        }
                        else {
                            $(this).closest("tr").next(".qualmainTr").find(".subDiv").slideUp("slow");
                            $(this).closest("tr").next(".qualmainTr").slideUp("slow");
                            $(this).find("i").removeClass("tform");
                        }
                    });
                }

                function bindRQualExpandTrInput() {
                    $paymentScheduleWrapper.on('focus', '.rqualmainTrInput', function (e) {
                        if (!$(this).closest("tr").next(".qualmainTr").is(":visible")) {
                            closeRQualTr();
                            $(this).closest("tr").next(".qualmainTr").show();
                            $(this).closest("tr").next(".qualmainTr").find(".subDiv").slideDown("slow");
                        }
                    });
                }

                function closeRQualTr() {
                    var $mainTr = $(".rqualmainTr");
                    $.each($mainTr, function () {
                        $(this).closest("tr").next(".qualmainTr").find(".subDiv").slideUp("slow");
                        $(this).closest("tr").next(".qualmainTr").slideUp("slow");
                    });
                }


                function bindQualExpandTr() {
                    $paymentScheduleWrapper.on('click', '.qualmainExp', function (e) {
                        e.preventDefault();
                        if (!$(this).closest("tr").next(".qualsubTr").is(":visible")) {
                            closeQualTr();
                            $(this).closest("tr").next(".qualsubTr").show();
                            $(this).closest("tr").next(".qualsubTr").find(".subDiv").slideDown("slow");
                            $(this).find("i").addClass("tform");
                        }
                        else {
                            $(this).closest("tr").next(".qualsubTr").find(".subDiv").slideUp("slow");
                            $(this).closest("tr").next(".qualsubTr").slideUp("slow");
                            $(this).find("i").removeClass("tform");
                        }
                    });
                }

                function bindQualExpandTrInput() {
                    $paymentScheduleWrapper.on('focus', '.qualmainTrInput', function (e) {
                        if (!$(this).closest("tr").next(".qualsubTr").is(":visible")) {
                            closeQualTr();
                            $(this).closest("tr").next(".qualsubTr").show();
                            $(this).closest("tr").next(".qualsubTr").find(".subDiv").slideDown("slow");
                        }
                    });
                }

                function closeQualTr() {
                    var $mainTr = $(".qualmainExp");
                    $.each($mainTr, function () {
                        $(this).closest("tr").next(".qualsubTr").find(".subDiv").slideUp("slow");
                        $(this).closest("tr").next(".qualsubTr").slideUp("slow");
                    });
                }

                function calcTaxForPaymentSchedule($tarPaySchTable) {

                    $tarPaySchTable.find('> tbody > tr.mainTr').each(function() {
                        var $tarReceiptTr = $(this),
                            $recSubTr = $tarReceiptTr.next('.subTr');

                        if($recSubTr.length <= 0) {
                            return true;
                        }

                        var $tarReceiptTab = $recSubTr.find('.receipt-type-table');
                        $tarReceiptTab.find('.qualmainTr').each(function() {
                            var sch_amt = parseFloatVal($(this).prev('tr').find('.sch-amt').val());

                            if(isNaN(sch_amt)) {
                                sch_amt = 0;
                            }

                            var $tarQualTab = $(this).find(' > td > .subDiv > table');
                            $tarQualTab.find('> tbody > tr').each(function() {
                                var $tarBaseIp =   $(this).find('>td:eq(4) input.qualmainTrInput');
                                $tarBaseIp.val(sch_amt);
                                $(this).find('>td:eq(3) input.qualChange').trigger('change');

                            });

                        });
                    });
                }

                bindTaxCalculation();
                function bindTaxCalculation() {
                    $paymentScheduleWrapper.on('change', '.qualChange', function() {
                        CalculateTax($(this)[0].id);
                    });
                }

                function CalculateTax(id) {
                    //if (bReady==false) return;
                    var key1 = id.split('_')[1],
                        key2 = id.split('_')[3];

                    var sname = $('#QualRowRef_' + key1).val();
                    var dbaseAmt= parseFloatVal(isNullCheck($('#' + sname).val(),'number'));

                    CalculateQualifier(dbaseAmt,key1);
                    var dTaxAmt = parseFloatVal(isNullCheck($('#QualTotalAmt_' + key1).val(),'number'));


                    var k1 = sname.split('_')[1],
                        k2 = sname.split('_')[3];

                    $('#BillAbs_' + k1 + '_TaxAmt_' + k2).val(dTaxAmt);
                    $('#BillAbs_' + k1 + '_NetAmt_' + k2).val(dTaxAmt+dbaseAmt);

                    CalculateTot();
                }
                function CalculateTot() {
                    var $mainTr = $(".schnet");
                    var netamt =0;
                    $.each($mainTr, function () {
                        netamt += parseFloatVal(isNullCheck($(this)[0].value,'number'));
                    });
                    $('#netTotal').val(sanitizeNumber(netamt,2,true));

                    var $mainTax = $(".schtax");
                    netamt =0;
                    $.each($mainTax, function () {
                        netamt += parseFloatVal(isNullCheck($(this)[0].value,'number'));
                    });
                    $('#nettax').val(sanitizeNumber(netamt,2,true));
                }

                function fillRowRefEditMode() {
                    var $mainTr = $paymentScheduleWrapper.find(".qualmainTr"),
                        iTotalCount= 0,
                        ikey =0;
                    $.each($mainTr, function () {
                        var $x =$(this),
                            $y = $x.prev(),
                            akey1 = 0,
                            akey2 = 0;
                        $y.find(".qualRefId").each(function () {
                            var $z =$(this);
                            akey1 = parseFloatVal($z[0].id.split('_')[1]);
                            akey2 = parseFloatVal($z[0].id.split('_')[3]);
                        });
                        $x.find(".qualTypeId").each(function () {
                            var $n =$(this),
                                key1 = parseFloatVal($n[0].id.split('_')[1]);
                            if (iTotalCount < key1) {
                                iTotalCount = key1;
                            }
                            if (ikey != key1) {
                                ikey = key1;
                                var sname = 'BillAbs_' + akey1 + '_CurAmt_' + akey2;
                                $('#QualRowRef_' + key1).val(sname);
                                $('#BillAbs_' + akey1 + '_QualRefId_' + akey2).val(key1);
                            }
                        });
                    });
                    $('#QualTotalRowId').val(iTotalCount);
                }


                function CalculateQualifier(baseValue, key1) {

                    var rows = $('#QualRowId_' + key1).val();
                    var sformula="";
                    var sname = $('#QualRowRef_' + key1).val();
                    var dbaseAmt= parseFloatVal(isNullCheck($('#' + sname).val(),'number'));
                    var dTotalQualAmt=0;

                    for (i = 1; i <= rows; i++) {
                        var sRef = $('#Qual_' + key1 + '_Ref_' + i).val().trim();
                        var sFormula = $('#Qual_' + key1 + '_Exp_'+ i).val();

                        var dPer = isNullCheck($('#Qual_' + key1 + '_ExpPer_'+ i).val(),'number');
                        var sbaseRef = 'R0';
                        if (parseFloatVal(dPer) ==0) dPer=100;
                        sFormula = sFormula.replace(new RegExp(sbaseRef, 'g'), dbaseAmt);

                        var fvaule = computeEval(sFormula);
                        $('#Qual_' + key1 + '_ExpValue_' + i).val(sanitizeNumber(fvaule,2,true));

                        var iQualTypeid = $('#Qual_' + key1 + '_TypeId_' + i).val();
                        if (iQualTypeid==1)  {
                            var dTaxablePer = parseFloatVal(isNullCheck($('#Qual_' + key1 + '_TaxablePer_' + i).val(), 'number'));
                            var dTaxPer = parseFloatVal(isNullCheck($('#Qual_' + key1 + '_TaxPer_' + i).val(), 'number'));
                            var dCess = parseFloatVal(isNullCheck($('#Qual_' + key1 + '_CessPer_' + i).val(), 'number'));
                            var dEDCess = parseFloatVal(isNullCheck($('#Qual_' + key1 + '_EduCessPer_' + i).val(), 'number'));
                            var dHEDCess = parseFloatVal(isNullCheck($('#Qual_' + key1 + '_HEduCessPer_' + i).val(), 'number'));
                            var dNetPer = dTaxPer + (dTaxPer * (dCess + dEDCess + dHEDCess)) / 100;
                            $('#Qual_' + key1 + '_NetPer_' + i).val(dNetPer);

                            $('#Qual_' + key1 + '_NetPer_' + i).val(sanitizeNumber(dNetPer, 2));
                            $('#Qual_' + key1 + '_ExpPer_' + i).val(sanitizeNumber(dNetPer, 2));

                            var dTaxableAmt = fvaule * (dTaxablePer / 100);
                            var dTaxAmt = dTaxableAmt * (dTaxPer / 100);
                            var dCessAmt = dTaxAmt * (dCess / 100);
                            var dEDAmt = dTaxAmt * (dEDCess / 100);
                            var dHEDAmt = dTaxAmt * (dHEDCess / 100);
                            var dNetAmt = dTaxAmt + dCessAmt + dEDAmt + dHEDAmt;

                            $('#Qual_' + key1 + '_TaxableAmt_' + i).val(sanitizeNumber(dTaxableAmt, 2, true));
                            $('#Qual_' + key1 + '_TaxPerAmt_' + i).val(sanitizeNumber(dTaxAmt, 2, true));
                            $('#Qual_' + key1 + '_CessAmt_' + i).val(sanitizeNumber(dCessAmt, 2, true));
                            $('#Qual_' + key1 + '_EduCessAmt_' + i).val(sanitizeNumber(dEDAmt, 2, true));
                            $('#Qual_' + key1 + '_HEduCessAmt_' + i).val(sanitizeNumber(dHEDAmt, 2, true));
                            $('#Qual_' + key1 + '_NetAmt_' + i).val(sanitizeNumber(dNetAmt, 2, true));

                            dAmt = dNetAmt;
                        } else if (iQualTypeid==2) {
                            var dTaxablePer = parseFloatVal(isNullCheck($('#Qual_' + key1 + '_TaxablePer_' + i).val(), 'number'));
                            var dTaxPer = parseFloatVal(isNullCheck($('#Qual_' + key1 + '_TaxPer_' + i).val(), 'number'));
                            var dKKCess = parseFloatVal(isNullCheck($('#Qual_' + key1 + '_KKCessPer_' + i).val(), 'number'));
                            var dSBCess = parseFloatVal(isNullCheck($('#Qual_' + key1 + '_SBCessPer_' + i).val(), 'number'));
                            var dNetPer = dTaxPer + dKKCess + dSBCess;
                            $('#Qual_' + key1 + '_NetPer_' + i).val(dNetPer);

                            $('#Qual_' + key1 + '_NetPer_' + i).val(sanitizeNumber(dNetPer, 2));
                            $('#Qual_' + key1 + '_ExpPer_' + i).val(sanitizeNumber(dNetPer, 2));

                            var dTaxableAmt = fvaule * (dTaxablePer / 100);
                            var dTaxAmt = dTaxableAmt * (dTaxPer / 100);
                            var dKKCessAmt = dTaxableAmt * (dKKCess / 100);
                            var dSBCessAmt = dTaxableAmt * (dSBCess / 100);

                            var dNetAmt = dTaxAmt + dKKCessAmt + dSBCessAmt;

                            $('#Qual_' + key1 + '_TaxableAmt_' + i).val(sanitizeNumber(dTaxableAmt, 2, true));
                            $('#Qual_' + key1 + '_TaxPerAmt_' + i).val(sanitizeNumber(dTaxAmt, 2, true));
                            $('#Qual_' + key1 + '_KKCessAmt_' + i).val(sanitizeNumber(dKKCessAmt, 2, true));
                            $('#Qual_' + key1 + '_SBCessAmt_' + i).val(sanitizeNumber(dSBCessAmt, 2, true));
                            $('#Qual_' + key1 + '_NetAmt_' + i).val(sanitizeNumber(dNetAmt, 2, true));

                            dAmt = dNetAmt;
                        } else {
                            var dAmt = parseFloatVal(fvaule) * (parseFloatVal(dPer) / 100);
                        }
                        $('#Qual_' + key1 + '_Amount_' + i).val(sanitizeNumber(dAmt,2,true));
                        if ($('#Qual_' + key1 + '_YesNo_' + i).is(':checked') == true) dTotalQualAmt = dTotalQualAmt+ parseFloatVal(dAmt);
                        for (j = i; j <= rows; j++) {
                            var sFormula = $('#Qual_' + key1 + '_Exp_'+ i).val();
                            sFormula = sFormula.replace(new RegExp(sRef, 'g'), dAmt);
                        }
                    }
                    $('#QualTotalAmt_' + key1).val(sanitizeNumber(dTotalQualAmt,2,true)).trigger('change');
                }

                bindQualTot_onChange();
                function bindQualTot_onChange() {
                    $paymentScheduleWrapper.on('change', '[id^="QualTotalAmt_"]', function() {
                        var $tarReceiptTr = $(this).closest('.qualmainTr').prev('tr');

                        $tarReceiptTr.find('.sch-tax').val($(this).val());

                        calcReceiptTotal($tarReceiptTr.closest('tbody'));
                    });
                }
                function calcReceiptTotal($tarTbody) {
                    var totAmt = 0,
                        totTax = 0;
                    $tarTbody.find('tr').each(function() {
                        var $tarSchAmt = $(this).find('.sch-amt');
                        if($tarSchAmt.length > 0) {
                            var amt = parseFloatVal($tarSchAmt.val());
                            if(!isNaN(amt)) {
                                totAmt += amt;
                            }
                            var tax = parseFloatVal($(this).find('.sch-tax').val());
                            if(!isNaN(tax)) {
                                totTax += tax;
                            }

                            netAmt = amt + tax;
                            if(!isNaN(netAmt)) {
                                $(this).find('.sch-net-amt').val(sanitizeNumber(netAmt,2,true));
                            }
                        }
                    });

                    var $totTr = $tarTbody.find('tr:last-of-type');
                    $totTr.find('.rec-tot-amt').val(sanitizeNumber(totAmt,2,true));
                    $totTr.find('.rec-tot-tax').val(sanitizeNumber(totTax,2,true));
                    var netAmt = totAmt + totTax;
                    $totTr.find('.rec-tot-net').val(sanitizeNumber(netAmt,2,true));

                    var $tarReceiptTr = $tarTbody.closest('.subTr').prev('.mainTr');
                    $tarReceiptTr.find('.sch-tax').val(sanitizeNumber(totTax,2,true));

                    $tarReceiptTr.find('.sch-net-amt').val(sanitizeNumber(netAmt,2,true));
                }

                function computeEval(formula) {
                    with (document.forms){
                        with (Math) {
                            A = eval((formula));
                        }
                    } return A;
                }


                function bindCustomQualRef() {
                    $(".qualRefId").each(function () {
                        var $z =$(this);
                        akey1 = parseFloatVal($z[0].id.split('_')[1]);
                        akey2 = parseFloatVal($z[0].id.split('_')[3]);

                        var sname = 'BillAbs_' + akey1 + '_CurAmt_' + akey2;
                        var key1 = $('#'+$z[0].id).val();
                        $('#QualRowRef_' + key1).val(sname);
                    });

                    $(".qualChange").each(function () {
                        CalculateTax($(this)[0].id);
                    });

                    var $q_ids = $('input[id*=QualTotalAmt_]');

                    $.each($q_ids, function (i, obj) {
                        var $tarReceiptTr = $(this).closest('.qualmainTr').prev('tr');

                        $tarReceiptTr.find('.sch-tax').val($(this).val());

                        calcReceiptTotal($tarReceiptTr.closest('tbody'));
                    });
                }
            });


            function signChange(x) {
                var $this = $(x);
                if ($this.hasClass( "fa-plus" )) {
                    $this.removeClass('fa-plus clr-gre');
                    $this.addClass('fa-minus clr-red');
                    var key1 = $this[0].id.split('_')[1],
                        key2 = $this[0].id.split('_')[3];
                    $('#Qual_' + key1 + '_Sign_' + key2).val('-');
                } else {
                    $this.removeClass('fa-minus clr-red');
                    $this.addClass('fa-plus clr-gre');
                    var key1 = $this[0].id.split('_')[1],
                        key2 = $this[0].id.split('_')[3];
                    $('#Qual_' + key1 + '_Sign_' + key2).val('+');
                }
            }

            function isDecimal(evt, element) {
                var charCode = (evt.which) ? evt.which : evt.keyCode;
                if((charCode != 46 || $(element).val().indexOf('.') != -1) &&      // . CHECK DOT, AND ONLY ONE.
                    (charCode < 48 || charCode > 57) && charCode!=39 && charCode!=8 && charCode!=9) {
                    return false;
                }
                return true;
            }
            $(".special").keydown(function (e) {
                var key = e.which || e.keyCode;
                if (!e.shiftKey && !e.altKey && !e.ctrlKey &&
                        // numbers
                    key >= 48 && key <= 57 ||
                        // Numeric keypad
                    key >= 96 && key <= 105 ||
                        // Backspace and Tab and Enter
                    key == 8 || key == 9 || key == 13 ||
                        // Home and End
                    key == 35 || key == 36 ||
                        // left and right arrows
                    key == 37 || key == 39 || (key == 190 &&  this.value.split('.').length === 1) ||
                        // Del and Ins
                    key == 46 || key == 45){
                    return true;}
                else{
                    return false;}

            });
            function addNewRow(x) {
                var strClass = $(x).attr('id');
                var arr = strClass.split('_');
                if($(x).val() != ""){
                    $(x).closest('.empty-'+arr[0]).removeClass('empty-'+arr[0]);
                }

                if($('#content_all').find('.empty-'+arr[0]).length > 0) {
                    return;
                }

                var newCount = parseInt($('#'+arr[0]+'_count').val());
                var oldCount =newCount;
                var template = $('#'+arr[0]+'-row').html();
                newCount++;
                template = template.replace(/__/g, '_' + newCount);
                template = template.replace(/--/g, ' ' + newCount);

                $(template).insertAfter(".coApp_"+oldCount);
                $('#'+arr[0]+'_count').val(newCount);
                $(".empty-coApp .lbl_move").polymerForm();
                $(".empty-coApp .lbl_move").each(function() {
                    if($(this).val() != '' && $(this).val() != null) {
                        $(this).closest('div').addClass('dirty');
                    }
                });
            }



            function getValidDateOfMonth(year,month,day) {
                var date = new Date(year+'-'+month+'-'+day);
                var firstDateOfMonth = new Date(year+'-'+month+'-1');
                var lastDateOfMonth = new Date(firstDateOfMonth.getFullYear(), firstDateOfMonth.getMonth()+1, 0);
                var lastDay = lastDateOfMonth.getDate();
                if(day > lastDay) {
                    date = new Date(year+'-'+month+'-'+lastDay);
                }
                return date;
            }
        </script>
        <script type="text/template" id="schedule-custom-template">
            <table class="table custom-schedule" data-scheduleid="{{scheduleid}}">
                <thead>
                <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Schedule Amount</th>
                    <th>Tax</th>
                    <th>Net Amount</th>
                    <th></th>
                </tr>
                </thead>
                <tbody class="main"></tbody>
                <tbody class="total">
                <tr class="mainTr">
                    <td></td>
                    <td class="text-right rate_pri">Total</td>
                    <td><input type="text" class="rec-tot-tax tbl_input txt_right totalright" id="sch_cust_total" name="sch_cust_total" readonly></td>
                    <td><input type="text" class="rec-tot-tax tbl_input txt_right totalright" id="nettax" value="0" /></td>
                    <td><input type="text" class="rec-tot-tax tbl_input txt_right totalright" id="netTotal" value="0" /></td>
                </tr>
                </tbody>
            </table>
            <input type="hidden" name="sch_cust_terms" id="sch_cust_terms"/>
            <input type="hidden" name="sch_cust_other" id="sch_cust_other"/>
            <input type="hidden" name="sch_cust_receipts" id="sch_cust_receipts"/>
        </script>
        <script type="text/template" id="schedule-custom-template-tr">
            <tr class="mainTr">
                <td><input type="text" class="tbl_input" name="sch_cust_date__" id="sch_cust_date__" value="{{date}}" readonly></td>
                <td><input type="text" class="tbl_input txt_left" name="sh_cust_desc__" id="sh_cust_desc__" value="{{terms}}" maxlength="250"></td>
                <td><input type="text" class="tbl_input txt_right" name="CurAmt__" id="CurAmt___" value="{{amount}}" readonly></td>
                <td><input type="text" class="tbl_input txt_right sch-tax schtax" name="TaxAmt__" id="TaxAmt___" value="" readonly></td>
                <td><input type="text" class="tbl_input txt_right sch-net-amt schnet" name="NetAmt__" id="NetAmt___" value="{{amount}}" readonly></td>
                <td>
                    <ul class="action_btns">
                        <li><a href="#" class="subTr"><i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="top" data-original-title="Expand"></i></a></li>
                    </ul>
                </td>
            </tr>
            <tr class="subTr" style="display: none;">
                <td colspan="11" style="padding:0px !important; ">
                    <div class="subDiv" style="display: none;">
                        <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"></div>
                        <div class="col-lg-12">
                            <div class="table-responsive topsp">
                                <table class="table receipt-type-table" style="margin-bottom:0px;" id="sch_cust_receipttable__">
                                    <thead>
                                    <tr>
                                        <th>Receipt Type</th>
                                        <th>Amount</th>
                                        <th>Tax</th>
                                        <th>Net Amount</th>
                                        <th></th>
                                    </tr>
                                    </thead>
                                    <tbody class="main"></tbody>
                                    <tbody class="total">
                                    <tr>
                                        <td class="text-right rate_pri">Total</td>
                                        <td><input type="text" class="rec-tot-amt tbl_input txt_right" name="sh_cust_receiptAmtTotal__" id="sh_cust_receiptAmtTotal__" readonly></td>
                                        <td><input type="text" class="rec-tot-amt tbl_input txt_right" name="sh_cust_receiptAmtTotal__" id="sh_cust_receiptAmtTotal__" readonly></td>
                                        <td><input type="text" class="rec-tot-amt tbl_input txt_right" name="sh_cust_receiptAmtTotal__" id="sh_cust_receiptAmtTotal__" readonly></td>
                                        <td>&nbsp;</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
        </script>
        <script type="text/template" id="schedule-custom-receipt-type-tr">
            <tr>
                <td>{{TypeName}}</td>
                <td><input type="text" name="BillAbs__0_CurAmt__" id="BillAbs__0_CurAmt__" class="sch-amt tbl_input txt_right" value="{{Amount}}" readonly></td>
                <td><input type="text" name="BillAbs__0_TaxAmt__" id="BillAbs__0_TaxAmt__" class="sch-tax tbl_input txt_right" value="" readonly></td>
                <td><input type="text" name="BillAbs__0_NetAmt__" id="BillAbs__0_NetAmt__" class="sch-net-amt tbl_input txt_right" value="" readonly></td>
                <input type="hidden" name="sch_cust__0_receipttypeid__" id="sch_cust__0_receipttypeid__" value="{{TypeId}}">
                <input type="hidden" name="sch_cust__0_receipttype__" id="sch_cust__0_receipttype__" value="{{Type}}">
                <input type="hidden" class="qualRefId" name="BillAbs__0_QualRefId__" id="BillAbs__0_QualRefId__" value="{{AbsQualRef}}">
                <td>
                    <ul class="action_btns"><li><a href="#" class="rqualmainTr"><i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="top" data-original-title="Expand"></i></a></li></ul>
                </td>
            </tr>
            <tr class="subTr qualmainTr" style="display: none;">
                <td colspan="5">
                    <div class="subDiv" style="display: none;" id="sch_cust__0_qualwrapper__">
                    </div>
                </td>
            </tr>
        </script>