<link rel="stylesheet" type="text/css" href="<?php echo $this->basePath(); ?>/css/project.css" />
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/js/select2.full.min.js"></script>
<link type="text/css" rel="stylesheet" href="<?php echo $this->basePath(); ?>/css/select2.min.css"/>
<link rel="stylesheet" href="<?php echo $this->basePath(); ?>/css/workorder.css"/>
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/js/bootstrap-datetimepicker.min.js"></script>
<link rel="stylesheet" href="<?php echo $this->basePath() . '/css/bootstrap-datetimepicker.min.css';?>"/>
<div class="content_wrapper padlr0">
<div class="container-fluid padlr0">
<div class="col-lg-12">
    <h1>Unit Proposal</h1>
</div>
<div class="col-lg-12 clear">
<div class="col-lg-12 clear">
<div class="kickoff_area col-lg-12 clear">
<div class="col-lg-12 clear padlr0">
<div class="col-lg-12 col-md-12 col-sm-12 cnt_sliders padlr0">
    <?php if(isset($err)): ?>
        <h1 class="text-center" style="margin: 150px auto;">Error: <?php echo $err; ?></h1>
    <?php elseif(isset($leadId)):?>

        <form id="proposal-form" method="post">
        <input type="hidden" name="csrf" value="<?php echo isset($csrf) ? $csrf : ''; ?>">
        <input type="hidden" name="lead_id" value="<?php if (isset($leadId)){ echo $leadId ;} ?>">
		<input type="hidden" name="CallTypeId" value="<?php if(isset($CallTypeId)){ echo $CallTypeId ;}?>">
        <div id="carousel" class="carousel slide" data-ride="carousel">
        <!-- Wrapper for slides -->
        <div class="carousel-inner" role="listbox">
        <!--step 1-->
        <div class="item active">
        <div class="col-lg-6 col-md-6 col-sm-6 col-xs-6">
            <div class="">
                <label for="proposal_no" class="bk_lbl bk_lbl_inpt">Proposal No <span class="colon_r">:</span></label>
                <input type="text" class="bk_lbl_inpt inputbg_ef bk_inpt1" name="proposal_no" id="proposal_no" value="<?php echo $svNo; ?>" <?php if ($genType==true) { ?> readonly <?php } ?> />
            </div>
        </div>
        <div class="col-lg-6 col-md-6 col-sm-6 col-xs-6 col-lg-pull-1 col-md-pull-1 col-sm-pull-1">
            <div class="col-lg-offset-1">
                <label for="proposal_date" class="bk_lbl bk_lbl_inpt"><span class="bkspan_calendar"><i class="fa fa-calendar-o"></i></span> Proposal Date <span class="colon_r">:</span></label>
                <input type="text" class="date_picker bk_lbl_inpt bk_inpt inputbg_ef"   disabled name="proposal_date" id="proposal_date"
                      value="<?php if(isset($dat)){ echo $dat ;}else{ echo date('d-m-Y'); }?>"/>
            </div>
        </div>
        <div class="col-lg-6 m_tb10">
            <div class="col-lg-8 col-lg-offset-2">
                <!--            <form class="form-horizontal">-->
                <div class="row">
                   <div id="project-wrapper" class="form-group col-lg-12 padtop20 animated fadeInUp">
                        <select id="project_id" name="project_id" class="form-control single_dropdown lbl_move"
                                label="Select Project..." style="width:100%;">
                            <option value=""></option>
                            <?php if (isset($arrProjects)): ?>
                                <?php foreach ($arrProjects as $project): ?>
                                    <option
                                        value="<?php echo $project['ProjectId']; ?>"><?php echo $project['ProjectName']; ?></option>
                                <?php endforeach; ?>
                            <?php endif; ?>
                        </select>
                    </div>

                    <div id="unitno-wrapper" class="form-group col-lg-12 padtop20 hide animated fadeInUp">
                        <select id="unit_no" name="unit_no" class="form-control single_dropdown lbl_move"
                                    label="Select Unit No..." style="width:100%;"></select>
                    </div>

                    <div id="buyer-wrapper" class="form-group col-lg-12 hide animated fadeInUp">
                        <div class="radio_check col-lg-11 col-lg-offset-1 col-md-8 col-md-offset-2">
                            <p class="col-lg-6">
                                <input type="radio" name="buyer_investor" id="buyer" value="B" checked>
                                <label for="buyer">Buyer</label>
                            </p>

                            <p class="col-lg-6">
                                <input type="radio" name="buyer_investor" id="investor" value="I">
                                <label for="investor">Investor</label>
                            </p>
                        </div>
                    </div>

                    <div id="unitprice-wrapper" class="form-group col-lg-12 padtop10 hide animated fadeInUp">
                        <input type="text" name="unit_rate" id="unit_rate" class="form-control lbl_move"
                               label="Unit Rate (Per Sq.ft)" readonly/>
                    </div>
                    <div id="discount-type-wrapper" class="form-group col-lg-12 padtop10 animated fadeInUp hide">
                        <select id="discount_type" name="discount_type" class="form-control single_dropdown lbl_move plan_disabled"
                                label="Select Discount Type" style="width:100%;">
                            <option value=""></option>
                            <option value="R">Rate/Sq.ft</option>
                            <option value="L">Lumpsum</option>
                            <option value="P">Percentage</option>
                        </select>
                    </div>
                    <div id="lumpsum-type-wrapper" class="form-group col-lg-12 padtop10 animated fadeInUp hide">
                        <div class="radio_check col-lg-11 col-lg-offset-1 col-md-8 col-md-offset-2">
                            <p class="col-lg-6">
                                <input type="radio" name="lumpsum_type" id="lumpsum_type_overall" value="O">
                                <label for="lumpsum_type_overall">OverAll</label>
                            </p>

                            <p class="col-lg-6">
                                <input type="radio" name="lumpsum_type" id="lumpsum_type_receiptwise" value="R">
                                <label for="lumpsum_type_receiptwise">Receipt wise</label>
                            </p>
                        </div>
                    </div>
                   <div id="lumpsum-receipt-wise-wrapper" class="form-group col-lg-12 padtop10 animated fadeInUp hide">
                        <select id="lumpsum_receipt_wise" name="lumpsum_receipt_wise"  class="form-control single_dropdown lbl_move plan_disabled"
                                label="Select Receipt Type" style="width:100%;">
                            <option value=""></option>
                            <?php foreach($arrReceiptTypes as $receipt): ?>
                                <option value="<?php echo $receipt['ReceiptTypeId']; ?>" data-type="<?php echo $receipt['Type']; ?>"><?php echo $receipt['ReceiptTypeName']; ?></option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    <div id="discount-wrapper" class="form-group col-lg-12 padtop10 hide animated fadeInUp">
                        <input type="text" name="discount" id="discount" class="form-control lbl_move"
                               label="Discount" onkeypress="return isDecimal(event, this)"/>
                    </div>

                </div>
                <!--            </form>-->
            </div>
        </div>
        <div id="unit-detail-wrapper" class="col-lg-6 m_tb10 hide">
            <div class="form-group">
                <div class="col-lg-12">
                    <div class="stginner_h5">
                        <h5>Unit Detail</h5>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <label class="col-lg-5 padlr0 col-md-5 col-sm-5 txt_left control-label">Unit Type</label>

                            <div class="col-lg-7 col-md-7 col-sm-7 padlr0">
                                <p id="unitdetail_UnitTypeName"></p>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <label class="col-lg-5 padlr0 col-md-5 col-sm-5 txt_left control-label">Block Name</label>

                            <div class="col-lg-7 col-md-7 col-sm-7 padlr0">
                                <p id="unitdetail_BlockName"></p>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <label
                                class="col-lg-5 padlr0 col-md-5 col-sm-5 col-md-4 txt_left control-label">Level</label>

                            <div class="col-lg-7 col-md-7 col-sm-7 padlr0">
                                <p id="unitdetail_FloorName"></p>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <label class="col-lg-5 padlr0 col-md-5 col-sm-5 txt_left control-label">UDS Land Area</label>

                            <div class="col-lg-7 col-md-7 col-sm-7 padlr0">
                                <p id="unitdetail_UDSLandArea"></p>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <label class="col-lg-5 padlr0 col-md-5 col-sm-5 txt_left control-label">Area</label>

                            <div class="col-lg-7 col-md-7 col-sm-7 padlr0">
                                <p><span id="unitdetail_UnitArea"></span> Sq.ft</p>
                                <input type="hidden" name="parea" id="parea">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <label class="col-lg-5 padlr0 col-md-5 col-sm-5 txt_left control-label">Rate</label>

                            <div class="col-lg-7 col-md-7 col-sm-7 padlr0">
                                <p id="unitdetail_Rate"></p>
                                <input type="hidden" name="prate" id="prate">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <label class="col-lg-5 padlr0 col-md-5 col-sm-5 txt_left control-label">Base Amount</label>

                            <div class="col-lg-7 col-md-7 col-sm-7 padlr0">
                                <p id="unitdetail_BaseAmt"></p>
                                <input type="hidden" name="pbase" id="pbase">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <label class="col-lg-5 padlr0 col-md-5 col-sm-5 txt_left control-label">Advance
                                Amount</label>

                            <div class="col-lg-7 col-md-7 col-sm-7 padlr0">
                                <p id="unitdetail_AdvAmount"></p>
                                <input type="hidden" name="padvan" id="padvan">
                            </div>
                        </div>
                    </div>
                    <div class="liner"></div>
                    <div class="row">
                        <div class="col-lg-12">
                            <label class="col-lg-5 padlr0 col-md-5 col-sm-5 txt_left control-label">Land Amount</label>

                            <div class="col-lg-7 col-md-7 col-sm-7 padlr0">
                                <p id="unitdetail_LandAmount"></p>
                                <input type="hidden" name="pland" id="pland">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <label class="col-lg-5 padlr0 col-md-5 col-sm-5 txt_left control-label">Construction Amount</label>

                            <div class="col-lg-7 col-md-7 col-sm-7 padlr0">
                                <p id="unitdetail_ConstructionAmount"></p>
                                <input type="hidden" name="pconst" id="pconst">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-12">
                            <label class="col-lg-5 padlr0 col-md-5 col-sm-5 txt_left control-label">Other Cost Amount</label>
                            <div class="col-lg-7 col-md-7 col-sm-7 padlr0">
                                <p><span id="unitde_OtherCostAmt"></span>
                                    &nbsp;&nbsp;
                                    <span id="arrOtherCost" data-placement="top" data-toggle="tooltip" data-html="true"
                                    data-original-title=""><i class="fa fa-briefcase" aria-hidden="true"></i></span>
                                </p>
                                <input type="hidden" name="pother" id="pother">

                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <label class="col-lg-5 padlr0 col-md-5 col-sm-5 txt_left control-label">Gross Amont</label>

                            <div class="col-lg-7 col-md-7 col-sm-7 padlr0">
                                <p id="unitdetail_GrossAmount"></p>
                                <input type="hidden" name="pgross" id="pgross">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <label class="col-lg-5 padlr0 col-md-5 col-sm-5 txt_left control-label">Qualifier Amont</label>
                            <div class="col-lg-7 col-md-7 col-sm-7 padlr0">
                                <p><span id="unitdet_QualAmt"></span> &nbsp;&nbsp;
                                <span id="arrQualAmt" data-placement="top" data-toggle="tooltip" data-html="true"
                                  data-original-title=""><i class="fa fa-briefcase" aria-hidden="true"></i></span>
                                </p>
                                <input type="hidden" name="pqual" id="pqual">
                            </div>
                        </div>
                    </div>
                    <div class="row hide" id="lndcnst">
                        <div class="col-lg-12">
                            <label class="col-lg-5 padlr0 col-md-5 col-sm-5 txt_left control-label">Land and construction reg amount</label>
                            <div class="col-lg-7 col-md-7 col-sm-7 padlr0">
                                <p id="landconst"></p>
                            </div>
                        </div>
                    </div>
                    <div class="net_amnt">
                        <h2>Net Amount</h2>
                        <h1>Rs. <span id="unitdetail_NetAmt"></span></h1>
                        <input type="hidden" name="pnetamt" id="pnetamt">
                    </div>
                </div>
            </div>
        </div>
         <div class="col-lg-12 savebtn_area padlr0 marg0 clear">
           <ul>
            <li class="save_btn float_l">
                <a href="<?php echo $this->basePath(); ?>/crm/lead/followup<?php echo (isset($leadId))?'/'.$leadId:'-entry'; ?>" class="ripple steps_btn">Back</a>
            </li>
            <li class="save_btn float_r">
                <a href="#" data-slide="next" data-stepno="2" class="ripple carousel-next-btn">Next</a>
            </li>
        </ul>
        </div>
        </div>
		<div class="item">
    <div class="col-lg-6 col-lg-offset-3 col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 padlr0 m_btm20 unit_kickoff">
        <div class="unitkkoff_topimg"></div>
        <div class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 padlr0 m_btm20">
            <div class="form-group m_top20 padtop20 clear">
				<input type="text" name="status_name" id="status_name" class="form-control lbl_move" label="Status" value=""/>
				<input type="hidden" name="status_id" id="status_id"/>
			</div>
			<div class="form-group m_top20 padtop20 clear">
			    <input type="text" name="nature_name" id="nature_name" class="form-control lbl_move special" label="Nature" value=""/>
			    <input type="hidden" name="nature_id" id="nature_id"/>
			</div>
            <div class="form-group m_top20 padtop20 clear">
                <div class="padlr0">
                    <div class="datetimepicker">
                        <span class="add-on datetimepicker_icon" style="top:34px !important;"><i class="fa fa-calendar"></i></span>
                        <input type="text" data-format="dd/MM/yyyy HH:mm:ss PP" name="nextCallDate" id="nextCallDate" readonly="readonly" data-bsfshare="Next Call Date and Time" class="form-control lbl_move date_time_icon" label="Next Followup Date and Time" />
                    </div>
                    <script type="text/javascript">


                        $('.date_time_icon').click(function() {
                            $('.datetimepicker_icon').trigger('click');
                        });
                        var dt=new Date();
                        $(function() {
                            $('.datetimepicker').datetimepicker({
                                language: 'en',
                                pick12HourFormat: true,
                                startDate:dt,
                                todayBtn: true
                            }).on('changeDate', function() {
                                //$('.bootstrap-datetimepicker-widget').hide();
                            });
                        });

                    </script>
                </div>
            </div>
			<div class="form-group m_top20 padtop20 clear">
			<select id="nextfollow_name" name="nextfollow_name" class="form-control single_dropdown lbl_move" style="width:100%" label="Choose Next Followup Type" >
			  <option value=""></option>
				<?php 
				foreach($arrCall as $type){ ?>
				<option value="<?php echo $type['data'] ?>" ><?php echo $type['value'] ?></option>
				<?php } ?>				
			  </select>
			</div>
			<div class="form-group m_top20 padtop20 clear" id="requ">
				<label for="buyer" class="col-lg-6 txt_left col-md-6 control-label">Vehicle Required?</label>
				<div class="radio_check">
				<p class="col-lg-6">
					<input type="radio" name="vehicleAllocation" id="allo_yes" value="1">
					<label for="allo_yes">Yes</label>
				<input type="radio" name="vehicleAllocation" id="allo_no" value="0">
					<label for="allo_no">No</label>
				</p>
		      </div>
		    </div>
			<div class="form-group m_top20 padtop20 clear" id="timep">
			  <input type="text" name="pickUpTime" id="pickUpTime"  class="form-control lbl_move time_picker" readonly label="Pick Up Time" />
			</div>
			<div class="form-group m_top20 padtop20 clear" id="addr">
			  <input type="text" name="pickUpAddress" id="pickUpAddress"  class="form-control lbl_move"label="PickUp Address" />
			</div>
			<div class="form-group m_top20 padtop20 clear">
			  <textarea name="nextfollowremarks" id="nextfollowremarks"  class="form-control lbl_move" label="Next Followup Remarks"></textarea>
			</div>
			<div class="form-group padtop10">
				<textarea name="remarks" id="remarks"  class="form-control lbl_move" label="Remarks"></textarea>
			</div>
		</div>
		<div class="col-lg-12 savebtn_area padlr0 marg0 clear">
            <ul>
                <li class="save_btn float_l">
                <a href="#carousel" data-slide="prev" data-stepno="1" class="ripple steps_btn">Back</a>
               </li>
                <li class="save_btn float_r">
                    <a id="finalise-btn" href="#" class="ripple">submit</a>
                </li>
            </ul>
        </div>
	</div>
</div>
        </div>
        </div>
        </div>
        </div>
        </form>
    <?php endif; ?>
</div>
</div>
</div>
</div>
</div>

<script id="payment-schedule-template" type="text/template">
    <table class="table payment-schedule" data-id="payment_schedule_id__">
        <thead>
        <tr>
            <th>Description</th>
            <th>Date</th>
            <th>Round Off</th>
            <th>Schedule %</th>
            <th>Schedule Amount</th>
            <th>Tax</th>
            <th>Net Amount</th>
            <th></th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</script>
<script type="text/javascript">

$(function () {
    $('.datepickerinput').datepicker({
        format: "dd-mm-yyyy",
        startDate: new Date(),
        todayBtn: true,
        orientation: "top auto",
        autoclose: true
    }).on("changeDate", function(e){
        $("#nextCallDate").text($(this).val());
    });

    var $project_id = $('#project_id'),
        $unit_no = $('#unit_no'),
        $unitnoWrapper = $('#unitno-wrapper'),
        $buyerWrapper = $('#buyer-wrapper'),
        $unitpriceWrapper = $('#unitprice-wrapper'),
        $discountWrapper = $('#discount-wrapper'),
        $unit_rate = $('#unit_rate'),
        $discount = $('#discount'),
        $advance_amt = $('#advance_amt'),
        $unitDetailWrapper = $('#unit-detail-wrapper'),
        $carousel = $('#carousel'),
        $unitdetail_NetAmt = $('#unitdetail_NetAmt'),
        $proposal_date = $('#proposal_date'),
        $proposal_no = $('#proposal_no'),
        $discountTypeWrapper = $('#discount-type-wrapper'),
        $discount_type = $('#discount_type'),
        $lumpsum_receipt_wise = $('#lumpsum_receipt_wise'),
        $lumpsumTypeWrapper = $('#lumpsum-type-wrapper'),
        $lumpsumReceiptWiseWrapper = $('#lumpsum-receipt-wise-wrapper'),
        $lumpsumType = $lumpsumTypeWrapper.find('input[name="lumpsum_type"]'),
        $constructionAmt = $('#unitdetail_ConstructionAmount'),
        $landAmt = $('#unitdetail_LandAmount'),
        $unitdetail_UnitArea = $('#unitdetail_UnitArea'),
        $unitdetail_Rate = $('#unitdetail_Rate'),
        $unitdetail_BaseAmt = $('#unitdetail_BaseAmt'),
        $unitdetail_GrossAmt = $('#unitdetail_GrossAmount'),
        $unitdetail_OtherCostAmt = $('#unitde_OtherCostAmt'),
        $executiveId = $('#executive_id'),
        $projectWrapper = $('#project-wrapper'),
		//followup details//
		$status_name=$('#status_name'),
		$status_id=$('#status_id'),
		$nature_name=$('#nature_name'),
		$nature_id=$('#nature_id'),
		$nextfollow_name=$('#nextfollow_name'),
		$nextfollow_id=$('#nextfollow_id'),
		$nextCallDate=$('#nextCallDate'),
		$vehicleAllocation=$('#vehicleAllocation'),
		$pickUpTime=$('#pickUpTime'),
		$pickUpAddress=$('#pickUpAddress'),
		$nextfollowremarks=$('#nextfollowremarks'),
		$actionRequiredBy=$('#actionRequiredBy'),
		$remarks=$('#remarks'),
		$qual=$('#unitdet_QualAmt'),
        otherCostarr = [],
        ansTax =false,
		$finaliseBtn = $('#finalise-btn');
		//followup Details//

    init();

    bindProposalNo_onChange();

    bindExecutive_onChange();
    bindProject_onChange();
    bindUnit_onChange();
    bindDiscount_onChange();
    bindDiscountType_onChange();
    bindLumpsumType_onChange();
    bindLumpsumReceiptWise_onChange();
	bindnextfollowup_onChange();
	bindStatus_autoComplete();
    bindNature_autoComplete();
	bindyes_onChange();
    bindNextBtn_onClick();
    bindFinalise_onClick();

    function init() {

        $carousel.carousel({
            interval: false
        });

        $('.single_dropdown').select2();
		$nextfollow_name.select2();
    }
    
	function bindyes_onChange() {
        $('input[name="vehicleAllocation"]').on('change', function () {
            if ($('#allo_no').is(':checked')) {
                $('#timep').hide().find('text').val('');
		        $('#addr').hide().find('textarea').val('');
            } else {
                $('#timep').show();
		        $('#addr').show();
            }
        });
    }
	
	
	 function bindnextfollowup_onChange() {
		 $nextfollow_name.on('change', function() {
			 var sname =$("#nextfollow_name option:selected").text();
			 
			if(sname=='Site Visit'){
			$('#requ').show();
		
		} else {
			$('#requ').hide().find('radio').val('');	
			$('#addr').hide().find('textarea').val('');
		    $('#timep').hide().find('text').val('');
		}
		 }).change();
	 }
	
	
	function bindStatus_autoComplete() {
        $status_name.autocomplete({
            lookup: <?php echo (isset($arrStatus))?json_encode($arrStatus):'[]'; ?>,
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            }, onSelect: function (suggestion) {
                if (suggestion) {
                    $status_id.val(suggestion.data);

                    removeError($(this));
                }
            }, onSearchStart: function (suggestion) {
                $status_id.val('');
            }, onSearchComplete: function (query, suggestions) {
                if (!suggestions.length) {
                    $status_id.val('');
                    showError($(this), 'Status not found!');
                } else {
                    removeError($(this));
                }
            }
        });
    }
	function bindNature_autoComplete() {
        $nature_name.autocomplete({
            lookup: <?php echo (isset($arrNature))?json_encode($arrNature):'[]'; ?>,
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            }, onSelect: function (suggestion) {
                if (suggestion) {
                    $nature_id.val(suggestion.data);

                    removeError($(this));
                }
            }, onSearchStart: function (suggestion) {
                $nature_id.val('');
            }, onSearchComplete: function (query, suggestions) {
                if (!suggestions.length) {
                    $nature_id.val('');
                    showError($(this), 'Status not found!');
                } else {
                    removeError($(this));
                }
            }
        });
    }
    function bindExecutive_onChange() {
        $executiveId.on('change', function() {
            var executiveId = $executiveId.val();

            if(executiveId.length > 0) {
                $projectWrapper.removeClass('hide');
            }
        });
    }

    function bindProposalNo_onChange() {
        $proposal_no.on('change', function() {

            checkProposalNo(function(isSuccess, msg) {
                if(isSuccess == false) {
                    alert(msg);
                    $proposal_no.focus();
                }
            });
        });

    }
	 function bindNextBtn_onClick() {
        $('.carousel-next-btn').on('click', function (ev) {
			ev.preventDefault();

            var stepno = parseInt($(this).attr('data-stepno'));
            switch (stepno) {
                case 2:
                    validate_step1(function (isSuccess) {
                        if (isSuccess) {
                            var netAmt = parseFloatVal(isNullCheck($unitdetail_NetAmt.text(),'number')),
                                baseAmt = parseFloatVal(isNullCheck($unitdetail_BaseAmt.text(),'number')),
                                otherCostAmt = parseFloatVal(isNullCheck($unitdetail_OtherCostAmt.text(),'number')),
                                qualAmt = parseFloatVal(isNullCheck($('#unitdet_QualAmt').text(),'number')),
                                landcost = parseFloatVal(isNullCheck($('#landconst').text(),'number'));

                            netAmt =  baseAmt+otherCostAmt+qualAmt+landcost;
                            $unitdetail_NetAmt.text(sanitizeNumber(netAmt,2,true));
                            $("#parea").val(parseFloatVal($unitdetail_UnitArea.text()));
                            $("#prate").val(parseFloatVal($unitdetail_Rate.text()));
                            $("#pbase").val(parseFloatVal($unitdetail_BaseAmt.text()));
                            $("#padvan").val(parseFloatVal($advance_amt.text()));
                            $("#pland").val(parseFloatVal($landAmt.text()));
                            $("#pconst").val(parseFloatVal($constructionAmt.text()));
                            $("#pother").val(parseFloatVal($unitdetail_OtherCostAmt.text()));
                            $("#pgross").val(parseFloatVal($unitdetail_GrossAmt.text()));
                            $("#pqual").val(parseFloatVal($qual.text()));
                            $("#pnetamt").val(parseFloatVal($unitdetail_NetAmt.text()));
                              $carousel.carousel('next');
                        }
                    });
                    break;
            }
        });
    }
	 function bindFinalise_onClick() {

        $finaliseBtn.on('click', function (ev) {
			
            ev.preventDefault();

            validate(function (isSuccess) {
                if (isSuccess) {

                    $('#proposal-form').submit();
                }
            });
        });

        function validate(callback) {
            var nextcalldate=$nextCallDate.val(),
				status=$status_name.val(),
				nature=$nature_name.val(),
				nextfollow=$nextfollow_name.val(),
				vehicle=$vehicleAllocation.val(),
				timepic	=$pickUpTime.val(),
				addrpic	=$pickUpAddress.val(),
				nremarks=$nextfollowremarks.val(),
				remark=$remarks.val();
				
				  removeError($nextCallDate);
				  removeError($status_name);
				  removeError($nature_name);
				  removeError($nextfollow_name);
				  removeError($vehicleAllocation);
				  removeError($pickUpTime);
				  removeError($pickUpAddress);
				  removeError($nextfollowremarks);
				  removeError($remarks);
	  
	    
			 if  (status.length <= 0) {
                showError($status_name, 'status is required!');
                callback(false);
                return false;
            }
			else if  (nature.length <= 0) {
                showError($nature_name, 'nature is required!');
                callback(false);
                return false;
            }
			else if (nextcalldate.length <= 0) {
                showError($nextCallDate, 'nextcalldate is required!');
                callback(false);
                return false;
            }
			else if  (nextfollow.length <= 0) {
                showError($nextfollow_name, 'next followup type is required!');
                callback(false);
                return false;
            }
			else if(nextfollow == 5 && $('#allo_yes').is(':checked')){
				
				 if(timepic.length <= 0) {
					showError($pickUpTime, 'time is required!');
					callback(false);
					return false;
					}
				 else if(addrpic.length <= 0) {
					showError($pickUpAddress, 'address is required!');
					callback(false);
					return false;
				  }
				 else if(nremarks.length <= 0) {
					showError($nextfollowremarks, 'followpremarks is required!');
					callback(false);
					return false;
				 }
				
				else if(remarks.length <= 0) {
					showError($remarks, 'remarks is required!');
					callback(false);
					return false;
				  }
				else{
					callback(true);
					return;
					}
			}
			else if  (nremarks.length <= 0) {
                showError($nextfollowremarks, 'followpremarks is required!');
                callback(false);
                return false;
            }
			
			else if  (remarks.length <= 0) {
                showError($remarks, 'remarks is required!');
                callback(false);
                return false;
            }
		else{
		
        callback(true);
        return;
		}
        }
    }

   

    function checkProposalNo(callback) {
        var proposal_no = $proposal_no.val().trim();
        if(proposal_no.length <= 0) {
            callback(false, 'Proposal No is required!');
            return false;
        } else {
            $.ajax({
                url: getBaseURL() + 'crm/lead/check-proposal-no',
                data: {csrf: "<?php echo isset($csrf)?$csrf:''; ?>", ProposalNo: proposal_no},
                type: 'POST',
                success: function (data, status, xhr) {

                    if (data.unitProposal == false) {
                        $proposal_no.addClass('already-exists');
                        callback(data.unitProposal, 'Proposal No Already exists!');
                        return data.unitProposal;
                    } else {
                        $proposal_no.removeClass('already-exists');
                        callback(true);
                        return true;
                    }
                },
                error: function (xhr, status, error) {
                    alert(xhr.responseText);
                    $proposal_no.addClass('already-exists');
                }
            });
        }
    }


    function validate_step1(callback) {
        var project_id = parseInt($project_id.val()),
            unit_no = parseInt($unit_no.val()),
            booking_no = $proposal_no.val().trim(),
            booking_date = $proposal_date.val().trim(),
            unitRate = parseFloatVal($unit_rate.val()),
            discount = parseFloatVal($discount.val()),
            discount_type = $discount_type.val();

        removeError($project_id);
        removeError($unit_no);
        removeError($discount);
        removeError($discount_type);

        calcDiscount(function() {
            if(booking_no.length <= 0) {
                alert('Booking No is required!');
                $booking_no.focus();
                callback(false);
                return false;
            } else if(booking_date.length <= 0) {
                alert('Booking Date is required!');
                $booking_date.focus();
                callback(false);
                return false;
            } else if($.trim($project_id.val())=="") {

                showError($project_id, 'Please select Project !!');
                $project_id.focus();
                callback(false);
                return false;
            } else if($.trim($unit_no.val())=="") {
                showError($unit_no, 'Please select unit !!');
                $unit_no.focus();
                callback(false);
                return false;
            }
            else if(discount_type != '' && isNaN(discount)) {
                showError($discount, 'Discount is required!');
                $discount.focus();
                callback(false);
                return false;
            }  else if($discount_type.val() == 'P' && discount > 100) {
                showError($discount, 'Percentage Discount should not be > 100');
                $discount.focus();
                callback(false);
                return false;
            }
            else if($discount.hasClass('error')) {
                callback(false);
                return false;
            }
            else {
                callback(true);
                return true;
            }
        });
    }

    function bindDiscount_onChange() {
        $discount.on('change', function () {
            calcDiscount();
        });
    }

    function calcDiscount(callback) {
        removeError($discount);
        removeError($lumpsum_receipt_wise);

        var discount = parseFloatVal($discount.val()),
            area = parseFloatVal($unitdetail_UnitArea.attr('data-original-value')),
            rate = parseFloatVal($unitdetail_Rate.attr('data-original-value')),
            baseAmt = parseFloatVal($unitdetail_BaseAmt.attr('data-original-value')),
            grossAmt = parseFloatVal($unitdetail_GrossAmt.attr('data-original-value')),
            netAmt = parseFloatVal($unitdetail_NetAmt.attr('data-original-value')),
            otherCostAmt = parseFloatVal($unitdetail_OtherCostAmt.text());

        $constructionAmt.text(sanitizeNumber(parseFloatVal($constructionAmt.attr('data-original-value')),2,true));
        $landAmt.text(sanitizeNumber(parseFloatVal($landAmt.attr('data-original-value')),2,true));
        $unitdetail_Rate.text(sanitizeNumber(rate,2,true));
        $unitdetail_BaseAmt.text(sanitizeNumber(baseAmt,2,true));
        $unitdetail_GrossAmt.text(sanitizeNumber(grossAmt,2,true));
        //$unitdetail_NetAmt.text(sanitizeNumber(netAmt,2,true));

        //   $paymentScheduleWrapper.html('');
        if ($discount_type.val() == 'L') {
            // lumpsum

            var lumpsumType = $lumpsumType.filter(':checked').val();
            if(typeof lumpsumType=='undefined') {
                alert('please select OverAll / ReceiptWise discount ...');
                return false;
            }
            if (lumpsumType == 'O') {
                // overall
                if(discount > baseAmt) {
                    showError($discount, 'Discount should be lesser than Base Amount!');
                    return false;
                }

                baseAmt = baseAmt - discount;
                grossAmt = baseAmt;
                netAmt = grossAmt;
                var landAmt = parseFloatVal($landAmt.attr('data-original-value'));
                var constAmt = baseAmt-landAmt;
                $constructionAmt.text(sanitizeNumber(constAmt,2,true));
            } else {
                // receipt wise
                var receiptType = $.trim($lumpsum_receipt_wise.val());
                    if(receiptType=='') {
                        showError($('#lumpsum_receipt_wise'), 'Select Receipt Type!');
                        return false;
                    }

                var $selReceiptType = $lumpsum_receipt_wise.find('option:selected'),
                    selReceipt = $selReceiptType.attr('data-type');

                if(selReceipt == 'C') {
                    var constAmt = parseFloatVal($constructionAmt.attr('data-original-value'));
                    if(discount > constAmt) {
                        showError($discount, 'Discount should be lesser than Construction Amount!');
                        return false;
                    }
                    constAmt -= discount;
                    $constructionAmt.text(sanitizeNumber(constAmt,2,true));
                } else if(selReceipt == 'L') {
                    var landAmt = parseFloatVal($landAmt.attr('data-original-value'));
                    if(discount > landAmt) {
                        showError($discount, 'Discount should be lesser than Land Amount!');
                        return false;
                    }
                    landAmt -= discount;
                    $landAmt.text(sanitizeNumber(landAmt,2,true));
                }

                baseAmt -= discount;
            }
        } else if ($discount_type.val() == 'R') {
            // unit rate
            if (discount > rate) {
                showError($discount, 'Discount should be lesser than Unit rate!');
                return false;
            } else {
                rate = rate - discount;
                baseAmt = rate * area;
                var landAmt = parseFloatVal($landAmt.attr('data-original-value'));
                var constAmt = baseAmt-landAmt;
                $constructionAmt.text(sanitizeNumber(constAmt,2,true));
            }
        } else if($discount_type.val() =='P') {
            var lumpsumType = $lumpsumType.filter(':checked').val();
            if(typeof lumpsumType=='undefined') {
                alert('please select OverAll / ReceiptWise discount ...');
                return false;
            }
            if (lumpsumType == 'O') {
                // overall
                discount=baseAmt * (discount/100);

                baseAmt = baseAmt - discount;
                grossAmt = baseAmt;
                netAmt = grossAmt;
                var landAmt = parseFloatVal($landAmt.attr('data-original-value'));
                var constAmt = baseAmt-landAmt;
                $constructionAmt.text(sanitizeNumber(constAmt,2,true));
            } else {
                // receipt wise
                var receiptType = $.trim($lumpsum_receipt_wise.val());
                if(receiptType=='') {
                    showError($('#lumpsum_receipt_wise'), 'Select Receipt Type!');
                    return false;
                }

                var $selReceiptType = $lumpsum_receipt_wise.find('option:selected'),
                    selReceipt = $selReceiptType.attr('data-type');

                if(selReceipt == 'C') {
                    var constAmt = parseFloatVal($constructionAmt.attr('data-original-value'));
                    discount=constAmt * (discount/100);

                    constAmt -= discount;
                    $constructionAmt.text(sanitizeNumber(constAmt,2,true));
                } else if(selReceipt == 'L') {
                    var landAmt = parseFloatVal($landAmt.attr('data-original-value'));
                    discount=landAmt * (discount/100);

                    landAmt -= discount;
                    $landAmt.text(sanitizeNumber(landAmt,2,true));
                }

                baseAmt -= discount;
            }
        }
        grossAmt = baseAmt;
        netAmt = grossAmt;
        if (!isNaN(otherCostAmt)) {
            grossAmt = baseAmt + otherCostAmt;
            netAmt = grossAmt;
        }

        $unitdetail_Rate.text(sanitizeNumber(rate,2,true));
        $unitdetail_BaseAmt.text(sanitizeNumber(baseAmt,2,true));
        $unitdetail_GrossAmt.text(sanitizeNumber(grossAmt,2,true));
        //$unitdetail_NetAmt.text(sanitizeNumber(netAmt,2,true));

        if (ansTax==false && typeof callback != 'undefined') {
            getTax(function(bool) {
                callback(bool);
            });
        } else if (ansTax==false && typeof callback == 'undefined') {
            getTax();
        }
        if($("#landconst").text()!='' || $("#landconst").text()!=0.00) {
            var netamt= parseFloatVal($unitdetail_NetAmt.text()) + parseFloatVal($("#landconst").text());
            $unitdetail_NetAmt.text(sanitizeNumber(netamt,2,true));
        }
    }

    function bindUnit_onChange() {
        $unit_no.on('change', function () {

            removeError($unit_no);

            load_unitDetails(function (isSuccess) {

                if(isSuccess) {
                    $unitDetailWrapper.removeClass('hide');
                    $unit_no.removeAttr('disabled');

                    $buyerWrapper.removeClass('hide');
                    $unitpriceWrapper.removeClass('hide');
                    $discountTypeWrapper.removeClass('hide');
                } else {
                    $unitDetailWrapper.addClass('hide');
                    $unit_no.removeAttr('disabled');
                }
            });
        });
    }

    function bindDiscountType_onChange() {
        $discount_type.on('change', function() {

            var discountType = $discount_type.val().trim();

            $discountWrapper.addClass('hide');
            $lumpsumTypeWrapper.addClass('hide');
            $lumpsumReceiptWiseWrapper.addClass('hide');

            //$discount.trigger('change');
            $lumpsumType.removeAttr('checked');
            if(discountType.length > 0 ) {
                if(discountType == 'L' || discountType=='P') {
                    $lumpsumTypeWrapper.removeClass('hide');
                } else {
                    $discountWrapper.removeClass('hide');
                }
            }
        });
    }

    function bindLumpsumType_onChange() {
        $lumpsumType.on('change', function() {

            var lumpsumType = $(this).val();
            if(lumpsumType == 'O') {
                $discountWrapper.removeClass('hide');
                $lumpsumReceiptWiseWrapper.addClass('hide');
            } else {
                $discountWrapper.addClass('hide');
                $lumpsumReceiptWiseWrapper.removeClass('hide');
            }
            $lumpsum_receipt_wise.val('option').removeAttr('selected');
            $discount.val('');
        });
    }


    function bindLumpsumReceiptWise_onChange() {
        $lumpsum_receipt_wise.on('change', function() {
            var receiptWise = $(this).val();
            if(receiptWise.length > 0) {
                $discountWrapper.removeClass('hide');
            } else {
                $discountWrapper.addClass('hide');
            }
            $discount.val('').trigger('change');
        });
    }

    function load_unitDetails(callback) {

        var unit_id = $unit_no.val();
        if (/^\d+$/.test(unit_id) === false || unit_id == 0) {
            callback(false);
            return false;
        }

        $unit_no.attr('disabled', true);
        otherCostarr =[];
        $.ajax({
            url: getBaseURL() + 'crm/lead/unitdetail',
            data: {csrf: "<?php echo isset($csrf)?$csrf:''; ?>", UnitId: unit_id},
            async: false,
            type: 'POST',
            success: function (data, status, xhr) {

                var othercost= 0,
                    sothercost='';

                $.each(data.unitamt, function (index, other) {
                    if (other.Amount==null) {
                        othercost=0;
                    }
                    else {
                        othercost += parseFloatVal(other.Amount);
                        sothercost = sothercost +  other.OtherCostName + ': ' + sanitizeNumber(other.Amount, 2, true) + '<br/>';

                        otherCostarr.push({
                            OtherCostId: other.OtherCostId,
                            OtherCostName:other.OtherCostName,
                            Amount: other.Amount,
                            'Area': other.Area,
                            'Rate': other.Rate
                        });

                    }
                });
                if(data.land!='' || data.land!=0.00) {
                    $("#landconst").text(sanitizeNumber(data.land,2,true));
                    $("#lndcnst").removeClass('hide');

                }

                $unitdetail_OtherCostAmt.text(sanitizeNumber(othercost, 2, true));
                $('#arrOtherCost').attr('data-original-title',sothercost);

                $.each(data.unit_detail, function (index, detail) {
                    var $tarDetail = $unitDetailWrapper.find('#unitdetail_' + index);

                    if (detail == 0 || detail == null || detail.trim() == '') {
                        $tarDetail.closest('.row').addClass('hide');
                    } else {
                        $tarDetail.closest('.row').removeClass('hide');
                        $tarDetail.text(detail).attr('data-original-value', detail);
                    }
					if(index!="NetAmt") {
                            $tarDetail.text(detail).attr('data-original-value', detail);
                        } else {
                            $tarDetail.text(sanitizeNumber(detail,2,true)).attr('data-original-value', detail);
                        }
					if(index=="AdvAmount" || index=="UDSLandArea" || index=="BaseAmt" || index=="GrossAmount" || index=="LandAmount" || index=="Rate" || index=="ConstructionAmount" || index=="GuideLinevalue" || index=="MarketLandValue" || index=="OtherCostAmt" || index=="QualifierAmount") {
                            $tarDetail.text(sanitizeNumber(detail,2,true)).attr('data-original-value', detail);
                        }
                });

                var unitRate = parseFloat(data.unit_detail.Rate).toFixed(2);
                if(isNaN(unitRate)) {
                    unitRate = '';
                }

                $unit_rate.val(unitRate).trigger('change');

                if (callback) {
                    callback(true);
                }
            },
            error: function (xhr, status, error) {
                alert(xhr.responseText);

                $unit_no.removeAttr('disabled');

                if (callback) {
                    callback(false);
                }
            }
        });

        getTax();
        if($("#landconst").text()!='' || $("#landconst").text()!=0.00) {

            var netamt= parseFloatVal($unitdetail_NetAmt.text()) + parseFloatVal($("#landconst").text());
            $unitdetail_NetAmt.text(sanitizeNumber(netamt,2,true));
        }
    }

    function getTax(callback) {

        var arrCost = [],dGrossAmt=0;
        var landAmt = parseFloatVal(isNullCheck($landAmt.text(),'number')),
            constructionAmt = parseFloatVal(isNullCheck($constructionAmt.text(),'number'));

        dGrossAmt = landAmt+ constructionAmt;

        arrCost.push({
            ReceiptType:'S',
            TypeId: 1,
            Amount: landAmt
        });
        arrCost.push({
            ReceiptType:'S',
            TypeId: 2,
            Amount: constructionAmt
        });

        $.each(otherCostarr, function (i, val) {
                arrCost.push({
                    ReceiptType:'O',
                    TypeId: otherCostarr[i]['OtherCostId'],
                    Amount: otherCostarr[i]['Amount']
                });
                dGrossAmt = dGrossAmt + parseFloat(isNullCheck(otherCostarr[i]['Amount'],'number'));
        });

        $unitdetail_GrossAmt.text(sanitizeNumber(dGrossAmt,2,true));

        var dDate = new Date();
        var arrCost = JSON.stringify(arrCost);

        $.ajax({
            url: getBaseURL() + 'crm/lead/getTax',
            data: {csrf: "<?php echo isset($csrf)?$csrf:''; ?>",arrReceipt:arrCost, GrossAmt:dGrossAmt,shDate:dDate},
            async: false,
            type: 'POST',
            success: function (data, status, xhr) {

                var dTax= 0,sTax='';
                $.each(data.arrTax, function (index, tax) {
                    var dTaxAmt = parseFloatVal(isNullCheck(tax.Amount,'number'));
                    if (dTaxAmt !=0) {
                        dTax = dTax+dTaxAmt;
                        sTax = sTax +  tax.QualifierName + ': ' + sanitizeNumber(dTaxAmt, 2, true) + '<br/>';
                    }
                });

                $('#unitdet_QualAmt').text(sanitizeNumber(dTax, 2, true));
                $('#arrQualAmt').attr('data-original-title',sTax);

                $('#unitdetail_NetAmt').text(sanitizeNumber(dGrossAmt+dTax, 2, true));
                if(typeof callback != 'undefined')
                    callback(true);
            },
            error: function (xhr, status, error) {
                if(typeof callback != 'undefined')
                callback(false);
            }
        });
    }


    function bindProject_onChange() {
        $project_id.on('change', function () {

            removeError($project_id);

            resetUnitData();

            load_units(function () {
                $unitnoWrapper.removeClass('hide');
            });
        });
    }

    function resetUnitData() {
        $buyerWrapper.addClass('hide');
        $unitpriceWrapper.addClass('hide');
        $discountWrapper.addClass('hide');
        $discountTypeWrapper.addClass('hide');
        $unitDetailWrapper.addClass('hide');
        $('#lumpsum-receipt-wise-wrapper').addClass('hide');
        $('#lumpsum-type-wrapper').addClass('hide');
        $unit_rate.val('');
        $discount.val('');

        $unit_no.html('');
        $unit_no.select2('val', '');

    }

    function load_units(callback) {

        var project_id = $project_id.val();
        if (/^\d+$/.test(project_id) === false) {
            return;
        }

        $unit_no.attr('disabled', true);

        $.ajax({
            url: getBaseURL() + 'crm/lead/units',
            data: {csrf: "<?php echo isset($csrf)?$csrf:''; ?>", ProjectId: project_id, Lead_Id: <?php echo $leadId; ?>},
            type: 'POST',
            success: function (data, status, xhr) {
                if (data.units.length > 0) {
                    var opHtml = '<option value=""></option>';
                    $.each(data.units, function (index, unit) {
                        opHtml += '<option value="' + unit.UnitId + '">' + unit.UnitNo + '</option>';
                    });
                    $unit_no.html(opHtml);
                } else {
                    $unit_no.html('');
                }

                $unit_no.removeAttr('disabled');

                if (callback) {
                    callback();
                }
            },
            error: function (xhr, status, error) {
                alert(xhr.responseText);
            }
        });
    }

});
</script>