<?php $bsf = new \BuildsuperfastClass(); ?>
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/js/select2.full.min.js"></script>
<link type="text/css" rel="stylesheet" href="<?php echo $this->basePath(); ?>/css/select2.min.css" />

<form method="post" id="other-cost-edit-form">
    <div class="content_wrapper padlr0">
        <div class="container-fluid padlr0">
            <div class="col-lg-12">
                <h1 class="float_l">Project Info of
                    <div class="btn-group proname_btn">
                        <a href="javascript:void(0);" class="dropdown-toggle" data-toggle="dropdown"><?php echo ucfirst($projectDetail['ProjectName']);?> <span class="edit_symbols" data-placement="right" data-toggle="tooltip" data-original-title="Choose&nbsp;your&nbsp;project"><i class="fa fa-caret-down "></i></span></a>
                        <div class="dropdown-menu toolbar_ddown proname_ddown arrow" role="menu">
                            <ul>
                                <?php foreach($projects as $project){?>
                                    <li><a href="<?php echo $this->basePath(); ?>/crm/project/<?php echo $this->currentRequest()->get('action'); ?>/<?php echo $bsf->encode($project['ProjectId']); ?>"><?php echo ucfirst($project['ProjectName']);?></a></li>
                                <?php }	?>
                            </ul>
                        </div>
                    </div>
                </h1>
                <div class="promote_social float_r">
                    <ul>
                        <span>Promote Project</span>
                        <li><a href="#" class="fb_c ripple"><i class="fa fa-facebook-square"></i></a></li>
                        <li><a href="#" class="twt_c ripple"><i class="fa fa-twitter-square"></i></a></li>
                        <li><a href="#" class="g_c ripple"><i class="fa fa-google-plus-square"></i></a></li>
                    </ul>
                </div>
            </div>
            <div class="col-lg-12 clear">
                <div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1 col-sm-10 col-sm-offset-1">
                    <div class="col-lg-12">
                        <div class="row">
                            <div class="step_by_liner animated slideInDown"></div>
                            <ul class="step_by stepby_mb60">
                                <li>
                                    <div class="step_by_sep animated_0_4s slideInRight"><p>3</p></div>
                                    <p class="stepli_p1">Land Cost Calculation</p>
                                </li>
                                <li>
                                    <div class="step_by_sep stepsep_active animated slideInRight"><p>4</p></div>
                                    <p class="stepli_p2">Other Cost Details</p>
                                </li>
                                <li class="opacity_08">
                                    <div class="step_by_sep animated_1_5s slideInRight"><p>5</p></div>
                                    <p class="stepli_p3">Payment Schedule</p>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 col-lg-offset-3 col-md-10 col-md-offset-1 col-sm-10 col-sm-offset-1">
                    <div class="row">
                        <div class="form-group col-lg-12 req_flds">
                            <select name="OtherCost[]" id="OtherCost" class="form-control multiple_dropdown lbl_move"  multiple="multiple" label="Select OtherCost" style="width:100%;">
                                <?php foreach($resultsOtherCost as $otherCost): ?>
                                    <option value="<?php echo $otherCost['OtherCostId']; ?>" <?php echo (in_array($otherCost['OtherCostId'],$arrSelOtherCostIds))?'selected':''; ?>
                                            data-used="<?php echo (isset($otherCost['isUsed']))?'true':''; ?>">
                                        <?php echo $otherCost['OtherCostName']; ?>
                                    </option>
                                <?php endforeach; ?>
                            </select>
                            <div class="error_message"><p>Please Select OtherCost...</p></div>
                        </div>
                    </div>

<!--                    <div class="row">-->
<!--                        <div id="other-cost-details-wrapper" class="form-group col-lg-12 --><?php //echo (empty($arrSelOtherCost))?'hide':''; ?><!--">-->
<!--                            <div class="stginner_h5 m_btm20">-->
<!--                                <h5>Other Cost Items</h5>-->
<!--                            </div>-->
<!--                            --><?php //if(isset($arrSelOtherCost)):
//                                foreach($arrSelOtherCost as $otherCost): ?>
<!--                                    <div class="form-group penality_int_area col-lg-12 req_flds" data-id="--><?php //echo $otherCost['OtherCostId']; ?><!--">-->
<!--                                        <div class="col-lg-5 col-md-5 col-sm-5 col-xs-4 padlr0">-->
<!--                                            <p style="padding-top:3px;">--><?php //echo $otherCost['OtherCostName']; ?><!--</p>-->
<!--                                        </div>-->
<!--                                        <div class="col-lg-7 col-md-7 col-sm-7 col-xs-8 padlr0">-->
<!--                                            <input type="text" class="lbl_move other-cost-amt special"  name="selectedOtherCostValue_--><?php //echo $otherCost['OtherCostId']; ?><!--"-->
<!--                                                   value="--><?php //echo $otherCost['Amount']; ?><!--" placeholder="Amount" onblur="return FormatNum(this, 3)">-->
<!--                                            <div class="error_message"><p></p></div>-->
<!--                                        </div>-->
<!--                                    </div>-->
<!---->
<!---->
<!---->
<!--                                --><?php //endforeach;
//                            endif;
//                            ?>
<!--                        </div>-->
<!--                    </div>-->

                    <div class="row clear">

                        <div class="form-group col-lg-12">
                            <p class="radio_label txt_center"><label for="INCLUDE">Land and construction Registration Include or exclude?</label></p>
                            <div class="radio_check col-lg-11 col-lg-offset-1 col-md-8 col-md-offset-2">
                                <p class="col-lg-6">
                                    <input type="radio" name="include" id="include" value="1" checked >
                                    <label for="include">Include</label>
                                </p>
                                <p class="col-lg-6">
                                    <input type="radio" name="include" id="exclude" value="0" <?php if(isset($resultDetail) && $resultDetail['Include'] == '0' ) { echo 'checked'; } ?> >
                                    <label for="exclude">Exclude</label>
                                </p>
                            </div>
                        </div>



                        <div class="row clear">
                            <div class="form-group col-lg-12 col-xs-12 req_flds">
                                <input type="text" class="form-control lbl_move free_field special" name="registrationVal" id="registrationVal" value="<?php echo $resultDetail['LRegistrationValue']; ?>" label="Land Registration Value in %" onblur="return FormatNum(this, 3)" >
                                <div class="error_message"><p>Please fill Land Registration Value...</p></div> </div>
                            <input type="hidden" id="buidType" value="<?php echo $resultsinfo['BusinessTypeId']; ?>" />
                        </div>
<!--                        <div class="row clear">-->
<!--                            <div class="form-group col-lg-12 col-xs-12 req_flds">-->
<!--                                <input type="text" class="form-control lbl_move free_field special" name="lAmtPer" id="lAmtPer" value="--><?php //echo $resultDetail['LAmountValue']; ?><!--" label="Land Amount Value in %" onblur="return FormatNum(this, 3)" >-->
<!--                                <div class="error_message"><p>Please fill Land Amount Value...</p></div> </div>-->
<!--                        </div>-->
                        <div class="row">
                            <div class="form-group col-lg-12 req_flds">
                                <input type="text" class="form-control lbl_move free_field special" name="cRegistrationVal" id="cRegistrationVal" value="<?php echo $resultDetail['CRegistrationValue']; ?>" label="Construction Registration Value in %" onblur="return FormatNum(this, 3)" >
                                <div class="error_message"><p>Please fill Construction Registration Value...</p></div>
                            </div>
                            <div class="row">
                                <div class="form-group col-lg-12 req_flds">
                                    <select name="Other[]" id="Other" class="form-control multiple_dropdown lbl_move"  multiple="multiple" label="Select construction registration OtherCost" style="width:100%;">
                                        <?php
                                        //print_r($leadProjects);
                                        foreach($resultsOtherCost as $type){ ?>
                                            <option <?php if(in_array($type['OtherCostId'], $constructothercost)) {echo 'Selected';} ?> value='<?php echo $type['OtherCostId']; ?>' ><?php echo $type['OtherCostName']; ?></option>
                                        <?php }
                                        ?>
                                    </select>
                                    <div class="error_message"><p>Please Select Other..</p></div>
                                </div>
                        </div>
<!--                        <div class="row clear">-->
<!--                            <div class="form-group col-lg-12 col-xs-12 req_flds">-->
<!--                                <input type="text" class="form-control lbl_move free_field special" name="cAmtPer" id="cAmtPer" value="--><?php //echo $resultDetail['CAmountValue']; ?><!--" label="Construction Amount Value in %" onblur="return FormatNum(this, 3)" >-->
<!--                                <div class="error_message"><p>Please fill Construction Amount Value...</p></div> </div>-->
<!--                        </div>-->
                    </div>
                </div>
            </div>

        </div>
        <div class="col-lg-12 savebtn_area">
            <ul>
                <li class="save_btn m_right10 float_r"><input type="button" name="saveExit" class="ripple continue" value="Save &amp; Exit"/></li>
                <li class="save_btn m_right10 float_r"><input type="button" name="saveNext" class="ripple continue save-next" value="Save &amp; Next"/></li>
                <li class="goto">
                    <label for="go_to" class="float_l">Go to</label>
                    <select id="projectSteps" name="go_to" class="float_l goto_select">
                        <option value="general" <?php if($this->currentRequest()->get('action') == 'general') { echo 'selected'; } ?>>General</option>
                        <option value="land-area" <?php if($this->currentRequest()->get('action') == 'land-area') { echo 'selected'; } ?>>Area Details</option>
                        <option value="land-cost" <?php if($this->currentRequest()->get('action') == 'land-cost') { echo 'selected'; } ?>>Land Cost Calculation</option>
                        <option value="other-cost" <?php if($this->currentRequest()->get('action') == 'other-cost') { echo 'selected'; } ?>>Other Cost Details</option>
                        <option value="payment" <?php if($this->currentRequest()->get('action') == 'payment-schedule' || $this->currentRequest()->get('action') == 'payment-schedule-edit' || $this->currentRequest()->get('action') == 'payment-schedule-register' || $this->currentRequest()->get('action') == 'payment') { echo 'selected'; } ?>>Payment Schedule</option>
                        <option value="unit-type-register" <?php if($this->currentRequest()->get('action') == 'unit-type-register' || $this->currentRequest()->get('action') == 'unit-type') { echo 'selected'; } ?>>Unit Type</option>
                        <option value="facility" <?php if($this->currentRequest()->get('action') == 'facility' || $this->currentRequest()->get('action') == 'car-park' || $this->currentRequest()->get('action') == 'other-facility') { echo 'selected'; } ?>>Facility Management</option>
                        <option value="checklist" <?php if($this->currentRequest()->get('action') == 'checklist') { echo 'selected'; } ?>>Check List Management</option>
                        <option value="penality-interestrate" <?php if($this->currentRequest()->get('action') == 'penality-interestrate') { echo 'selected'; } ?>>Penality & Interest Rate</option>
                        <option value="incentive-register" <?php if($this->currentRequest()->get('action') == 'incentive-register') { echo 'selected'; } ?>>Incentive Management</option>
                        <option value="property-management" <?php if($this->currentRequest()->get('action') == 'property-management') { echo 'selected'; } ?>>Property Management</option>
                    </select>
                    <p class="donecngs_p">Done With Your Changes ?</p>
                </li>
            </ul>
        </div>
</form>
<script>
    $("#projectSteps").change(function(){
        window.location.href= getBaseURL() + "crm/project/"+this.value+"/<?php echo $bsf->encode($projectId); ?>";
    });
</script>

<script type="text/javascript">
    $(function() {

        var $otherCostDetailsWrapper = $('#other-cost-details-wrapper'),
            $OtherCost = $("#OtherCost"),
            $otherCostEditForm = $('#other-cost-edit-form'),
            $regVal = $('#registrationVal'),
//            $lAmtPer = $('#lAmtPer'),
            $cregVal = $('#cRegistrationVal');
//            $cAmtPer = $('#cAmtPer');


        bindOtherCost_onChange();
        bindSaveBtn_onClick();

        function dropMultipleNew() {
            $(".multiple_dropdown").select2({
                tags: true
            });
        }
        dropMultipleNew();
        function bindSaveBtn_onClick() {
            $('.save_btn input[type="button"]').on('click', function() {
                var $this = $(this);

                validate(function(isSuccess) {
                    if(isSuccess) {
                        if($this.hasClass('save-next')) {
                            $otherCostEditForm.append('<input type="hidden" name="saveNext" value="1">');
                        }
                        $otherCostEditForm.submit();
                    }
                });

            });
        }

        function validate(callback) {
            var regVal = parseFloat($regVal.val()),
                cRegVal = parseFloat($cregVal.val()),
//                lAmtPer = parseFloat($lAmtPer.val()),
//                cAmtPer = parseFloat($cAmtPer.val()),
                isSuccess = true;

            if($OtherCost.val() == '' || $OtherCost.val() == null) {
                showErrorMsg($OtherCost, 'Please Select OtherCost...');
                isSuccess = false;
            } else {
                removeErrorMsg($OtherCost);
            }
//            // check other cost details
//            $otherCostDetailsWrapper.find('input').each(function() {
//                var otherCostAmt = parseFloat($(this).val());
//                if(isNaN(otherCostAmt) || otherCostAmt == 0) {
//                    showErrorMsg($(this), 'Invalid Amount...');
//                    isSuccess = false;
//                } else {
//                    removeErrorMsg($(this));
//                }
//            });

            if(isNaN(regVal) || regVal == 0) {
                showErrorMsg($regVal, 'Invalid...');
                isSuccess = false;
            } else if(regVal > 100) {
                showErrorMsg($regVal, 'Value must be Lesser than or Equal to 100.');
                isSuccess = false;
            } else {
                removeErrorMsg($regVal);
            }
//            if(isNaN(lAmtPer)) {
//                showErrorMsg($lAmtPer, 'Invalid...');
//                isSuccess = false;
//            } else if(lAmtPer > 100) {
//                showErrorMsg($lAmtPer, 'Value must be Lesser than or Equal to 100.');
//                isSuccess = false;
//            } else {
//                removeErrorMsg($lAmtPer);
//            }
            var buildtype=$("#buidType").val().trim();
            if(buildtype !=3){
                if( isNaN(cRegVal) || cRegVal == 0) {
                    showErrorMsg($cregVal, 'Invalid...');
                    isSuccess = false;
                } else if(cRegVal > 100) {
                    showErrorMsg($cregVal, 'Value must be Lesser than or Equal to 100.');
                    isSuccess = false;
                } else {
                    removeErrorMsg($cregVal);
                }

//                if(isNaN(cAmtPer)) {
//                    showErrorMsg($cAmtPer, 'Invalid...');
//                    isSuccess = false;
//                } else if(cAmtPer > 100) {
//                    showErrorMsg($cAmtPer, 'Value must be Lesser than or Equal to 100.');
//                    isSuccess = false;
//                } else {
//                    removeErrorMsg($cAmtPer);
//                }
            }
console.log(1);
            callback(isSuccess);
            return isSuccess;
        }

        function showErrorMsg($tarIp, msg) {
            var $tarErrorMsg = $tarIp.closest('.form-group').find('.error_message');
            $tarErrorMsg.find('p').text(msg);
            $tarErrorMsg.show();
        }

        function removeErrorMsg($tarIp) {
            var $tarErrorMsg = $tarIp.closest('.form-group').find('.error_message');
            $tarErrorMsg.find('p').text('Please Enter ' + $tarIp.attr('label') + '...');
            $tarErrorMsg.hide();
        }

        function bindOtherCost_onChange() {
            // select
            $OtherCost.on("select2:select", function (e) {
                //Gets the last selected item
                var $tarOpt = $(e.params.data.element),
                    selOtherCostId = e.params.data.id,
                    selOtherCostName = e.params.data.text.trim();

                var otherCostAmtHtml = '<div class="form-group penality_int_area col-lg-12 req_flds" data-id="'+ selOtherCostId+'">'
                    + '<div class="col-lg-5 col-md-5 col-sm-5 col-xs-4 padlr0">'
                    + '<p style="padding-top:3px;">'+ selOtherCostName+'</p>'
                    + '</div>'
                    + '<div class="col-lg-7 col-md-7 col-sm-7 col-xs-8 padlr0">'
                    + '<input type="text" class="lbl_move other-cost-amt"  name="selectedOtherCostValue_'+selOtherCostId+'" placeholder="Amount" onkeypress="return isDecimal(event, this)">'
                    + '<div class="error_message"><p></p></div>'
                    + '</div>'
                    + '</div>';

                $otherCostDetailsWrapper.append(otherCostAmtHtml);
                $otherCostDetailsWrapper.removeClass('hide');
                var $tarOtherCostDetail = $otherCostDetailsWrapper.find('> div[data-id="'+selOtherCostId+'"]');
                var $tarIp = $tarOtherCostDetail.find('input.lbl_move');

                $tarIp.polymerForm();
                $tarIp.each(function() {
                    if($(this).val() != '' && $(this).val() != null) {
                        $(this).closest('div').addClass('dirty');
                    }
                });
            });

            // unselect
            $OtherCost.on("select2:unselect", function (e) {

                //Gets the last selected item
                var selOtherCostId = e.params.data.id;
                var $tarOtherCostDetail = $otherCostDetailsWrapper.find('> div[data-id="'+selOtherCostId+'"]');
                $tarOtherCostDetail.remove();

                if($otherCostDetailsWrapper.find('>div').length <= 1) {
                    $otherCostDetailsWrapper.addClass('hide');
                }

            });

            $OtherCost.on("select2:unselecting", function (e) {

                var $tarOpt = $(e.params.args.data.element);
                if($tarOpt.attr('data-used') == 'true') {
                    alert('Could not remove. Other cost already in use!');
                    return  false;
                }

            });

        }
    });
    $("#OtherCost").change(function(e) {


        var data=[];
        var $el=$("#OtherCost");
        $el.find('option:selected').each(function(){
            data.push({value:$(this).val(),text:$(this).text()});
        });
        var opHtml = '<option value=""></option>';
        var valu = data;
        console.log(valu);
        $.each(valu,function(i,o){
            opHtml += '<option value="'+o.value+'">' +o.text+'</option>';
        });
        $('#Other').html(opHtml);

    });

    $(".special").keydown(function (e) {
        var key = e.which || e.keyCode;
        if (!e.shiftKey && !e.altKey && !e.ctrlKey &&
                // numbers
            key >= 48 && key <= 57 ||
                // Numeric keypad
            key >= 96 && key <= 105 ||
                // Backspace and Tab and Enter
            key == 8 || key == 9 || key == 13 ||
                // Home and End
            key == 35 || key == 36 ||
                // left and right arrows
            key == 37 || key == 39 || (key == 190 &&  this.value.split('.').length === 1) ||
                // Del and Ins
            key == 46 || key == 45){
            return true;}
        else{
            return false;}

    });
</script>