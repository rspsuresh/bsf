<script type="text/javascript" src="<?php echo $this->basePath(); ?>/js/select2.full.min.js"></script>
<link type="text/css" rel="stylesheet" href="<?php echo $this->basePath(); ?>/css/select2.min.css" />
<link rel="stylesheet" href="<?php echo $this->basePath(); ?>/css/workorder.css"/>
<form method="post" id="payment">
    <div class="content_wrapper padlr0">
        <div class="container-fluid padlr0">
            <div class="col-lg-12">
                <h1 data-bsfhead="Payment">Payment</h1>
            </div>
            <!---------------------------Form Area--------------------------->
            <div class="col-lg-12" style=" margin-bottom:10px; padding-bottom:20px;">
                <ul class="edit-lbls" style="margin-top:30px;">
                    <li>
                        <label>Project / Unit / Buyer</label>
                        <input class="parent_text" type="text" name="unitname" id="unitname" data-bsfshare="Project/buyer/Unit" placeholder="Project / Unit / Buyer" />
                        <input type="hidden" name="unitId" id="unitid" value=""/>
                    </li>
                    <li style="position:relative;">
                        <label>Date : </label>
                        <span class="date_icon reen-dates"> <i class="fa fa-calendar"></i> </span>
                        <input class="parent_text  date_picker"  readonly="readonly" type="text" name="pay_date" id="pay_date" data-bsfshare="PaymentDate" value="<?php echo date('d-m-Y');?>"/>
                        <!-- <p class="edit-abl"><?php //echo date('d-m-Y');?></p>-->
                    </li>
                    <li>
                        <label>Voucher No : </label>
                        <input class="parent_text " type="text" name="pay_no" id="pay_no" data-bsfshare="PaymentNo" value="<?php echo uniqid();?>"/>
                        <!-- <p class="edit-abl" type="text" name="pay_no" id="pay_no" ><?php // echo uniqid();?></p>-->
                    </li>
                </ul>
            </div>
            <!---------------------------Form Area end--------------------------->
            <!---------------------------payment deatlis--------------------------->
            <div class="clearfix"></div>
            <div class="col-lg-12">
                <div class="pay-detalis">
                    <h1>Receipts</h1>
                    <ul >
                        <li>
                            <label>Rent Amount Received </label>
                            <i class="fa fa-file cur-css"></i>
                            <div>
                                <input class="parent_text text-right" type="text" name="rent_amount" data-bsfshare="RentAmount" onkeypress="return isDecimal(event,this)" onchange="FormatNum(this, 2);"  id="rent_amount" />
                            </div>
                            <input type="hidden" name="rentalRegId" id="rentalRegId">
                        </li>
                        <li class="pay-tol">
                            <label>Total </label>
                            <i class="fa fa-inr cur-css"></i>
                            <input type="text" readonly class="fa fa-inr cur-css text-right" id="receipt_total" data-bsfshare="Receipt Total" name="receipt_total"/>
                        </li>
                    </ul>
                </div>
                <div class="pay-detalis">
                    <h1>Expenses</h1>
                    <ul >
                        <div id="Expenses"></div>
                        <!--  <li id="bill">
                        <label>Maintenance Bill </label>
                          <i class="fa fa-newspaper-o cur-css"></i>
                        <input class="parent_text text-right" type="text" value="" name="maintanence_bill" id="maintanence_bill">
                      </li>
                      <li id="eb">
                        <label>EB Charges </label>
                       <i class="fa fa-plug cur-css"></i>
                        <input class="parent_text text-right" type="text" value="" name="eb_charges" id="eb_charges">
                      </li>
                      <li id="tele">
                        <label>Telephone Charges </label>
                          <i class="fa fa-phone cur-css"></i>
                        <input class="parent_text text-right" type="text" value="" name="telephone_charges" id="telephone_charges">
                      </li>-->
                        <li class="pay-tol">
                            <label>Total </label>
                            <i class="fa fa-inr cur-css"></i>
                            <input type="text" onchange="FormatNum(this, 2);" class="fa fa-inr cur-css text-right" id="payment_amount" data-bsfshare="Payment Amount" name="payment_amount"  readonly />
                        </li>
                    </ul>
                </div>
            </div>
            <div class="clearfix"></div>
            <div class="col-lg-12">
                <div class="pay-detalis">
                    <h1>Detalis</h1>
                    <ul id="details">
                        <li>
                            <label class="pad-r8">Cheque No </label>
                            <i class="fa fa-check cur-css"></i>
                            <input type="text" value="" data-bsfshare="ChequeNo" name="cheque_no" id="cheque_no" />
                        </li>
                        <li>
                            <label class="pad-r8">Cheque Date</label>
                            <i class="fa fa-calendar cur-css"></i>
                            <input type="text" class="date_picker" data-bsfshare="ChequeDate" readonly="readonly" value="" placeholder="<?php echo date('d-m-Y')?>" name="cheque_date" id="cheque_date" />
                        </li>
                        <li>
                            <label class="pad-r8">Bank Name</label>
                            <i class="fa fa-list-alt cur-cssa"></i>
                            <input type="text" class="mar-le" value="" name="bank_name" data-bsfshare="BankName" id="bank_name" />
                        </li>
                    </ul>
                </div>
                <div class="pay-detalis">
                    <h1>Payable</h1>
                    <ul>
                        <li>
                            <label class="pad-r8" >Amount </label>
                            <i class="fa fa-inr cur-css"></i>
                            <input type="text" value="" class="text-right"name="amount" data-bsfshare="Amount" readonly onchange="FormatNum(this, 2);"  id="amount" />
                        </li>
                        <li id="serv">
                            <div id="serviceamt"></div>
                        </li>
                        <input type="hidden" class="parent_txts" name="RowCount" id="RowCount" value="1" />
                    </ul>
                </div>
            </div>
            <div class="clearfix"></div>
            <div class="col-lg-12">
                <textarea class="narration_textarea pay-rem" placeholder="Remarks..." name="remarks" data-bsfshare="Remarks" id="remarks" rows="3"></textarea>
            </div>
            <div class="clearfix"></div>
            <!---------------------------payment deatlis end--------------------------->
        </div>
    </div>
    <!---------------------------button--------------------------->
    <div class="col-lg-12 savebtn_area clear">
        <ul>
            <li class="dropdown save_btn float_r"> <a href="javascript:void(0);" class="pay ripple">Submit</a> </li>
        </ul>
    </div>
</form>
<!---------------------------button--------------------------->
<script>
    $('#serv').hide();
    $('.edit-abl').bind('click',
        function(){
            $(this).attr('contentEditable',true);
        });

    $RentAmount = $('#rent_amount');


    var arr_Units = <?php echo (isset($unitList)) ? json_encode($unitList) : '[]';?>;
    var $unitname = $('#unitname'),$UnitId = $('#unitid');
    $(document).ready(function() {
        $unitname.autocomplete({
            lookup: arr_Units,
            showNoSuggestionNotice: false,
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            }, onSelect: function (suggestion) {
                if (suggestion) {
                    $UnitId.val(suggestion.data);

                    $(this).removeClass('error');
                    var formData=$UnitId.val(suggestion.data);
                    $.ajax({
                        url:getBaseURL()+"crm/property/payment",
                        type:"post",
                        data:formData,
                        success:function(data,textStatus,jqXHR){
                            var val=JSON.parse(data);
                            var receipts=val['rental'];
                            var payment=val['payment'];
                            var paynt=val['payment'].length;
                            var total=val['total'];
                            $RentAmount.val(0);
                            $("#receipt_total").val(0);
                            $.each(receipts,function(i,o){
                                $RentAmount.val(o.RentAmount);
                                $('#rentalRegId').val(o.RentalRegisterId);
                                $("#receipt_total").val( $("#rent_amount").val());
                            });
                            $("#Expenses").html("");
                            $count=0;
                            if(paynt>0) {
                                $.each(payment, function (i, v) {
                                    $count = $count + 1;
                                    $("#Expenses").append("<li class=''>" +
                                    "<div>" +
                                    "<p>" +
                                    "<label>" + v.ServiceName + "</label>" + " <i class='fa fa-inr cur-css'>" + "</i>" +
                                    "<input type='text' class='parent_text text-right' onchange='FormatNum(this, 2);'  name='service_" + $count + "' id='service_" + $count + "' value='" + v.Amount + "'/>" +
                                        <!--"<input type='hidden' class='parent_text"+v.ServiceId+"' onchange='FormatNum(this, 2);'  name='sample_"+v.ServiceId+"' id='sample_"+v.ServiceId+"' value='"+v.ServiceId+"'/>"+	-->
                                    "</p>" +
                                    "</div>" +
                                    "</li>");
                                    $("#serviceamt").append("<li class=''>" +
                                    "<div>" +
                                    "<p>" +
                                    "<label>" + v.ServiceName + "</label>" + " <i class='fa fa-inr cur-css'>" + "</i>" +
                                        <!--"<input type='text' class='parent_text"+v.ServiceId+"' onchange='FormatNum(this, 2);'  name='service_"+v.ServiceId+"' id='service_"+v.ServiceId+"' value='"+v.Amount+"'/>"+-->
                                    "<input type='hidden' class='parent_text text-right" + v.ServiceId + "' onchange='FormatNum(this, 2);'  name='sample_" + $count + "' id='sample_" + $count + "' value='" + v.ServiceId + "'/>" +
                                    "</p>" +
                                    "</div>" +
                                    "</li>");
                                    //$cnt++;

                                });
                            }
                            if(total!=false) {
                                $("#payment_amount").val(total['Total']);
                            }

                            onChangeUnit();

                        }

                    });

                }

            }, onSearchStart: function (suggestion) {
                $UnitId.val(0);
            }, onSearchComplete: function (query, suggestions) {
                if (!suggestions.length) {
                    $UnitId.val(0);
                    $(this).addClass('error');
                } else $(this).removeClass('error');
            }
        });

    });

    //onchange ajax value//
    $('#Expenses').on('change,blur', 'input', function() {
        var iSum = 0;
        $('#Expenses input').each( function() {
            iSum  += parseFloatVal($(this).val());
            //alert(iSum);
        });
        $('#payment_amount').val(sanitizeNumber(iSum,2));
        onChangeUnit();
    });

    function onChangeUnit() {
        var rent=$("#receipt_total").val();
        var pay=$("#payment_amount").val();
        var tot = rent-pay ;
        $('#amount').val(sanitizeNumber(tot,2))
    }


    $('.pay').on('click',function(){
        var rowCount = $('#Expenses li').length;
        $('#RowCount').val(rowCount);
        if ($("#unitname").val() <= 0) {
            showError($("#unitname"), 'unit name is required!');
            return false;
        }
        else {
            removeError($("#unitname"));
        }

        if ($("#cheque_no").val() <= 0) {
            showError($("#cheque_no"), 'Cheque Number is required!');
            return false;
        }
        else {
            removeError($("#cheque_no"));
        }
        if($("#cheque_date").val() <= 0) {
            showError($("#cheque_date"), 'Cheque Date is required!');
            return false;
        }
        else {
            removeError($("#cheque_date"));
        }
        if($("#bank_name").val() <= 0) {
            showError($("#bank_name"), 'bank name is required!');
            return false;
        }
        else {
            removeError($("#bank_name"));
        }
        if($("#remarks").val() <= 0) {
            showError($("#remarks"), 'remarks is required!');
            return false;
        }
        else {
            removeError($("#remarks"));
        }

        $("#payment").submit();

    });
    $RentAmount.on('change',function(){
        var amt=$("#rent_amount").val();
        $("#receipt_total").val(amt);
        onChangeUnit();
    });
</script>