<!--<script src="<?php echo $this->basePath(); ?>/js/tinymce.min.js"></script>-->
<script src="//cdn.tinymce.com/4/tinymce.min.js"></script>
<script>
tinymce.init({
	selector: "textarea"
});
</script>
<div class="content_wrapper padlr0">
	<div class="container-fluid">
		<div class="row">
		 <?php if(isset($ticketedit)) {?>
			<div class="col-lg-12">
				<h1 class="txt_center">Edit Ticket Details</h1>
		 </div><?php } else{?>
		 <div class="col-lg-12">
				<h1 class="txt_center">Ticket Entry</h1>
		 </div>
		 <?php
		} ?>
			<div class="col-lg-12 clear m_top20">
            	<form class="form-horizontal" id="ticket" method="post">
				<div class="ticketentry">
                <div class="col-lg-10 col-lg-offset-1">
                    <div class="form-group col-lg-6 col-md-6 col-sm-6">
					<?php if(isset($ticketedit)){?>
                        <div class="padtop20 col-lg-12">
						 <input type="text" name="requester" id="requester" value="<?php echo $ticketedit['Requester'];?>" label="Requester" class="lbl_move" />
                            <input type="hidden" name="LeadId" value="<?php echo $ticketedit['LeadId'];?>" id="LeadId" />
                            <input type="hidden" name="MailId" value="<?php echo $ticketedit['Email'];?>" id="EmailId" />
                            <input type="hidden" name="phone" value="<?php echo $ticketedit['Mobile'];?>" id="mobile" />
                            <div class="error_message">
                                <p>Please Enter Requester...</p>
                            </div>
                        </div>
                    <?php } else{?>
					<div class="padtop20 col-lg-12">
					<input type="text" name="requester" id="requester" value="" label="Requester" class="lbl_move"><a href="javascript:void(0);" class="request">New Request</a></input>
                            <input type="hidden" name="LeadId" id="LeadId" value="<?php if(isset($ticketedit)){echo $ticketedit['LeadId'];}?>"/>
                            <input type="hidden" name="mailId" id="mailId" value="<?php if(isset($ticketedit)){echo $ticketedit['Email'];}?>"/>
                            <input type="hidden" name="phonenumber" id="phonenumber" value="<?php if(isset($ticketedit)){echo $ticketedit['Mobile'];}?>" />
                            <div class="error_message">
                                <p>Please Enter Requester...</p>
					</div>
					</div><?php }?>
					</div>
                    <div class="form-group col-lg-6 col-md-6 col-sm-6">
                        <div class="padtop20 col-lg-12">
                            <input type="text" name="subject" value="<?php if(isset($ticketedit)){echo $ticketedit['Subject'];} ?>" label="Subject" class="lbl_move" />
                            <div class="error_message">
                                <p>Please Enter Subject...</p>
                            </div>
                        </div>
                    </div>
                    <div class="form-group col-lg-6 col-md-6 col-sm-6">
                        <div class="padtop20 col-lg-12">
                            <select class="single_dropdown2 lbl_move" style="width:100%;" name="type" id="type" label="Type" title="Type">
                                 <option value="">Type<option>
										<option value="Question" <?php echo (isset($ticketedit) && $ticketedit['Type'] == "Question") ? 'selected' : '';?>>Question<option>
                                        <option value="Incident" <?php echo (isset($ticketedit) && $ticketedit['Type'] == "Incident") ? 'selected' : '';?>>Incident</option>
                                        <option value="Problem" <?php echo (isset($ticketedit) && $ticketedit['Type'] == "Problem") ? 'selected' : '';?>>Problem</option>
                                        <option value="Request" <?php echo (isset($ticketedit) && $ticketedit['Type'] == "Request") ? 'selected' : '';?>>Request</option>
                                        <option value="Lead" <?php echo (isset($ticketedit) && $ticketedit['Type'] == "Lead") ? 'selected' : '';?>>Lead</option>
                            </select>
                            <div class="error_message">
                                <p>Please Select Type...</p>
                            </div>
                        </div>
                    </div>
                    <div class="form-group col-lg-6 col-md-6 col-sm-6">
                        <div class="padtop20 col-lg-12">
                            <select class="single_dropdown2 lbl_move" style="width:100%;" name="status" label="Status" title="Status">
                                <option value="">Status<option>
							    <option value="Open" <?php echo (isset($ticketedit) && $ticketedit['Status'] == "Open") ? 'selected' : '';?>>Open<option>
                                        <option value="Pending" <?php echo (isset($ticketedit) && $ticketedit['Status'] == "Pending") ? 'selected' : '';?>>Pending</option>
                                        <option value="Resolved" <?php echo (isset($ticketedit) && $ticketedit['Status'] == "Resolved") ? 'selected' : '';?>>Resolved</option>
                                        <option value="Closed" <?php echo (isset($ticketedit) && $ticketedit['Status'] == "Closed") ? 'selected' : '';?>>Closed</option>
                                        <option value="Waiting for Customer" <?php echo (isset($ticketedit) && $ticketedit['Status'] == "Waiting for Customer") ? 'selected' : '';?>>Waiting for Customer</option>
                            </select>
                            <div class="error_message">
                                <p>Please Select Status...</p>
                            </div>
                        </div>
                    </div>
                    <div class="form-group col-lg-6 col-md-6 col-sm-6">
                        <div class="padtop20 col-lg-12">
                            <select class="single_dropdown2 lbl_move" style="width:100%;" name="priority" label="Priority" title="Priority">
                                <option value="">Priority<option>
									   <option value="Low" <?php echo (isset($ticketedit) && $ticketedit['Priority'] == "Low") ? 'selected' : '';?>>Low<option>
                                        <option value="Medium" <?php echo (isset($ticketedit) && $ticketedit['Priority'] == "Medium") ? 'selected' : '';?>>Medium</option>
                                        <option value="High" <?php echo (isset($ticketedit) && $ticketedit['Priority'] == "High") ? 'selected' : '';?>>High</option>
                                        <option value="Urgent" <?php echo (isset($ticketedit) && $ticketedit['Priority'] == "Urgent") ? 'selected' : '';?>>Urgent</option>
                            </select>
                            <div class="error_message">
                                <p>Please Select Priority...</p>
                            </div>
                        </div>
                    </div>
                    <div class="form-group col-lg-6 col-md-6 col-sm-6">
                        <div class="padtop20 col-lg-12">
                            <select class="single_dropdown2 lbl_move" name="tgroup" style="width:100%;" label="Group" title="Group">
                                <option value="">Group<option>
										<option value="Sales" <?php echo (isset($ticketedit) && $ticketedit['TGroup'] == "Sales") ? 'selected' : '';?>>Sales<option>
                                        <option value="Support" <?php echo (isset($ticketedit) && $ticketedit['TGroup'] == "Support") ? 'selected' : '';?>>Support</option>
                            </select>
                            <div class="error_message">
                                <p>Please Select Group...</p>
                            </div>
                        </div>
                    </div>
                    <div class="form-group col-lg-6 col-md-6 col-sm-6">
                        <div class="padtop20 col-lg-12">
                            <select class="single_dropdown2 lbl_move" style="width:100%;" name="executiveId" label="Executive" title="Executive">
                                 <option value="">Choose Executive Name</option>
											<?php
											foreach($resultsExecutive as $type){
												if(count($ticketedit)>0){
													echo "<option ".($ticketedit['ExecutiveId']==$type['UserId']? 'selected':'')." value='".$type['UserId']."' >".$type['EmployeeName']."</option>";
												}
												else{
													echo "<option value='".$type['UserId']."' >".$type['EmployeeName']."</option>";
												}
											}
											?>
                            </select>
                            <div class="error_message">
                                <p>Please Select Executive...</p>
                            </div>
                        </div>
                    </div>
                    <!--<div class="form-group col-lg-6 col-md-6 col-sm-6">
                        <div class="padtop20 col-lg-12">
                            <select class="multiple_dropdown lbl_move" multiple="multiple" name="tags[]" id="tags" style="width:100%;" label="Tags" title="Tags">
                                <option value="Tags1">Tags1<option>
								<option value="Tags2">Tags2</option>
                            </select>
                            <div class="error_message">
                                <p>Please Select tags...</p>
                            </div>
                        </div>
                    </div>-->
                    <div class="form-group col-lg-12 clear">
                    	<div class="col-lg-12">
                    		<textarea id="description" name="description"><?php if(isset($ticketedit)){echo $ticketedit['Description'];} ?></textarea>
							<div class="error_message">
                                <p>Please give some Description...</p>
                            </div>
                    	</div>
                    </div>
					<?php if(isset($ticketedit)){?>
                    <div class="form-group col-lg-6 col-md-6 col-sm-6">
                        <div class="padtop20 col-lg-12">
                        <div class="vip_customer keepme_area brad_50 float_l">
                            <input type="checkbox" value="1" name="updatecli" id="updatecli" <?php echo ((count($ticketedit)>0 && $ticketedit['CliUpdate'] == 1)?'checked':'')?> class="keepme" />
                            <label for="updatecli" ></label>
                        </div>
                        <p class="float_l vip_label_p"><label for="updatecli" class="ripple">Want to Update Status to Client?</label></p>
                    </div>
                </div>
					<?php }?>  
                    
                    <div class="col-lg-12 savebtn_area m_btm20 no_border">
                        <ul>
                            <li class="save_btn m_auto"> <a href="javascript:void(0);" class="ripple continue">Generate Ticket</a> </li>
                        </ul>
                    </div>
               	</div>
               	</div>
				
				<div class="modal fade" id="agreementnext" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
				<div class="modal-dialog width865" role="document">
					<div class="modal-content">
						<div class="modal-body">
							<div class="padlr0">
								<div class="container-fluid">
									<div class="">
									    <div class="form-group col-lg-6 col-md-6 col-sm-6">
                                        <div class="padtop20 col-lg-12">
										 <input type="text" name="requestern" id="requestern" value="" label="Requester" class="lbl_move">
										  <div class="error_message">
                                           <p>Please Enter Requester...</p>
										   </div>
									        </div>
								            </div>
										  <div class="form-group col-lg-6 col-md-6 col-sm-6">
                                          <div class="padtop20 col-lg-12">
										 <input type="text" name="emailIdn" id="emailIdn" value="" label="EmailId" class="lbl_move">
										 <div class="error_message">
												<p>Please Enter emailId...</p>
											</div>
										</div>
									</div>
										 <div class="form-group col-lg-6 col-md-6 col-sm-6">
                                          <div class="padtop20 col-lg-12">
										 <input type="text" name="phonen" id="phonen" value="" label="Phone" class="lbl_move">
										  <div class="error_message">
													<p>Please Enter Phone...</p>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="modal-footer">
							<div class="commargin_top commargin_bottom">
								<a href="javascript:void(0);" id="create" onclick="return newrequest();" class="md_cance">Create</a>
								<a href="javascript:void(0);" id="btnDeleteYes" class="md_ok">Delete</a></div>
						</div>
					</div>
				</div>
				</div>
                </form>
			</div>
		</div>
	</div>
</div>
<script>
$(document).ready(function() {
	$(".single_dropdown2").select2({
		placeholder: "",
		allowClear: true
	});
	$(".multiple_dropdown").select2({
    });
});
</script>
<script>
$(document).ready(function() {
	$(".single_dropdown2").select2({
		placeholder: "",
		allowClear: true
	});
});


//form validation//
$(".continue").click(function(){
	$('.error_message').hide();
	var ele = $(".ticketentry:visible");
	$(".error").text("");
	var bool = true;
	ele.find("input ,select").each(function(){
	var tagname = $(this).prop("tagName").toLowerCase();
            if(tagname == 'input'){
                var type = $(this).attr("type");
                if(type == 'text'){
                    if($(this).is(":visible") && $(this).val().trim() == ''){
                        bool=false;
                         $(this).closest('.form-group').find(".error_message").show();
                        $(this).focus();
                        return false;
			}
			
			}}
			else if(tagname == 'select'){
              
                    if ($(this).val() == "" || $(this).val() == null){
                        bool = false;
                        $(this).closest('.form-group').find(".error_message").show();
                        $(this).focus();
                        return false;
                    }
			 }
			 else if(tagname == 'textarea'){
                if($(this).is(":visible")){
                    if($(this).val().trim().length == 0){
                        bool = false;
                        $(this).closest('.form-group').find(".error_message").show();
                        $(this).focus();
                        return false;
                    }
                }
            }
        else {
                $(".error_message").remove();
            }
		});
		
	if(bool){
		
			
			if($(".ticketentry:visible").index() == $(".ticketentry:last").index()){
				
				$("#ticket").submit();
			}
		
		
	}
});
//autocomplete//
var arr_Units = <?php echo (isset($resultsLead)) ? json_encode($resultsLead) : '[]';?>;
var $LeadName = $('#requester'),$LeadId= $('#LeadId');$MailId= $('#mailId');$phone=$('#phonenumber');
$LeadName.autocomplete({
  lookup: arr_Units,
  showNoSuggestionNotice: false,
  lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
      if (queryLowerCase == '*') {
          return suggestion.value;
      } else {
          var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
          return re.test(suggestion.value);
      }
  },
  onSelect: function (suggestion) {
      if (suggestion) {
  $LeadId.val(suggestion.data);
  $MailId.val(suggestion.mail);
  $phone.val(suggestion.phone);
  }
  },
  onSearchStart: function (suggestion) {
      $LeadId.val(0);
      $MailId.val(0);
      $phone.val(0);
  }, onSearchComplete: function (query, suggestions) {
      if (!suggestions.length) {
          $LeadId.val(0);
          $MailId.val(0);
          $phone.val(0);
      } 
  }
		 
});


$('.request').click(function(){

$('#agreementnext').modal('show');


});
$('#btnDeleteYes').click(function(){
$('#agreementnext').modal('hide');
});
function newrequest(){
		//alert("1");
            var reqs = $("#requestern").val();
            var phonen = $("#phonen").val();
            var emailn = $("#emailIdn").val();
            $("#requester").val($('#requestern').val());
            $("#mailId").val($("#emailIdn").val());
            $("#phonenumber").val($("#phonen").val());
            if(reqs.length == 0) {
               alert("Requester name is required");
                $("#requestern").val().focus();
				return false;
            } else{
			removeError($("#requestern"));}
			if(phonen.length == 0) {
                alert(" EmailId is required");
                return false;
            } else{
			removeError($("#phonen"));}
			if(emailn.length == 0) {
                 alert("Phone number is required");
                return false;
            } else{
			removeError($("#emailIdn"));}

	$('#agreementnext').modal('hide');
	       $.ajax({
                url: getBaseURL() + 'crm/pm/new',
                type: 'POST',
                async: false,
                data:  "request="+reqs+"&phoneId="+phonen+"&emailId="+emailn,
                success:function(data, textStatus, jqXHR){
                   
                },
                error:function(jqXHR, textStatus, errorThrown){
                    alert('Failed to add!');
                }
            });
            $("#requestern").val('');
            $("#phonen").val('');
            $("#emailIdn").val('');
	}

</script>
<!--PAGE SCRIPTS-->