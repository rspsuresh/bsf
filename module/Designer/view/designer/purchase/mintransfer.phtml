<!--STYLE-->
<link rel="stylesheet" href="<?php echo $this->basePath() . '/css/wpm.css';?>"/>
<style type="text/css">
    #WorkTypeWrapper,
    #pref-details,
    #vendorServiceListWrapper {
        display: none;
    }
    #WorkType + .select2,
    #vendorServiceList + .select2{
        width: 100% !important;
	}
	.fil-til h2		{font-weight:300!important;font-size:22px; color:#3f5fa2; padding-bottom: 20px; padding-left:0px !important; float:left;}
	.fil-til p		{font-weight:300!important;font-size:14px;color:#548301;padding-left:0px;float:left; padding-top: 13px;}
	.fil-til span	{font-weight:700!important;font-size:14px;color:#548301;padding-left:0px;float:left; padding-top: 16px; padding-left:5px;}
	.push_10		{margin-left:10px;}
	.push_15		{margin-left:15px;}
	.push_btm_20	{margin-bottom:20px !important;}
	.blue-bg		{height:90px !important; background: #3580c4;padding-top: 20px;}
	.clr_fff		{color:#3680c2; font-weight:600 !important;}
	.mar_5			{margin-top:5px;}
	.mar_lft20		{margin-left:20px;}
	.mar_20			{margin-top:20px;}
	.lbl_move 		{height: 45px !important;
	.radio_check p  {float: left;font-size: 14px; padding: 11px 15px 11px 0 !important;}
</style>

<!--content-->
<form method="post" action="<?php echo $this->basePath(); ?>/mms/issue/" id="formWrapper">
	<div class="content_wrapper padlr0">
    	<div class="container-fluid">
            <div class="col-lg-12">
				<h1>Min Transfer</h1>
			</div>
			<div class="col-lg-12">
				<div class="col-lg-2 col-lg-offset-0 col-md-4 col-md-offset-0 col-sm-4 col-sm-offset-0 col-xs-12 col-xs-offset-0">
					<div class="radio_check">
						<p>
							<input type="radio"  class="ripple" value="0" id="Own" name="OwnOrCsm" checked />
							<label for="Own" class="clr_fff">Despatch</label>
						</p>
					</div>
				</div>
				<div class="col-lg-5 col-lg-offset-0 col-md-2 col-md-offset-0 col-sm-2 col-sm-offset-0 col-xs-12 col-offset-0 form-group req_flds">
					<select class="single_dropdown lbl_move" data-bsfshare="Issue Type" style="width:100%;" 
					data-placeholder="From Compnay" 
					name="issue_type" id="issue_type">
						<option value=""></option>
						<option value="1">Casa Grand Pvt.Ltd</option>
						<option value="2">NAPCL Pvt.Ltd</option>
					</select>
				<div class="error_message"><p>Please select Company...</p> </div>
				</div>
				<div class="col-lg-5 col-lg-offset-0 col-md-2 col-md-offset-0 col-sm-2 col-sm-offset-0 col-xs-12 col-offset-0 form-group req_flds">
					<select class="single_dropdown lbl_move" data-bsfshare="Issue" style="width:100%;" 
					data-placeholder="From Project"  
					name="issue" id="issue">
						<option value=""></option>
						<option value="0">Issue</option>
						<option value="1">Return</option>
					</select>
					<div class="error_message"><p>Please select Project ...</p> </div>
				</div>
			</div>
			<div class="col-lg-12">
				<div class="col-lg-2 col-lg-offset-0 col-md-4 col-md-offset-0 col-sm-4 col-sm-offset-0 col-xs-12 col-xs-offset-0">
					<div class="radio_check">
						<p>
							<input type="radio" class="ripple"value="1" id="Csm" name="OwnOrCsm"/>
							<label for="Csm" class="clr_fff">Receipt</label>
						</p>
					</div>
				</div>
				<div class="col-lg-5 col-lg-offset-0 col-md-2 col-md-offset-0 col-sm-2 col-sm-offset-0 col-xs-12 col-offset-0 form-group req_flds">
					<select data-placeholder="To Company" style="width:100%;" class="single_dropdown lbl_move" 
					name="CostCentre" id="CostCentre">
						<option value=""></option>
						<option value="1">Casa Grand Pvt.Ltd</option>
						<option value="2">NAPCL Pvt.Ltd</option>	
					</select>
					<div class="error_message"><p>Please select Company..</p></div>
				</div>
				<div class="col-lg-5 col-lg-offset-0 col-md-2 col-md-offset-0 col-sm-2 col-sm-offset-0 col-xs-12 col-offset-0 form-group req_flds">
					<select data-placeholder="To Project" style="width:100%;" class="single_dropdown lbl_move" 
					name="CostCentre" id="CostCentre">
						<option value=""></option>
						<option value="0">Issue</option>
						<option value="1">Return</option>
					</select>
					<div class="error_message"><p>Please select project...</p></div>
				</div>
			</div>
        	<div class="col-lg-12 feed-bg mar_20">
                <div class="fil-til push_btm_20">
                    <h2 class="h1-head">List of resources from the selected project.</h2>
                    <p class="h1-head push_15">Selected Resources</p>
                    <span class=" h1-head push_15" id="NoOfSelResource">0</span>
                </div>
                <div id="resourceGrid"></div>
            </div>
            <input type="hidden" name="frm_index" value="1"/>
        	<div id="requestTransInputsWrapper" class="hide">
            	<input type="hidden" name="frm_index" value="1"/>
    		</div>
		</div>
 	</div>
    <div class="col-lg-12 savebtn_area">
    	<ul>
        	<li id="continueButton" class="dropdown save_btn float_r">
         		<a onclick="validateOnSubmit();" class="ripple">Continue</a>
        	</li>
            <li class="cancel_btn cancel_btn_bluecolor float_l"><a href="<?php echo $this->basePath() . '/mms/issue/entry';?>" 
                class="ripple">Cancel</a>
           	</li>
     	</ul>
  	</div>
</form>	

<script type="text/template" id="request-template">
    <div class="col-md-3">
        <div class="three-box hvr-overline-from-center request-box">
            <ul data-id="{{IssueRegisterId}}">
                <li><span>Request No</span>:&nbsp;{{IssueNo}}</li>
                <li><span>Cost Centre</span>:&nbsp;{{CostCentreName}}</li>
                <li><span>Approved On</span>:&nbsp;{{RequestDate}}</li>
            </ul>
            <span class="high-lit">R</span>
        </div>
    </div>
</script>
<script>
var sel_resource_count = 0;
var tmpLocalData = [];
var $resourceGrid = $("#resourceGrid");
var $searchRequestNo = $('#searchRequestNo');
var resourceSource = {
    localdata: [],
    dataType: "json",
    dataFields: [
        { name: 'Include', type: 'boolean' },
        { name: 'ResourceId', type: 'int' },
        { name: 'ResourceName', type: 'string' },
        { name: 'ItemId', type: 'string' },
        { name: 'Quantity', type: 'string' },
        { name: 'IssueNo', type: 'string' },
        { name: 'RequestDate', type: 'string' },
        { name: 'IssueRegisterId', type: 'int' }
    ],
    id: 'RequestTransId'
};
var resourceAdapter = new $.jqx.dataAdapter(resourceSource);

$(function () {
    $('#CostCentre').on('change',function(){
        $searchRequestNo.val('');
        bindRequests();
    });

    $('#RequestType').on('change',function(){
        $searchRequestNo.val('');

        if($(this).val() == 'service') {
            $('#vendorServiceListWrapper').show();
            $('#vendorServiceList').prop('disabled', false);

            $('#vendorContractListWrapper').hide();
            $('#vendorContractList').prop('disabled', true);
        } else {
            $('#vendorServiceListWrapper').hide();
            $('#vendorServiceList').prop('disabled', true);

            $('#vendorContractListWrapper').show();
            $('#vendorContractList').prop('disabled', false);
        }

        bindRequests();
    });

    $('#WorkType').on('change',function(){
        $searchRequestNo.val('');
        bindRequests();
    });

    $resourceGrid.jqxGrid({
        width: '100%',
        pageable: true,
        rowsheight: 35,
        selectionMode: 'singleRow',
        pagerButtonsCount: 6,
        autoheight:true,
        source: resourceAdapter,
        editable: true,
        columns: [
            { dataField: 'RequestTransId', hidden: true},
            { dataField: 'IssueRegisterId', hidden: true},
            { text: '', dataField: 'Include', columntype: 'checkbox', align:'center',width:'15%'},
            { text: 'Resource Name', dataField: 'ResourceName',width:'85%', editable:false},
        ]
    });
    $resourceGrid.on('cellvaluechanged', function (event) {
        var args = event.args;
        var datarow = $resourceGrid.jqxGrid('getrowdata', args.rowindex);
        if(args.newvalue === true)
            sel_resource_count++;
        else
            sel_resource_count--;
        $('#NoOfSelResource').html(sel_resource_count);
        generateSelResourceInputs();
    });
    $('#RequestType').on('change', function () {
        if($(this).val() == 'work') {
            $('#WorkTypeWrapper').show();
        } else {
            $('#WorkTypeWrapper').hide();
        }
    });
    // request check and uncheck
    $('#requestWrapper').on('click','.request-box', function () {
        $(this).toggleClass('selected');
        renderSelectedResources();
    });
    // search by request no.
    $searchRequestNo.on('keyup', function () {
        var requestNo = $.trim($(this).val());
        if(IssueNo.length != 0 && tmpLocalData.length != 0) {
            var filtered_data = $.grep(tmpLocalData, function (o) {
                return new RegExp('^'+IssueNo,'gi').test(o.IssueNo);
            });
            renderRequests(filtered_data);
        } else {
            renderRequests(tmpLocalData);
        }
    });
    // vendor select2
    $(".single_dropdown_vendor").select2({
        placeholder: "",
        templateResult: formatState,
        templateSelection: formatState,
        allowClear: true
    });
});

function formatState (state) {
    if (!state.id) { return state.text; }
    var $state = $('<span class="img-select"><img src="<?php echo $this->basePath() . '/images/avatar.jpg';?>" class="img-flag" /> ' + state.text + '</span>');
    return $state;
}

function bindRequests() {
    var costCentreId = $('#CostCentre').val();
    var RequestType = $('#RequestType').val();
    var workType = $('#WorkType').val();

    if(RequestType == 'work' && workType == '')
        return;

    $.ajax({
        url:getBaseURL()+'ats/index/sample',
        type:"post",
        data:{'CostCentreId':costCentreId, 'RequestType': RequestType, 'WorkType': workType},
        dataType:"json",
        success:function(data, textStatus, jqXHR){
            if(jqXHR.status == 200) {
                renderRequestResources(data.resources);
            }
        }
    });
}

function renderRequests(data) {
    var $requestWrapper = $('#requestWrapper');
    if(data.length == 0) {
        $requestWrapper.html('<p style="text-align: center;padding-top: 88px;">No data to display.</p>');
    } else {
        var template = $('#request-template').html();
        $requestWrapper.html('');
        $.each(data, function (i,o) {
            $requestWrapper.append(template.replace(/\{\{IssueNo\}\}/g,o.IssueNo)
                .replace(/\{\{CostCentreName\}\}/g,o.CostCentreName)
                .replace(/\{\{RequestDate\}\}/g,o.RequestDate)
                .replace(/\{\{IssueRegisterId\}\}/g,o.IssueRegisterId));
        });
    }
}

function renderRequestResources(data) {
    resourceSource.localdata = data;
    resourceAdapter.dataBind();
}

function renderSelectedResources() {
    var $selRequests = $('.request-box.selected');
    $('#NoOfSelRequest').html($selRequests.length);

    // select resources in grid
    if($selRequests.length != 0) {
        var arr_requestIds = [];
        $.each($selRequests, function (i, o) {
            var requestId = $(this).find('ul[data-id]').attr('data-id');
            arr_requestIds.push(IssueRegisterId);
        });

        $.each(resourceSource.localdata, function (j, r) {
            if ($.inArray(r.IssueRegisterId, arr_requestIds) != -1) {
                r.Include = '1';
                sel_resource_count++;
                return;
            }

            r.Include = '0';
        });
    } else {
        $.each(resourceSource.localdata, function (j, r) {
            r.Include = '0';
        });
        sel_resource_count = 0;
    }
    $('#NoOfSelResource').html(sel_resource_count);
    resourceAdapter.dataBind();
    generateSelResourceInputs();
}

function generateSelResourceInputs() {
    var rows = $resourceGrid.jqxGrid('getrows');
    var $inputs = '';
    for(var i = 0; i < rows.length; i++) {
        var row = rows[i];
        if (row.Include === true) {
            $inputs += '<input type="hidden" name="requestTransIds[]" class="requestTransIds" value="' + row.ResourceId + '"/>';
            $inputs += '<input type="hidden" name="itemTransIds[]" class="itemTransIds" value="' + row.ItemId + '"/>';
        }
    }

    $('#requestTransInputsWrapper').html($inputs);
}

function validateOnSubmit() {
    if($('#issue_type').val() == '') {
//            $('#RequestType').select2('open');
        alert('Please select Issue Type');
        return false;
    }

    if($('#issue').val() == '') {
//            $('#vendorServiceList').select2('open');
        alert('Please select issue');
        return false;
    }

    if($('#CostCentre').val() == '') {
//            $('#CostCentre').select2('open');
        alert('Please select Cost Centre');
        return false;
    }


    if($('#issue_date').val() == '') {
//            $('#vendorServiceList').select2('open');
        alert('Please select issue_date');
        return false;
    }

    if($('#NoOfSelResource').html() == 0) {
        alert('Please select resources');
        return false;
    }

    $('#formWrapper').submit();
}
$('#issue_type').on('change', function() {
    var sname = $("#issue_type option:selected").text();
    if(sname=='Contractor'){
       $('#contract').show();
    } else {
        $('#contract').hide();
    }
}).change();
$('.datepickerinput').datepicker({
    format: "dd-mm-yyyy",
    startDate: new Date(),
    todayBtn: true,
    orientation: "top auto",
    autoclose: true
}).on("changeDate", function(e){
    $("#dateSpan").text($(this).val());
});
$('.date_icon').click(function() {
    var input = $(this).parent().find('input').datepicker('show');
});


</script>