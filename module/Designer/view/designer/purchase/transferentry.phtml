<!--STYLE-->
<link rel="stylesheet" href="<?php echo $this->basePath() . '/css/workorder.css';?>"/>
<link rel="stylesheet" href="<?php echo $this->basePath() . '/css/wpm.css';?>"/>
<!--STYLE-->
<style>
    .panel {border-radius:0px !important;}
    .panel-info { border:none;border-top:none;}
    .lbl_btm {padding-bottom:7px!important;}
    .lbl_tp {padding-top:7px!important;}
    .pan_box	{display:block; width:100%; background:#fff; box-shadow: inset 0 0 1em #ccc; height:200px;border-left:3px solid #a93c14;    		 					  				 position:relative;transition: all 0.5s ease; margin-bottom:15px;}
    .pan_box ul {width:100%;  padding:13px; margin-left:10px; float:left; padding-top:8px;}
    .pan_box ul li  {width:100%; padding-bottom:5px; float:left;}
    .pan_box ul li label {font-size:13px; color:#009688;  float:left; width:200px; padding-left: 6px;}
    .mgic	{border: medium none; color: #266aa8;font-size: 13px; overflow: hidden;text-overflow: ellipsis; white-space: nowrap; width: 100px;}
    .pan_box ul li span input[type=text] {border:none;font-size:13px; color:#266aa8; width:100px;white-space: nowrap;overflow: hidden;text-overflow:      		 										ellipsis; }
    .top-20	{margin-top:20px;}
    .pan_box:before {content:"\f0da";font-family:FontAwesome;font-style:normal;font-weight:normal;text-decoration:inherit;color:#a93c14;font-size:18px;			                	padding-right:0.5em;position:absolute;top:38%;left:-1px;transition: all 0.5s ease;}
    .pan_box:hover:before	{content:"\f0da"; color:red;}
    .pan_box:hover {border-left:3px solid red;}
    .box2th			{border-left:3px solid #ff9800;}
    .box2th:before	{content:"\f0da"; color:#ff9800;}
    .box3th			{border-left:3px solid #4caf50;}
    .box3th:before	{content:"\f0da"; color:#4caf50;}
    .pad_rt-10	{padding-right:10px;}
	.bot-20		{margin-bottom:20px;}
    .tick	{margin-left:20px; color:#266aa8;}
    .hde{float:left;color:#039;font-size:16px !important;font-weight:400 !important;}
    .shw{float:left;center;color:#666;font-size:16px !important;font-weight:400 !important; display:inline-block;}
    .kik_btn{color:#fff; background:#6796c0;}
    .kik_btn:hover{background:#23527c;}
	.cal_icon{color: #b2b3b4;cursor: pointer;display: inline-block;font-size: 14px;font-weight: normal;line-height: 9px;position: absolute;right: 20px;top: 11px;z-index: 1;}
	.select2-selection__placeholder{ font-size:13px!important; padding-top:2px; font-weight:600; color:#009688!important;}
	.select2-container--default .select2-selection--single .select2-selection__arrow b {border-color: #266aa8 transparent transparent transparent !important;border-style: solid;border-width: 5px 4px 0 4px;height: 0;left: 50%;margin-left: -4px; margin-top: -2px;position: absolute;top: 50%;width: 0;
	.bootstrap-select.btn-group .btn .caret { position: absolute; top: 50%; right: 7px!important; margin-top: -2px; vertical-align: middle;color: #266aa8 !important;}
	.bootstrap-select.btn-group .btn .filter-option {display: inline-block;overflow: hidden;width: 100%;text-align: left;color: #00968b !important;font-size: 13px !important;font-weight:600!important;}
	</style>
<!--content-->
<div class="content_wrapper padlr0">
<div class="container-fluid">
<div class="row">
<form method="post" id="formWrapper" action="<?php echo $this->basePath(); ?>/mms/purchase/">
<input type="hidden" id="CostCenterId" name="CostCenterId" value="">
<input type="hidden" name="PORegId" value="">
<input type="hidden" name="VendorId" value="">
<input type="hidden" name="OrderType" id="OrderType" value="">
<div class="col-lg-12">
    <h1>Min Conversion</h1>
</div>
<div class="col-lg-12">
    <div class="col-lg-4">
        <div class="pan_box">
            <ul>
                <li class="lbl_tp lbl_btm">
                    <label>Cost Centre</label>
                    <span class="mgic"></span>
                </li>
                <li class="lbl_tp lbl_btm">
                    <label>Vendor</label>
                    <span class="mgic"></span>
                </li>
                <li class="lbl_tp pad_rt-10 lbl_btm">
                    <label></label>
                    <span>
                        <select name="purchase_type" id="purchase_type" class="form-control single_dropdown sortoption" data-placeholder="Select Purchase Type" style="width:100%;">
                            <option value="" >Select Purchase Type</option>
                            
                        </select>
                        <script>
                            $(document).ready(function() {
                                $(".single_dropdownpt").select2({
                                    placeholder: "",
                                    allowClear: true
                                });
                            });
                        </script>
                    </span>
                </li>
                <li class="lbl_tp pad_rt-10 lbl_btm">
                    <label></label>
                    <select name="account_type" id="account_type" class="form-control single_dropdown sortoption" data-placeholder="Select Account Type" style="width:100%;">
                        <option value="" >Select Account Type</option>
                        
                    </select>
                    <script>
                        $(document).ready(function() {
                            $(".single_dropdownpt").select2({
                                placeholder: "",
                                allowClear: true
                            });
                        });
                    </script>
                    <div class="error_message"><p>Please enter Account type...</p> </div>
                </li>

            </ul>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="pan_box box2th">
            <ul>
                <li class="lbl_tp lbl_btm">
                    <label>Tv Date</label>
                    <span><input type="text" placeholder="DD-MM-YYYY" class="date_picker" id="PODate" name="PODate" style="cursor:pointer;" value="<?php echo (isset($PODate)) ? $PODate : date('d-m-Y');?>" readonly onchange="validateDate(this)"/></span>
                </li>
                <li class="lbl_tp lbl_btm">
                    <label>GP No</label>
                    <span class="mgic"></span>
                </li>
				<li class="lbl_tp lbl_btm">
                    <label>GP Date</label>
                    <span><input type="text" placeholder="DD-MM-YYYY" class="date_picker" id="RefDate" name="RefDate" style="cursor:pointer;" value="<?php echo (isset($RefDate)) ? $RefDate : date('d-m-Y');?>" onchange="validateDate(this)"/></span>
                </li>
				<li class="lbl_tp lbl_btm">
                    <label>Despatch Date</label>
                    <span><input type="text" placeholder="DD-MM-YYYY" class="date_picker" id="RefDate" name="RefDate" style="cursor:pointer;" value="<?php echo (isset($RefDate)) ? $RefDate : date('d-m-Y');?>" onchange="validateDate(this)"/></span>
                </li>
            </ul>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="pan_box box3th">
            <ul>
                <li class="lbl_tp lbl_btm">
                    <label>CTV No</label>
                    <span><input type="text" placeholder="xxxxx" id="PVNo" name="PVNo" value="<?php echo (isset($vNo)) ? $vNo : ''; ?> "readonly /></span>
                </li>
                <li class="lbl_tp lbl_btm">
                    <label>CCTV No</label>
                    <span><input type="text" placeholder="xxxxx" id="CCPVNo" name="CCPVNo" value="<?php echo (isset($CCPONo)) ? $CCPONo : '';?>"/></span>
                </li>
				<li class="lbl_tp pad_rt-10">
                    <label></label>
                    <span>
                        <select id="vehicle" name="vehicle"  class="form-control single_dropdown sortoption" style="width:100%;" data-placeholder="Vehicle Used">
                            
                                <option value=""</option>
                           
                        </select>
                        <script>
                            $(document).ready(function() {
                                $(".single_dropdowncur").select2({
                                    placeholder: "",
                                    allowClear: true
                                });
                            });
                        </script>
                    </span>
                </li>
				<li class="checkbox-styled ">
                	<label>
                    <input type="checkbox"class="chkbx" >
                    <span><p class="tick">Adjustment</p></span>
                    </label>
         		</li>	
				<li class="checkbox-styled">
                	<label>
                    <input type="checkbox"class="chkbx" >
                    <span><p class="tick">Indirect</p></span>
                    </label>
         		</li>	
            </ul>
        </div>
    </div>
</div>
<div class="clearfix"></div>
<div class="col-lg-12 clear top-20">
    <div id="accordion" class="panel-group">
        <!-------------------------------Bill of Quantities------------------------------->
        <div class="panel panel-info">
            <div data-target="#collapseOne" data-parent="#accordion" data-toggle="collapse" class="panel-heading collapsed panel_heads" id="panelheading-1">
                <h4 class="panel-title accordion-toggle defa_panels">Purchase Quantity</h4>
            </div>
            <div class="panel-collapse collapse" id="collapseOne" style="height: 0px;">
                <div class="panel-body bgcolr">
                    <div class="col-lg-12">
                        <div class="table-responsive top-30">
                            <table class="table" style=" margin-bottom:0px;" id="workorderTable">
                                <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Unit</th>
                                    <th>Qty</th>
									<th>Actual Qty</th>
                                    <th>Rate</th>
                                    <th>QRate</th>
                                    <th>BaseAmount</th>
                                    <th>Amount</th>
                                    <th>&nbsp;</th>
									<th>&nbsp;</th>
                                </tr>
                                </thead>
                                <tbody class="main"></tbody>
                                <tbody class="total">
                                <tr>
                                    <td colspan="6">&nbsp;</td>
                                    <td align="right" class="rate_pri">Total Amount</td>
                                    <td width="15%" >
                                        <input class="parent_text border-none" type="text" name="total" id="total" readonly/>
                                        <input type="hidden" name="basetotal" id="basetotal"/>
                                    </td>
                                    <td>&nbsp;</td>
                                </tr>
                                </tbody>
                            </table>
                            <input type="hidden" name="rowid" id="rowid" value="0"/>
                        </div>
                        <div class="cont_bt col-lg-5 col-lg-offset-7 col-md-9 col-md-offset-3 col-sm-7 col-sm-offset-5 col-xs-7 col-xs-offset-5">
                            <ul>
                                <li><a href="javascript:nextAccordian(2)">Continue &nbsp;<i class="fa fa-chevron-circle-right"></i></a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-------------------------------Bill of Quantities end------------------------------->
        <!-------------------------------Terms and Condition------------------------------->
		<!-- Terms remove -->
         <div class="panel panel-info">
			<div data-target="#collapseTwo" data-parent="#accordion" data-toggle="collapse" class="panel-heading collapsed panel_heads" id="panelheading-2">
				<h4 class="panel-title accordion-toggle defa_panels">Terms And Conditions</h4>
			</div>
			<div class="panel-collapse collapse" id="collapseTwo" style="height: 0px;">
				<div class="panel-body bgcolr">
					<div class="col-lg-12">
						<div class="table-responsive top-30">
							<table class="table" style=" margin-bottom:0px;" id="termsTable">
								<thead>
								<tr>
									<th>Terms</th>
									<th>Value</th>
									<th>Account</th>
								</tr>
								</thead>
								<tbody class="main"></tbody>
							</table>
							<input type="hidden" name="trowid" id="trowid" value="0"/>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-------------------------------Others Details------------------------------->
		<div class="panel panel-info">
			<div data-target="#collapseThree" data-parent="#accordion" data-toggle="collapse" class="panel-heading collapsed panel_heads" id="panelheading-3">
				<h4 class="panel-title accordion-toggle defa_panels">Other Details</h4>
			</div>
			<div class="panel-collapse collapse" id="collapseThree" style="height: 0px;">
				<div class="panel-body bgcolr">
					<div class="clearfix"></div>
					<div class="col-lg-12">
						<div class="card">
							<ul class="nav nav-tabs">
								<li class="active"><a href="#nar" id="narrationTabLink" onclick="showotherstabs('narration')" aria-controls="naration" role="tab" data-toggle="tab">Narration</a></li>
							</ul>
							<div class="tab-content" id="narration">
								<div class="tab-pane active" id="nar">
									<p>
									<div class="col-lg-12">
										<textarea class="exp-tex" name="Narration" id="Narration"> <?php echo (isset($narration)) ? $narration : 'Enter your Notes';?> </textarea>

									</div>
									</p>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-------------------------------Others Details------------------------------->

</div>
<div class="col-lg-12 savebtn_area">
    <ul>
        <li class="dropdown save_btn float_r"><a onclick="submitForm()" data-toggle="tooltip" class="ripple" title="Submit">Submit</a>
        <li class="cancel_btn float_r"><a href="<?php echo $this->basePath();?>/mms/purchase/" data-toggle="tooltip" class="ripple" title="Go back!">Back</a></li>
    </ul>
</div>
<!-- stock details for desc -->
<!--<div class="modal fade" id="stockPOModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button data-dismiss="modal" aria-hidden="true" class="close"><i class="fa fa-times"></i></button>
                <h4 class="modal-title" style="color:#18439d;">Stock Details</h4>
            </div>
            <div class="modal-body">
                <div class="col-lg-12 commargin_top_20">
                    <div class="table-responsive clear">
                        <table class="table table-hover clear" id="contactTable"">
                        <thead>
                        </thead>
                        <tbody>
                        <tr>
                            <td width="50%">
                                <label class="pop_label">Estimate Qty</label>
                            </td>
                            <td width="50%">
                                <input type="text" id="estimateQty" class="parent_txts newRow"  value="" readonly />
                            </td>
                        </tr>
                        <tr>
                            <td width="50%">
                                <label class="pop_label">Estimate Rate</label>
                            </td>
                            <td width="50%">
                                <input type="text" id="estimateRate" class="parent_txts newRow" value=""  readonly />
                            </td>
                        </tr>
                        <tr>
                            <td width="50%">
                                <label class="pop_label">Available Quantity</label>
                            </td>
                            <td width="50%">
                                <input type="text" id="availableQty" class="parent_txts newRow" value="" readonly />
                            </td>
                        </tr>
                        <tr>
                            <td width="50%">
                                <label class="pop_label">Excess Quantity</label>
                            </td>
                            <td width="50%">
                                <input type="text" id="excessQty" class="parent_txts newRow" value="" readonly />
                            </td>

                        </tr>
                        <tr>
                            <td width="50%">
                                <label class="pop_label">Balance PO</label>
                            </td>
                            <td width="50%">
                                <input type="text" id="balancePO" class="parent_txts newRow" value="" readonly />
                            </td>
                        </tr>
                        <tr>
                            <td width="50%">
                                <label class="pop_label">Total Purchase</label>
                            </td>
                            <td width="50%">
                                <input type="text" id="totalPurchase" class="parent_txts newRow" value="" readonly />
                            </td>
                        </tr>
                        <tr>
                            <td width="50%">
                                <label class="pop_label">Request Quantity</label>
                            </td>
                            <td width="50%">
                                <input type="text" id="requestQty" class="parent_txts newRow" value="" readonly />
                            </td>
                        </tr>
                        <tr>
                            <td width="50%">
                                <label class="pop_label">PO Quantity</label>
                            </td>
                            <td width="50%">
                                <input type="text" id="poQty" class="parent_txts newRow" value="" readonly />
                            </td>
                        </tr>
                        <tr>
                            <td width="50%">
                                <label class="pop_label">Min Quantity</label>
                            </td>
                            <td width="50%">
                                <input type="text" id="minQty" class="parent_txts newRow" value="" readonly />
                            </td>
                        </tr>
                        <tr>
                            <td width="50%">
                                <label class="pop_label">Bill Quantity</label>
                            </td>
                            <td width="50%">
                                <input type="text" id="billQty" class="parent_txts newRow" value="" readonly />
                            </td>
                        </tr>

                        </tbody>
                        </table>
                        <input type="hidden" class="parent_txts" name="" id="" value="" />
                    </div>
                </div>
            </div>
            <div class= "modal-footer clear">
                <div class="col-lg-12 savebtn_area no_border">
                    <ul>
                        <li class="cancel_btn float_r"><a href="javascript:void(0);" data-dismiss="modal" class="ripple">Close</a></li>
                    </ul>
                </div>
                <div class="clear"></div>
            </div>
        </div>
    </div>
</div>-->
<!-------------------------------------------------------------------------------------->
<!------------ Previous Purchase Rate ------------>
    <!--<div class="modal fade" id="preRateModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static">
        <div class="modal-dialog" role="document" style="width:850px !important;">
            <div class="modal-content">
                <div class="modal-header">
                    <button data-dismiss="modal" aria-hidden="true" class="close"><i class="fa fa-times"></i></button>
                    <h4 class="modal-title" style="color:#18439d;">Previous Purchase Rates</h4>
                </div>
                <div class="modal-body">
                    <h4 class="modal-title" style="color:#18439d;">Over All</h4>
                    <div id="orateGrid">
                    </div>

                </div>
                <div class= "modal-footer clear">
                    <div class="col-lg-12 savebtn_area no_border">
                        <ul>
                            <li class="cancel_btn float_r"><a href="javascript:void(0);" data-dismiss="modal" class="ripple">Close</a></li>
                        </ul>
                    </div>
                    <div class="clear"></div>
                </div>
            </div>
        </div>
    </div>-->


<!----------------------------------------------------------------------------------->
   <!-- <div class="modal fade" id="stockWBSModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button data-dismiss="modal" aria-hidden="true" class="close"><i class="fa fa-times"></i></button>
                    <h4 class="modal-title" style="color:#18439d;">Stock Details</h4>
                </div>
                <div class="modal-body">
                    <div class="col-lg-12 commargin_top_20">
                        <div class="table-responsive clear">
                            <table class="table table-hover clear" id="contactTable"">
                            <tbody>
                            <tr>
                                <td width="50%">
                                    <label class="pop_label">Estimate Qty</label>
                                </td>
                                <td width="50%">
                                    <input type="text" id="estimateWbsQty" class="parent_txts newRow"  value="" readonly />
                                </td>
                            </tr>
                            <tr>
                                <td width="50%">
                                    <label class="pop_label">Estimate Rate</label>
                                </td>
                                <td width="50%">
                                    <input type="text" id="estimateWbsRate" class="parent_txts newRow" value=""  readonly />
                                </td>
                            </tr>
                            <tr>
                                <td width="50%">
                                    <label class="pop_label">Available Quantity</label>
                                </td>
                                <td width="50%">
                                    <input type="text" id="availableWbsQty" class="parent_txts newRow" value="" readonly />
                                </td>
                            </tr>
                            <tr>
                                <td width="50%">
                                    <label class="pop_label">Excess Quantity</label>
                                </td>
                                <td width="50%">
                                    <input type="text" id="excessWbsQty" class="parent_txts newRow" value="" readonly />
                                </td>

                            </tr>
                            <tr>
                                <td width="50%">
                                    <label class="pop_label">Balance PO</label>
                                </td>
                                <td width="50%">
                                    <input type="text" id="balanceWbsPO" class="parent_txts newRow" value="" readonly />
                                </td>
                            </tr>
                            <tr>
                                <td width="50%">
                                    <label class="pop_label">Total Purchase</label>
                                </td>
                                <td width="50%">
                                    <input type="text" id="totalWbsPurchase" class="parent_txts newRow" value="" readonly />
                                </td>
                            </tr>
                            <tr>
                                <td width="50%">
                                    <label class="pop_label">Request Quantity</label>
                                </td>
                                <td width="50%">
                                    <input type="text" id="requestWbsQty" class="parent_txts newRow" value="" readonly />
                                </td>
                            </tr>
                            <tr>
                                <td width="50%">
                                    <label class="pop_label">PO Quantity</label>
                                </td>
                                <td width="50%">
                                    <input type="text" id="poWbsQty" class="parent_txts newRow" value="" readonly />
                                </td>
                            </tr>
                            <tr>
                                <td width="50%">
                                    <label class="pop_label">Min Quantity</label>
                                </td>
                                <td width="50%">
                                    <input type="text" id="minWbsQty" class="parent_txts newRow" value="" readonly />
                                </td>
                            </tr>
                            <tr>
                                <td width="50%">
                                    <label class="pop_label">Bill Quantity</label>
                                </td>
                                <td width="50%">
                                    <input type="text" id="billWbsQty" class="parent_txts newRow" value="" readonly />
                                </td>
                            </tr>
                            </tbody>
                            </table>
                            <input type="hidden" class="parent_txts" name="" id="" value="" />
                        </div>
                    </div>
                </div>
                <div class= "modal-footer clear">
                    <div class="col-lg-12 savebtn_area no_border">
                        <ul>
                            <li class="cancel_btn float_r"><a href="javascript:void(0);" data-dismiss="modal" class="ripple">Close</a></li>
                        </ul>
                    </div>
                    <div class="clear"></div>
                </div>
            </div>
        </div>
    </div>-->

<script id="resource-template"  type="text/template" class="hide">
    <tr>
        <td width="25%">
            <input class="parent_text resourceSuggest" type="text" name="desc__" id="desc__" onfocus="checkResourceUsed(this);" />
            <input type="hidden" name="resourceid__" id="resourceid__"/>
        </td>
        <td width="10%">
            <input class="parent_text border-none" type="text" name="unitname__" id="unitname__" readonly/>
            <input type="hidden" name="unitid__" id="unitid__"/>
            <input type="hidden" name="itemid__" id="itemid__"/>
        </td>
        <td width="10%">
            <input class="parent_text border-none" type="text" name="qty__" id="qty__"  readonly />
            <input type="hidden" name="hiddenqty__" id="hiddenqty__" >
        </td>
		<td width="10%">
            <input class="parent_text border-none" type="text" name="actualqty__" id="actualqty__"  readonly />
            <input type="hidden" name="hiddenqty__" id="hiddenqty__" >
        </td>
        <td width="15%"><input class="parent_text border-none" type="text" name="rate__" id="rate__" onkeypress="return isDecimal(event,this)"  onchange="rateChange(this.id)"/></td>
        <td width="10%"><input class="parent_text border-none" type="text" name="qrate__" id="qrate__" onkeypress="return isDecimal(event,this)" readonly/></td>
        <td width="15%"><input class="parent_text border-none" type="text" name="baseamount__" id="baseamount__" readonly/></td>
        <td width="15%"><input class="parent_text border-none" type="text" name="amount__" id="amount__" readonly/></td>

        <td width="10%" align="center" class="action_btns_td">
            <ul class="action_btns">
                <li> <a onclick="deleteRow(this, event);"  id="deleteTr__" style="display:none;"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
                <li> <a href="#" class="mainTr" id="expandTr__" style="display:none;"> <i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="left" data-original-title="Add lines" ></i></a> </li>
            </ul>
        </td>
    </tr>
    <tr style="display:none;" class="subTr">
        <td colspan="9" style="padding:0px !important; ">
			<div class="subDiv" style="display:none;">
                <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;">
                    <div class="card">
                        <ul class="nav nav-tabs">
                            <li class="active"><a class="ripple has-ripple" id="decisionTabLink__" onclick="showtabs('decision',this.id,event)" style="position: relative; overflow: hidden;cursor:pointer;"> Decision<span class="ripple-wrapper animated" style="width: 89px; height: 89px; top: -41.5px; left: 22.9531px;"></span></a></li>
                            <li class=""><a class="ripple has-ripple" id="qualifierTable__" onclick="showtabs('wbs',this.id,event)" style="position: relative; overflow: hidden;cursor:pointer;">Qualifier<span class="ripple-wrapper animated" style="width: 89px; height: 89px; top: -41.5px; left: 22.9531px;"></span></a></li>
                            <li class=""><a class="ripple has-ripple" id="whTable__" onclick="showtabs('qualifier',this.id,event)" style="position: relative; overflow: hidden;cursor:pointer;">Warehouse <span class="ripple-wrapper animated" style="width: 105px; height: 105px; top: -29.5px; left: 16.9531px;"></span></a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-12">
                    <div class="tab-content">
                        <div class="table-responsive topsp">
                            <table class="table" style="margin-bottom:0px;" id="decisionTable__">
                                <thead>
                                <tr>
                                    <th class="worktype-activity">Decision No</th>
                                    <th class="worktype-activity">BalQty</th>
                                    <th>Qty</th>
                                    <th class="iow___requestfields" style="display: none;">&nbsp;</th>
                                </tr>
                                </thead>
                                <tbody class="main"></tbody>
                                <tbody class="total">
                                </tbody>
                                <input type="hidden" name="iow___rowid" id="iow___rowid" value="0"/>
                            </table>
                            <table class="table" style="margin-bottom:0px; display: none;" id="qualifierTable__" onchange="CalculateRate(this.id)">
                            </table>
							<table class="table" style="margin-bottom:0px; display:none;" id="whTable__">
								<thead>
								<tr>
									<th class="worktype-activity">Warehouse Name </th>
									<th class="worktype-activity">Description </th>
									<th class="worktype-activity">Qty </th>
									<th class="" style="display: none;">&nbsp;</th>
								</tr>
								</thead>
								<tbody class="main"></tbody>
								<tbody class="total">
								</tbody>
								<input type="hidden" name="wh___rowid" id="wh___rowid" value="0"/>
							</table>
                        </div>
                    </div>
                </div>
            </div>

        </td>
    </tr>
</script>

<script id="iow-template"  type="text/template" class="hide">
    <tr>
        <td width="20%" class="worktype-activity">
            <input class="parent_text border-none" type="text" name="iow___decisionno_0" id="iow___decisionno_0" readonly/>
            <input type="hidden" name="iow___decisionid_0" id="iow___decisionid_0"/>
            <input type="hidden" name="iow___dectransid_0" id="iow___dectransid_0"/>
            <input type="hidden" name="iow___reqtransid_0" id="iow___reqtransid_0"/>
            <input type="hidden" name="iow___resourceid_0" id="iow___resourceid_0"/>
            <input type="hidden" name="iow___itemid_0" id="iow___itemid_0"/>
        </td>
        <td width="30%"><input class="parent_text border-none" type="text" name="iow___balqty_0" id="iow___balqty_0" readonly/></td>
        <td width="30%">
            <input class="parent_text" type="text" name="iow___qty_0" id="iow___qty_0" onkeypress="return isDecimal(event,this)"  onchange="calcQuantity(this);"/>
            <inpu type="hidden" name="iow__hiddenqty_0" id="iow__hiddenqty_0"/>
        </td>
        <td width="10%" align="center" class="action_btns_td iow___requestfields" style="display: none;">
            <ul class="action_btns">
                <li><a href="#" class="mainTr"> <i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="left" data-original-title="Add lines" ></i></a> </li>
            </ul>
        </td>
    </tr>
    <tr style="display:none;" class="subTr">
        <td colspan="9" style="padding:0px !important; "><div class="subDiv" style="display:none;">
                <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"></div>
                <div class="col-lg-12">
                    <div class="table-responsive topsp">
                        <table class="table" style="margin-bottom:0px;" id="iow___request_0_reqno">
                            <thead>
                            <tr>
                                <th>WBS Name</th>
                                <th>Bal Qty</th>
                                <th>Qty</th>
                            </tr>
                            </thead>
                            <tbody class="main"></tbody>
                            <tbody class="total">
                            </tbody>
                            <input type="hidden" name="iow___request_0_rowid" id="iow___request_0_rowid" value="0"/>
                        </table>
                    </div>
                </div>
            </div>
        </td>
    </tr>

    </script>
<script id="request-template"  type="text/template" class="hide">
    <tr>
        <td width="10%">
            <input class="parent_text border-none" type="text" name="iow___request_0_wbsname__9" id="iow___request_0_wbsname__9" readonly/>
            <input type="hidden" name="iow___request_0_wbsid__9" id="iow___request_0_wbsid__9"/>
            <input type="hidden" name="iow___request_0_dectransid__9" id="iow___request_0_dectransid__9"/>
            <input type="hidden" name="iow___request_0_decatransid__9" id="iow___request_0_decatransid__9"/>
            <input type="hidden" name="iow___request_0_reqtransid__9" id="iow___request_0_reqtransid__9"/>
            <input type="hidden" name="iow___request_0_reqahtransid__9" id="iow___request_0_reqahtransid__9"/>
            <input type="hidden" name="iow___request_0_resourceid__9" id="iow___request_0_resourceid__9"/>
            <input type="hidden" name="iow___request_0_itemid__9" id="iow___request_0_itemid__9"/>
        </td>
        <td width="5%"><input class="parent_text border-none" type="text" name="iow___request_0_balqty__9" id="iow___request_0_balqty__9" readonly/></td>
        <td width="5%">
            <input class="parent_text" type="text" name="iow___request_0_qty__9" id="iow___request_0_qty__9"  onkeypress="return isDecimal(event,this)" onchange="calcRequestQuantity(this);"/>
            <input type="hidden" name="iow___request_0_hiddenqty__9" id="iow___request_0_hiddenqty__9"/>
        </td>
        <!--<td width="1%" align="center" class="action_btns_td iow_1_requestfields">
            <ul class="action_btns">
                <li><a  onclick="stockWBSDetails(this);" class="" id="iow___request_0_expandWbs__9"><i class="fa fa-question-circle" data-toggle="modal" data-target="#stockWBSModal" data-placement="left"></i></a></li>
            </ul>
        </td>-->
    </tr>
</script>
<script id="resspec-template" type="text/template">
    <tr>
        <td width="100%">
            <textarea class="exp-tex"  name="resspec__" id="resspec__" class="parent_txts newRow"  value=""/>

        </td>
    </tr>
</script>
<script id="wbs-template"  type="text/template" class="hide">
    <tr>
        <td width="20%" class="worktype-activity">
            <input class="parent_text border-none" type="text" name="wbs___wbsname_0" id="wbs___wbsname_0" readonly/>
            <input type="hidden" name="wbs___wbsid_0" id="wbs___wbsid_0"/>
        </td>
        <td width="30%">
            <input class="parent_text" type="text" name="wbs___qty_0" id="wbs___qty_0" onkeypress="return isDecimal(event,this)" onchange="calcWbsQuantity(this);"/>
            <input type="hidden" name="iow__hiddenqty_0" id="iow__hiddenqty_0"/>
        </td>
        <td width="10%" align="center" class="action_btns_td">
            <ul class="action_btns">
                <li> <a onclick="deleteRow(this, event);"  id="deleteWbsTr__" style="display:none;"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
            </ul>
        </td>
    </tr>
</script>
<script id="terms-template"  type="text/template" class="hide">
	<tr>
		<td width="33%">
			<input class="parent_text resourceSuggest" type="text" name="terms__" id="terms__" onfocus="checkTermsUsed(this);"/>
			<input type="hidden" name="termsid__" id="termsid__"  value=""/>
			<input type="hidden"  name="isvalue__" id="isvalue__"/>
			<input type="hidden"  name="isaccount__" id="isaccount__"/>
		</td>
		<td width="33%"><input class="parent_text border-none" type="text" name="value__" id="value__" onkeypress="return isNumberKey(event,this)" onchange="valueTotal(this);"/></td>
		<td width="33%"><select data-placeholder="" class="form-control single_dropdown lbl_box sortoption tbl_input changeVal" name="account__" id="account__">
		<td width="15%" align="center" class="action_btns_td">
			<ul class="action_btns">
				<li> <a  id="termsdeleteTr__" style="display:none;"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
			</ul>
		</td>
	</tr>
</script>

<script id="otherterms-template"  type="text/template" class="hide">
    <tr>
        <td width="15%"><input class="parent_text" type="text" name="termTitle__" id="termTitle__" maxlength="155" onchange="addNewTermRow(this)"/></td>
        <td width="15%"><textarea class="parent_texts" name="termDesc__" id="termDesc__"></textarea></td>
    </tr>
</script>

<script type="text/javascript">
var arr_resources = <?php echo (isset($arr_resources)) ? json_encode($arr_resources) : '[]';?>;

var tmp_arr_resources = arr_resources;

var arr_requestResources = <?php echo (isset($arr_requestResources)) ? json_encode($arr_requestResources) : '[]';?>;
var arr_resource_iows = <?php echo (isset($arr_resource_iows)) ? json_encode($arr_resource_iows) : '[]';?>;
var arr_resource_iow_requests = <?php echo (isset($arr_resource_iow_requests)) ? json_encode($arr_resource_iow_requests) : '[]';?>;

var materiallists = <?php echo (isset($materiallists)) ? json_encode($materiallists) : '[]';?>;
var materialPrice = materiallists;
var materialSupply = materiallists;
var materialaAdv = materiallists;

var arr_otherTerms = <?php echo (isset($arr_otherTerms)) ? json_encode($arr_otherTerms) : '[]';?>;
var arr_materials = <?php echo (isset($arr_materials)) ? json_encode($arr_materials) : '[]';?>;
var arr_exc_materials = <?php echo (isset($arr_exc_materials)) ? json_encode($arr_exc_materials) : '[]';?>;
var arr_adv_materials = <?php echo (isset($arr_adv_materials)) ? json_encode($arr_adv_materials) : '[]';?>;

var arr_terms=<?php echo (isset($arr_terms)) ? json_encode($arr_terms) : '[]';?>;
var tmp_arr_terms=arr_terms;
var arr_edit_terms=<?php echo (isset($arr_edit_terms)) ? json_encode($arr_edit_terms) : '[]';?>;
var arr_qual_list=<?php echo (isset($arr_qual_list)) ? json_encode($arr_qual_list) : '[]';?>;
var WorkType = $('#WorkType').val();
var OrderType = $('#OrderType').val();

var qualiferHTML = '<?php echo (isset($qualHtml)) ? preg_replace('~>\s+<~', '><',$qualHtml) : '';?>';
$(function () {
    var $rowid = $('#rowid');
    var template = $('#resource-template').html();
    var iowtemplate = $('#iow-template').html();
    var requesttemplate = $('#request-template').html();
    var termstemplate = $('#terms-template').html();
    var resspectemplate=$('#resspec-template').html();
    var rowid = 0;
    var $tbody = $('#workorderTable').find('> tbody.main');
    if(arr_requestResources.length != 0) {
        $.each(arr_requestResources, function(i, o) {
            rowid += 1;
            $tbody.append(template.replace(/__/g, '_' + rowid));
            $('#desc_' + rowid).val(o.Desc).addClass('border-none').prop('disabled', true);
            $('#resourceid_' + rowid).val(o.ResourceId);
            $('#itemid_' + rowid).val(o.ItemId);
            $('#unitname_' + rowid).val(o.UnitName);
            $('#unitid_' + rowid).val(o.UnitId);
            $('#qty_' + rowid).val(o.Qty);
            $('#rate_' + rowid).val(o.Rate);
            $('#qrate_' + rowid).val(o.QRate);
            $('#baseamount_' + rowid).val(o.BaseAmount);
            $('#amount_' + rowid).val(o.Amount);
            $('#hiddenqty_' + rowid).val(o.HiddenQty);
            $('#expandTr_' + rowid).show();
            $('#deleteTr_' + rowid).show();
            $('#expandSt_' + rowid).show();
            $('#expandRt_' + rowid).show();
            $('#reqspeTable_' + rowid).append(resspectemplate.replace(/__/g, '_' + rowid));
            $('#resspec_' + rowid).val(o.ResSpec);

            var findRes = arr_resource_iows.filter(function(obj) {
                return (obj.ResourceId === o.ResourceId) && (obj.ItemId === o.ItemId && (obj.BalQty > 0 || obj.Qty > 0));
            });

            if(findRes.length > 0) {

                $.each(arr_resource_iows, function (j, l) {
                    if ((l.ResourceId != o.ResourceId || l.ItemId != o.ItemId)) {
                        return;
                    }

//|| (l.ProjectIOWId != o.DescId && OrderType == 'work' && WorkType == 'iow')
                    var iowrowid = parseInt($('#iow_' + rowid + '_rowid').val()) + 1;
                    $('#decisionTable_' + rowid).find('> tbody.main').append(iowtemplate.replace(/__/g, '_' + rowid).replace(/_0/g, '_' + iowrowid));
                    $('#iow_' + rowid + '_rowid').val(iowrowid);
                    /////////////////
                    $('#wbsTable_' + rowid).hide();
                    $('#decisionTable_' + rowid).show();
                    $('#decisionTabLink_' + rowid).show();
                    $('#wbsTabLink_' + rowid).hide();
                    if (<?php echo (isset($poRegId)) ? $poRegId : 0;?> >0)
                    {
                        var RId = o.ResourceId;
                        var ItId = o.ItemId;
                        var poRegId =<?php echo (isset($poRegId)) ? $poRegId : 0;?>;

                        $.ajax({
                            url: getBaseURL() + 'mms/purchase/',
                            type: "post",
                            data: "ResourceId=" + RId + "&Type=getqualdetails&ItemId=" + ItId + "&poId=" + poRegId + "",
                            async: false,
                            success: function (data, textStatus, jqXHR) {
                                if (jqXHR.status == 200) {
                                    data = JSON.parse(data);
                                    $('#qualifierTable_' + rowid).html(data.replace(/__1/g, '_' + rowid));
                                }
                                $('.loading_area').hide();
                            }, error: function (jqXHR, textStatus, errorThrown) {
                                $('.loading_area').hide();
                            }
                        });
                    }
                    else
                    {
                        $('#qualifierTable_' + rowid).html(qualiferHTML.replace(/__1/g, '_' + rowid));
                        //$('#resspec-template_' + rowid).append(resspectemplate.replace(/__1/g, '_' + rowid));
                        // $('#resspec-template_' + rowid).find('> tbody.main').append(resspectemplate.replace(/__/g, '_' + rowid));
                    }
                    ////////////////


                    $('#iow_' + rowid + '_decisionid_' + iowrowid).val(l.DecisionId);
                    $('#iow_' + rowid + '_dectransid_' + iowrowid).val(l.DecTransId);
                    $('#iow_' + rowid + '_reqtransid_' + iowrowid).val(l.ReqTransId);
                    $('#iow_' + rowid + '_resourceid_' + iowrowid).val(l.ResourceId);
                    $('#iow_' + rowid + '_itemid_' + iowrowid).val(l.ItemId);
                    $('#iow_' + rowid + '_decisionno_' + iowrowid).val(l.DecisionNo);
                    $('#iow_' + rowid + '_balqty_' + iowrowid).val(l.BalQty);
                    $('#iow_' + rowid + '_qty_' + iowrowid).val(l.Qty);
                    $('#iow_' + rowid + '_hiddenqty_' + iowrowid).val(l.HiddenQty);

                    if (WorkType == 'activity') {
                        $('#iow_' + rowid + '_agtno_' + iowrowid).val(l.SerialNo);
                        $('#iow_' + rowid + '_spec_' + iowrowid).val(l.Specification);
                    } else if (WorkType == 'iow') {
                        $('.worktype-activity').remove();
                    }
                    $.each(arr_resource_iow_requests, function (k, r) {
                        if (l.DecisionId != r.DecisionId || l.ResourceId != r.ResourceId || l.ItemId != r.ItemId) {
                            return;
                        }

                        $('#iow_' + rowid + '_qty_' + iowrowid).addClass('border-none').prop('readonly', true);
                        $('.iow_' + rowid + '_requestfields').show();
                        var requestrowid = parseInt($('#iow_' + rowid + '_request_' + iowrowid + '_rowid').val()) + 1;
                        $('#iow_' + rowid + '_request_' + iowrowid + '_reqno').find('> tbody.main').append(requesttemplate
                            .replace(/__9/g, '_' + requestrowid)
                            .replace(/_0/g, '_' + iowrowid)
                            .replace(/__/g, '_' + rowid));
                        $('#iow_' + rowid + '_request_' + iowrowid + '_rowid').val(requestrowid);

                        $('#iow_' + rowid + '_request_' + iowrowid + '_wbsname_' + requestrowid).val(r.WBSName);
                        $('#iow_' + rowid + '_request_' + iowrowid + '_wbsid_' + requestrowid).val(r.WBSId);
                        $('#iow_' + rowid + '_request_' + iowrowid + '_dectransid_' + requestrowid).val(r.DecTransId);
                        $('#iow_' + rowid + '_request_' + iowrowid + '_decatransid_' + requestrowid).val(r.DecATransId);
                        $('#iow_' + rowid + '_request_' + iowrowid + '_reqtransid_' + requestrowid).val(r.ReqTransId);
                        $('#iow_' + rowid + '_request_' + iowrowid + '_reqahtransid_' + requestrowid).val(r.ReqAHTransId);
                        $('#iow_' + rowid + '_request_' + iowrowid + '_resourceid_' + requestrowid).val(r.ResourceId);
                        $('#iow_' + rowid + '_request_' + iowrowid + '_itemid_' + requestrowid).val(r.ItemId);
                        $('#iow_' + rowid + '_request_' + iowrowid + '_balqty_' + requestrowid).val(sanitizeNumber((r.BalQty)));
                        $('#iow_' + rowid + '_request_' + iowrowid + '_qty_' + requestrowid).val(sanitizeNumber(r.Qty));
                        $('#iow_' + rowid + '_request_' + iowrowid + '_hiddenqty_' + requestrowid).val(sanitizeNumber(r.HiddenQty));
                        $('#iow_' + rowid + '_request_' + iowrowid + '_expandWbs_' + requestrowid).show();
                    });
                    CalculateRate('#qualifierTable_' + rowid);
                });
            }
            /////
            else
            {
                $('#wbsTable_' + rowid).show();
                $('#decisionTable_' + rowid).hide();
                $('#decisionTabLink_' + rowid).hide();
                $('#wbsTabLink_' + rowid).show();

                //Without Request Decision Wbs Populate
                var ResId = o.ResourceId;
                var IteId = o.ItemId;
                var PoRegId = <?php echo (isset($poRegId)) ? $poRegId : 0;?>;
                var CcId = <?php echo (isset($costcenter)) ? $costcenter['CostCentreId'] : '';?>;
                $.ajax({
                    url: getBaseURL() + 'mms/purchase/',
                    type: "post",
                    data: "ResourceId=" + ResId + "&Type=wbsEdit&ItemId=" + IteId + "&PORegId=" + PoRegId + "&CCId=" + CcId + "",
                    async: false,
                    success: function (data, textStatus, jqXHR) {
                        if (jqXHR.status == 200) {
                            data = JSON.parse(data);
                            var wbstemplate = $('#wbs-template').html();
                            $.each(data.wbs, function (i, l) {
                                var iowrowid = parseInt($('#wbs_' + rowid + '_rowid').val()) + 1;
                                $('#wbsTable_' + rowid).find('> tbody.main').append(wbstemplate.replace(/__/g, '_' + rowid).replace(/_0/g, '_' + iowrowid));
                                $('#wbsTable_' + rowid).show();
                                $('#decisionTable_' + rowid).hide();
                                $('#decisionTabLink_' + rowid).hide();
                                $('#wbsTabLink_' + rowid).show();
                                $('#wbs_' + rowid + '_rowid').val(iowrowid);
                                $('#wbs_' + rowid + '_wbsid_' + iowrowid).val(l.WBSId);
                                $('#wbs_' + rowid + '_wbsname_' + iowrowid).val(l.WbsName);
                                $('#wbs_' + rowid + '_qty_' + iowrowid).val(l.Qty);
                            });
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        $('.loading_area').hide();
                    }

                });


                if (<?php echo (isset($poRegId)) ? $poRegId : 0;?> >0)
                {
                    var RId = o.ResourceId;
                    var ItId = o.ItemId;
                    var poRegId =<?php echo (isset($poRegId)) ? $poRegId : 0;?>;

                    $.ajax({
                        url: getBaseURL() + 'mms/purchase/orderentry',
                        type: "post",
                        data: "ResourceId=" + RId + "&Type=getqualdetails&ItemId=" + ItId + "&poId=" + poRegId + "",
                        async: false,
                        success: function (data, textStatus, jqXHR) {
                            if (jqXHR.status == 200) {
                                data = JSON.parse(data);
                                $('#qualifierTable_' + rowid).html(data.replace(/__1/g, '_' + rowid));
                            }
                            $('.loading_area').hide();
                        }, error: function (jqXHR, textStatus, errorThrown) {
                            $('.loading_area').hide();
                        }
                    });
                }
                else
                {
                    $('#qualifierTable_' + rowid).html(qualiferHTML.replace(/__1/g, '_' + rowid));
                    //$('#resspec-template_' + rowid).append(resspectemplate.replace(/__1/g, '_' + rowid));
                    // $('#resspec-template_' + rowid).find('> tbody.main').append(resspectemplate.replace(/__/g, '_' + rowid));
                }

            }
            /////
        });
    }
    rowid += 1;
    $tbody.append(template.replace(/__/g, '_' + rowid));
    $rowid.val(rowid);

    bindResourceAutocomplete();
    //terms & condition start
    // other terms
    var $termrowid = $('#termrowid');
    var template = $('#otherterms-template').html();
    var termrowid = 0;
    var $tbody = $('#otherTermsTable').find('> tbody');
    if(arr_otherTerms.length != 0) {
        $.each(arr_otherTerms, function(i, o) {
            termrowid += 1;
            $tbody.append(template.replace(/__/g, '_' + termrowid));

            $('#termTitle_' + termrowid).val(o.Title);
            $('#termDesc_' + termrowid).val(o.Desc);
            $('#deleteTermTr_' + termrowid).show();
        });
    }
    termrowid += 1;
    $tbody.append(template.replace(/__/g, '_' + termrowid));
    $termrowid.val(termrowid);

    // material
    var $materialrowid = $('#materialrowid');
    var template = $('#material-template').html();
    var materialrowid = 0;
    var $tbody = $('#materialTable').find('> tbody');
    if(arr_materials.length != 0) {
        $.each(arr_materials, function(i, o) {
            materialrowid += 1;
            $tbody.append(template.replace(/__/g, '_' + materialrowid));

//                $('#materialName_' + materialrowid).val(o.Title);
//                $('#materialId_' + materialrowid).val(o.Desc);
//                $('#materialUnit_' + materialrowid).val(o.Desc);
//                $('#materialRate_' + materialrowid).val(o.Desc);
//                $('#escalationper_' + materialrowid).val(o.Desc);
//                $('#materialbase_' + materialrowid).val(o.Desc);
//                $('#materialnewRate_' + materialrowid).val(o.Desc);
            $('#materialDeleteTr_' + materialrowid).show();
        });
    }
    materialrowid += 1;
    $tbody.append(template.replace(/__/g, '_' + materialrowid));
    $materialrowid.val(materialrowid);
    bindMaterialBaseAutoComplete();

    // exc material
    var $materialExcrowid = $('#materialExcrowid');
    var template = $('#materialexc-template').html();
    var materialExcrowid = 0;
    var $tbody = $('#materialExcTable').find('> tbody');
    if(arr_exc_materials.length != 0) {
        $.each(arr_exc_materials, function(i, o) {
            materialExcrowid += 1;
            $tbody.append(template.replace(/__/g, '_' + materialExcrowid));

//                $('#materialExcName_' + materialExcrowid).val(o.Title);
//                $('#materialExcId_' + materialExcrowid).val(o.Desc);
//                $('#materialExcUnit_' + materialExcrowid).val(o.Desc);
//                $('#materialExcRate_' + materialExcrowid).val(o.Desc);
//                $('#materialExcType_' + materialExcrowid).val(o.Desc);
            $('#materialExcDeleteTr_' + materialExcrowid).show();
        });
    }
    materialExcrowid += 1;
    $tbody.append(template.replace(/__/g, '_' + materialExcrowid));
    $materialExcrowid.val(materialExcrowid);
    bindMaterialExcAutoComplete();

    // adv material
    var $materialAdvrowid = $('#materialAdvrowid');
    var template = $('#materialadv-template').html();
    var materialAdvrowid = 0;
    var $tbody = $('#materialAdvTable').find('> tbody');
    if(arr_adv_materials.length != 0) {
        $.each(arr_adv_materials, function(i, o) {
            materialAdvrowid += 1;
            $tbody.append(template.replace(/__/g, '_' + materialAdvrowid));

//                $('#materialExcName_' + materialAdvrowid).val(o.Title);
//                $('#materialExcId_' + materialAdvrowid).val(o.Desc);
//                $('#materialExcUnit_' + materialAdvrowid).val(o.Desc);
//                $('#materialExcRate_' + materialAdvrowid).val(o.Desc);
//                $('#materialExcType_' + materialAdvrowid).val(o.Desc);
            $('#materialAdvDeleteTr_' + materialAdvrowid).show();
        });
    }
    materialAdvrowid += 1;
    $tbody.append(template.replace(/__/g, '_' + materialAdvrowid));
    $materialAdvrowid.val(materialAdvrowid);
    bindMaterialAdvAutoComplete();

    // tech title
    var $techrowid = $('#techrowid');
    var template = $('#techtitle-template').html();
    var techrowid = 0;
    var $tbody = $('#techTitleTable').find('> tbody');
    if(arr_adv_materials.length != 0) {
        $.each(arr_adv_materials, function(i, o) {
            techrowid += 1;
            $tbody.append(template.replace(/__/g, '_' + techrowid));

//                $('#materialExcName_' + techrowid).val(o.Title);
//                $('#materialExcId_' + techrowid).val(o.Desc);
//                $('#materialExcUnit_' + techrowid).val(o.Desc);
//                $('#materialExcRate_' + techrowid).val(o.Desc);
//                $('#materialExcType_' + techrowid).val(o.Desc);
            $('#deleteTechTr_' + techrowid).show();
        });
    }
    techrowid += 1;
    $tbody.append(template.replace(/__/g, '_' + techrowid));
    $techrowid.val(techrowid);

    //terms &condition end
    var $trowid = $('#trowid');
    var template = $('#terms-template').html();
    var trowid = 0;
    var $tbody = $('#termsTable').find('> tbody');

    if(arr_edit_terms.length != 0) {

        $.each(arr_edit_terms, function(i, o) {
            trowid += 1;
            $tbody.append(termstemplate.replace(/__/g, '_' + trowid));

            $('#slno_' + trowid).val(o.SlNo).addClass('border-none').prop('disabled', true);
            $('#termsid_' + trowid).val(o.data);
            $('#terms_' + trowid).val(o.value);
            $('#per_' + trowid).val(o.Per);
            $('#value_' + trowid).val(o.Val);
            $('#period_' + trowid).val(o.Period);
            $('#date_' + trowid).val(o.Dte);
            $('#string_' + trowid).val(o.Strg);
            $('#isper_' + trowid).val(o.IsPer);
            $('#isvalue_' + trowid).val(o.IsValue);
            $('#isperiod_' + trowid).val(o.IsPeriod);
            $('#istdate_' + trowid).val(o.IsTDate);
            $('#iststring_' + trowid).val(o.IsTString);
            $('#includegross_' + trowid).val(o.IncludeGross);
            $('#termsdeleteTr_' + trowid).show();
        });
    }
    trowid += 1;
    $tbody.append(template.replace(/__/g, '_' + trowid));
    $trowid.val(trowid);

    $('.content_wrapper').on('click','.mainTr',function(e){
        e.preventDefault();
        if(!$(this).closest("tr").next(".subTr").is(":visible")){
            $(this).closest("tr").next(".subTr").show();
            $(this).closest("tr").next(".subTr").find(".subDiv").slideDown("slow");
            $(this).find("i").addClass("tform");
        }
        else{
            $(this).closest("tr").next(".subTr").find(".subDiv").slideUp("slow");
            $(this).closest("tr").next(".subTr").slideUp("slow");
            $(this).find("i").removeClass("tform");
        }
    });

    nextAccordian(1);
    calcTotal();
});

function submitForm() {
    /* if(!validateLength($('#PODate')))
     return false;

     if(!validateLength($('#RefDate')))
     return false;


     if(!validateLength($('#CCWONo')))
     return false;

     if(!validateLength($('#CompWONo')))
     return false;

     if(!validateLength($('#RefNo')))
     return false;

     if($('#formWrapper .error').length != 0) {
     alert('Kindly notice the errors!');
     return false;
     }*/
    if($('#purchase_type').val() == '') {
        alert('Please select Purchase Type');
        return false;
    }
    if($('#account_type').val() == '') {
        alert('Please select Account Type');
        return false;
    }
    if($('#currency').val() == '') {
        alert('Please select Account Type');
        return false;
    }
    var rowCountqty= parseInt($('#rowid').val()-1);

    if(rowCountqty == 0)
    {
        alert('Add any resource!');
        return false;
    }
    for(i=1;i<=rowCountqty;i++) {
        if ($('#qty_' + i).val() == "" || $('#qty_' + i).val() == 0) {
            alert('Zero Quantity Exists!');
            return false;
        }
    }

    for(i=1;i<=rowCountqty;i++) {
        if ($('#rate_' + i).val() == "" || $('#rate_' + i).val() == 0) {
            alert('Zero Rate Exists!');
            return false;
        }
    }

    $('#valuefrom').attr("disabled", false);
    $('#formWrapper').submit();
}

function validateLength($input) {
    if($.trim($input.val()).length == 0) {
        showError($input, 'required');
        return false;
    }

    removeError($input);
    return true;
}

function bindTermsAutocomplete() {
    // bind resource autocomplete
    $('#termsTable .resourceSuggest').autocomplete({
        lookup: tmp_arr_terms,
        lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
            if (queryLowerCase == '*') {
                return suggestion.value;
            } else {
                console.log(suggestion.data);
                var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                return re.test(suggestion.value);
            }
        }, onSelect: function (suggestion) {
            if (suggestion) {

                var $this = $(this);
                var rowid = $this[0].id.split('_')[1];
                $this.prop('readonly', true).addClass('border-none');
                $('#termsid_' + rowid).val(suggestion.data);
                $('#slno_' + rowid).val(suggestion.SlNo).attr("readonly",true);
                $('#terms_' + rowid).val(suggestion.value);
                $('#per_' + rowid).val(suggestion.Per);
                $('#value_' + rowid).val(suggestion.Val);
                $('#period_' + rowid).val(suggestion.Period);
                $('#date_' + rowid).val(suggestion.Dte);
                $('#string_' + rowid).val(suggestion.Strg);
                $('#isper_' + rowid).val(suggestion.IsPer);
                $('#isvalue_' + rowid).val(suggestion.IsValue);
                $('#isperiod_' + rowid).val(suggestion.IsPeriod);
                $('#istdate_' + rowid).val(suggestion.IsTDate);
                $('#iststring_' + rowid).val(suggestion.IsTString);
                $('#includegross_' + rowid).val(suggestion.IncludeGross);
                $('#termsdeleteTr_' + rowid).show();
                if(parseInt($('#isper_' + rowid).val())==0){$('#per_' + rowid).attr("readonly",true);}
                if(parseInt($('#isvalue_' + rowid).val())==0) {$('#value_' + rowid).attr("readonly",true);}
                if(parseInt($('#isperiod_' + rowid).val())==0) {$('#period_' + rowid).attr("readonly",true);}
                if(parseInt($('#istdate_' + rowid).val())==0) {$('#date_' + rowid).attr("readonly",true);}
                if(parseInt($('#iststring_' + rowid).val())==0) {$('#string_' + rowid).attr("readonly",true);}
                addNewTermsRow($this);
            }
        }, onSearchStart: function (suggestion) {
            //var rowid = $(this)[0].id.split('_')[1];
            ////$('#terms_' + rowid).val('');
        }, onSearchComplete: function (query, suggestions) {
            if(!suggestions.length) {
               // var rowid = $(this)[0].id.split('_')[1];
               // $('#terms_' + rowid).val('');
            }
        }
    });
}

//function bindResourceDecisionTrans(x) {
//    var rowid = $(x)[0].id.split('_')[1];
//    //var $iowrowid = $('#iow_' + rowid + '_rowid');
//    //var descId = $('#iow_' + rowid + '_decisionid_' + iowrowid).val();
//    //var iowrowid = parseInt($('#iow_'+rowid+'_rowid').val()) + 1;
//    var resid=$('#resourceid_'+rowid).val();
//    var itemid=$('#itemid_'+rowid).val();
//    var data = {};
//    var ccid=<?php //echo (isset($costcenter)) ? $costcenter['CostCentreId'] : '';?>//;
//
//
//    data.Type='getNewDecisionTrans';
//    data.ResourceId=resid;
//    data.ItemId=itemid;
//    data.CostCentreId=ccid;
//    $('.loading_area').show();
//    $.ajax({
//        url: getBaseURL() + 'mms/purchase/order-entry',
//        type: "post",
//        data: data,
//        async: false,
//        success: function (data, textStatus, jqXHR) {
//            if(jqXHR.status == 200) {
//                data = JSON.parse(data);
//                var iowtemplate = $('#iow-template').html();
//                var resspectemplate=$('#resspec-template').html();
//                $.each(data, function (i,l) {
//                    var iowrowid = parseInt($('#iow_'+rowid+'_rowid').val()) + 1;
//                    $('#decisionTable_' + rowid).find('> tbody.main').append(iowtemplate.replace(/__/g, '_' + rowid).replace(/_0/g, '_' + iowrowid));
//                    $('#iow_'+rowid+'_rowid').val(iowrowid);
//                    $('#iow_'+ rowid +'_decisionid_'+ iowrowid).val(l.DecisionId);
//                    $('#iow_'+ rowid +'_dectransid_'+ iowrowid).val(l.DecTransId);
//                    $('#iow_'+ rowid +'_reqtransid_'+ iowrowid).val(l.ReqTransId);
//                    $('#iow_'+ rowid +'_resourceid_'+ iowrowid).val(l.ResourceId);
//                    $('#iow_'+ rowid +'_itemid_'+ iowrowid).val(l.ItemId);
//                    $('#iow_' + rowid + '_decisionno_' + iowrowid).val(l.DecisionNo);
//                    $('#iow_' + rowid + '_balqty_' + iowrowid).val(l.BalQty);
//                    $('#iow_' + rowid + '_qty_' + iowrowid).val(l.Qty);
//                    bindResourceDecisionAnalTrans(x);
//
//                });
//            }
//            $('.loading_area').hide();
//        }, error: function (jqXHR, textStatus, errorThrown) {
//            $('.loading_area').hide();
//        }
//    });
//
//}

function bindResourceDecisionTrans(x) {
    var rowid = $(x)[0].id.split('_')[1];
    //var $iowrowid = $('#iow_' + rowid + '_rowid');
    //var descId = $('#iow_' + rowid + '_decisionid_' + iowrowid).val();
    //var iowrowid = parseInt($('#iow_'+rowid+'_rowid').val()) + 1;
    var resid=$('#resourceid_'+rowid).val();
    var itemid=$('#itemid_'+rowid).val();

    var ccid=<?php echo (isset($costcenter)) ? $costcenter['CostCentreId'] : '';?>;


    $('.loading_area').show();
    $.ajax({
        url: getBaseURL() + 'mms/purchase/',
        type: "post",
        data: "CostCentreId=" + ccid +"&Type=wbs&ResourceId=" + resid +"&ItemId=" + itemid ,
        async: false,
        success: function (data, textStatus, jqXHR) {
            if(jqXHR.status == 200) {
                data = JSON.parse(data);

                if((data.dec).length != 0) {
                    var iowtemplate = $('#iow-template').html();
                    var resspectemplate = $('#resspec-template').html();
                    $.each(data.dec, function (i, l) {
                        var iowrowid = parseInt($('#iow_' + rowid + '_rowid').val()) + 1;
                        $('#decisionTable_' + rowid).find('> tbody.main').append(iowtemplate.replace(/__/g, '_' + rowid).replace(/_0/g, '_' + iowrowid));
                        $('#wbsTable_'+rowid).hide();
                        $('#decisionTable_'+rowid).show();
                        $('#decisionTabLink_'+rowid).show();
                        $('#wbsTabLink_'+rowid).hide();
                        $('#iow_' + rowid + '_rowid').val(iowrowid);
                        $('#iow_' + rowid + '_decisionid_' + iowrowid).val(l.DecisionId);
                        $('#iow_' + rowid + '_dectransid_' + iowrowid).val(l.DecTransId);
                        $('#iow_' + rowid + '_reqtransid_' + iowrowid).val(l.ReqTransId);
                        $('#iow_' + rowid + '_resourceid_' + iowrowid).val(l.ResourceId);
                        $('#iow_' + rowid + '_itemid_' + iowrowid).val(l.ItemId);
                        $('#iow_' + rowid + '_decisionno_' + iowrowid).val(l.DecisionNo);
                        $('#iow_' + rowid + '_balqty_' + iowrowid).val(l.BalQty);
                        $('#iow_' + rowid + '_qty_' + iowrowid).val(l.Qty);
                        bindResourceDecisionAnalTrans(x);

                    });
                }
                else
                {
                    if((data.wbs).length != 0)
                    {
                      var wbstemplate =  $('#wbs-template').html();

                        $.each(data.wbs, function (i, l) {
                            var iowrowid = parseInt($('#wbs_' + rowid + '_rowid').val()) + 1;
                            $('#wbsTable_' + rowid).find('> tbody.main').append(wbstemplate.replace(/__/g, '_' + rowid).replace(/_0/g, '_' + iowrowid));
                            $('#wbsTable_'+rowid).show();
                            $('#decisionTable_'+rowid).hide();
                            $('#decisionTabLink_'+rowid).hide();
                            $('#wbsTabLink_'+rowid).show();
                            $('#wbs_' + rowid + '_rowid').val(iowrowid);
                            $('#wbs_' + rowid + '_wbsid_' + iowrowid).val(l.WBSId);
                            $('#wbs_' + rowid + '_wbsname_' + iowrowid).val(l.WbsName);
                            $('#wbs_' + rowid + '_qty_' + iowrowid).val(l.Qty);
                        });

                    }
                }
            }
            $('.loading_area').hide();
        }, error: function (jqXHR, textStatus, errorThrown) {
            $('.loading_area').hide();
        }
    });

}


function bindResourceDecisionAnalTrans(x) {
    var rowid = $(x)[0].id.split('_')[1];
    var iowrowid = $('#iow_' + rowid + '_rowid').val();
    var decid=$('#iow_' + rowid + '_decisionid_' + iowrowid).val();
    var dectransid=$('#iow_' + rowid + '_dectransid_' + iowrowid).val();
    var data = {};
    data.Type='getNewDecAnalTrans';
    data.DecisionId=decid;
    data.DecTransId=dectransid;
    $('.loading_area').show();
    $.ajax({
        url: getBaseURL() + 'mms/purchase/order-entry',
        type: "post",
        data: data,
        async: false,
        success: function (data, textStatus, jqXHR) {
            if(jqXHR.status == 200) {
                data = JSON.parse(data);
                var requesttemplate = $('#request-template').html();
                $.each(data, function (i,l) {
                    $('#iow_' + rowid + '_qty_' + iowrowid).addClass('border-none').prop('readonly', true);
                    $('.iow_' + rowid + '_requestfields').show();
                    var requestrowid = parseInt($('#iow_' + rowid + '_request_' + iowrowid + '_rowid').val()) + 1;
                    $('#iow_' + rowid + '_request_' + iowrowid + '_reqno').find('> tbody.main').append(requesttemplate
                        .replace(/__9/g, '_' + requestrowid)
                        .replace(/_0/g, '_' + iowrowid)
                        .replace(/__/g, '_' + rowid));
                    $('#iow_' + rowid + '_request_' + iowrowid + '_rowid').val(requestrowid);

                    $('#iow_' + rowid + '_request_' + iowrowid + '_wbsname_' + requestrowid).val(l.WBSName);
                    $('#iow_' + rowid + '_request_' + iowrowid + '_wbsid_' + requestrowid).val(l.WBSId);
                    $('#iow_' + rowid + '_request_' + iowrowid + '_dectransid_' + requestrowid).val(l.DecTransId);
                    $('#iow_' + rowid + '_request_' + iowrowid + '_decatransid_' + requestrowid).val(l.DecATransId);
                    $('#iow_' + rowid + '_request_' + iowrowid + '_reqtransid_' + requestrowid).val(l.ReqTransId);
                    $('#iow_' + rowid + '_request_' + iowrowid + '_reqahtransid_' + requestrowid).val(l.ReqAHTransId);
                    $('#iow_' + rowid + '_request_' + iowrowid + '_resourceid_' + requestrowid).val(l.ResourceId);
                    $('#iow_' + rowid + '_request_' + iowrowid + '_itemid_' + requestrowid).val(l.ItemId);
                    $('#iow_' + rowid + '_request_' + iowrowid + '_balqty_' + requestrowid).val(sanitizeNumber((l.BalQty)));
                    $('#iow_' + rowid + '_request_' + iowrowid + '_qty_' + requestrowid).val(sanitizeNumber(l.Qty));
                    $('#iow_' + rowid + '_request_' + iowrowid + '_hiddenqty_' + requestrowid).val(sanitizeNumber(0));
                    $('#iow_' + rowid + '_request_' + iowrowid + '_expandWbs_' + requestrowid).show();

                });
            }
            $('.loading_area').hide();
        }, error: function (jqXHR, textStatus, errorThrown) {
            $('.loading_area').hide();
        }
    });
}

function addNewTermsRow(x) {
    var $tr = $(x).closest('tr');
    if ($tr.next('tr:not(.subTr)').length != 0)
        return;

    var $trowid = $('#trowid'),
        trowid = parseInt($trowid.val()),
        $tbody = $('#termsTable').find('> tbody.main');

    $('#deleteTr_' + trowid).show();
    var count = trowid + 1,
        template = $('#terms-template').html();

    template = template.replace(/__/g, '_' + count);
    $tbody.append(template);

    $trowid.val(count);
    var tCount =  $('#termsTable tbody tr').length;
    if(tCount > 1){
        $('#valuefrom').attr("disabled", true);
    }
    else
    {
        $('#valuefrom').attr("disabled", false);
    }
    bindTermsAutocomplete();
}

function deleteRow(x,e) {
    e.preventDefault();
    var $x = $(x),
        key = $x[0].className.split('_')[1];

    if (!confirm('Do you want to Delete'))
        return false;

    var $tr = $x.closest('tr');
    $tr.next('.subTr').remove();
    $tr.next('.subTr').remove();
    $tr.remove();
    calcTotal();
    bindTermsAutocomplete();
    TermsAutoRefresh();
    return false;
}

function checkTermsUsed(x) {
    var id = $(x)[0].id.split('_')[1];
    var termkeyid = $('input[id*=termsid_]');
    tmp_arr_terms = arr_terms;
    tmp_arr_terms = $.grep(arr_terms, function (element, index) {
        var is_selected = true;
        $.each(termkeyid, function (i, obj) {
            var $this = $(this),
                name = $this[0].id;
            var arrname = name.split('_');
            var key1 = arrname[1];
            if (key1 != id) {
                if (element.data == $this.val()) {
                    is_selected = false;
                    return false;
                }
            }
        });
        return is_selected;
    });
    bindTermsAutocomplete();
}

function nextAccordian(id) {
    $('#panelheading-' + id).trigger('click');
}

function calcQuantity(x) {
    var $x = $(x);
    var ids = $x[0].id.split('_');
    var rowid = ids[1];
    var name=ids[0];
    if(name == 'iow') {
        // calc total qty
        var totalQty = 0;
        $.each($('input[id^=iow_' + rowid + '_qty_'), function (i, o) {
            var qty = parseFloatVal($(this).val());
            if (isNaN(qty))
                qty = 0;

            totalQty += qty;
        });

        $('#qty_' + rowid).val(parseFloatVal(totalQty, 0));

        // calc total amount
        var rate = parseInt($('#rate_' + rowid).val());
        var qrate = parseInt($('#qrate_' + rowid).val());

        $('#amount_' + rowid).val(parseInt(totalQty * qrate));
        $('#baseamount_' + rowid).val(parseInt(totalQty * rate));
        calcTotal();
        var vname = '#qualifierTable_' + rowid;
        CalculateRate(vname);
       TermsAutoRefresh();
    }
}

function calcRequestQuantity(x) {
    var $x = $(x);
    var ids = $x[0].id.split('_');
    var rowid = ids[1];
    var iowrowid = ids[3];
    var requestrowid = ids[5];

    var balqty=parseFloatVal($('#iow_' + rowid + '_request_' + iowrowid + '_balqty_' + requestrowid).val());
    var curqty=parseFloatVal($('#iow_' + rowid + '_request_' + iowrowid + '_qty_' + requestrowid).val());
    var hiddenqty=parseFloatVal($('#iow_' + rowid + '_request_' + iowrowid + '_hiddenqty_' + requestrowid).val());
    if((curqty-hiddenqty)>balqty)
    {
        alert('Qty should not exceed balance quantity');
        $('#iow_' + rowid + '_request_' + iowrowid + '_qty_' + requestrowid).val(0);
    }

    // calc total qty
    var totalQty=0;
    $.each($('input[id^=iow_'+rowid+'_request_'+iowrowid+'_qty_'), function (i,o) {
        var qty = parseFloatVal($(this).val());
        if(isNaN(qty))
            qty = 0;

        totalQty += qty;
    });

    if(totalQty > $('#iow_'+rowid+'_request_'+iowrowid+'_estimateqty').val()) {
        showError($x, 'Qty should not exceed estimate qty!');
        return;
    } else {
        removeError($x);
    }

//        $('#iow_'+rowid+'_request_'+iowrowid+'_totbilledqty').val(sanitizeNumber(totalQty,0));
    $('#iow_'+rowid+'_qty_'+iowrowid).val(parseFloatVal(totalQty,0)).trigger('change');
}

function calcWbsQuantity(x) {

    var $x = $(x);
    var ids = $x[0].id.split('_');
    var rowid = ids[1];
    var name=ids[0];
    if(name == 'wbs') {
        // calc total qty
        var totalQty = 0;
        $.each($('input[id^=wbs_' + rowid + '_qty_'), function (i, o) {
            var qty = parseFloatVal($(this).val());
            if (isNaN(qty))
                qty = 0;

            totalQty += qty;
        });

        $('#qty_' + rowid).val(parseFloatVal(totalQty, 0));

        // calc total amount
        var rate = parseInt($('#rate_' + rowid).val());
        var qrate = parseInt($('#qrate_' + rowid).val());

        $('#amount_' + rowid).val(parseInt(totalQty * qrate));
        $('#baseamount_' + rowid).val(parseInt(totalQty * rate));
        calcTotal();
        var vname = '#qualifierTable_' + rowid;
        CalculateRate(vname);
        TermsAutoRefresh();
    }
}

function calcTotal() {
    var total = 0;
    var btotal = 0;
   // var key1=1;
   // var rows = $('#iow_'+key1+'_RowId' ).val();


    $.each($('input[id^=amount_]'), function (i,o) {
        total += parseFloatVal($(this).val());
    });

    $.each($('input[id^=baseamount_]'), function (i,o) {
        btotal += parseFloatVal($(this).val());
    });

    $('#total').val(sanitizeNumber(total));
    $('#basetotal').val(sanitizeNumber(btotal));

    var tCount =  $('#termsTable tbody tr').length;

    if(tCount > 1){
        $('#valuefrom').attr("disabled", true);
    }
    else
    {
        $('#valuefrom').attr("disabled", false);
    }
}

function addNewTermRow(x) {
    var $tr = $(x).closest('tr');
    if ($tr.next('tr').length != 0)
        return;

    var $rowid = $('#termrowid'),
        rowid = parseInt($rowid.val());
    $('.deleteTermTr_' + rowid).show();
    var count = rowid + 1,
        template = $('#otherterms-template').html();

    template = template.replace(/__/g, '_' + count);
    $tr.parent('tbody').append(template);
    $rowid.val(count);


}

function deleteTerm(x,e) {
    e.preventDefault();
    if (!confirm('Do you want to Delete'))
        return false;

    var $tr = $(x).closest('tr'),
        $tbody = $tr.parent('tbody');

    $tr.remove();
    return false;
}

function addNewTechRow(x) {
    var $tr = $(x).closest('tr');
    if ($tr.next('tr').length != 0)
        return;

    var $rowid = $('#techrowid'),
        rowid = parseInt($rowid.val());
    $('.deleteTechTr_' + rowid).show();
    var count = rowid + 1,
        template = $('#techtitle-template').html();

    template = template.replace(/__/g, '_' + count);
    $tr.parent('tbody').append(template);
    $rowid.val(count);
}

function deleteTech(x,e) {
    e.preventDefault();
    if (!confirm('Do you want to Delete'))
        return false;

    var $tr = $(x).closest('tr'),
        $tbody = $tr.parent('tbody');

    $tr.remove();
    return false;
}

function addNewMaterialRow(x) {
    var $x = $(x),
        $tr = $x.closest('tr'),
        key = $x[0].id.split('_')[1];

    if ($tr.next('tr').length != 0)
        return;

    if ($('#materialName_' + key).val().length == 0 || $('#materialRate_' + key).val().length == 0)
        return;

    var $rowid = $('#materialrowid'),
        rowid = parseInt($rowid.val());
    $('.materialDeleteTr_' + rowid).show();
    var count = rowid + 1,
        template = $('#material-template').html();

    template = template.replace(/__/g, '_' + count);
    $tr.parent('tbody').append(template);
    $rowid.val(count);
    bindMaterialBaseAutoComplete();
}

function deleteMaterial(x,e) {
    e.preventDefault();
    var $x = $(x),
        key = $x[0].className.split('_')[1],
        materialId = $('#materialId_' + key).val();

    if (!confirm('Do you want to Delete'))
        return false;

    var $tr = $x.closest('tr'),
        $tbody = $tr.parent('tbody');

    $tr.remove();
    materialPrice = materiallists;

    bindMaterialBaseAutoComplete();
    return false;
}

function addNewMaterialExcRow(x) {
    var $tr = $(x).closest('tr');

    if ($tr.next('tr').length != 0)
        return;

    var $rowid = $('#materialExcrowid'),
        rowid = parseInt($rowid.val());
    $('.materialExcDeleteTr_' + rowid).show();
    var count = rowid + 1,
        template = $('#materialexc-template').html();

    template = template.replace(/__/g, '_' + count);
    $tr.parent('tbody').append(template);
    $rowid.val(count);
    bindMaterialExcAutoComplete();
}

function deleteMaterialExc(x,e) {
    e.preventDefault();
    var $x = $(x),
        key = $x[0].className.split('_')[1],
        materialId = $('#materialExcId_' + key).val(),
        type = $('#materialExcType_' + key).val();

    if (!confirm('Do you want to Delete'))
        return false;

    var $tr = $(x).closest('tr'),
        $tbody = $tr.parent('tbody');

    $tr.remove();
    bindMaterialExcAutoComplete();
    return false;
}

function addNewMaterialAdvRow(x) {
    var $x = $(x),
        $tr = $x.closest('tr'),
        key = $x[0].id.split('_')[1];

    if ($tr.next('tr').length != 0)
        return;

    if ($('#materialAdvName_' + key).val().length == 0 || $('#materialAdvRate_' + key).val().length == 0)
        return;

    var $rowid = $('#materialAdvrowid'),
        rowid = parseInt($rowid.val());
    $('.materialAdvDeleteTr_' + rowid).show();
    var count = rowid + 1,
        template = $('#materialadv-template').html();

    template = template.replace(/__/g, '_' + count);
    $tr.parent('tbody').append(template);
    $rowid.val(count);
    bindMaterialAdvAutoComplete();
}

function deleteMaterialAdv(x,e) {
    e.preventDefault();
    var $x = $(x),
        key = $x[0].className.split('_')[1],
        materialId = $('#materialAdvId_' + key).val();

    if (!confirm('Do you want to Delete'))
        return false;

    var $tr = $x.closest('tr'),
        $tbody = $tr.parent('tbody');


    $tr.remove();
    bindMaterialAdvAutoComplete();
    return false;
}

function bindMaterialBaseAutoComplete() {
    var $matertialName = $('input[id^=materialName_]');
    $matertialName.unbind('autocomplete');
    var addedMaterials = [];
    $.each($matertialName, function () {
        var $this = $(this),
            name = $this[0].id;
        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1) return;
        var arrname = name.split('_');
        var key1 = arrname[1];

        $this.autocomplete({
            lookup: materialPrice,
//                showNoSuggestionNotice:true,
//                noSuggestionNotice: 'Do you want to Create New <input type="button" style="font-weight:bold" class="btn btn-link" id="matpricenew_' + key1+'" value="Material" onclick="return AddNewMaterial(this.id)">',
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            }, onSelect: function(suggestion) {
                if(suggestion) {
                    var $el = $("#materialId_" + key1);
                    $el.val(suggestion.data);
                    $('#materialUnit_' + key1).val(suggestion.unit);
                    removeError($(this));
                }
            }, onSearchStart: function(suggestion) {
                $("#materialId_" + key1).val(0);
            }, onSearchComplete: function (query, suggestions) {
                if(!suggestions.length){
                    showError($(this), 'Required');
                    $("#materialId_" + key1).val(0);
                } else
                    removeError($(this));
            }
        });
    });
}

function bindMaterialExcAutoComplete() {
    var $materialName = $('input[id^=materialExcName_]');
    $materialName.unbind('autocomplete');

    $.each($materialName, function () {
        var $this = $(this),
            name = $this[0].id;
        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1) return;
        var arrname = name.split('_');
        var key1 = arrname[1];

        $this.autocomplete({
            lookup: materialSupply,
//                showNoSuggestionNotice:true,
//                noSuggestionNotice: 'Do you want to Create New <input type="button" style="font-weight:bold" class="btn btn-link" id="matsupplynew_' + key1+'" value="Material" onclick="return AddNewMaterial(this.id)">',
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            }, onSelect: function(suggestion) {
                if(suggestion) {
                    var $el = $("#materialExcId_" + key1);
                    $el.val(suggestion.data);
                    $('#materialExcUnit_' + key1).val(suggestion.unit);
                    removeError($(this));
                }
            }, onSearchStart: function(suggestion) {
                $("#materialExcId_" + key1).val(0);
            }, onSearchComplete: function (query, suggestions) {
                if(!suggestions.length){
                    showError($(this), 'Required');
                    $("#materialExcId_" + key1).val(0);
                } else {
                    removeError($(this));
                }
            }
        });
    });
}

function bindMaterialAdvAutoComplete() {
    var $matertialName = $('input[id^=materialAdvName_]');
    $matertialName.unbind('autocomplete');
    $.each($matertialName, function () {
        var $this = $(this),
            name = $this[0].id;
        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1) return;
        var arrname = name.split('_');
        var key1 = arrname[1];

        $this.autocomplete({
            lookup: materialaAdv,
//                showNoSuggestionNotice:true,
//                noSuggestionNotice: 'Do you want to Create New <input type="button" style="font-weight:bold" class="btn btn-link" id="matadvnew_' + key1+'" value="Material" onclick="return AddNewMaterial(this.id)">',
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            }, onSelect: function(suggestion) {
                if(suggestion) {
                    var $el = $("#materialAdvId_" + key1);
                    $el.val(suggestion.data);
                    removeError($(this));
                }
            }, onSearchStart: function(suggestion) {
                $("#materialAdvId_" + key1).val(0);
            }, onSearchComplete: function (query, suggestions) {
                if(!suggestions.length){
                    showError($(this), 'Required');
                    $("#materialAdvId_" + key1).val(0);
                } else
                    removeError($(this));
            }
        });
    });
}

function checkMaterialPriceUsed(x) {
    var id = $(x)[0].id.split('_')[1];
    var reskeyid = $('input[id*=materialId_]');
    materialPrice = materiallists;

    materialPrice = $.grep(materiallists, function (element, index) {
        var is_selected = true;
        $.each(reskeyid, function (i, obj) {
            var $this = $(this),
                name = $this[0].id;
            var arrname = name.split('_');
            var key1 = arrname[1];

            if (key1 != id) {
                if (element.data == $this.val()) {
                    is_selected = false;
                    return false;
                }
            }
        });
        return is_selected;
    });
    bindMaterialBaseAutoComplete();
}

function checkMaterialSupplyUsed(x) {
    var id = $(x)[0].id.split('_')[1];
    var reskeyid = $('input[id*=materialExcId_]');
    materialSupply = materiallists;

    materialSupply = $.grep(materiallists, function (element, index) {
        var is_selected = true;
        $.each(reskeyid, function (i, obj) {
            var $this = $(this),
                name = $this[0].id;
            var arrname = name.split('_');
            var key1 = arrname[1];
            if (key1 != id) {
                if (element.data == $this.val()) {
                    is_selected = false;
                    return false;
                }
            }
        });
        return is_selected;
    });
    bindMaterialExcAutoComplete();
}

function checkMaterialAdvUsed(x) {
    var id = $(x)[0].id.split('_')[1];
    var reskeyid = $('input[id*=materialAdvId_]');
    materialaAdv = materiallists;
    materialaAdv = $.grep(materiallists, function (element, index) {
        var is_selected = true;
        $.each(reskeyid, function (i, obj) {
            var $this = $(this),
                name = $this[0].id;
            var arrname = name.split('_');
            var key1 = arrname[1];
            if (key1 != id) {
                if (element.data == $this.val()) {
                    is_selected = false;
                }
            }
        });
        return is_selected;
    });
    bindMaterialAdvAutoComplete();
}

function bindResourceAutocomplete() {

    // bind resource autocomplete
    $('#workorderTable .resourceSuggest').autocomplete({
        lookup: tmp_arr_resources,
        lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
            if (queryLowerCase == '*') {
                return suggestion.value;
            } else {
                var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                return re.test(suggestion.value);
            }
        }, onSelect: function (suggestion) {

            if (suggestion) {
                var $this = $(this);
                var rowid = $this[0].id.split('_')[1];
                var reskeyid = $('input[id*=resourceid_] ') ;
                var bRet=false;
                $.each(reskeyid, function (i, obj) {
                    var $this = $(this),
                        name = $this[0].id;
                    var arrname = name.split('_');
                    var key1 = arrname[1];

                    if (key1 != rowid) {
                        if ($this.val() == suggestion.data && $('#itemid_' + key1).val() == suggestion.ItemId) {
                            bRet = true;
                        }
                    }
                });
                if(bRet == false) {
                    $this.prop('readonly', true).addClass('border-none');
                    $('#desc_' + rowid).val(suggestion.value).addClass('border-none').prop('disabled', true);
                    $('#resourceid_' + rowid).val(suggestion.data);
                    $('#itemid_' + rowid).val(suggestion.ItemId);
                    $('#unitname_' + rowid).val(suggestion.UnitName);
                    $('#unitid_' + rowid).val(suggestion.UnitId);
                    $('#rate_' + rowid).val(suggestion.Rate);
                    $('#qrate_' + rowid).val(suggestion.Rate);
                    $('#expandTr_' + rowid).show();
                    $('#deleteTr_' + rowid).show();
                    $('#expandSt_' + rowid).show();
                    $('#expandRt_' + rowid).show();
                    bindResourceDecisionTrans($this);
                    //bindResourceDecisionAnalTrans($this);
                    addNewResourceRow($this);
                }
                else
                {
                    alert('Already added in list');
                    $('#desc_' + rowid).val('');
                    return;
                }

            }
        }, onSearchStart: function (suggestion) {
            var rowid = $(this)[0].id.split('_')[1];
            $('#unitname_' + rowid).val('');
            $('#rate_' + rowid).val('');
        }, onSearchComplete: function (query, suggestions) {
            if(!suggestions.length) {
                var rowid = $(this)[0].id.split('_')[1];
                $('#unitname_' + rowid).val('');
                $('#rate_' + rowid).val('');
            }
        }
    });
}
function addNewResourceRow(x) {

       var $tr = $(x).closest('tr');
       if ($tr.next('tr:not(.subTr)').length != 0)
           return;

       var $rowid = $('#rowid'),
           rowid = parseInt($rowid.val()),
           $tbody = $('#workorderTable').find('> tbody.main');

       $('#deleteTr_' + rowid).show();
       var count = rowid + 1,
       template = $('#resource-template').html();
       var resspectemplate=$('#resspec-template').html();

       template = template.replace(/__/g, '_' + count);
       $tbody.append(template);
       $('#qualifierTable_' + rowid).html(qualiferHTML.replace(/__1/g, '_' + rowid));
       $('#reqspeTable_' + rowid).append(resspectemplate.replace(/__/g, '_' + rowid));
       $rowid.val(count);
       bindResourceAutocomplete();

}
function checkResourceUsed(x) {
    var id = $(x)[0].id.split('_')[1];
    var reskeyid = $('input[id*=resourceid_] ') ;
    var itemkeyid=$('input[id*=itemid_]');

    tmp_arr_resources = arr_resources;
    tmp_arr_resources = $.grep(arr_resources, function (element, index) {

        var is_selected = true;
        $.each(reskeyid, function (i, obj) {

            var $this = $(this),
                name = $this[0].id;
            var arrname = name.split('_');
            var key1 = arrname[1];

            if (key1 != id) {
                if (element.data == $this.val() && itemkeyid[0].value == element.ItemId) {
                    is_selected = false;
                    return false;
                }
            }
        });

        return is_selected;
    });
    bindResourceAutocomplete();

}
function checkAlreadyUsedItem(x) {
    var id = $(x)[0].id.split('_')[1];
    var resid = $('#resourceid_' + id).val();
    var itemid=$('#itemid_' + id).val();
    var reskeyid = $('input[id*=resourceid_] ') ;

    var bRet=false;
    $.each(reskeyid, function (i, obj) {

            var $this = $(this),
                name = $this[0].id;
            var arrname = name.split('_');
            var key1 = arrname[1];

        if (key1 != id ) {
            if ($this.val() == resid && $('#itemid_' + key1).val() == itemid) {

                bRet = true;
                return;
            }
        }
        });
    return bRet;
}
$('#purchase_type').change(function() {
    var ptypeId = $(this).val();
    $.ajax({
        type: "POST",
        url: getBaseURL()+'mms/purchase/',
        data: "ptypeId="+ptypeId+"&Type=selectAccount",
        dataType: "json",
        success: function(data){
            $("#account_type").html('');
            $("#account_type").append("<option value='0'>Select Account Type</option>");
            $.each(data['resultAcc'], function(i,v){
                $("#account_type").append("<option value='"+v.data+"'>"+v.value+"</option>");
            });
            $("#account_type").selectpicker('refresh');
        }

    });
});

$('#branchname').change(function() {
    var branchid = $(this).val();

    $.ajax({
        type: "POST",
        url: getBaseURL()+'mms/purchase/',
        data: "branchid="+branchid+"&Type=selectBranchContact",
        dataType: "json",
        success: function(data,textStatus,jqXHR){
            if(jqXHR.status == 200) {
                $('#branchcontactno').val(data['ContactNo']);
            }
        }, error: function (jqXHR, textStatus, errorThrown) {
            $('#branchcontactno').val('');
        }
    });

    $.ajax({
        type: "POST",
        url: getBaseURL()+'mms/purchase/',
        data: "branchid="+branchid+"&Type=selectBranchCPerson",
        dataType: "json",
        success: function(data,textStatus,jqXHR){
            if(jqXHR.status == 200) {
                $("#cperson").html('');
                $("#cperson").append("<option value='0'>None</option>");
                $.each(data, function(i,v){
                    $("#cperson").append("<option value='"+v.data+"'>"+v.value+"</option>");
                });
                $("#cperson").selectpicker('refresh');
            }
        }, error: function (jqXHR, textStatus, errorThrown) {

        }
    });
    if(branchid == 0)
    {
        $('#branchcontactno').val('');
        $('#cperson').val('');
        $('#cpersonno').val('');
        $('#cperson').trigger('change');

    }

});

$('#cperson').change(function() {
    var branchtransid=$(this).val();
    if(branchtransid == 0)
    {
        $('#cpersonno').val('');
    }
    $.ajax({
        type: "POST",
        url: getBaseURL()+'mms/purchase/',
        data: "branchtransid="+branchtransid+"&Type=selectCPersonno",
        dataType: "json",
        success: function(data,textStatus,jqXHR){
            if(jqXHR.status == 200) {
                $('#cpersonno').val(data['cpersonno']);
            }
        }, error: function (jqXHR, textStatus, errorThrown) {
            $('#cpersonno').val('');
        }
    });
});
$('#warehouse').change(function() {
    var whtransid=$(this).val();
    if(whtransid == 0)
    {
        $('#whaddress').val('');
    }
    $.ajax({
        type: "POST",
        url: getBaseURL()+'mms/purchase/',
        data: "whtransid="+whtransid+"&Type=selectWHAddress",
        dataType: "json",
        success: function(data,textStatus,jqXHR){
            if(jqXHR.status == 200) {
                $('#whaddress').val(data['whaddress']);
            }
        }, error: function (jqXHR, textStatus, errorThrown) {
            $('#whaddress').val('');
        }
    });
});
function showtabs(type,id,event) {
    event.preventDefault();
    $('#' + id).parent('li').addClass('active').siblings('li').removeClass('active');
    var rowid = id.split('_')[1];
    if (type=="decision") {
        $('#decisionTable_'+rowid).show();
        $('#qualifierTable_'+rowid).hide();
        $('#reqspeTable_'+rowid).hide();
        $('#wbsTable_'+rowid).hide();

    } else if (type=="qualifier") {
        $('#qualifierTable_'+rowid).show();
        $('#decisionTable_'+rowid).hide();
        $('#reqspeTable_'+rowid).hide();
        $('#wbsTable_'+rowid).hide();
    }
    else if (type=="wbs") {
        $('#wbsTable_'+rowid).show();
        $('#qualifierTable_'+rowid).hide();
        $('#decisionTable_'+rowid).hide();
        $('#reqspeTable_'+rowid).hide();
    }
    else
    {
        $('#reqspeTable_'+rowid).show();
        $('#qualifierTable_'+rowid).hide();
        $('#decisionTable_'+rowid).hide();
        $('#wbsTable_'+rowid).hide();
    }
    return false;
}

function showotherstabs(type) {
    if (type=="narration") {
        $('#narration').show();
        $('#branchdetails').hide();
        $('#deliverydetails').hide();
        $('#vendorcontact').hide();
        $('#cccontact').hide();
        $('#ccontact').hide();
    }
    else if(type == "branch"){
        $('#branchdetails').show();
        $('#narration').hide();
        $('#deliverydetails').hide();
        $('#vendorcontact').hide();
        $('#cccontact').hide();
        $('#ccontact').hide();
    }
    else if(type == "delivery")
    {
        $('#deliverydetails').show();
        $('#branchdetails').hide();
        $('#narration').hide();
        $('#vendorcontact').hide();
        $('#cccontact').hide();
        $('#ccontact').hide();
    }
    else if(type == "vcontact")
    {
        $('#vendorcontact').show();
        $('#deliverydetails').hide();
        $('#branchdetails').hide();
        $('#narration').hide();
        $('#cccontact').hide();
        $('#ccontact').hide();
    }
    else if(type == "cccontact")
    {
        $('#cccontact').show();
        $('#vendorcontact').hide();
        $('#deliverydetails').hide();
        $('#branchdetails').hide();
        $('#narration').hide();
        $('#ccontact').hide();
    }
    else if(type == "ccontact")
    {
        $('#ccontact').show();
        $('#vendorcontact').hide();
        $('#deliverydetails').hide();
        $('#branchdetails').hide();
        $('#narration').hide();
        $('#cccontact').hide();
    }

}

function rateChange(x)
{
    var iFocusRowId= x.split("_")[1];
    var bRate=parseFloatVal($('#rate_' + iFocusRowId).val());
    var bQty=parseFloatVal($('#qty_' + iFocusRowId).val());
    $('#qrate_' + iFocusRowId).val(parseFloatVal($('#rate_' + iFocusRowId).val()));
    $('#baseamount_' + iFocusRowId).val(sanitizeNumber(parseFloatVal(bQty)*parseFloatVal(bRate),2,true));
    $('#amount_' + iFocusRowId).val(sanitizeNumber(parseFloatVal(bQty)*parseFloatVal(bRate),2,true));
    var vname = '#qualifierTable_' + iFocusRowId;
    CalculateRate(vname);
}

function CalculateRate(x) {

    var iFocusRowId=x.split("_")[1],
        name = '#desc_' + iFocusRowId,
        iRows = $('#rowid_' + iFocusRowId).val(),
        sname = x.split("_")[0],
        sQualName = "Qual";
    sUnit =isNullCheck($('#unitid_' + iFocusRowId).val(),'string');


    if (sname.substr(sname.length-1) ==  "R") {
        name = '#rateanalR_' + iFocusRowId;
        iRows = $('#rowinfoidR_' + iFocusRowId).val();
        sQualName = "QualR";
    }

    var qty=$('#qty_'+iFocusRowId).val();
    var dbaseAmt=$('#baseamount_'+iFocusRowId).val();

    var dQAmt =  CalculateQualifier(dbaseAmt,iFocusRowId,sQualName);

    $('#amount_' + iFocusRowId).val(sanitizeNumber(parseFloatVal(dbaseAmt)+parseFloatVal(dQAmt),2,true));
    $('#qrate_' + iFocusRowId).val(sanitizeNumber((parseFloatVal(dbaseAmt)+parseFloatVal(dQAmt))/parseFloatVal(qty)),2,true);
    calcTotal();
	
    TermsAutoRefresh();
}

function CalculateQualifier(baseValue, key1,sQualName) {
    var sQName = sQualName + '_';
    var rows = $('#' + sQualName +  'RowId_' + key1).val();
    var sformula="";
    var dbaseAmt=parseFloatVal(isNullCheck(baseValue,'number'));
    var dTotalQualAmt=0;

    for (i = 1; i <= rows; i++) {
        var sRef = $('#' + sQName + key1 + '_Ref_' + i).val().trim();
        var sFormula = isNullCheck($('#' + sQName + key1 + '_Exp_'+ i).val(),'string');
        var dPer = parseFloatVal(isNullCheck($('#' + sQName + key1 + '_ExpPer_'+ i).val(),'number'));
        var sbaseRef = 'R0';
        if (parseFloatVal(dPer) ==0) dPer=100;
        sFormula = sFormula.replace(new RegExp(sbaseRef, 'g'), dbaseAmt);
        for (j = 1; j <= rows; j++) {
            var sFRef = $('#' + sQName + key1 + '_Ref_' + j).val().trim();
            var dFamt = parseFloatVal(isNullCheck($('#' + sQName + key1 + '_Amount_'+ j).val(),'number'));
            sFormula = sFormula.replace(new RegExp(sFRef, 'g'), dFamt);
        }
        var fvaule = computeEval(sFormula);
        $('#' + sQName + key1 + '_ExpValue_' + i).val(numberFormat(fvaule,'C'));

        var iQualTypeid = $('#' + sQName + key1 + '_TypeId_' + i).val();

        if (iQualTypeid==1 || iQualTypeid==2) {
            var dTaxablePer = parseFloatVal(isNullCheck($('#' + sQName + key1 + '_TaxablePer_' + i).val(),'number'));
            var dTaxPer = parseFloatVal(isNullCheck($('#' + sQName + key1 + '_TaxPer_' + i).val(),'number'));
            var dCess = parseFloatVal(isNullCheck($('#' + sQName + key1 + '_CessPer_' + i).val(),'number'));
            var dEDCess = parseFloatVal(isNullCheck($('#' + sQName + key1 + '_EduCessPer_' + i).val(),'number'));
            var dHEDCess = parseFloatVal(isNullCheck($('#' + sQName + key1 + '_HEduCessPer_' + i).val(),'number'));
            var dNetPer = dTaxPer + (dTaxPer * (dCess +  dEDCess + dHEDCess))/100;
            $('#' + sQName + key1 + '_NetPer_' + i).val(dNetPer);

            $('#' + sQName + key1 + '_NetPer_' + i).val(numberFormat(dNetPer,'C'));
            $('#' + sQName + key1 + '_ExpPer_'+ i).val(numberFormat(dNetPer,'C'));

            var dTaxableAmt =  fvaule* (dTaxablePer/100);
            var dTaxAmt =  dTaxableAmt* (dTaxPer/100);
            var dCessAmt =  dTaxAmt* (dCess/100);
            var dEDAmt =  dTaxAmt* (dEDCess/100);
            var dHEDAmt =  dTaxAmt* (dHEDCess/100);
            var dNetAmt = dTaxAmt+dCessAmt+dEDAmt+dHEDAmt;

            $('#' + sQName + key1 + '_TaxableAmt_'+ i).val(numberFormat(dTaxableAmt,'C'));
            $('#' + sQName + key1 + '_TaxPerAmt_'+ i).val(numberFormat(dTaxAmt,'C'));
            $('#' + sQName + key1 + '_CessAmt_'+ i).val(numberFormat(dCessAmt,'C'));
            $('#' + sQName + key1 + '_EduCessAmt_'+ i).val(numberFormat(dEDAmt,'C'));
            $('#' + sQName + key1 + '_HEduCessAmt_'+ i).val(numberFormat(dHEDAmt,'C'));
            $('#' + sQName + key1 + '_NetAmt_'+ i).val(numberFormat(dNetAmt,'C'));

            dAmt = dNetAmt;
        } else {

            var dAmt = parseFloatVal(fvaule) * (parseFloatVal(dPer) / 100);
        }

        $('#' + sQName + key1 + '_Amount_' + i).val(numberFormat(dAmt,'C'));
        if ($('#' + sQName + key1 + '_YesNo_' + i).is(':checked') == true) {
            var sSign = isNullCheck($('#' + sQName + key1 + '_Sign_' + i).val(),'string');
            if (sSign =="-") dTotalQualAmt = dTotalQualAmt - parseFloatVal(dAmt);
            else dTotalQualAmt = dTotalQualAmt + parseFloatVal(dAmt);
        }
    }

    $('#'+ sQualName + 'TotalAmt_' + key1).val(numberFormat(dTotalQualAmt,'C'));

    return dTotalQualAmt;
    //qualTotal();
}

function bindTaxCalculation() {
    var $mainTr = $(".qualChange");
    $mainTr.change(function (e) {
        CalculateTax($(this)[0].id);
    });
}

function signChange(x) {
    var $this = $(x);
    if ($this.hasClass( "fa-plus" )) {
        $this.removeClass('fa-plus clr-gre');
        $this.addClass('fa-minus clr-red');
        var sname= $this[0].id.split('_')[0],
            key1 = $this[0].id.split('_')[1],
            key2 = $this[0].id.split('_')[3];
        $('#' +  sname + '_' + key1 + '_Sign_' + key2).val('-');
    } else {
        $this.removeClass('fa-minus clr-red');
        $this.addClass('fa-plus clr-gre');
        var sname= $this[0].id.split('_')[0],
            key1 = $this[0].id.split('_')[1],
            key2 = $this[0].id.split('_')[3];
        $('#' +  sname + '_' + key1 + '_Sign_' + key2).val('+');
    }
    CalculateQualifier($this[0].id);
}

function CalculateTax(id) {
    //if (bReady==false) return;
    var sname= id.split('_')[0],
        key1 = id.split('_')[1],
        key2 = id.split('_')[3];

    var name = '#rateanal_' + key1;
    if (sname == "QualR")  name = '#rateanalR_' + key1;

    CalculateRate(name);

function bindQualTot_onChange() {
    $paymentScheduleWrapper.on('change', '[id^="QualTotalAmt_"]', function() {
        var $tarReceiptTr = $(this).closest('.qualmainTr').prev('tr');

        $tarReceiptTr.find('.sch-tax').val($(this).val());

        calcReceiptTotal($tarReceiptTr.closest('tbody'));
    });
}
function signChange(x) {
    var $this = $(x);
    if ($this.hasClass( "fa-plus" )) {
        $this.removeClass('fa-plus clr-gre');
        $this.addClass('fa-minus clr-red');
        var key1 = $this[0].id.split('_')[1],
            key2 = $this[0].id.split('_')[3];
        $('#Qual_' + key1 + '_Sign_' + key2).val('-');
    } else {
        $this.removeClass('fa-minus clr-red');
        $this.addClass('fa-plus clr-gre');
        var key1 = $this[0].id.split('_')[1],
            key2 = $this[0].id.split('_')[3];
        $('#Qual_' + key1 + '_Sign_' + key2).val('+');
    }
    CalculateTax($this[0].id);
}
function computeEval(formula) {
    with (document.forms){
        with (Math) {
            A = eval((formula));
        }
    } return A;
}
function CalculateTax(id) {
    var sname= id.split('_')[0],
        key1 = id.split('_')[1],
        key2 = id.split('_')[3];

    var name = '#qualifierTable_' + key1;
    if (sname == "QualR")  name = '#qualifierTable_' + key1;
    CalculateRate(name);
}


function TermsAutoRefresh()
{
    var netAmt=parseFloat(isNullCheck($('#total').val(),'number'));
    var iKey=0;
    var dFAmt=0.0;
    var sTerms='';
    $.each($('input[id^=terms_]'), function (i,o) {
        iKey = iKey + 1;
        sTerms = $(this).val();

        if(sTerms == 'Advance' || sTerms == 'Against Delivery' || sTerms == "Against Work" || sTerms == "Against Bill" || sTerms == "Against Certification")
        {
            dCurPer = parseFloat(isNullCheck($('#per_'+iKey).val(),'number'));;
            if(parseFloat(isNullCheck(netAmt,'number'))>0 && parseFloat(isNullCheck(dCurPer,'number')) > 0)
            {
                dFAmt = (parseFloat(isNullCheck(dCurPer,'number')) / 100) * parseFloat(isNullCheck(netAmt,'number'));
            }
            $('#value_'+iKey).val(dFAmt);
        }
    });


    var tCount =  $('#termsTable tbody tr').length;

    if(tCount > 1){
        $('#valuefrom').attr("disabled", true);
    }
    else
    {
        $('#valuefrom').attr("disabled", false);
    }

}

function TermsCalculation(x)
{
    var valueFrom=$('#valuefrom').val();
    var sname= x.split('_')[0],
        key= x.split('_')[1];
    var netAmt=0.0;
    if(valueFrom == 'BaseAmount'){
        netAmt = parseFloat(isNullCheck($('#basetotal').val(),'number'));
    }
    else if(valueFrom == 'NetAmount'){
        netAmt=parseFloat(isNullCheck($('#total').val(),'number'));
    }
    else
    {
        netAmt=parseFloat(isNullCheck($('#basetotal').val(),'number'));
    }

    var sTerms=$('#terms_'+key).val();

    var eTerms="";
    var dAdvPer,dADelPer,dAWorkPer,dABillPer,dACerPer,dCurPer=0.0;
    var dAdvVal,dADelVal,dAWorkVal,dABillVal,dACerVal=0.0;
    var iKey=0;
    $.each($('input[id^=terms_]'), function (i,o) {
        $this=$(this);
        //iKey = iKey + 1;
        iKey = $this[0].id.split('_')[1];
        eTerms = $(this).val();

        //iKey = $this[0].id.split('_')[1];
        if(eTerms == 'Advance'){
            dAdvPer=parseFloat(isNullCheck($('#per_'+iKey).val(),'number'));
            dAdvVal=parseFloat(isNullCheck($('#value_'+iKey).val(),'number'));
        }
        if(eTerms == 'Against Delivery'){
            dADelPer=parseFloat(isNullCheck($('#per_'+iKey).val(),'number'));
            dADelVal=parseFloat(isNullCheck($('#value_'+iKey).val(),'number'));
        }
        if(eTerms == 'Against Work'){
            dAWorkPer=parseFloat(isNullCheck($('#per_'+iKey).val(),'number'));
            dAWorkVal=parseFloat(isNullCheck($('#value_'+iKey).val(),'number'));
        }
        if(eTerms == 'Against Bill'){
            dABillPer=parseFloat(isNullCheck($('#per_'+iKey).val(),'number'));
            dABillVal=parseFloat(isNullCheck($('#value_'+iKey).val(),'number'));
        }
        if(eTerms == 'Against Certification'){
            dACerPer=parseFloat(isNullCheck($('#per_'+iKey).val(),'number'));
            dACerVal=parseFloat(isNullCheck($('#value_'+iKey).val(),'number'));
        }
    });
    if(sTerms == 'Advance' && sname == 'per' || sTerms == 'Against Delivery' && sname == 'per' || sTerms == "Against Work" && sname == 'per' || sTerms == "Against Bill" && sname == 'per' || sTerms == "Against Certification" && sname == 'per')
    {
        if(sTerms == 'Advance' && sname == 'per')
        {
            dCurPer = dAdvPer;
        }
        else if(sTerms == 'Against Delivery' && sname == 'per')
        {
            dCurPer = dADelPer;
        }
        else if(sTerms == 'Against Work' && sname == 'per')
        {
            dCurPer = dAWorkPer;
        }
        else if(sTerms == 'Against Bill' && sname == 'per')
        {
            dCurPer = dABillPer;
        }
        else if(sTerms == 'Against Certification' && sname == 'per')
        {
            dCurPer = dACerPer;
        }

        if(TotAmtValidation(dAdvPer,dADelPer,dAWorkPer,dABillPer,dACerPer) == false)
        {
            PerCalc(dAdvPer,dADelPer,dAWorkPer,dABillPer,dACerPer,dCurPer,netAmt,key)
        }
        else
        {
            alert("Enter Valid Amount!");
            $('#per_'+key).val(0);
            $('#value_'+key).val(0);
            return;
        }
    }
    else if(sTerms == 'Advance' && sname == 'value' || sTerms == 'Against Delivery' && sname == 'value' || sTerms == "Against Work" && sname == 'value' || sTerms == "Against Bill" && sname == 'value' || sTerms == "Against Certification" && sname == 'value')
    {
        if(sTerms == 'Advance' && sname == 'value')
        {
            dCurPer = dAdvVal;
        }
        else if(sTerms == 'Against Delivery' && sname == 'value')
        {
            dCurPer = dADelVal;
        }
        else if(sTerms == 'Against Work' && sname == 'value')
        {
            dCurPer = dADelval;
        }
        else if(sTerms == 'Against Bill' && sname == 'value')
        {
            dCurPer = dABillVal;
        }
        else if(sTerms == 'Against Certification' && sname == 'value')
        {
            dCurPer = dACerVal;
        }
        AmtCalc(dAdvPer,dADelPer,dAWorkPer,dABillPer,dACerPer,dCurPer,netAmt,key);
        dCurPer = parseFloat(isNullCheck($('#per_'+key).val(),'number'));

        $.each($('input[id^=terms_]'), function (i,o) {
            eTerms = $(this).val();
            if(eTerms == 'Advance'){
                dAdvPer=parseFloat(isNullCheck($('#per_'+key).val(),'number'));
                dAdvVal=parseFloat(isNullCheck($('#value_'+key).val(),'number'));
            }
            if(eTerms == 'Against Delivery'){
                dADelPer=parseFloat(isNullCheck($('#per_'+key).val(),'number'));
                dADelVal=parseFloat(isNullCheck($('#value_'+key).val(),'number'));
            }
            if(eTerms = 'Against Work'){
                dAWorkPer=parseFloat(isNullCheck($('#per_'+key).val(),'number'));
                dAWorkVal=parseFloat(isNullCheck($('#value_'+key).val(),'number'));
            }
            if(eTerms == 'Against Bill'){
                dABillPer=parseFloat(isNullCheck($('#per_'+key).val(),'number'));
                dABillVal=parseFloat(isNullCheck($('#value_'+key).val(),'number'));
            }
            if(eTerms == 'Against Certification'){
                dACerPer=parseFloat(isNullCheck($('#per_'+key).val(),'number'));
                dACerVal=parseFloat(isNullCheck($('#value_'+key).val(),'number'));
            }
        });

        if(TotAmtValidation(dAdvPer,dADelPer,dAWorkPer,dABillPer,dACerPer) == true)
        {
            alert("Enter Valid Amount!");
            $('#per_'+key).val(0);
            $('#value_'+key).val(0);
        }
    }
    //alert(dAdvPer);
}

function TotAmtValidation(argAdv,argADel,argAWork,argABill,argACer)
{
    var bRet=false;
    var dTot=parseFloat(isNullCheck(argAdv,'number')) + parseFloat(isNullCheck(argADel,'number')) + parseFloat(isNullCheck(argABill,'number')) + parseFloat(isNullCheck(argACer,'number')) + parseFloat(isNullCheck(argAWork,'number'));
    if(dTot > 100)
    {
        bRet = true;
    }
    return bRet;
}
function AmtCalc(argAdv,argAgaDel,argAgaWork,argAgaBill,argAgaCer,argPer,argTotAmt,key)
{
    var Val,TotPer = 0.0;
    TotPer = parseFloat(isNullCheck(argAgaDel,'number')) + parseFloat(isNullCheck(argAgaBill,'number')) + parseFloat(isNullCheck(argAgaCer,'number')) + parseFloat(isNullCheck(argAgaWork,'number'));
    Val = AmountToPer(parseFloat(isNullCheck(argTotAmt,'number')),parseFloat(isNullCheck(argPer,'number')),parseFloat(isNullCheck(TotPer,'number')));
    $('#per_'+key).val(Val);
}
function PerCalc(argAdv,argAgaDel,argAgaWork,argAgaBill,argAgaCer,argPer,argTotAmt,key)
{
    var Val,TotPer=0.0;
    TotPer = parseFloat(isNullCheck(argAgaDel,'number'))+parseFloat(isNullCheck(argAgaBill,'number'))+parseFloat(isNullCheck(argAgaCer,'number'))+parseFloat(isNullCheck(argAgaWork,'number'));
    Val = PerToAmount(parseFloat(isNullCheck(argPer,'number')),parseFloat(isNullCheck(argTotAmt,'number')),parseFloat(isNullCheck(TotPer,'number')));
    $('#value_'+key).val(Val);
}
function PerToAmount(argPer,argAmt,argTotPer)
{
    if(parseFloat(isNullCheck(argAmt,'number'))>0 && parseFloat(isNullCheck(argPer,'number')) > 0)
    {
        argPer = (parseFloat(isNullCheck(argPer,'number')) / 100) * parseFloat(isNullCheck(argAmt,'number'));
    }
    return argPer;
}
function AmountToPer(argAmt,argPer,argTotPer)
{
    if(parseFloat(isNullCheck(argAmt,'number')) > 0 && parseFloat(isNullCheck(argPer,'number')) >0)
    {
        argAmt = ((parseFloat(isNullCheck(argPer,'number')) / parseFloat(isNullCheck(argAmt,'number'))) * 100)
    }
    return argAmt;
}
function stockPODetails(x){

    var rowid = $(x)[0].id.split('_')[1];
    var resourceid = $('#resourceid_' + rowid).val();
    var itemid = $('#itemid_' + rowid).val();
    var CostCenterId = $('#CostCenterId').val();
    var  mode="getstockdetails";

    $.ajax({
        url: getBaseURL() + 'mms/purchase/',
        type: "post",
        data: "Type="+ mode + "&CostCenterId=" + CostCenterId +"&resourceid=" + resourceid ,
        success: function (data, textStatus, jqXHR) {
            if(jqXHR.status == 200) {
                var sdata = JSON.parse(data);
                $("#stockPOModal").show();
                $("#estimateQty").val(sdata['EstimateQty']);
                $("#estimateRate").val(sdata['EstimateRate']);
                $("#availableQty").val(sdata['AvailableQty']);
                $("#excessQty").val(sdata['ExcessQty']);
                $("#balancePO").val(sdata['BalPOQty']);
                $("#totPurchase").val(sdata['TotPurchase']);
                $("#reqQty").val(sdata['ReqQty']);
                $("#poQty").val(sdata['POQty']);
                $("#minQty").val(sdata['MinQty']);
                $("#billQty").val(sdata['BillQty']);
            }
        }

    });
}

function stockWBSDetails(x){

    var $x = $(x);
    var ids = $x[0].id.split('_');
    var rowid = ids[1];
    var iowrowid = ids[3];
    var requestrowid = ids[5];

    var resourceid = $('#resourceid_' + rowid).val();
    var itemid = $('#itemid_' + rowid).val();
    var CostCenterId = $('#CostCenterId').val();
    var WBSId = $('#iow_' + rowid + '_request_' + iowrowid + '_wbsid_' + requestrowid).val();
    var  mode="getwbsstockdetails";

    $.ajax({
        url: getBaseURL() + 'mms/purchase/',
        type: "post",
        data: "Type="+ mode + "&WBSId="+ WBSId + "&CostCenterId=" + CostCenterId +"&resourceid=" + resourceid ,
        success: function (data, textStatus, jqXHR) {
            if(jqXHR.status == 200) {
                var sdata = JSON.parse(data);
                $("#stockWBSModal").show();
                $("#estimateWbsQty").val(sdata['EstimateQty']);
                $("#estimateWbsRate").val(sdata['EstimateRate']);
                $("#availableWbsQty").val(sdata['AvailableQty']);
                $("#excessWbsQty").val(sdata['ExcessQty']);
                $("#balanceWbsPO").val(sdata['BalPOQty']);
                $("#totWbsPurchase").val(sdata['TotPurchase']);
                $("#reqWbsQty").val(sdata['ReqQty']);
                $("#poWbsQty").val(sdata['POQty']);
                $("#minWbsQty").val(sdata['MinQty']);
                $("#billWbsQty").val(sdata['BillQty']);
            }
        }

    });
}

function prerateDetails(x){

    var rowid = $(x)[0].id.split('_')[1];
    var resourceid = $('#resourceid_' + rowid).val();
    var itemid = $('#itemid_' + rowid).val();
    var CostCenterId = $('#CostCenterId').val();
    var  mode="getpreORate";
    var venid = <?php echo (isset($vendor)) ? $vendor['VendorId'] : '';?>;

    $.ajax({
        url: getBaseURL() + 'mms/purchase/orderentry',
        type: "post",
        data: "Type="+ mode + "&CostCenterId=" + CostCenterId +"&ResourceId=" + resourceid + "&ItemId=" + itemid + "&VendorId=" + venid,
        datatype: "json",
        success: function (data, textStatus, jqXHR) {
            if(jqXHR.status == 200) {
                data = JSON.parse(data);

                var source =
                {
                    dataFields: [
                        { name: 'Date', type: 'string' },
                        { name: 'PONo', type: 'string' },
                        { name: 'CostCentre', type: 'string' },
                        { name: 'Vendor', type: 'string' },
                        { name: 'Company', type: 'string' },
                        { name: 'Specification', type: 'string' },
                        { name: 'Rate', type: 'number' }

                    ],
                    localdata:data.orate,
                    id: 'Id',
                    datatype: "json",
                    async: false

                };

                var orate = new $.jqx.dataAdapter(source);

                // creage jqxgrid
                $("#orateGrid").jqxGrid({
                    width: '100%',
                    autoheight:true,
                    source: orate,
                    sortable: true,
                    filterable: true,
                    pageable: true,
                    ready: function () {
                        //$("#subGrid").jqxGrid('showrowdetails', 1);
                    },
                    columns: [

                        { text: 'Date', dataField: 'Date',width: '50%'},
                        { text: 'PONo', dataField: 'PONo' },
                        { text: 'CostCentre', dataField: 'CostCentre' },
                        { text: 'Vendor', dataField: 'Vendor' },
                        { text: 'Company', dataField: 'Company' },
                        { text: 'Specification', dataField: 'Specification' },
                        { text: 'Rate', dataField: 'Rate' }
                    ]
                });
            }
        }

    });
}




</script>
