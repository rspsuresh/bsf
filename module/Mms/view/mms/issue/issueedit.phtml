<!--STYLE-->
<link rel="stylesheet" href="<?php echo $this->basePath() . '/css/mms.css';?>"/>
<!--STYLE-->
<style type="text/css">
    .sub_tbl1 {color:#424141;font-weight: 600; background:#edefe2 !important;border-bottom: 2px solid #9c793b !important;border-top: 1px solid #ddd !important;white-space: nowrap;}
    .sub_tbl2{color: #424141;font-weight: 600; background: #efe2e2 !important;border-bottom: 2px solid #5d9bb6 !important;border-top: 1px solid #ddd !important;white-space: nowrap;}
    .sub_tbl3{color: #424141;font-weight: 600; background: #ceefe5 !important;border-bottom: 2px solid #18abc4 !important;border-top: 1px solid #ddd !important;white-space: nowrap;
	.bar1, .bar2, .bar3 {width: 18px;height: 3px;background-color: #009688;margin: 3px 0;transition: 0.4s;}
    .change .bar1 {-webkit-transform: rotate(-45deg) translate(-6px, 5px);transform: rotate(-45deg) translate(-6px,5px);}
    .change .bar2 {opacity: 0;}
    .change .bar3 {-webkit-transform: rotate(45deg) translate(-3px, -3px);transform: rotate(45deg) translate(-3px, -3px);}
    .flip0{float:right;margin-top:5px;cursor:pointer;}
	.lbl_ptb {padding-top: 5px!important;padding-bottom:5px !important;}
	.pan_box{height:100px !important;}

</style>

<!--content-->
<div class="content_wrapper padlr0">
<div class="container-fluid">
    <div class="row">
        <form method="post" id="formWrapper" action="<?php echo $this->basePath(); ?>/mms/issue/issueEnt">
            <input type="hidden" id="CostCentre" name="CostCentre" value="<?php echo (isset($CostCentre)) ? $CostCentre : '';?>">
            <input type="hidden" name="issue_date" value="<?php echo (isset($issue_date)) ? $issue_date : 0;?>">
            <input type="hidden" name="IssueNo" value="<?php echo (isset($IssueNo)) ? $IssueNo :  '';?>">
            <input type="hidden" name="issue_type" value="<?php echo (isset($issue_type)) ? $issue_type :  '';?>">
            <input type="hidden" name="IssueId" value="<?php echo (isset($IssueId)) ? $issue_type :  '';?>">
            <input type="hidden" name="contractor" id="contractor" value="<?php echo (isset($contractor)) ? $contractor :  '';?>">
            <input type="hidden" name="issue" value="<?php echo (isset($issue)) ? $issue:  '';?>">
            <input type="hidden" name="OwnOrCsm" value="<?php echo (isset($OwnOrCsm)) ? $OwnOrCsm :  '';?>">
            <input type="hidden" name="VendorId" value="<?php echo (isset($VendorId)) ? $VendorId :  '';?>">
            <input type="hidden" name="IssueRegisterId" value="<?php echo (isset($IssueRegisterId)) ? $IssueRegisterId :  '';?>">
            <input type="hidden" id="gridtype" name="gridtype" value="<?php echo (isset($gridtype)) ? $gridtype : 0;?>">

            <input type="hidden" name="closingstock">
            <div class="col-lg-12">
                <h1>Issue Entry 
					<div class="flip0">
						<div class="click" onclick="myFunction(this)">
							<div class="bar1"></div>
							<div class="bar2"></div>
							<div class="bar3"></div>
						</div>
					</div>
				</h1>
            </div>
            <div class="col-lg-12">
				<div class="pane0">
					<div class="col-lg-6">
						<div class="pan_box zoomIn animated">
							<ul>
								<li class="lbl_ptb" id="CostCentre">
									<label>Cost Centre</label>
									<span class="mgic"><?php echo (isset($ProjectName)) ? $ProjectName : '';?></span>
								</li>
								<li class="lbl_ptb">
									<label>Issue No</label>
									<span class="mgic"><?php echo (isset($vNo)) ? $vNo : '';?></span>
                                    <span><input type="hidden" name="IssueNo" id="IssueNo" value="<?php echo (isset($vNo)) ? $vNo : '';?>"/></span>
                                </li>
								<li class="lbl_ptb">
									<label>Issue Date</label>
									<span><input type="text" placeholder="DD-MM-YYYY" class="date_picker" name="issueDate" style="cursor:pointer;" value="<?php echo (isset($issue_datess)) ? $issue_datess : date('d-m-Y');?>" readonly/></span>

								</li>
								<li class="lbl_ptb">
									<label>CIssue No</label>
									<?php if((((isset($IssueRegisterId)) ? $IssueRegisterId : 0) >0  || $CCIssue['genType']==0)){?>
										<span><input type="text" placeholder="xxxxx" id="CCINo" name="CCINo" value="<?php echo (isset($CCINo)) ? $CCINo : '';?>"/></span>
									<?php }else{ ?>
										<span><input type="text" placeholder="xxxxx" id="CCINo" name="CCINo" value="<?php echo (isset($CCINo)) ? $CCINo : '';?>" readonly /></span>
									<?php } ?>
								</li>
							</ul>
						</div>
					</div>
					<div class="col-lg-6">
						<div class="pan_box zoomIn animated">
							<ul>
								<li class="lbl_ptb">
									<label>CCIssue No</label>
									<?php if((((isset($IssueRegisterId)) ? $IssueRegisterId : 0) >0  || $CIssue['genType']==0)){?>
										<span><input type="text" placeholder="xxxxx" id="CINo" name="CINo" value="<?php echo (isset($CINo)) ? $CINo : '';?>"/></span>
									<?php }else{ ?>
										<span><input type="text" placeholder="xxxxx" id="CINo" name="CINo" value="<?php echo (isset($CINo)) ? $CINo : '';?>" readonly /></span>
									<?php } ?>
								</li>
								<li class="lbl_ptb">
									<label>Issue Type</label>
									<span><input type="text" placeholder="xxxxx" name="issuetype" value="<?php echo (isset($issue_typename)) ? $issue_typename : '';?>" readonly/></span>
								</li>
								<li class="lbl_ptb">
									<label>contractor</label>
									<span><input type="text" placeholder="xxxxx" name="contractorName" value="<?php echo (isset($ContractorName)) ? $ContractorName : '';?>" readonly /></span>
								</li>
								<li class="lbl_ptb">
									<label>Issue</label>
									<span><input type="text" placeholder="xxxxx" name="issue" value="<?php echo (isset($issue)) ? $issue : '';?>" readonly /></span>
								</li>
							</ul>
						</div>
					</div>
				</div>
            </div>
            <input type="hidden" name="frm_index" value="1"/>
            <div class="clearfix"></div>
            <div class="col-lg-12 clear top-20">
                <div id="accordion" class="panel-group">
                    <?php if($issue=="issue"){?>
                        <div class="panel panel-info">
                            <div data-target="#collapseOne" data-parent="#accordion" data-toggle="collapse" class="panel-heading collapsed panel_heads" id="panelheading-1">
                                <h4 class="panel-title accordion-toggle defa_panels">Issue Quantity</h4>
                            </div>
                            <div class="panel-collapse collapse" id="collapseOne" style="height: 0px;">
                                <div class="panel-body bgcolr">
                                    <div class="col-lg-12">
                                        <div class="table-responsive top-30">
                                            <table class="table" style=" margin-bottom:0px;" id="workorderTable">
                                                <thead>
                                                <tr>
                                                    <th>Code</th>
                                                    <th>Resource</th>
                                                    <th>F/C</th>
                                                    <th>Unit</th>
                                                    <th>Qty</th>
                                                    <th>Rate</th>
                                                    <th>Amount</th>
                                                    <th>Remarks</th>
                                                    <th>Issue A/C</th>
                                                    <th>Purchase A/C</th>
                                                    <th>&nbsp;</th>
                                                    <th>&nbsp;</th>
                                                </tr>
                                                </thead>
                                                <tbody class="main"></tbody>
                                            </table>
                                            <input type="hidden" name="rowid" id="rowid" value="0"/>
                                        </div>
                                        <div class="cont_bt col-lg-5 col-lg-offset-7 col-md-9 col-md-offset-3 col-sm-7 col-sm-offset-5 col-xs-7 col-xs-offset-5">
                                            <ul>
                                                <li><a href="javascript:nextAccordian(2)">Continue &nbsp;<i class="fa fa-chevron-circle-right"></i></a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <?php }else{?>
                        <div class="panel panel-info">
                            <div data-target="#collapseOne" data-parent="#accordion" data-toggle="collapse" class="panel-heading collapsed panel_heads" id="panelheading-1">
                                <h4 class="panel-title accordion-toggle defa_panels">Return Quantity</h4>
                            </div>
                            <div class="panel-collapse collapse" id="collapseOne" style="height: 0px;">
                                <div class="panel-body bgcolr">
                                    <div class="col-lg-12">
                                        <div class="table-responsive top-30">
                                            <table class="table" style=" margin-bottom:0px;" id="workorderTable">
                                                <thead>
                                                <tr>
                                                    <th>Code</th>
                                                    <th>Desc</th>
                                                    <th>Qty</th>
                                                    <th>Unit</th>
                                                    <th>Rate</th>
                                                    <th>Amount</th>
                                                    <th>F/C</th>
                                                    <th>Remarks</th>
                                                    <th>Issue A/C</th>
                                                    <th>Purchase A/C</th>
                                                    <th>&nbsp;</th>
                                                    <th>&nbsp;</th>

                                                </tr>
                                                </thead>
                                                <tbody class="main"></tbody>
                                            </table>
                                            <input type="hidden" name="rowid" id="rowid" value="0"/>
                                        </div>
                                        <div class="cont_bt col-lg-5 col-lg-offset-7 col-md-9 col-md-offset-3 col-sm-7 col-sm-offset-5 col-xs-7 col-xs-offset-5">
                                            <ul>
                                                <li><a href="javascript:nextAccordian(2)">Continue &nbsp;<i class="fa fa-chevron-circle-right"></i></a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <?php }?>

                    <!-------------------------------Bill of Quantities end------------------------------->
                    <!-------------------------------Terms and Condition------------------------------->

                    <div class="panel panel-info">
                        <div data-target="#collapseTwo" data-parent="#accordion" data-toggle="collapse" class="panel-heading collapsed panel_heads" id="panelheading-2">
                            <h4 class="panel-title accordion-toggle defa_panels">Other Details</h4>
                        </div>
                        <div class="panel-collapse collapse" id="collapseTwo" style="height: 0px;">
                            <div class="panel-body bgcolr">
                                <div class="clearfix"></div>
                                <div class="col-lg-12">
                                    <div class="card">
                                        <ul class="nav nav-tabs">
                                            <li><a href="#Note" aria-controls="settings" role="tab" data-toggle="tab">Narration</a></li>
                                        </ul>
                                        <div class="tab-pane" id="Note">
                                            <p>
                                            <div class="col-lg-12">
                                                <?php
                                                if($Narration != ''){
                                                    ?>
                                                    <textarea class="exp-tex" name="Notes" id="Notes"> <?php echo ($Narration != '') ? $Narration : 'Enter Your Notes.......';?> </textarea>
                                                <?php }else{ ?>
                                                    <textarea class="exp-tex" name="Notes" id="Notes" placeholder="Enter your Notes..."></textarea>
                                                <?php } ?>
                                            </div>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-------------------------------Terms and Condition------------------------------->
            <div class="clearfix"></div>
    </div>
</div>
<div id="Question"></div>
<div class="col-lg-12 savebtn_area">
    <ul>
        <li class="dropdown save_btn float_r"><a type="button" onclick="validate(this);" data-toggle="tooltip" id="sub1" class="ripple" name="Submit" title="Submit" value="Submit">Submit</a></li>
        <li class="cancel_btn float_r">
			<?php if(isset($Approve) && $Approve=="N"): ?>
				<a href="<?php echo $this->basePath();?>/mms/issue/issue-register" data-toggle="tooltip" class="ripple" title="Go to Register!">Close</a>
			<?php elseif (isset($Approve) && $Approve=='P'): ?>
				<a href="<?php echo $this->basePath();?>/mms/issue/issue-register" data-toggle="tooltip" class="ripple" title="Go to Register!">Back</a>
			<?php else: ?>
				<a href="<?php echo $this->basePath();?>/mms/issue/save" data-toggle="tooltip" class="ripple" title="Close!">Close</a>
			<?php endif; ?>
		</li>
    </ul>
</div>
</form>
</div>
<!-- stock details for desc -->
<!-------------------------------------------------------------------------------------->
<script id="resource-template"  type="text/template" class="hide">
    <?php if($issue=="issue"){

        $displayscreen="display:show";
        $displaymaintr= "";
        if($gridtype == 1) {
            $displayscreen="display:none";
            $displaymaintr="mainTr";
         }
    ?>
    <tr id="click__" onclick="clickTr(this);" class="count-tr">
        <td class="mar_20" width="9%">
            <input class="parent_text border-none" type="text" name="code__" id="code__" readonly/></td>
        <td width="15%">
            <input class="parent_text resourceSuggest" type="text" name="desc__" id="desc__" onfocus="checkResourceUsed(this);"/>
            <input type="hidden" name="resourceid__" id="resourceid__"/>
            <input type="hidden" name="itemid__" id="itemid__"/>
        </td>
        <td width="10%">
            <select data-placeholder="" class="form-control single_dropdown lbl_box sortoption tbl_input changeVal" name="FC__" id="FC__">
                <option value="C">Chargeable</option>
                <option value="F">Free</option>
            </select>
        </td>
        <td width="8%">
            <input class="parent_text border-none" type="text" name="unitname__" id="unitname__" readonly/>
            <input type="hidden" name="unitid__" id="unitid__"/>
        </td>
        <td width="12%" style="margin-bottom:5px;">
            <textarea class="expnd_box ta <?php echo $displaymaintr; ?>" style="text-align:right"  name="qty__" id="qty__" onkeypress="isqtyDecimal(event,this,'mqty')" onkeyup="Rate(this);" onblur="return FormatNum(this, 3, true)" ></textarea><span id="stock__" data-stock="" class="qty"></span>
            <input type="hidden" name="hiddenqty__" id="hiddenqty__"/>
        </td>
        <td width="8%"><input class="tbl_input changeVal" style="text-align:right" type="text" name="rate__" id="rate__" onKeyPress="return isDecimal(event,this);"  onblur="return FormatNum(this, 2, true)" onkeyup="Rate(this);" /></td>
        <td width="9%"><input class="tbl_input changeVal" readonly  type="text" style="text-align:right"  name="amount__" id="amount__" /></td>
        <td width="8%"><input class="tbl_input changeVal" type="text" name="remarks__" id="remarks__" /></td>
        <td width="10%"><select data-placeholder="" class="form-control single_dropdown lbl_box sortoption tbl_input changeVal" name="issueAccount__" id="issueAccount__">
            </select></td>
        <td width="10%"><select data-placeholder="" class="form-control single_dropdown lbl_box sortoption tbl_input changeVal" name="PurchaseAccount__" id="PurchaseAccount__">
            </select></td>
        <td width="5%" align="center" class="action_btns_td">
            <ul class="action_btns">
                <li> <a  id="deleteTr__" style="display:none;cursor:pointer;"  onclick="deleteRow(this);"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top"   data-original-title="Delete"></i> </a> </li>
                <li> <a  class="mainTr" id="expandTr__" style="display:none;cursor:pointer;"> <i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="left" data-original-title="Add lines" ></i></a> </li>
            </ul>
        </td>
    </tr>

    <tr style="<?php echo $displayscreen; ?>;" id="click1__"  class="subTr count-tr">
        <td colspan="12" style="padding:0px !important; ">
            <div id="subMaintd__" class="subDiv" style="<?php echo $displayscreen; ?>;">
                <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;">
                    <div class="card">
                        <ul class="nav nav-tabs">
                            <li class="active"><a class="ripple has-ripple" id="decisionTabLink__" onclick="showtabs('decision',this.id,event)" style="position: relative; overflow: hidden;cursor:pointer;"> WBS<span class="ripple-wrapper animated" style="width: 89px; height: 89px; top: -41.5px; left: 22.9531px;"></span></a></li>
                            <li class=""><a class="ripple has-ripple" style="display:none;" id="whTableLink__" onclick="showtabs('wh',this.id,event)" style="position: relative; overflow: hidden;cursor:pointer;"> Warehouse<span class="ripple-wrapper animated"></span></a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-12">
                    <div class="scrl">
                        <div class="tab-content">
                            <div class="table-responsive topsp">
                                <table class="table" style="margin-bottom:0px;" id="iowTable__">
                                    <thead>
                                    <tr>
                                        <th width="48%" class="sub_tbl3">WBS Name</th>
                                        <th width="49%" class="sub_tbl3">WBS Qty</th>
                                        <th width="4%" class="sub_tbl3">&nbsp;</th>
                                    </tr>
                                    </thead>
                                    <tbody class="main"></tbody>
                                    <tbody class="total">
                                    <tr>
                                        <td width="10%">
                                            <input class="parent_text border-none" type="hidden" name="totalqty__" id="totalqty__" readonly/>
                                        </td>
                                    </tr>
                                    </tbody>
                                    <input type="hidden" name="iow___rowid" id="iow___rowid" value="0"/>
                                </table>
                                <table class="table" style="margin-bottom:0px; display:none;" id="whTable__">
                                    <thead>
                                    <tr>
                                        <th class="worktype-activity sub_tbl2">Warehouse Name </th>
                                        <th class="worktype-activity sub_tbl2">Description </th>
                                        <th class="worktype-activity sub_tbl2">ClosingStock </th>
                                        <th class="worktype-activity sub_tbl2">Qty </th>
                                        <th class="worktype-activity sub_tbl2" style="display: none;">&nbsp;</th>
                                    </tr>
                                    </thead>
                                    <tbody class="main"></tbody>
                                    <tbody class="total">
                                    </tbody>
                                    <input type="hidden" name="wh___rowid" id="wh___rowid" value="0"/>
                                </table>
                                <div class="tab-content">
                                    <div class="table-responsive topsp">
                                        <table class="table" style="margin-bottom:0px; display: none;" id="reqspeTable__">
                                            <tbody class="main"></tbody>
                                            <tbody class="total">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </td>
    </tr>
</script>

<script id="iow-warehouse"  type="text/template" class="hide">
    <tr class="subTr dont-hide">
        <td width="25%">
            <input  type="text" name="wh___warehousename_0" id="wh___warehousename_0" />
            <input type="hidden" name="wh___warehouseid_0" id="wh___warehouseid_0"/>
            <input  type="hidden" name="wh___stockid_0" id="wh___stockid_0" />
        </td>
        <td width="25%">
            <input  type="text" name="wh___desc_0" id="wh___desc_0" readonly/>
        </td>
        <td width="25%">
            <input  type="text" name="wh___closingstock_0" id="wh___closingstock_0"  readonly/>
        </td>
        <td width="25%">
            <input class="parent_text chqty" type="text" name="wh___qty_0" id="wh___qty_0" style="text-align: right;" onkeypress="return isDecimal(event,this);" onblur="return FormatNum(this, 3, true)" onchange="checkWHQuantity(this);" />
            <input type="hidden" name="iow__hiddenqty_0" id="iow__hiddenqty_0" value="0"/>
        </td>
    </tr>
</script>
<script id="wbs-warehouse"  type="text/template" class="hide">
    <tr class="subTr dont-hide">
        <td width="20%">
            <input  type="text" name="wh___wbs_0_warehousename__7" id="wh___wbs_0_warehousename__7" />
            <input type="hidden" name="wh___wbs_0_warehouseid__7" id="wh___wbs_0_warehouseid__7"/>
            <input  type="hidden" name="wh___wbs_0_stockid__7" id="wh___wbs_0_stockid__7" />
        </td>
        <td width="20%">
            <input  type="text" name="wh___wbs_0_desc__7" id="wh___wbs_0_desc__7" readonly/>
        </td>
        <td width="20%">
            <input  type="text" name="wh___wbs_0_closingstock__7" id="wh___wbs_0_closingstock__7"  readonly/>
        </td>
        <td width="20%">
            <input class="parent_text chqty" type="text" name="wh___wbs_0_qty__7" id="wh___wbs_0_qty__7" style="text-align:right;" onkeypress="return isDecimal(event,this);" onblur="return FormatNum(this, 3, true)" onchange="checkWWHQty(this);" />
            <input type="hidden" name="wh___wbs_0_hiddenqty__7" id="wh___wbs_0_hiddenqty__7" value="0"/>
        </td>
    </tr>
</script>
<script id="iow-template"  type="text/template" class="hide">
    <tr class="dont-hide">
        <td width="30%">
            <input type="hidden"  name="iow___wbsid_0" id="iow___wbsid_0" readonly/>
            <input class="parent_text border-none" type="text" name="iow___wbsname_0" id="iow___wbsname_0" readonly/>
        </td>
        <td width="25%">
            <input class="parent_text" type="text" style="text-align:right;" name="iow___qty_0" id="iow___qty_0" onkeypress="return isqtyDecimal(event,this,'iowqty')" onblur="return FormatNum(this, 3, true)" />
            <input type="hidden" name="iow___hiddenqty_0" id="iow___hiddenqty_0" value="0"/>
        </td>
        <td width="5%" align="center" class="action_btns_td iow_1_requestfields">
            <ul class="action_btns">
                <li><a href="" class="mainTr wwBox" id="expandTr__"> <i class="fa fa-chevron-circle-down" data-toggle="modal" data-target="#myModal" data-placement="left"></i></a> </li>
            </ul>
        </td>
    </tr>

    <tr style="display:none;" class="subTr dont-hide" id="iow___request_0_trwbsid">
        <td colspan="9" style="padding:0px !important;">
            <div class="subDiv" style="display:none;">
                <div class="table-responsive topsp">
                    <table class="table" style="margin-bottom:0px;" id="whTable___wbs_0_whreqno">
                        <thead>
                        <tr>
                            <th class="worktype-activity sub_tbl2">Warehouse Name </th>
                            <th class="worktype-activity sub_tbl2">Description </th>
                            <th class="worktype-activity sub_tbl2">ClosingStock </th>
                            <th class="worktype-activity sub_tbl2">Qty </th>
                            <th class="sub_tbl2" style="display: none;">&nbsp;</th>
                        </tr>
                        </thead>
                        <tbody class="ware"></tbody>
                        <tbody class="total">
                        </tbody>
                    </table>
                    <input type="hidden" name="wh___wbs_0_wrowid" id="wh___wbs_0_wrowid" value="0"/>
                </div>
            </div>
        </td>
    </tr>
</script>
<script id="techtitle-template"  type="text/template" class="hide">
    <tr class="dont-hide">
        <td width="15%"><input class="parent_text" type="text" name="techTitle__" id="techTitle__" maxlength="155" onchange="addNewTechRow(this)"/></td>
        <td width="15%"><textarea class="parent_texts" name="techDesc__" id="techDesc__"></textarea></td>
        <td width="4%" class="action_btns_td">
            <ul class="action_btns">
                <li style="float:left;"> <a href="#" class="deleteTechTr__" onclick="deleteTech(this, event);" style="display: none;"><span data-toggle="tooltip" data-placement="left" data-original-title="Term Delete"><i class="fa fa-trash-o"></i></span></a> </li>
            </ul>
        </td>
    </tr>
    <?php } else {
    $displayscreen="display:none";
    $displaymaintr="mainTr";
    if($gridtype == 1) {
        $displayscreen="display:none";
        $displaymaintr="mainTr";
    }
    ?>
    <tr id="click__" class="count-tr">
        <td class="mar_20" width="9%"><input class="parent_text border-none" type="text" name="code__" id="code__" readonly/></td>
        <td width="15%">
            <input class="parent_text resourceSuggest" type="text" name="desc__" id="desc__" onfocus="checkResourceUsed(this);"/>
            <input type="hidden" name="resourceid__" id="resourceid__"/>
            <input type="hidden" name="itemid__" id="itemid__"/>
        </td>
        <td width="12%" style="margin-bottom:5px;">
            <textarea class="expnd_box  <?php echo $displaymaintr; ?>" name="qty__" id="qty__"  onkeypress="return isqtyDecimal(event,this,'mqty')" onblur="return FormatNum(this, 3, true)" readonly ></textarea>
        </td>
        <td width="8%">
            <input class="parent_text border-none" type="text" name="unitname__" id="unitname__" readonly/>
            <input type="hidden" name="unitid__" id="unitid__"/>
        </td>
        <td width="8%"><input class="tbl_input changeVal" type="text" style="text-align:right" name="rate__" id="rate__" onKeyPress="return isDecimal(event,this);" onblur="return FormatNum(this, 2, true)" onkeyup="Rate(this);" /></td>
        <td width="9%"><input class="tbl_input changeVal" readonly style="text-align:right" type="text" name="amount__" id="amount__" /></td>
        <td width="10%"><select data-placeholder="" class="form-control single_dropdown lbl_box sortoption tbl_input changeVal" name="FC__" id="FC__">
                <option value="C">Chargeable</option>
                <option value="F">Free</option></select></td>

        <td width="8%"><input class="tbl_input changeVal" type="text" name="remarks__" id="remarks__" /></td>
        <td width="10%"><select data-placeholder="" class="form-control single_dropdown lbl_box sortoption tbl_input changeVal" name="issueAccount__" id="issueAccount__">
            </select></td>
        <td width="10%"><select data-placeholder="" class="form-control single_dropdown lbl_box sortoption tbl_input changeVal" name="PurchaseAccount__" id="PurchaseAccount__">
            </select></td>
        <td width="9%" align="center" class="action_btns_td">
            <ul class="action_btns">
                <li> <a id="deleteTr__" style="display:none;cursor:pointer;"  onclick="deleteRow(this);"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top"   data-original-title="Delete"></i> </a> </li>
                <li> <a class="mainTr" id="expandTr__" style="display:none;cursor:pointer;"> <i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="left" data-original-title="Add lines" ></i></a> </li>
            </ul>
        </td>
    </tr>

    <tr id="subTr__"style="<?php echo $displayscreen; ?>;" class="subTr count-tr">
        <td colspan="12" style="padding:0px !important; ">
            <div id="subMaintd__" class="subDiv" style="<?php echo $displayscreen; ?>;">
                <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;">
                    <div class="card">
                        <ul class="nav nav-tabs">
                            <li class="active"><a class="ripple has-ripple" id="decisionTabLink__" onclick="navtabs('decision',this.id,event)" style="position: relative; overflow: hidden;cursor:pointer;"> Return<span class="ripple-wrapper animated" style="width: 89px; height: 89px; top: -41.5px; left: 22.9531px;"></span></a></li>
<!--                            <li class=""><a class="ripple has-ripple" id="whTableLink__" onclick="navtabs('wh',this.id,event)" style="position: relative; overflow: hidden;cursor:pointer;"> Warehouse<span class="ripple-wrapper animated"></span></a></li>-->
                        </ul>
                    </div>
                </div>
                <div class="col-lg-12">
                    <div class="tab-content">
                        <div class="table-responsive topsp">
                            <table class="table" style="margin-bottom:0px;" id="iowTables__">
                                <thead>
                                <tr>
                                    <th class="sub_tbl3" width="20%">IssueNo</th>
                                    <th class="sub_tbl3" width="20%">IssueDate</th>
                                    <th class="sub_tbl3" width="10%">IssueQty</th>
                                    <th class="sub_tbl3" width="10%">BalIssueQty</th>
                                    <th class="sub_tbl3" width="10%">Rate</th>
                                    <th class="sub_tbl3" width="20%">ReturnQty</th>
                                    <th class="sub_tbl3" width="10%">AdjustmentQty</th>
                                    <th class="sub_tbl3" width="10%">&nbsp;</th>
                                </tr>
                                </thead>
                                <tbody class="main"></tbody>
                                <tbody class="total">
                                <tr>
                                    <td width="10%">
                                        <input class="parent_text border-none" type="hidden" name="totalqty__" id="totalqty__" readonly/>
                                    </td>
                                </tr>
                                </tbody>
                                <input type="hidden" name="iow___rowid" id="iow___rowid" value="0"/>
                            </table>

<!--                            <table class="table" style="margin-bottom:0px; display:none;" id="whTables__">-->
<!--                                <thead>-->
<!--                                <tr>-->
<!--                                    <th class="worktype-activity">Warehouse Name </th>-->
<!--                                    <th class="worktype-activity">Description </th>-->
<!--                                    <th class="worktype-activity">ClosingStock </th>-->
<!--                                    <th class="worktype-activity">Qty </th>-->
<!--                                    <th class="" style="display: none;">&nbsp;</th>-->
<!--                                </tr>-->
<!--                                </thead>-->
<!--                                <tbody class="main"></tbody>-->
<!--                                <tbody class="total">-->
<!--                                </tbody>-->
<!--                                <input type="hidden" name="wh___rowid" id="wh___rowid" value="0"/>-->
<!--                            </table>-->
                        </div>
                    </div>
                </div>
            </div>
        </td>
    </tr>
</script>
<!--<script id="iow-warehouse"  type="text/template" class="hide">-->
<!--    <tr class="subTr">-->
<!--        <td width="20%">-->
<!--            <input  type="text" name="wh___warehousename_0" id="wh___warehousename_0" />-->
<!--            <input type="hidden" name="wh___warehouseid_0" id="wh___warehouseid_0"/>-->
<!--            <input  type="hidden" name="wh___stockid_0" id="wh___stockid_0" />-->
<!--        </td>-->
<!--        <td width="20%">-->
<!--            <input  type="text" name="wh___desc_0" id="wh___desc_0" readonly/>-->
<!--        </td>-->
<!--        <td width="20%">-->
<!--            <input  type="text" name="wh___closingstock_0" id="wh___closingstock_0"  readonly/>-->
<!--        </td>-->
<!--        <td width="20%">-->
<!--            <input class="parent_text chqty" type="text" name="wh___qty_0" id="wh___qty_0" style="text-align: right;" onkeypress="return isDecimal(event,this);" onchange="checkWHQuantity(this);" />-->
<!--            <input type="hidden" name="iow__hiddenqty_0" id="iow__hiddenqty_0" value="0"/>-->
<!--        </td>-->
<!--    </tr>-->
<!--</script>-->
<script id="issue-warehouse"  type="text/template" class="hide">
    <tr class="subTr dont-hide">
        <td width="10%">
            <input  type="text" name="wh___wbs_0_warehousename__7" id="wh___wbs_0_warehousename__7" />
            <input type="hidden" name="wh___wbs_0_warehouseid__7" id="wh___wbs_0_warehouseid__7"/>
            <input  type="hidden" name="wh___wbs_0_stockid__7" id="wh___wbs_0_stockid__7" />
        </td>
        <td width="10%">
            <input  type="text" name="wh___wbs_0_desc__7" id="wh___wbs_0_desc__7" readonly/>
        </td>
        <td width="10%">
            <input  type="text" name="wh___wbs_0_issueqty__7" id="wh___wbs_0_issueqty__7" readonly/>
        </td>
        <td width="10%">
            <input  type="text" name="wh___wbs_0_bissueqty__7" id="wh___wbs_0_bissueqty__7" readonly/>
        </td>
        <td width="10%">
            <input class="parent_text chqty" type="text" name="wh___wbs_0_qty__7" id="wh___wbs_0_qty__7" style="text-align:right;" onkeypress="return isDecimal(event,this);" onblur="return FormatNum(this, 3, true)" onchange="checkIssueWHQty(this);" />
            <input type="hidden" name="wh___wbs_0_hiddenqty__7" id="wh___wbs_0_hiddenqty__7" value="0"/>
        </td>
        <td width="10%">
            <input class="parent_text chqty" type="text" name="wh___wbs_0_adqty__7" id="wh___wbs_0_adqty__7" style="text-align:right;" onkeypress="return isDecimal(event,this);" onblur="return FormatNum(this, 3, true)" onchange="checkAdjustQty(this);" />
            <input type="hidden" name="wh___wbs_0_hiddenadqty__7" id="wh___wbs_0_hiddenadqty__7" value="0"/>
        </td>
    </tr>
</script>
<script id="iow-template"  type="text/template" class="hide">
    <tr class="dont-hide">
        <td width="10%"><input class="parent_text" type="text"  name="iow___issueNo_0"  id="iow___issueNo_0" readonly/>
            <input class="parent_text" type="hidden"  name="iow___TransId_0"  id="iow___TransId_0" />
        </td>
        <td width="15%">
            <div class="col-lg-12 padlr0">
                <input class="tbl_input date_picker" type="text" name="iow___IssueDate_0" id="iow___IssueDate_0" readonly/>
                <span class="date_icon"><i class="fa fa-calendar"></i></span>
            </div>
        </td>
        <td width="15%"><input class="parent_text" type="text" style="text-align:right" name="iow___IssueQty_0" id="iow___IssueQty_0" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 3, true)" /></td>
        <td width="15%"><input class="parent_text" type="text" style="text-align:right" name="iow___BalQty_0" id="iow___BalQty_0" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 3, true)" /></td>
        <td width="15%"><input class="parent_text" type="text" style="text-align:right" name="iow___Rate_0" id="iow___Rate_0" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 2, true)" /></td>
        <td width="15%"><input class="parent_text mainTr" type="text" style="text-align:right"  name="iow___ReturnQty_0" id="iow___ReturnQty_0" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 3, true)" onfocus="checkWarehouse(this);" readonly/></td>
        <td width="10%"><input class="parent_text" type="text" style="text-align:right" name="iow___AdjustmentQty_0" id="iow___AdjustmentQty_0" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 3, true)" readonly /></td>
        <td width="5%" align="center" class="action_btns_td">
            <ul class="action_btns">
                <li> <a class="mainTr" id="expandwTr__" style="display:none;cursor:pointer;"> <i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="left" data-original-title="Add lines" ></i></a> </li>
            </ul>
        </td>
    </tr>

      <tr style="display:none;" class="subTr  dont-hide" id="iow___request_0_trwbsid">
        <td colspan="9" style="padding:0px !important;">
            <div class="subDiv" style="display:none;">
                <div class="table-responsive topsp">
                    <table class="table" style="margin-bottom:0px;" id="whTable___wbs_0_whreqno">
                        <thead>
                        <tr>
                            <th class="worktype-activity sub_tbl2">Warehouse Name </th>
                            <th class="worktype-activity sub_tbl2">Description </th>
                            <th class="worktype-activity sub_tbl2">IssueQty </th>
                            <th class="worktype-activity sub_tbl2">BalIssueQty </th>
                            <th class="worktype-activity sub_tbl2">Qty </th>
                            <th class="worktype-activity sub_tbl2">AdjustmentQty</th>
                            <th class="sub_tbl2" style="display: none;">&nbsp;</th>
                        </tr>
                        </thead>
                        <tbody class="ware"></tbody>
                        <tbody class="total">
                        </tbody>

                    </table>
                    <input type="hidden" name="wh___wbs_0_wrowid" id="wh___wbs_0_wrowid" value="0"/>
                </div>
            </div>
        </td>
    </tr>
</script>

<script id="techtitle-template"  type="text/template" class="hide">
    <tr class="dont-hide">
        <td width="15%"><input class="parent_text" type="text" name="techTitle__" id="techTitle__" maxlength="155" onchange="addNewTechRow(this)"/></td>
        <td width="15%"><textarea class="parent_texts" name="techDesc__" id="techDesc__"></textarea></td>
        <td width="4%" class="action_btns_td">
            <ul class="action_btns">
                <li style="float:left;"> <a href="#" class="deleteTechTr__" onclick="deleteTech(this, event);" style="display: none;"><span data-toggle="tooltip" data-placement="left" data-original-title="Term Delete"><i class="fa fa-trash-o"></i></span></a> </li>
            </ul>
        </td>
    </tr>
    <?php }?>
</script>
<link rel="stylesheet" href="<?php echo $this->basePath() . '/css/paging.css';?>"/>
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/js/paging.js"></script>
<script type="text/javascript">
var arr_resources = <?php echo (isset($arr_resources)) ? json_encode($arr_resources) : '[]';?>;
var tmp_arr_resources = arr_resources;
var arr_wbs = <?php echo (isset($arr_res_wbs)) ? json_encode($arr_res_wbs) : '[]';?>;
var issue = <?php echo (isset($issue)) ? json_encode($issue) : '';?>;
var arr_requestResources = <?php echo (isset($arr_requestResources)) ? json_encode($arr_requestResources) : '[]';?>;
var arr_accountType = <?php echo (isset($arr_accountType)) ? json_encode($arr_accountType) : '[]';?>;
var arr_resource_iows = <?php echo (isset($arr_resource_iows)) ? json_encode($arr_resource_iows) : '[]';?>;
var arr_sel_warehouse = <?php echo (isset($arr_sel_warehouse)) ? json_encode($arr_sel_warehouse) : '[]';?>;
var arr_wbs_warehouse = <?php echo (isset($arr_wbs_warehouse)) ? json_encode($arr_wbs_warehouse) : '[]';?>;
var arr_selwbs_warehouse = <?php echo (isset($arr_selwbs_warehouse)) ? json_encode($arr_selwbs_warehouse) : '[]';?>;
var arr_resel_warehouse = <?php echo (isset($arr_resel_warehouse)) ? json_encode($arr_resel_warehouse) : '[]';?>;
var arr_resel_iswarehouse = <?php echo (isset($arr_resel_iswarehouse)) ? json_encode($arr_resel_iswarehouse) : '[]';?>;
var arr_resource_closingstock = <?php echo (isset($arr_resource_closingstock)) ? json_encode($arr_resource_closingstock) : '[]';?>;
var mode = <?php echo $IssueRegisterId; ?>;


if(issue == "issue") {
    ///////////////////////////////////////////   ISSUE     /////////////////////////////////////
    $(function () {
        var $rowid = $('#rowid');
        var template = $('#resource-template').html();
        var iowtemplate = $('#iow-template').html();
        var waretemplate = $('#iow-warehouse').html();
        var requestTemplate = $('#wbs-warehouse').html();
        var rowid = 0;
        var $tbody = $('#workorderTable').find('> tbody.main');

        if (arr_requestResources.length != 0) {
            $.each(arr_requestResources, function (i, o) {
                rowid += 1;
                $tbody.append(template.replace(/__/g, '_' + rowid));
                var opt = '<option></option>';
                if (arr_accountType.length > 0) {
                    $.each(arr_accountType, function (j, p) {
                        opt += '<option value="' + p.TypeId + '">' + p.Typename + '</option>';
                    });
                }
                $('#PurchaseAccount_' + rowid).html(opt);
                $('#issueAccount_' + rowid).html(opt);

                $('#code_' + rowid).val(o.Code).addClass('border-none').prop('disabled', false);
                $('#desc_' + rowid).val(o.ResourceName).addClass('border-none').prop('disabled', false);
                $('#resourceid_' + rowid).val(o.ResourceId);
                $('#itemid_' + rowid).val(o.ItemId);
                $('#rate_' + rowid).val(sanitizeNumber(o.Rate,2,true));
                if (typeof(o.PurchaseAccount) != 'undefined') {
                    $('#PurchaseAccount_' + rowid).val(o.PurchaseAccount).trigger('change');
                }
                if (typeof(o.issueAccount) != 'undefined') {
                    $('#issueAccount_' + rowid).val(o.issueAccount).trigger('change');
                }
                if (typeof(o.rate) != "undefined") {
                    $('#rate_' + rowid).val(sanitizeNumber(o.rate,2,true));
                }
                if (typeof(o.Amount) != "undefined") {
                    $('#amount_' + rowid).val(sanitizeNumber(o.Amount,2,true));
                }
                if (typeof(o.Remarks) != "undefined") {
                    $('#remarks_' + rowid).val(o.Remarks);
                }
                if (typeof(o.Qty) != "undefined") {
                    $('#qty_' + rowid).val(sanitizeNumber(o.Qty,3,true));
                }

                if(typeof(o.HiddenQty) != "undefined")
                {
                    $('#hiddenqty_' + rowid).val(sanitizeNumber(o.Qty,3,true));
                }
                if (typeof(o.FreeOrCharge) != "undefined") {
                    $('#FC_' + rowid).val(o.FreeOrCharge);
                }
                $('#unitname_' + rowid).val(o.UnitName);
                $('#unitid_' + rowid).val(o.UnitId);
                $('#expandTr_' + rowid).show();
                $('#deleteTr_' + rowid).show();

                //ClosingStock
                if(arr_resource_closingstock.length != 0) {
                    var findClstock = arr_resource_closingstock.filter(function(obj) {
                        return (obj.ResourceId === o.ResourceId && obj.ItemId === o.ItemId);
                    });
                    if(findClstock.length > 0) {
                        $.each(arr_resource_closingstock, function (s, t) {
                            if (o.ResourceId != t.ResourceId || o.ItemId != t.ItemId) {
                                return;
                            }
                            $('#qty_' + rowid).next('span').html('closing Stock: ' + sanitizeNumber(t.Qty,3,true));
                            $('#qty_' + rowid).next('span').attr('data-stock', sanitizeNumber(t.Qty,3,true));
                        });
                    }
                }
                //
                var wbsCount = 0;
                var whsCount = 0;

                $.each(arr_resource_iows, function (j, l) {
                    var findRes = arr_wbs.filter(function(obj) {
                        return (obj.ResourceId === o.ResourceId && obj.WBSId === l.WBSId);
                    });
                    if(findRes.length > 0) {
                        wbsCount = wbsCount + 1;
                        if(mode != 0) { // Edit Section
                            //if (l.ResourceId == o.ResourceId && l.ItemId == o.ItemId) { // edit mode -issue
                                var iowrowid = parseInt($('#iow_' + rowid + '_rowid').val()) + 1;
                                $('#iowTable_' + rowid).find('tbody.main').append(iowtemplate.replace(/__/g, '_' + rowid).replace(/_0/g, '_' + iowrowid));
                                $('#iow_' + rowid + '_rowid').val(iowrowid);
                                $('#iow_' + rowid + '_wbsid_' + iowrowid).val(l.WBSId);
                                $('#iow_' + rowid + '_wbsname_' + iowrowid).val(l.WbsName);
                                $('#iow_' + rowid + '_qty_' + iowrowid).val(sanitizeNumber(l.Qty,3,true));
                                $('#iow_' + rowid + '_hiddenqty_' + iowrowid).val(sanitizeNumber(l.HiddenQty,3,true));

                                // start wbs-warehouse
                                if (arr_wbs_warehouse.length != 0) {
                                    var findWHH11 = arr_wbs_warehouse.filter(function (obj) {
                                        return (obj.ResourceId === o.ResourceId && obj.ItemId === o.ItemId);
                                    });
                                    if(findWHH11.length == 0){
                                        $('.wwBox').hide();
                                        //$('#whTable_' + rowid + '_wbs_' + iowrowid + '_whreqno').hide();
                                        $('#iow_' + rowid + '_qty_' + iowrowid).attr('onchange', 'calcQuantity(this)');
                                        $('#iow_' + rowid + '_qty_' + iowrowid).prop("readonly", false);
                                    } else{
                                        $.each(arr_wbs_warehouse, function (m, n) {
                                            if (o.ResourceId != n.ResourceId || o.ItemId != n.ItemId ) {
                                                return;
                                            }
                                            var whrowid = parseInt($('#wh_' + rowid + '_wbs_' + iowrowid + '_wrowid').val()) + 1;

                                            $('#whTable_' + rowid + '_wbs_' + iowrowid + '_whreqno').find('> tbody.ware').append(requestTemplate
                                                .replace(/__7/g, '_' + whrowid)
                                                .replace(/_0/g, '_' + iowrowid)
                                                .replace(/__/g, '_' + rowid));

                                            $('#wh_' + rowid + '_wbs_' + iowrowid + '_wrowid').val(whrowid);
                                            $('#wh_' + rowid + '_wbs_' + iowrowid + '_warehouseid_' + whrowid).val(n.WareHouseId);
                                            $('#wh_' + rowid + '_wbs_' + iowrowid + '_warehousename_' + whrowid).val(n.WareHouseName);
                                            $('#wh_' + rowid + '_wbs_' + iowrowid + '_stockid_' + whrowid).val(n.StockId);
                                            $('#wh_' + rowid + '_wbs_' + iowrowid + '_desc_' + whrowid).val(n.Description);
                                            $('#wh_' + rowid + '_wbs_' + iowrowid + '_qty_' + whrowid).val(sanitizeNumber(n.Qty,3,true));
                                            $('#wh_' + rowid + '_wbs_' + iowrowid + '_closingstock_' + whrowid).val(sanitizeNumber(n.ClosingStock,3,true));
                                            $('#wh_' + rowid + '_wbs_' + iowrowid + '_hiddenqty_' + whrowid).val(sanitizeNumber(n.Qty,3,true));
                                            $.each(arr_selwbs_warehouse, function (s,t) {
                                                if (n.WareHouseId == t.WareHouseId && l.WBSId == t.AnalysisId && o.ResourceId == t.ResourceId && o.ItemId == t.ItemId && t.Qty>0) {
                                                    $('#wh_' + rowid + '_wbs_' + iowrowid + '_qty_' + whrowid).val(sanitizeNumber(t.Qty,3,true));
                                                }
                                            });
                                        });
                                    }
                                }
                                //end wbs-warehouse
                           // }
                        } else {
                               //Add Section
                            var iowrowid = parseInt($('#iow_' + rowid + '_rowid').val()) + 1;
                            $('#iowTable_' + rowid).find('tbody.main').append(iowtemplate.replace(/__/g, '_' + rowid).replace(/_0/g, '_' + iowrowid));
                            $('#iow_' + rowid + '_rowid').val(iowrowid);
                            $('#iow_' + rowid + '_wbsid_' + iowrowid).val(l.WBSId);
                            $('#iow_' + rowid + '_wbsname_' + iowrowid).val(l.WbsName);
                            $('#iow_' + rowid + '_qty_' + iowrowid).val(sanitizeNumber(l.Qty,3,true));
                            $('#iow_' + rowid + '_hiddenqty_' + iowrowid).val(l.HiddenQty);
                            // start wbs-warehouse

                            if (arr_sel_warehouse.length != 0) {
                                var findWHH = arr_sel_warehouse.filter(function (obj) {
                                    return (obj.ResourceId === o.ResourceId && obj.ItemId === o.ItemId);
                                });
                                if(findWHH.length == 0){
                                    $('.wwBox').hide();
                                    $('#iow_' + rowid + '_qty_' + iowrowid).attr('onchange', 'calcQuantity(this)');
                                    $('#iow_' + rowid + '_qty_' + iowrowid).prop("readonly", false);
                                } else{
                                    $.each(arr_sel_warehouse, function (m, n) {
                                        if (o.ResourceId != n.ResourceId || o.ItemId != n.ItemId ) {
                                            return;
                                        }
                                        var whrowid = parseInt($('#wh_' + rowid + '_wbs_' + iowrowid + '_wrowid').val()) + 1;
                                        $('#expandTr_' + rowid).show();
                                        $('#iow_' + rowid + '_request_' + iowrowid + '_trwbsid').addClass('subTr');
                                        $('#whTable_' + rowid + '_wbs_' + iowrowid + '_whreqno').find('> tbody.ware').append(requestTemplate
                                            .replace(/__7/g, '_' + whrowid)
                                            .replace(/_0/g, '_' + iowrowid)
                                            .replace(/__/g, '_' + rowid));

                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_wrowid').val(whrowid);
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_warehouseid_' + whrowid).val(n.WareHouseId);
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_warehousename_' + whrowid).val(n.WareHouseName);
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_stockid_' + whrowid).val(n.StockId);
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_desc_' + whrowid).val(n.Description);
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_qty_' + whrowid).val(sanitizeNumber(n.Qty,3,true)).attr('data-find', n.WareHouseId);
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_closingstock_' + whrowid).val(n.ClosingStock);
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_hiddenqty_' + whrowid).val(sanitizeNumber(n.Qty,3,true));

                                    });

                                }
                            } else  {
                                $('#whTable_' + rowid + '_wbs_' + iowrowid + '_whreqno').hide();
                                $('#iow_' + rowid + '_qty_' + iowrowid).attr('onchange', 'calcQuantity(this)');
                                $('#iow_' + rowid + '_qty_' + iowrowid).prop("readonly", false);
                            }
                        }
                        $('#iowTable_' + rowid).show();
                        $('#decisionTabLink_' + rowid).show();
                        $('#whTableLink_' + rowid).hide();
                        $('#whTable_' + rowid).hide();
                    }
                });
                if(wbsCount == 0) {
                    if(arr_sel_warehouse.length != 0) {
                        $.each(arr_sel_warehouse, function (m, n) {
                            if (o.ResourceId != n.ResourceId || o.ItemId != n.ItemId ) {
                                return;
                            }
                            whsCount = whsCount+1;
                            var whrowid = parseInt($('#wh_' + rowid + '_rowid').val()) + 1;
                            $('#whTable_' + rowid).find('> tbody.main').append(waretemplate
                                .replace(/__/g, '_' + rowid)
                                .replace(/_0/g, '_' + whrowid));

                            $('#wh_' + rowid + '_rowid').val(whrowid);
                            $('#wh_' + rowid + '_warehouseid_' + whrowid).val(n.WareHouseId);
                            $('#wh_' + rowid + '_warehousename_' + whrowid).val(n.WareHouseName);
                            $('#wh_' + rowid + '_stockid_' + whrowid).val(n.StockId);
                            $('#wh_' + rowid + '_desc_' + whrowid).val(n.Description);
                            $('#wh_' + rowid + '_qty_' + whrowid).val(sanitizeNumber(n.Qty,3,true));
                            $('#wh_' + rowid + '_closingstock_' + whrowid).val(sanitizeNumber(n.ClosingStock,3,true));
                            $('#wh_' + rowid + '_hiddenqty_' + whrowid).val(sanitizeNumber(n.Qty,3,true));
                        });
                    }
                    $('#iowTable_' + rowid).hide();
                    $('#decisionTabLink_' + rowid).hide();
                    $('#whTableLink_' + rowid).show();
                    $('#whTable_' + rowid).show();
                }

                if(whsCount == 0 && wbsCount == 0) {
                    $('#qty_' + rowid).attr('onkeypress','return isDecimal(event,this);');
                    $('#qty_' + rowid).attr('onchange','calcResQuantity(this)');
                    $('#expandTr_' + rowid).hide();
                    $('#iowTable_' + rowid).hide();
                    $('#decisionTabLink_' + rowid).hide();
                    $('#whTableLink_' + rowid).hide();
                    $('#whTable_' + rowid).hide();
                } else {
                    $('#qty_' + rowid).attr('readOnly','readOnly');
                }
                $('#subMaintd_' + rowid).hide();
            });
        }
        rowid += 1;
        $tbody.append(template.replace(/__/g, '_' + rowid));

        bindResourceAutocomplete();
        var opt = '<option></option>';
        if (arr_accountType.length > 0) {
            $.each(arr_accountType, function (j, p) {
                opt += '<option value="' + p.TypeId + '">' + p.Typename + '</option>';
            });
        }
        $('#PurchaseAccount_' + rowid).html(opt);
        $('#issueAccount_' + rowid).html(opt);
        var rowIdval = parseInt(arr_requestResources.length + 1);
        $('#rowid').val(rowIdval);

        $('.content_wrapper').on('click', '.mainTr', function (e) {
            e.preventDefault();
            if (!$(this).closest("tr").next(".subTr").is(":visible")) {
                $(this).closest("tr").next(".subTr").show();
                $(this).closest("tr").next(".subTr").find(".subDiv").slideDown("slow");
                $(this).find("i").addClass("tform");
            }
            else {
                $(this).closest("tr").next(".subTr").find(".subDiv").slideUp("slow");
                $(this).closest("tr").next(".subTr").slideUp("slow");
                $(this).find("i").removeClass("tform");
            }
        });

        nextAccordian(1);
        if('<?php echo (isset($gridtype)) ? $gridtype : '';?>' == 0) {
            $('#workorderTable').paging({limit: 2});
            $('.paging-nav').children('a[data-page=0]').trigger('click');
            $('#subMaintd_' + rowid).hide();
        }

    });
    function bindResourceAutocomplete() {
        // bind resource autocomplete
        $('#workorderTable .resourceSuggest').autocomplete({
            lookup: tmp_arr_resources,
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            }, onSelect: function (suggestion) {
                if (suggestion) {
                    var $this = $(this);
                    var rowid = $this[0].id.split('_')[1];
                    var reskeyid = $('input[id*=resourceid_] ');
                    var bRet=false;
                    $.each(reskeyid, function (i, obj) {
                        var $this = $(this),
                            name = $this[0].id;
                        var arrname = name.split('_');
                        var key1 = arrname[1];

                        if (key1 != rowid) {
                            if ($this.val() == suggestion.data && $('#itemid_' + key1).val() == suggestion.ItemId) {
                                bRet = true;
                            }
                        }
                    });
                    if(bRet == false) {
                        $this.prop('readonly', true).addClass('border-none');
                        $('#resourceid_' + rowid).val(suggestion.data);
                        $('#itemid_' + rowid).val(suggestion.ItemId);
                        $('#unitname_' + rowid).val(suggestion.UnitName);
                        $('#code_' + rowid).val(suggestion.Code);
                        $('#rate_' + rowid).val(sanitizeNumber(suggestion.Rate,2,true));
                        $('#unitid_' + rowid).val(suggestion.UnitId);
                        $('#expandTr_' + rowid).show();
                        bindResourceIOW($this);
                        addNewResourceRow($this);
                    } else {
                        alert('Already added in list');
                        $('#desc_' + rowid).val('');
                        return;
                    }
                }
            }, onSearchStart: function (suggestion) {
                var rowid = $(this)[0].id.split('_')[1];
                $('#unitname_' + rowid).val('');
                $('#rate_' + rowid).val('');
            }, onSearchComplete: function (query, suggestions) {
                if (!suggestions.length) {
                    var rowid = $(this)[0].id.split('_')[1];
                    $('#unitname_' + rowid).val('');
                    $('#rate_' + rowid).val('');
                }
            }
        });
    }

    function bindResourceIOW(x) {
        var rowid = $(x)[0].id.split('_')[1];
        var $iowrowid = $('#iow_' + rowid + '_rowid');
        var resourceId = $('#resourceid_' + rowid).val();
        var itemId = $('#itemid_' + rowid).val();
        var costcentre = $('#CostCentre').val();
        var issuedate = "<?php echo (isset($issue_date)) ? $issue_date : 0;?>";
        $('.loading_area').show();
        $.ajax({
            url: getBaseURL() + 'mms/issue/issueedit',
            type: "post",
            data: {'Type': 'getwbsdetails', 'ResourceId': resourceId,'ItemId': itemId, 'CostCentre': costcentre,'issuedate': issuedate},
            async: false,
            success: function (data, textStatus, jqXHR) {
                if (jqXHR.status == 200) {
                    data = JSON.parse(data);
                    var iowtemplate = $('#iow-template').html();
                    var requestTemplate = $('#wbs-warehouse').html();

                    $.each(data.arr_resource_iows, function (i, l) {
                        var findRes = arr_wbs.filter(function(obj) {
                            return (obj.ResourceId === resourceId && obj.WBSId === l.WBSId);
                        });
                        if(findRes.length > 0) {
                            var iowrowid = parseInt($iowrowid.val()) + 1;
                            $('#iowTable_' + rowid).find('tbody.main').append(iowtemplate.replace(/__/g, '_' + rowid).replace(/_0/g, '_' + iowrowid));
                            $iowrowid.val(iowrowid);
                            $('#iow_' + rowid + '_wbsname_' + iowrowid).val(l.WbsName);
                            $('#iow_' + rowid + '_wbsid_' + iowrowid).val(l.WBSId);
                            $('#iow_' + rowid + '_qty_' + iowrowid).val();


                            // start of warehouse
                            if (data.arr_sel_warehouse.length != 0) {
                                var findWHH1 = data.arr_sel_warehouse.filter(function (obj) {
                                    return (obj.ResourceId === resourceId && obj.ItemId === itemId);
                                });
                                if (findWHH1.length == 0) {
                                    $('.wwBox').hide();
                                    //$('#whTable_' + rowid + '_wbs_' + iowrowid + '_whreqno').hide();
                                    $('#iow_' + rowid + '_qty_' + iowrowid).attr('onchange', 'calcQuantity(this)');
                                    $('#iow_' + rowid + '_qty_' + iowrowid).prop("readonly", false);

                                } else {
                                    $.each(data.arr_sel_warehouse, function (m, n) {
                                        if (resourceId != n.ResourceId || itemId != n.ItemId) {
                                            return;
                                        }
                                        var whrowid = parseInt($('#wh_' + rowid + '_wbs_' + iowrowid + '_wrowid').val()) + 1;
                                        $('#whTable_' + rowid + '_wbs_' + iowrowid + '_whreqno').find('> tbody.ware').append(requestTemplate
                                            .replace(/__7/g, '_' + whrowid)
                                            .replace(/_0/g, '_' + iowrowid)
                                            .replace(/__/g, '_' + rowid));


                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_wrowid').val(whrowid);
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_warehouseid_' + whrowid).val(n.WareHouseId);
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_warehousename_' + whrowid).val(n.WareHouseName);
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_stockid_' + whrowid).val(n.StockId);
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_desc_' + whrowid).val(n.Description);
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_qty_' + whrowid).val(sanitizeNumber(n.Qty,3,true));
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_closingstock_' + whrowid).val(sanitizeNumber(n.ClosingStock,3,true));
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_hiddenqty_' + whrowid).val(sanitizeNumber(n.Qty,3,true));
                                    });
                                }
                            } else{
                                $('#whTable_' + rowid + '_wbs_' + iowrowid + '_whreqno').hide();
                                $('#iow_' + rowid + '_qty_' + iowrowid).attr('onchange', 'calcQuantity(this)');
                                $('#iow_' + rowid + '_qty_' + iowrowid).prop("readonly", false);
                            }
                        }
                    });

                    $.each(data.arr_auto_closingstock, function (i, q) {
                        var findclstock = data.arr_auto_closingstock.filter(function (obj) {
                            return (obj.ResourceId === resourceId && obj.ItemId === itemId);
                        });

                        if (findclstock.length > 0) {
                            if (resourceId != q.ResourceId || itemId != q.ItemId) {
                                return;
                            }
                            $('#qty_' + rowid).next('span').html('closing Stock: ' + sanitizeNumber(q.Qty,3,true));
                            $('#qty_' + rowid).next('span').attr('data-stock', sanitizeNumber(q.Qty,3,true));

                        }
                    });

                }
                $('.loading_area').hide();
            }, error: function (jqXHR, textStatus, errorThrown) {
                $('.loading_area').hide();
            }
        });
    }

    function addNewResourceRow(x) {
        var $tr = $(x).closest('tr');
        if ($tr.next('tr:not(.subTr)').length != 0)
            return;

        var $rowid = $('#rowid'),
            rowid = parseInt($rowid.val()),
            $tbody = $('#workorderTable').find('> tbody.main');

        $('#deleteTr_' + rowid).show();
        if('<?php echo (isset($gridtype)) ? $gridtype : '';?>' == 0) {
            $('#subMaintd_' + rowid).hide();
        }
        var count = rowid + 1,
            template = $('#resource-template').html();

        template = template.replace(/__/g, '_' + count);
        $tbody.append(template);
        if('<?php echo (isset($gridtype)) ? $gridtype : '';?>' == 0) {
            $('#subMaintd_' + count).hide();
        }
        $rowid.val(count);

        var opt;
        if (arr_accountType.length > 0) {
            opt +='<option value =""></option>';
            $.each(arr_accountType, function (j, p) {
                opt += '<option value="' + p.TypeId + '">' + p.Typename + '</option>';
            });
        }
        $('#PurchaseAccount_' + rowid).html(opt);
        $('#issueAccount_' + rowid).html(opt);

        bindResourceAutocomplete();
        if('<?php echo (isset($gridtype)) ? $gridtype : '';?>' == 0) {
            var f = parseInt($(".paging-nav").find('.selected-page').html()) - 1;
            $('.paging-nav').remove();
            thisVal._getNavBar($('#workorderTable').find('> tbody.main >tr'));
            setTimeout(function () {
                $('.paging-nav').children('a[data-page=' + f + ']').trigger('click');
            }, 100);
        }
    }

    function checkResourceUsed(x) {
        var id = $(x)[0].id.split('_')[1];
        var reskeyid = $('input[id*=resourceid_]');
        var itemkeyid=$('input[id*=itemid_]');
        tmp_arr_resources = arr_resources;
        tmp_arr_resources = $.grep(arr_resources, function (element, index) {
            var is_selected = true;
            $.each(reskeyid, function (i, obj) {
                var $this = $(this),
                    name = $this[0].id;
                var arrname = name.split('_');
                var key1 = arrname[1];
                if (key1 != id) {
                    if (element.data == $this.val() && itemkeyid[0].value == element.ItemId) {
                        is_selected = false;
                        return false;
                    }
                }
            });
            return is_selected;
        });
        bindResourceAutocomplete();
    }

    function nextAccordian(id) {
        $('#panelheading-' + id).trigger('click');
    }

    var errorFlag = 0;

    function calcQuantity(x) {
        var $x = $(x);
        var ids = $x[0].id.split('_');
        var rowid = ids[1];
        // calc total qty
        var totalQty = 0;
        var tothidden = 0;
        $.each($('input[id^=iow_' + rowid + '_qty_'), function (i, o) {
            var qty = parseFloatVal($(this).val());
            if (isNaN(qty))
                qty = 0;
            totalQty += qty;
        });
        totalQty = sanitizeNumber(totalQty,3,true);
        $.each($('input[id^=iow_' + rowid + '_hiddenqty_'), function (i, o) {
            var hqty = parseFloatVal($(this).val());
            if (isNaN(hqty))
                hqty = 0;
            tothidden += hqty;
        });
        var sVal = parseFloatVal($('#stock_' + rowid).attr('data-stock'));
        if (totalQty-tothidden > sVal) {
            showError($('#qty_' + rowid), "Greater than Closing Stock");
            errorFlag = 1;
        } else {
            removeError($('#qty_' + rowid));
            errorFlag = 0;
        }
        $('#qty_' + rowid).val(sanitizeNumber(totalQty,3,true));
        // calc total amount
        var rate = parseFloatVal($('#rate_' + rowid).val());
        $('#amount_' + rowid).val(sanitizeNumber(totalQty * rate,2,true));
        calcTotal();
    }

    function Rate(x) {
        var $x = $(x);
        var ids = $x[0].id.split('_');
        var rowid = ids[1];

        // calc total qty
        var totalQty = 0;
        $.each($('input[id^=iow_' + rowid + '_qty_'), function (i, o) {
            var qty = parseFloatVal($(this).val(),0);
            if (isNaN(qty))
                qty = 0;

            totalQty += qty;
        });
        totalQty = sanitizeNumber(totalQty,3,true);
        $('#qty_' + rowid).val(sanitizeNumber(totalQty,3,true));
        // calc total amount
        var rate = parseFloatVal($('#rate_' + rowid).val());
        $('#amount_' + rowid).val(sanitizeNumber(totalQty * rate,2,true));
        calcTotal();
    }

    function calcTotal() {
        var total = 0;
        $.each($('input[id^=amount_]'), function (i, o) {
            total += parseFloatVal($(this).val());
        });
        $('#total').val(sanitizeNumber(total,3,true));
    }

    function clickTr(val) {
        var id = ($(val).attr('id')).split('_');
        var resourceId = $('#resourceid_' + id[1]).val();
        var itemId = $('#itemid_' + id[1]).val();
        var CostCentre = $('#CostCentre').val();

        $.ajax({
            url: getBaseURL() + "mms/issue/issueedit",
            type: "post",
            data: "resourceId=" + resourceId + "&itemId=" + itemId + "&CostCentre=" + CostCentre + "&mode=Questions",
            success: function (data, textStatus, jqXHR) {
                if (data != 'false') {
                    var valu = JSON.parse(data);
//                    $('#qty_' + id[1]).closest('td').append('closing Stock: '+valu['ClosingStock']);
                    $('#qty_' + id[1]).next('span').html('closing Stock: ' + sanitizeNumber(valu['ClosingStock'],3,true));
                    $('#qty_' + id[1]).next('span').attr('data-stock', sanitizeNumber(valu['ClosingStock'],3,true));
                } else {
//                    $('#qty_' + id[1]).closest('td').append('closing Stock: 0');
                    $('#qty_' + id[1]).next('span').html('closing Stock: 0');
                    $('#qty_' + id[1]).next('span').attr('data-stock', 0);
                }

            },
            error: function (jqXHR, textStatus, errorThrown) {
                alert(textStatus + "-----" + errorThrown);
            }
        });

    }

    function deleteRow(val) {
        var rowid = $(val)[0].id.split('_')[1];
        if (confirm('Do you want to Delete')) {
            $('#click_' + rowid).attr("onclick", 'null');
            $('#click_' + rowid).remove();
            $('#click1_' + rowid).remove();
            if('<?php echo (isset($gridtype)) ? $gridtype : '';?>' == 0) {
                var f = parseInt($(".paging-nav").find('.selected-page').html()) - 1;
                $('.paging-nav').remove();
                thisVal._getNavBar($('#workorderTable').find('> tbody.main >tr'));
                setTimeout(function () {
                    $('.paging-nav').children('a[data-page=' + f + ']').trigger('click');
                }, 100);
            }
        }
    }

    function validate() {

        if($('.error').length != 0){
            alert('Kindly Notice the Error Notifications');
            return false;
        }
        var tCount =  $('#workorderTable tbody tr').length;
        if(tCount == 19){
            alert('Add Resource');
            return false;
        }
        var rowCountqty= parseInt($('#rowid').val()-1);
        for (var d = 1; d <= rowCountqty; d++) {
            if (parseFloat($('#qty_' + d).val()) == '' || 0) {
                alert('Kindly enter the values or delete the unwanted resource');
                return false;
            }
        }
        // if(($('#qty_'+rowCountqty).val()) == 0 && ($('#qty_'+rowCountqty).val()) == '' ){
        // alert('Enter the Quantity or delete unwanted Resources');
        // return false;
        // }
        if(($('#rate_'+rowCountqty).val()) == 0 && ($('#rate_'+rowCountqty).val()) == '' ){
            alert('Enter the Rate or delete unwanted Resources');
            return false;
        }
        if(($('#PurchaseAccount_'+rowCountqty).val()) == 0 && ($('#PurchaseAccount_'+rowCountqty).val()) == '' ){
            alert('Enter the Purchase Account or delete unwanted Resources');
            return false;
        }
        if(($('#issueAccount_'+rowCountqty).val()) == 0 && ($('#issueAccount_'+rowCountqty).val()) == '' ){
            alert('Enter the Issue Account or delete unwanted Resources');
            return false;
        }
        var is_warehouse = <?php echo (isset($isWh)) ? json_encode($isWh) : '[]';?>;
        var rowCountqty= parseInt($('#rowid').val()-1);
//        if(is_warehouse.length > 0)
//        {
//            for (var i = 1; i <= rowCountqty; i++) {
//                var whrow = $('#wh_' + i + '_rowid').val();
//                var rqty = parseFloatVal($('#qty_' + i).val());
//
//                var add = 0.0;
//                for (var j = 1; j <= whrow; j++) {
//                    add += parseFloatVal($('#wh_' + i + '_qty_' + j).val());
//                }
//                if (parseFloatVal(rqty) != parseFloatVal(add)) {
//                    alert('Kindly adjust the WareHouse Qty');
//                    return false;
//                }
//            }
//        }

//        var whqty = 0;
//        if(is_warehouse.length > 0){
//            for (var i = 1; i <= rowCountqty; i++) {
//                $.each($('input[id^=iow_' + i + '_qty_'), function (i, o) {
//                    var qty = parseFloatVal($(this).val());
//                    if(isNaN(qty))
//                        qty = 0;
//                    whqty += qty;
//                });
//            }
//
//        }
        $("#formWrapper").submit();
    }

    function checkWHQuantity(x) {
        var $x = $(x);
        var ids = $x[0].id.split('_');
        var rowid = ids[1];
        var whrowid = ids[3];
        var whqty = 0;

        var closingstock=parseInt($('#wh_'+ rowid + '_closingstock_' + whrowid).val());
        var assoc = parseInt($('#wh_'+ rowid + '_qty_' + whrowid).val());
        if (!isNaN(assoc) && !isNaN(closingstock) && assoc > closingstock) {
            alert('WareHouse Qty is exceed from closingstock');
            $('#wh_'+ rowid + '_qty_' + whrowid).val(000).trigger('change');
        } else{
            $.each($('input[id^=wh_'+rowid+'_qty_'), function (i,o) {
                var qty = parseFloatVal($(this).val());
                if(isNaN(qty))
                    qty = 0;
                whqty += qty;
            });
            var ssVal = parseFloatVal($('#stock_' + rowid).attr('data-stock'));
            if (whqty > ssVal) {
                showError($('#qty_' + rowid), "Greater than Closing Stock");
                errorFlag = 1;
            } else {
                removeError($('#qty_' + rowid));
                errorFlag = 0;
            }
            $('#qty_'+rowid).val(sanitizeNumber(parseFloatVal(whqty,0),3,true));
            // calc total amount
            var rate = parseFloatVal($('#rate_' + rowid).val(),0);
            $('#amount_' + rowid).val(sanitizeNumber(parseFloatVal(whqty * rate,0),2,true));
        }
    }

    function showtabs(type,id,event) {
        event.preventDefault();
        $('#' + id).parent('li').addClass('active').siblings('li').removeClass('active');
        var rowid = id.split('_')[1];
        if (type=="decision") {
            //   $('#decisionTable_'+rowid).show();
            $('#iowTable_' + rowid).show();
            $('#whTable_'+rowid).hide();
        }
        else
        {
            $('#whTable_'+rowid).show();
            // $('#decisionTable_'+rowid).hide();
            $('#iowTable_' + rowid).hide();
        }
        return false;
    }

    function checkWarehouse(x){
        var $x = $(x);
        var ids = $x[0].id.split('_');
        var rowid = ids[1];
        var iowrowid = ids[3];

        $('#whTable_' + rowid + '_wbs_' + iowrowid + '_whreqno').show();
    }

    function checkWWHQty(x){
        var $x = $(x);
        var ids = $x[0].id.split('_');
        var rowid = ids[1];
        var iowrowid = ids[3];
        var whrowid = ids[5];
        var totalQty=0;
        var add=0;
        var sub =0;
        var wareCheck = parseInt($x.data('find'));
        var closingstock=parseFloat($('#wh_' + rowid + '_wbs_' + iowrowid + '_closingstock_' + whrowid).val());
        var assoc = parseInt($('#wh_' + rowid + '_wbs_' + iowrowid + '_qty_' + whrowid).val());
        var desc = $('#wh_' + rowid + '_wbs_' + iowrowid + '_desc_' + whrowid).val();

        if (!isNaN(assoc) && !isNaN(closingstock)) {
            $('input[data-find='+wareCheck+']').each(function() {
                var cVal = parseFloat($(this).val());
                if(cVal!=false) {
                    sub+=cVal || 0;
                }
            });
            if(closingstock<sub) {
                $x.val('');
                showError($x, 'Kindly Check your Closing-Stock  of'+ desc + '!!!');

            } else {
                removeError($x);
            }
            $.each($('input[id*=wh_' + rowid + '_wbs_' + iowrowid + '_qty_'), function (i, o) {
                add += parseFloatVal($(this).val()) || 0;
            });
            add = sanitizeNumber(add,3,true);
            $('#iow_' + rowid + '_qty_' + iowrowid).val(add,0);
            $('#qty_' + rowid).val(add,0);


            $.each($('input[id^=iow_'+rowid+'_qty_'), function (i,o) {
                var qty = parseFloatVal($(this).val());
                if(isNaN(qty))
                    qty = 0;
                totalQty += qty;
            });
            totalQty=sanitizeNumber(totalQty,3,true);
            var sVal = parseFloatVal($('#stock_' + rowid).attr('data-stock'));
            if (totalQty > sVal) {
                showError($('#qty_' + rowid), "Greater than Closing Stock");
                errorFlag = 1;
            } else {
                removeError($('#qty_' + rowid));
                errorFlag = 0;
            }
            $('#qty_'+rowid).val(sanitizeNumber(parseFloatVal(totalQty,0),3,true));
            // calc total amount
            var rate = parseFloatVal($('#rate_' + rowid).val(),0);
            var qrate = parseFloatVal($('#rate_' + rowid).val(),0);

            $('#amount_' + rowid).val(sanitizeNumber(parseFloatVal(totalQty * qrate,0),2,true));
            $('#qrate_' + rowid).val(sanitizeNumber(parseFloatVal(qrate,0),2,true));
            $('#baseamount_' + rowid).val(sanitizeNumber(parseFloatVal(totalQty * rate),2,true));
            calcTotal();
        }
    }

    function calcResQuantity(x) {
        var $x = $(x);
        var ids = $x[0].id.split('_');
        var rowid = ids[1];
        var name = ids[0];

        if (name == 'qty') {
            // calc total qty
            var totalQty = 0;
            var tothidden = 0;
            totalQty = parseFloatVal($('#qty_' + rowid).val(),0);
            tothidden =parseFloatVal($('#hiddenqty_' + rowid).val(),0);
            var ssVal = parseFloatVal($('#stock_' + rowid).attr('data-stock'));
            if ((totalQty-tothidden) > ssVal) {
                showError($('#qty_' + rowid), "Greater than Closing Stock");
                errorFlag = 1;
            } else {
                removeError($('#qty_' + rowid));
                errorFlag = 0;
            }
            // calc total amount
            var rate = parseFloatVal($('#rate_' + rowid).val(),0);
            $('#amount_' + rowid).val(sanitizeNumber(parseFloatVal(totalQty * rate,0),2,true));
        }
    }
    ////////////////////////////////////////////////////  ISSUE END  //////////////////////////////////////
} else {
    /////////////////////////////////////////////// ISSUE-RETURN  /////////////////////////
    $(function () {
        var $rowid = $('#rowid');
        var template = $('#resource-template').html();
        var iowtemplate = $('#iow-template').html();
        //var waretemplate = $('#iow-warehouse').html();
        var requesttemplate = $('#issue-warehouse').html();
        var rowid = 0;
        var $tbody = $('#workorderTable').find('> tbody.main');
        if(arr_requestResources.length != 0) {
            $.each(arr_requestResources, function(i, o) {
                rowid += 1;
                $tbody.append(template.replace(/__/g, '_' + rowid));
                var opt = '<option></option>';
                if (arr_accountType.length > 0) {
                    $.each(arr_accountType, function (j, p) {
                        opt += '<option value="' + p.TypeId + '">' + p.Typename + '</option>';
                    });
                }
                $('#PurchaseAccount_' + rowid).html(opt);
                $('#issueAccount_' + rowid).html(opt);

                if (typeof(o.PurchaseAccount) != 'undefined') {
                    $('#PurchaseAccount_' + rowid).val(o.PurchaseAccount).trigger('change');
                }
                if (typeof(o.issueAccount) != 'undefined') {
                    $('#issueAccount_' + rowid).val(o.issueAccount).trigger('change');
                }
                if (typeof(o.rate) != "undefined") {
                    $('#rate_' + rowid).val(sanitizeNumber(o.rate,2,true));
                }
                if (typeof(o.Amount) != "undefined") {
                    $('#amount_' + rowid).val(sanitizeNumber(o.Amount,2,true));
                }
                if (typeof(o.Remarks) != "undefined") {
                    $('#remarks_' + rowid).val(o.Remarks);
                }
                if (typeof(o.Qty) != "undefined") {
                    $('#qty_' + rowid).val(sanitizeNumber(o.Qty,3,true));
                }
                if (typeof(o.FreeOrCharge) != "undefined") {
                    $('#FC_' + rowid).val(o.FreeOrCharge);
                }

                $('#code_' + rowid).val(o.Code).addClass('border-none').prop('disabled', false);
                $('#desc_' + rowid).val(o.ResourceName).addClass('border-none').prop('disabled', false);
                $('#resourceid_' + rowid).val(o.ResourceId);
                $('#itemid_' + rowid).val(o.ItemId);
                $('#unitname_' + rowid).val(o.UnitName);
                $('#unitid_' + rowid).val(o.UnitId);
                $('#expandTr_' + rowid).show();
                $('#deleteTr_' + rowid).show();

//                if(arr_sel_warehouse.length != 0) {
//                    $.each(arr_sel_warehouse, function (m, n) {
//                        if (o.ResourceId != n.ResourceId || o.ItemId != n.ItemId ) {
//                            return;
//                        }
//
//                        var whrowid = parseInt($('#wh_' + rowid + '_rowid').val()) + 1;
//                        $('#whTables_' + rowid).find('> tbody.main').append(waretemplate
//                            .replace(/__/g, '_' + rowid)
//                            .replace(/_0/g, '_' + whrowid));
//
//                        $('#wh_' + rowid + '_rowid').val(whrowid);
//                        $('#wh_' + rowid + '_warehouseid_' + whrowid).val(n.WareHouseId);
//                        $('#wh_' + rowid + '_warehousename_' + whrowid).val(n.WareHouseName);
//                        $('#wh_' + rowid + '_stockid_' + whrowid).val(n.StockId);
//                        $('#wh_' + rowid + '_desc_' + whrowid).val(n.Description);
//                        $('#wh_' + rowid + '_qty_' + whrowid).val(n.Qty);
//                        $('#wh_' + rowid + '_closingstock_' + whrowid).val(n.ClosingStock);
//                        $('#wh_' + rowid + '_hiddenqty_' + whrowid).val(n.Qty);
////                    $.each(arr_warehouseQty, function (s,t) {
////                        if (n.WareHouseId == t.WareHouseId && o.ResourceId == t.ResourceId && o.ItemId == t.ItemId && t.Qty>0) {
////                            $('#wh_' + rowid + '_qty_' + whrowid).val(t.Qty);
////                        }
////                    });
//                    });
//                }
//
                var IssueCount = 0;
                console.log(arr_resource_iows.length);
                if(arr_resource_iows.length > 0) {
                    $.each(arr_resource_iows, function (j, l) {
                        if (l.ResourceId == o.ResourceId && l.ItemId == o.ItemId) {

                            var iowrowid = parseInt($('#iow_' + rowid + '_rowid').val()) + 1;
                            IssueCount = IssueCount+1;
                            $('#iowTables_' + rowid).find('tbody.main').append(iowtemplate.replace(/__/g, '_' + rowid).replace(/_0/g, '_' + iowrowid));
                            $('#iow_' + rowid + '_rowid').val(iowrowid);
                            $('#iow_' + rowid + '_issueNo_' + iowrowid).val(l.IssueNo);
                            $('#iow_' + rowid + '_TransId_' + iowrowid).val(l.AIssueTransId);
                            $('#iow_' + rowid + '_IssueDate_' + iowrowid).val(l.IssueDate);
                            $('#iow_' + rowid + '_BalQty_' + iowrowid).val(sanitizeNumber(l.BalQty,3,true));
                            $('#iow_' + rowid + '_IssueQty_' + iowrowid).val(sanitizeNumber(l.Qty,3,true));
                            $('#iow_' + rowid + '_Rate_' + iowrowid).val(sanitizeNumber(l.Rate,2,true));
                            $('#iow_' + rowid + '_ReturnQty_' + iowrowid).val(sanitizeNumber(l.CurrentQty,3,true));
                            $('#iow_' + rowid + '_AdjustmentQty_' + iowrowid).val(sanitizeNumber(l.AdjustmentQty,3,true));

                            //start warehouse
                            var wareCount = 0;
                            if (arr_resel_warehouse.length != 0) {
                                var findReturnWH = arr_resel_warehouse.filter(function (obj) {
                                    return (obj.ResourceId === o.ResourceId) && (obj.ItemId === o.ItemId) && (obj.IssueTransId === l.AIssueTransId);
                                });
                                if (findReturnWH.length > 0) {
                                    $.each(arr_resel_warehouse, function (m, n) {
                                        if (o.ResourceId != n.ResourceId || o.ItemId != n.ItemId || n.IssueTransId != l.AIssueTransId) {
                                            return;
                                        }
                                        wareCount = wareCount+1;
                                        var whrowid = parseInt($('#wh_' + rowid + '_wbs_' + iowrowid + '_wrowid').val()) + 1;
                                        $('#expandwTr_' + rowid).show();
                                        $('#whTable_' + rowid + '_wbs_' + iowrowid + '_whreqno').find('> tbody.ware').append(requesttemplate
                                            .replace(/__7/g, '_' + whrowid)
                                            .replace(/_0/g, '_' + iowrowid)
                                            .replace(/__/g, '_' + rowid));

                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_wrowid').val(whrowid);
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_warehouseid_' + whrowid).val(n.WareHouseId);
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_warehousename_' + whrowid).val(n.WareHouseName);
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_stockid_' + whrowid).val(n.StockId);
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_desc_' + whrowid).val(n.Description);
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_qty_' + whrowid).val(sanitizeNumber(n.Qty,3,true));
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_bissueqty_' + whrowid).val(sanitizeNumber(n.BalIssueQty,3,true));
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_issueqty_' + whrowid).val(sanitizeNumber(n.IssueQty,3,true));
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_hiddenqty_' + whrowid).val(sanitizeNumber(n.Qty,3,true));
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_adqty_' + whrowid).val(sanitizeNumber(n.AdjustmentQty,3,true));
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_hiddenadqty_' + whrowid).val(sanitizeNumber(n.HAdjustmentQty,3,true));
                                        $.each(arr_resel_iswarehouse, function (s, t) {
                                            if (n.WareHouseId == t.WareHouseId && l.AIssueTransId == t.RIssueTransId && o.ResourceId == t.ResourceId && o.ItemId == t.ItemId && t.Qty > 0) {
                                                $('#wh_' + rowid + '_wbs_' + iowrowid + '_qty_' + whrowid).val(sanitizeNumber(t.Qty,3,true));
                                                $('#wh_' + rowid + '_wbs_' + iowrowid + '_adqty_' + whrowid).val(sanitizeNumber(t.AdjustmentQty,3,true));

                                            }
                                        });
                                    });
                                }
                            }
                            if(wareCount == 0) {
                                $('#iow_' + rowid + '_ReturnQty_' + iowrowid).removeClass('mainTr');
                                $('#whTable_' + rowid + '_wbs_' + iowrowid + '_whreqno').hide();
                                $('#iow_' + rowid + '_ReturnQty_' + iowrowid).attr('onchange', 'calcQuantity(this)');
                                $('#iow_' + rowid + '_ReturnQty_' + iowrowid).prop("readonly", false);
                                $('#iow_' + rowid + '_AdjustmentQty_' + iowrowid).attr('onkeyup', 'calc(this)');
                                $('#iow_' + rowid + '_AdjustmentQty_' + iowrowid).prop("readonly", false);
                            }
                            //end of warehouse
                        }
                    });
                }
                if(IssueCount == 0){
                    alert("check up0");
                    $('#expandTr_' + rowid).hide();
                    $('#qty_' + rowid ).attr('onfocus', 'calcResQty(this)');
                    $('#qty_' + rowid).prop("readonly", false);
                    $('#qty_' + rowid).removeClass('mainTr');
                }
            });
        }
        rowid += 1;
        $tbody.append(template.replace(/__/g, '_' + rowid));
        $rowid.val(rowid);
        bindResourceAutocomplete();
        var opt = '<option></option>';
        if (arr_accountType.length > 0) {
            $.each(arr_accountType, function (j, p) {
                opt += '<option value="' + p.TypeId + '">' + p.Typename + '</option>';
            });
        }
        $('#PurchaseAccount_' + rowid).html(opt);
        $('#issueAccount_' + rowid).html(opt);
        var rowIdval = parseInt(arr_requestResources.length + 1);
        $('#rowid').val(rowIdval);

        $('.content_wrapper').on('click','.mainTr',function(e){
            e.preventDefault();
            if(!$(this).closest("tr").next(".subTr").is(":visible")){
                $(this).closest("tr").next(".subTr").show();
                $(this).closest("tr").next(".subTr").find(".subDiv").slideDown("slow");
                $(this).find("i").addClass("tform");
            }
            else{
                $(this).closest("tr").next(".subTr").find(".subDiv").slideUp("slow");
                $(this).closest("tr").next(".subTr").slideUp("slow");
                $(this).find("i").removeClass("tform");
            }
        });

        $('.content_wrapper').on('keyup','.mainTr',function(e){
            e.preventDefault();
            if(!$(this).closest("tr").next(".subTr").is(":visible")){
                $(this).closest("tr").next(".subTr").show();
                $(this).closest("tr").next(".subTr").find(".subDiv").slideDown("slow");
                $(this).find("i").addClass("tform");
            }
            else{
                $(this).closest("tr").next(".subTr").find(".subDiv").slideUp("slow");
                $(this).closest("tr").next(".subTr").slideUp("slow");
                $(this).find("i").removeClass("tform");
            }
        });

        nextAccordian(1);
        if('<?php echo (isset($gridtype)) ? $gridtype : '';?>' == 0) {
            $('#workorderTable').paging({limit: 2});
            $('.paging-nav').children('a[data-page=0]').trigger('click');
        }
    });

    function bindResourceAutocomplete() {
        // bind resource autocomplete
        $('#workorderTable .resourceSuggest').autocomplete({
            lookup: tmp_arr_resources,
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            }, onSelect: function (suggestion) {

                if (suggestion) {
                    var $this = $(this);
                    var rowid = $this[0].id.split('_')[1];
                    var reskeyid = $('input[id*=resourceid_] ') ;
                    var bRet=false;
                    $.each(reskeyid, function (i, obj) {
                        var $this = $(this),
                            name = $this[0].id;
                        var arrname = name.split('_');
                        var key1 = arrname[1];

                        if (key1 != rowid) {
                            if ($this.val() == suggestion.data && $('#itemid_' + key1).val() == suggestion.ItemId) {
                                bRet = true;
                            }
                        }
                    });

                    if(bRet == false) {
                        $this.prop('readonly', true).addClass('border-none');
                        $('#resourceid_' + rowid).val(suggestion.data);
                        $('#itemid_' + rowid).val(suggestion.ItemId);
                        $('#unitname_' + rowid).val(suggestion.UnitName);
                        $('#code_' + rowid).val(suggestion.Code);
                        $('#unitid_' + rowid).val(suggestion.UnitId);
                        $('#rate_' + rowid).val(sanitizeNumber(suggestion.Rate,2,true));
                        $('#expandTr_' + rowid).show();
                        bindResourceIOW($this);
                        addNewResourceRow($this);
                    } else {
                        alert('Already added in list');
                        $('#desc_' + rowid).val('');
                        return;
                    }
                }
            }, onSearchStart: function (suggestion) {
                var rowid = $(this)[0].id.split('_')[1];
                $('#unitname_' + rowid).val('');
                $('#rate_' + rowid).val('');
            }, onSearchComplete: function (query, suggestions) {
                if(!suggestions.length) {
                    var rowid = $(this)[0].id.split('_')[1];
                    $('#unitname_' + rowid).val('');
                    $('#rate_' + rowid).val('');
                }
            }
        });
    }

    function bindResourceIOW(x) {

        var rowid = $(x)[0].id.split('_')[1];
        var $iowrowid = $('#iow_' + rowid + '_rowid');
        var ResourceId = $('#resourceid_' + rowid).val();
        var ItemId = $('#itemid_' + rowid).val();
        var costcentre = $('#CostCentre').val();
        var contractor = $('#contractor').val();
        var requesttemplate = $('#issue-warehouse').html();
        $('.loading_area').show();
        $.ajax({
            url: getBaseURL() + 'mms/issue/issueedit',
            type: "post",
            data: {'Type': 'getIssueDetails', 'ResourceId': ResourceId,'ItemId': ItemId,'CostCentre': costcentre,'contractor':contractor},
            async: false,
            success: function (data, textStatus, jqXHR) {
                if(jqXHR.status == 200) {
                    data = JSON.parse(data);
                    var iowtemplate = $('#iow-template').html();
                    var IssueCount = 0;
                    var findRes = data.arr_resource_issue.filter(function(obj) {
                        return (obj.ResourceId === ResourceId && obj.ItemId === ItemId);
                    });
                    if(findRes.length > 0) {
                        $.each(data.arr_resource_issue, function (i, l) {
                            var iowrowid = parseInt($iowrowid.val()) + 1;
                            IssueCount = IssueCount+1;
                            $('#iowTables_' + rowid).find('tbody.main').append(iowtemplate.replace(/__/g, '_' + rowid).replace(/_0/g, '_' + iowrowid));
                            $('#iow_' + rowid + '_rowid').val(iowrowid);
                            $('#iow_' + rowid + '_issueNo_' + iowrowid).val(l.IssueNo);
                            $('#iow_' + rowid + '_TransId_' + iowrowid).val(l.AIssueTransId);
                            $('#iow_' + rowid + '_IssueDate_' + iowrowid).val(l.IssueDate);
                            $('#iow_' + rowid + '_BalQty_' + iowrowid).val(sanitizeNumber(l.BalQty,3,true));
                            $('#iow_' + rowid + '_IssueQty_' + iowrowid).val(sanitizeNumber(l.Qty,3,true));
                            $('#iow_' + rowid + '_Rate_' + iowrowid).val(sanitizeNumber(l.Rate,2,true));
                            $('#iow_' + rowid + '_ReturnQty_' + iowrowid).val(sanitizeNumber(l.CurrentQty,3,true));
                            $('#iow_' + rowid + '_AdjustmentQty_' + iowrowid).val(sanitizeNumber(l.AdjustmentQty,3,true));
                            //start warehouse
                            var wareCount = 0;
                            if (data.arr_warehouse.length != 0) {
                                var findReturnWH = data.arr_warehouse.filter(function (obj) {
                                    return (obj.ResourceId === ResourceId && obj.ItemId === ItemId);
                                });
                                if (findReturnWH.length > 0) {
                                    $.each(data.arr_warehouse, function (m, n) {
                                        if (ResourceId != n.ResourceId || ItemId != n.ItemId || n.IssueTransId != l.AIssueTransId) {
                                            return;
                                        }
                                        wareCount = wareCount+1;
                                        var whrowid = parseInt($('#wh_' + rowid + '_wbs_' + iowrowid + '_wrowid').val()) + 1;
                                        $('#expandwTr_' + rowid).show();
                                        $('#whTable_' + rowid + '_wbs_' + iowrowid + '_whreqno').find('> tbody.ware').append(requesttemplate
                                            .replace(/__7/g, '_' + whrowid)
                                            .replace(/_0/g, '_' + iowrowid)
                                            .replace(/__/g, '_' + rowid));

                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_wrowid').val(whrowid);
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_warehouseid_' + whrowid).val(n.WareHouseId);
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_warehousename_' + whrowid).val(n.WareHouseName);
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_stockid_' + whrowid).val(n.StockId);
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_desc_' + whrowid).val(n.Description);
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_qty_' + whrowid).val(sanitizeNumber(n.Qty,3,true));
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_issueqty_' + whrowid).val(sanitizeNumber(n.IssueQty,3,true));
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_hiddenqty_' + whrowid).val(sanitizeNumber(n.Qty,3,true));
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_adqty_' + whrowid).val(sanitizeNumber(n.AdjustmentQty,3,true));
                                        $('#wh_' + rowid + '_wbs_' + iowrowid + '_hiddenadqty_' + whrowid).val(sanitizeNumber(n.HAdjustmentQty,3,true));
                                    });
                                }
                            }
                            if(wareCount == 0) {

                                $('#iow_' + rowid + '_ReturnQty_' + iowrowid).removeClass('mainTr');
                                $('#whTable_' + rowid + '_wbs_' + iowrowid + '_whreqno').hide();
                                $('#iow_' + rowid + '_ReturnQty_' + iowrowid).attr('onchange', 'calcQuantity(this)');
                                $('#iow_' + rowid + '_ReturnQty_' + iowrowid).prop("readonly", false);
                                $('#iow_' + rowid + '_AdjustmentQty_' + iowrowid).attr('onkeyup', 'calc(this)');
                                $('#iow_' + rowid + '_AdjustmentQty_' + iowrowid).prop("readonly", false);
                            }
                            //end of warehouse
                        });
                    } if(IssueCount == 0){
                        $('#qty_' + rowid).removeClass('mainTr');
                        $('#expandTr_' + rowid).hide();
                        $('#qty_' + rowid ).attr('onchange', 'calcResQty(this)');
                        $('#qty_' + rowid).prop("readonly", false);
                    }
                }
                $('.loading_area').hide();
            }, error: function (jqXHR, textStatus, errorThrown) {
                $('.loading_area').hide();
            }
        });
    }

    function addNewResourceRow(x) {
        var $tr = $(x).closest('tr');
        if ($tr.next('tr:not(.subTr)').length != 0)
            return;

        var $rowid = $('#rowid'),
            rowid = parseInt($rowid.val()),
            $tbody = $('#workorderTable').find('> tbody.main');

        $('#deleteTr_' + rowid).show();
        var count = rowid + 1,
            template = $('#resource-template').html();

        template = template.replace(/__/g, '_' + count);
        $tbody.append(template);

        $rowid.val(count);
        var opt;
        if (arr_accountType.length > 0) {
            opt +='<option value =""></option>';
            $.each(arr_accountType, function (j, p) {
                opt += '<option value="' + p.TypeId + '">' + p.Typename + '</option>';
            });
        }
        $('#PurchaseAccount_' + rowid).html(opt);
        $('#issueAccount_' + rowid).html(opt);

        bindResourceAutocomplete();
        if('<?php echo (isset($gridtype)) ? $gridtype : '';?>' == 0) {
            var f = parseInt($(".paging-nav").find('.selected-page').html()) - 1;
            $('.paging-nav').remove();
            thisVal._getNavBar($('#workorderTable').find('> tbody.main >tr'));
            setTimeout(function () {
                $('.paging-nav').children('a[data-page=' + f + ']').trigger('click');
            }, 100);
        }
    }

    function checkResourceUsed(x) {
        var id = $(x)[0].id.split('_')[1];
        var reskeyid = $('input[id*=resourceid_]');
        var itemkeyid=$('input[id*=itemid_]');
        tmp_arr_resources = arr_resources;
        tmp_arr_resources = $.grep(arr_resources, function (element, index) {
            var is_selected = true;
            $.each(reskeyid, function (i, obj) {
                var $this = $(this),
                    name = $this[0].id;
                var arrname = name.split('_');
                var key1 = arrname[1];
                if (key1 != id) {
                    if (element.data == $this.val() && itemkeyid[0].value == element.ItemId) {
                        is_selected = false;
                        return false;
                    }
                }
            });
            return is_selected;
        });
        bindResourceAutocomplete();
    }

    function nextAccordian(id) {
        $('#panelheading-' + id).trigger('click');
    }

    var errorFlag = 0;
    function calc(y){
        var $x = $(y);
        var ids = $x[0].id.split('_');
        var rowid = ids[1];
        var rowids= ids[3];
        // calc total qty
        var totalQty = 0;
        $.each($('input[id^=iow_' + rowid + '_AdjustmentQty_'), function (i, o) {
            var qty = parseFloatVal($(this).val(),0);
            if (isNaN(qty))
                qty = 0;

            totalQty += qty;
        });
        totalQty = sanitizeNumber(totalQty,3,true);
        var result =0;
        var sVal = parseFloatVal($('#iow_' + rowid + '_AdjustmentQty_'+rowids).val());
        var rVal = parseFloatVal($('#iow_' + rowid + '_ReturnQty_'+rowids).val());
        result = sVal+rVal;
        var TVal = parseInt($('#iow_' + rowid + '_BalQty_'+rowids).val());
        if (result > TVal) {
            showError($('#iow_' + rowid + '_AdjustmentQty_'+rowids), "Greater than Bal Qty");
            errorFlag = 1;
        } else {
            removeError($('#iow_' + rowid + '_AdjustmentQty_'+rowids));
            errorFlag = 0;
        }
    }
    function calcQuantity(x) {
        var $x = $(x);
        var ids = $x[0].id.split('_');
        var rowid = ids[1];
        var rowids= ids[3];
        // calc total qty
        var totalQty = 0;
        $.each($('input[id^=iow_' + rowid + '_ReturnQty_'), function (i, o) {
            var qty = parseFloatVal($(this).val(),0);
            if (isNaN(qty))
                qty = 0;

            totalQty += qty;
        });
        totalQty = sanitizeNumber(totalQty,3,true);
        var sVal = parseFloatVal($('#iow_' + rowid + '_ReturnQty_'+rowids).val(),0);
        var TVal = parseFloatVal($('#iow_' + rowid + '_BalQty_'+rowids).val(),0);
        if (sVal > TVal) {
            showError($('#iow_' + rowid + '_ReturnQty_'+rowids), "Greater than Bal Qty");
            errorFlag = 1;
        } else {
            removeError($('#iow_' + rowid + '_ReturnQty_'+rowids));
            errorFlag = 0;
        }
        $('#qty_' + rowid).val(sanitizeNumber(totalQty,3,true));
        // calc total amount
        var rate = parseFloatVal($('#rate_' + rowid).val());
        $('#amount_' + rowid).val(sanitizeNumber(totalQty * rate,2,true));
        calcTotal();
    }

    function Rate(x) {
        var $x = $(x);
        var ids = $x[0].id.split('_');
        var rowid = ids[1];
        // calc total qty
        var totalQty = 0;

        $.each($('input[id^=iow_' + rowid + '_ReturnQty_'), function (i, o) {
            var qty = parseFloatVal($(this).val(),0);
            if (isNaN(qty))
                qty = 0;

            totalQty += qty;
        });
        totalQty = sanitizeNumber(totalQty,3,true);
        $('#qty_' + rowid).val(sanitizeNumber(totalQty,3,true));
        // calc total amount
        var rate = parseFloatVal($('#rate_' + rowid).val());
        $('#amount_' + rowid).val(sanitizeNumber(totalQty * rate,2,true));
        calcTotal();
    }
    function navtabs(type,id,event) {
        event.preventDefault();
        $('#' + id).parent('li').addClass('active').siblings('li').removeClass('active');
        var rowid = id.split('_')[1];
        if (type=="decision") {
            $('#iowTables_' + rowid).show();
          //  $('#whTables_'+rowid).hide();
        }
        else
        {
          //  $('#whTables_'+rowid).show();
            $('#iowTables_' + rowid).hide();
        }
        return false;
    }
//    function checkWHQuantity(x){
//        var $x = $(x);
//        var ids = $x[0].id.split('_');
//        var rowid = ids[1];
//
//        var add=0;
//        var whrow = $('#wh_' + rowid + '_rowid').val();
//        var  qty  = $('#qty_' + rowid).val();
//
//        if($('#qty_' + rowid).val() > 0){
//            for (j = 1; j <= whrow; j++) {
//                add += parseInt($('#wh_' + rowid + '_qty_' + j).val());
//
//                if (!isNaN(add) && add > qty) {
//                    alert('WareHouse Qty is exceed from Qty');
//                    $('#wh_' + rowid + '_qty_' + j).val(0).trigger('change');
//                    return false;
//                }
//            }
//        }
//    }

    function calcTotal() {
        var total = 0;
        $.each($('input[id^=amount_]'), function (i, o) {
            total += parseFloatVal($(this).val());
        });
        $('#total').val(sanitizeNumber(total,2,true));
    }

    function validate() {

        if($('.error').length != 0){
            alert('Kindly Notice the Error Notifications');
            return false;
        }
        var tCount =  $('#workorderTable tbody tr').length;
        if(tCount == 19){
            alert('Add Resource');
            return false;
        }

        var rowCountqty= parseInt($('#rowid').val()-1);

        for (var d = 1; d <= rowCountqty; d++) {
            var cqty = parseFloat($('#qty_' + d).val());
            if(isNaN(cqty))
            {
                cqty = 0;
            }
            if (cqty == 0) {
                alert('Kindly enter the values or delete the unwanted resource');
                return false;
            }
        }

        if(($('#rate_'+rowCountqty).val()) == 0 && ($('#rate_'+rowCountqty).val()) == '' ){
            alert('Enter the Rate or delete unwanted Resources');
            return false;
        }
        if(($('#PurchaseAccount_'+rowCountqty).val()) == 0 && ($('#PurchaseAccount_'+rowCountqty).val()) == '' ){
            alert('Enter the Purchase Account or delete unwanted Resources');
            return false;
        }
        if(($('#issueAccount_'+rowCountqty).val()) == 0 && ($('#issueAccount_'+rowCountqty).val()) == '' ){
            alert('Enter the Issue Account or delete unwanted Resources');
            return false;
        }
        var is_warehouse = <?php echo (isset($isWh)) ? json_encode($isWh) : '[]';?>;


        $("#formWrapper").submit();
    }

    function deleteRow(val) {
        var rId = $(val).attr('id');
        var rId1 = rId.split('_')[1];
        if (confirm('Do you want to Delete')) {
            $('#click_' + rId1).remove();
            $('#subTr_' + rId1).remove();
            if('<?php echo (isset($gridtype)) ? $gridtype : '';?>' == 0) {
                var f = parseInt($(".paging-nav").find('.selected-page').html()) - 1;
                thisVal._getNavBar($('#workorderTable').find('> tbody.main >tr'));
                setTimeout(function () {
                    $('.paging-nav').children('a[data-page=' + f + ']').trigger('click');
                }, 100);
            }
        }
    }
    function entryValidate() {
        if($('.error').length != 0){
            alert('Kindly Notice the Error Notifications');
            return false;
        }
    }
    function checkWarehouse(x){
        var $x = $(x);
        var ids = $x[0].id.split('_');
        var rowid = ids[1];
        var iowrowid = ids[3];

        $('#whTable_' + rowid + '_wbs_' + iowrowid + '_whreqno').show();
    }
    function calcResQty(x){
        var $x = $(x);
        var ids = $x[0].id.split('_');
        var rowid = ids[1];
        showError($('#qty_' + rowid), "No Issue Qty Available Here");
        $('#qty_' + rowid).val('');
        errorFlag = 1;
    }
    function checkIssueWHQty(x){
        var $x = $(x);
        var ids = $x[0].id.split('_');
        var rowid = ids[1];
        var iowrowid = ids[3];
        var whrowid = ids[5];
        var totalQty=0;
        var add=0;

        var issueqty =parseFloatVal($('#wh_' + rowid + '_wbs_' + iowrowid + '_bissueqty_' + whrowid).val(),0);
        var assoc = parseFloatVal($('#wh_' + rowid + '_wbs_' + iowrowid + '_qty_' + whrowid).val(),0);

        if (!isNaN(assoc) && !isNaN(issueqty) && assoc > issueqty) {
            alert('WareHouse Qty is exceed from BalanceIssueQty');
            $('#wh_' + rowid + '_wbs_' + iowrowid + '_qty_' + whrowid).val(000).trigger('change');
        } else {
            $.each($('input[id*=wh_' + rowid + '_wbs_' + iowrowid + '_qty_'), function (i, o) {
                add += parseFloatVal($(this).val()) || 0;
            });
            add = sanitizeNumber(add,3,true);
            $('#iow_' + rowid + '_ReturnQty_' + iowrowid).val(add,00);
            $('#qty_' + rowid).val(add,00);

            $.each($('input[id^=iow_'+rowid+'_ReturnQty_'), function (i,o) {
                var qty = parseFloatVal($(this).val());
                if(isNaN(qty))
                    qty = 0;
                totalQty += qty;
            });
            totalQty = sanitizeNumber(totalQty,3,true);
            var sVal = parseInt($('#stock_' + rowid).attr('data-stock'));
            if (totalQty > sVal) {
                showError($('#qty_' + rowid), "Greater than Closing Stock");
                errorFlag = 1;
            } else {
                removeError($('#qty_' + rowid));
                errorFlag = 0;
            }
            $('#qty_'+rowid).val(sanitizeNumber(parseFloatVal(totalQty,0),3,true));
            // calc total amount
            var rate = parseFloatVal($('#rate_' + rowid).val(),2,true);
            $('#amount_' + rowid).val(sanitizeNumber(parseFloatVal(totalQty * rate,0),2,true));
            calcTotal();
        }

    }

    function checkAdjustQty(y){
        var $x = $(y);
        var ids = $x[0].id.split('_');
        var rowid = ids[1];
        var iowrowid= ids[3];
        var rowids= ids[5];
        // calc total qty
        var totalQty = 0;
        $.each($('input[id^=wh_' + rowid + '_wbs_' + iowrowid + '_adqty_'), function (i, o) {
            var qty = parseFloatVal($(this).val(),0);
            if (isNaN(qty))
                qty = 0;

            totalQty += qty;
        });
        totalQty = sanitizeNumber(totalQty,3,true);
        $('#iow_' + rowid + '_AdjustmentQty_' + iowrowid).val(totalQty,00);
        var result =0;
        var sVal = parseFloatVal($('#wh_' + rowid + '_wbs_' + iowrowid + '_adqty_'+ rowids).val());
        var rVal = parseFloatVal($('#wh_' + rowid + '_wbs_' + iowrowid + '_qty_'+ rowids).val());
        result = sVal+rVal;
        console.log(sVal,rVal,result);
        var TVal = parseFloatVal($('#wh_' + rowid + '_wbs_' + iowrowid + '_bissueqty_'+ rowids).val(),0);
        if (result > TVal) {
            showError($('#wh_' + rowid + '_wbs_' + iowrowid + '_adqty_'+ rowids), "Greater than BalanceIssue Qty");
            errorFlag = 1;
            $('#iow_' + rowid + '_AdjustmentQty_' + iowrowid).val(00);
        } else {
            removeError($('#wh_' + rowid + '_wbs_' + iowrowid + '_adqty_'+ rowids));
            errorFlag = 0;
            $('#iow_' + rowid + '_AdjustmentQty_' + iowrowid).val(totalQty,00);

        }

    }


    ////////////////////////////////////////////////// ISSUE-RETURN END  ////////////////////
}


/////////////////////////////////////////////// COMMON FUNCTIONS  /////////////////////////////////////////////////////////
function isqtyDecimal(evt, x, v) {

    var charCode = (evt.which) ? evt.which : evt.keyCode;
    if (evt.key =="%") charCode=0;
    if (evt.key =="#") charCode=0;
    if (
        (charCode != 46 || $(element).val().indexOf('.') != -1) &&      // �.� CHECK DOT, AND ONLY ONE.
        (charCode < 48 || charCode > 57) && charCode!=39 && charCode!=37 && charCode!=8 && charCode!=35 && charCode!=9)
        return false;

    if(v === 'mqty') {

        var rowid = $(x)[0].id.split('_')[1];

        var iowrowid = 0;
        var dWbs = parseInt($('#wbs_' + rowid + '_rowid').val());
        var reqDec = parseInt($('#iow_' + rowid + '_rowid').val());

        if (dWbs > 0 || reqDec > 0) {
            $('#qty_' + rowid).attr('readonly', true);

        }
        else {
            $('#qty_' + rowid).attr('readonly', false);
        }
    }
    else
    {
        var ids = $(x)[0].id.split('_');
        var rowid = ids[1];
        var iowrowid= ids[3];

        var dWh = parseInt($('#wh_' + rowid + '_wbs_' + iowrowid + '_wrowid').val());
        if(dWh > 0)
        {
            $('#iow_' + rowid + '_qty_' + iowrowid).attr('readonly', true);
        }
        else
        {
            $('#iow_' + rowid + '_qty_' + iowrowid).attr('readonly', false);
        }
    }

    return true;
}

$('textarea').focus(function(){
    $(this).removeAttr('placeholder');
});
$(document).ready(function(){
        $(".flip0").click(function(){
            $(".pane0").slideToggle("slow");
        });
    });
    function myFunction(x) {
        x.classList.toggle("change");
    }

$( document ).ready(function() {
    if('<?php echo (isset($Approve)) ? $Approve : '';?>' == 'Y')
    {
        $('#sub1').hide();
    }
    else if('<?php echo (isset($Approve)) ? $Approve : '';?>' == 'P')
    {
        $('#sub1').hide();
    }
    else{
        $('#sub1').show();
    }

});
</script>
