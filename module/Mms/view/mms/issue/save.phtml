<!--STYLE-->
<link rel="stylesheet" href="<?php echo $this->basePath() . '/css/wpm.css';?>"/>
<style type="text/css">
	#WorkTypeWrapper, #ServiceTypeWrapper, #HireTypeWrapper, #pref-details,  #vendorServiceListWrapper {display: none;}
   .jqx-grid-header {height:75px !important;}
   .lbl_move{height:40px !important;}
    #jqxgrid									{min-height:200px !important;}
    .jqx-grid-groups-row						{padding-left:5px !important;}
    .jqx-grid-pager-input						{padding: 2px; text-align: center !important; width: 35px;}
    .jqx-dropdownlist-state-normal				{display: block;  float: right;height: 16px !important;margin-right: 7px;margin-top: 0;  padding-bottom: 2px !important;padding-top: 2px !important; width: 40px;}
    .jqx-button									{cursor: pointer;float: right;margin-right: 3px !important;margin-top: 0 !important;padding: 0 !important;width: 20px !important;}
    .jqx-button > .jqx-icon-arrow-left,
    .jqx-button >.jqx-icon-arrow-right			{height: 21px !important;margin-left: 0 !important;width: 20px !important;}
    .jqx-listitem-element						{height: 25px !important;}
    .jqx-input									{height: 25px !important; margin:2px 4px !important;}
    .jqx-grid-pager .jqx-grid-pager-input		{height:20px !important; margin:0px 4px !important;}
    #jqxgrid .jqx-grid-cell-right-align 		{text-align:right !important; padding-right:8px;}
    #jqxgrid .jqx-grid-cell-left-align 			{padding-left:8px;}
    .jqx-grid-column-menubutton::after			{left:4px;top:10px;}
</style>
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/library/jqwidgets/jqxgrid.grouping.js"></script>
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/library/jqwidgets/jqxgrid.aggregates.js"></script>
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/library/jqwidgets/jqx-all.js"></script>
<!--content-->
<form method="post" action="<?php echo $this->basePath(); ?>/mms/issue/issueedit" id="formWrapper">
	<div class="content_wrapper padlr0">
    	<div class="container-fluid">
            <h1>Issue Entry</h1>
              	<div class="col-lg-12">
               		<div class="col-lg-1">
                    	<div class="radio_check">
                        	<p class="mar_5">
                            	<input type="radio"  class="ripple" value="0" id="Own" name="OwnOrCsm" checked />
                                <label for="Own" class="clr_fff">Own</label>
                           	</p>
						</div>
					</div>
					<div class="col-lg-1">
						<div class="radio_check">
							<p class="mar_5">
                            	<input type="radio" class="ripple"value="1" id="Csm" name="OwnOrCsm"/>
                                <label for="Csm" class="clr_fff">Csm</label>
                            </p>
                     	</div>
              		</div>
<!--                    <div class="col-lg-2 col-lg-offset-0 col-md-2 col-md-offset-0 col-sm-2 col-sm-offset-0 col-xs-12 col-offset-0 form-group">-->
<!--                        <input type="text" class="form-control lbl_move"  placeholder="Issue No." name="IssueNo" id="IssueNo" value="--><?php //echo $vNo['voucherNo'];?><!--">-->
<!--                    <div class="error_message"><p>Please enter IssueNo...</p> </div>-->
<!--                	</div>-->
                    <input type="hidden" name="RequestType" value="Material" id="RequestType"/>
                    <div class="col-lg-2 col-lg-offset-0 col-md-2 col-md-offset-0 col-sm-2 col-sm-offset-0 col-xs-12 col-offset-0 form-group">
                    	<select class="single_dropdown lbl_move" data-bsfshare="Issue Type" style="width:100%;" 
                        data-placeholder="Select Issue type" 
                        name="issue_type" id="issue_type">
                        	<option value=""></option>
                            <option value="1">Internal</option>
                            <option value="2">Contractor</option>
                     	</select>
                  	<div class="error_message"><p>Please select Issue Type...</p> </div>
         	        </div>
                    <div class="col-lg-2 col-lg-offset-0 col-md-2 col-md-offset-0 col-sm-2 col-sm-offset-0 col-xs-12 col-offset-0 form-group">
                        <div class="req_flds">
                            <select class="single_dropdown lbl_move" data-bsfshare="Issue" style="width:100%;" 
                            data-placeholder="Select Issue"  
                            name="issue" id="issue">
                                <option value=""></option>
                                <option value="0">Issue</option>
                                <option value="1">Return</option>
                            </select>
                            <div class="error_message"><p>Please select Issue ...</p> </div>
                        </div>
                    </div>
                    <div class="col-lg-2 col-lg-offset-0 col-md-2 col-md-offset-0 col-sm-2 col-sm-offset-0 col-xs-12 col-offset-0 form-group">
                        <div class="req_flds">
                            <select data-placeholder="Cost Centre" style="width:100%;" class="single_dropdown lbl_move" 
                            name="CostCentre" id="CostCentre">
                                <option value=""></option>
                                <?php if(isset($arr_costcenter)):
                                    foreach($arr_costcenter as $costcenter): ?>
                              	<option value="<?php echo $costcenter['CostCentreId'];?>"><?php echo $costcenter['CostCentreName'];?></option>
                                    <?php endforeach;
                                endif; ?>
                            </select>
                            <div class="error_message"><p>Please select project...</p></div>
                        </div>
                    </div>
                    <div class="col-lg-2 col-lg-offset-0 col-md-2 col-md-offset-0 col-sm-2 col-sm-offset-0 col-xs-12 col-offset-0 form-group">
                        <div class="req_flds">
                            <select class="form-control selectpicker show-tick" name="gridtype" id="gridtype" >
                                <!--                        <option value="-1" selected>Select Priority</option>-->
                                <option value="0" selected="true">Sequential View</option>
                                <option value="1">List View</option>

                            </select>
                            <div class="error_message"><p>Please select the priority...</p></div>
                        </div>
                    </div>
                    <div class="col-lg-2 col-lg-offset-0 col-md-2 col-md-offset-0 col-sm-2 col-sm-offset-0 col-xs-12 col-offset-0 form-group">
                    	<div style="display:none;" id="contract">
                            <div class="req_flds">
                                <select class="form-control single_dropdown lbl_move" data-bsfshare="Contractor" style="width:100%;" select data-placeholder="Select contractor" name="contractor" id="contractor">
                                    <option value="">Select contractor</option>
                                    <?php
                                    foreach($arr_contractor as $d){
                                        echo '<option value="'.$d['VendorId'].'">'.$d['VendorName'].'</option>';
                                    }
                                    ?>
                                </select>
                                <div class="error_message"><p>Please select contract...</p> </div>
                            </div>
                        </div>
                  	</div>
    	        </div>
        	<div class="col-lg-12 feed-bg mar_20">
                <div class="fil-til push_btm_20">
                    <h2 class="h1-head">List of resources from the selected project.</h2>
                    <p class="h1-head push_15">Selected Resources</p>
                    <span class=" h1-head push_15" id="NoOfSelResource">0</span>
                </div>
                <div id="resourceGrid" class="animated fadeInUp"></div>
            </div>
            <input type="hidden" name="frm_index" value="1"/>
        	<div id="requestTransInputsWrapper" class="hide">
            	<input type="hidden" name="frm_index" value="1"/>
    		</div>
		</div>
 	</div>
    <div class="col-lg-12 savebtn_area">
    	<ul>
        	<li id="continueButton" class="dropdown save_btn float_r">
         		<a onclick="validateOnSubmit();" class="ripple">Continue</a>
        	</li>
            <li class="cancel_btn cancel_btn_bluecolor float_l"><a href="<?php echo $this->basePath() . '/mms/issue/entry';?>" 
                class="ripple">Cancel</a>
           	</li>
     	</ul>
  	</div>
</form>	

<script type="text/template" id="request-template">
    <div class="col-md-3">
        <div class="three-box hvr-overline-from-center request-box">
            <ul data-id="{{IssueRegisterId}}">
                <li><span>Request No</span>:&nbsp;{{IssueNo}}</li>
                <li><span>Cost Centre</span>:&nbsp;{{CostCentreName}}</li>
                <li><span>Approved On</span>:&nbsp;{{RequestDate}}</li>
            </ul>
            <span class="high-lit">R</span>
        </div>
    </div>
</script>
<script>
var sel_resource_count = 0;
var tmpLocalData = [];
var $resourceGrid = $("#resourceGrid");
var $searchRequestNo = $('#searchRequestNo');
var resourceSource = {
    localdata: [],
    dataType: "json",
    dataFields: [
        { name: 'Include', type: 'boolean' },
        { name: 'ResourceId', type: 'int' },
        { name: 'Code', type: 'string' },
        { name: 'ResourceName', type: 'string' },
        { name: 'ItemId', type: 'string' },
        { name: 'Quantity', type: 'string' },
        { name: 'IssueNo', type: 'string' },
        { name: 'RequestDate', type: 'string' }
    ],
    id: 'RequestTransId'
};
var resourceAdapter = new $.jqx.dataAdapter(resourceSource);

$(function () {
    $('#CostCentre').on('change',function(){
        $searchRequestNo.val('');
        bindRequests();
    });

    $('#RequestType').on('change',function(){
        $searchRequestNo.val('');

        if($(this).val() == 'service') {
            $('#vendorServiceListWrapper').show();
            $('#vendorServiceList').prop('disabled', false);

            $('#vendorContractListWrapper').hide();
            $('#vendorContractList').prop('disabled', true);
        } else {
            $('#vendorServiceListWrapper').hide();
            $('#vendorServiceList').prop('disabled', true);

            $('#vendorContractListWrapper').show();
            $('#vendorContractList').prop('disabled', false);
        }

        bindRequests();
    });

    $('#WorkType').on('change',function(){
        $searchRequestNo.val('');
        bindRequests();
    });

    $resourceGrid.jqxGrid({
        width: "100%",
        source: resourceAdapter,
        pageable: true,
        pagerMode: 'advanced',
        selectionMode: 'singleRow',
        pagerHeight: 40,
        rowsheight:40,
        autoheight: true,
        pagerButtonsCount: 8,
        editable: true,
        showfilterrow: true,
        filterable: true,
        columns: [
            { dataField: 'RequestTransId', hidden: true},
            { text: '', dataField: 'Include', columntype: 'checkbox', align:'center',width:'15%'},
            { text: 'Code', dataField: 'Code',width:'25%', editable:false},
            { text: 'Resource Name', dataField: 'ResourceName',width:'60%', editable:false}
        ]
    });
    $resourceGrid.on('cellvaluechanged', function (event) {
        var args = event.args;
        var datarow = $resourceGrid.jqxGrid('getrowdata', args.rowindex);
        if(args.newvalue === true)
            sel_resource_count++;
        else
            sel_resource_count--;
        $('#NoOfSelResource').html(sel_resource_count);
        generateSelResourceInputs();
    });
    $('#RequestType').on('change', function () {
        if($(this).val() == 'work') {
            $('#WorkTypeWrapper').show();
        } else {
            $('#WorkTypeWrapper').hide();
        }
    });
    // request check and uncheck
    $('#requestWrapper').on('click','.request-box', function () {
        $(this).toggleClass('selected');
        renderSelectedResources();
    });
    // search by request no.
    $searchRequestNo.on('keyup', function () {
        var requestNo = $.trim($(this).val());
        if(IssueNo.length != 0 && tmpLocalData.length != 0) {
            var filtered_data = $.grep(tmpLocalData, function (o) {
                return new RegExp('^'+IssueNo,'gi').test(o.IssueNo);
            });
            renderRequests(filtered_data);
        } else {
            renderRequests(tmpLocalData);
        }
    });
    // vendor select2
    $(".single_dropdown_vendor").select2({
        placeholder: "",
        templateResult: formatState,
        templateSelection: formatState,
        allowClear: true
    });
});

function formatState (state) {
    if (!state.id) { return state.text; }
    var $state = $('<span class="img-select"><img src="<?php echo $this->basePath() . '/images/avatar.jpg';?>" class="img-flag" /> ' + state.text + '</span>');
    return $state;
}

function bindRequests() {
    var costCentreId = $('#CostCentre').val();
    var RequestType = $('#RequestType').val();
    var workType = $('#WorkType').val();

    if(RequestType == 'work' && workType == '')
        return;

    $.ajax({
        url:getBaseURL()+'mms/issue/save',
        type:"post",
        data:{'CostCentreId':costCentreId, 'RequestType': RequestType, 'WorkType': workType},
        dataType:"json",
        success:function(data, textStatus, jqXHR){
            if(jqXHR.status == 200) {
                renderRequestResources(data.resources);
            }
        }
    });
}

function renderRequests(data) {
    var $requestWrapper = $('#requestWrapper');
    if(data.length == 0) {
        $requestWrapper.html('<p style="text-align: center;padding-top: 88px;">No data to display.</p>');
    } else {
        var template = $('#request-template').html();
        $requestWrapper.html('');
        $.each(data, function (i,o) {
            $requestWrapper.append(template.replace(/\{\{IssueNo\}\}/g,o.IssueNo)
                .replace(/\{\{CostCentreName\}\}/g,o.CostCentreName)
                .replace(/\{\{RequestDate\}\}/g,o.RequestDate)
                .replace(/\{\{IssueRegisterId\}\}/g,o.IssueRegisterId));
        });
    }
}

function renderRequestResources(data) {
    resourceSource.localdata = data;
    resourceAdapter.dataBind();
}

function renderSelectedResources() {
    var $selRequests = $('.request-box.selected');
    $('#NoOfSelRequest').html($selRequests.length);

    // select resources in grid
    if($selRequests.length != 0) {
        var arr_requestIds = [];
        $.each($selRequests, function (i, o) {
            var requestId = $(this).find('ul[data-id]').attr('data-id');
            arr_requestIds.push(IssueRegisterId);
        });

        $.each(resourceSource.localdata, function (j, r) {
            if ($.inArray(r.IssueRegisterId, arr_requestIds) != -1) {
                r.Include = '1';
                sel_resource_count++;
                return;
            }

            r.Include = '0';
        });
    } else {
        $.each(resourceSource.localdata, function (j, r) {
            r.Include = '0';
        });
        sel_resource_count = 0;
    }
    $('#NoOfSelResource').html(sel_resource_count);
    resourceAdapter.dataBind();
    generateSelResourceInputs();
}

function generateSelResourceInputs() {
    var rows = $resourceGrid.jqxGrid('getrows');
    var $inputs = '';
    for(var i = 0; i < rows.length; i++) {
        var row = rows[i];
        if (row.Include === true) {
            $inputs += '<input type="hidden" name="requestTransIds[]" class="requestTransIds" value="' + row.ResourceId + '"/>';
            $inputs += '<input type="hidden" name="itemTransIds[]" class="itemTransIds" value="' + row.ItemId + '"/>';
        }
    }

    $('#requestTransInputsWrapper').html($inputs);
}

function validateOnSubmit() {
    if($('#issue_type').val() == '') {
//            $('#RequestType').select2('open');
        alert('Please select Issue Type');
        return false;
    }

    if($('#issue').val() == '') {
//            $('#vendorServiceList').select2('open');
        alert('Please select issue');
        return false;
    }

    if($('#CostCentre').val() == '') {
//            $('#CostCentre').select2('open');
        alert('Please select Cost Centre');
        return false;
    }


    if($('#issue_date').val() == '') {
//            $('#vendorServiceList').select2('open');
        alert('Please select issue_date');
        return false;
    }

    if($('#NoOfSelResource').html() == 0) {
        alert('Please select resources');
        return false;
    }

    $('#formWrapper').submit();
}
$('#issue_type').on('change', function() {
    var sname = $("#issue_type option:selected").text();
    if(sname=='Contractor'){
       $('#contract').show();
    } else {
        $('#contract').hide();
    }
}).change();
$('.datepickerinput').datepicker({
    format: "dd-mm-yyyy",
    startDate: new Date(),
    todayBtn: true,
    orientation: "top auto",
    autoclose: true
}).on("changeDate", function(e){
    $("#dateSpan").text($(this).val());
});
$('.date_icon').click(function() {
    var input = $(this).parent().find('input').datepicker('show');
});


</script>