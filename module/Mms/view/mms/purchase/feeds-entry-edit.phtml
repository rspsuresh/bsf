<script type="text/javascript" src="<?php echo $this->basePath(); ?>/js/select2.full.min.js"></script>
<link type="text/css" rel="stylesheet" href="<?php echo $this->basePath(); ?>/css/select2.min.css" />
<?php echo $this->headLink(array('rel' => 'shortcut icon', 'type' => 'image/vnd.microsoft.icon', 'href' => $this->basePath() . '/img/favicon.ico'))
?>
<style>
.selected{
	background-color:#6CEDC2;
}
#TermsPickList .jqx-grid-header 	{height:75px !important;}
#contentServicePickList .jqx-grid-header 	{height:75px !important;}
#contentLogisticsPickList .jqx-grid-header 	{height:75px !important;}
.jqx-grid-column-header .jqx-checkbox-default{
	display:none;
}


fieldset.group  { 
  margin: 0; 
  padding: 0; 
  margin-bottom: 1.25em; 
  padding: .125em; 
} 

fieldset.group legend { 
  margin: 0; 
  padding: 0; 
  font-weight: bold; 
  margin-left: 20px; 
  font-size: 100%; 
  color: black; 
} 


ul.checkbox  { 
  margin: 0; 
  padding: 0; 
  margin-left: 20px; 
  list-style: none; 
} 

ul.checkbox li input { 
  margin-right: .25em; 
} 

ul.checkbox li { 
  border: 1px transparent solid; 
  display:inline-block;
  width:100%;
} 

ul.checkbox li label { 
  margin-left: ; 
} 
ul.checkbox li:hover, 
ul.checkbox li.focus  { 
  background-color: lightyellow; 
  border: 1px gray solid; 
  width: 100%; 
} 
</style>
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/js/select2.full.min.js"></script>
<link type="text/css" rel="stylesheet" href="<?php echo $this->basePath(); ?>/css/select2.min.css" />
<style>
.btn.active, .btn:active {
	background:#cecdcd !important;
	box-shadow:none !important
}

</style>
<div class="content_wrapper padlr0">
	<div class="container-fluid">
		<div class="col-lg-12 clear">
			<form class="form-horizontal" method="post" action="feeds-entry">
				<input type="hidden" name="poregId" id="poregId" value="<?php echo $poRegId; ?>">
				<div class="row showDiv" id="firstStep">
					<h1 class="txt_center form_main_h1 frmwrk_h1">New purchase order<?php echo ($vNo['genType']==true) ? '-' : ''; ?><?php echo $poResult['PONo']; ?></h1>
					<div class="form-group">
						<div class="col-lg-4 col-lg-offset-4 col-md-6 col-md-offset-3 col-sm-8 col-sm-offset-2">
							<div class="row" style="<?php echo ($vNo['genType']==true) ? 'display:none' : ''; ?>">
								<div class="form-group req_flds col-lg-12">
									<input type="text" name="voucherNo" id="voucherNo" class="form-control lbl_move" label="Enter voucherNo" value="<?php echo ($vNo['genType']==true) ? $poResult['PONo'] : ''; ?>" >
									<!--<input type="text" id="autocomplete-ajax-x" disabled="disabled" class="form-control" style="color: #CCC; position: static; background: transparent; z-index: 1;">-->
									<div class="error_message" style="display:none;"><p>Please enter VoucherNo...</p> </div> 
								</div>
							</div>
							<div class="row">   
								<div class="form-group req_flds col-lg-12">
									<span class="date_icon"><i class="fa fa-calendar"></i></span>
									<input type="text" name="purchase_date" id="purchase_date" class="form-control lbl_move datepickerinput" label="Purchase date" value='<?php echo $poResult['PODate']; ?>' />
									<div class="error_message"><p>Please enter purchase date...</p> </div> 
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="row showDiv" id="secondStep">
					<div class="col-lg-12">
					
						<div class="row">
								<div class="col-lg-12">
									<h1>New Purchase Order</h1>
								</div>
								<!--form start-->
								<div class="col-lg-12 top_ct" > 
									<!--select project-->
									<div class="col-lg-5 col-lg-offset-7 col-md-7 col-md-offset-4 col-sm-7 col-sm-offset-5 clear">
										
										<div class="form-group req_flds col-lg-12">
											<select name="project_name[]" id="project_name" class="form-control multiple_dropdown selectpicker lbl_move nextVal"  multiple="multiple" label="Select Required Projects" style="width:100%;">
											<?php
												foreach($costResult as $type){ 
													echo "<option value='".$type['data']."' res-id='' dec-id='' cost-id='' >".$type['value']."</option>";
												} 
											?>
											</select>
										</div>
									</div>
									<!--select project--> 
								</div>
								<div class="col-lg-12 clear">
									<div class="row">
									  <div class="col-lg-12 f-gb">
										<div class="col-lg-3 col-md-2 col-sm-2">
										  <div class="form-group">
											<label class="lbs-st">Search for</label>
											<div class="icon-addon addon-sm">
											  <input type="text" id="autocomplete-ajax" placeholder="Select Project" class="btsx">
											  <input type="hidden" name="filterproject_name" id="filterproject_name" class="form-control" >
											  <label class="glyphicon glyphicon-search serc"></label>
											</div>
										  </div>
										</div>
										<div class="col-lg-2 col-md-2 col-sm-2">
										  <div class="form-group">
											<label class="lbs-st">Date</label>
											<div class="icon-addon addon-sm">
											  <input type="text" id="dateFilter" placeholder="DD/MM/YYYY" class="btsx date_picker">
											  <label class="fa fa-calendar serc"></label>
											</div>
										  </div>
										</div>
										<div class="col-lg-3 col-md-3 col-sm-3">
										  <div class="form-group" style="margin-bottom:0px !important;">
											<label class="lbs-st">Viewing</label>
											<div class="btn-group" data-toggle="buttons">
											  <label class="btn bnts-light">
												<input type="radio" name="options" id="optionDay">
												Day</label>
											  <label class="btn bnts-light">
												<input type="radio" name="options" id="optionWeek">
												Week </label>
											  <label class="btn bnts-light">
												<input type="radio" name="options" id="optionMonth">
												Month</label>
											</div>
										  </div>
										</div>
										<div class="col-lg-2 col-md-2 col-sm-2">
										  <div class="form-group">
											<label class="lbs-st">Type</label>
											<div class="select-style"> <span class="slect"></span>
											  <select id="decision_type">
												<option value="0" selected>Select Type</option>
												<option value="2">Material</option>
												<option value="3">Asset</option>
											  </select>
											</div>
										  </div>
										</div>
										<div class="col-lg-2 col-md-3 col-sm-3">
										  <div class="form-group">
											<label class="lbs-st">Matching Results <span class="fil-rew">12</span></label>
											<button type="button" id="overallFilter" class="up-fli">Update Filters</button>
										  </div>
										</div>
									  </div>
									</div>
									<div class="filetr-contents">
									  <div class="fil-til">
										<h2>Purchase Decisions</h2>
										<p>Selected Decisions </p>
										<span>02</span> </div>
									 
									 
									  
									</div>
									<div class="row">
										<div class="col-lg-12">
											<input type="hidden" name="sel_wbsId" id="sel_wbsId" value="none">
											<div id="jqxWidget">
												<div id="decision" style="width:100%;">
												</div>
											</div>
										</div>
									</div>
								</div>
								<div class="col-lg-12 clear">
									<div class="col-lg-6 col-lg-offset-0 col-md-6 col-md-offset-0 col-sm-6 col-sm-offset-0" style="float:left;">
									  <div class="fil-til">
										<h2 style="padding-left:0 !important;">(OR) Select Required Resource</h2>
									  </div>
									  <div class="table-responsive topsp">
											<table class="table table-bordered" id="resourceTable">
												<thead>
													<tr>
														<th>Resource Name</th>
														<th width="4%">&nbsp;</th>
													</tr>
												</thead>
												<tbody>
													<tr>
														<td><input type="text" class="form-control auto-complete" res-id="" dec-id="" cost-id=""></td>
														<td class="action_btns_td">
															<ul class="action_btns">
																<li class="float_r">
																	<a href="javascript:void(0);" class="removeResource" data-toggle="tooltip" data-placement="left" data-original-title="Delete">
																		<span><i class="fa fa-trash-o"></i></span>
																	</a>
																</li>
															</ul>
														</td>
													</tr>
												</tbody>
											</table>
										
									  </div>
									</div>
								   
									<div class="col-lg-6 col-lg-offset-0 col-md-6 col-md-offset-0 col-sm-6 col-sm-offset-0">
									  <div class="fil-til">
										<h2 style="padding-left:0px !important;">Select Required Vendor</h2>
									  </div>
									  <div class="col-sm-8 col-sm-offset-2 clear">
										<div class="sel-pht">
										  <select class="single_dropdown2 lbl_move" name="vendorId" id="vendorId" style="width:100%;" label="Select Vendor..." >
											<option data-image='none' value='0'>Select Service Provider</option>
											<?php
											foreach($serviceProvider as $type1){									
												echo "<option data-image='".$type1['LogoPath']."' value='".$type1['VendorId']."' ".(($type1['VendorId'] == $poResult['VendorId'])?'selected':'').">".$type1['VendorName']."</option>";
											}
											?>
										  </select>
										</div>
									  </div>
									  <div class="add-det">
										<div class="add-dets">
										  <div class="add-lft"> <span class="add-lfts">
											<h4>Preferred Vendor</h4>
											</span> <span class="add-rfts"></span> </div>
										  <div class="add-rgt">
											<p>Material Matching : 8</p>
											<span class="add-fulladd"> <strong>Harish dhananjeyan</strong>
											<p><span>Address  : </span>Micromen Systems & Software Pvt. Ltd,</br>
											  # 2, Sardar Patel Road, Adyar,</br>
											  Chennai - 600 020.</p>
											</span></div>
										</div>
									  </div>
									</div>
								</div>
						</div>
	
	
	
						
						<!--<div class="row" style="margin-top:50px;">
							<div class="col-lg-6">
								
							</div>
							<div class="col-lg-6">
								<table class="table table-bordered" id="costTable">
									<thead>
										<tr>
											<th>Project Name</th>
											<th width="4%">&nbsp;</th>
										</tr>
									</thead>
									<tbody>
										<tr>
											<td><input type="text" class="form-control auto-complete" res-id="" dec-id="" cost-id=""></td>
											<td class="action_btns_td">
												<ul class="action_btns">
													<li class="float_r">
														<a href="javascript:void(0);" class="removeCost" data-toggle="tooltip" data-placement="left" data-original-title="Delete">
															<span><i class="fa fa-trash-o"></i></span>
														</a>
													</li>
												</ul>
											</td>											
										</tr>
									</tbody>
								</table>								
							</div>
						</div>-->
					</div>
				
				</div>
				<div class="row showDiv" id="thirdStep">
					<div class="col-lg-12" style="margin:10px;">
						<div class="row">
							<div class="col-lg-12">				
								<table id="decisionTable" class="table table-bordered" style="margin-top:20px;border-collapse: unset;">
									<thead>
										<tr>
											<th>Code</th>
											<th>Resource</th>
											<th>Unit</th>
											<th>Balance Quantity</th>
											<th>Quantity</th>
											<th>BaseRate</th>
											<th>QualRate</th>
											<th>Amount</th>
											<th>Delivery date</th>
										</tr>
									</thead>
									<tbody>
									<?php
									$result = json_decode($feedsResult, true);
									foreach($result as $rs){
									?>		
										<tr>
											<td class="tbl_input_td"><?php echo $rs['Code']; ?></td>
											<td class="tbl_input_td"><?php echo $rs['ResourceName']; ?></td>
											<td class="tbl_input_td"><?php echo $rs['UnitName']; ?></td>
											<td class="tbl_input_td"><?php echo $rs['Quantity']; ?></td>
											<td class="tbl_input_td">
												<input type="text" tid="<?php echo $rs['ResourceId']; ?>" class="parent_txts tbl_input quanTr" name="transQuantity_<?php echo $rs['ResourceId']; ?>" readonly oldVal="<?php echo $rs['CurQty']; ?>" value="<?php echo $rs['CurQty']; ?>">
												<input type="hidden" tid="<?php echo $rs['ResourceId']; ?>" class="parent_txts tbl_input quanTr" name="hidtransQuantity_<?php echo $rs['ResourceId']; ?>" readonly value="<?php echo $rs['CurQty']; ?>">
											</td>
											<td class="tbl_input_td"><input type="text" class="parent_txts tbl_input baseRate" eleName="transAmount_<?php echo $rs['ResourceId']; ?>" name="transBaserate_<?php echo $rs['ResourceId']; ?>" oldVal="0" value="0"></td>
											<td></td>
											<td class="tbl_input_td"><input type="text" class="parent_txts tbl_input" name="transAmount_<?php echo $rs['ResourceId']; ?>" readonly></td>
											<td class="tbl_input_td"><input type="text" class="parent_txts tbl_input" name="transDeliverydate_<?php echo $rs['ResourceId']; ?>">
											<input type="hidden" class="parent_txts tbl_input" name="unitId_<?php echo $rs['ResourceId']; ?>" value="<?php echo $rs['UnitId']; ?>">
											</td>
										</tr>
									<?php			
									}
									?>
									</tbody>
								</table>
								<table id="subTable" class="table table-bordered" style="margin-top:20px;border-collapse: unset;display:none;">
									<thead>
										<tr>
											<th></th>
										</tr>
									</thead>
									<tbody>
									<?php
									$resourceJson = array();
									foreach($result as $rs){
										$resourceJson[$rs['ResourceId']] = array();
									?>		
										<tr class="subTr_<?php echo $rs['ResourceId']; ?> decSubTr">
											<td colspan=9>
												<div class="subDiv col-lg-11 col-lg-offset-1 padlr0">
													<table class="table table-bordered table-hover" style="border-collapse: unset;">
														<thead>
															<tr>
																<th>RDecisionNo</th>
																<th>Balance Quantity</th>
																<th>Quantity</th>
															</tr>
														</thead>
														<tbody>
														<?php
														foreach($rs['decision'] as $dec){
															$resourceJson[$rs['ResourceId']][$dec['DecisionId']] = array();
														?>					
															<tr class="mainTr" sclass="costSubTr" sdiv="costSubDiv">
																<td><?php echo $dec['RDecisionNo']; ?></td>
																<td><?php echo $dec['Quantity']; ?></td>
																<td class="tbl_input_td">
																	<input type="text" readonly class="parent_txts tbl_input decvalue" name="decisionQty_<?php echo $rs['ResourceId']; ?>_<?php echo $dec['DecisionId']; ?>" oldVal="<?php echo $dec['CurQty']; ?>" value="<?php echo $dec['CurQty']; ?>">
																	<input type="hidden" readonly class="form-control" name="hiddecisionQty_<?php echo $rs['ResourceId']; ?>_<?php echo $dec['DecisionId']; ?>" value="<?php echo $dec['CurQty']; ?>">
																	<input type="hidden" class="form-control" name="reqTransId_<?php echo $rs['ResourceId']; ?>_<?php echo $dec['DecisionId']; ?>" value="<?php echo $dec['RequestTransId']; ?>">
																</td>
															</tr>
															<tr class="costSubTr backgroundtr_vendor">
																<td colspan=9>
																	<div class="costSubDiv col-lg-11 col-lg-offset-1 padlr0">
																		<table class="table table-bordered table-hover" style="border-collapse: unset;">
																			<thead>
																				<tr>
																					<th>CostCentreName</th>
																					<th>Balance Quantity</th>
																					<th>Quantity</th>
																				</tr>
																			</thead>
																			<tbody>
																			<?php
																			foreach($dec['cost'] as $cost){
																				$resourceJson[$rs['ResourceId']][$dec['DecisionId']][$cost['CostcentreId']] = array_column($cost['wbs'], 'RequestAHTransId');
																			?>	
																				<tr class="mainTr" id="project_<?php echo $rs['ResourceId']; ?>_<?php echo $dec['DecisionId']; ?>_<?php echo $cost['CostcentreId']; ?>">
																					<td><?php echo $cost['CostCentreName']; ?></td>
																					<td><?php echo $cost['Quantity']; ?></td>
																					<td class="tbl_input_td">
																						<input type="text" readonly name="costQuantity_<?php echo $rs['ResourceId']; ?>_<?php echo $dec['DecisionId']; ?>_<?php echo $cost['CostcentreId']; ?>" class="parent_txts tbl_input costvalue" oldVal="<?php echo $cost['CurQty']; ?>" value="<?php echo $cost['CurQty']; ?>" >
																						<input type="hidden" readonly name="hidcostQuantity_<?php echo $rs['ResourceId']; ?>_<?php echo $dec['DecisionId']; ?>_<?php echo $cost['CostcentreId']; ?>" class="form-control" value="<?php echo $cost['CurQty']; ?>" >
																					</td>
																				</tr>
																				<tr class="wbsSubTr potblbckclrto">
																					<td colspan=9>
																						<div class="wbsSubDiv col-lg-11 col-lg-offset-1 padlr0">
																							<table class="table table-bordered table-hover" style="border-collapse: unset;">
																								<thead>
																									<tr>
																										<th>Wbs name</th>
																										<th>Balance Quantity</th>
																										<th>Quantity</th>
																									</tr>
																								</thead>
																								<tbody>
																								<?php
																								foreach($cost['wbs'] as $wbs){
																								?>
																									<tr>
																										<td><?php echo $wbs['WbsName']; ?></td>
																										<td><?php echo $wbs['Quantity']; ?></td>
																										<td class="tbl_input_td"><input class-name="quantityVal" type="text" rid="<?php echo $rs['ResourceId']; ?>" class="parent_txts tbl_input quantityVal" oldVal="<?php echo $wbs['CurQty']; ?>" value="<?php echo $wbs['CurQty']; ?>" name="wbsQuantity_<?php echo $rs['ResourceId']; ?>_<?php echo $dec['DecisionId']; ?>_<?php echo $cost['CostcentreId']; ?>_<?php echo $wbs['RequestAHTransId']; ?>"
																											costName="costQuantity_<?php echo $rs['ResourceId']; ?>_<?php echo $dec['DecisionId']; ?>_<?php echo $cost['CostcentreId']; ?>"
																											transName="decisionQty_<?php echo $rs['ResourceId']; ?>_<?php echo $dec['DecisionId']; ?>"
																											resourceName="transQuantity_<?php echo $rs['ResourceId']; ?>">
																											<input type="hidden" rid="<?php echo $rs['ResourceId']; ?>" class="form-control" value="<?php echo $wbs['CurQty']; ?>" name="hidwbsQuantity_<?php echo $rs['ResourceId']; ?>_<?php echo $dec['DecisionId']; ?>_<?php echo $cost['CostcentreId']; ?>_<?php echo $wbs['RequestAHTransId']; ?>">
																											<input type="hidden" class="form-control" value="<?php echo $wbs['AnalysisId']; ?>" name="analysisId_<?php echo $rs['ResourceId']; ?>_<?php echo $dec['DecisionId']; ?>_<?php echo $cost['CostcentreId']; ?>_<?php echo $wbs['RequestAHTransId']; ?>">
																										</td>
																									</tr>
																								<?php		
																								}
																								?>
																								</tbody>
																							</table>	
																						</div>
																					</td>
																				</tr>
																			<?php		
																			}
																			?>
																			</tbody>
																		</table>	
																	</div>
																</td>
															</tr>
														<?php				
														}
														?>
														</tbody>
													</table>	
												</div>
											</td>
										</tr>
									<?php			
									}
									?>
									</tbody>
								</table>
								<table id="cloneTable" class="table table-bordered" style="margin-top:20px;border-collapse: unset;display:none;">
									<thead>
										<tr>
											<th></th>
										</tr>
									</thead>
									<tbody>
									</tbody>
								</table>
								<table id="resTable" class="table table-bordered" style="margin-top:20px;border-collapse: unset;display:none">
									<thead>
										<tr>
											<th>Code</th>
											<th>Resource</th>
											<th>Unit</th>
											<th>Balance Quantity</th>
											<th>Quantity</th>
											<th>BaseRate</th>
											<th>QualRate</th>
											<th>Amount</th>
											<th>Delivery date</th>
										</tr>
									</thead>
									<tbody>
									<?php
									foreach($result as $rs){
									?>		
										<tr>
											<td><?php echo $rs['Code']; ?></td>
											<td><?php echo $rs['ResourceName']; ?></td>
											<td><?php echo $rs['UnitName']; ?></td>
											<td><?php echo $rs['Quantity']; ?></td>
											<td>
												<input type="text" tid="<?php echo $rs['ResourceId']; ?>" class="form-control quanTr" name="transQuantity_<?php echo $rs['ResourceId']; ?>" readonly oldVal="<?php echo $rs['CurQty']; ?>" value="<?php echo $rs['CurQty']; ?>">
												<input type="hidden" tid="<?php echo $rs['ResourceId']; ?>" class="form-control quanTr" name="hidtransQuantity_<?php echo $rs['ResourceId']; ?>" readonly value="<?php echo $rs['CurQty']; ?>">
											</td>
											<td><input type="text" class="form-control baseRate" eleName="transAmount_<?php echo $rs['ResourceId']; ?>" name="transBaserate_<?php echo $rs['ResourceId']; ?>" oldVal="0" value="0"></td>
											<td></td>
											<td><input type="text" class="form-control" name="transAmount_<?php echo $rs['ResourceId']; ?>" readonly></td>
											<td><input type="text" class="form-control" name="transDeliverydate_<?php echo $rs['ResourceId']; ?>">
											<input type="hidden" class="form-control" name="unitId_<?php echo $rs['ResourceId']; ?>" value="<?php echo $rs['UnitId']; ?>">
											</td>
										</tr>
									<?php			
									}
									?>
									</tbody>
								</table>								
							</div>
						</div>
						<input type="hidden" name="hidjson" id="hidjson" value='<?php echo json_encode($resourceJson); ?>'>
					</div>		
				</div>
				<!--first Entry-->
				<div class="row showDiv" id="fourthStep">
					<div class="form-group">
						<div class="col-lg-4 col-lg-offset-4 col-md-6 col-md-offset-3 col-sm-8 col-sm-offset-2">
							<div class="row">   
								<div class="form-group req_flds col-lg-12">	
									<div id="distributorList"></div>
								</div>
							</div>
							<div class="row">   
								<div class="form-group req_flds col-lg-12">
									<div class="commargin_ttop_20 ">								
										<select id="currency" name="currency" class="single_dropdown lbl_move" style="width:100%;" label="Select currency" >
											<option value='0'>Select Currency</option>
											<?php
											foreach($currencyList as $curList){									
												echo "<option value='".$curList['CurrencyId']."' ".(($curList['CurrencyId'] == $poResult['CurrencyId'])?'selected':'').">".$curList['CurrencyName']."</option>";
											}
											?>				
										</select>
										<script>
                                            $(document).ready(function() {
                                                $(".single_dropdown").select2({
                                                    placeholder: "",
                                                    allowClear: true,
                                                });
                                            });
                                        </script>
									</div>
								</div>
							</div>
							<div class="row">   
								<div class="form-group req_flds col-lg-12">	
									<ul class="list ui-sortable" data-sortable="true">
										<li class="tile ui-sortable-handle">
											<div class="checkbox checkbox-styled tile-text">
												<label>
													<input type="checkbox" class="includetax" name="includetax" id="all_resource">
													<span>IncludeTax</span>
												</label>
											</div>
										</li>
										<li class="tile ui-sortable-handle">
											<div class="checkbox checkbox-styled tile-text">
												<label>
													<input type="checkbox" class="Readyforapproval" name="Readyforapproval" id="all_resource">
													<span>Ready for approval</span>
												</label>
											</div>
										</li>
									</ul>	
								</div>
							</div>		
						</div>
					</div>
				</div>	
				<!--Second Entry-->
				<div class="row showDiv" id="firstStep">
					<h1 class="padbtm0 col-lg-6 col-lg-offset-3 col-md-6 col-md-offset-3 col-sm-8 col-sm-offset-2 padlr0">Add additional details to this purchase order</h1>
					<div class="form-group">
						<div class="col-lg-6 col-lg-offset-3 col-md-6 col-md-offset-3 col-sm-8 col-sm-offset-2 commargin_top_20">
							<div class="row">   
								<div class="form-group col-lg-12 col-xs-12">
									<h1 class="col-lg-6 col-md-6 txt_left vendorrequest_text">Terms</h1>
									<div class="col-lg-6 col-md-6">
										<div class="radio_check">
											<p>
												<input type="radio" value="1" id="default" name="terms"/>
												<label for="buyer">Default</label>
											</p>
											<p>
												<input type="radio" value="2" id="Manual" name="terms" checked/>
												<label for="investor">Manual</label>
											</p>
										</div>
									</div>
								</div>
							</div>
							<div class="row">
                                <div class="form-group col-lg-12 col-xs-12">
                                    <h1 class="col-lg-6 col-md-6 txt_left vendorrequest_text">Logistics</h1>
                                    <div class="col-lg-6 col-md-6">  
                                        <div class="radio_check">
                                            <p>
                                                <input type="radio" value="1" id="default1" name="logistics"/>
                                                <label for="buyer">Default</label>
                                            </p>
                                            <p>
                                                <input type="radio" value="2" id="Manual1" name="logistics" checked/>
                                                <label for="investor">Manual</label>
                                            </p>
                                        </div>
                                    </div>
                                </div>    
                            </div>	
							<div class="row">
                                <div class="form-group col-lg-12 col-xs-12">
                                    <h1 class="col-lg-6 col-md-6 txt_left vendorrequest_text">Delivery Address</h1>
                                    <div class="col-lg-6 col-md-6">  
                                        <div class="radio_check">
                                            <p>
                                                <input type="radio" value="1" id="default2" name="deliveryaddress"/>
                                                <label for="buyer">Default</label>
                                            </p>
                                            <p>
                                                <input type="radio" value="2" id="Manual2" name="deliveryaddress" checked/>
                                                <label for="investor">Manual</label>
                                            </p>
                                        </div>
                                    </div>
                                </div>    
                            </div>	
							<div class="row">   
								<div class="form-group req_flds col-lg-11">						
									<select id="paymentmethod" name="paymentmethod" class="single_dropdown lbl_move" style="width:100%;" label="Select payment method">
										<option value='0'>Select payment method</option>
										<?php
										foreach($currencyList as $curList){									
											echo "<option value='".$curList['CurrencyId']."' ".(($curList['CurrencyId'] == $poResult['CurrencyId'])?'selected':'').">".$curList['CurrencyName']."</option>";
										}
										?>				
									</select>
									<script>
										$(document).ready(function() {
											$(".single_dropdown").select2({
												placeholder: "",
												allowClear: true,
											});
										});
									</script>
								</div>
							</div>
						</div>	
					</div>
				</div>
				<!--Third Entry-->
				<div class="row showDiv" id="sixthStep">
					<h1 class="txt_center commargin_bottom_20">Terms And Conditions</h1>
					<div class="form-group">
						<div class="col-lg-12 col-md-12 col-sm-12">
							<div class="row">   
								<div class="form-group col-lg-6">
									<h1 class="txt_center vendorrequest_text commargin_bottom_20">Terms Regarding Rate and Quantity</h1>								
									<div id="TermsPickList"></div>
								</div>
								<div class="form-group col-lg-6">
									<h1 class="txt_center vendorrequest_text commargin_bottom_20">Manual Term entry</h1>
                                    <div class="borderfull">
                                        <div id="appendDiv">
                                            <div class="form-group commargin_ttop_20">
                                                <input type="text" id="title" name="title_1" tagname="title" label="Enter Term Title" class="form-control lbl_move" />	
                                            </div>
                                            <div class="form-group" style="">				
                                                <textarea id="termsdescription" name="termsdescription_1" tagname="termsdescription" label="Enter Your Description" class="form-control lbl_move"></textarea>
                                            </div>
                                            <div class="form-group">
                                                <div class="col-lg-10 col-lg-offset-2">
                                                    <span class=" parent_txts vendor_technicalupload btn-file"> 
                                                        Upload your document &nbsp; &nbsp;<span class="font_upload" style="color: #43b6d4"><i class="fa fa-cloud-upload"></i></span>
                                                        <input type="file" id="termdocument" name="termdocument_1" tagname="termdocument" class="font_unset"/>
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="col-lg-4 col-lg-offset-5">
                                                    <a href="#" class="vendor_addnew">Addnew</a>
                                                </div>
                                            </div>	
                                        </div>
                                    </div>	
								</div>
							</div>
						</div>
					</div>
					<div class="form-group">
						<div class="col-lg-12">
							<table class="table" id="termTable">
								<thead>		
									<tr>
										<th>SlNo</th>
										<th>Terms</th>
										<th>ValueFromNet</th>
										<th>Per</th>
										<th>Value</th>
										<th>Period</th>
										<th>Date</th>
										<th>Str</th>
									</tr>
								</thead>
								<tbody class="appendData">
								<?php foreach($resultsFillTermdet as $termResult){ ?>
									<tr class="deleteTermTr_<?php echo $termResult['TermsId']; ?>" id="<?php echo $termResult['TermsId']; ?>">
										<td><?php echo $termResult['SlNo']; ?></td>
										<td><?php echo $termResult['Terms']; ?></td>
										<td>
											<input type='text' class='form-control' name='ValueFromNet_<?php echo $termResult['TermsId']; ?>' value="<?php echo $termResult['ValueFromNet']; ?>">
										</td>
										<td>
											<input type='text' <?php if($termResult['IsPer']== 0){ echo "readonly"; } ?> class='form-control' name='Per_<?php echo $termResult['TermsId']; ?>' value="<?php echo $termResult['Per']; ?>">
										</td>
										<td>
											<input type='text' <?php if($termResult['IsValue']== 0){ echo "readonly"; } ?> class='form-control' name='Value_<?php echo $termResult['TermsId']; ?>' value="<?php echo $termResult['Value']; ?>">
										</td>
										<td>
											<input type='text'  <?php if($termResult['IsPeriod']== 0){ echo "readonly"; } ?> class='form-control' name='Period_<?php echo $termResult['TermsId']; ?>' value="<?php echo $termResult['Period']; ?>">
										</td>
										<td>
											<input type='text' <?php if($termResult['IsDate']== 0){ echo "readonly"; } ?>  class='form-control' name='Date_<?php echo $termResult['TermsId']; ?>' value="<?php echo $termResult['Date']; ?>">
										</td>
										<td>
											<input type='text' <?php if($termResult['IsString']== 0){ echo "readonly"; } ?>  class='form-control' name='Str_<?php echo $termResult['TermsId']; ?>' value="<?php echo $termResult['Str']; ?>">
										</td>
									</tr>																	 
								<?php }  ?>
								</tbody>
							</table>
							<table class="table" id="termTableDuplicate" style="display:none;">
								<thead>		
									<tr>
										<th>SlNo</th>
										<th>Terms</th>
										<th>ValueFromNet</th>
										<th>Per</th>
										<th>Value</th>
										<th>Period</th>
										<th>Date</th>
										<th>Str</th>
									</tr>
								</thead>
								<tbody class="appendData">
								<?php foreach($resultsFillTermdet as $termResult){ ?>
									<tr class="deleteTermTr_<?php echo $termResult['TermsId']; ?>" id="<?php echo $termResult['TermsId']; ?>">
										<td><?php echo $termResult['SlNo']; ?></td>
										<td><?php echo $termResult['Terms']; ?></td>
										<td>
											<input type='text' class='form-control' name='ValueFromNet_<?php echo $termResult['TermsId']; ?>' value="<?php echo $termResult['ValueFromNet']; ?>">
										</td>
										<td>
											<input type='text' <?php if($termResult['IsPer']== 0){ echo "readonly"; } ?> class='form-control' name='Per_<?php echo $termResult['TermsId']; ?>' value="<?php echo $termResult['Per']; ?>">
										</td>
										<td>
											<input type='text' <?php if($termResult['IsValue']== 0){ echo "readonly"; } ?> class='form-control' name='Value_<?php echo $termResult['TermsId']; ?>' value="<?php echo $termResult['Value']; ?>">
										</td>
										<td>
											<input type='text'  <?php if($termResult['IsPeriod']== 0){ echo "readonly"; } ?> class='form-control' name='Period_<?php echo $termResult['TermsId']; ?>' value="<?php echo $termResult['Period']; ?>">
										</td>
										<td>
											<input type='text' <?php if($termResult['IsDate']== 0){ echo "readonly"; } ?>  class='form-control' name='Date_<?php echo $termResult['TermsId']; ?>' value="<?php echo $termResult['Date']; ?>">
										</td>
										<td>
											<input type='text' <?php if($termResult['IsString']== 0){ echo "readonly"; } ?>  class='form-control' name='Str_<?php echo $termResult['TermsId']; ?>' value="<?php echo $termResult['Str']; ?>">
										</td>
									</tr>																	 
								<?php }  ?>
								</tbody>
							</table>
						</div>	
					</div>
				</div>		
				<!--Fifth Entry-->
				<div class="row showDiv" id="seventhStep">
					<h1 class="txt_center">Contact And Delivery Details</h1>
					<div class="form-group">
						<div class="col-lg-4 col-lg-offset-4 col-md-6 col-md-offset-3 col-sm-8 col-sm-offset-2">
							<h1 class="txt_center vendorrequest_text">Contact Details</h1>
							<div class="row">   
								<div class="form-group col-lg-12">
									<div class="commargin_ttop_20">
										<select name="Branch" id="Branch" class="single_dropdown lbl_move" style="width:100%;" label="Select Branch">
											<option value='0'>Select Branch</option>
											<?php
											foreach($vendorBranch as $branch){	
												echo "<option value='".$branch['BranchId']."' ".(($branch['BranchId'] == $poResult['BranchId'])?'selected':'').">".$branch['BranchName']."</option>";
											}
											?>
										</select>
										<script>
                                            $(document).ready(function() {
                                                $(".single_dropdown").select2({
                                                    placeholder: "",
                                                    allowClear: true,
                                                });
                                            });
                                        </script>
                                    </div>
								</div>
							</div>		
							<div class="row">   
								<div class="form-group req_flds col-lg-12">
									<input type="text" id="branchcontactno" name="branchcontactno" label="Branch Contact No" value="<?php echo $poResult['Phone']; ?>" class="form-control lbl_move" />
								</div>
							</div>	
							<div class="row">   
								<div class="col-lg-12">
                                	<div class="commargin_ttop_20">
										<select name="Branchcontactperson" id="Branchcontactperson" class="single_dropdown lbl_move" style="width:100%;" label="Select Branch contactperson" >
										<option value='0'>Select Contact</option>
										<?php
										foreach($branchContact as $contact){	
											echo "<option value='".$contact['BranchTransId']."' ".(($contact['BranchTransId'] == $poResult['BranchTransId'])?'selected':'').">".$contact['ContactPerson']."</option>";
										}
										?>
										</select>
										<script>
                                            $(document).ready(function() {
                                                $(".single_dropdown").select2({
                                                    placeholder: "",
                                                    allowClear: true,
                                                });
                                            });
                                        </script>
                                    </div>
								</div>
							</div>
							<h1 class="txt_center form_main_h1 frmwrk_h1">Address Details</h1>
							<div class="row">   
								<div class="form-group req_flds col-lg-12">
									<input type="text" id="addressline1" name="addressline1" label="Address line 1" value="<?php echo $poResult['Address1']; ?>" class="form-control lbl_move" />	
								</div>
							</div>	
							<div class="row">   
								<div class="form-group req_flds col-lg-12">							
									<input type="text" id="addressline2" name="addressline2" label="Address line 2" value="<?php echo $poResult['Address2']; ?>" class="form-control lbl_move" />	
								</div>
							</div>	
							<div class="row">   
								<div class="form-group req_flds col-lg-12">
									<input type="text" id="addressline3" name="addressline3" label="Address line 3" value="<?php echo $poResult['Address3']; ?>" class="form-control lbl_move" />	
								</div>
							</div>
							<div class="row">   
								<div class="form-group req_flds col-lg-12">
									<input type="text" id="city" name="city" label="city" class="form-control lbl_move" value="<?php echo $poResult['City']; ?>" />	
								</div>
							</div>
							<div class="row commargin_bottom ">   
								<div class="form-group req_flds col-lg-12">
									<input type="text" id="pincode" name="pincode" label="pincode" class="form-control lbl_move" value="<?php echo $poResult['Pincode']; ?>" />	
								</div>
							</div>
							<div class="row">   
								<div class="form-group req_flds col-lg-12">
									<span class="date_icon"><i class="fa fa-calendar"></i></span>
									<input type="text" name="delivery_date" id="delivery_date" class="form-control lbl_move datepickerinput" label="Delivery date" value='<?php echo Date('d-m-Y'); ?>' />
									<div class="error_message"><p>Please enter purchase date...</p> </div> 									
								</div>
							</div>
						</div>	
					</div>
				</div>
				<!--Sixth Entry-->
				<div class="row showDiv" id="eightStep">
					<h1 class="txt_center">Logistics</h1>
					<div class="form-group">
						<div class="col-lg-12">				
							<div class="row">   
								<div class="form-group req_flds">
									<div class="col-lg-6">
                                        <div class="commargin_ttop_20">
											<select name="serviceprovider" id="serviceprovider" class="single_dropdown lbl_move"  style="width:100%;" label="Select Service Provider">
												<option value='0'>Select Service Provider</option>
												<?php
												foreach($serviceProvider as $serviceList){
													echo "<option value='".$serviceList['VendorId']."' ".(($serviceList['VendorId'] == $poResult['ProviderId'])?'selected':'').">".$serviceList['VendorName']."</option>";
												}
												?>	
											</select>
											<script>
                                                $(document).ready(function() {
                                                    $(".single_dropdown").select2({
                                                        placeholder: "",
                                                        allowClear: true,
                                                    });
                                                });
                                            </script>
                                        </div>
                                    </div>
									<div class="col-lg-6">
                                        <div class="commargin_ttop_20">
											<select name="transportmode" id="transportmode" style="width:100%;" class="single_dropdown lbl_move" label="Select Transport Mode">
												<option value='0'>Select Transport Mode</option>
												<?php
												foreach($transPortMode as $mode){									
													echo "<option value='".$mode['TransportId']."' ".(($mode['TransportId'] == $poResult['VehicleId'])?'selected':'').">".$mode['TransportName']."</option>";
												}
												?>	
											</select>
											<script>
                                                $(document).ready(function() {
                                                    $(".single_dropdown").select2({
                                                        placeholder: "",
                                                        allowClear: true,
                                                    });
                                                });
											</script>
										</div>
                                    </div>
								</div>
							</div>
							<div class="col-lg-12">
                                <div class="row">   
                                    <div class="form-group req_flds col-lg-6">
                                        <h1 class="form_main_h1 frmwrk_h1">Select Type Of service</h1>
                                        <div id="ServicePickList"></div>
                                    </div>
                                    <div class="form-group req_flds col-lg-6">
                                        <h1 class="form_main_h1 frmwrk_h1">Select Logistics Type</h1>
                                        <div id="LogisticsPickList"></div>
                                    </div>
                                </div>
                            </div>
						</div>	
					</div>
				</div>
				<!--Seventh Entry-->
				<div class="row showDiv" id="ninethStep">
					<h1 class="txt_center">Logistics</h1>
					<div class="form-group">
						<div class="col-lg-5 col-lg-offset-4 col-md-6 col-md-offset-3 col-sm-8 col-sm-offset-2 borderfull" style="padding: 30px !important">				
							<div class="row">   
								<div class="form-group req_flds col-lg-12">				
									<a href="#" class="polnkButton">PO Entered By : <?php echo "Name";?><span class="float_r"> <i class="fa fa-pencil"></i></span></a>									
								</div>
							</div>	
							<div class="row">   
								<div class="form-group req_flds col-lg-12">
                                	<a href="#" class="polnkButton">Totel Item : No. of item selected <span class="float_r"> <i class="fa fa-pencil"></i></span></a>	
								</div>
							</div>	
							<div class="row">   
								<div class="form-group req_flds col-lg-12">
                                	<a href="#" class="polnkButton">Estimated Rate : Rate of an Item <span class="float_r"> <i class="fa fa-pencil"></i></span></a>	
								</div>
							</div>
							<div class="row">   
								<div class="form-group req_flds col-lg-12">	
                                	<a href="#" class="polnkButton">Round Off : Rounded amount for an item <span class="float_r"> <i class="fa fa-pencil"></i></span></a>	
								</div>
							</div>
							<div class="row">   
								<div class="form-group req_flds col-lg-12">	
                                	<a href="#" class="polnkButton">Net Amount: Final amount of an Item <span class="float_r"> <i class="fa fa-pencil"></i></span></a>	
								</div>
							</div>	
							<div class="row">   
								<div class="form-group req_flds col-lg-12">	
                                	<a href="#" class="polnkButton">PO Date : Item purchase on 18-11-2015 <span class="float_r"> <i class="fa fa-pencil"></i></span></a>	
								</div>
							</div>	
							<div class="row">   
								<div class="col-lg-12">
                                	<a href="#" class="polnkButton">Approved By : Rate approved by a person <span class="float_r"> <i class="fa fa-pencil"></i></span></a>	
								</div>
							</div>	
						</div>	
					</div>
				</div>
				<input type="hidden" name="gridServiceId" id="gridServiceId">
				<input type="hidden" name="gridLogisticstypeId" id="gridLogisticstypeId">
				<input type="hidden" name="distributorListId" id="distributorListId">
				<input type="hidden" name="gridtermListId" id="gridtermListId">				
			</form>	
		</div>
	</div>
</div>
<div class="popover right" role="tooltip" style="top: 29px; left: 262px;display:none;z-index:750;">
	<div class="arrow" style="top: 50%;">
	</div>
	<!--<h3 class="popover-title">Resource</h3>-->
	<div class="popover-content">
	</div>
</div>
<div class="col-lg-12 savebtn_area">
    <ul>
        <li id="continueButton" class="dropdown save_btn float_r">
            <a href="javascript:void(0);" class="ripple">Continue</a>
        </li>
        <li id="backButton" class="cancel_btn float_r" style="display:none;"><a href="javascript:void(0);" class="ripple">back</a></li>
		 <li class="cancel_btn cancel_btn_bluecolor float_l"><a id="cancelbutton" class="ripple" onclick="alert confirm();">cancel</a></li>
    </ul>
</div>


<script>
$(".showDiv").hide();
$("#backButton").hide();
$("#firstStep").show();
	
$('.datepickerinput').datepicker({
	format: "dd-mm-yyyy",
	todayBtn: true,
	orientation: "top auto",
	autoclose: true
}).on("changeDate", function(e){
	$("#dateSpan").text($(this).val());
});	
$('.date_icon').click(function() {
	var input = $(this).parent().find('input').datepicker('show');
});
	
/*Decision picklist*/
var resJson = <?php echo json_encode($resJson); ?>;
var oldJson = JSON.stringify(resJson);

function unique(array){
    return $.grep(array, function(el, index) {
        return index == $.inArray(el, array);
    });
}

$(document).ready(function() {
		$(".multiple_dropdown").select2({
		});
	});

/*$(".multiple_dropdown").change(function() {
    //alert($(".multiple_dropdown").val())
});*/

/*
$(".multiple_dropdown").change(function(element, checked) {
	var brands = $('.multiple_dropdown option:selected');
	var selected = [];
	$(brands).each(function(index, brand){
		selected.push($(this).val());
	});

	console.log(selected);
});
	
	$(".multiple_dropdown").on("select2-highlight", function(e) {
			console.log("highlighted val=" + e.val);
          //console.log("highlighted val=" + e.val + " choice=" + e.choice.text);
        });
	$(".multiple_dropdown").on("select2:select", function (e) { 
	//console.log("select2:select"); 
	 console.log("select val=" + e.val);
	 //console.log("selecting val=" + e.val + " choice=" + e.object.text);
	});
$(".multiple_dropdown").on("select2:unselect", function (e) { 
//console.log("select2:unselect");
console.log("Unselect val=" + e.val);
//console.log("removed val=" + e.val + " choice=" + e.choice.text);
 });
*/
 //start
 //var $eventLog = $(".js-event-log");
 var $eventSelect = $(".multiple_dropdown");
 
$eventSelect.on("select2:open", function (e) { 
//log("select2:open", e);
 });
$eventSelect.on("select2:close", function (e) {
// log("select2:close", e);
 });
$eventSelect.on("select2:select", function (e) { log("select2:select", e); });
$eventSelect.on("select2:unselect", function (e) { log("select2:unselect", e); });
 
function log (name, evt) {
  if (!evt)
	return;

	var id = evt.params.data.id,
	isSelected = evt.params.data.selected;
	if(isSelected){
		fillCost(id, 1);
	}
	else{
		fillCost(id, 2);
	}
}

var decArr = <?php echo json_encode($feedResult); ?>;

var resArr=<?php echo json_encode($resResult); ?>;
var resArrCopy = <?php echo json_encode($resResult); ?>;

var costArr=<?php echo json_encode($costResult); ?>;
var costArrCopy = <?php echo json_encode($costResult); ?>;


var decSource ={
	localData: <?php echo json_encode(array_chunk($feedResult,3)); ?>,
	dataType: "json",
};

var decDataAdapter = new $.jqx.dataAdapter(decSource);


$("#decision").jqxDataTable({
	width: '100%',
	pageable: true,
	pageSize: 3,
	pagerButtonsCount: 5,
	enableHover: false,
	selectionMode: 'none',
	rendered: function () {
		
	},
	rendering: function () {
		
	},	
	source: decDataAdapter,	
	columns: [
		  {
			  text: 'Decision List', cellsAlign: 'centre', dataField: 'VendorName',  width:'100%', cellClassName:"sample",
			  // row - row's index.
			  cellsrenderer: function (row, column, value, rowData) {
				  var container = '';
										$.each(rowData, function(i,v){
											if(v.RDecisionNo){
												container += '<div class="col-lg-4 col-md-4 col-sm-6 decisionCell" id="decisonCell_'+v.DecisionId+'" onClick=\'decisionSelect('+JSON.stringify(v)+', this);\' sel="0">'+
																'<div class="list-put row fillrow '+(($.inArray(v.DecisionId, decId) != -1)?"selected":"")+'"> <a href="#" class="close-bt"><i class="fa fa-times"></i></a>'+
																	'<div class="left-cap"   onmouseover=\'resourceList('+v.DecisionId+', this);\' onmouseleave=\'removePopup();\'> <strong class="strngpad">A</strong> <img src="<?php echo $this->basePath(); ?>/images/hart.png" class="poimgpadstrng" alt=""></div>'+
																	  '<div class="mid-cap">'+
																		'<p>'+v.RDecisionNo+'</p>'+
																		'<span>Approved On :</span> <b class="dates-sh">'+v.DecDate+' </b> <strong>Ni185</strong> </div>'+
			
						'</div>'+
						'</div>';
											}
										});				
				  return container;
			  }
		  }		  
	]
});
$('#autocomplete-ajax').autocomplete({
        // serviceUrl: '/autosuggest/service/url',
        lookup: <?php echo json_encode(array_values($costResult)); ?>,
		multiselect:true,
        lookupFilter: function(suggestion, originalQuery, queryLowerCase) {
            var re = new RegExp('\\b' + $.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
            return re.test(suggestion.value);
        },
        onSelect: function(suggestion) {
			$("#filterproject_name").val(suggestion.data);
        },
       onHint: function (hint) {
            //$('#autocomplete-ajax-x').val(hint);
        },
        onInvalidateSelection: function() {
            //$('#selction-ajax').html('You selected: none');
        }
    }).bind("blur", function(){
		if($.inArray($(this).val(), <?php echo json_encode(array_column($costResult, 'value')); ?>) == -1){
			$(this).val('');
			$("#filterproject_name").val('0');
		}	
	})
	
//Overall Filter
$('#overallFilter').click(function(){
	//$("#decision").jqxDataTable('clear');
	var iproj=$("#filterproject_name").val();
	if(iproj=="") {iproj=0;}
	var iType=$("#decision_type").val();
	var dDate=$("#dateFilter").val();
	var bDay=0,bWeek=0,bMonth=0;
	if($('#optionDay').is(':checked')){ bDay=1; }
	if($('#optionWeek').is(':checked')){ bWeek=1; }
	if($('#optionMonth').is(':checked')){ bMonth=1; }
	
	$.ajax({
		url:getBaseURL()+'mms/purchase/feeds-entry',
		type:"post",
		data:'mode=filterStep&iType='+iType+'&bDay='+bDay+'&bWeek='+bWeek+'&bMonth='+bMonth+'&dDate='+dDate+'&iproj='+iproj,
		dataType:"json",
		success:function(data, textStatus, jqXHR){
			decSource.localdata = data['result'];
			decDataAdapter.dataBind();
		}					
	});
});
var removePopup = function(){
	setTimeout(function(){
		if(!$('.popover').is(':hover') && $('.decisionCell:hover').length == 0 && $('#resourceTable .auto-complete:hover').length == 0){
			$('.popover').hide();
			$('.popover').attr('id', '');
			$('.popover-content').html('');
		}		
	}, 300);
}
$('.popover').mouseleave(function(){
	setTimeout(function(){
		if($('.decisionCell:hover').length == 0){
			$('.popover').hide();
			$('.popover').attr('id', '');
			$('.popover-content').html('');
		}		
	}, 300);	
});
var resourceList = function (dsid, invoker){
	if($('.popover').attr('id') == 'dec_'+dsid)
		return false;
	else
		$('.popover').attr('id', 'dec_'+dsid);
	
	$('.popover-title').text('Resource');
	if(!$('.popover').is(':visible'))
		$('.popover').show();

	$('.popover-content').html('');
	var cost = unique(decArr[dsid].CostCentreId.split(','));
	var cost1 = decArr[dsid].CostCentreId.split(',');
	var resource = decArr[dsid].ResourceId.split(',');
	$('.popover-content').append('<div class="col-lg-12 fieldset">'+
		'<h1 class="vendorrequest_txtchng">Select costcenter and resource</h1><ul class="checkbox">');
		for(var cc in cost){
			var costIndex = cost1.reduce(function(a, e, i) {
							if (e === cost[cc])
								a.push(i);
							return a;
						}, []);
			var res = unique(resource.reduce(function(a, e, i) {
								if ($.inArray(i,costIndex) != -1)
									a.push(e);
								return a;
							}, []));
			var finRes = $.grep(res, function(element){
							return $.inArray(element, Object.keys(resJson)) !== -1;
						});	
			
			var costBool = false;
			var arrRes = [];
			for(var rr in finRes){
				if(resJson[finRes[rr]]){
					if(resJson[finRes[rr]][dsid]){
						if($.inArray(cost[cc], resJson[finRes[rr]][dsid].cost) != -1){
							arrRes.push(finRes[rr]);
							costBool = true;
						}
					}
				}
			}
			$('.popover-content ul:first').append(
				'<li>'+
				'<div class="radio_check"><p style="padding:11px 20px 4px 0px !important">'+
					'<input type="checkbox" id="cost_'+cost[cc]+'" name="cost_'+cost[cc]+'" cost-id="'+cost[cc]+'" dec-id="'+dsid+'" '+((costBool)?"checked":"")+' onclick=\'resSelect(this, "cost");\' />'+
					'<label class="ripple" for="cost_'+cost[cc]+'">'+costArr[cost[cc]].value+'</label>'+
					'</p></div>');
				if(res.length > 0){
					$('.popover-content li:last').append(
						'<ul class="checkbox">');
						for(var rr in res){
							$('.popover-content ul:last').append(
								'<li>'+
								'<div class="radio_check"><p>'+
									'<input type="checkbox" id="resource_'+res[rr]+'" name="resource_'+res[rr]+'" '+(($.inArray(res[rr], arrRes) != -1)?"checked":"")+' cost-id="'+cost[cc]+'" res-id="'+res[rr]+'" dec-id="'+dsid+'" onclick=\'resSelect(this, "res");\' />'+
									'<label class="ripple" for="resource_'+res[rr]+'">'+resArr[res[rr]].value+'</label>'+
									'</p></div>'+
								'</li>');
						}
				}
				$('.popover-content ul:first').append('</li>');
		}		
	$('.popover').animate({left: parseFloat($(invoker).offset().left) - 60, top:parseFloat($(invoker).offset().top) - parseFloat($('header').height())  - (parseFloat($('.popover .arrow').offset().top) - parseFloat($('.popover').offset().top))});
}
var resSelect = function(invoker, mode){
	var dsid = $(invoker).attr('dec-id');
	if(mode == 'cost'){
		var cid = $(invoker).attr('cost-id');
		var resource = decArr[dsid].ResourceId.split(',');
		var cost1 = decArr[dsid].CostCentreId.split(',');
		var costIndex = cost1.reduce(function(a, e, i) {
						if (e === cid)
							a.push(i);
						return a;
					}, []);
		var rsid = unique(resource.reduce(function(a, e, i) {
							if ($.inArray(i,costIndex) != -1)
								a.push(e);
							return a;
						}, []));		
		if($(invoker).is(':checked')){
			$(invoker).closest('div').nextAll('ul').find('input:checkbox').prop('checked', true);
			for(var res in rsid){
				if(!resJson[rsid[res]]){
					resJson[rsid[res]]={};
					resJson[rsid[res]][dsid] = {};
					resJson[rsid[res]][dsid].cost = cid.split(',');
					addResource(rsid[res]);
					$('#decisonCell_'+dsid).find('.fillrow').addClass('selected');
					if($.inArray(cid, costId) == -1)
						addCost(cid);
					
					decId.push(dsid);
				}
				else{
					if(!resJson[rsid[res]][dsid]){
						resJson[rsid[res]][dsid] = {};
						resJson[rsid[res]][dsid].cost = cid.split(',');
						$('#decisonCell_'+dsid).find('.fillrow').addClass('selected');
						if($.inArray(cid, costId) == -1)
							addCost(cid);
					
						decId.push(dsid);
					}
					else{
						$.merge(resJson[rsid[res]][dsid].cost, cid.split(','));
						if($.inArray(cid, costId) == -1)
							addCost(cid);
					}
				}
				costId.push(cid);
			}			
		}
		else{
			for(var res in rsid){
				if($(invoker).closest('div').nextAll('ul').find('input[res-id='+rsid[res]+']').is(':checked')){
					resJson[rsid[res]][dsid].cost.splice($.inArray(cid, resJson[rsid[res]][dsid].cost),1);
					costId.splice($.inArray(cid, costId), 1);
					if($(invoker).closest('.fieldset').find('input[name=resource_'+rsid[res]+']:checked').length == 1){
						decId.splice($.inArray(dsid, decId), 1);
						delete resJson[rsid[res]][dsid];
					}
					if($.inArray(dsid, decId) == -1){
						$('#decisonCell_'+dsid).find('.fillrow').removeClass('selected');
					}
					if($.inArray(cid, costId) == -1){
						costArrCopy[cid] = costArr[cid];
						$('#costTable input[cost-id='+cid+']').closest('tr').remove();
						$('.multiple_dropdown option[value='+cid+']').removeAttr('selected');

						var i = $.inArray(cid,cis1)
						if (i >= 0){
							cis1.splice(i, 1);
						}						
						//cis1.splice(cid, 1);
						//alert(cid)
						//alert(cis1)
					}
					if(Object.keys(resJson[rsid[res]]).length == 0){
						resArrCopy[rsid[res]] = resArr[rsid[res]];
						$('#resourceTable input[res-id='+rsid[res]+']').closest('tr').remove();	
						delete resJson[rsid[res]];
					}
				}
			}
			$( ".multiple_dropdown" ).val(unique(cis1)).trigger("change");
			$(invoker).closest('div').nextAll('ul').find('input:checkbox').prop('checked', false);
		}
	}
	else{
		var cid = $(invoker).attr('cost-id');
		var rid = $(invoker).attr('res-id');
		if($(invoker).is(':checked')){
			if(!resJson[rid]){
				resJson[rid]={};
				resJson[rid][dsid] = {};
				resJson[rid][dsid].cost = cid.split(',');
				addResource(rid);
				$('#decisonCell_'+dsid).find('.fillrow').addClass('selected');
				if($.inArray(cid, costId) == -1)
					addCost(cid);
				
				decId.push(dsid);
			}
			else{
				if(!resJson[rid][dsid]){
					resJson[rid][dsid] = {};
					resJson[rid][dsid].cost = cid.split(',');
					$('#decisonCell_'+dsid).find('.fillrow').addClass('selected');
					if($.inArray(cid, costId) == -1)
						addCost(cid);
				
					decId.push(dsid);
				}
				else{
					$.merge(resJson[rid][dsid].cost, cid.split(','));
					if($.inArray(cid, costId) == -1)
						addCost(cid);
				}
			}
			costId.push(cid);
			if($(invoker).closest('ul').find('input:checkbox:checked').length == 1){
				$(invoker).closest('.fieldset').find('input[name=cost_'+cid+']').prop('checked', true);
			}
		}
		else{
			resJson[rid][dsid].cost.splice($.inArray(cid, resJson[rid][dsid].cost),1);
			costId.splice($.inArray(cid, costId), 1);
			if(!$(invoker).closest('.fieldset').find('input[name=resource_'+rid+']').is(':checked')){
				decId.splice($.inArray(dsid, decId), 1);
				delete resJson[rid][dsid];
			}
			
			if($.inArray(dsid, decId) == -1){
				$('#decisonCell_'+dsid).find('.fillrow').removeClass('selected');
			}
			if($.inArray(cid, costId) == -1){
				costArrCopy[cid] = costArr[cid];
				$('#costTable input[cost-id='+cid+']').closest('tr').remove();
				$('.multiple_dropdown option[value='+cid+']').removeAttr('selected');
				var i = $.inArray(cid,cis1)
				if (i >= 0){
					cis1.splice(i, 1);
				}
				$( ".multiple_dropdown" ).val(unique(cis1)).trigger("change");
			}
			
			if(Object.keys(resJson[rid]).length == 0){
				resArrCopy[rid] = resArr[rid];
				$('#resourceTable input[res-id='+rid+']').closest('tr').remove();	
				delete resJson[rid];
			}
			if($(invoker).closest('ul').find('input:checkbox:checked').length == 0){
				$(invoker).closest('.fieldset').find('input[name=cost_'+cid+']').prop('checked', false);
			}			
		}
	}
}
function addResource(rid){
	$("#resourceTable tbody tr:last").find('input:text').val(resArr[rid].value);
	$("#resourceTable tbody tr:last").find('input:text').attr('res-id', rid);
	var table = $("#resourceTable tbody");
	table.append(table.find("tr:first").clone());
	table.find("tr:last").each(function(){
		$(this).find("input:text").each(function(){
			$(this).val('').attr('res-id', '');
		});
	});			
	removeResourcetr();
	bindAutoComplete();
	delete resArrCopy[rid];
}
var cis1=[];
function addCost(cid){
	/*$("#costTable tbody tr:last").find('input:text').val(costArr[cid].value);
	$("#costTable tbody tr:last").find('input:text').attr('cost-id', cid);
	var table = $("#costTable tbody");
	table.append(table.find("tr:first").clone());
	table.find("tr:last").each(function(){
		$(this).find("input:text").each(function(){
			$(this).val('').attr('cost-id', '');
		});
	});			
	removeCosttr();
	bindAutoCompleteCost();*/
	cis1.push(cid);
	$( ".multiple_dropdown" ).val(unique(cis1)).trigger("change");
	delete costArrCopy[cid];
}
var costId=<?php echo json_encode($costArray); ?>;
var decId=<?php echo json_encode($decArray); ?>;
var decisionSelect = function (data, invoker){
	var rowData = data; 
	var uid = rowData.DecisionId;

	var rid = rowData.ResourceId.split(',');
	var cid = rowData.CostCentreId.split(',');	
	if(!$(invoker).find('.fillrow').hasClass('selected')){
		var rrid = unique(rid);
		for(var res in rrid){
			var resIndex = rid.reduce(function(a, e, i) {
							if (e === rrid[res])
								a.push(i);
							return a;
						}, []);
			var ccArr = unique(cid.reduce(function(a, e, i) {
								if ($.inArray(i,resIndex) != -1)
									a.push(e);
								return a;
							}, []));				
						
			if(!resJson[rrid[res]]){
				resJson[rrid[res]]={};
				resJson[rrid[res]][uid] = {};
				resJson[rrid[res]][uid].cost = ccArr;
				addResource(rrid[res]);
			}
			else{
				if(!resJson[rrid[res]][uid]){
					resJson[rrid[res]][uid] = {};
					resJson[rrid[res]][uid].cost = ccArr;
				}
				else{
					$.merge(resJson[rrid[res]][uid].cost, unique(ccArr));
				}
			}
			for(cc in ccArr){
				if($.inArray(ccArr[cc], costId) == -1)
					addCost(ccArr[cc]);
			}
			decId.push(uid);
			$.merge(costId, ccArr);
		}
		if($('.popover').is(':visible') && $('.popover').attr('id') == 'dec_'+uid)
			$('.popover input:checkbox').prop('checked', true);
		
		$(invoker).find('.fillrow').addClass('selected');
	}
	else{
		var finRes = $.grep(unique(rid), function(element) {
						return $.inArray(element, Object.keys(resJson)) !== -1;
					});
		for(var res in finRes){
			var resIndex = rid.reduce(function(a, e, i) {
							if (e === finRes[res])
								a.push(i);
							return a;
						}, []);
			var ccArr = unique(cid.reduce(function(a, e, i) {
								if ($.inArray(i,resIndex) != -1)
									a.push(e);
								return a;
							}, []));				
						
			
			for(cc in ccArr){
				if(resJson[finRes[res]][uid] && $.inArray(ccArr[cc], resJson[finRes[res]][uid].cost) != -1){
					resJson[finRes[res]][uid].cost.splice($.inArray(ccArr[cc], resJson[finRes[res]][uid].cost),1);
					costId.splice($.inArray(ccArr[cc], costId), 1);
					if($.inArray(ccArr[cc], costId) == -1){
						costArrCopy[ccArr[cc]] = costArr[ccArr[cc]];
						$('#costTable input[cost-id='+ccArr[cc]+']').closest('tr').remove();
						$('.multiple_dropdown option[value='+ccArr[cc]+']').removeAttr('selected');
						var i = $.inArray(ccArr[cc],cis1)
						if (i >= 0){
							cis1.splice(i, 1);
						}
					}
				}
			}
			$( ".multiple_dropdown" ).val(unique(cis1)).trigger("change");
			if(resJson[finRes[res]][uid]){
				decId.splice($.inArray(uid, decId), 1);
				delete resJson[finRes[res]][uid];
			}
			if(Object.keys(resJson[finRes[res]]).length == 0){
				resArrCopy[finRes[res]] = resArr[finRes[res]];
				$('#resourceTable input[res-id='+finRes[res]+']').closest('tr').remove();
				delete resJson[finRes[res]];
			}
		}
		if($('.popover').is(':visible') && $('.popover').attr('id') == 'dec_'+uid)
			$('.popover input:checkbox').prop('checked', false);
		
		$(invoker).find('.fillrow').removeClass('selected');
	}	
}


/*Resource autocomplete start*/
bindAutoComplete();
removeResourcetr();
function deleteUnResource(){
	$("#resourceTable tbody tr .error").each(function(){
		if($(this).attr('res-id') != '')
			fillResource('', this, 2);
		
		if($(this).closest('tr').index() == 0 && $("#resourceTable tbody tr").length == 1){
			$(this).val('').attr('res-id', '');
			$(this).removeClass('error');
		}
		else if($(this).closest('tr').index() == $("#resourceTable tbody tr:last").index()){
			$(this).val('').attr('res-id', '');
			$(this).removeClass('error');
		}
		else if($(this).closest('tr').index() != 0 && $(this).closest('tr').index() != $("#resourceTable tbody tr:last").index()){
			$(this).closest('tr').remove();
		}
		else if($(this).closest('tr').index() == 0 && $("#resourceTable tbody tr").length > 1){
			$(this).closest('tr').remove();
		}		
	});
}

function removeResourcetr(){
	$(".removeResource").unbind();
	$(".removeResource").bind("click", function(){
		fillResource('', this, 2);
	});
}
function addResourceTr(invoker){
	var table = $("#resourceTable tbody");
	if($(invoker).closest("tr").index() == table.find("tr:last").index()){
		table.append(table.find("tr:first").clone());
		table.find("tr:last").each(function(){
			$(this).find("input:text").each(function(){
				$(this).val('').attr('res-id', '');
			});
		});			
		removeResourcetr();
		bindAutoComplete();
	}
}
function fillResource(json, invoker, mode){
	var tr = $(invoker).closest("tr");
	var res = tr.find("input:text").attr('res-id');
	if(mode == 1){
		if(res != json.data){
			if(res != ''){
				var rid=res;
				var dsid = resArr[rid].decId.split(',');
				var cid = resArr[rid].costId.split(',');
				var finDec = $.grep(unique(dsid), function(element) {
								return $.inArray(element, Object.keys(resJson[rid])) !== -1;
							});
				for(var dec in finDec){
					var decIndex = dsid.reduce(function(a, e, i) {
									if (e === finDec[dec])
										a.push(i);
									return a;
								}, []);
					var ccArr = unique(cid.reduce(function(a, e, i) {
										if ($.inArray(i,decIndex) != -1)
											a.push(e);
										return a;
									}, []));				
					
					for(cc in ccArr){
						if(resJson[rid][finDec[dec]] && $.inArray(ccArr[cc], resJson[rid][finDec[dec]].cost) != -1){
							resJson[rid][finDec[dec]].cost.splice($.inArray(ccArr[cc], resJson[rid][finDec[dec]].cost),1);
							costId.splice($.inArray(ccArr[cc], costId), 1);
							if($.inArray(ccArr[cc], costId) == -1){
								costArrCopy[ccArr[cc]] = costArr[ccArr[cc]];
								$('#costTable input[cost-id='+ccArr[cc]+']').closest('tr').remove();
								$('.multiple_dropdown option[value='+ccArr[cc]+']').removeAttr('selected');
								var i = $.inArray(ccArr[cc],cis1)
								if (i >= 0){
									cis1.splice(i, 1);
								}	
							}
						}
					}
					$( ".multiple_dropdown" ).val(unique(cis1)).trigger("change");
					
					if(resJson[rid][finDec[dec]]){
						decId.splice($.inArray(finDec[dec], decId), 1);
						if($.inArray(finDec[dec], decId) == -1)
							$('#decisonCell_'+finDec[dec]).find('.fillrow').removeClass('selected');
						
						if(resJson[rid][finDec[dec]].cost.length == 0)
							delete resJson[rid][finDec[dec]];
					}
				}
				resArrCopy[rid] = resArr[rid];
				delete resJson[rid];
			}
			var rid=json.data;
			var dsid = json.decId.split(',');
			var cid = json.costId.split(',');
			tr.find("input:text").attr('res-id', rid);
			
			resJson[rid]={};
			var dssid = unique(dsid);
			for(var dec in dssid){
				var decIndex = dsid.reduce(function(a, e, i) {
								if (e === dssid[dec])
									a.push(i);
								return a;
							}, []);
				var ccArr = unique(cid.reduce(function(a, e, i) {
									if ($.inArray(i,decIndex) != -1)
										a.push(e);
									return a;
								}, []));				
							
				if(!resJson[rid][dssid[dec]]){
					resJson[rid][dssid[dec]] = {};
					resJson[rid][dssid[dec]].cost = ccArr;
				}
				else{
					$.merge(resJson[rid][dssid[dec]].cost, unique(ccArr));
				}
				
				for(cc in ccArr){
					if($.inArray(ccArr[cc], costId) == -1)
						addCost(ccArr[cc]);
				}
				
				if($.inArray(dssid[dec], decId) == -1)
					$('#decisonCell_'+dssid[dec]).find('.fillrow').addClass('selected');
				
				decId.push(dssid[dec]);
				$.merge(costId, ccArr);
			}
			delete resArrCopy[json.data];
		}
	}
	else{
		if(res != ''){
			var rid=res;
			var dsid = resArr[rid].decId.split(',');
			var cid = resArr[rid].costId.split(',');
			var finDec = $.grep(unique(dsid), function(element) {
							return $.inArray(element, Object.keys(resJson[rid])) !== -1;
						});
			for(var dec in finDec){
				var decIndex = dsid.reduce(function(a, e, i) {
								if (e === finDec[dec])
									a.push(i);
								return a;
							}, []);
				var ccArr = unique(cid.reduce(function(a, e, i) {
									if ($.inArray(i,decIndex) != -1)
										a.push(e);
									return a;
								}, []));				
				
				for(cc in ccArr){
					if(resJson[rid][finDec[dec]] && $.inArray(ccArr[cc], resJson[rid][finDec[dec]].cost) != -1){
						resJson[rid][finDec[dec]].cost.splice($.inArray(ccArr[cc], resJson[rid][finDec[dec]].cost),1);
						costId.splice($.inArray(ccArr[cc], costId), 1);
						if($.inArray(ccArr[cc], costId) == -1){
							costArrCopy[ccArr[cc]] = costArr[ccArr[cc]];
							$('#costTable input[cost-id='+ccArr[cc]+']').closest('tr').remove();
							$('.multiple_dropdown option[value='+ccArr[cc]+']').removeAttr('selected');
							//$( ".multiple_dropdown" ).val(unique(cis1)).trigger("change");
							//$('.multiple_dropdown option[value='+ccArr[cc]+']').prop('selected', false);
							//$(".multiple_dropdown").select2('deselect', ccArr[cc]);
							//cis1.splice(ccArr[cc], 1);
							var i = $.inArray(ccArr[cc],cis1)
							if (i >= 0){
								cis1.splice(i, 1);
							}
						}
					}
				}
				alert(unique(cis1))
				$( ".multiple_dropdown" ).val(unique(cis1)).trigger("change");
				
				if(resJson[rid][finDec[dec]]){
					decId.splice($.inArray(finDec[dec], decId), 1);
					if($.inArray(finDec[dec], decId) == -1)
						$('#decisonCell_'+finDec[dec]).find('.fillrow').removeClass('selected');
					
					if(resJson[rid][finDec[dec]].cost.length == 0)
						delete resJson[rid][finDec[dec]];
				}
			}
			$('#resourceTable input[res-id='+rid+']').closest('tr').remove();
			resArrCopy[rid] = resArr[rid];
			delete resJson[rid];
		}
	}
}
var decSelect = function(invoker, mode){
	var resId = $(invoker).attr('res-id');
	if(mode == 'cost'){
		var cid = $(invoker).attr('cost-id');
		var decision = resArr[resId].decId.split(',');
		var cost1 = resArr[resId].costId.split(',');
		var costIndex = cost1.reduce(function(a, e, i) {
						if (e === cid)
							a.push(i);
						return a;
					}, []);
		var dsid = unique(decision.reduce(function(a, e, i) {
							if ($.inArray(i,costIndex) != -1)
								a.push(e);
							return a;
						}, []));		
		if($(invoker).is(':checked')){
			$(invoker).closest('div').nextAll('ul').find('input:checkbox').prop('checked', true);
			for(var dec in dsid){
				if(!resJson[resId][dsid]){
					resJson[resId][dsid[dec]] = {};
					resJson[resId][dsid[dec]].cost = cid.split(',');
					$('#decisonCell_'+dsid[dec]).find('.fillrow').addClass('selected');
					if($.inArray(cid, costId) == -1)
						addCost(cid);
				
					decId.push(dsid[dec]);
				}
				else{
					$.merge(resJson[resId][dsid[dec]].cost, cid.split(','));
				}
				costId.push(cid);
			}			
		}
		else{
			for(var dec in dsid){
				if($(invoker).closest('div').nextAll('ul').find('input[dec-id='+dsid[dec]+']').is(':checked')){
					resJson[resId][dsid[dec]].cost.splice($.inArray(cid, resJson[resId][dsid[dec]].cost),1);
					costId.splice($.inArray(cid, costId), 1);
					if($(invoker).closest('.fieldset').find('input[name=decision_'+dsid[dec]+']:checked').length == 1){
						decId.splice($.inArray(dsid[dec], decId), 1);
						delete resJson[resId][dsid[dec]];
					}					
					if($.inArray(dsid[dec], decId) == -1){
						$('#decisonCell_'+dsid[dec]).find('.fillrow').removeClass('selected');
					}
					if($.inArray(cid, costId) == -1){
						costArrCopy[cid] = costArr[cid];
						$('#costTable input[cost-id='+cid+']').closest('tr').remove();
						$('.multiple_dropdown option[value='+cid+']').removeAttr('selected');

						var i = $.inArray(cid,cis1)
						if (i >= 0){
							cis1.splice(i, 1);
						}
						$( ".multiple_dropdown" ).val(unique(cis1)).trigger("change");
					}
					
					if(Object.keys(resJson[resId]).length == 0){
						$('.popover').hide();
						$('.popover').attr('id', '');
						$('.popover-content').html('');
						resArrCopy[resId] = resArr[resId];
						$('#resourceTable input[res-id='+resId+']').closest('tr').remove();
						delete resJson[resId];
					}
				}
			}
			$(invoker).closest('div').nextAll('ul').find('input:checkbox').prop('checked', false);
		}
	}
	else{
		var cid = $(invoker).attr('cost-id');
		var dsid = $(invoker).attr('dec-id');
		if($(invoker).is(':checked')){
			if(!resJson[resId][dsid]){
				resJson[resId][dsid] = {};
				resJson[resId][dsid].cost = cid.split(',');
				$('#decisonCell_'+dsid).find('.fillrow').addClass('selected');
				if($.inArray(cid, costId) == -1)
					addCost(cid);
			
				decId.push(dsid);
			}
			else{
				$.merge(resJson[resId][dsid].cost, cid.split(','));
			}
			costId.push(cid);
			if($(invoker).closest('ul').find('input:checkbox:checked').length == 1){
				$(invoker).closest('.fieldset').find('input[name=cost_'+cid+']').prop('checked', true);
			}
		}
		else{
			resJson[resId][dsid].cost.splice($.inArray(cid, resJson[resId][dsid].cost),1);
			costId.splice($.inArray(cid, costId), 1);
			if(!$(invoker).closest('.fieldset').find('input[name=decision_'+dsid+']').is(':checked')){
				decId.splice($.inArray(dsid, decId), 1);					
				delete resJson[resId][dsid];
			}			
			if($.inArray(dsid, decId) == -1){
				$('#decisonCell_'+dsid).find('.fillrow').removeClass('selected');
			}
			if($.inArray(cid, costId) == -1){
				costArrCopy[cid] = costArr[cid];
				$('#costTable input[cost-id='+cid+']').closest('tr').remove();
				$('.multiple_dropdown option[value='+cid+']').removeAttr('selected');

				var i = $.inArray(cid,cis1)
				if (i >= 0){
					cis1.splice(i, 1);
				}
				$( ".multiple_dropdown" ).val(unique(cis1)).trigger("change");
			}
			
			if(Object.keys(resJson[resId]).length == 0){
				$('.popover').hide();
				$('.popover').attr('id', '');
				$('.popover-content').html('');
				resArrCopy[resId] = resArr[resId];
				$('#resourceTable input[res-id='+resId+']').closest('tr').remove();	
				delete resJson[resId];
			}
			if($(invoker).closest('ul').find('input:checkbox:checked').length == 0){
				$(invoker).closest('.fieldset').find('input[name=cost_'+cid+']').prop('checked', false);
			}			
		}
	}
}
function bindAutoComplete(){
	$('#resourceTable .auto-complete').unbind();
	$('#resourceTable .auto-complete').autocomplete({
		lookup: <?php echo json_encode(array_values($resResult)); ?>,
		lookupFilter: function(suggestion, originalQuery, queryLowerCase){
			var re = new RegExp('\\b' + $.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
			return re.test(suggestion.value);
		},
		onSelect: function(suggestion){
			 if(suggestion){
				 addResourceTr(this);
				 fillResource(suggestion, this, 1);
				 $(this).removeClass('error');
			 }
		},
		onSearchStart: function(suggestion) {
			
		},
		onSearchComplete: function (query, suggestion){
			 if(!suggestion.length){
				 //fillResource('', this, 2);
				 //$(this).addClass('error');
			 }
			 else{
				 //fillResource('', this, 2);
				 $(this).removeClass('error');
			 }
		},
	}).bind("blur", function(){
		if($.inArray($(this).val(), <?php echo json_encode(array_column($resResult, 'value')); ?>) == -1){
			//fillResource('', this, 2);
			$(this).addClass("error");
		}
		setTimeout(function(){
			deleteUnResource();
		}, 200);
	}).bind('mouseover', function(){
		var resId = $(this).attr('res-id');
		if($('.popover').attr('id') == 'res_'+resId || $(this).val() == ''){
			$('.popover').hide();
			$('.popover').attr('id', '');
			$('.popover-content').html('');			
			return false;
		}
		else{
			$('.popover').attr('id', 'res_'+resId);
		}
		
		$('.popover-title').text('Decision');
		
		if(!$('.popover').is(':visible'))
			$('.popover').show();
			
		
		$('.popover-content').html('');
		
		var cost = unique(resArr[resId].costId.split(','));
		var cost1 = resArr[resId].costId.split(',');
		var decision = resArr[resId].decId.split(',');
		$('.popover-content').append(
			'<div class="col-lg-12 fieldset">'+
                    '<h1 class="vendorrequest_text">Select costcenter and decision</h1><ul class="checkbox">');
					for(var cc in cost){
						var costIndex = cost1.reduce(function(a, e, i) {
										if (e === cost[cc])
											a.push(i);
										return a;
									}, []);
						var dec = unique(decision.reduce(function(a, e, i) {
											if ($.inArray(i,costIndex) != -1)
												a.push(e);
											return a;
										}, []));
						var finDec = $.grep(dec, function(element){
										return $.inArray(element, Object.keys(resJson[resId])) !== -1;
									});	
						
						var costBool = false;
						var arrDec = [];
						for(var dd in finDec){
							if(resJson[resId]){
								if(resJson[resId][finDec[dd]]){
									if($.inArray(cost[cc], resJson[resId][finDec[dd]].cost) != -1){
										arrDec.push(finDec[dd]);
										costBool = true;
									}
								}
							}
						}
						$('.popover-content ul:first').append(
							'<li>'+
							'<div class="radio_check"><p>'+
							'<input type="checkbox" name="cost_'+cost[cc]+'" id="cost_'+cost[cc]+'" cost-id="'+cost[cc]+'" res-id="'+resId+'" '+((costBool)?"checked":"")+' onclick=\'decSelect(this, "cost");\' />'+
								'<label class="ripple" for="cost_'+cost[cc]+'">'+costArr[cost[cc]].value+'</label>'+
							'</p></div>');
							if(dec.length > 0){
								$('.popover-content li:last').append(
									'<ul class="checkbox">');
									for(var dd in dec){
										$('.popover-content ul:last').append(
											'<li>'+
											'<div class="radio_check"><p>'+
											'<input type="checkbox" name="decision_'+dec[dd]+'" '+(($.inArray(dec[dd], arrDec) != -1)?"checked":"")+' id="decision_'+dec[dd]+'_'+cost[cc]+'" cost-id="'+cost[cc]+'" res-id="'+resId+'" dec-id="'+dec[dd]+'" onclick=\'decSelect(this, "dec");\' />'+
											'<label class="ripple" for="decision_'+dec[dd]+'_'+cost[cc]+'" >'+decArr[dec[dd]].RDecisionNo+'</label>'+
											'</p></div>'+
											'</li>');								
									}
							}
					}
		
		$('.popover').animate({left: parseFloat($(this).offset().left) - 60, top:parseFloat($(this).offset().top) - parseFloat($('header').height()) - ($('.popover .arrow').offset().top - $('.popover').offset().top)});
	}).bind('mouseleave', function(){
		removePopup();
	});
	
 	$('#resourceTable .auto-complete').bind("focus", function(){
		var arr = resArrCopy;
		if($(this).attr('res-id') != '')
			arr[$(this).attr('res-id')] = resArr[$(this).attr('res-id')];
		
		var res = $.map(arr, function(i,v){
					return i;
				  });
				 
		$(this).autocomplete().setOptions({
			lookup: res
		});			
	});
}

var uniqueCost = <?php echo json_encode(array_unique($costArray)); ?>;
var uniqueRes =<?php echo json_encode(array_keys($resJson)); ?>;
$( ".multiple_dropdown" ).val(unique(uniqueCost)).trigger("change");
for(var r in uniqueRes){
	addResource(uniqueRes[r]);
}
/*Resource autocomplete end*/

/*Project autocomplete start*/
function fillCost(json, mode){
	if(mode == 1){
		var cid=json;
		var dsid = costArr[cid].decId.split(',');
		var resId = costArr[cid].resId.split(',');		
		
		var rid = unique(resId);
		for(var res in rid){
			var resIndex = resId.reduce(function(a, e, i) {
							if (e === rid[res])
								a.push(i);
							return a;
						}, []);
			var decArr = unique(dsid.reduce(function(a, e, i) {
								if ($.inArray(i,resIndex) != -1)
									a.push(e);
								return a;
							}, []));
							
			if(!resJson[rid[res]]){
				resJson[rid[res]] = {};
				addResource(rid[res]);
			}
			for(dec in decArr){
				if(!resJson[rid[res]][decArr[dec]]){
					resJson[rid[res]][decArr[dec]] = {};
					resJson[rid[res]][decArr[dec]].cost = cid.split(',');
					decId.push(decArr[dec]);
					$('#decisonCell_'+decArr[dec]).find('.fillrow').addClass('selected');
				}
				else{
					$.merge(resJson[rid[res]][decArr[dec]].cost, cid);
				}
				costId.push(cid);
			}
		}
		delete costArrCopy[json.data];
	}
	else{
		var cid = json;
		var dsid = costArr[cid].decId.split(',');
		var resId = costArr[cid].resId.split(',');
		var finRes = $.grep(unique(resId), function(element){
						return $.inArray(element, Object.keys(resJson)) !== -1;
					});
		for(var res in finRes){
			var resIndex = resId.reduce(function(a, e, i) {
							if (e === finRes[res])
								a.push(i);
							return a;
						}, []);
			var decArr1 = unique(dsid.reduce(function(a, e, i) {
								if ($.inArray(i,resIndex) != -1)
									a.push(e);
								return a;
							}, []));

			var decArr = $.grep(decArr1, function(element){
							return $.inArray(element, Object.keys(resJson[finRes[res]])) !== -1;
						});								
			
			for(dec in decArr){
				if(resJson[finRes[res]] && resJson[finRes[res]][decArr[dec]]){
					resJson[finRes[res]][decArr[dec]].cost.splice($.inArray(cid, resJson[finRes[res]][decArr[dec]].cost), 1);
					if(resJson[finRes[res]][decArr[dec]].cost.length == 0){
						delete resJson[finRes[res]][decArr[dec]];
					}
					decId.splice($.inArray(decArr[dec], decId), 1);
					costId.splice($.inArray(cid, costId), 1);
					if($.inArray(decArr[dec], decId) == -1)
						$('#decisonCell_'+decArr[dec]).find('.fillrow').removeClass('selected');
				}
			}
			if(Object.keys(resJson[finRes[res]]).length == 0){
				resArrCopy[finRes[res]] = resArr[finRes[res]];
				$('#resourceTable input[res-id='+finRes[res]+']').closest('tr').remove();
				delete resJson[finRes[res]];
			}
		}
		costArrCopy[cid] = costArr[cid];
	}
}
/*Project autocomplete end*/
/*End of feed*/
function arrequal(arr1, arr2){
	var is_equal = arr1.length==arr2.length && arr1.every(function(v,i) { return ($.inArray(v,arr2) != -1)});
	return is_equal;
}
$("#continueButton").click(function(){
	//$("form").submit();		
	var ele = $(".showDiv:visible");
	bool=true;
	if($("#firstStep").is(":visible")){
		if($("#voucherNo").val().trim().length==0){
			bool=false;
			$("#voucherNo").focus();
			alert("Please Enter Request Voucher No");		
		}
		else if($("#purchase_date").val().length == 0){
			bool=false;
			$("#purchase_date").focus();
			alert("Please Select the valid date");
		}
		var decDt=$("#purchase_date").val();
		$("#dateFilter").val(decDt);
	}
	else if($('#secondStep').is(':visible')){
		var jsonEqual = true;
		 if(Object.keys(resJson).length != 0){
			 if(oldJson != '')
				var resOldJson = $.parseJSON(oldJson);
			
				var curJson = resJson;
				if(oldJson != '' && arrequal(Object.keys(resJson), Object.keys(resOldJson))){
					for(var res in curJson){
						if(arrequal(Object.keys(resJson[res]), Object.keys(resOldJson[res]))){
							for(var dec in curJson[res]){
								if(!arrequal(resJson[res][dec].cost, resOldJson[res][dec].cost)){
									jsonEqual = false;
									break;
								}
							}
						}
						else{
							jsonEqual = false;
							break;
						}						
					}
				}
				else{
					jsonEqual = false;
				}
			
			$('.popover').hide();
			if(!jsonEqual){
				oldJson = JSON.stringify(resJson);
				oTable.fnClearTable();
				$("#cloneTable").html($("#subTable").html());
				$('#subTable tbody:first').html('');
				var resourceJson = {};
				$.ajax({
					url:getBaseURL()+'mms/purchase/feeds-entry-edit',
					type:"post",
					data:'mode=thirdStep&poregId='+<?php echo $poRegId; ?>+'&res='+JSON.stringify(resJson)+'&dec='+JSON.stringify(decId)+'&cost='+JSON.stringify(costId),
					dataType:"json",
					success:function(data, textStatus, jqXHR){
						$.each(data, function(i,v){
							resourceJson[v.ResourceId] = {};
								var ai = oTable.fnAddData([v.Code,
													v.ResourceName,
													v.UnitName,
													v.Quantity,
													'<td class="tbl_input_td"><input type="text" tid="'+v.ResourceId+'" class="parent_txts tbl_input quanTr" name="transQuantity_'+v.ResourceId+'" readonly value="'+v.CurQty+'"></td>',
													'<td class="tbl_input_td"><input type="text" tid="'+v.ResourceId+'" class="parent_txts tbl_input baseRate" eleName="transAmount_'+v.ResourceId+'" name="transBaserate_'+v.ResourceId+'" value="0"></td>',
													'',
													'<td class="tbl_input_td"><input type="text" class="parent_txts tbl_input" name="transAmount_'+v.ResourceId+'" readonly></td>',
													'<td class="tbl_input_td"><input type="text" class="parent_txts tbl_input" name="transDeliverydate_'+v.ResourceId+'"></td>',
												]);
												
								$('#resTable').append(
									'<tr>'+
										'<td class="tbl_input_td">'+v.Code+'</td>'+
										'<td class="tbl_input_td">'+v.ResourceName+'</td>'+
										'<td class="tbl_input_td">'+v.UnitName+'<input type="text" class="parent_txts tbl_input quanTr" name="unitId_'+v.ResourceId+'" readonly value="'+v.UnitId+'"></td>'+
										'<td>'+v.Quantity+'</td>'+
										'<td class="tbl_input_td"><input type="text" tid="'+v.ResourceId+'" class="parent_txts tbl_input quanTr" name="transQuantity_'+v.ResourceId+'" readonly value="'+v.CurQty+'"></td>'+
										'<td class="tbl_input_td"><input type="text" tid="'+v.ResourceId+'" class="parent_txts tbl_input baseRate" eleName="transAmount_'+v.ResourceId+'" name="transBaserate_'+v.ResourceId+'" value="0"></td>'+
										'<td></td>'+
										'<td class="tbl_input_td"><input type="text" class="parent_txts tbl_input" name="transAmount_'+v.ResourceId+'" readonly></td>'+
										'<td class="tbl_input_td"><input type="text" class="parent_txts tbl_input" name="transDeliverydate_'+v.ResourceId+'"></td>'+
									'</tr>');
								
								var n = oTable.fnSettings().aoData[ai[0]].nTr;
								//Adding design td class
								for(var i=0; i<8; i++){
									if (i>=4){ 
									$('td', n)[i].setAttribute( 'class', 'tbl_input_td'); }
								}
								n.setAttribute('id', v.ResourceId);
								n.setAttribute('class', 'mainTr deleteTr_'+v.ResourceId);
									
							$('#subTable tbody:first').append('<tr class="subTr_'+v.ResourceId+' decSubTr">'+
																'<td colspan=9>'+
																	'<div class="subDiv col-lg-11 col-lg-offset-1 padlr0">'+
																		'<table class="table table-bordered" style="border-collapse: unset;">'+
																			'<thead>'+
																				'<tr>'+
																					'<th>RDecisionNo</th>'+
																					'<th>Balance Quantity</th>'+
																					'<th>Quantity</th>'+
																				'</tr>'+
																			'</thead>'+
																			'<tbody>');
																			$.each(v['dec'], function(deci,decv){
																				resourceJson[v.ResourceId][decv.DecisionId] = {};
																				$('#subTable .subTr_'+v.ResourceId+' tbody:first').append(
																				'<tr class="mainTr" sclass="costSubTr" sdiv="costSubDiv">'+
																					'<td>'+decv.RDecisionNo+'</td>'+
																					'<td>'+decv.Quantity+'</td>'+
																					'<td class="tbl_input_td"><input type="text" readonly class="parent_txts tbl_input decvalue" name="decisionQty_'+v.ResourceId+'_'+decv.DecisionId+'" value="'+decv.CurQty+'">'+
																					'<input type="hidden" class="form-control" name="reqTransId_'+v.ResourceId+'_'+decv.DecisionId+'" value="'+decv.RequestTransId+'">'+
																					'</td>'+
																				'</tr>'+
																				'<tr class="costSubTr backgroundtr_vendor ">'+
																					'<td colspan=9>'+
																						'<div class="costSubDiv col-lg-11 col-lg-offset-1 padlr0">'+
																							'<table class="table table-bordered" style="border-collapse: unset;">'+
																								'<thead>'+
																									'<tr>'+
																										'<th>CostCentreName</th>'+
																										'<th>Balance Quantity</th>'+
																										'<th>Quantity</th>'+
																									'</tr>'+
																								'</thead>'+
																								'<tbody>');
																								$.each(decv['cost'], function(costi,costv){
																									resourceJson[v.ResourceId][decv.DecisionId][costv.CostcentreId] = [];
																									if(resOldJson && resOldJson[v.ResourceId] && resOldJson[v.ResourceId][decv.DecisionId] && $.inArray(costv.CostcentreId, resOldJson[v.ResourceId][decv.DecisionId].cost) != -1){
																										var oldCostVal = costv.CurQty;
																										$('#subTable .subTr_'+v.ResourceId+' tbody:last').append($('#cloneTable #project_'+v.ResourceId+'_'+decv.DecisionId+'_'+costv.CostcentreId).clone());
																										$('#subTable .subTr_'+v.ResourceId+' tbody:last').append($('#cloneTable #project_'+v.ResourceId+'_'+decv.DecisionId+'_'+costv.CostcentreId).next('tr').clone());
																										var decisionInput = $('#subTable #project_'+v.ResourceId+'_'+decv.DecisionId+'_'+costv.CostcentreId).closest('.decSubTr').find('input[name="decisionQty_'+v.ResourceId+'_'+decv.DecisionId+'"]');
																										var decVal = parseFloat(decisionInput.val()) - parseFloat(oldCostVal);
																										$('#cloneTable #project_'+v.ResourceId+'_'+decv.DecisionId+'_'+costv.CostcentreId).find('.costvalue').each(function(){
																											decVal = parseFloat(decVal) + parseFloat($(this).val());
																										});
																										decisionInput.val(decVal.toFixed(6)).attr('value', decVal.toFixed(6));
																										
																										var resourceInput = oTable.$('input[name=transQuantity_'+v.ResourceId+']');
																										var resVal = parseFloat(resourceInput.val()) - parseFloat(oldCostVal) + parseFloat(decVal);
																										resourceInput.val(resVal.toFixed(6)).attr('value', resVal.toFixed(6));
																										$('input[name=transQuantity_'+v.ResourceId+']').val(resVal.toFixed(6));
																										$('input[name=transQuantity_'+v.ResourceId+']').attr('value', resVal.toFixed(6));
																										
																										$.each(costv['wbsname'], function(wbsi,wbsv){
																											resourceJson[v.ResourceId][decv.DecisionId][costv.CostcentreId].push(wbsv.RequestAHTransId);
																										});
																									}
																									else{
																										$('#subTable .subTr_'+v.ResourceId+' tbody:last').append(
																										'<tr class="mainTr" id="project_'+v.ResourceId+'_'+decv.DecisionId+'_'+costv.CostcentreId+'">'+
																											'<td>'+costv.CostCentreName+'</td>'+
																											'<td>'+costv.Quantity+'</td>'+
																											'<td class="tbl_input_td"><input type="text" readonly name="costQuantity_'+v.ResourceId+'_'+decv.DecisionId+'_'+costv.CostcentreId+'" class="parent_txts tbl_input costvalue" value="'+costv.CurQty+'"></td>'+
																										'</tr>'+
																										'<tr class="wbsSubTr potblbckclrto">'+
																											'<td colspan=9>'+
																												'<div class="wbsSubDiv col-lg-11 col-lg-offset-1 padlr0">'+
																													'<table class="table table-bordered" style="border-collapse: unset;">'+
																														'<thead>'+
																															'<tr>'+
																																'<th>Wbs name</th>'+
																																'<th>Balance Quantity</th>'+
																																'<th>Quantity</th>'+
																															'</tr>'+
																														'</thead>'+
																														'<tbody>');
																														$.each(costv['wbsname'], function(wbsi,wbsv){
																															resourceJson[v.ResourceId][decv.DecisionId][costv.CostcentreId].push(wbsv.RequestAHTransId);
																															$('#subTable tbody:last').append(
																															'<tr>'+
																																'<td>'+wbsv.WbsName+'</td>'+
																																'<td>'+wbsv.Quantity+'</td>'+
																																'<td class="tbl_input_td"><input type="text" class-name="quantityVal" rid="'+v.ResourceId+'" class="parent_txts tbl_input quantityVal" value="'+wbsv.CurQty+'" oldVal="'+wbsv.CurQty+'" name="wbsQuantity_'+v.ResourceId+'_'+decv.DecisionId+'_'+costv.CostcentreId+'_'+wbsv.RequestAHTransId+'"'+
																																	'costName="costQuantity_'+v.ResourceId+'_'+decv.DecisionId+'_'+costv.CostcentreId+'"'+
																																	'transName="decisionQty_'+v.ResourceId+'_'+decv.DecisionId+'"'+
																																	'resourceName="transQuantity_'+v.ResourceId+'">'+
																																	'<input type="hidden" class="form-control" value="'+wbsv.AnalysisId+'" name="analysisId_'+v.ResourceId+'_'+decv.DecisionId+'_'+costv.CostcentreId+'_'+wbsv.RequestAHTransId+'">'+
																																'</td>'+
																															'</tr>');
																														});
																														$('#subTable tbody:last').append(
																														'</tbody>'+
																													'</table>'+
																												'</div>'+
																											'</td>'+
																										'</tr>');
																									}
																								});
																								$('#subTable tbody').append(
																								'</tbody>'+
																							'</table>'+
																						'</div>'+
																					'</td>'+
																				'</tr>');	
																			});
																			$('#subTable tbody').append(
																			'</tbody>'+
																		'</table>'+
																	'</div>'+
																'</td>'+
															'</tr>');
						});	
						$('#hidjson').val(JSON.stringify(resourceJson));
						trClick();
					},
					complete:function(data){
						
					},
					error:function(jqXHR, textStatus, errorThrown){
						//alert(textStatus+"-----"+errorThrown);
					}
				});
			}
		}
		else{
			bool=false;
			alert('Please select atleast one decision');
		}
		//$("form").submit();
	}
	if(bool){
		if($(".showDiv:visible").index() != $(".showDiv:last").index()){
			$("#backButton").show();
			$(".showDiv:visible").next(".showDiv").show();
			ele.hide();
			if($(".showDiv:visible").index() == $(".showDiv:last").index()){
				$(this).val("Submit");
			}
		}
		else{
			var index = $('#ServicePickList').jqxGrid('getselectedrowindexes');
			var data=[];
			if (index.length > 0){
				for(var i in index){
				
					var selectedRowData = $('#ServicePickList').jqxGrid('getrowdata', index[i]);
					data.push(selectedRowData.uid);
				}					
			}			
			$("#gridServiceId").val(data);
			var index1 = $('#LogisticsPickList').jqxGrid('getselectedrowindexes');
			var data1=[];
			if (index1.length > 0){
				for(var i in index1){
					var selectedRowData = $('#LogisticsPickList').jqxGrid('getrowdata', index1[i]);
					data1.push(selectedRowData.uid);
				}					
			}	
			
			$("#gridLogisticstypeId").val(data1);
			
			var checkedItems = [];
			var index2 = $('#distributorList').jqxDropDownList('getCheckedItems');
			$.each(index2, function(i,v){
				checkedItems.push(v.value);
			})
			$("#distributorListId").val(checkedItems);
			//TermPickListId
			var index3 = $('#TermsPickList').jqxGrid('getselectedrowindexes');
			//alert(JSON.stringify(index3))
			var data3=[];
			if (index3.length > 0){
				for(var i in index3){
				
					var selectedRowData = $('#TermsPickList').jqxGrid('getrowdata', index3[i]);
					data3.push(selectedRowData.uid);
				}					
			}	
			$("#gridtermListId").val(data3);
			oTable.fnClearTable();
			termTable.fnClearTable();
			$('form').submit();
		}
	}
});

$("#backButton").click(function(){
	$("#continueButton").val("Continue");
	var ele = $(".showDiv:visible");
	//alert($(".showDiv:visible").closest(".showDiv").prev(".showDiv").html())
	if($(".showDiv:visible").closest(".showDiv").prev(".showDiv").index() == $(".showDiv:first").index())
		$("#backButton").hide();
		
	$(".showDiv:visible").closest(".showDiv").prev(".showDiv").show();
	ele.hide();
});

var oTable = $("#decisionTable").dataTable({"aLengthMenu": [[1, 5, 10], [1, 5, 10]], "order": [],
	"initComplete": function(settings, json) {
		$("select[name=decisionTable_length]").addClass("show-tick").selectpicker();
	},	
	"drawCallback": function( settings ){
		//alert($(this).find(".datepickerinput").attr("class"))
		$(this).find('tr.mainTr').find('td.quanTr').trigger('click');
	}	
});
/*second Step end*/


var decisionId=[];
var resourceId=[];
var termTable = $("#termTable").dataTable({"aLengthMenu": [[1, 5, 10], [1, 5, 10]], "order": [],
	"initComplete": function(settings, json) {
		$("select[name=termTable_length]").addClass("show-tick").selectpicker();
	},	
	"drawCallback": function( settings ){
		//alert($(this).find(".datepickerinput").attr("class"))
		//$(this).find("tr.mainTr .totQuantity").trigger('click');
	}	
});
trClick();
wbstrClick();
rateChange();
function trimNumber(s){
	while (s.substr(0,1) == '0' && s.length>1){
		s = s.substr(1,9999);
	}
	return s;
}
var orgVal = '';
	
function changePage(){
	$(".quantityVal").unbind();
	$(".quantityVal").bind('keypress keyup keydown', function(e){
		var key = e.which || e.keyCode;
		var name = $(this).attr("name");
		var wbsclassname = $(this).attr('class-name');

		if(key != 9){
			if($(this).val().indexOf(' ') > -1){
				$(this).val($(this).val().trim());
			}				
			if(isNaN($(this).val())){
				this.value = this.value.replace(/[^0-9\.]/g,'');
				if($(this).val().indexOf('.') > -1){
					var index = $(this).val().indexOf( '.' );
					this.value = this.value.substr( 0, index + 1 ) + this.value.slice( index ).replace( /\./g, '' );
				}
			}
			var ex = /^\d*(\.\d{0,6})?$/;
			if(!ex.test($(this).val())){
				$(this).val($(this).val().substring(0,$(this).val().length-1));
			}
			
			var costName = $(this).attr("costName");
			var decName = $(this).attr("transName");
			var resourceName = $(this).attr("resourceName");
			
			/*Total value validation*/	
			var totWbsVal = parseFloat($(this).closest("tr").find("td:nth-child(2)").text()) + parseFloat($(this).attr('oldVal'));
			 if(totWbsVal < $(this).val()){
				 $(this).val(orgVal);
			 }
			else{
				var sum = 0;
				orgVal = $(this).val();
				$(this).closest('table').find("."+wbsclassname).each(function() {
					//add only if the value is number
					if (!isNaN(this.value) && this.value.length != 0) {
						sum += parseFloat(this.value);
					}
				});
				$("input[name="+costName+"]").val(sum.toFixed(6));
				var costsum = 0;
				$(this).closest('.costSubTr').find(".costvalue").each(function() {
					//add only if the value is number
					if (!isNaN(this.value) && this.value.length != 0) {
						costsum += parseFloat(this.value);
					}
				});
				$("input[name="+decName+"]").val(costsum.toFixed(6));
				var decsum = 0;
				$(this).closest('.decSubTr').find(".decvalue").each(function() {
					//add only if the value is number
					if (!isNaN(this.value) && this.value.length != 0) {
						decsum += parseFloat(this.value);
					}
				});
				oTable.$("tr.mainTr").find("input[name="+resourceName+"]").val(decsum.toFixed(6));
			}
			oTable.$(".baseRate").trigger("keyup");
		}
	});
	$(".quantityVal").bind('blur', function(){
		var name = $(this).attr("name");
		var wbsclassname = $(this).attr('class-name');

		if($(this).val().indexOf(' ') > -1){
			$(this).val($(this).val().trim());
		}				
		if(isNaN($(this).val())){
			this.value = this.value.replace(/[^0-9\.]/g,'');
			if($(this).val().indexOf('.') > -1){
				var index = $(this).val().indexOf( '.' );
				this.value = this.value.substr( 0, index + 1 ) + this.value.slice( index ).replace( /\./g, '' );
			}
		}
		var ex = /^\d*(\.\d{0,6})?$/;
		if(!ex.test($(this).val())){
			$(this).val($(this).val().substring(0,$(this).val().length-1));
		}
		
		var costName = $(this).attr("costName");
		var decName = $(this).attr("transName");
		var resourceName = $(this).attr("resourceName");
		
		
		/*Total value validation*/	
		var totWbsVal = parseFloat($(this).closest("tr").find("td:nth-child(2)").text()) + parseFloat($(this).attr('oldVal'));
		 if(totWbsVal < $(this).val()){
			 $(this).val(orgVal);
		 }
		else{
			var sum = 0;
			orgVal = $(this).val();
			$(this).closest('table').find("."+wbsclassname).each(function() {
				//add only if the value is number
				if (!isNaN(this.value) && this.value.length != 0) {
					sum += parseFloat(this.value);
				}
			});
			$("input[name="+costName+"]").val(sum.toFixed(6));
			$("input[name="+costName+"]").attr('value', sum.toFixed(6));
			var costsum = 0;
			$(this).closest('.costSubTr').find(".costvalue").each(function() {
				//add only if the value is number
				if (!isNaN(this.value) && this.value.length != 0) {
					costsum += parseFloat(this.value);
				}
			});
			$("input[name="+decName+"]").val(costsum.toFixed(6));
			$("input[name="+decName+"]").attr('value', costsum.toFixed(6));
			var decsum = 0;
			$(this).closest('.decSubTr').find(".decvalue").each(function() {
				//add only if the value is number
				if (!isNaN(this.value) && this.value.length != 0) {
					decsum += parseFloat(this.value);
				}
			});
			oTable.$("tr.mainTr").find("input[name="+resourceName+"]").val(decsum.toFixed(6));
			$("input[name="+resourceName+"]").val(decsum.toFixed(6));
			$("input[name="+resourceName+"]").attr('value', decsum.toFixed(6));
		}
			
			var val = 0;
			if($(this).val() == '' || $(this).val() == 0){
				val = val+'.000000';
			}
			else{
				$(this).val(trimNumber($(this).val()));
				val1 = $(this).val();
				var str = '000000';
				var splitVal = val1.split('.');
				var len = 6;
				if(splitVal[1]){
					len -= splitVal[1].length;
				}
				if(len == 6)
					val = val1+'.000000';
				else if(len < 0)
					val = splitVal[0]+'.'+splitVal[1].substring(0,6);
				else
					val = val1+str.substring(0,len);
				
				if(val.charAt(0) == '.')
					val = '0' + val;
			}

			
			$("input[name="+name+"]").attr("value", val);
			$("input[name="+name+"]").val(val);				
			
		
	});
}

function trClick(){
	oTable.$(".quanTr").unbind();
	oTable.$(".quanTr").bind('click', function(){
		var tr = $(this).closest("tr");
		if(!(tr.next("tr").hasClass("duplicateTr"))){
			tr.after("<tr class='duplicateTr decSubTr'>"+$(".subTr_"+$(this).attr("tid")).html()+"</tr>");
			tr.next(".subTr_"+$(this).attr("tid")).show();
			tr.next("tr").find('.subDiv').slideDown("slow");
			changePage();
			wbstrClick();
		}
	});
}
function wbstrClick(){
	$(".mainTr").unbind();
	$(".mainTr").bind('click', function(){
		var tr = $(this).closest("tr");
		var nextTr = $(this).closest("tr").attr("sclass");
		var nextDiv = $(this).closest("tr").attr("sdiv");
		tr.next("."+nextTr).show();
		tr.next("tr").find('.'+nextDiv).slideDown("slow");
	});
}
function rateChange(){
	oTable.$(".baseRate").unbind();
	oTable.$(".baseRate").bind('keypress keyup keydown', function(e){
		var key = e.which || e.keyCode;
		var name = $(this).attr("name");
		if(key != 9){
			//alert($(this).val())
			var currVal = $(this).val();
				
			var ex = /^\d+(\.\d{0,6})?$/;
			if(ex.test(currVal)==false){
				currVal = currVal.substring(0,currVal.length - 1);
				//currVal = currVal.replace(/^\D*(\.\D{0,6})?$/,'');
				//alert(currVal.split(".")[1])
				/*if (typeof currVal.split(".")[1] != undefined) {
					currVal.split(".")[1].subString(0,6);
				}*/	
				$(this).val(currVal);
			}
			$(this).val(trimNumber($(this).val()));
			
			var tr = $(this).closest("tr");
			var quan = tr.find("td:nth-child(5) input:text").val();
			var amount = tr.find("td:nth-child(8) input:text");
			if(currVal == ''){
				amount.val((parseFloat(quan) * parseFloat(0.0)).toFixed(6));
			}
			else{
				amount.val((parseFloat(quan) * parseFloat(currVal)).toFixed(6));
			}
				
		}
	});
}

//Distributor
var source =
{
	localdata:<?php echo json_encode($distributor); ?>,
	datatype: "json",
	datafields: [
		{ name: 'VendorName' }
	],
	id:'VendorId',
	async: false
};
var dataAdapter = new $.jqx.dataAdapter(source);

// Create a jqxDropDownList
$("#distributorList").jqxDropDownList({ checkboxes: true, source: dataAdapter, displayMember: "VendorName", valueMember: "VendorId", width: 400, height: 25});
$.each(<?php echo json_encode($distributor); ?>, function(i,v){
	if(v.Sel == 1)
		$("#distributorList").jqxDropDownList('checkItem', v.VendorId);
});	
var serviceSource =
	{
		localData: <?php echo json_encode($service); ?>,
		dataType: "json",
		dataFields:
		[			
			{ name: 'ServiceName', type: 'ServiceName' }				
		],
		id:'ServiceId'
	};

var serviceDataAdapter = new $.jqx.dataAdapter(serviceSource);
$("#ServicePickList").jqxGrid({
	width: '100%',
	pageable: true,
	selectionMode: 'singleRow',
	pagerButtonsCount: 6,
	autoheight:true,
	//rowsheight:60,
	autorowheight: true,
	filterable: true,
	sortable: true,
	//filtermode: 'advanced',				
	columnsResize: true,
	showfilterrow: true,
	ready: function(){
		var localizationobj = {};
		localizationobj.emptydatastring = "No Service to display";
		$("#ServicePickList").jqxGrid('localizestrings', localizationobj);								
	},
	selectionmode: 'checkbox',					
	source: serviceDataAdapter,
	columns: [		
	  { text: 'ServiceName', editable: false,datafield: 'ServiceName'}			  
	]
});

$('#ServicePickList').on('rowclick', function (event){
	var args = event.args;
	// row's bound index.
	var boundIndex = args.rowindex;
	var index = $('#ServicePickList').jqxGrid('selectedrowindexes'); 
	//alert($.inArray(boundIndex, index))
	if($.inArray(boundIndex, index) == -1)
		$('#ServicePickList').jqxGrid('selectrow', boundIndex);
	else
		$('#ServicePickList').jqxGrid('unselectrow', boundIndex);
});	

$.each(<?php echo json_encode($service); ?>, function(i,v){
	var rid1 = v.ServiceId;
	if(v.Sel == 1){
		var mindex = $('#ServicePickList').jqxGrid('getrowboundindexbyid', rid1);
		if(mindex!=-1)
			$('#ServicePickList').jqxGrid('selectrow', mindex);
	}
});	
//TermsPicklist
var source1 =
	{
		localData: <?php echo json_encode($terms); ?>,
		dataType: "json",
		dataFields:
		[			
			{ name: 'Title', type: 'Title' }				
		],
		id:'TermsId'
	};

var dataAdapter1 = new $.jqx.dataAdapter(source1);
$("#TermsPickList").jqxGrid({
	width: '100%',
	pageable: true,
	selectionMode: 'singleRow',
	pagerButtonsCount: 6,
	autoheight:true,
	//rowsheight:60,
	autorowheight: true,
	filterable: true,
	sortable: true,
	//filtermode: 'advanced',				
	columnsResize: true,
	showfilterrow: true,
	ready: function(){
		var localizationobj = {};
		localizationobj.emptydatastring = "No Terms to display";
		$("#TermsPickList").jqxGrid('localizestrings', localizationobj);								
	},
	selectionmode: 'checkbox',							
	source: dataAdapter1,
	columns: [		
	  { text: 'Title', editable: false,datafield: 'Title'}			  
	]
});

$("#TermsPickList").bind('rowselect', function (event){
	// event arguments.
	var args = event.args;
	// row's bound index.
	var rowBoundIndex = args.rowindex;
	// row's data. The row's data object or null(when all rows are being selected or unselected with a single action). If you have a datafield called "firstName", to access the row's firstName, use var firstName = rowData.firstName;
	var rowData = args.row; 
	var rid = rowData.uid;
	if($(this).is(':visible'))
		checkClick(rid, '1');
});	

$('#TermsPickList').on('rowunselect', function (event){
	// event arguments.
	var args = event.args;
	// row's bound index.
	var rowBoundIndex = args.rowindex;
	// row's data. The row's data object or null(when all rows are being selected or unselected with a single action). If you have a datafield called "firstName", to access the row's firstName, use var firstName = rowData.firstName;
	var rowData = args.row;
	var rid = rowData.uid;
	checkClick(rid, '2');
});

$('#TermsPickList').on('rowclick', function (event){
	var args = event.args;
	// row's bound index.
	var boundIndex = args.rowindex;
	var index = $('#TermsPickList').jqxGrid('selectedrowindexes'); 
	//alert($.inArray(boundIndex, index))
	if($.inArray(boundIndex, index) == -1)
		$('#TermsPickList').jqxGrid('selectrow', boundIndex);
	else
		$('#TermsPickList').jqxGrid('unselectrow', boundIndex);
});	
$.each(<?php echo json_encode($terms); ?>, function(i,v){
	var rid1 = v.TermsId;
	if(v.Sel == 1){
		var mindex = $('#TermsPickList').jqxGrid('getrowboundindexbyid', rid1);
		if(mindex!=-1)
			$('#TermsPickList').jqxGrid('selectrow', mindex);
	}
});	

//LogisticsPickList	
var data =  [
	{ "id": 1, "name": "Procurement" }, 
	{ "id": 2, "name": "Inbound Traffic" }, 
	{ "id": 3, "name": "Receiving" },
	{ "id": 4, "name": "Storage" },	
	{ "id": 5, "name": "Stock Control" },
	{ "id": 6, "name": "Order pick up" },
	{ "id": 7, "name": "Material Handling" },
	{ "id": 8, "name": "Outbound Traffic" },
	{ "id": 9, "name": "Physical Distribution" },
	{ "id": 10, "name": "Recyling & Waste Disposal" },	
	{ "id": 11, "name": "Location" },
	{ "id": 12, "name": "Transportation Strategy" },
	{ "id": 13, "name": "Information Flow" }	
];
	
var source =
{
	localData: data,
	dataType: "json",
	dataFields:
	[			
		{ name: 'name', type: 'name' }				
	],
	id:'id'
};

var dataAdapter = new $.jqx.dataAdapter(source);
$("#LogisticsPickList").jqxGrid({
	width: '100%',
	pageable: true,
	selectionMode: 'singleRow',
	pagerButtonsCount: 6,
	autoheight:true,
	//rowsheight:60,
	autorowheight: true,
	filterable: true,
	sortable: true,
	//filtermode: 'advanced',				
	columnsResize: true,
	showfilterrow: true,
	ready: function(){
		var localizationobj = {};
		localizationobj.emptydatastring = "No Logistics to display";
		$("#LogisticsPickList").jqxGrid('localizestrings', localizationobj);								
	},
	selectionmode: 'checkbox',						
	source: dataAdapter,
	columns: [			
	  { text: 'Logistics', editable: false,datafield: 'name'}			  
	]
});

$('#LogisticsPickList').on('rowclick', function (event){
	var args = event.args;
	// row's bound index.
	var boundIndex = args.rowindex;
	var index = $('#LogisticsPickList').jqxGrid('selectedrowindexes'); 
	//alert($.inArray(boundIndex, index))
	if($.inArray(boundIndex, index) == -1)
		$('#LogisticsPickList').jqxGrid('selectrow', boundIndex);
	else
		$('#LogisticsPickList').jqxGrid('unselectrow', boundIndex);
});	
$.each(<?php echo json_encode($logistics); ?>, function(i,v){
	var rid1 = v.id;				
	var mindex = $('#LogisticsPickList').jqxGrid('getrowboundindexbyid', rid1);
	if(mindex!=-1)
		$('#LogisticsPickList').jqxGrid('selectrow', mindex);
});	
/*				
$("#vendorId").change(function(){		
	$.ajax({
		url:getBaseURL()+'mms/purchase/feeds-entry-edit',
		type:"post",
		data:"cid="+$(this).val()+"&mode=vendorSelect&poregId="+$("#poregId").val(),
		dataType:"json",
		success:function(data, textStatus, jqXHR){
			//alert(JSON.stringify(data))
			$("#Branch").html('');
			$("#Branch").append("<option value='0'>Select Branch</option>")
			$.each(data['branch'], function(i,v){
				$("#Branch").append("<option value='"+v.BranchId+"'>"+v.BranchName+"</option>")
			});	
			$("#Branch").selectpicker('refresh');
			$("#transportmode").html('');
			$("#transportmode").append("<option value='0'>Select Transport Mode</option>")
			$.each(data['transport'], function(i,v){
				$("#transportmode").append("<option value='"+v.TransportId+"'>"+v.TransportName+"</option>")
			});	
			$("#distributorList").jqxDropDownList('clear');
			
			//Service picklist//
			$("#ServicePickList").jqxGrid("clear");
			serviceSource.localdata = data['service'];
			serviceDataAdapter.dataBind();
			
			var index1 = $('#ServicePickList').jqxGrid('selectedrowindexes'); 
			if(index1.length > 0)
				$('#ServicePickList').jqxGrid('clearselection'); 			
			
			//selected Item
			$.each(data['service'], function(i,v){
				var rid1 = v.ServiceId;
				if(v.Sel == 1){
					var mindex = $('#ServicePickList').jqxGrid('getrowboundindexbyid', rid1);
					if(mindex!=-1)
						$('#ServicePickList').jqxGrid('selectrow', mindex);
				}
			});	
			
			$.each(data['distributor'], function(i,v){
				$("#distributorList").jqxDropDownList('addItem', { label: v.VendorName, value: v.VendorId}); 
			});
		},
		error:function(jqXHR, textStatus, errorThrown){
			alert(textStatus+"-----"+errorThrown);
		}
	});		
})*/
	
$("#Branch").change(function(){
	$.ajax({
		url:getBaseURL()+'mms/purchase/feeds-entry',
		type:"post",
		data:"cid="+$(this).val()+"&mode=branchSelect",
		dataType:"json",
		success:function(data, textStatus, jqXHR){
			//alert(JSON.stringify(data['contact'][0].Phone))
			$("#Branchcontactperson").html('');
			$("#Branchcontactperson").append("<option value='0'>Select One</option>")
			$.each(data['branch'], function(i,v){
				$("#Branchcontactperson").append("<option value='"+v.BranchTransId+"'>"+v.ContactPerson+"</option>")
			});
			$("#Branchcontactperson").selectpicker('refresh');
			$('#branchcontactno').val(data['contact'][0].Phone);
		},
		error:function(jqXHR, textStatus, errorThrown){
			alert(textStatus+"-----"+errorThrown);
		}
	});		
});
function remove(){
	$(".remove").unbind();
	$(".remove").bind('click', function(){
		$(this).closest(".subDiv").remove();
		var i=2;
		$("#mainDiv").find(".subDiv").each(function(){
			$(this).find("input:text, textarea, input:file").each(function(){
				$(this).attr("name", $(this).attr("tagname")+"_"+i);
			});
			i++;
		});			
	});
}
$("#addmore").click(function(){
	$("#mainDiv").append("<div class='subDiv'>"+$("#appendDiv").html()+"<div class='form-group'><input type='button' value='Remove' class='btn btn-primary remove'></div></div>");
	remove();
	var i=2;
	$("#mainDiv").find(".subDiv").each(function(){
		$(this).find("input:text, textarea, input:file").each(function(){
			$(this).attr("name", $(this).attr("tagname")+"_"+i);
		});
		i++;
	});
});

//TermsPickList
function checkClick(rid, mode){
	//alert(rid);
	if(mode == 1){
		$.ajax({
			url:getBaseURL()+'mms/purchase/feeds-entry',
			type:"post",
			data:"rid="+rid+"&mode=fillTerms",
			dataType:"json",
			success:function(data, textStatus, jqXHR){
				/*$(".datepicker").datetimepicker({
					format: 'DD-MM-YYYY'
				});appendData*/
				$.each(data['result'], function(i,v){
					var ai = termTable.fnAddData([v.SlNo,
										v.Terms,
										"<input type='text' class='parent_txts tbl_input' oldVal='0' name='ValueFromNet_"+v.TermsId+"'>",
										"<input type='text' "+((v.IsPer == 0)?'readonly':'')+" class='parent_txts tbl_input' name='Per_"+v.TermsId+"'>",
										"<input type='text' "+((v.IsValue == 0)?'readonly':'')+" class='parent_txts tbl_input' name='Value_"+v.TermsId+"'>",
										"<input type='text' "+((v.IsPeriod == 0)?'readonly':'')+" class='parent_txts tbl_input' name='Period_"+v.TermsId+"'>",
										"<input type='text' "+((v.IsDate == 0)?'readonly':'')+" class='parent_txts tbl_input' name='Date_"+v.TermsId+"'>",
										"<input type='text' "+((v.IsString == 0)?'readonly':'')+" class='parent_txts tbl_input' name='Str_"+v.TermsId+"'>",
									]);
									
					$('#termTableDuplicate tbody').append('<tr id="deleteTermTr_'+v.TermsId+'">'+
										'<td>'+v.SlNo+'</td>'+
										'<td>'+v.Terms+'</td>'+
										'<td><input type="text" class="parent_txts tbl_input" oldVal="0" name="ValueFromNet_'+v.TermsId+'"></td>'+
										'<td><input type="text" class="parent_txts tbl_input" oldVal="0" name="Per_'+v.TermsId+'"></td>'+
										'<td><input type="text" class="parent_txts tbl_input" oldVal="0" name="Value_'+v.TermsId+'"></td>'+
										'<td><input type="text" class="parent_txts tbl_input" oldVal="0" name="Period_'+v.TermsId+'"></td>'+
										'<td><input type="text" class="parent_txts tbl_input" oldVal="0" name="Date_'+v.TermsId+'"></td>'+
										'<td><input type="text" class="parent_txts tbl_input" oldVal="0" name="Str_'+v.TermsId+'"></td>'+

									'</tr>');
					var n = termTable.fnSettings().aoData[ai[0]].nTr;
					for(var i=0; i<8; i++){
						if (i>=2){ 
						$('td', n)[i].setAttribute( 'class', 'tbl_input_td'); }
					}
					n.setAttribute('id', v.TermsId);
					n.setAttribute('class', "mainTr deleteTermTr_"+v.TermsId);	
					termTable.$('tr.mainTr').find('input:text').unbind();
					termTable.$('tr.mainTr').find('input:text').bind('blur', function(){
						$('#termTableDuplicate input[name='+$(this).attr('name')+']').val($(this).val());
					});
				});
			},
			error:function(jqXHR, textStatus, errorThrown){
				alert(textStatus+"-----"+errorThrown);
			}
		});					
	}
	else{
		termTable.$("tr.deleteTermTr_"+rid).each(function(){
			var target_row = $(this).get(0); 
			var aPos = termTable.fnGetPosition(target_row); 
			termTable.fnDeleteRow(aPos);
		});
	}
}	

$(document).ready(function() {
	$eventSelect = $(".single_dropdown2").select2({
						placeholder: "",
						templateResult: formatState,
						templateSelection: formatState,
						allowClear: true
					});
	$eventSelect.on("change", function (e){ 
		if($(this).val() != '' && $(this).val() != 'none' && $(this).val() != null){
			$.ajax({
				url:getBaseURL()+'mms/purchase/feeds-entry-edit',
				type:"post",
				data:"cid="+$(this).val()+"&mode=vendorSelect&poregId="+$("#poregId").val(),
				dataType:"json",
				success:function(data, textStatus, jqXHR){
					//alert(JSON.stringify(data))
					$("#Branch").html('');
					$("#Branch").append("<option value='0'>Select Branch</option>")
					$.each(data['branch'], function(i,v){
						$("#Branch").append("<option value='"+v.BranchId+"'>"+v.BranchName+"</option>")
					});	
					$("#Branch").selectpicker('refresh');
					$("#transportmode").html('');
					$("#transportmode").append("<option value='0'>Select Transport Mode</option>")
					$.each(data['transport'], function(i,v){
						$("#transportmode").append("<option value='"+v.TransportId+"'>"+v.TransportName+"</option>")
					});	
					$("#distributorList").jqxDropDownList('clear');
					
					//Service picklist//
					$("#ServicePickList").jqxGrid("clear");
					serviceSource.localdata = data['service'];
					serviceDataAdapter.dataBind();
					
					var index1 = $('#ServicePickList').jqxGrid('selectedrowindexes'); 
					if(index1.length > 0)
						$('#ServicePickList').jqxGrid('clearselection'); 			
					
					//selected Item
					$.each(data['service'], function(i,v){
						var rid1 = v.ServiceId;
						if(v.Sel == 1){
							var mindex = $('#ServicePickList').jqxGrid('getrowboundindexbyid', rid1);
							if(mindex!=-1)
								$('#ServicePickList').jqxGrid('selectrow', mindex);
						}
					});	
					
					$.each(data['distributor'], function(i,v){
						$("#distributorList").jqxDropDownList('addItem', { label: v.VendorName, value: v.VendorId}); 
					});
				},
				error:function(jqXHR, textStatus, errorThrown){
					alert(textStatus+"-----"+errorThrown);
				}
			});	
		}		
	});
});

function formatState (state) {
	var optimage = $(state.element).data('image');
	if (!state.id) { return state.text; }
	/*var $state = $(
		'<span><img src="<?php echo $this->basePath(); ?>/images/pro_img.jpg" width="30" height="30" class="img-flag"/> ' + state.text + '</span>'
	);*/
	 /*https://select2.github.io/examples.html*/
	 
	 var $state = $(
		//'<span><img src="<?php echo $this->basePath(); ?>/' + state.element.value.toLowerCase() + '"  width="30" height="30" class="img-flag" /> ' + state.text + '</span>'
		'<span><img src="<?php echo $this->basePath(); ?>/'+((optimage.toLowerCase() != 0)?optimage.toLowerCase():"images/avatar.jpg")+'"  width="30" height="30" class="img-flag" /> ' + state.text + '</span>'
	);
	return $state;
};
</script>