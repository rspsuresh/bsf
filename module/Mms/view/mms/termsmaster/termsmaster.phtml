<link rel="stylesheet" href="<?php echo $this->basePath() . '/css/mms.css';?>"/>

<style>
    .select-style select { padding-left: 8px ! important;}
    .mar_20{margin-top:20px;}
    .lbl_type {font-size: 15px;line-height: 21px;padding-top: 8px;}
</style>
<form action="" method="post" onsubmit="">
    <div class="content_wrapper padlr0">
        <div class="container-fluid padlr0">
            <div class="col-lg-12 clear">
                <h1 class="txt_center form_main_h1 mms_h1">Terms Master</h1>
            </div>
            <div class="col-lg-12">
                <div class="col-lg-4 col-lg-offset-4 col-md-6 col-md-offset-3 col-sm-8 col-sm-offset-2">
                    <div class="form-group col-lg-12 padtop10">
                        <div class="polymer-form">
                            <div class="row">
                                <div class="form-group col-sm-2">
                                    <label class="lbl_type">Type</label>
                                </div>
                                <div class="form-group col-md-8">
                                    <select name="type" id="type" class="single_dropdown" style="width:100%;" tabindex="-1" aria-hidden="true"  onchange="positionSelect($(this).val());">
                                        <option value="">Type</option>
                                        <option value="0">None</option>
                                        <option value="S">Supply</option>
                                        <option value="W">Work</option>
                                        <option value="C">Client</option>
                                    </select>
                                </div>
                            </div>
                            <div class="error_message">
                                <p>Please select the Type...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-12 feed-bg commargin_top">
                    <div class="table-responsive mar_20">
                        <table class="table table-hover clear" id="contactTable">
                            <thead>
                            <tr>
                                <th>Sl.No</th>
                                <th>Title</th>
                                <th>Description</th>
                                <th>%</th>
                                <th>Value</th>
                                <th>Period</th>
                                <th>Date</th>
                                <th>String</th>
                                <th>Yes/No</th>
                                <th>Include Gross</th>
                                <th>A/C Update</th>
                                <th>Account</th>
                                <th>&nbsp;</th>
                            </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                        <div class="div-overallscroll"></div>
                        <input type="hidden" class="parent_txts" name="RowCount" id="RowCount" value="1"/>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-12 savebtn_area">
        <ul>
            <li id="submitdata" class="dropdown save_btn float_r">
                <a href="javascript:void(0);" class="ripple" >Submit</a>
            </li>
            <li id="back" class="cancel_btn float_r" ><a href="<?php echo $this->basePath();?>/mms/master/resourceview" class="ripple">Close</a></li>
        </ul>
    </div>
</form>
<script type="text/javascript">
    $('#submitdata').click(function(){
        var rowCount = $('#contactTable tbody tr').length;
        $('#RowCount').val(rowCount);
        $('.dis').prop('disabled', false);
        $('form').submit();
    });

</script>

<script type="text/javascript">
    $(function () {
        $('.div-overallscroll').slimScroll({
            position: 'right',
            height: '100%',
            width: '100%',
            alwaysVisible: false,
            railVisible: true,
            railColor: '#d7dabd',
            color: '#009688',
            railOpacity: 1
        });
    });
</script>
<script id="table" type="text/template" class="hide">
    <tr id="tr__">
        <input type="hidden" name="TermsId__" id="TermsId__"/>
        <td width="10%"><input type="text" class="parent_txts " name="sno__" id="sno__"  /></td>
        <td width="40%"><input type="text" class="parent_txts resourceSuggest" name="title__" id="title__" onkeypress="rowGenerate(this);" onfocus="checkResourceUsed(this);" />
            <input type="hidden" name="titleId__" id="titleId__" /></td>
        <td width="20%"><input type="text" class="parent_txts" name="description__" id="description__"/></td>
        <td width="3%">
            <div class="radio_check">
                <p>
                    <input type="checkbox" name="per__" value="1" id="per__" class="">
                    <label for="per__" class="ripple has-ripple"></label>
                </p>
            </div>
        </td>
        <td width="3%">
            <div class="radio_check">
                <p>
                    <input type="checkbox" name="value__" value="1" id="value__" class="">
                    <label for="value__" class="ripple has-ripple"></label>
                </p>
            </div>
        </td>
        <td width="3%">
            <div class="radio_check">
                <p>
                    <input type="checkbox"  name="period__" value="1" id="period__" class="">
                    <label for="period__" class="ripple has-ripple"></label>
                </p>
            </div>
        </td>
        <td width="3%">
            <div class="radio_check">
                <p>
                    <input type="checkbox" name="date__" value="1" id="date__" class="">
                    <label for="date__" class="ripple has-ripple"></label>
                </p>
            </div>
        </td>
        <td width="3%">
            <div class="radio_check">
                <p>
                    <input type="checkbox" name="string__"  value="1" id="string__" class="">
                    <label for="string__" class="ripple has-ripple"></label>
                </p>
            </div>
        </td>
        <input type="hidden"  name="sys__" id="sys__"  value="">
        <td width="3%">
            <div class="radio_check">
                <p>
                    <input type="checkbox" name="yn__" value="1" id="yn__" class="">
                    <label for="yn__" class="ripple has-ripple"></label>
                </p>
            </div>
        </td>
        <td width="3%">
            <div class="radio_check">
                <p>
                    <input type="checkbox" name="includegross__" value="1" id="includegross__" class="">
                    <label for="includegross__" class="ripple has-ripple"></label>
                </p>
            </div>
        </td>
        <input type="hidden" name="sortorder__"  value="1" id="sortorder__" />
        <td width="3%">
            <div class="radio_check">
                <p>
                    <input type="checkbox" name="accountupdate__" value="1" id="accountupdate__" class="">
                    <label for="accountupdate__" class="ripple has-ripple"></label>
                </p>
            </div>
        </td>
        <td width="10%">
            <div class="select-style heg30">
                <select name="account__"  id="account__" >
                    <option value="0">None</option>
                    <?php
                    foreach($position as $values){
                        echo '<option value="'.$values['AccountId'].'">'.$values['AccountName '].'</option>';
                    }
                    ?>
                </select>
            </div>
        </td>
        <td width="2%" align="center" class="action_btns_td">
            <ul class="action_btns">
                <li>
                    <a class="deleteTr__" id="deleteTr__"  onclick="deleteRow(this,event);" ><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i></a>
                </li>
            </ul>
        </td>
    </tr>
</script>
<script>
    function positionSelect(data) {
        var termtype = data;
        $.ajax({
            type: 'post',
            url: getBaseURL()+'mms/termsmaster/termsmaster',
            data: {TermType: termtype,mode:'select'},
            success: function (data) {
                var BlockValues = JSON.parse(data);
                var table = $('#table').html();
                var bindPlace = $('#contactTable tbody');
                bindPlace.html('<input type="hidden" id="blockrowid" name="blockrowid" value="0"/>');
                var h=0;
                $.each(BlockValues,function(j,p) {
                    h++;
                    bindPlace.append(table.replace(/__/g, '_' + h));
                    $('#TermsId_' + h).val(p.TermsId);
                    $('#sno_' + h).val(p.SlNo);
                    $('#title_' + h).val(p.Title);
                    $('#titleId_' + h).val(p.TermsTypeId);
                    $('#description_' + h).val(p.Description);
                    $('#sortorder_' + h).val(p.SortOrder);

                    if(parseInt(p.Per)==1) {
                        $('#per_' + h).attr("checked",true);
                    }

                    if(parseInt(p.Value)==1) {
                        $('#value_' + h).attr("checked",true);
                    }

                    if(parseInt(p.Period)==1) {
                        $('#period_' + h).attr("checked",true);
                    }

                    if(parseInt(p.TDate)==1) {
                        $('#date_' + h).attr("checked",true);
                    }

                    if(parseInt(p.TString)==1) {
                        $('#string_' + h).attr("checked",true);
                    }

                    if(parseInt(p.YesNo)==1) {
                        $('#yn_' + h).attr("checked",true);
                    }

                    if(parseInt(p.IncludeGross)==1) {
                        $('#includegross_' + h).attr("checked",true);
                    }

                    if(parseInt(p.AccountUpdate)==1) {
                        $('#accountupdate_' + h).attr("checked",true);
                    }
                    if(parseInt(p.SysDefault)==1) {
                        $('#title_' + h).addClass('dis');
                        $('#per_' + h).addClass('dis');
                        $('#value_' + h).addClass('dis');
                        $('#period_' + h).addClass('dis');
                        $('#date_' + h).addClass('dis');
                        $('#yn_' + h).addClass('dis');
                        $('#accountupdate_' + h).addClass('dis');
                        $('#sys_' + h).val(p.SysDefault);
                    }
                    $('#account_' + h).val(p.AccountId).trigger('change');
                    $('#blockrowid').val(h);

                });
                $('.dis').prop('disabled', true);
                addNewRow();

            }
        });
    }
    function addNewRow(){
        var table = $('#table').html();
        var bindPlace = $('#contactTable tbody');
        var valu = $('#blockrowid').val();
        var h = valu;
        valu++;
        bindPlace.append(table.replace(/__/g, '_' + valu));
        $('#deleteTr_' + valu).hide();
        $("#blockrowid").val(valu);
        bindDescAutocomplete();
    }
    function rowGenerate(val){
        var spl =$(val).attr('id');
        var ret= (spl).split('_')[1];
        var lastIndex=$("#contactTable tbody tr:last").attr('id').split('_')[1];

        if ($("#title_"+ret).val() != ''){
            $('#deleteTr_' + ret).show();
            if(ret==lastIndex )
                addNewRow();
        }
    }
</script>

<script type="text/javascript">
    var arr_resources = <?php echo (isset($tid)) ? json_encode($tid) : '[]';?>;
    var tmp_arr_resources = arr_resources;
    function bindDescAutocomplete() {
        // bind resource autocomplete
        $('.resourceSuggest').autocomplete({
            lookup: tmp_arr_resources,
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            }, onSelect: function (suggestion) {

                if (suggestion) {
                    var $this = $(this);
                    var rowid = $this[0].id.split('_')[1];
                    $('#title_' + rowid).val(suggestion.value);
                    $('#titleId_' + rowid).val(suggestion.data);
                    if(parseInt(suggestion.Per)==1) {
                        $('#per_' + rowid).attr("checked",true);
                    }

                    if(parseInt(suggestion.Value)==1) {
                        $('#value_' + rowid).attr("checked",true);
                    }

                    if(parseInt(suggestion.Period)==1) {
                        $('#period_' + rowid).attr("checked",true);
                    }

                    if(parseInt(suggestion.TDate)==1) {
                        $('#date_' + rowid).attr("checked",true);
                    }

                    if(parseInt(suggestion.TString)==1) {
                        $('#string_' + rowid).attr("checked",true);
                    }

                    if(parseInt(suggestion.IncludeGross)==1) {
                        $('#includegross_' + rowid).attr("checked",true);
                    }

                    if(parseInt(suggestion.AccountUpdate)==1) {
                        $('#accountupdate_' + rowid).attr("checked",true);
                    }
                    if(parseInt(suggestion.SysDefault)==1) {
                        $('#title_' + rowid).addClass('dis');
                        $('#per_' + rowid).addClass('dis');
                        $('#value_' + rowid).addClass('dis');
                        $('#period_' + rowid).addClass('dis');
                        $('#date_' + rowid).addClass('dis');
                        $('#string_' + rowid).addClass('dis');
                        $('#yn_' + rowid).addClass('dis');
                        $('#includegross_' + rowid).addClass('dis');
                        $('#accountupdate_' + rowid).addClass('dis');
                        $('#sys_' + rowid).val(suggestion.SysDefault);
                    }
                    $('.dis').prop('disabled', true);
                    rowGenerate(this);
                }
            }, onSearchStart: function (suggestion) {
                var rowid = $(this)[0].id.split('_')[1];
                $('#titleId_' + rowid).val('');
            }, onSearchComplete: function (query, suggestions) {
                if(!suggestions.length) {
                    var rowid = $(this)[0].id.split('_')[1];
                    $('#titleId_' + rowid).val('');
                }
            }

        });
    }
    function checkResourceUsed(x) {
        var id = $(x)[0].id.split('_')[1];
        var reskeyid = $('input[id*=titleId_]');
        tmp_arr_resources = arr_resources;
        tmp_arr_resources = $.grep(arr_resources, function (element, index) {
            var is_selected = true;
            $.each(reskeyid, function (i, obj) {
                var $this = $(this),
                    name = $this[0].id;
                var arrname = name.split('_');
                var key1 = arrname[1];
                if (key1 != id) {
                    if (element.data == $this.val()) {
                        is_selected = false;
                        return false;
                    }
                }
            });
            return is_selected;
        });
        bindDescAutocomplete();
    }
    function deleteRow(x,e,data) {
        e.preventDefault();
        if (!confirm('Do you want to Delete'))
            return false;
        var $x = $(x),
            key = $x[0].className.split('_')[1];
        var tId= $('#TermsId_'+ key).val();
        if(tId!=""){
            $.ajax({
                type: 'post',
                url: getBaseURL()+'mms/termsmaster/termsmaster',
                data: {TermId: tId,mode:'delete'},
                success: function (data) {
                    if(data=='success'){
                        $('#tr_'+key).remove();
                        bindDescAutocomplete();
                        alert('SUCCESS');
                    }else{
                        alert('delete failed!!!can`t delete this terms');
                    }
                }
            });
        }else{
            $('#tr_'+key).remove();
            bindDescAutocomplete();
        }
    }
    $(document).on('change','.forDel',function(){
        var dId = $(this).attr('id').split('_')[1];
        if($(this).val() != ''){
            $(this).closest().find('.del').show();

        } else {
            $(this).closest().find('.del').hide();
        }
    });
</script>