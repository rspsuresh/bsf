<link rel="stylesheet" href="<?php echo $this->basePath() . '/css/project.css';?>"/>
<style>
.panel                  {border-radius:0px !important;}
.panel-info 			{border:none;border-top:none;}
.chat_content 			{float:left;width:100%;}
.toolbar_ddown ul 		{height:314px !important;border:none !important;}
.toolbar_ddown 			{border:none !important;}
#DetailsWrapper 		{display:none;}
.form-control 			{box-shadow:none !important}
.new-pg 				{display:none;}
.comments, .comment-delete {display: none;}
  .btn_newlist {width:50px; font-size:18px; height:50px; color:#000; background:#e3edf1; border: 2px solid #93cee5; border-radius:50%; margin-top:15px;float:left; line-height:47px; text-align:center;}
	.btn_newlist a i{ text-align:center; font-size:18px; color:#000; padding-left:16px; line-height:45px; transition:all 0.3s ease;}
	.btn_newlist a i:hover{-webkit-transform: scale(1.3);
            -ms-transform: scale(1.3);
            transform: scale(1.3); padding-left:14px}
</style>
<div class="content_wrapper padlr0">
  <div class="container-fluid">
    <form method="post" id="formWrapper">
      <div class="row">
        <div class="col-lg-12">
          <h1>Land Bank - Due Diligence</h1>
          <div class="col-lg-12 top_ct fade in" id="MainWrapper" <?php echo (isset($duediligenceid) && $duediligenceid != 0) ? 'style="display: none;"' : '';?>>
            <div class="col-lg-6 col-lg-offset-3 col-md-6 col-md-offset-3 col-sm-8 col-sm-offset-2 prt-next">
              <div class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 top-nexts">
                <div class="form-group">
                  <input type="text" name="PropertyName" class="form-control lbl_move" label="Name of Property" id="PropertyName" autofocus/>
                  <input type="hidden" id="EnquiryId" name="EnquiryId"/>
                    <input type="hidden" id="pageUrl" name="pageUrl" value="<?php if ($page != '') { echo $page; } else { echo ''; } ?>" />
                </div>
                <div class="next-bt"><a href="javascript:submitProperty();" class="nextclick">Next <i class="fa fa-chevron-circle-right"></i></a></div>
              </div>
            </div>
          </div>
          <div class="clearfix"></div>
        </div>
        <div id="DetailsWrapper" <?php echo (isset($duediligenceid) && $duediligenceid != 0) ? 'style="display: block;"' : '';?>>
          <div class="col-lg-12 top_ct" >
            <div class="col-lg-4 col-lg-offset-0 col-md-4 col-md-offset-0 col-sm-4 col-sm-offset-0">
              <div class="form-group col-lg-12"> <span class="date_icon"><i class="fa fa-calendar"></i></span>
                <input type="text" name="RefDate" id="RefDate" class="form-control date_picker lbl_move" label="Reference Date"  value="<?php echo (isset($duediligenceid) && $duediligenceid != 0) ? date("d-m-Y", strtotime($duediligencedetails['RefDate'])) : date("d-m-Y");?>"/>
              </div>
            </div>
            <div class="col-lg-4 col-lg-offset-0 col-md-4 col-md-offset-0 col-sm-4 col-sm-offset-0">
              <div class="form-group col-lg-12">
                <input type="text" name="RefNo" id="RefNo" class="form-control lbl_move" label="Reference No"  value="<?php echo (isset($duediligenceid) && $duediligenceid != 0) ? $duediligencedetails['RefNo'] : $svNo; ?>"  readonly/>
              </div>
            </div>
            <div class="col-lg-4 col-lg-offset-0 col-md-4 col-md-offset-0 col-sm-4 col-sm-offset-0">
              <div class="form-group col-lg-12">
                <input type="text" class="form-control lbl_move" label="Name of Property" id="lblPropertyName" value="<?php echo (isset($duediligenceid) && $duediligenceid != 0) ? $duediligencedetails['PropertyName'] : ' '; ?>" readonly/>
              </div>
            </div>
          </div>
          <!--accordion start-->
          <div class="col-lg-12 clear">
            <div id="accordion" class="panel-group">
              <div class="panel panel-info">
                <div data-target="#collapseOne" data-parent="#accordion" data-toggle="collapse" class="panel-heading collapsed panel_heads" id="panelheading-1">
                  <h4 class="panel-title accordion-toggle defa_panels">Legal CheckList</h4>
                </div>
                <div class="panel-collapse collapse" id="collapseOne" style="height: 0px;">
                  <div class="panel-body bgcolr">
                    <div class="col-lg-12">
                        <span data-toggle="modal" data-target="#chklist">
                             <a href="#" data-toggle="tooltip"  data-placement="right" title="Add New Checklist" class="btn_newlist"> <i class="fa fa-plus"></i>  </a>
                        </span>
                    </div>
                    <div class="checklisters clear">
                      <ul id="legal-checklist-wrapper">
                      </ul>
                      <input type="hidden" name="legalchk-rowid" id="legalchecklist-rowid">
                    </div>
                    <div class="cont_bt col-lg-5 col-lg-offset-7 col-md-9 col-md-offset-3 col-sm-7 col-sm-offset-3 col-xs-7 col-xs-offset-4">
                      <ul>
                        <li><a href="javascript:nextAccordian(2)">Continue &nbsp;<i class="fa fa-chevron-circle-right"></i></a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
              <div class="panel panel-info">
                <div data-target="#collapseTwo" data-parent="#accordion" data-toggle="collapse" class="panel-heading collapsed panel_heads" id="panelheading-2">
                  <h4 class="panel-title accordion-toggle defa_panels">Financial CheckList</h4>
                </div>
                <div class="panel-collapse collapse" id="collapseTwo" style="height: 0px;">
                  <div class="panel-body bgcolr">
                    <div class="col-lg-12">
                        <span data-toggle="modal" data-target="#fin-chklist">
                             <a href="#" data-toggle="tooltip"  data-placement="right" title="Add New Checklist" class="btn_newlist"> <i class="fa fa-plus"></i>  </a>
                        </span>
                    </div>
                    <div class="checklisters clear">
                      <ul id="fin-checklist-wrapper">
                      </ul>
                      <input type="hidden" name="financialchk-rowid" id="financialchecklist-rowid">
                    </div>
                    <div class="cont_bt ecpanelcontent col-lg-5 col-lg-offset-7 col-md-9 col-md-offset-3 col-sm-7 col-sm-offset-3 col-xs-7 col-xs-offset-4">
                      <ul>
                        <li><a href="javascript:nextAccordian(3)">Continue &nbsp;<i class="fa fa-chevron-circle-right"></i></a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
              <div class="panel panel-info ecpanelcontent"  <?php (isset($duediligenceid) && $duediligenceid != 0 && !isset($encumbrancedetails)) ? 'style="display: none;"' : '';?>>
                <div data-target="#collapsethree" data-parent="#accordion" data-toggle="collapse" class="panel-heading collapsed panel_heads" id="panelheading-3">
                  <h4 class="panel-title accordion-toggle defa_panels">Encumbrance Certificate</h4>
                </div>
                <div class="panel-collapse collapse" id="collapsethree" style="height: 0px;">
                  <div class="panel-body bgcolr">
                    <div class="table-responsive topsp">
                      <table class="table tableWithFloatingHeader" style=" margin-bottom:0px;">
                        <thead>
                          <tr>
                            <th>Survey No.</th>
                            <th>Patta No.</th>
                            <th>Patta Name</th>
                            <th>Area of Land</th>
                            <th>Owner Name</th>
                            <th>Action</th>
                          </tr>
                        </thead>
                        <tbody id="surveyWrapper">
                          <?php
                                    $i = 0;
                                    if(isset($encumbrancedetails)):
                                foreach($encumbrancedetails as $detail):
                                    $i++; ?>
                          <tr>
                            <td width="10%"><input class="parent_text" type="text" readonly value="<?php echo $detail['SurveyNo'];?>"/></td>
                            <td width="10%"><input class="parent_text" type="text" readonly value="<?php echo $detail['PattaNo'];?>"/></td>
                            <td width="12%"><input class="parent_text" type="text" readonly value="<?php echo $detail['PattaName'];?>"/></td>
                            <td width="12%"><input class="parent_text" type="text" readonly value="<?php echo $detail['LandArea'] . ' ' . $detail['LandAreaUnitName'];?>"/></td>
                            <td width="12%"><input class="parent_text" type="text" readonly value="<?php echo $detail['OwnerName'];?>"/></td>
                            <td width="3%" align="center"><ul class="action_btns">
                                <li> <a href="#" class="mainTr"><i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="top" data-original-title="Expand"></i></a> </li>
                              </ul></td>
                          </tr>
                          <!--expand table-->
                          <tr style="display:none;" class="subTr">
                            <td colspan="9" style="padding:0px !important; "><div class="subDiv" style="display:none;">
                                <div class="col-lg-12">
                                  <div class="table-responsive topsp">
                                    <table class="table tableWithFloatingHeader" style=" margin-bottom:0px;">
                                      <thead>
                                        <tr>
                                          <th>S.No.</th>
                                          <th>Description of Documents</th>
                                          <th>Doc No. / Dt.</th>
                                          <th>Exec / Vendor</th>
                                          <th>Claimant / Owner</th>
                                          <th>S.No / Exnt.</th>
                                          <th>Parent Doc. Ref</th>
                                        </tr>
                                      </thead>
                                      <tbody>
                                        <tr>
                                          <input type="hidden" name="encumbranceid_<?php echo $i;?>" id ="encumbranceid_<?php echo $i;?>" value="<?php echo $detail['EncumbranceId'];?>"/>
                                          <input type="hidden" name="OwnerId_<?php echo $i;?>" id ="OwnerId_<?php echo $i;?>" value="<?php echo $detail['OwnerId'];?>"/>
                                          <td width="10%"><input class="parent_text" type="text" name="slno_<?php echo $i;?>" id="slno_<?php echo $i;?>" value="<?php echo $detail['SlNo'];?>"/></td>
                                          <td width="30%"><textarea class="parent_texts" name="docdesc_<?php echo $i;?>" id="docdesc_<?php echo $i;?>"><?php echo $detail['DocDescription'];?></textarea></td>
                                          <td width="10%"><input class="parent_text" type="text" name="docno_<?php echo $i;?>" id="docno_<?php echo $i;?>" value="<?php echo $detail['DocNo'];?>"/></td>
                                          <td width="10%"><input class="parent_text" type="text" name="exec_<?php echo $i;?>" id="exec_<?php echo $i;?>" value="<?php echo $detail['VendorName'];?>"/></td>
                                          <td width="10%"><input class="parent_text" type="text" name="claimant_<?php echo $i;?>" id="claimant_<?php echo $i;?>" value="<?php echo $detail['ClaimantName'];?>"/></td>
                                          <td width="10%"><input class="parent_text" type="text" name="exnt_<?php echo $i;?>" id="exnt_<?php echo $i;?>" value="<?php echo $detail['ExtSlNo'];?>"/></td>
                                          <td width="10%"><input class="parent_text" type="text" name="docref_<?php echo $i;?>" id="docref_<?php echo $i;?>" value="<?php echo $detail['ParentDocRefNo'];?>"/></td>
                                        </tr>
                                      </tbody>
                                    </table>
                                  </div>
                                </div>
                              </div></td>
                          </tr>
                          <!--expand table-->
                          <?php endforeach; endif;?>
                        <input type="hidden" name="ecrowid" value="<?php echo $i;?>"/>
                          </tbody>
                        
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!--accordion end--> 
        </div>
        <div class="col-lg-12 savebtn_area" id="button-area" <?php echo (isset($duediligenceid) && $duediligenceid != 0) ? 'style="display: block;"' : 'style="display: none;"';?>>
          <ul>
            <li class="pull-left" <?php echo (isset($duediligenceid) && $duediligenceid != 0) ? 'style="display: none;"' : '';?>>
              <div id="back-btn" class="back-bts"> <a href="javascript:showPropertyOptions();" data-toggle="tooltip" data-placement="right" title="Go Back"><i class="fa fa-chevron-circle-left"></i> Back</a> </div>
            </li>
            <li class="dropdown save_btn float_r ripple has-ripple" style="position: relative; overflow: hidden;"> <a onclick="submitForm();">Submit</a> <span class="ripple-wrapper animated" style="width: 120px; height: 120px; top: -55px; left: 9px;"></span> </li>
              <li class="cancel_btn float_r" id="back-btn"><a href="javascript:void(0);" data-toggle="tooltip" class="ripple" title="back" onclick="return goBack();">Back</a></li>
              <div class="clearfix"></div>
          </ul>
        </div>
      </div>
    </form>
  </div>
</div>
<script id="dummy-checklist"  type="text/template" class="hide">
    <li>
        <span class="cheched">
            <span class="users_det">
                <img src="--USERPIC--" width="50" height="50p" />
                <p>--USERNAME--</p>
            </span>
            <span class="dons">--PROGRESS--</span>
            <span class="checklistnames">
                <p>--CHECKLISTNAME--</p>
            </span>
            <span class="time_datelist">
                <a href="#" class="comments cd-btn" data-id="--CHECKLISTTRANSID--">Comments <i class="fa fa-comment"></i></a>
                <a href="#" class="comment-delete cd-btn" data-id="--CHECKLISTTRANSID--"><i class="fa fa-trash"></i></a>
                <p>--DATETIME--</p>
            </span>
        </span>
        <input type="hidden" name="id__" value="--CHECKLISTID--"/>
        <input type="hidden" name="name__" value="--CHECKLISTNAME--"/>
        <input type="hidden" name="progress__" value="--PROGRESS--"/>
        <input type="hidden" name="date__" value="--DATETIME--"/>
        <input type="hidden" name="assignedto__" value="--ASSIGNEDTO--"/>
        <input type="hidden" name="updaterow__" id="chkupdaterow__" value="0"/>
        <input type="hidden" name="transid__" value="--CHECKLISTTRANSID--" />
    </li>
</script> 
<script id="dummy-checklist-history"  type="text/template" class="hide">
    <li>
        <span class="chat_content">
            <div class="avatars">
                <div class="ava_img">
                    <img src="--USERPIC--" width="50" height="50p" />
                </div>
                <div class="username_detalis">
                    <p>--USERNAME--</p>
                    <strong>--DATETIME--</strong>
                </div>
            </div>
            <div class="bubble bubble-left">
                <strong>--PROGRESS--</strong>
                <p>--REMARKS--</p>
            </div>
        </span>
    </li>
</script> 

<!--Comments area-->
<div class="comments_content" id="comments">
  <div class="comments_content_full">
    <div class="comments_heade">
      <h1 id="checklist-history-title"></h1>
      <a href="javascript:closeComment();"><i class="fa fa-times"></i></a> </div>
    <div class="content_commt toolbar_ddown">
      <div class="content_detaliss">
        <ul id="checklist-history-wrapper">
        </ul>
      </div>
    </div>
    <div class="comments_footer">
      <form id="chklist-history-form">
        <ul>
          <li>
            <div class="select-style select-status">
              <select id="chk-history-status" name="status">
                <option value="">Select Status </option>
                <option value="Done">Done </option>
                <option value="In Progress">In Progress</option>
              </select>
            </div>
          </li>
          <li>
            <textarea class="commentstext" placeholder="Remarks" id="chk-history-remarks" name="remarks"></textarea>
          </li>
          <li>
            <input type="hidden" name="transid" id="chk-history-transid"/>
            <input type="button" value="Submit" id="btn-chk-history">
          </li>
        </ul>
      </form>
    </div>
  </div>
</div>
<!--Comments area--> 

<!--Add Comments area--> 
<!-- Modal -->
<div id="fin-chklist" class="modal fade" role="dialog">
  <div class="modal-dialog"> 
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><i class="fa fa-times-circle-o clpot"></i></button>
        <h1>Add Financial CheckList</h1>
      </div>
      <div class="clearfix"></div>
      <div class="modal-body">
       
        <form id="fin-chklist-form">
        <div class="col-lg-10 col-lg-offset-1">
          <div class="col-lg-12 form-group" style="padding-top:10px;">
              <input type="text" class="form-control lbl_move" name="name" id="fin-chklist-name" label="CheckList Name"/>
              <strong class="new-pg" id="fin-chklist-new">New</strong>
              <input type="hidden" name="id" id="fin-chklist-id"/>
              </div>
        
           <div class="col-lg-12 form-group">
             
              <input type="text" class="form-control lbl_move" name="username" id="fin-chklist-assigned" label="Assigned To"/>
              <input type="hidden" class="user-id" id="fin-chklist-assigned-id" name="userid"/>
        </div>
              <div class="col-lg-12 form-group">
             <span class="date_icon"><i class="fa fa-calendar"></i></span>
              <input type="text" class="form-control lbl_move date_picker" name="targetdate" id="fin-chklist-date" onkeypress="return isDate(event);" onchange="validateDate(this);" label="Target Date"/>
      </div>
           <div class="col-lg-12 form-group">
           
              <select id="fin-chk-status" class="form-control single_dropdown lbl_move" name="status" style="width:100%; label="Status"">
                <option value=""></option>
                <option value="Done">Done</option>
                <option value="In Progress">In Progress</option>
              </select>
       </div>
          <input type="hidden" class="static" name="chktype" value="4" />
         </div>
        </form>
       </div>
      <div class="clearfix"></div>
      <div class="modal-footer">
        <div class="col-lg-12"> <a style="position: relative; overflow: hidden;" data-dismiss="modal" class="md_cance" href="#">Cancel<span class="ripple-wrapper"></span><span class="ripple-wrapper"></span></a>
          <button onclick="savechklist('financial')" class="md_ok" type="button">Submit</button>
        </div>
      </div>
    </div>
  </div>
</div>
<!--Add Comments area--> 
<!-- Modal -->
<div id="chklist" class="modal fade" role="dialog">
  <div class="modal-dialog"> 
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><i class="fa fa-times-circle-o clpot"></i></button>
        <h1>Add Legal CheckList</h1>
      </div>
      <div class="clearfix"></div>
      <div class="modal-body">
        <form id="chklist-form">
          <div class="col-lg-10 col-lg-offset-1">
            <div class="col-lg-12 form-group" style="padding-top:10px;">
              <input type="text" class="form-control lbl_move" name="name" id="chklist-name" label="CheckList Name"/>
              <strong class="new-pg" id="chklist-new">New</strong>
              <input type="hidden" name="id" id="chklist-id"/>
            </div>
            <div class="col-lg-12 form-group">
              <input type="text" class="form-control lbl_move users-list" name="username" id="chklist-assigned" label="Assigned To"/>
              <input type="hidden" class="user-id" id="chklist-assigned-id" name="userid"/>
            </div>
            <div class="col-lg-12 form-group"> <span class="date_icon"><i class="fa fa-calendar"></i></span>
              <input type="text" class="form-control lbl_move date_picker" name="targetdate" id="chklist-date" onkeypress="return isDate(event);" onchange="validateDate(this);" label="Target Date"/>
            </div>
            <div class="col-lg-12 form-group">
              <select id="chk-status" class="form-control single_dropdown lbl_move" label="Status" style="width:100%;">
                  <option value=" "></option>
                <option value="Done">Done</option>
                <option value="In Progress">In Progress</option>
              </select>
            </div>
          </div>
          
          <!--  <ul class="addcheck">
                        <li>
                            <label>CheckList Name</label>
                            <input type="text" class="parent_text" name="name" id="chklist-name"/>
                            <strong class="new-pg" id="chklist-new">New</strong>
                            <input type="hidden" name="id" id="chklist-id"/>
                        </li>
                        <li>
                            <label>Assigned To</label>
                            <input type="text" class="parent_text users-list" name="username" id="chklist-assigned"/>
                            <input type="hidden" class="user-id" id="chklist-assigned-id" name="userid"/>
                        </li>
                        <li>
                            <label>Target Date</label>
                            <input type="text" class="parent_text date_picker" name="targetdate" id="chklist-date" onkeypress="return isDate(event);" onchange="validateDate(this);"/>
                        </li>
                        <li>
                            <label>Status</label>
                            <select id="chk-status" name="status" class="single_dropdown2">
                                <option value="Done">Done</option>
                                <option value="In Progress">In Progress</option>
                            </select>
                        </li>
                    </ul>-->
          <input type="hidden" class="static" name="chktype" value="3" />
        </form>
      </div>
      <div class="clearfix"></div>
      <div class="modal-footer">
        <div class="center-block"> <a style="position: relative; overflow: hidden;" data-dismiss="modal" class="md_cance" href="#">Cancel<span class="ripple-wrapper"></span><span class="ripple-wrapper"></span></a>
          <button onclick="savechklist('legal')" class="md_ok" type="button">Submit</button>
        </div>
      </div>
    </div>
  </div>
</div>
<div style="display: none">
    <form class="form-horizontal" method="post" action="<?php echo $this->basePath() .'/project/landbank/followup' ?>" id="followupform">
        <input type="hidden" id="IFEnquiryId" name="EnquiryId" value = "" />
        <input type="hidden" id="EnquiryName" name="EnquiryName" value = "" />
        <input type="hidden" id="formfrom" name="formfrom" value="title" />
    </form>
</div>
<!--Add Comments area--> 

<script type="text/javascript">
    var arr_propertynames = <?php echo (isset($users)) ? json_encode($propertynames) : '[]';?>;
    var arr_users = <?php echo (isset($users)) ? json_encode($users) : '[]';?>;

    var arr_legal_checklists = <?php echo (isset($legalchecklists)) ? json_encode($legalchecklists) : '[]';?>;
    var tmp_arr_legal_checklists = <?php echo (isset($legalchecklists)) ? json_encode($legalchecklists) : '[]';?>;
    var arr_financial_checklists = <?php echo (isset($financialchecklists)) ? json_encode($financialchecklists) : '[]';?>;
    var tmp_arr_financial_checklists = <?php echo (isset($financialchecklists)) ? json_encode($financialchecklists) : '[]';?>;

    var financial_checklist_trans = <?php echo (isset($financialchecklisttrans)) ? json_encode($financialchecklisttrans) : '[]';?>;
    var legal_checklist_trans = <?php echo (isset($legalchecklisttrans)) ? json_encode($legalchecklisttrans) : '[]';?>;

    var arrEnqName = <?php echo (isset($EnqName)) ? json_encode($EnqName) : '[]';?>;

    var $propertyName = $('#PropertyName'),
        $enquiryId = $('#EnquiryId'),
        $mainWrapper = $('#MainWrapper'),
        $buttonArea = $('#button-area'),
        $detailsWrapper = $('#DetailsWrapper'),
        $firstCollapeHeader = $('#collapseOne'),
        $lblProjectName = $('#lblPropertyName'),
        $surveyWrapper = $('#surveyWrapper'),
        $ECContent =  $('.ecpanelcontent');
    $(function () {
        // expand first accordian
        $('#panelheading-1').trigger('click');

        // bind property name autocomplete
        $propertyName.autocomplete({
            lookup: arr_propertynames,
            showNoSuggestionNotice: false,
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            },
            onSelect: function (suggestion) {
                if (suggestion) {
                    $enquiryId.val(suggestion.data);
                    $(this).removeClass('error');
                }
            },
            onSearchStart: function (suggestion) {
                $enquiryId.val(0);
            },
            onSearchComplete: function (query, suggestions) {
                if (!suggestions.length) {
                    $(this).addClass('error');
                    $enquiryId.val(0);
                } else
                    $(this).removeClass('error');
            }
        });

        // bind users autocomplete
        $('.users-list').autocomplete({
            lookup: arr_users,
            showNoSuggestionNotice: false,
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            },
            onSelect: function (suggestion) {
                if (suggestion) {
//                    $(this).next('.user-id').val(suggestion.data);
                    $('#chklist-assigned-id').val(suggestion.data);
                    $(this).removeClass('error');
                }
            },
            onSearchStart: function (suggestion) {
//                $(this).next('.user-id').val(0);
                $('#chklist-assigned-id').val(0);
            },
            onSearchComplete: function (query, suggestions) {
                if (!suggestions.length) {
                    $(this).addClass('error');
//                    $(this).next('.user-id').val(0);
                    $('#chklist-assigned-id').val(0);
                } else
                    $(this).removeClass('error');
            }
        });
        // bind Assigned to for financial autocomplete
        $('#fin-chklist-assigned').autocomplete({
            lookup: arr_users,
            showNoSuggestionNotice: false,
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            },
            onSelect: function (suggestion) {
                if (suggestion) {
//                    $(this).next('.user-id').val(suggestion.data);
                    $('#fin-chklist-assigned-id').val(suggestion.data);
                    $(this).removeClass('error');
                }
            },
            onSearchStart: function (suggestion) {
//                $(this).next('.user-id').val(0);
                $('#fin-chklist-assigned-id').val(0);
            },
            onSearchComplete: function (query, suggestions) {
                if (!suggestions.length) {
                    $(this).addClass('error');
//                    $(this).next('.user-id').val(0);
                    $('#fin-chklist-assigned-id').val(0);
                } else
                    $(this).removeClass('error');
            }
        });

        bindLegalChecklistAutocomplete();
        bindFinancialChecklistAutocomplete();

        // show comments history link
        $('#formWrapper').on('click', '.comments', function (e) {
            e.preventDefault();
            $('.loading_area').show();
            var id = $(this).attr('data-id');
            $.ajax({
                url: getBaseURL() +'project/landbank/getchecklisthistory?requesttype=duediligence',
                data: {'CheckListTransId' : $(this).attr('data-id')},
                async: false,
                type: 'post',
                success: function(data,status, jqXHR){
                    if (jqXHR.status == 200) {
                        var chklist = JSON.parse(data);
                        var template = $('#dummy-checklist-history').html();
                        var $checkListHistoryWrapper = $('#checklist-history-wrapper');

                        $('#chk-history-transid').val(chklist.CheckListTransId);
                        $('#checklist-history-title').html(chklist.CheckListName);
                        $checkListHistoryWrapper.html('');
                        $.each(chklist.history, function (i, obj) {
                            $checkListHistoryWrapper.append(
                                template.replace(/--USERPIC--/g, obj.UserLogo)
                                    .replace(/--USERNAME--/g, obj.UserName)
                                    .replace(/--DATETIME--/g, obj.RefDate)
                                    .replace(/--PROGRESS--/g, obj.Status)
                                    .replace(/--REMARKS--/g, obj.Remarks)
                            );
                        });
                        $('.comments_content').addClass('show');
                    } else {
                        alert('Unable to get checklist, try again later!');
                    }

                    $('.loading_area').hide();
                }, error:function(jqXHR, textStatus, errorThrown){
                    alert('Unable to get checklist, try again later!');
                    $('.loading_area').hide();
                }
            });

            return false;
        });

        // delete comment link
        $('#formWrapper').on('click', '.comment-delete', function (e) {
            e.preventDefault();
            $('.loading_area').show();

            // check if checklist has history
            var hasChecklist = false;
            $.ajax({
                url: getBaseURL() +'project/landbank/checkforchecklisttrans?requesttype=duediligence',
                data: {'CheckListTransId' : $(this).attr('data-id')},
                async: false,
                type: 'post',
                success: function(data,status, jqXHR){
                    if (jqXHR.status == 200) {
                        hasChecklist = true;
                    }

                }, error:function(jqXHR, textStatus, errorThrown){
                    hasChecklist = true;
                }
            });

            if(hasChecklist) {
                alert('Sorry you cannot delete this checklist, since it has history!');
                $('.loading_area').hide();
                return false;
            }

            if (!confirm('Do you want to delete this checklist?')) {
                $('.loading_area').hide();
                return false;
            }

            var id = $(this).attr('data-id'),
                $li = $(this).closest('li');
            $.ajax({
                url: getBaseURL() +'project/landbank/deletechecklist?requesttype=duediligence',
                data: {'CheckListTransId' : $(this).attr('data-id')},
                async: false,
                type: 'post',
                success: function(data,status, jqXHR){
                    if (jqXHR.status == 200) {
                        $li.remove();
                    } else {
                        alert('Unable to delete checklist, try again later!');
                    }

                    $('.loading_area').hide();
                }, error:function(jqXHR, textStatus, errorThrown){
                    alert('Unable to delete checklist, try again later!');
                    $('.loading_area').hide();
                }
            });

            return false;
        });

        // comment save
        var $chklist_history_form = $('#chklist-history-form');
        $('#btn-chk-history').on('click', function() {
            var $status = $('#chk-history-status');
            var $remarks = $('#chk-history-remarks');

            if($status.find('option:selected').val() == '') {
                alert('Status is required!');
                return;
            }

            if($remarks.val().length == 0) {
                alert('Remarks is required!');
                return;
            }

            $('.loading_area').show();
            $.ajax({
                url: getBaseURL() +'project/landbank/addchecklisthistory?requesttype=duediligence',
                data: $chklist_history_form.serialize(),
                async: false,
                type: 'post',
                success: function(data,status, jqXHR){
                    if (jqXHR.status == 200) {
                        renderChecklistHistory(JSON.parse(data));
                    } else {
                        alert('Unable to add remarks, try again later!');
                    }

                }, error:function(jqXHR, textStatus, errorThrown){
                    alert('Unable to add remarks, try again later!');
                }
            });

            $status.find('option:first-child').prop('selected', true);
            $remarks.val('');
            $('.loading_area').hide();
        });

        // load checklist
        if(financial_checklist_trans.length != 0) {
            renderChecklist(financial_checklist_trans);
        }
        if(legal_checklist_trans.length != 0) {
            renderChecklist(legal_checklist_trans);
        }
        bindExpandTr();
        showHideCommentOptions();

        $('#PropertyName').val(arrEnqName['PropertyName']);

        var duediligenceid = <?php echo json_encode($duediligenceid);?>;
        if(duediligenceid == 0) {
            var href = $('.nextclick').attr('href');
            window.location.href = href;
        }

        $('#lblPropertyName').focus();
        $('#lblPropertyName').val(arrEnqName['PropertyName']);
        $('#EnquiryId').val(arrEnqName['EnquiryId'])
    });

    // checklist fns
    function showHideCommentOptions() {
        var cmts = $('.comments'),
            cmts_delete = $('.comment-delete');

        $.each(cmts, function (i, obj) {
            var $this = $(this),
                $cmt_delete = $this.next('.comment-delete');
            if($this.attr('data-id') != 0) {
                $this.show();
            }

            if($cmt_delete.attr('data-id') != 0) {
                $cmt_delete.show();
            }
        });
    }

    function bindLegalChecklistAutocomplete() {
        // bind checklist autocomplete
        $('#chklist-name').autocomplete({
            lookup: tmp_arr_legal_checklists,
            showNoSuggestionNotice: false,
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            },
            onSelect: function (suggestion) {
                if (suggestion) {
                    $('#chklist-id').val(suggestion.data);
                } else
                    $('#chklist-new').hide();
            },
            onSearchStart: function (suggestion) {
                $('#chklist-id').val(0);
            },
            onSearchComplete: function (query, suggestions) {
                if (!suggestions.length) {
                    $('#chklist-id').val('new');
                    $('#chklist-new').show();
                } else {
                    $('#chklist-new').hide();
                }
            }
        });
    }

    function bindFinancialChecklistAutocomplete() {
        // bind jv checklist autocomplete
        $('#fin-chklist-name').autocomplete({
            lookup: tmp_arr_financial_checklists,
            showNoSuggestionNotice: false,
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            },
            onSelect: function (suggestion) {
                if (suggestion) {
                    $('#fin-chklist-id').val(suggestion.data);
                } else
                    $('#fin-chklist-new').hide();
            },
            onSearchStart: function (suggestion) {
                $('#fin-chklist-id').val(0);
            },
            onSearchComplete: function (query, suggestions) {
                if (!suggestions.length) {
                    $('#fin-chklist-id').val('new');
                    $('#fin-chklist-new').show();
                } else {
                    $('#fin-chklist-new').hide();
                }
            }
        });
    }

    // save checklist
    function savechklist(type) {
        var prefix = '';
        var chktype = '3';
        if(typeof type != 'undefined' && type =='financial') {
            prefix = 'fin-';
            chktype = '4';
        }

        var $name = $('#' + prefix + 'chklist-name');
        var $id = $('#' + prefix + 'chklist-id');
        var $assigned_to = $('#' + prefix + 'chklist-assigned');
        var assigned_to_id = $('#' + prefix + 'chklist-assigned-id').val();
        var $date = $('#' + prefix + 'chklist-date');
        var $status = $('#' + prefix + 'chk-status');

        if($name.val().length == 0) {
            showError($name, "Required");
            return false;
        } else {
            removeError($name);
        }

        // check for checklist name exitst
        if($id.val() == 'new' && checkForCheckListUsage($name.val(), chktype)) {
            showError($name, "Already exists!");
            return false;
        } else {
            removeError($name);
        }

        if($assigned_to.val().length == 0 || assigned_to_id.length == 0 || assigned_to_id == 0 ) {
            showError($assigned_to, "Required");
            return false;
        } else {
            removeError($assigned_to);
        }

        if($date.val().length == 0) {
            showError($date, "Required");
            return false;
        } else {
            removeError($date);
        }

        if($status.val().length == 0 || $status.val() == '') {
            showError($status, "Required");
            return false;
        } else {
            removeError($status);
        }

        renderChecklist([{
            'CheckListName': $name.val(),
            'CheckListId': $id.val(),
            'CheckListTransId': 0,
            'TypeId': chktype,
            'UserName': $assigned_to.val(),
            'AssignedTo': assigned_to_id,
            'TargetDate': $date.val(),
            'Status': $status.val(),
            'UserLogo': ''
        }]);

        var json = {'data': $id.val(), 'value': $name.val()};
        if($id.val() == 'new' && prefix == '') {
            arr_legal_checklists.push(json);
        } else if($id.val() == 'new' && prefix != '') {
            arr_financial_checklists.push(json);
        }

        $('#'+prefix+'chklist').modal('hide');
        $('#'+prefix+'chklist-form').find('input:not(.static)').val('');
        $('#'+prefix+'chklist-new').hide();

        if(prefix == '')
            legalChecklistUnique();
        else
            financialChecklistUnique();

    }

    function legalChecklistUnique() {
        var name = $('input[name^=name_]');
        tmp_arr_legal_checklists = arr_legal_checklists;
        tmp_arr_legal_checklists = $.grep(arr_legal_checklists, function (element, index) {
            var is_selected = true;
            $.each(name, function (i, obj) {
                var $this = $(this);
                if ($.trim(element.value) == $.trim($this.val())) {
                    is_selected = false;
                }
            });
            return is_selected;
        });

        bindLegalChecklistAutocomplete();
    }

    function financialChecklistUnique() {
        var name = $('input[name^=name_fin_]');
        tmp_arr_financial_checklists= arr_financial_checklists;
        tmp_arr_financial_checklists = $.grep(arr_financial_checklists, function (element, index) {
            var is_selected = true;
            $.each(name, function (i, obj) {
                var $this = $(this);
                if ($.trim(element.value) == $.trim($this.val())) {
                    is_selected = false;
                }
            });
            return is_selected;
        });

        bindFinancialChecklistAutocomplete();
    }

    function checkForCheckListUsage(name, type) {
        var isUsed = false;

        $('.loading_area').show();
        $.ajax({
            url: getBaseURL() + 'project/landbank/findchecklist',
            type: "post",
            data: {'name': name, 'type' : type},
            async: false,
            success: function (data, textStatus, jqXHR) {
                if(data == 'Y')
                    isUsed = true;
                else
                    isUsed = false;

                $('.loading_area').hide();
            }, error: function (jqXHR, textStatus, errorThrown) {
                isUsed = true;
                $('.loading_area').hide();
            }
        });
        return isUsed;
    }

    function submitProperty () {
        var id = $enquiryId.val();
        /*if(id == 0 || $propertyName.val().trim().length == 0) {
            alert('Select a property!');
            return;
        }*/

        $surveyWrapper.html('');
        $.ajax({
            url: getBaseURL() + "project/landbank/getduediligencedetails",
            async: false,
            data: {'EnquiryId': id},
            type: 'post',
            success: function (data, status) {
                if(!data) {
                    $ECContent.hide();
                } else {
                    $ECContent.show();
                }
                $surveyWrapper.html(data);
                $mainWrapper.hide();

                // bind options
                $detailsWrapper.fadeIn("slow");
                $buttonArea.fadeIn("slow");

                if(!$firstCollapeHeader.hasClass('in'))
                    nextAccordian(1);

                $lblProjectName.val($propertyName.val());
//                $enquiryId.val(0);
                $propertyName.val('');
                bindExpandTr();
            }
        });
    }

    function renderChecklist(data) {
        $('.loading_area').show();

        var template = $('#dummy-checklist').html();
        var $legalcheckListWrapper = $('#legal-checklist-wrapper');
        var $finCheckListWrapper = $('#fin-checklist-wrapper');

        var $legal_rowid = $('#legalchecklist-rowid');
        var legal_rowid = parseInt($legal_rowid.val());
        if(isNaN(legal_rowid))
            legal_rowid = 0;

        var $fin_rowid = $('#financialchecklist-rowid');
        var fin_rowid = parseInt($fin_rowid.val());
        if(isNaN(fin_rowid))
            fin_rowid = 0;

        $.each(data, function (i, obj) {
            var userpic  = getBaseURL();
            var chkType  = obj.TypeId;

            if(obj.UserLogo != '' || obj.UserLogo != 'null')
                userpic += obj.UserLogo;
            else
                userpic += 'images/pro_user.png';

            if(chkType == '3') {
                legal_rowid += 1;
                $legalcheckListWrapper.append(
                    template.replace(/--CHECKLISTNAME--/g, obj.CheckListName)
                        .replace(/--CHECKLISTID--/g, obj.CheckListId)
                        .replace(/--CHECKLISTTRANSID--/g, obj.CheckListTransId)
                        .replace(/--USERNAME--/g, obj.UserName)
                        .replace(/--ASSIGNEDTO--/g, obj.AssignedTo)
                        .replace(/--DATETIME--/g, obj.TargetDate)
                        .replace(/--PROGRESS--/g, obj.Status)
                        .replace(/--USERPIC--/g, userpic)
                        .replace(/__/g, '_'+legal_rowid)
                );
            } else if(chkType == '4') {
                fin_rowid += 1;
                $finCheckListWrapper.append(
                    template.replace(/--CHECKLISTNAME--/g, obj.CheckListName)
                        .replace(/--CHECKLISTID--/g, obj.CheckListId)
                        .replace(/--CHECKLISTTRANSID--/g, obj.CheckListTransId)
                        .replace(/--USERNAME--/g, obj.UserName)
                        .replace(/--ASSIGNEDTO--/g, obj.AssignedTo)
                        .replace(/--DATETIME--/g, obj.TargetDate)
                        .replace(/--PROGRESS--/g, obj.Status)
                        .replace(/--USERPIC--/g, userpic)
                        .replace(/__/g, '_fin_'+fin_rowid)
                );
            }
        });
        $legal_rowid.val(legal_rowid);
        $fin_rowid.val(fin_rowid);

        $('.loading_area').hide();
    }

    function renderChecklistHistory(history) {
        $('.loading_area').show();

        var template = $('#dummy-checklist-history').html();
        var $checkListHistoryWrapper = $('#checklist-history-wrapper');

        $checkListHistoryWrapper.append(
            template.replace(/--USERPIC--/g, history.UserLogo)
                .replace(/--USERNAME--/g, history.UserName)
                .replace(/--DATETIME--/g, history.RefDate)
                .replace(/--PROGRESS--/g, history.Status)
                .replace(/--REMARKS--/g, history.Remarks)
        );

        $('.loading_area').hide();
    }

    function submitForm() {
        $('#formWrapper').submit();
    }

    function showPropertyOptions() {
        $mainWrapper.fadeIn("slow");

        $detailsWrapper.hide();
        $buttonArea.hide();
        $propertyName.focus();
    }

    function bindExpandTr() {
        var $tr = $(".mainTr");
        $tr.unbind('click');
        $tr.click(function(e){
            e.preventDefault();
            var $subtr = $(this).closest("tr").next(".subTr"),
                $i = $(this).find("i");

            if(!$subtr.is(":visible")){
                $subtr.show();
                $subtr.find(".subDiv").slideDown("slow");
                $i.addClass("tform");
            } else{
                $subtr.find(".subDiv").slideUp("slow");
                $subtr.slideUp("slow");
                $i.removeClass("tform");
            }
        });
    }
    function backfn() {
        $('#formfrom').val("title");
        $('#frmfollowup').submit();
    }
    function nextAccordian(id) {
        $('#panelheading-' + id).trigger('click');
    }

    function showComments(e, id) {
        e.preventDefault();
        $('#comments').addClass('show');
    }

    function closeComment() {
        $('#comments').removeClass('show');
    }


</script>
