<script type="text/javascript" src="<?php echo $this->basePath(); ?>/js/select2.full.min.js"></script>
<link type="text/css" rel="stylesheet" href="<?php echo $this->basePath(); ?>/css/select2.min.css" />
<link rel="stylesheet" href="<?php echo $this->basePath() . '/css/project.css';?>"/>
<style>
.panel 					{border-radius:0px !important;}
.panel-info 			{border:none;border-top:none;}
#DetailsWrapper 		{display:none;}
.form-control 			{box-shadow:none !important}
.frmwrk_div 			{margin: 0;}
</style>
<!--content-->
<div class="content_wrapper padlr0">
  <div class="container-fluid">
    <div class="row">
      <form  onsubmit="return entryValidate()"  method="post">
        <div class="col-lg-12">
          <h1>Land Bank - Finalization </h1>
          <input type="hidden" id="finalizationId" name="finalizationId" value="<?php echo $enquiryId; ?>"/>
          <?php if ($enquiryId !=0): ?>
          <input type="hidden" id="EnquiryId" name="EnquiryId" value="<?php echo $enquiryId; ?>"/>
              <input type="hidden" id="pageUrl" name="pageUrl" value="<?php if ($page != '') { echo $page; } else { echo ''; } ?>" />
          <?php else: ?>
          <div class="col-lg-12 top_ct fade in" id="MainWrapper">
            <div class="col-lg-6 col-lg-offset-3 col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 prt-next">
              <div class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 top-next">
                <div class="form-group">
                  <input type="text" name="PropertyName" class="form-control lbl_move" label="Name of Property" id="PropertyName" autofocus/>
                  <input type="hidden" id="EnquiryId"/>
                    <input type="hidden" id="pageUrl" name="pageUrl" value="<?php if ($page != '') { echo $page; } else { echo ''; } ?>" />
                </div>
                <div class="next-bt"><a href="#" onclick="submitProperty(this, event); return false;">Next <i class="fa fa-chevron-circle-right"></i></a></div>
              </div>
            </div>
          </div>
          <?php endif; ?>
          <div class="clearfix"></div>
        </div>
        <div id="DetailsWrapper" <?php echo ($enquiryId !=0) ? 'style="display: block;"' : '';?>>
          <div class="col-lg-12 top_ct" >
            <div class="col-lg-4 col-lg-offset-0 col-md-4 col-md-offset-0 col-sm-4 col-sm-offset-0">
              <div class="form-group col-lg-12"> <span class="date_icon"><i class="fa fa-calendar"></i></span>
                <input type="text" name="RefDate" id="RefDate" class="form-control date_picker lbl_move" label="Reference Date"  value="<?php echo (isset($finalization)) ? date("d-m-Y", strtotime($finalization['RefDate'])) : date("d-m-Y"); ?>"/>
              </div>
            </div>
            <div class="col-lg-4 col-lg-offset-0 col-md-4 col-md-offset-0 col-sm-4 col-sm-offset-0">
              <div class="form-group col-lg-12">
                <input type="text" name="RefNo" id="RefNo" class="form-control lbl_move" label="Reference No"  value="<?php  echo (isset($finalization)) ? $finalization['RefNo'] :  $svNo;?>"  readonly/>
              </div>
            </div>
            <div class="col-lg-4 col-lg-offset-0 col-md-4 col-md-offset-0 col-sm-4 col-sm-offset-0">
              <div class="form-group col-lg-12">
                <input type="text" class="form-control lbl_move" label="Name of Property" id="lblPropertyName" value="<?php  echo $propertyname;?>" readonly/>
                <input type="hidden" name="EnquiryId" id="lblEnquiryId" value="<?php  echo ($enquiryId !=0) ? $enquiryId :  '';?>"/>
              </div>
            </div>
            <div class="col-lg-4 col-lg-offset-0 col-md-4 col-md-offset-0 col-sm-4 col-sm-offset-0">
              <div class="form-group col-lg-12">
                <div class="frmwrk_div">
                  <select name='SaleTypeId' id='SaleTypeId' class="single_dropdown2 lbl_move" style="width:100%;" label="Offer Type">
                    <option></option>
                    <?php if(isset($offertypelists)):
                                            foreach($offertypelists as $list): ?>
                    <option value="<?php echo $list['SaleTypeId'];?>" <?php  echo (isset($finalization) && $finalization['SaleTypeId'] == $list['SaleTypeId']) ? 'selected' :  '';?>><?php echo $list['SaleTypeName'];?></option>
                    <?php endforeach; endif; ?>
                  </select>
                </div>
              </div>
            </div>
            <div class="col-lg-4 col-lg-offset-0 col-md-4 col-md-offset-0 col-sm-4 col-sm-offset-0">
              <div class="form-group col-lg-12">
                <input type="text" name="FinalAmount" id="FinalAmount" class="form-control lbl_move" label="Final Amount"  onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)" maxlength="18" value="<?php  echo (isset($finalization)) ? $this->commonHelper()->sanitizeNumber($finalization['FinalAmount']) :  '';?>"/>
              </div>
            </div>
          </div>
          <!--accordion start-->
          <div class="col-lg-12 clear">
            <div id="accordion" class="panel-group"> 
              <!--Owner Details-->
              <div class="panel panel-info">
                <div data-target="#collapseOne" data-parent="#accordion" data-toggle="collapse" class="panel-heading collapsed panel_heads" id="panelheading-1">
                  <h4 class="panel-title accordion-toggle defa_panels">Payment Schedule</h4>
                </div>
                <div class="panel-collapse collapse" id="collapseOne" style="height: 0px;">
                  <div class="panel-body bgcolr">
                    <div class="col-lg-10 col-lg-offset-1 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0">
                      <div class="table-responsive topsp" style="margin-top:10px;">
                        <table class="table tableWithFloatingHeader" style=" margin-bottom:0px;">
                          <thead>
                            <tr>
                              <th>Owner Name</th>
                              <th>Share Type</th>
                              <th>Percentage</th>
                              <th class="text-right">Amount</th>
                              <th>&nbsp;</th>
                            </tr>
                          </thead>
                          <tbody id="ownerDetailsWrapper">
                            <?php $i=0; if(isset($ownerdetails)):
                                                    foreach($ownerdetails as $owner):
                                                        $i=$i+1;?>
                            <tr>
                              <input type="hidden" name="ownertransid_<?php echo $i; ?>" id="ownertransid_<?php echo $i; ?>" value="<?php echo $owner['FinalizationOwnerId'];?>"/>
                              <input type="hidden" name="ownerupdaterow_<?php echo $i; ?>" id="ownerupdaterow_<?php echo $i; ?>" value="0"/>
                              <td width="20%"><input class="parent_text" type="text" name="ownername_<?php echo $i; ?>" id="ownername_<?php echo $i; ?>" maxlength="155" value="<?php echo $owner['OwnerName'];?>" readonly/>
                                <input type="hidden" name="ownerId_<?php echo $i; ?>" id="ownerId_<?php echo $i; ?>" value="<?php echo $owner['OwnerId'];?>"/></td>
                              <td width="20%"><input class="parent_text" type="text" name="shareType_<?php echo $i; ?>" id="shareType_<?php echo $i; ?>" maxlength="155" value="<?php echo $owner['ShareTypeName'];?>"/>
                                <input type="hidden" name="shareTypeId_<?php echo $i; ?>" id="shareTypeId_<?php echo $i; ?>" value="<?php echo $owner['ShareTypeId'];?>"/></td>
                              <td width="10%"><input class="parent_text text-right" type="text" name="sharePercentage_<?php echo $i; ?>" id="sharePercentage_<?php echo $i; ?>" onchange="isReadOnly(this);" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)" maxlength="18" value="<?php echo $this->commonHelper()->sanitizeNumber($owner['Percentage']);?>"/></td>
                              <td width="10%"><input class="parent_text text-right" type="text" name="shareAmount_<?php echo $i; ?>" id="shareAmount_<?php echo $i; ?>" onchange="isReadOnly(this);" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)" maxlength="18" value="<?php echo $this->commonHelper()->sanitizeNumber($owner['Amount']);?>"/></td>
                              <td width="3%" align="center"><ul class="action_btns">
                                  <li><a href="#" class="mainTr"> <i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="top" data-original-title="Expand"></i></a></li>
                                </ul></td>
                            </tr>
                            <!--expand table-->
                            <tr style="display:none;" class="subTr">
                              <td colspan="9" style="padding:0px !important; "><div class="subDiv" style="display:none;">
                                  <div class="col-lg-12">
                                    <div class="table-responsive topsp">
                                      <table class="table tableWithFloatingHeader" style=" margin-bottom:0px;">
                                        <thead>
                                          <tr>
                                            <th>Description</th>
                                            <th>Date</th>
                                            <th class="text-right">Amount</th>
                                            <th> &nbsp;</th>
                                          </tr>
                                        </thead>
                                        <tbody>
                                          <?php $j=1; foreach($ownerpaymentdetails as $payment) {
                                                                                    if($owner['FinalizationOwnerId'] != $payment['FinalizationOwnerId'])
                                                                                        continue;
                                                                                    ?>
                                          <tr>
                                            <input type="hidden" name="payment_<?php echo $i; ?>_transid_<?php echo $j; ?>" id="payment_<?php echo $i; ?>_transid_<?php echo $j; ?>" value="<?php echo $payment['PaymentScheduleId'];?>"/>
                                            <input type="hidden" name="payment_<?php echo $i; ?>_updaterow_<?php echo $j; ?>" id="payment_<?php echo $i; ?>_updaterow_<?php echo $j; ?>" value="0"/>
                                            <td width="15%"><input type="text" class="parent_text" name="payment_<?php echo $i; ?>_desc_<?php echo $j; ?>" id="payment_<?php echo $i; ?>_desc_<?php echo $j; ?>" maxlength="155" onchange="validatePaymentTr(this);triggerPaymentUpdate(this);" value="<?php echo $payment['Description'];?>"></td>
                                            <td width="5%"><input type="text" class="parent_text date_picker" placeholder="DD-MM-YYYY" name="payment_<?php echo $i; ?>_date_<?php echo $j; ?>" id="payment_<?php echo $i; ?>_date_<?php echo $j; ?>" onchange="validatePaymentTr(this);triggerPaymentUpdate(this);" value="<?php echo $payment['Date'];?>"></td>
                                            <td width="5%"><input class="parent_text text-right" type="text" name="payment_<?php echo $i; ?>_amt_<?php echo $j; ?>" id="payment_<?php echo $i; ?>_amt_<?php echo $j; ?>" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)" maxlength="18" onchange="validatePaymentTr(this);triggerPaymentUpdate(this);" value="<?php echo $this->commonHelper()->sanitizeNumber($payment['Amount']);?>"/></td>
                                            <td width="3%" align="center"><ul class="action_btns">
                                                <li> <a href="#" id="payment_<?php echo $i; ?>_delete_<?php echo $j; ?>" onclick="deleteSubTr(this, event, true);" class="subTrDelete"><i class="fa fa-trash" data-toggle="tooltip" data-placement="top" data-original-title="Delete" ></i></a> </li>
                                              </ul></td>
                                          </tr>
                                          <?php $j=$j+1; } ?>
                                          <tr>
                                            <input type="hidden" name="payment_<?php echo $i; ?>_transid_<?php echo $j; ?>" id="payment_<?php echo $i; ?>_transid_<?php echo $j; ?>" value="0"/>
                                            <input type="hidden" name="payment_<?php echo $i; ?>_updaterow_<?php echo $j; ?>" id="payment_<?php echo $i; ?>_updaterow_<?php echo $j; ?>" value="0"/>
                                            <td width="15%"><input type="text" class="parent_text" name="payment_<?php echo $i; ?>_desc_<?php echo $j; ?>" id="payment_<?php echo $i; ?>_desc_<?php echo $j; ?>" maxlength="155" onchange="validatePaymentTr(this);triggerPaymentUpdate(this);"></td>
                                            <td width="5%"><input type="text" class="parent_text date_picker" placeholder="DD-MM-YYYY" name="payment_<?php echo $i; ?>_date_<?php echo $j; ?>" id="payment_<?php echo $i; ?>_date_<?php echo $j; ?>" onchange="validatePaymentTr(this);triggerPaymentUpdate(this);"></td>
                                            <td width="5%"><input class="parent_text" type="text" name="payment_<?php echo $i; ?>_amt_<?php echo $j; ?>" id="payment_<?php echo $i; ?>_amt_<?php echo $j; ?>" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)" maxlength="18" onchange="validatePaymentTr(this);triggerPaymentUpdate(this);"/></td>
                                            <td width="3%" align="center"><ul class="action_btns">
                                                <li> <a href="#" id="payment_<?php echo $i; ?>_delete_<?php echo $j; ?>" onclick="deleteSubTr(this, event);" class="subTrDelete" style="display: none;"><i class="fa fa-trash" data-toggle="tooltip" data-placement="top" data-original-title="Delete" ></i></a> </li>
                                              </ul></td>
                                          </tr>
                                        </tbody>
                                      </table>
                                      <input type="hidden" name="paymentdetailid_<?php echo $i; ?>" id="paymentdetailid_<?php echo $i; ?>" value="<?php echo $j; ?>"/>
                                      <input type="hidden" name="paymentdeleteids_<?php echo $i; ?>" id="paymentdeleteids_<?php echo $i; ?>" value="0"/>
                                    </div>
                                  </div>
                                </div></td>
                            </tr>
                            <?php endforeach; ?>
                          <?php endif; ?>
                            </tbody>
                        </table>
                          <input type="hidden" name="scheduleRowId" id="scheduleRowId" value="<?php echo $i;?>"/>
                      </div>
                    </div>
                    <div class="cont_bt col-lg-5 col-lg-offset-7 col-md-9 col-md-offset-3 col-sm-7 col-sm-offset-3 col-xs-7 col-xs-offset-4">
                      <ul>
                        <li style="padding-top:10px;"><a href="javascript:nextAccordian(2)">Continue &nbsp;<i class="fa fa-chevron-circle-right"></i></a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
              <!--Owner Details end--> 
              <!--Escrow Account Details-->
              <div class="panel panel-info">
                <div data-target="#collapseTwo" data-parent="#accordion" data-toggle="collapse" class="panel-heading collapsed panel_heads" id="panelheading-2">
                  <h4 class="panel-title accordion-toggle defa_panels">Escrow Account Details</h4>
                </div>
                <div class="panel-collapse collapse" id="collapseTwo" style="height: 0px;">
                  <div class="panel-body bgcolr">
                    <div class="deft_act">
                      <div class="col-lg-10 col-lg-offset-1 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0">
                        <div class="col-lg-6 col-lg-offset-0 col-md-6 col-md-offset-0 col-sm-6 col-sm-offset-0">
                          <div class="form-group">
                            <input type="text" class="form-control lbl_move" label="Account No" name="AccountNo" id="AccountNo" onkeypress="return alphaNumeric(event);" maxlength="50" value="<?php  echo (isset($finalization)) ? $finalization['AccountNo'] :  '';?>">
                          </div>
                          <div class="form-group">
                            <input type="text" class="form-control lbl_move" label="Account Name" maxlength="155" name="AccountName" id="AccountName" value="<?php  echo (isset($finalization)) ? $finalization['AccountName'] :  '';?>">
                          </div>
                          <div class="form-group">
                            <input type="text" class="form-control lbl_move" label="Bank Name" name="BankName" id="BankName" maxlength="100" value="<?php  echo (isset($finalization)) ? $finalization['BankName'] :  '';?>">
                          </div>
                        </div>
                        <div class="col-lg-6 col-lg-offset-0 col-md-6 col-md-offset-0 col-sm-6 col-sm-offset-0">
                          <div class="form-group">
                            <input type="text" class="form-control lbl_move" label="Branch Name" name="BranchName" id="BranchName" maxlength="100" value="<?php  echo (isset($finalization)) ? $finalization['BranchName'] :  '';?>">
                          </div>
                          <div class="form-group">
                            <div class="frmwrk_div">
                              <select name='CityId' id='CityId' class="single_dropdown2 lbl_move" style="width:100%;" label="City" >
                                <option></option>
                                <?php if(isset($citylists)):
                                                                    foreach($citylists as $list):?>
                                <option value="<?php echo $list['CityId'];?>" <?php echo ((isset($finalization)) && $list['CityId'] == $finalization['CityId']) ? 'selected' : '';?>><?php echo $list['CityName'];?></option>
                                <?php endforeach; endif; ?>
                              </select>
                            </div>
                          </div>
                          <div class="form-group">
                            <input type="text" class="form-control lbl_move" label="IFSC Code" name="IFSCCode" id="IFSCCode" maxlength="50" onkeypress="return alphaNumeric(event);" value="<?php  echo (isset($finalization)) ? $finalization['IFSCCode'] :  '';?>">
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!--Escrow Account Details end--> 
            </div>
          </div>
          <!--accordion end--> 
        </div>
        <div class="col-lg-12 savebtn_area" style="display: <?php echo ($enquiryId !=0) ? 'block' : 'none';?>;" id="button-area">
          <ul>
            <li class="pull-left"  <?php echo (isset($finalization)) ? 'style="display: none;"' : ''?>>
              <div id="back-btn" class="back-bts"> <a href="<?php echo $this->basePath() . '/project/landbank/register';?>" data-toggle="tooltip" data-placement="right" title="Go Back"><i class="fa fa-chevron-circle-left"></i> Back</a> </div>
            </li>
            <li class="dropdown save_btn float_r ripple has-ripple" style="position: relative; overflow: hidden;"> <a href="javascript:submitForm();">Submit</a> <span class="ripple-wrapper animated" style="width: 120px; height: 120px; top: -55px; left: 9px;"></span> </li>
            <div class="clearfix"></div>
          </ul>
        </div>
      </form>
    </div>
  </div>
</div>
<!--content end--> 

<!--Dummy Payment Detail subTr-->
<table id="dummy-payment" style="display: none;">
  <tbody>
    <tr>
      <input type="hidden" name="payment__0_transid__1" id="payment__0_transid__1" value="0">
      <input type="hidden" name="payment__0_updaterow__1" id="payment__0_updaterow__1" value="0">
      <td width="15%"><input type="text" class="parent_text" name="payment__0_desc__1" id="payment__0_desc__1" maxlength="155" onchange="validatePaymentTr(this);triggerPaymentUpdate(this);"></td>
      <td width="5%"><input type="text" class="parent_text date_picker" placeholder="DD-MM-YYYY" name="payment__0_date__1" id="payment__0_date__1" readonly onchange="validatePaymentTr(this);triggerPaymentUpdate(this);"></td>
      <td width="5%"><input class="parent_text" type="text" name="payment__0_amt__1" id="payment__0_amt__1" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)" maxlength="18" onchange="validatePaymentTr(this);triggerPaymentUpdate(this);"/></td>
      <td width="3%" align="center"><ul class="action_btns">
          <li> <a href="#" id="payment__0_delete__1" onclick="deleteSubTr(this, event);" class="subTrDelete" style="display: none;"><i class="fa fa-trash" data-toggle="tooltip" data-placement="top" data-original-title="Delete" ></i></a> </li>
        </ul></td>
    </tr>
  </tbody>
</table>
<script type="text/javascript">
//    var arr_propertynames = <?php //echo json_encode($propertynames);?>//;
    var arr_jvsharetypes = <?php echo json_encode($jvsharetypes);?>;
    var arrOwnerdetails = <?php echo (isset($ownerdetails)) ? json_encode($ownerdetails) : '[]'; ?>;
//    var $propertyName = $('#PropertyName'),
      var  $enquiryId = $('#EnquiryId'),
        $mainWrapper = $('#MainWrapper'),
        $buttonArea = $('#button-area'),
        $detailsWrapper = $('#DetailsWrapper'),
        $firstCollapeHeader = $('#collapseOne'),
        $secondCollapeHeader = $('#collapseTwo'),
        $lblProjectName = $('#lblPropertyName'),
        $lblEnquiryId = $('#lblEnquiryId'),
        $ownerDetailsWrapper = $('#ownerDetailsWrapper');
    var $inputs =  {
        SaleTypeId: $('#SaleTypeId'),
        FinalAmount: $('#FinalAmount'),
        AccountNo: $('#AccountNo'),
        AccountName: $('#AccountName'),
        BankName: $('#BankName'),
        BranchName: $('#BranchName'),
        CityId: $('#CityId')
    };
    $(function () {
        // expand first accordian
        $('#panelheading-1').trigger('click');

        // bind property name autocomplete
//        $propertyName.autocomplete({
//            lookup: arr_propertynames,
//            showNoSuggestionNotice: false,
//            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
//                if (queryLowerCase == '*') {
//                    return suggestion.value;
//                } else {
//                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
//                    return re.test(suggestion.value);
//                }
//            },
//            onSelect: function (suggestion) {
//                if (suggestion) {
//                    $enquiryId.val(suggestion.data);
//                    $(this).removeClass('error');
//                }
//            },
//            onSearchStart: function (suggestion) {
//                $enquiryId.val(0);
//            },
//            onSearchComplete: function (query, suggestions) {
//                if (!suggestions.length) {
//                    $(this).addClass('error');
//                    $enquiryId.val(0);
//                } else
//                    $(this).removeClass('error');
//            }
//        });

        $(".single_dropdown2").select2({
            placeholder: "",
            minimumResultsForSearch: -1
        });

        bindExpandTr();

        if(arrOwnerdetails == '') {
            loadOwner();
        }

        var rowId = $('#scheduleRowId').val();
        for(var i=1;i<=rowId;i++) {
            var Amt = $('#shareAmount_'+i).val();
            var Percent = $('#sharePercentage_'+i).val();
            console.log(Amt);
            console.log(Percent);
//            if(Amt.length == 0 || Amt == 0 || Amt == '') {
//                $('#shareAmount_' + i).attr('readonly', true);
//            }
//            if(Percent.length == 0 || Percent == 0 || Percent == '') {
//                $('#sharePercentage_'+i).attr('readonly',true);
//            }
        }

    });

    function submitForm() {
        $('form').submit();
    }

    function isReadOnly(x) {
        //sharePercentage_1
        var $x = $(x),
            id = $x[0].id;
        var scheduleRowId = $('#scheduleRowId').val();
        for(var i=1;i<=scheduleRowId;i++) {
            if (id == 'sharePercentage_' + i) {
                var $x = $(x);
                if ($x.val() > 100.00) {
                    showError($x, "Percentage Cannot be more than 100%");
                } else {
                    removeError($x);
                }
//                $('#shareAmount_' + i).attr('readonly', true);
            } else if(id == 'shareAmount_'+i) {
                if($('#shareAmount_'+i).val() != 0) {
                    $('#sharePercentage_'+i).attr('readonly',true);
                }
            }
        }
    }

    function entryValidate() {
        resetError();
        var validRows = 0;

        if ($inputs.SaleTypeId.find('option:selected').val() == '') {
            alert('Select offer type!');
            return false;
        }

        if ($inputs.FinalAmount.val() == 0) {
            alert('Final Amount Cannot be Zero or Empty!');
            return false;
        }

        $.each($('input[name^=ownername]'), function () {
            var $this = $(this),
                id = $this[0].id,
                key = id.split('_')[1];

            $shareType = $('#shareType_' + key);
            if ($shareType.val().length == 0 || $('#shareTypeId_' + key).val() == 0) {
                showError($shareType, 'Required');
                return;
            }

            /*$sharePer = $('#sharePercentage_' + key);
            if ($sharePer.val().length == 0) {
                showError($sharePer, 'Required');
                return;
            }

            $shareAmt = $('#shareAmount_' + key);
            if ($shareAmt.val().length == 0) {
                showError($shareAmt, 'Required');
                return;
            }*/

            validRows++;
        });

        if (validRows < $('#scheduleRowId').val())
            return false;

        if ($inputs.AccountNo.val().length == 0) {
            alert('Account No is required');
            if(!$secondCollapeHeader.hasClass('in'))
                nextAccordian(2);
            return false;
        }

        if ($inputs.AccountName.val().length == 0) {
            alert('Account Name is required');
            if(!$secondCollapeHeader.hasClass('in'))
                nextAccordian(2);
            return false;
        }

        if ($inputs.BankName.val().length == 0) {
            alert('Bank Name is required');
            if(!$secondCollapeHeader.hasClass('in'))
                nextAccordian(2);
            return false;
        }

        if ($inputs.BranchName.val().length == 0) {
            alert('Branch Name is required');
            if(!$secondCollapeHeader.hasClass('in'))
                nextAccordian(2);
            return false;
        }

        if ($inputs.CityId.find('option:selected').val() == '') {
            alert('City is required');
            if(!$secondCollapeHeader.hasClass('in'))
                nextAccordian(2);

            return false;
        }


        if($('.error').length != 0) {
            alert('Kindly notice the error notifications!');
            return false;
        }

        return true;
    }

    function resetError() {
        $.each($('.error'), function () {
            removeError($(this));
        });
    }

    function bindShareTypeAutoComplete() {
        var $sharetypes = $('input[id^=shareType_]');
        $sharetypes.unbind('autocomplete');
        $.each($sharetypes, function (i, obj) {
            var $this = $(this),
                key1 = $this[0].id.split('_')[1];
            $this.autocomplete({
                lookup: arr_jvsharetypes,
                showNoSuggestionNotice: false,
                lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                    if (queryLowerCase == '*') {
                        return suggestion.value;
                    } else {
                        var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                        return re.test(suggestion.value);
                    }
                },
                onSelect: function (suggestion) {
                    if (suggestion) {
                        $("#shareTypeId_" + key1).val(suggestion.data);
                        $(this).removeClass('error');
                    }
                },
                onSearchStart: function (suggestion) {
                    $("#shareTypeId_" + key1).val(0);
                },
                onSearchComplete: function (query, suggestions) {
                    if (!suggestions.length) {
                        $(this).addClass('error');
                        $("#shareTypeId_" + key1).val(0);
                    } else $(this).removeClass('error');
                }
            });
        });
    }

    function bindExpandTr() {
        var $tr = $(".mainTr");
        $tr.unbind('click');
        $tr.click(function(e){
            e.preventDefault();
            var $subtr = $(this).closest("tr").next(".subTr"),
                $i = $(this).find("i");

            if(!$subtr.is(":visible")){
                $subtr.show();
                $subtr.find(".subDiv").slideDown("slow");
                $i.addClass("tform");
            } else{
                $subtr.find(".subDiv").slideUp("slow");
                $subtr.slideUp("slow");
                $i.removeClass("tform");
            }
        });
    }

    function validatePaymentTr(x) {
        var $x = $(x),
            $tr = $x.closest('tr'),
            keys = $x[0].id.split('_');

        if($('#payment_'+keys[1]+'_amt_'+ keys[3]).val().length == 0 || $('#payment_'+keys[1]+'_desc_'+ keys[3]).val().trim().length == 0
            || $('#payment_'+keys[1]+'_date_'+ keys[3]).val().trim().length == 0 )
            return;

        addSubTr(x);
        $tr.find('.subTrDelete').show();
    }

    function triggerPaymentUpdate (x) {
        var $x = $(x),
            $tr = $x.closest('tr'),
            keys = $x[0].id.split('_');

        if($('#payment_'+keys[1]+'_transid_'+keys[3]).val() == '0') {
            return;
        }

        $('#payment_'+keys[1]+'_updaterow_'+keys[3]).val(1);
    }

    function deleteSubTr(x,e,deleteFlag) {
        e.preventDefault();
        if (!confirm('Do you want to Delete'))
            return false;

        var $x = $(x),
            $tr = $x.closest('tr'),
            keys = $x[0].id.split('_');

        if ($tr.parent('tbody').find('> tr').length == 1)
            addSubTr(x,true);

        if(typeof deleteFlag != 'undefined' && deleteFlag) {
            var $ids = $('#paymentdeleteids_' + keys[1]);
            $ids.val($ids.val() + ',' + $('#payment_'+keys[1]+'_transid_'+keys[3]).val());
        }

        $tr.remove();
        return false;
    }

    function addSubTr(x, reset) {
        var $x = $(x),
            $tr = $x.closest('tr'),
            key = $x[0].id.split('_')[1];

        if ($tr.next('tr').length != 0)
            return;

        var $paymentdetailid = $('#paymentdetailid_' + key),
            count = parseInt($paymentdetailid.val()) + 1,
            template = $('#dummy-payment tbody').html();

        if(typeof reset != 'undefined' && reset == true)
            count = 1;

        template = template.replace(/__0/g, '_' + key).replace(/__1/g, '_' + count);
        $tr.after(template);

        $paymentdetailid.val(count);
        bindPaymentDatePicker();
    }

    function bindPaymentDatePicker() {
        $('.date_picker').datepicker({
            'format': 'dd-mm-yyyy'
        }).on('changeDate', function() {
            $('.datepicker').hide();
        }).data('datepicker');
    }

    function submitProperty (x,e) {
        e.preventDefault();
        var $x = $(x);
        var id = $enquiryId.val();
        $x.blur();

        if(id == 0) {
            //$propertyName.focus();
            alert('Select a property!');
            return false;
        }

        $x.prop('disabled', true);
        $ownerDetailsWrapper.html('');
        $.ajax({
            url: getBaseURL() + "project/landbank/getfinalizationownerdetails",
            async: false,
            data: {'EnquiryId': id},
            type: 'post',
            success: function (data, status,xhr) {
                if(xhr.status == "200"){
                    var template = $('#ownerDetailTemplate').html();
                    var payid = 0,
                        arr_owners = JSON.parse(data);
                    $.each(arr_owners,function(i,o){
                        payid+=1;
                        $ownerDetailsWrapper.append(template.replace(/__/g,'_'+payid));
                        $('#ownername_'+payid).val(o.OwnerName);
                        $('#ownerId_'+payid).val(o.OwnerId);
                    });
                }

                $mainWrapper.hide();

                // bind options
                $detailsWrapper.fadeIn("slow");
                $buttonArea.fadeIn("slow");

                if(!$firstCollapeHeader.hasClass('in'))
                    nextAccordian(1);

                bindShareTypeAutoComplete();
                bindExpandTr();
                bindPaymentDatePicker();

//                $lblProjectName.val($propertyName.val());
//                $lblEnquiryId.val($enquiryId.val());
//                $enquiryId.val(0);
//                $propertyName.val('');
            }
        });
        $x.prop('disabled', false);
    }

    function loadOwner() {
        if($('#lblPropertyName').val().length != 0) {
            var id = $enquiryId.val();
            $ownerDetailsWrapper.html('');
            $.ajax({
                url: getBaseURL() + "project/landbank/getfinalizationownerdetails",
                async: false,
                data: {'EnquiryId': id},
                type: 'post',
                success: function (data, status,xhr) {
                    if(xhr.status == "200"){

                        var template = $('#ownerDetailTemplate').html();
                        var payid = 0,
                            arr_owners = JSON.parse(data);
                        $.each(arr_owners,function(i,o){
                            payid+=1;
                            $ownerDetailsWrapper.append(template.replace(/__/g,'_'+payid));
                            $('#ownername_'+payid).val(o.OwnerName);
                            $('#ownerId_'+payid).val(o.OwnerId);
                        });
                        $('#scheduleRowId').val(arr_owners.length);
                    }

                    $mainWrapper.hide();

                    // bind options
                    $detailsWrapper.fadeIn("slow");
                    $buttonArea.fadeIn("slow");

                    if(!$firstCollapeHeader.hasClass('in'))
                        nextAccordian(1);

                    bindShareTypeAutoComplete();
                    bindExpandTr();
                    bindPaymentDatePicker();

                }
            });
        }
    }

    function showPropertyOptions() {
        $mainWrapper.fadeIn("slow");
        $detailsWrapper.hide();
        $buttonArea.hide();
        //$propertyName.focus();
    }

    function nextAccordian(id) {
        $('#panelheading-' + id).trigger('click');
    }

    function showComments(e, id) {
        e.preventDefault();
        $('#comments').addClass('show');
    }

    function closeComment() {
        $('#comments').removeClass('show');
    }
</script> 
<script id = "ownerDetailTemplate" type="text/template" class="hide">
    <tr>
        <td width="20%">
            <input class="parent_text" type="text" name="ownername__" id="ownername__" maxlength="155" readonly/>
            <input type="hidden" name="ownerId__" id="ownerId__" />
        </td>
        <td width="20%">
            <input class="parent_text" type="text" name="shareType__" id="shareType__" maxlength="155"/>
            <input type="hidden" name="shareTypeId__" id="shareTypeId__" />
        </td>
        <td width="10%">
            <input class="parent_text text-right" type="text" name="sharePercentage__" id="sharePercentage__" onchange="isReadOnly(this);" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)" maxlength="18"/>
        </td>
        <td width="10%">
            <input class="parent_text text-right" type="text" name="shareAmount__" id="shareAmount__" onblur="return FormatNum(this, 2)" onchange="isReadOnly(this);"  onkeypress="return isDecimal(event,this)" maxlength="18"/>
        </td>
        <td width="3%" align="center">
            <ul class="action_btns">
                <li><a href="#" class="mainTr"> <i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="top" data-original-title="Expand"></i></a></li>
            </ul>
        </td>
    </tr>
    <!--expand table-->
    <tr style="display:none;" class="subTr">
        <td colspan="9" style="padding:0px !important; ">
            <div class="subDiv" style="display:none;">
                <div class="col-lg-12">
                    <div class="table-responsive topsp">
                        <table class="table tableWithFloatingHeader" style=" margin-bottom:0px;">
                            <thead>
                            <tr>
                                <th>Description</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <input type="hidden" name="payment___transid_1" id="payment___transid_1" value="0"/>
                                <input type="hidden" name="payment___updaterow_1" id="payment___updaterow_1" value="0"/>
                                <td width="15%"><input type="text" class="parent_text" name="payment___desc_1" id="payment___desc_1" maxlength="155" onchange="validatePaymentTr(this);triggerPaymentUpdate(this);"></td>
                                <td width="5%"><input type="text" class="parent_text date_picker" placeholder="DD-MM-YYYY" name="payment___date_1" id="payment___date_1" onchange="validatePaymentTr(this);triggerPaymentUpdate(this);"></td>
                                <td width="5%"><input class="parent_text" type="text" name="payment___amt_1" id="payment___amt_1" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)" maxlength="18" onchange="validatePaymentTr(this);triggerPaymentUpdate(this);"/></td>
                                <td width="3%" align="center">
                                    <ul class="action_btns">
                                        <li>
                                            <a href="#" id="payment___delete_1" onclick="deleteSubTr(this, event);" class="subTrDelete" style="display: none;"><i class="fa fa-trash" data-toggle="tooltip" data-placement="top" data-original-title="Delete" ></i></a>
                                        </li>
                                    </ul>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                        <input type="hidden" name="paymentdetailid__" id="paymentdetailid__" value="1"/>
                        <input type="hidden" name="paymentdeleteids__" id="paymentdeleteids__" value="0"/>
                    </div>
                </div>
            </div>
        </td>
    </tr>
</script> 
