<script type="text/javascript" src="<?php echo $this->basePath(); ?>/js/select2.full.min.js"></script>
<link type="text/css" rel="stylesheet" href="<?php echo $this->basePath(); ?>/css/select2.min.css" />
<link rel="stylesheet" href="<?php echo $this->basePath(); ?>/css/workorder.css"/>
<div class="content_wrapper padlr0">
  <div class="container-fluid">
    <div class="row">
      <div class="col-lg-12">
        <h1 class="float_l">Qualifier Service Tax Setting</h1>
      </div>
    </div>
    <div class="col-lg-12 fmg_topcnt clear" style="margin-bottom:10px; border-bottom:none;">
      <div class="col-lg-4 form-group" style="padding-left:0px !important;">
        <select class="form-control single_dropdown lbl_move"  id="period"  onchange="return periodChange()" label="Period" style="width:100%;">
          <option></option>
          <option value="0" <?php echo ($periodid == '0') ? 'selected' : '';?>>None</option>
          <?php $i=1; if(isset($periodlist)) {
                        foreach($periodlist as $trans) { ?>
          <option value="<?php echo $trans['PeriodId']; ?>"  <?php echo ($periodid == $trans['PeriodId']) ? 'selected' : '';?> ><?php echo $trans['PeriodName']; ?></option>
          <?php $i=$i+1; } }?>
        </select>
      </div>
        <div class="col-lg-4 form-group tds-sett-md" style="padding-left:0px !important;"> <a style="display:block;" href="#" title="Add New Period" onclick="showPeriod()" ><i class="fa fa-plus"></i> Add New Period</a>
   
      </div>
    </div>
    <div class="panel-group block_panel clear" id="accordion" role="tablist" aria-multiselectable="true">
      <div class="panel panel-default">
        <?php $i=1; if(isset($stlist)) {
                    foreach($stlist as $trans) { ?>
        <div class="panel-heading accordion_head accordion_head_crnt" role="tab" id="heading_<?php echo $i; ?>" data-toggle="collapse" data-parent="#accordion" href="#collapse_<?php echo $i; ?>" aria-expanded="true" aria-controls="collapse_<?php echo $i; ?>">
          <h4><?php echo (isset($trans['WorkTypeName'])) ? $trans['WorkTypeName'] : ''; ?></h4>
          <input type="hidden" name="worktype_<?php echo $i; ?>" id="worktype_<?php echo $i; ?>" value="<?php echo (isset($trans['WorkType'])) ? $trans['WorkType'] : ''; ?>" />
        </div>
        <div id="collapse_<?php echo $i; ?>" class="panel-collapse collapse in" role="tabpanel" style="height: 0px; overflow: hidden;" aria-expanded="true" aria-labelledby="heading_<?php echo $i; ?>">
          <div class="panel-body">
            <div class="col-lg-12 clear top-sce">
              <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0">
                <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0">
                  <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0">
                    <div class="table-responsive topsp">
                      <table class="table tableWithFloatingHeader" style=" margin-bottom:0px;">
                        <thead>
                          <tr>
                            <th>Taxable %</th>
                            <th>Tax %</th>
                            <th>SB Cess</th>
                            <th>KK Cess</th>
                            <th>Net Tax</th>
                            <th>Reverse Tax</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td width="10%"><input class="parent_text text-right" type="text"  name="taxable_<?php echo $i; ?>" id="taxable_<?php echo $i; ?>" value="<?php echo (isset($trans['TaxablePer'])) ? $this->commonHelper()->sanitizeNumber($trans['TaxablePer'],2) : 0; ?>" onkeypress="return isDecimal(event,this)" ></td>
                            <td width="9%"><input class="parent_text text-right" type="text" name="tax_<?php echo $i; ?>" id="tax_<?php echo $i; ?>" value="<?php echo (isset($trans['TaxPer'])) ? $this->commonHelper()->sanitizeNumber($trans['TaxPer'],2) : 0; ?>" onkeypress="return isDecimal(event,this)" ></td>
                            <td width="7%"><input class="parent_text text-right" type="text" name="sbcess_<?php echo $i; ?>" id="sbcess_<?php echo $i; ?>" value="<?php echo (isset($trans['SBCess'])) ? $this->commonHelper()->sanitizeNumber($trans['SBCess'],2) : 0; ?>" onkeypress="return isDecimal(event,this)"></td>
                            <td width="7%"><input class="parent_text text-right" type="text" name="kkcess_<?php echo $i; ?>"  id="kkcess_<?php echo $i; ?>" value="<?php echo (isset($trans['KKCess'])) ? $this->commonHelper()->sanitizeNumber($trans['KKCess'],2) : 0; ?>" onkeypress="return isDecimal(event,this)"></td>
                            <td width="7%"><input class="parent_text text-right" type="text" name="nettax_<?php echo $i; ?>" id="nettax_<?php echo $i; ?>" value="<?php echo (isset($trans['NetTax'])) ? $this->commonHelper()->sanitizeNumber($trans['NetTax'],2) : 0; ?>" onkeypress="return isDecimal(event,this)" readonly></td>
                            <td width="7%"><input class="parent_text text-right" type="text" name="reversetax_<?php echo $i; ?>" id="reversetax_<?php echo $i; ?>" value="<?php echo (isset($trans['ReversePer'])) ? $this->commonHelper()->sanitizeNumber($trans['ReversePer'],2) : 0; ?>" onkeypress="return isDecimal(event,this)"></td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                    <div class="cont_bt col-lg-5 col-lg-offset-7 col-md-9 col-md-offset-3 col-sm-7 col-sm-offset-3 col-xs-7 col-xs-offset-4">
                      <ul>
                        <li style="padding-top:10px;"><a id="save_<?php echo $i; ?>" onclick="SaveRow(this.id)" href="#"><i class="fa fa-floppy-o" aria-hidden="true"></i> Save</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <?php $i=$i+1; } }?>
      </div>
    </div>
  </div>
    <div class="col-lg-12 savebtn_area clear">
    <ul>
     <li class="cb-cancel"><a href="<?php echo $this->basePath(); ?>/project/qualifier/qualifiermaster"><i class="fa fa-times-circle-o can-l"></i> Cancel</a></li>
     <li class="dropdown save_btn float_r"><!--<a onclick="submitForm(); return false;" data-toggle="tooltip" class="ripple" title="Save">Submit
     </a>--></li> </ul>
  </div>
  <div id="periodmodal" class="modal fade" role="dialog" data-backdrop="static" data-keyboard="false ">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal"><i class="fa fa-times-circle-o clpot"></i></button>
          <h1>Period Master - Service Tax</h1>
        </div>
        <div class="modal-body">
          <div class="topsp">
            <table class="table tableWithFloatingHeader" style=" margin-bottom:0px;" id="vtabillformat" >
              <thead>
                <tr>
                  <th>PeriodName</th>
                  <th>From Date</th>
                  <th>To Date</th>
                  <th>&nbsp;</th>
                </tr>
              </thead>
              <tbody>
                <?php $i=1;  if(isset($periodlist))  {
                                foreach($periodlist as $ptrans) { ?>
                <tr id="prowid_<?php echo $i; ?>">
                  <td width="10%"><input class="parent_text" type="text" name="periodName_<?php echo $i; ?>" id="periodName_<?php echo $i; ?>" value="<?php echo (isset($ptrans)) ? $ptrans['PeriodName'] : '';?>"  onchange="return validatePeriodName(this)" ></td>
                  <td width="10%"><input type="text" name="fromdate_<?php echo $i; ?>" id="fromdate_<?php echo $i; ?>" class="form-control date_picker"  value="<?php echo (isset($ptrans)) ? $ptrans['FDate'] : date('d-m-Y');?>" onchange="return validateDate(this)" />
                  <td width="10%"><input type="text" name="todate_<?php echo $i; ?>" id="todate_<?php echo $i; ?>" class="form-control date_picker"  value="<?php echo (isset($ptrans)) ? $ptrans['TDate'] : '';?>" disabled/>
                    <input type="hidden" name="periodId_<?php echo $i; ?>" id="periodId_<?php echo $i; ?>"  value="<?php echo $ptrans['PeriodId']; ?>"/>
                  <td width="1%" align="center"><ul class="action_btns">
                      <li> <a href="#" class="pdelete_<?php echo $i; ?>" name="pdelete_<?php echo $i; ?>" id="pdelete_<?php echo $i; ?>" onclick="deleteprow(this); return false;"> <i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete" ></i> </a> </li>
                    </ul></td>
                </tr>
                <?php $i=$i+1; } } ?>
                <tr id="prowid_<?php echo $i; ?>">
                  <td width="10%"><input class="parent_text" type="text" name="periodName_<?php echo $i; ?>" id="periodName_<?php echo $i; ?>" value="" onchange="return validatePeriodName(this)"></td>
                  <td width="10%"><input type="text" name="fromdate_<?php echo $i; ?>" id="fromdate_<?php echo $i; ?>" class="form-control date_picker"  value="" onchange="return validateDate(this)" />
                  <td width="10%"><input type="text" name="todate_<?php echo $i; ?>" id="todate_<?php echo $i; ?>" class="form-control date_picker"  value="" disabled/>
                    <input type="hidden" name="periodId_<?php echo $i; ?>" id="periodId_<?php echo $i; ?>"  value=""/>
                  <td width="1%" align="center"><ul class="action_btns">
                      <li> <a href="#" class="pdelete_<?php echo $i; ?>" name="pdelete_<?php echo $i; ?>" id="pdelete_<?php echo $i; ?>" onclick="deleteprow(this); return false;"> <i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete" ></i> </a> </li>
                    </ul></td>
                </tr>
              </tbody>
              <input type="hidden" name="prow" id="prow" value = "<?php echo $i; ?>"/>
            </table>
          </div>
        </div>
        <div class="clearfix"></div>
        <div class="modal-footer">
          <div class="col-lg-12"> <a href="#" class="md_cance" data-dismiss="modal" style="position: relative; overflow: hidden;">Cancel<span class="ripple-wrapper"></span><span class="ripple-wrapper"></span></a>
            <button type="button" class="md_ok" onclick="updatePeriod()">Submit</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <table id="dummy-period" style="display: none;">
    <tbody>
      <tr id="prowid__1">
        <td width="10%"><input class="parent_text" type="text" name="periodName__1" id="periodName__1" value="" onchange="return validatePeriodName(this)"></td>
        <td width="10%"><input type="text" name="fromdate__1" id="fromdate__1" class="form-control date_picker"  value="" onchange="return validateDate(this)" />
        <td width="10%"><input type="text" name="todate__1" id="todate__1" class="form-control date_picker"  value="" disabled/>
          <input type="hidden" name="periodId__1" id="periodId__1"  value=""/>
        <td width="1%" align="center"><ul class="action_btns">
            <li> <a href="#" class="pdelete__1" name="pdelete__1" id="pdelete__1" onclick="deleteprow(this); return false;"> <i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete" ></i> </a> </li>
          </ul></td>
      </tr>
    </tbody>
  </table>
</div>
<script>
    var bdateChange=false;

    $(document).ready(function() {
        $(".single_dropdown").select2({
            placeholder: "",
            allowClear: true
        });
    });

    $('input').on('change', function() {
        var $this = $(this),
            key1 = $this[0].id.split('_')[1];
        calculateTax(key1);
    });

    function calculateTax(key1)
    {
        var dTax = parseFloat(isNullCheck($('#tax_' + key1).val(),'number')),
            dkkcess = parseFloat(isNullCheck($('#kkcess_' + key1).val(),'number')),
            dsbcess = parseFloat(isNullCheck($('#sbcess_' + key1).val(),'number')),
            dreversetax = parseFloat(isNullCheck($('#reversetax_' + key1).val(),'number')),
            dNetTax = dTax + dkkcess + dsbcess;

        if (dreversetax >100) dreversetax=100;

        $('#tax_' + key1).val(sanitizeNumber(dTax,2));
        $('#kkcess_' + key1).val(sanitizeNumber(dkkcess,2));
        $('#reversetax_' + key1).val(sanitizeNumber(dreversetax,2));
        $('#nettax_' + key1).val(sanitizeNumber(dNetTax,2));

    }

    function SaveRow(id) {
        var key1 =  id.split('_')[1],
            iPeriod = $('#period').val(),
            sWorkType = isNullCheck($('#worktype_' + key1).val(),'string'),
            dTaxable = parseFloat(isNullCheck($('#taxable_' + key1).val(),'number')),
            dTax = parseFloat(isNullCheck($('#tax_' + key1).val(),'number')),
            dSBCess = parseFloat(isNullCheck($('#sbcess_' + key1).val(),'number')),
            dKKCess = parseFloat(isNullCheck($('#kkcess_' + key1).val(),'number')),
            dNetTax = parseFloat(isNullCheck($('#nettax_' + key1).val(),'number')),
            dReverseTax = parseFloat(isNullCheck($('#reversetax_' + key1).val(),'number'));


        var postData = {'PeriodId': iPeriod, 'WorkType': sWorkType,'Taxable' : dTaxable,'Tax':dTax,'KKCess':dKKCess,'NetTax': dNetTax,'ReversePer':dReverseTax,'SBCess':dSBCess};

        $('.loading_area').show();
        $.ajax({
            url: getBaseURL() + 'project/qualifier/updatestsetting',
            type: "post",
            data: postData,
            async: false,
            success: function (data, textStatus, jqXHR) {
//                if(data == 'Y')
//                    alert('Yes');
//                else
//                    alert('No');

                $('.loading_area').hide();
            }, error: function (jqXHR, textStatus, errorThrown) {
                isUsed = true;
                $('.loading_area').hide();
            }
        });
    }

    function updatePeriod() {
       var rows = $('tr[id*=prowid_]');
        var aPeriodList=[];
        $.each(rows, function() {
            var id = $(this)[0].id;
            i = id.split('_')[1];
            if (id.indexOf('__') != -1 || id.indexOf('excel') != -1) return;

            var iPeriodId = parseInt(isNullCheck($('#periodId_' + i).val(), 'number')),
                sPeriodName = isNullCheck($('#periodName_' + i).val(), 'string'),
                sfDate = isNullCheck($('#fromdate_' + i).val(), 'string'),
                stDate = isNullCheck($('#todate_' + i).val(), 'string');

            if (sPeriodName.length == 0) return;

            aPeriodList.push({
                PeriodId: iPeriodId,
                PeriodName: sPeriodName,
                FDate: sfDate,
                TDate: stDate
            });
        });

        $('.loading_area').show();
        $.ajax({
            url: getBaseURL() + 'project/qualifier/updateperiodmaster',
            type: "post",
            data: {'PeriodList': aPeriodList,'Type':'S'},
            async: false,
            success: function (data, textStatus, jqXHR) {
//                    if(data == 'Y')
//                        alert('Yes');
//                    else
//                        alert('No');

                $('.loading_area').hide();
            }, error: function (jqXHR, textStatus, errorThrown) {
                isUsed = true;
                $('.loading_area').hide();
            }
        });

        $('#periodmodal').modal('toggle');
        var iPeriodId = parseInt(isNullCheck($('#period').val(),'number'));
        window.location.href = getBaseURL() + "project/qualifier/servicetaxsetting/" + iPeriodId;
    }

    function showPeriod() {
        $("#periodmodal").modal('show');
        checkDelete();
    }

    function validateDate(x) {
        if (bdateChange==true) return;

        var $x = $(x),
            $tr = $x.closest('tr'),
            key = parseInt($x[0].id.split('_')[1]),
            bAns=false;

        if  (key >1)
        {
            var ikey = $tr.prev()[0].id.split('_')[1];
            var dPDate = new Date($('#fromdate_' + ikey).datepicker('getDate'));
            var dCDate = new Date($('#fromdate_' + key).datepicker('getDate'));

            if (dCDate <=  dPDate) {
                bAns=true;
                alert ("Invalid Date");

                var actualDate = new Date(dPDate);
                var newDate = new Date(actualDate.getFullYear(), actualDate.getMonth(), actualDate.getDate()+1);

                bdateChange=true;
                $('#fromdate_' + key).datepicker({'format': 'dd-mm-yyyy'}).datepicker('setDate', newDate);
                bdateChange=false;

                var actualDate = new Date();
                var newDate = new Date(actualDate.getFullYear(), actualDate.getMonth(), actualDate.getDate()-1);
                $('#todate_' + ikey).datepicker({'format': 'dd-mm-yyyy'}).datepicker('setDate', newDate);

            } else {
                var actualDate = new Date(dCDate);
                var newDate = new Date(actualDate.getFullYear(), actualDate.getMonth(), actualDate.getDate()-1);
                $('#todate_' + ikey).datepicker({'format': 'dd-mm-yyyy'}).datepicker('setDate', newDate);
            }
        }
        if (bAns==false) addNewPeriodRow(x);
    }


    function validatePeriodName(x) {
        var $x = $(x),
            $tr = $x.closest('tr'),
            key = parseInt($x[0].id.split('_')[1]),
            rowid = parseInt($('#prow').val()),
            sPeriodName = isNullCheck($('#periodName_' + key).val(),'string'),
            bAns=false;
        for (i=1;i <rowid;i++) {
            if (i != key) {
                var sCPeriodName = isNullCheck($('#periodName_' + i).val(),'string');
                if (sPeriodName == sCPeriodName) {
                    bAns==true;
                    alert ("Period Name Already Exists");
                    $('#periodName_' + key).val('');
                    return;
                }
            }
        }
        if (bAns==false) addNewPeriodRow(x);
    }

    function addNewPeriodRow(x) {
        var $x = $(x),
            $tr = $x.closest('tr'),
            key = $x[0].id.split('_')[1];

        if ($tr.next('tr').length != 0)  return;
        if ($('#periodName_' + key).val().length ==0) return;
        if ($('#fromdate_' + key).val().length ==0) return;

        var $rowid = $('#prow'),
            rowid = parseInt($rowid.val());
        var count = rowid + 1,
            template = $('#dummy-period tbody').html();
        template = template.replace(/__1/g, '_' + count);
        $tr.parent('tbody:not(.total)').append(template);

        $tr.next('tr').find('input.date_picker[id^="fromdate_"]').datepicker({'format': 'dd-mm-yyyy'});
        $tr.next('tr').find('.date_icon').click(function() {
            $(this).parent().find('input').datepicker('show');
        });
        checkDelete();
        $rowid.val(count);
    }

    function deleteprow(x) {
        var $tr = $(x).closest('tr'),
            key = parseInt($tr[0].id.split('_')[1]);
        var iPeriodId = parseInt(isNullCheck($('#periodId_' + key).val(), 'number'));

        var bAns=false;
        if (iPeriodId !=0) {
            $.ajax({
                url: getBaseURL() + 'project/qualifier/checkPeriodUsed',
                type: "post",
                data: {'PeriodId': iPeriodId, 'Type': 'S'},
                async: false,
                success: function (data, textStatus, jqXHR) {
                    if (data == "Y") {
                        alert('Period Used Do Not Delete');
                        bAns = true;
                        return;
                    }
                }
            });
        }

        if (bAns==false) {
            if (confirm('Do you want to Delete')) {
                if (key > 1) {
                    var key1 = $tr.prev()[0].id.split('_')[1];
                    $('#todate_' + key1).val('');
                }
                $tr.remove();
                checkDelete();
            }
        }
    }

    function checkDelete(){
        var rows = $('tr[id*=prowid_]');
        $.each(rows, function() {
            var id = $(this)[0].id;
            i = id.split('_')[1];
            if (id.indexOf('__') != -1 || id.indexOf('excel') != -1) return;

            if (id !=  $('#vtabillformat tr:last').attr('id')) {
                $('#pdelete_' + i).hide();
                $('#fromdate_' + i).prop('disabled', true);
            } else {
                $('#pdelete_' + i).show();
                $('#fromdate_' + i).prop('disabled', false);
            }
        });
    }


    function periodChange(id) {
        var iPeriodId = parseInt(isNullCheck($('#period').val(),'number'));
        window.location.href = getBaseURL() + "project/qualifier/servicetaxsetting/" + iPeriodId;
    }
</script>