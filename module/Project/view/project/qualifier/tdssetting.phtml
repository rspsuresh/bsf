<script type="text/javascript" src="<?php echo $this->basePath(); ?>/js/select2.full.min.js"></script>
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/js/select2.full.min.js"></script>
<link type="text/css" rel="stylesheet" href="<?php echo $this->basePath(); ?>/css/select2.min.css" />
<link rel="stylesheet" href="<?php echo $this->basePath(); ?>/css/workorder.css"/>
<div class="content_wrapper padlr0">
  <div class="container-fluid">
    <div class="row">
      <div class="col-lg-12">
        <h1 class="float_l">Qualifier TDS Setting </h1>
      </div>
    </div>
    <div class="col-lg-12 fmg_topcnt clear" style="margin-bottom:10px; border-bottom:none;">
      <div class="col-lg-4 form-group" style="padding-left:0px !important;">
        <select class="form-control single_dropdown lbl_move"  id="period"  onchange="return periodChange()" label="Period" style="width:100%;">
          <option></option>
          <option value="0" <?php echo ($periodid == '0') ? 'selected' : '';?>>None</option>
          <?php $i=1; if(isset($periodlist)) {
                        foreach($periodlist as $trans) { ?>
          <option value="<?php echo $trans['PeriodId']; ?>"  <?php echo ($periodid == $trans['PeriodId']) ? 'selected' : '';?> ><?php echo $trans['PeriodName']; ?></option>
          <?php $i=$i+1; } }?>
        </select>
      </div>
      <div class="col-lg-4 form-group tds-sett-md" style="padding-left:0px !important;"> <a style="display:block;" href="#" title="Add New Period" onclick="showPeriod()" ><i class="fa fa-plus"></i> Add New Period</a> </div>
    </div>
    <div class="panel-group block_panel clear" id="accordion" role="tablist" aria-multiselectable="true">
      <div class="panel panel-default">
        <?php $i=1; if(isset($tdstypelist)) {
                    foreach($tdstypelist as $trans) { ?>
        <div class="panel-heading accordion_head accordion_head_crnt" role="tab" id="heading_<?php echo $i; ?>" data-toggle="collapse" data-parent="#accordion" href="#collapse_<?php echo $i; ?>" aria-expanded="true" aria-controls="collapse_<?php echo $i; ?>">
          <h4><?php echo (isset($trans['TDSType'])) ? $trans['TDSType'] : ''; ?></h4>
          <input type="hidden" name="tdstypeId_<?php echo $i; ?>" id="tdstypeId_<?php echo $i; ?>" value="<?php echo (isset($trans['TDSTypeId'])) ? $trans['TDSTypeId'] : 0; ?>" />
        </div>
        <div id="collapse_<?php echo $i; ?>" class="panel-collapse collapse in" role="tabpanel" style="height: 0px; overflow: hidden;" aria-expanded="true" aria-labelledby="heading_<?php echo $i; ?>">
          <div class="panel-body">
            <div class="col-lg-12 clear top-sce">
              <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0">
                <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0">
                  <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0">
                    <div class="table-responsive topsp">
                      <table class="table tableWithFloatingHeader" style=" margin-bottom:0px;">
                        <thead>
                          <tr>
                            <th>Section</th>
                            <th>Taxable %</th>
                            <th>Tax %</th>
                            <th>Cess %</th>
                            <th>Edu.Cess %</th>
                            <th>H.Edu.cess %</th>
                            <th>Net Tax</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td width="10%"><input class="parent_text" type="text" name="section_<?php echo $i; ?>" id="section_<?php echo $i; ?>" value="<?php echo (isset($trans['Section'])) ? $trans['Section'] : ''; ?>" ></td>
                            <input type="hidden" name="sectionId_<?php echo $i; ?>" id="sectionId_<?php echo $i; ?>" value="<?php echo (isset($trans['SectionId'])) ? $trans['SectionId'] : 0; ?>"/>
                            <td width="10%"><input class="parent_text text-right" type="text"  name="taxable_<?php echo $i; ?>" id="taxable_<?php echo $i; ?>" value="<?php echo (isset($trans['TaxablePer'])) ? $this->commonHelper()->sanitizeNumber($trans['TaxablePer'],2) : 0; ?>" onkeypress="return isDecimal(event,this)" ></td>
                            <td width="9%"><input class="parent_text text-right" type="text" name="tax_<?php echo $i; ?>" id="tax_<?php echo $i; ?>" value="<?php echo (isset($trans['TaxPer'])) ? $this->commonHelper()->sanitizeNumber($trans['TaxPer'],2) : 0; ?>" onkeypress="return isDecimal(event,this)" ></td>
                            <td width="7%"><input class="parent_text text-right" type="text" name="cess_<?php echo $i; ?>" id="cess_<?php echo $i; ?>" value="<?php echo (isset($trans['SurCharge'])) ? $this->commonHelper()->sanitizeNumber($trans['SurCharge'],2) : 0; ?>" onkeypress="return isDecimal(event,this)"></td>
                            <td width="7%"><input class="parent_text text-right" type="text" name="educess_<?php echo $i; ?>"  id="educess_<?php echo $i; ?>" value="<?php echo (isset($trans['EDCess'])) ? $this->commonHelper()->sanitizeNumber($trans['EDCess'],2) : 0; ?>" onkeypress="return isDecimal(event,this)"></td>
                            <td width="7%"><input class="parent_text text-right" type="text" name="heducess_<?php echo $i; ?>" id="heducess_<?php echo $i; ?>" value="<?php echo (isset($trans['HEDCess'])) ? $this->commonHelper()->sanitizeNumber($trans['HEDCess'],2) : 0; ?>" onkeypress="return isDecimal(event,this)"></td>
                            <td width="7%"><input class="parent_text text-right" type="text" name="nettax_<?php echo $i; ?>" id="nettax_<?php echo $i; ?>" value="<?php echo (isset($trans['NetTax'])) ? $this->commonHelper()->sanitizeNumber($trans['NetTax'],2) : 0; ?>" onkeypress="return isDecimal(event,this)" readonly></td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                    <div class="cont_bt col-lg-5 col-lg-offset-7 col-md-9 col-md-offset-3 col-sm-7 col-sm-offset-3 col-xs-7 col-xs-offset-4">
                      <ul>
                        <li style="padding-top:10px;"><a  id="save_<?php echo $i; ?>" onclick="SaveRow(this.id)" href="#"><i class="fa fa-floppy-o" aria-hidden="true"></i> Save</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <?php $i=$i+1; } }?>
      </div>
    </div>
  </div>
</div>

<div id="periodmodal" class="modal fade" role="dialog" data-backdrop="static" data-keyboard="false ">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><i class="fa fa-times-circle-o clpot"></i></button>
        <h1>Period Master - TDS</h1>
      </div>
      <div class="modal-body">
        <div class="topsp">
          <table class="table tableWithFloatingHeader" style=" margin-bottom:0px;" id="vtabillformat" >
            <thead>
              <tr>
                <th>PeriodName</th>
                <th>From Date</th>
                <th>To Date</th>
                <th>&nbsp;</th>
              </tr>
            </thead>
            <tbody>
              <?php $i=1;  if(isset($periodlist))  {
                            foreach($periodlist as $ptrans) { ?>
              <tr id="prowid_<?php echo $i; ?>">
                <td width="10%"><input class="parent_text" type="text" name="periodName_<?php echo $i; ?>" id="periodName_<?php echo $i; ?>" value="<?php echo (isset($ptrans)) ? $ptrans['PeriodName'] : '';?>"  onchange="return validatePeriodName(this)" ></td>
                <td width="10%"><input type="text" name="fromdate_<?php echo $i; ?>" id="fromdate_<?php echo $i; ?>" class="form-control date_picker"  value="<?php echo (isset($ptrans)) ? $ptrans['FDate'] : date('d-m-Y');?>" onchange="return validateDate(this)" />
                <td width="10%"><input type="text" name="todate_<?php echo $i; ?>" id="todate_<?php echo $i; ?>" class="form-control date_picker"  value="<?php echo (isset($ptrans)) ? $ptrans['TDate'] : '';?>" disabled/>
                  <input type="hidden" name="periodId_<?php echo $i; ?>" id="periodId_<?php echo $i; ?>"  value="<?php echo $ptrans['PeriodId']; ?>"/>
                <td width="1%" align="center"><ul class="action_btns">
                    <li> <a href="#" class="pdelete_<?php echo $i; ?>" name="pdelete_<?php echo $i; ?>" id="pdelete_<?php echo $i; ?>" onclick="deleteprow(this); return false;"> <i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete" ></i> </a> </li>
                  </ul></td>
              </tr>
              <?php $i=$i+1; } } ?>
              <tr id="prowid_<?php echo $i; ?>">
                <td width="10%"><input class="parent_text" type="text" name="periodName_<?php echo $i; ?>" id="periodName_<?php echo $i; ?>" value="" onchange="return validatePeriodName(this)"></td>
                <td width="10%"><input type="text" name="fromdate_<?php echo $i; ?>" id="fromdate_<?php echo $i; ?>" class="form-control date_picker"  value="" onchange="return validateDate(this)" />
                <td width="10%"><input type="text" name="todate_<?php echo $i; ?>" id="todate_<?php echo $i; ?>" class="form-control date_picker"  value="" disabled/>
                  <input type="hidden" name="periodId_<?php echo $i; ?>" id="periodId_<?php echo $i; ?>"  value=""/>
                <td width="1%" align="center"><ul class="action_btns">
                    <li> <a href="#" class="pdelete_<?php echo $i; ?>" name="pdelete_<?php echo $i; ?>" id="pdelete_<?php echo $i; ?>" onclick="deleteprow(this); return false;"> <i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete" ></i> </a> </li>
                  </ul></td>
              </tr>
            </tbody>
            <input type="hidden" name="prow" id="prow" value = "<?php echo $i; ?>"/>
          </table>
        </div>
      </div>
      <div class="clearfix"></div>
      <div class="modal-footer">
        <div class="col-lg-12"> 
        <a href="#" class="md_cance" data-dismiss="modal" style="position: relative; overflow: hidden;">Cancel<span class="ripple-wrapper"></span><span class="ripple-wrapper"></span></a>
          <button type="button" class="md_ok" onclick="updatePeriod()">Submit</button>
        </div>
      </div>
    </div>
  </div>
</div>
  <div class="col-lg-12 savebtn_area clear">
    <ul>
      <li class="cb-cancel"><a href="<?php echo $this->basePath(); ?>/project/qualifier/qualifiermaster"><i class="fa fa-times-circle-o can-l"></i> Cancel</a></li>
     <li class="dropdown save_btn float_r"><!--<a onclick="submitForm(); return false;" data-toggle="tooltip" class="ripple" title="Save">Submit
     </a>--></li> </ul>
  </div>
<table id="dummy-period" style="display: none;">
  <tbody>
    <tr id="prowid__1">
      <td width="10%"><input class="parent_text" type="text" name="periodName__1" id="periodName__1" value="" onchange="return validatePeriodName(this)"></td>
      <td width="10%"><input type="text" name="fromdate__1" id="fromdate__1" class="form-control date_picker"  value="" onchange="return validateDate(this)" />
      <td width="10%"><input type="text" name="todate__1" id="todate__1" class="form-control date_picker"  value="" disabled/>
        <input type="hidden" name="periodId__1" id="periodId__1"  value=""/>
      <td width="1%" align="center"><ul class="action_btns">
          <li> <a href="#" class="pdelete__1" name="pdelete__1" id="pdelete__1" onclick="deleteprow(this); return false;"> <i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete" ></i> </a> </li>
        </ul></td>
    </tr>
  </tbody>
</table>
<script>
    var bdateChange=false;
    var sectionlist = <?php echo (isset($sectionlist)) ? json_encode($sectionlist) : '[]';?>;
    $(document).ready(function() {
        $(".single_dropdown").select2({
            placeholder: "",
            allowClear: true
        });
        bindSectionAutoComplete();
    });

    $('input').on('change', function() {
        var $this = $(this),
            key1 = $this[0].id.split('_')[1];
        calculateTax(key1);
    });

    function calculateTax(key1)
    {
        var dTax = parseFloat(isNullCheck($('#tax_' + key1).val(),'number')),
            dcess = parseFloat(isNullCheck($('#cess_' + key1).val(),'number')),
            dedcess = parseFloat(isNullCheck($('#educess_' + key1).val(),'number')),
            dhedcess = parseFloat(isNullCheck($('#heducess_' + key1).val(),'number')),
            dNetTax = dTax + ((dcess*dTax  + dedcess*dTax + dhedcess*dTax)/100);

        $('#tax_' + key1).val(sanitizeNumber(dTax,2));
        $('#cess_' + key1).val(sanitizeNumber(dcess,2));
        $('#educess_' + key1).val(sanitizeNumber(dedcess,2));
        $('#heducess_' + key1).val(sanitizeNumber(dhedcess,2));
        $('#nettax_' + key1).val(sanitizeNumber(dNetTax,2));
    }

    function bindSectionAutoComplete() {
        var $typename = $('input[id^=section_]');
        $.each($typename, function () {
            var $this = $(this),
                name = $this[0].id;
            if (name.indexOf('__') != -1 || name.indexOf('excel') != -1) return;

            $this.unbind('autocomplete');
            var arrname = name.split('_');
            var key1 = arrname[1];
            $this.autocomplete({
                lookup: sectionlist,
                lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                    if (queryLowerCase == '*') {
                        return suggestion.value;
                    } else {
                        var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                        return re.test(suggestion.value);
                    }
                }, onSelect: function(suggestion) {
                    if(suggestion) {
                        var $el = $("#sectionId_" + key1);
                        $el.val(suggestion.data);
                        removeError($(this));
                    }
                }, onSearchStart: function(suggestion) {
                    $("#sectionId_" + key1).val(0);
                }, onSearchComplete: function (query, suggestions) {
                    if(!suggestions.length  && query.length > 1){
                        showError($(this), 'Required');
                        $("#sectionId_" + key1).val(0);
                    } else
                        removeError($(this));
                }
            });
        });
    }

    function updatePeriod() {
        var rows = $('tr[id*=prowid_]');
        var aPeriodList=[];
        $.each(rows, function() {
            var id = $(this)[0].id;
            i = id.split('_')[1];
            if (id.indexOf('__') != -1 || id.indexOf('excel') != -1) return;

            var iPeriodId = parseInt(isNullCheck($('#periodId_' + i).val(), 'number')),
                sPeriodName = isNullCheck($('#periodName_' + i).val(), 'string'),
                sfDate = isNullCheck($('#fromdate_' + i).val(), 'string'),
                stDate = isNullCheck($('#todate_' + i).val(), 'string');

            if (sPeriodName.length == 0) return;
            aPeriodList.push({
                PeriodId: iPeriodId,
                PeriodName: sPeriodName,
                FDate: sfDate,
                TDate: stDate
            });
        });

        //console.log(aPeriodList);

        $('.loading_area').show();
        $.ajax({
            url: getBaseURL() + 'project/qualifier/updateperiodmaster',
            type: "post",
            data: {'PeriodList': aPeriodList,'Type':'T'},
            async: false,
            success: function (data, textStatus, jqXHR) {
                $('.loading_area').hide();
            }, error: function (jqXHR, textStatus, errorThrown) {
                isUsed = true;
                $('.loading_area').hide();
            }
        });

        $('#periodmodal').modal('toggle');
        var iPeriodId = parseInt(isNullCheck($('#period').val(),'number'));
        window.location.href = getBaseURL() + "project/qualifier/tdssetting/" + iPeriodId;
    }

    function showPeriod() {
        $("#periodmodal").modal('show');
        checkDelete();
    }

    function validateDate(x) {
        if (bdateChange==true) return;
        var $x = $(x),
            $tr = $x.closest('tr'),
            key = parseInt($x[0].id.split('_')[1]),
            bAns=false;
        if  (key >1)
        {
            var ikey = $tr.prev()[0].id.split('_')[1];
            var dPDate = new Date($('#fromdate_' + ikey).datepicker('getDate'));
            var dCDate = new Date($('#fromdate_' + key).datepicker('getDate'));
            if (dCDate <=  dPDate) {
                bAns=true;
                alert ("Invalid Date");

                var actualDate = new Date(dPDate);
                var newDate = new Date(actualDate.getFullYear(), actualDate.getMonth(), actualDate.getDate()+1);

                bdateChange=true;
                $('#fromdate_' + key).datepicker({'format': 'dd-mm-yyyy'}).datepicker('setDate', newDate);
                bdateChange=false;

                var actualDate = new Date();
                var newDate = new Date(actualDate.getFullYear(), actualDate.getMonth(), actualDate.getDate()-1);

                $('#todate_' + ikey).datepicker({'format': 'dd-mm-yyyy'}).datepicker('setDate', newDate);
            } else {

                var actualDate = new Date(dCDate);
                var newDate = new Date(actualDate.getFullYear(), actualDate.getMonth(), actualDate.getDate()-1);

                $('#todate_' + ikey).datepicker({'format': 'dd-mm-yyyy'}).datepicker('setDate', newDate);
            }
        }
        if (bAns==false) addNewPeriodRow(x);
    }


    function validatePeriodName(x) {
        var $x = $(x),
        $tr = $x.closest('tr'),
        key = parseInt($x[0].id.split('_')[1]),
        rowid = parseInt($('#prow').val()),
        sPeriodName = isNullCheck($('#periodName_' + key).val(),'string'),
        bAns=false;
        for (i=1;i <rowid;i++) {
            if (i != key) {
                var sCPeriodName = isNullCheck($('#periodName_' + i).val(),'string');
                if (sPeriodName == sCPeriodName) {
                    bAns==true;
                    alert ("Period Name Already Exists");
                    $('#periodName_' + key).val('');
                    return;
                }
            }
        }
        if (bAns==false) addNewPeriodRow(x);
    }

    function addNewPeriodRow(x) {

        var $x = $(x),
            $tr = $x.closest('tr'),
            key = $x[0].id.split('_')[1];

        if ($tr.next('tr').length != 0)  return;
        if ($('#periodName_' + key).val().length ==0) return;
        if ($('#fromdate_' + key).val().length ==0) return;

        var $rowid = $('#prow'),
            rowid = parseInt($rowid.val());
        var count = rowid + 1,
            template = $('#dummy-period tbody').html();
        template = template.replace(/__1/g, '_' + count);
        $tr.parent('tbody:not(.total)').append(template);

        $tr.next('tr').find('input.date_picker[id^="fromdate_"]').datepicker({'format': 'dd-mm-yyyy'});
        $tr.next('tr').find('.date_icon').click(function() {
            $(this).parent().find('input').datepicker('show');
        });
        checkDelete();
        $rowid.val(count);
    }

    function deleteprow(x) {

        var $tr = $(x).closest('tr'),
            key = parseInt($tr[0].id.split('_')[1]);

        var iPeriodId = parseInt(isNullCheck($('#periodId_' + key).val(), 'number'));

        var bAns=false;
        if (iPeriodId !=0) {
            $.ajax({
                url: getBaseURL() + 'project/qualifier/checkPeriodUsed',
                type: "post",
                data: {'PeriodId': iPeriodId, 'Type': 'T'},
                async: false,
                success: function (data, textStatus, jqXHR) {
                    if (data == "Y") {
                        alert('Period Used Do Not Delete');
                        bAns = true;
                        return;
                    }
                }
            });
        }

        if (bAns==false) {
            if (confirm('Do you want to Delete')) {
                if (key > 1) {
                    var key1 = $tr.prev()[0].id.split('_')[1];
                    $('#todate_' + key1).val('');
                }
                $tr.remove();
                checkDelete();
            }
        }
    }

    function periodChange(id) {
        var iPeriodId = $('#period').val();
        window.location.href = getBaseURL() + "project/qualifier/tdssetting/" + iPeriodId;
    }


    function checkDelete(){
        var rows = $('tr[id*=prowid_]');
        $.each(rows, function() {
            var id = $(this)[0].id;
            i = id.split('_')[1];
            if (id.indexOf('__') != -1 || id.indexOf('excel') != -1) return;

            if (id !=  $('#vtabillformat tr:last').attr('id')) {
                $('#pdelete_' + i).hide();
                $('#fromdate_' + i).prop('disabled', true);
            } else {
                $('#pdelete_' + i).show();
                $('#fromdate_' + i).prop('disabled', false);
            }
        });
    }

    function SaveRow(id) {
        var key1 =  id.split('_')[1],
            iPeriod = $('#period').val(),
            iTdsTypeId = parseInt(isNullCheck($('#tdstypeId_' + key1).val(),'number')),
            iSectionId = parseInt(isNullCheck($('#sectionId_' + key1).val(),'number')),
            dTaxable = parseFloat(isNullCheck($('#taxable_' + key1).val(),'number')),
            dTax = parseFloat(isNullCheck($('#tax_' + key1).val(),'number')),
            dcess = parseFloat(isNullCheck($('#cess_' + key1).val(),'number')),
            dedcess = parseFloat(isNullCheck($('#educess_' + key1).val(),'number')),
            dhedcess = parseFloat(isNullCheck($('#heducess_' + key1).val(),'number')),
            dNetTax = parseFloat(isNullCheck($('#nettax_' + key1).val(),'number'));

        var postData = {'PeriodId': iPeriod, 'TDSTypeId': iTdsTypeId,'SectionId':iSectionId,'Taxable' : dTaxable,'Tax':dTax,'Cess':dcess,'EDCess': dedcess,'HEDCess': dhedcess,'NetTax': dNetTax };

        $('.loading_area').show();
        $.ajax({
            url: getBaseURL() + 'project/qualifier/updatetdssetting',
            type: "post",
            data: postData,
            async: false,
            success: function (data, textStatus, jqXHR) {
                $('.loading_area').hide();
            }, error: function (jqXHR, textStatus, errorThrown) {
                isUsed = true;
                $('.loading_area').hide();
            }
        });
    }
</script>