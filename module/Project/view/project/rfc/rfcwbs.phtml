<link rel="stylesheet" href="<?php echo $this->basePath() . '/css/project.css';?>"/>

<style>
    body{ background:#F1F4F9;}
    .jqx-widget-content{background:#fff;border:1px solid #c2c2c2; color:#333 !important;}
    .jqx-widget-content ul{ width:250px !important; }
    .jqx-widget-content ul li.jqx-tree-item-li{border:1px solid rgba(128, 123, 23, 0.59)!important; width:252px!important; margin-bottom:5px;}
    .jqx-widget{  margin-bottom:10px !important; }
    .jqx-tree-item{ border:none !important; overflow:unset !important; width:220px !important; padding:5px;}
    .jqx-tree-item-arrow-expand jqx-icon-arrow-down{ background:#06F !important;}
    .jqx-tree-item-hover{ background:none !important;}
    .jqx-tree-dropdown-root{ margin-top:20px !important;}
    .jqx-rc-all{ border:none !important; border-radius:none !important;}
    .jqx-tree-item-arrow-expand{ border:1px solid #999 !important; margin-left:3px !important; margin-top:3px !important; margin-right:3px;}
    .jqx-icon-arrow-right{ border:1px solid #999 !important; margin-left:3px !important; margin-top:3px !important;margin-right:3px; }
    .jqx-fill-state-pressed{ background:rgba(226, 241, 171, 0.41) !important; padding-left:3px !important;border-radius:0px !important; padding:5px !important;}
    .jqx-tree-item:hover{ color:#999;}
    .jqx-popup{ background:#F3F9DC !important;   border: 1px solid hsla(57, 70%, 30%, 0.59) !important;}
    .jqx-menu-item-top{ float:left; margin:0px; padding:5px;}
    .jqx-fill-state-hover{ background:none !important; color:#999; }
    .jqx-menu-iteam-top-hover{ background:none !important;border-bottom:1px thick #066;}
    #treeWrapper {width: 100%;}
    #treeWrapper, #treeWrapper > div {float: left;}
</style>

<div class="content_wrapper padlr0">
    <div class="container-fluid">
        <div class="row">
            <form id="form"  method="post">
                <input type="hidden" name="rfcUId" id="rfcUId" value="<?php echo $rfcid;?>">
                <input type="hidden" name="rfcmode" id="rfcmode" value="<?php echo $mode;?>">
                <input type="hidden" name="editid" id="editid" value="<?php echo $editid;?>">

                <div class="col-lg-12 page_tittle">
                    <h1>Request for Creation - WBS Add</h1>
                </div>

                <div class="col-lg-12 top_ct" >
                    <div class="col-lg-3 col-lg-offset-0 col-md-3 col-md-offset-0 col-sm-3 col-sm-offset-0">
                        <div class="form-group"> <span class="date_icon"><i class="fa fa-calendar"></i></span>
                            <input type="text" name="refdate" id="refdate" class="form-control date_picker lbl_move" label="Reference Date"  value="<?php  if ($rfcid !=0) { echo date("d-m-Y", strtotime($rfcregister['RefDate'])) ;} else { echo date("d-m-Y");  }?>" readonly/>
                        </div>
                    </div>
                    <div class="col-lg-3 col-lg-offset-0 col-md-3 col-md-offset-0 col-sm-3 col-sm-offset-0">
                        <div class="form-group">
                            <input type="text" name="refno" id="refno" class="form-control lbl_move" label="Reference No" value="<?php echo ($rfcid !=0 ) ? $rfcregister['RefNo'] : $svNo; ?>" <?php echo ($genType==true) ? 'readonly' : ''; ?>/>
                        </div>
                    </div>

                    <div class="col-lg-3 col-lg-offset-0 col-md-3 col-md-offset-0 col-sm-3 col-sm-offset-0">
                        <div class="form-group">
                            <input type="text" name="project_name" id="project_name" class="form-control lbl_move" label="Project Name"  value="<?php if(isset($projectinfo)) echo $projectinfo['ProjectName']; else if(isset($rfcregister['ProjectName'])) echo $rfcregister['ProjectName'];?>" readonly/>
                            <input type="hidden" name="project_id" id="project_id"  value="<?php if(isset($projectinfo)) echo $projectinfo['ProjectId']; else if(isset($rfcregister['ProjectId'])) echo $rfcregister['ProjectId'];?>"/>
                        </div>
                    </div>
                    <div class="col-lg-3 col-lg-offset-0 col-md-3 col-md-offset-0 col-sm-3 col-sm-offset-0">
                        <div class="form-group">
                            <input type="text" name="project_typename" id="project_typename" class="form-control lbl_move" label="Type" value="<?php if(isset($projecttypename)) echo $projecttypename; else if(isset($rfcregister['ProjectTypeName'])) echo $rfcregister['ProjectTypeName'];?>" readonly/>
                            <input type="hidden" name="project_type" id="project_type" value="<?php if(isset($projecttype)) echo $projecttype; else if(isset($rfcregister['ProjectType'])) echo $rfcregister['ProjectType'];?>"/>
                        </div>
                    </div>
                    <div class="clearfix"></div>
                </div>

                <!--table Jq Grid start-->
                <div class="col-lg-12 col-lg-offset-0" id="iow-list">
                    <!-- Tree Structure -->
                    <div id="treeWrapper" style="display: none;">
                        <div class="bread_crumb first_step" id="tree-structure"></div>
                    </div>
                    <div class="clearfix"></div>
                    <div class="table-responsive clear" style="overflow: visible;" id="grid-wrapper">
                        <div id='jqxWidget'>
                            <div id='jqxTree'></div>
                            <div id='jqxMenu'>
                                <ul>
                                    <li id="menu-newwbs">Add WBS</li>
                                    <li>Edit WBS</li>
                                    <li>Remove WBS</li>
                                    <li id="menu-addiow">Add IOW</li>
                                    <li id="menu-showiow">Show IOW</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!--Project IOW Table Start-->
                <div class="col-lg-12 col-lg-offset-0">
                    <div class="table-responsive topsp" id="iow-content" style="display: none;"></div>
                    <input type="hidden" name="newIOWRowId" id="newIOWRowId" value="[]"/>
                </div>
            </form>
        </div>
        <table  id="newrateresource" style="display: none;">
            <tr>
                <td ><a href="#" id ="butnewrateresource" class="btn btn-link" onclick="return ShowRateResource(event)" >Resource Invloved</a></td>
            </tr>
        </table>

        <table id="newitems" style="display: none;">
            <tr>
                <!-- <td > <button type="button" id ="butnewitems" class="btn btn-info btn-xs" > Work Group </button> </td> -->
                <td ><a href="#" id ="butnewitems" class="btn btn-link" onclick="return ShowNewWorkGroup(event)" >New Work Group Created</a></td>
                <!-- <td> <h4 class="butnewitems">New Work Group Created</h4> </td> -->
            </tr>
            <tr>
                <table class="table" id ="newwg" style="display: none; width:50%; border:1px solid #ccc;">
                    <thead>
                    <tr>
                        <th style="border-right:1px solid #ccc;">Work Group Name</th>
                        <th class="text-center">Action</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td style="border-right:1px solid #ccc;"><input type="text" class="parent_text" name="newwgname_1" value = "" id="newwgname_1" align="right" readonly></td>
                        <td width="3%" align="center"><button type="button" name="newwgdetails_1" value = "Show Details" id="newwgdetails_1" onclick="return ShowWorkGroup(this.id)" style="margin:0;" ><i class="fa fa-pencil-square-o ctlss"></i></button></td>
                        <input type="hidden" name="newwgid_1" value = "" id="newwgid_1" >
                        <input type="hidden" name="newwgtypename_1" value = "" id="newwgtypename_1" >
                        <input type="hidden" name="newwgactivity_1" value = "" id="newwgactivity_1" >
                        <input type="hidden" name="newwgrateanal_1" value = "" id="newwgrateanal_1" >
                        <input type="hidden" name="newwgactivityres_1" value = "" id="newwgactivityres_1" >
                    </tr>
                    </tbody>
                </table>
            </tr>
        </table>
        <table  id="newresitems" style="display: none;">
            <tr>
                <!-- <td > <button type="button" id ="butnewresitems" class="btn btn-info btn-xs" > Resource </button> </td> -->
                <td ><a href="#" id ="butnewresitems" class="btn btn-link" onclick="return ShowNewResource(event)" >New Resource Created</a></td>
            </tr>
            <tr >
                <table class="table" id="newres" style="display: none; width:50%;border:1px solid #ccc;">
                    <thead>
                    <tr>
                        <th style="border-right:1px solid #ccc;">Resource Name</th>
                        <th style="border-right:1px solid #ccc;">Type</th>
                        <th class="text-center">Action</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td style="border-right:1px solid #ccc;"><input type="text" class="parent_text" name="newresname_1" value = "" id="newresname_1" align="right" readonly></td>
                        <td style="border-right:1px solid #ccc;"><input type="text" class="parent_text" name="newrestype_1" value = "" id="newrestype_1" align="right" readonly></td>
                        <td width="3%" align="center"><button type="button" name="newresdetails_1" value = "Show Details" id="newresdetails_1" onclick="return ShowResource(this.id)" style="margin:0;"><i class="fa fa-pencil-square-o ctlss"></i></button></td>
                        <input type="hidden"  name="newresgroup_1" value = "" id="newresgroup_1">
                        <input type="hidden"  name="newresgroupid_1" value = "" id="newresgroupid_1">
                        <input type="hidden"  name="newresunit_1" value = "" id="newresunit_1">
                        <input type="hidden"  name="newresunitid_1" value = "" id="newresunitid_1">
                        <input type="hidden"  name="newresrate_1" value = "" id="newresrate_1">
                    </tr>
                    </tbody>
                </table>
            </tr>
        </table>
    </div>
</div>

<div class="col-lg-12 savebtn_area">
    <ul>
        <li><div id="back-btn" class="back-bts" style="display:none;"><a href="javascript:showTreeGrid();" data-toggle="tooltip" data-placement="right" title="Go Back"> <i class="fa fa-chevron-circle-left"></i> Back</a></div></li>
        <li class="dropdown save_btn float_r" id="submit-btn"><a href="javascript:submitForm();" data-toggle="tooltip" class="ripple" title="Submit!">Submit</a>
        <li class="cancel_btn float_r" id="cancel-btn"><a href="<?php echo $this->basePath() . '/project/rfc/rfcwbs';?>" data-toggle="tooltip" class="ripple" title="Cancel">Cancel</a></li>
    </ul>
</div>


<!-- Modal -->
<div id="rateResource" class="modal fade" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><i class="fa fa-times-circle-o clpot"></i></button>
                <h1>Resource Rate</h1>
            </div>
            <div class="modal-body">
                <div class="table-responsive topsp animated-panel zoomIn" style="overflow:visible;animation-delay: 0.2s;">
                    <table class="table" id="resourcerate" style="margin-bottom: 0">
                        <thead>
                        <tr>
                            <th class="th-modal">ResourceName</th>
                            <th class="th-modal">Unit</th>
                            <th class="th-modal">Rate</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td width="15%"><input class="parent_text" type="text" name="rateresname_1" id="rateresname_1" readonly ></td>
                            <td width="3%"><input class="parent_text" type="text" name="rateresunit_1" id="rateresunit_1" readonly ></td>
                            <td width="5%"><input  class="parent_text text-right" type="text" name="rateresrate_1" id="rateresrate_1" align="right" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 2)"></td>
                            <input type="hidden" name="rateresoldrate_1" id="rateresoldrate_1" >
                            <input type="hidden" name="rateresid_1" id="rateresid_1" >
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="clearfix"></div>
            </div>
            <div class="modal-footer">
                <a href="#" class="md_cance" data-dismiss="modal" data-toggle="tooltip"  data-original-title="Cancel" style="position: relative; overflow: hidden;">Cancel<span class="ripple-wrapper"></span><span class="ripple-wrapper"></span></a>
                <button type="button" class="md_ok" onclick="return ResourceRateUpdate()" data-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<div id="formula" class="modal fade" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><i class="fa fa-times-circle-o clpot"></i></button>
                <h1>Formula</h1>
            </div>
            <div class="modal-body">

                <div class="form-group">
                    <label>Formula Expression</label>
                    <input type="text" class="parent_text" name="formulaexp" value = "" id="formulaexp" onchange="return formulacalculation()" onkeypress="return isFormula(event);" >
                </div>
                <div class="form-group">
                    <input type="text" class="parent_text text-right" name="formulavalue" value = "" id="formulavalue" readonly >
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="md_ok ripple has-ripple" onclick="return formulaok()" data-dismiss="modal" data-toggle="tooltip" data-original-title="OK">OK</button>
            </div>
        </div>
    </div>
</div>

<div id="workgroupmodal" class="modal fade" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><i class="fa fa-times-circle-o clpot"></i></button>
                <h1>WorkGroup</h1>
            </div>
            <div class="modal-body">
                <input type="hidden" name="wgrowid" id="wgrowid">
                <div class="form-group">
                    <label style="margin-bottom: 10px;">Work Group Name</label>
                    <input type="text" class="parent_text" name="workgroup" id="workgroup" >
                </div>
                <div class="form-group">
                    <label style="margin-bottom: 10px;">Worktype</label>
                    <input type="text" class="parent_text" name="worktype" id ="worktype" >
                    <input type="hidden" name="worktype_id" id ="worktype_id" >
                    <div class="clearfix"></div>
                </div>
                <div class="radio_check">
                    <p>
                        <input type="checkbox" name="resgroup" value="" id="create-activity">
                        <label for="create-activity" class="ripple has-ripple" style="position: relative; overflow: hidden;">Create Activity Resource Group Same as Work Group<span class="ripple-wrapper"></span></label>
                    </p>
                    <p>
                        <input type="checkbox" value="" name="resact" id="auto-res-create">
                        <label for="auto-res-create" class="ripple has-ripple" style="position: relative; overflow: hidden;">Auto Activity Resource Creation Based on<span class="ripple-wrapper"></span></label>
                    </p>
                    <p>
                        <input type="checkbox" value="" id="auto-generate-rate" name="rateanal">
                        <label for="auto-generate-rate" class="ripple has-ripple" style="position: relative; overflow: hidden;">Automatically Generate Rate Analysis for Item of Work based on Work Group Analysis<span class="ripple-wrapper"></span></label>
                    </p>
                </div>
                <div class="clearfix"></div>
            </div>
            <div class="modal-footer">
                <a href="#" class="cancel_btn ripple has-ripple" data-dismiss="modal"  data-toggle="tooltip" data-original-title="Cancel" style="position: relative; overflow: hidden;">Cancel<span class="ripple-wrapper"></span><span class="ripple-wrapper"></span></a>
                <button type="button" class="md_ok ripple has-ripple" onclick="return WorkGroupUpdate()" data-dismiss="modal" data-toggle="tooltip"  data-original-title="OK">OK</button>
            </div>
        </div>
    </div>
</div>

<div id="dummyheader" style="display: none">
    <table id="dummyanalhead">
        <tbody>
        <tr id="newiow__0_rateanal__1_header__9">
            <td colspan="12"><input type="text" class="parent_text"  style="font-weight:bold" name="newiow__0_rateanal__1_resdes__9" id="newiow__0_rateanal__1_resdes__9"></td>
            <input type="hidden" name="newiow__0_rateanal__1_rowrefid__9" value = "" id="newiow__0_rateanal__1_rowrefid__9">
            <input type="hidden" name="newiow__0_rateanal__1_type__9" value = "H" id="newiow__0_rateanal__1_type__9">
            <input type="hidden" name="newiow__0_rateanal__1_refid__9" value = "<?php echo $j; ?>" id="newiow__0_rateanal__1_refid__9">
        </tr>
        <tr id="newiow__0_rateanalR__1_header__9">
            <td colspan="12"><input type="text" class="parent_text" style="font-weight:bold" name="newiow__0_rateanal__1_resdes__9" id="newiow__0_rateanal__1_resdes__9"></td>
            <input type="hidden" name="newiow__0_rateanalR__1_rowrefid__9" value = "" id="newiow__0_rateanalR__1_rowrefid__9">
            <input type="hidden" name="newiow__0_rateanalR__1_type__9" value = "H" id="newiow__0_rateanalR__1_type__9">
            <input type="hidden" name="newiow__0_rateanalR__1_refid__9" value = "<?php echo $j; ?>" id="newiow__0_rateanalR__1_refid__9">
        </tr>
        </tbody>
    </table>
</div>
<div id="dummytableheader" style="display: none">
    <table class="table newIOWs" style=" margin-bottom:0px; display: none;" id="newIOW__1">
        <thead>
        <tr>
            <input type="hidden" name="newiow__1_rowid" id="newiow__1_rowid" value="1">
            <th>Parent</th>
            <th>Ref no</th>
            <th>S-No</th>
            <th>Unit</th>
            <th>Rate</th>
            <th>Qty</th>
            <th>Amount</th>
            <th class="text-center">Action</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<div id="dummy" style="display: none">
<table id="dummytable">
<tbody>
<tr id="newiow__0_irowid__1">
    <td width="11%"><input type="text" class="parent_text" name="newiow__0_parentid__1" id="newiow__0_parentid__1" onblur="return CheckParentValid(this.id)"></td>
    <td width="3%"><input class="parent_text" type="text" name="newiow__0_refserialno__1" id="newiow__0_refserialno__1" onchange="return SerialUpdate(this.id)"></td>
    <td width="3%"><input class="parent_text" type="text" name="newiow__0_serialno__1" id="newiow__0_serialno__1" readonly></td>
    <td width="5%"><input type="text" class="parent_text" name="newiow__0_unitid__1" id="newiow__0_unitid__1" onblur="return CheckUnitValid(this.id)" ></td>
    <td width="5%"><input class="parent_text text-right" type="text" name="newiow__0_rate__1" id="newiow__0_rate__1" align="right" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)" readonly></td>
    <td width="5%"><input class="parent_text text-right" type="text" name="newiow__0_qty__1" id="newiow__0_qty__1" align="right" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)" onchange="return rateUpdate(this.id)"></td>
    <td width="5%"><input class="parent_text text-right" type="text" name="newiow__0_amt__1" id="newiow__0_amt__1" align="right" onblur="return FormatNum(this, 2)" onfocus="return clickbut(this.id)" onkeypress="return isDecimal(event,this)" readonly></td>
    <input type="hidden" name="newiow__0_unitkeyid__1" id="newiow__0_unitkeyid__1">
    <input type="hidden" name="newiow__0_parentkeyid__1" id="newiow__0_parentkeyid__1">
    <input type="hidden" name="newiow__0_rowrefid__1" value = "1" id="newiow__0_rowrefid__1">
    <input type="hidden" name="newiow__0_type__1" id="newiow__0_type__1">
    <td width="4%" align="center">
        <ul class="action_btns">
            <li>
                <a href="javascript: DeleteTRFn('#newiow__0_mainTrDelete__1');" id="newiow__0_mainTrDelete__1"><i class="fa fa-trash" data-toggle="tooltip" data-placement="top" data-original-title="Delete" ></i></a>
            </li>

            <li>
                <a href="#" class="newiow__0_mainTr__1"><i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="top" data-original-title="Expand" ></i></a>
            </li>
        </ul>
    </td>
</tr>
<!--expand table-->
<tr style="display:none;" class="subTr__1 paintTr">
<td colspan="12" style="padding:0px !important; "><div class="subDiv" style="display:none;">
<div class="rdbt" style="margin-top:5px;">
    <div class="short_spc">
        <ul>
            <li class="col-lg-3 col-lg-offset-0 col-md-3 col-md-offset-0 col-sm-3 col-sm-offset-0" style="padding-left:2px !important; padding-right:2px !important;">
                <label class="spl_siz">Specification</label>
                <textarea class="parent_texts expand" name="newiow__0_spec__1" id="newiow__0_spec__1" ></textarea>
            </li>
            <li class="col-lg-3 col-lg-offset-0 col-md-3 col-md-offset-0 col-sm-3 col-sm-offset-0" style="padding-left:2px !important; padding-right:2px !important;">
                <label class="spl_siz">Short Specification</label>
                <textarea class="parent_texts" name="newiow__0_shortspec__1" id="newiow__0_shortspec__1"></textarea>
            </li>
            <li class="col-lg-2 col-lg-offset-0 col-md-2 col-md-offset-0 col-sm-2 col-sm-offset-0" style="padding-left:2px !important; padding-right:2px !important;">
                <label class="spl_siz">Project WorkGroup</label>
                <input type="text" name="newiow__0_workgroupname__1" id="newiow__0_workgroupname__1"/>
                <input type="hidden" name="newiow__0_workgroupid__1" id="newiow__0_workgroupid__1"/>
            </li>
            <li class="col-lg-2 col-lg-offset-0 col-md-2 col-md-offset-0 col-sm-2 col-sm-offset-0" style="padding-left:2px !important; padding-right:2px !important;">
                <label class="spl_siz">Site Mix (%)</label>
                <input type="text" name="newiow__0_sitemixper__1" id="newiow__0_sitemixper__1" onchange="MixRateUpdate(this.id)" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)"/>
            </li>
            <li class="col-lg-2 col-lg-offset-0 col-md-2 col-md-offset-0 col-sm-2 col-sm-offset-0" style="padding-left:2px !important; padding-right:2px !important;">
                <label class="spl_siz">Ready Mix (%)</label>
                <input type="text" name="newiow__0_readymixper__1" id="newiow__0_readymixper__1" onchange="MixRateUpdate(this.id)" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)"/>
            </li>
        </ul>
    </div>
    <!-- Nav tabs -->
    <div class="darkmenu" id="newiow__0_mixtab__1">
        <ul>
            <li class="active"><a href="#" name="newiow__0_analtype__1" id="newiow__0_analtype__1" onclick="showmix('sitemix',this.id,event)"><i class="fa fa-angle-double-right"></i> Sitemix</a></li>
            <li><a href="#" name="newiow__0_analtypeR__1" id="newiow__0_analtypeR__1" onclick="showmix('readymix',this.id,event)"><i class="fa fa-angle-double-right"></i> Readymix</a></li>
        </ul>
    </div>
    <!-- Tab panes -->
    <div class="lstate">
        <ul  id="newiow__0_raworktable__1">
            <li>
                <label class="lbl_style">Working Qty</label>
                <input type="text" class="col-lg-2 parent_texters text-right" name="newiow__0_rateanal__1_AnalQty" id="newiow__0_rateanal__1_AnalQty" title="Working Qty" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)"/>
            </li>
            <li id="newiow__0_rateanal_1AQty_li">
                <label>Cement</label>
                <input type="text" class="col-lg-2 parent_texters text-right" name="newiow__0_rateanal__1_AQty" id="newiow__0_rateanal__1_AQty" title="Cement (A)" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)"/>
            </li>
            <li id="newiow__0_rateanal_1BQty_li">
                <label>Sand</label>
                <input type="text" class="col-lg-2 parent_texters text-right" name="newiow__0_rateanal__1_BQty" id="newiow__0_rateanal__1_BQty" title="Sand (B)" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)"/>
            </li>
            <li id="newiow__0_rateanal_1CQty_li">
                <label>Metal</label>
                <input type="text" class="col-lg-2 parent_texters text-right" name="newiow__0_rateanal__1_CQty" id="newiow__0_rateanal__1_CQty" title="Metal (C)" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)"/>
            </li>
            <li id="newiow__0_rateanal_1thick_li">
                <label>Thickness (mm)</label>
                <input type="text" class="col-lg-2 parent_texters text-right" name="newiow__0_rateanal__1_thick" id="newiow__0_rateanal__1_thick" title="Thickness (mm) (T)" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)"/>
            </li>
        </ul>
        <ul  style="display: none;" id="newiow__0_raworkRtable__1">
            <li>
                <label class="lbl_style">Working Qty</label>
                <input type="text" class="col-lg-2 parent_texters text-right" name="newiow__0_rateanalR__1_AnalQty" id="newiow__0_rateanalR__1_AnalQty" title="Working Qty" onkeypress="return isDecimal(event,this)"/>
            </li>
        </ul>
    </div>
</div>
<div class="col-lg-12">
    <div class="table-responsive topsp"  style="overflow: visible;">
        <!-- Sitemix tabs -->
        <table class="table" style="margin-bottom:0px;" id="newiow__0_rateanal__1_restable">
            <thead>
            <tr>
                <th class="bg_clo">Inc / Exc</th>
                <th class="bg_clo">Ref no</th>
                <th class="bg_clo">Resource</th>
                <th class="bg_clo">Coefficient</th>
                <th class="bg_clo">Unit</th>
                <th class="bg_clo">Rate</th>
                <th class="bg_clo">Amount</th>
                <th class="bg_clo text-center">Action</th>
            </tr>
            </thead>
            <tbody class="sorting">
            <tr id="newiow__0_rateanal__1_RowId__9">
                <td width="1%" style="padding: 10px 0 10px 16px !important;"><label>
                        <input type="checkbox" name="newiow__0_rateanal__1_inc__9" value = <?php echo true; ?> id="newiow__0_rateanal__1_inc__9" checked class="ios_checkbox"/>
                        <div class="ios_switch"><span></span></div>
                    </label></td>
                <td width="3%"><label for ="newiow__0_rateanal__1_ref__9" > R1 </label></td>
                <td width="15%"><input class="parent_text" name="newiow__0_rateanal__1_resid__9"  id="newiow__0_rateanal__1_resid__9" onfocus="return checkResource(this.id,'')" onblur="return CheckResValid(this.id)"/></td>
                <td width="3%"><input class="parent_text text-right" type="text" name="newiow__0_rateanal__1_resqty__9" id="newiow__0_rateanal__1_resqty__9" align="right" onfocus="return showformula(this.id)" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" onkeydown="return showF(this.id,event)" onchange="return ValueChange(this.id)"/></td>
                <td width="5%"><label for ="newiow__0_rateanal__1_resunit__9" ></label></td>
                <td width="5%"><input class="parent_text text-right" type="text" name="newiow__0_rateanal__1_resrate__9"  id="newiow__0_rateanal__1_resrate__9" align="right"  onfocus="return showAnalysis(this.id)" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 2)" onchange="return ValueChange(this.id)"/></td>
                <td width="8%"><input class="parent_text text-right" type="text" name="newiow__0_rateanal__1_resamt__9"  id="newiow__0_rateanal__1_resamt__9" align="right"  readonly onkeypress="return isDecimal(event,this)"/></td>
                <td width="3%" align="center"><a href="#"  name="newiow__0_rateanal__1_resdel__9" id="newiow__0_rateanal__1_resdel__9" onclick="javascript:DeleteResource(this.id,event)"><i class="fa fa-trash-o ctlss" data-toggle="tooltip" data-placement="top" data-original-title="Add new"></i></a></td>
                <input type="hidden" name="newiow__0_rateanal__1_reskeyid__9" id="newiow__0_rateanal__1_reskeyid__9">
                <input type="hidden" name="newiow__0_rateanal__1_iowkeyid__9" id="newiow__0_rateanal__1_iowkeyid__9">
                <input type="hidden" name="newiow__0_rateanal__1_formula__9" id="newiow__0_rateanal__1_formula__9">
                <input type="hidden" name="newiow__0_rateanal__1_rowrefid__9" value = "1" id="newiow__0_rateanal__1_rowrefid__9">
                <input type="hidden" name="newiow__0_rateanal__1_type__9" id="newiow__0_rateanal__1_type__9">
                <input type="hidden" name="newiow__0_rateanal__1_refid__9" value = "1" id="newiow__0_rateanal__1_refid__9">
                <input type="hidden" name="newiow__0_rateanal__1_restypeid__9"  id="newiow__0_rateanal__1_restypeid__9">
                <input type="hidden" name="newiow__0_rateanal__1_ratetype__9"  id="newiow__0_rateanal__1_ratetype__9">
            </tr>
            </tbody>
            <tbody class="total" style="border: none;">
            <tr style="border-bottom:none;">
                <td style="border-right:none;"></td>
                <td style="border-right:none;"></td>
                <td style="border-right:none;"></td>
                <td style="border-right:none;"></td>
                <td style="border-right:none;"></td>
                <td style="border-right:none;" align="right" class="rate_pri">Rate for</td>
                <td style="border-right:none;"><input class="parent_text text-right" type="text" placeholder="00.0" name="newiow__0_rateanal__1_totrate" id="newiow__0_rateanal__1_totrate" align="right" readonly/></td>
                <td style="border-right:none;">&nbsp;</td>
            </tr>
            <tr style="border-bottom:none;">
                <td style="border-right:none; border-top:none;"></td>
                <td style="border-right:none;border-top:none;"></td>
                <td style="border-right:none;border-top:none;"></td>
                <td style="border-right:none;border-top:none;"></td>
                <td style="border-right:none;border-top:none;"></td>
                <td style="border-right:none;border-top:none;" align="right" class="rate_pri">Rate per</td>
                <td style="border-right:none;border-top:none;"><input class="parent_text text-right" type="text" placeholder="00.0" name="newiow__0_rateanal__1_perrate" id="newiow__0_rateanal__1_perrate" align="right" readonly/></td>
                <td style="border-right:none;border-top:none;">&nbsp;</td>
            </tr>
            <tr style="border-bottom:none;">
                <td style="border-right:none; border-top:none;"></td>
                <td style="border-right:none;border-top:none;"></td>
                <td style="border-right:none;border-top:none;"></td>
                <td style="border-right:none;border-top:none;"></td>
                <td style="border-right:none;border-top:none;"></td>
                <td style="border-right:none;border-top:none;" align="right" class="rate_pri">Net rate</td>
                <td style="border-right:none;border-top:none;"><input class="parent_text text-right" type="text" placeholder="00.0" name="newiow__0_rateanal__1_netrate" id="newiow__0_rateanal__1_netrate" align="right" readonly/></td>
                <td style="border-right:none;border-top:none;">&nbsp;</td>
            </tr>
            </tbody>
        </table>
        <input type="hidden" name="newiow__0_rowinfoid__1" id="newiow__0_rowinfoid__1" value="1">
        <!-- Readymix tabs -->
        <table class="table" style="display: none;margin-bottom:0px;" id="newiow__0_rateanalR__1_restable">
            <thead>
            <tr>
                <th class="bg_clo">Inc / Exc</th>
                <th class="bg_clo">Ref no</th>
                <th class="bg_clo">Resource</th>
                <th class="bg_clo">Coefficient</th>
                <th class="bg_clo">Unit</th>
                <th class="bg_clo">Rate</th>
                <th class="bg_clo">Amount</th>
                <th class="bg_clo text-center">Action</th>
            </tr>
            </thead>
            <tbody class="sorting">
            <tr id="newiow__0_rateanalR__1_RowId__9">
                <td width="1%" style="padding: 10px 0 10px 16px !important;"><label>
                        <input type="checkbox" name="newiow__0_rateanalR__1_inc__9" value = "<?php echo true; ?>" id="newiow__0_rateanalR__1_inc__9" checked class="ios_checkbox"/>
                        <div class="ios_switch"><span></span></div>
                    </label></td>
                <td width="3%"><label for ="newiow__0_rateanalR__1_rowrefid__9" > R1 </label></td>
                <td width="15%"><input class="parent_text" name="newiow__0_rateanalR__1_resid__9" id="newiow__0_rateanalR__1_resid__9" onfocus="return checkResource(this.id,'R')" onblur="return CheckResValid(this.id)"/></td>
                <td width="3%"><input class="parent_text text-right" type="text" name="newiow__0_rateanalR__1_resqty__9" id="newiow__0_rateanalR__1_resqty__9" align="right" onblur="return FormatNum(this, 3)" onfocus="return showformulaR(this.id)" onkeypress="return isDecimal(event,this)" onkeydown="return showFR(this.id,event)" onchange="return ValueChange(this.id)"/></td>
                <td width="5%"><label for ="newiow__0_rateanalR__1_resunit__9"></label></td>
                <td width="5%"><input class="parent_text text-right" type="text" name="newiow__0_rateanalR__1_resrate__9"  id="newiow__0_rateanalR__1_resrate__9" align="right"  onfocus="return showAnalysis(this.id,'R')" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)" onchange="return ValueChange(this.id)"/></td>
                <td width="8%"><input class="parent_text text-right" type="text" name="newiow__0_rateanalR__1_resamt__9" id="newiow__0_rateanalR__1_resamt__9" align="right"  readonly onkeypress="return isDecimal(event,this)"/></td>
                <td width="3%" align="center"><a href="#" name="newiow__0_rateanalR__1_resdel__9" id="newiow__0_rateanalR__1_resdel__9" onclick="javascript:DeleteResourceR(this.id, event)"><i class="fa fa-trash-o ctlss" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i></a></td>
                <input type="hidden" name="newiow__0_rateanalR__1_reskeyid__9" id="newiow__0_rateanalR__1_reskeyid__9">
                <input type="hidden" name="newiow__0_rateanalR__1_iowkeyid__9" id="newiow__0_rateanalR__1_iowkeyid__9">
                <input type="hidden" name="newiow__0_rateanalR__1_formula__9" id="newiow__0_rateanalR__1_formula__9">
                <input type="hidden" name="newiow__0_rateanalR__1_rowrefid__9" value = "1" id="newiow__0_rateanalR__1_rowrefid__9">
                <input type="hidden" name="newiow__0_rateanalR__1_type__9" id="newiow__0_rateanalR__1_type__9">
                <input type="hidden" name="newiow__0_rateanalR__1_refid__9" value = "1" id="newiow__0_rateanalR__1_refid__9">
                <input type="hidden" name="newiow__0_rateanalR__1_restypeid__9" id="newiow__0_rateanalR__1_restypeid__9">
                <input type="hidden" name="newiow__0_rateanalR__1_ratetype__9"  id="newiow__0_rateanalR__1_ratetype__9">
            </tr>
            </tbody>
            <tbody class="total" style="border: none;">
            <tr style="border-bottom:none;">
                <td style="border-right:none;"></td>
                <td style="border-right:none;"></td>
                <td style="border-right:none;"></td>
                <td style="border-right:none;"></td>
                <td style="border-right:none;"></td>
                <td style="border-right:none;" align="right" class="rate_pri">Rate for</td>
                <td style="border-right:none;"><input class="parent_text text-right" type="text" placeholder="00.0" name="newiow__0_rateanalR__1_totrate" id="newiow__0_rateanalR__1_totrate" align="right" readonly/></td>
                <td style="border-right:none;">&nbsp;</td>
            </tr>
            <tr style="border-bottom:none;">
                <td style="border-right:none; border-top:none;"></td>
                <td style="border-right:none;border-top:none;"></td>
                <td style="border-right:none;border-top:none;"></td>
                <td style="border-right:none;border-top:none;"></td>
                <td style="border-right:none;border-top:none;"></td>
                <td style="border-right:none;border-top:none;" align="right" class="rate_pri">Rate per</td>
                <td style="border-right:none;border-top:none;"><input class="parent_text text-right" type="text" placeholder="00.0" name="newiow__0_rateanalR__1_perrate" id="newiow__0_rateanalR__1_perrate" align="right" readonly/></td>
                <td style="border-right:none;border-top:none;">&nbsp;</td>
            </tr>
            <tr style="border-bottom:none;">
                <td style="border-right:none; border-top:none;"></td>
                <td style="border-right:none;border-top:none;"></td>
                <td style="border-right:none;border-top:none;"></td>
                <td style="border-right:none;border-top:none;"></td>
                <td style="border-right:none;border-top:none;"></td>
                <td style="border-right:none;border-top:none;" align="right" class="rate_pri">Net rate</td>
                <td style="border-right:none;border-top:none;"><input class="parent_text text-right" type="text" placeholder="00.0" name="newiow__0_rateanalR__1_netrate" id="newiow__0_rateanalR__1_netrate" align="right" readonly/></td>
                <td style="border-right:none;border-top:none;">&nbsp;</td>
            </tr>
            </tbody>
        </table>
        <input type="hidden" name="newiow__0_rowinfoidR__1" id="newiow__0_rowinfoidR__1" value="1">
    </div>
</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div id="dummyactivity" style="display: none">
    <div class="darkmenu">
        <ul>
            <li class="active"><a href="#" name="analtypeM" id="analtype" onclick="showAnalmix('manual',this.id, event)"><i class="fa fa-angle-double-right"></i> Manual</a></li>
            <li><a href="#" name="analtype" id="analtypeA" onclick="showAnalmix('machinery',this.id, event)"><i class="fa fa-angle-double-right"></i> Machinery</a></li>
        </ul>
        <div class="lstate manual_mac">
            <ul>
                <li>
                    <label >LS Rate</label>
                    <input class="parent_text text-right" type="text" name="analrateL" id="analrateLS" title="LS Rate" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)" readonly/>
                </li>
                <li>
                    <label>Manual Rate</label>
                    <input class="parent_text text-right" type="text" name="analrateM" id="analrateM" onkeypress="return isDecimal(event,this)" readonly/>
                </li>
                <li>
                    <label>Machinery Rate</label>
                    <input class="parent_text text-right" type="text" name="analrateA" id="analrateA" onkeypress="return isDecimal(event,this)" readonly/>
                </li>
                <li>
                    <label>Rate Type</label>
                    <div class="select-style select-inline">
                        <select name="analrate" id ="analrate"  onchange="return MainRateUpdate(this)">
                            <option value="L" >LS </option>
                            <option value="M" >Manual </option>
                            <option value="A" >Machinery </option>
                        </select>
                    </div>
                </li>
            </ul>
        </div>
    </div>
    <div class="col-lg-12 clear" id="activitymanual" >
        <label class="lbl_style">Working Qty</label>
        <input type="text" class="parent_texters work_qt text-right" name="activityAnalQty" id="activityAnalQty" onkeypress="return isDecimal(event,this)" readonly>
    </div>
    <div class="col-lg-12" id="activitymachinery" style="display: none;">
        <label class="lbl_style">Working Qty</label>
        <input type="text" class="parent_texters work_qt text-right"  name="activityRAnalQty" id="activityRAnalQty" onkeypress="return isDecimal(event,this)" readonly>
    </div>
    <div class="col-lg-12">
        <div class="table-responsive topsp animated-panel zoomIn" style="overflow: visible;animation-delay: 0.2s;">
            <!-- Manual tabs -->
            <table class="table" style="margin-bottom:0px;" id="activityrestable">
                <thead>
                <tr>
                    <th class="bg_clo_subTr">Resource name</th>
                    <th class="bg_clo_subTr">Unit</th>
                    <th class="bg_clo_subTr">Qty</th>
                    <th class="bg_clo_subTr">Rate</th>
                    <th class="bg_clo_subTr">Amount</th>
                </tr>
                </thead>
                <tbody >
                <tr id="activityRowId_1">
                    <td width="25%"><input type="text" class="parent_text" name="activityresid_1" id ="activityresid_1" readonly ></td>
                    <td width="5%"><input type="text" class="parent_text" name="activityresunit_1" id="activityresunit_1" readonly></td>
                    <td width="5%"><input type="text" class="parent_text text-right" name="activityresqty_1" id="activityresqty_1" align="right" readonly ></td>
                    <td width="5%"><input type="text" class="parent_text text-right" name="activityresrate_1" id="activityresrate_1" align="right"  readonly></td>
                    <td width="8%"><input type="text" class="parent_text text-right" name="activityresamt_1" id="activityresamt_1" align="right" readonly ></td>
                    <input type="hidden" name="activityformula_1" value = "" id="activityformula_1">
                </tr>
                <tr style="border-bottom:none;">
                    <td style="border-right:none;"></td>
                    <td style="border-right:none;"></td>
                    <td style="border-right:none;"></td>
                    <td style="border-right:none;" align="right" class="rate_pri">Total</td>
                    <td style="border-right:none;"><input class="parent_text text-right" type="text" placeholder="00.0" name="activitytotrate" id="activitytotrate" align="right" readonly/></td>
                </tr>
                <tr style="border-bottom:none;">
                    <td style="border-right:none;border-top:none;"></td>
                    <td style="border-right:none;border-top:none;"></td>
                    <td style="border-right:none;border-top:none;"></td>
                    <td style="border-right:none;border-top:none;" align="right" class="rate_pri">Rate Per Unit</td>
                    <td style="border-right:none;border-top:none;"><input class="parent_text text-right" type="text" placeholder="00.0" name="activityperrate" id="activityperrate" align="right" readonly/></td>
                </tr>
                </tbody>
            </table>
            <input type="hidden" name="arowinfoid" id="arowinfoid" value="1">
            <!-- Machinery tabs -->
            <table class="table" style="display: none;margin-bottom:0px;" id="activityRrestable">
                <thead>
                <tr>
                    <th class="bg_clo_subTr">Resource name</th>
                    <th class="bg_clo_subTr">Unit</th>
                    <th class="bg_clo_subTr">Qty</th>
                    <th class="bg_clo_subTr">Rate</th>
                    <th class="bg_clo_subTr">Amount</th>
                </tr>
                </thead>
                <tbody >
                <tr id="activityRRowId_1">
                    <td width="25%"><input type="text" class="parent_text" name="activityRresid_1" id ="activityRresid_1" readonly ></td>
                    <td width="8%"><input type="text" class="parent_text" name="activityRresunit_1" id="activityRresunit_1" readonly></td>
                    <td width="5%"><input type="text" class="parent_text text-right" name="activityRresqty_1" id="activityRresqty_1"  align="right" readonly></td>
                    <td width="5%"><input type="text" class="parent_text text-right" name="activityRresrate_1" id="activityRresrate_1" align="right" readonly></td>
                    <td width="12%"><input type="text" class="parent_text text-right" name="activityRresamt_1" id="activityRresamt_1" align="right" readonly></td>
                    <input type="hidden" name="activityRformula_1" value = "" id="activityRformula_1">
                </tr>
                <tr style="border-bottom:none;">
                    <td style="border-right:none;"></td>
                    <td style="border-right:none;"></td>
                    <td style="border-right:none;"></td>
                    <td style="border-right:none;  color:#1d99d4; vertical-align: middle; " align="right">Total</td>
                    <td style="border-right:none;"><input class="parent_text text-right" type="text" placeholder="00.0" name="activityRtotrate" id="activityRtotrate" align="right" onkeypress="return isDecimal(event,this)" readonly/></td>

                </tr>
                <tr style="border-bottom:none;">
                    <td style="border-right:none;border-top:none;"></td>
                    <td style="border-right:none;border-top:none;"></td>
                    <td style="border-right:none;border-top:none;"></td>
                    <td style="border-right:none;border-top:none;" align="right" class="rate_pri">Rate Per Unit</td>
                    <td style="border-right:none;border-top:none;"><input class="parent_text text-right" type="text" placeholder="00.0" name="activityRperrate" id="activityRperrate" align="right" onkeypress="return isDecimal(event,this)" readonly/></td>
                </tr>
                </tbody>
            </table>
            <input type="hidden" name="arowinfoidR" id="arowinfoidR" value="1">
        </div>
    </div>
</div>
<div id="dummysubiow" style="display: none">
    <tr class="subiow_1">
        <td width="100%"><div class="col-lg-12 col-lg-offset-0" style="margin-top:5px;">
                <!-- Nav tabs -->
                <div class="darkmenu">
                    <ul>
                        <li class="active"><a href="#" name="sanaltypeS" id="sanaltype" onclick="showSubIOWMix('sitemix',this, event)"><i class="fa fa-angle-double-right"></i> Sitemix</a></li>
                        <li><a href="#" name="sanaltype" id="sanaltypeR" onclick="showSubIOWMix('readymix',this, event)"><i class="fa fa-angle-double-right"></i> Readymix</a></li>
                    </ul>
                    <div class="manual_seletc">
                        <label>Rate Type</label>
                        <div class="select-style select-inline">
                            <select name="analrate" id ="analrate" onchange="return MainRateUpdate(this)">
                                <option value="">Default Rate Type</option>
                                <option value="S" >SiteMix </option>
                                <option value="R" >ReadyMix </option>
                            </select>
                        </div>
                    </div>
                </div>
                <!-- Tab panes -->
                <div class="lstate">
                    <ul  id="sraworktable">
                        <li>
                            <label class="lbl_style">Working Qty</label>
                            <input type="text" class="col-lg-2 parent_texters text-right" name="srateanalAnalQty" id="srateanalAnalQty" title="Working Qty" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)"/>
                        </li>
                        <li>
                            <label>Cement</label>
                            <input type="text" class="col-lg-2 parent_texters text-right" name="srateanalAQty" id="srateanalAQty" title="Cement (A)" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)"/>
                        </li>
                        <li>
                            <label>Sand</label>
                            <input type="text" class="col-lg-2 parent_texters text-right" name="srateanalBQty" id="srateanalBQty" title="Sand (B)" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)"/>
                        </li>
                        <li>
                            <label>Metal</label>
                            <input type="text" class="col-lg-2 parent_texters text-right" name="srateanalCQty" id="srateanalCQty" title="Metal (C)" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)"/>
                        </li>
                        <li>
                            <label>Thickness (mm)</label>
                            <input type="text" class="col-lg-2 parent_texters text-right" name="srateanalthick" id="srateanalthick" title="Thickness (mm) (T)" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)"/>
                        </li>
                    </ul>
                    <ul  style="display: none;" id="sraworkRtable">
                        <li>
                            <label class="lbl_style">Working Qty</label>
                            <input type="text" class="col-lg-2 parent_texters text-right" name="srateanalRAnalQty" id="srateanalRAnalQty" title="Working Qty" onkeypress="return isDecimal(event,this)"/>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-lg-12">
                <div class="table-responsive topsp animated-panel zoomIn" style="overflow: visible;">
                    <!-- Sitemix tabs -->
                    <table class="table" style="margin-bottom:0px;" id="srateanalrestable">
                        <thead>
                        <tr>
                            <th class="bg_clo_subTr">Inc / Exc</th>
                            <th class="bg_clo_subTr">Ref no</th>
                            <th class="bg_clo_subTr">Resource</th>
                            <th class="bg_clo_subTr">Coefficient</th>
                            <th class="bg_clo_subTr">Unit</th>
                            <th class="bg_clo_subTr">Rate</th>
                            <th class="bg_clo_subTr">Amount</th>
                            <th class="bg_clo_subTr text-center">Action</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr id="srateanalRowId_1">
                            <td width="1%" style="padding: 10px 0 10px 16px !important;">
                            <label>
                              <input type="checkbox" name="srateanalinc_1" value = <?php echo true; ?> id="srateanalinc_1" checked class="ios_checkbox"/>
                              <div class="ios_switch"><span></span></div>
                                </label></td>
                            <td width="3%"><label for ="srateanalref_1">R1</label></td>
                            <td width="15%"><input class="parent_text" name="srateanalresid_1" id ="rateanalresid_1" onblur="return CheckResValid(this.id)"/></td>
                            <td width="3%"><input class="parent_text text-right" type="text" name="srateanalresqty_1" value = "" id="srateanalresqty_1" align="right" onfocus="return showformula(this.id)" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this)" onkeydown="return showF(this.id,event)" onchange="return ValueChange(this.id)"/></td>
                            <td width="5%"><label for ="srateanalresunit_1" ></label></td>
                            <td width="5%"><input class="parent_text text-right" type="text" name="srateanalresrate_1" id="srateanal_<?php echo $i;?>resrate_1" align="right"  onfocus="return showAnalysis(this.id)" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 2)" onchange="return ValueChange(this.id)"/></td>
                            <td width="8%"><input class="parent_text text-right" type="text" name="srateanalresamt_1" id="srateanalresamt_1" align="right"  readonly onkeypress="return isDecimal(event,this)"/></td>
                            <td width="3%"<a href="#" name="srateanal_1resdel_1" id="srateanal_1resdel_1" onclick="javascript:DeleteResource(this.id,event)"><i class="fa fa-trash-o ctlss" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i></a></td>
                            <input type="hidden" name="srateanalformula_1" value = "" id="srateanalformula_1">
                            <input type="hidden" name="srateanalrowrefid_1" value = "" id="srateanalrowrefid_1">
                            <input type="hidden" name="srateanaltype_1" value = "R" id="srateanaltype_1">
                            <input type="hidden" name="srateanalrefid_1" value = "1" id="srateanalrefid_1">
                            <input type="hidden" name="srateanalrestypeid_1" value = "" id="srateanalrestypeid_1">
                        </tr>
                        <tr style="border-bottom:none;">
                            <td style="border-right:none;"></td>
                            <td style="border-right:none;"></td>
                            <td style="border-right:none;"></td>
                            <td style="border-right:none;"></td>
                            <td style="border-right:none;"></td>
                            <td style="border-right:none;" align="right" class="rate_pri">Rate for</td>
                            <td style="border-right:none;"><input class="parent_text text-right" type="text" placeholder="00.0" name="srateanaltotrate" id="srateanaltotrate" align="right" readonly/></td>
                            <td style="border-right:none;">&nbsp;</td>
                        </tr>
                        <tr style="border-bottom:none;">
                            <td style="border-right:none; border-top:none;"></td>
                            <td style="border-right:none;border-top:none;"></td>
                            <td style="border-right:none;border-top:none;"></td>
                            <td style="border-right:none;border-top:none;"></td>
                            <td style="border-right:none;border-top:none;"></td>
                            <td style="border-right:none;border-top:none;" align="right" class="rate_pri">Rate per</td>
                            <td style="border-right:none;border-top:none;"><input class="parent_text text-right" type="text" placeholder="00.0" name="srateanalperrate" id="srateanalperrate" align="right" readonly/></td>
                            <td style="border-right:none;border-top:none;">&nbsp;</td>
                        </tr>
                        <tr style="border-bottom:none;">
                            <td style="border-right:none; border-top:none;"></td>
                            <td style="border-right:none;border-top:none;"></td>
                            <td style="border-right:none;border-top:none;"></td>
                            <td style="border-right:none;border-top:none;"></td>
                            <td style="border-right:none;border-top:none;"></td>
                            <td style="border-right:none;border-top:none;" align="right" class="rate_pri">Net rate</td>
                            <td style="border-right:none;border-top:none;"><input class="parent_text text-right" type="text" placeholder="00.0" name="srateanalnetrate" id="srateanalnetrate" align="right" readonly/></td>
                            <td style="border-right:none;border-top:none;">&nbsp;</td>
                        </tr>
                        </tbody>
                    </table>
                    <input type="hidden" name="srowinfoid" id="srowinfoid" value="1">
                    <!-- Readymix tabs -->
                    <table class="table" style="display: none;margin-bottom:0px;"  id="srateanalRrestable">
                        <thead>
                        <tr>
                            <th class="bg_clo_subTr">Inc / Exc</th>
                            <th class="bg_clo_subTr">Ref no</th>
                            <th class="bg_clo_subTr">Resource</th>
                            <th class="bg_clo_subTr">Coefficient</th>
                            <th class="bg_clo_subTr">Unit</th>
                            <th class="bg_clo_subTr">Rate</th>
                            <th class="bg_clo_subTr">Amount</th>
                            <th class="bg_clo_subTr text-center">Action</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr id="srateanalRRowId_1">
                            <td width="1%" style="padding: 10px 0 10px 16px !important;"><label>
                                    <input type="checkbox" name="srateanalRinc_1" value = "<?php echo true; ?>" id="srateanalRinc_1" checked class="ios_checkbox"/>
                                    <div class="ios_switch"><span></span></div>
                                </label></td>
                            <td width="3%"><label for ="" >R1</label></td>
                            <td width="15%"><input class="parent_text" name="srateanalRresid_1" id ="rateanalRresid_1" onblur="return CheckResValid(this.id)"/></td>
                            <td width="3%"><input class="parent_text text-right" type="text" name="srateanalRresqty_1" id="srateanalRresqty_1" align="right" onblur="return FormatNum(this, 3)" onfocus="return showformulaR(this.id)" onkeypress="return isDecimal(event,this)" onkeydown="return showFR(this.id,event)" onchange="return ValueChange(this.id)"/></td>
                            <td width="5%"><label for ="srateanalRresunit_1"></label></td>
                            <td width="5%"><input class="parent_text text-right" type="text" name="srateanalRresrate_1" id="srateanalR_<?php echo $i;?>resrate_1" align="right"  onfocus="return showAnalysis(this.id,'R')" onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this)" onchange="return ValueChange(this.id)"/></td>
                            <td width="8%"><input class="parent_text text-right" type="text" name="srateanalRresamt_1" id="srateanalRresamt_1" align="right"  readonly onkeypress="return isDecimal(event,this)"/></td>
                            <td width="3%"<a href="#" name="srateanalR_1resdel_1" id="srateanalR_1resdel_1" onclick="javascript:DeleteResource(this.id,event)"><i class="fa fa-trash-o ctlss" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i></a></td>
                            <input type="hidden" name="srateanalRformula_1" value = "" id="srateanalRformula_1">
                            <input type="hidden" name="srateanalRrowrefid_1" value = "" id="srateanalRrowrefid_1">
                            <input type="hidden" name="srateanalRtype_1" value = "R" id="srateanalRtype_1">
                            <input type="hidden" name="srateanalRrefid_1" value = "1" id="srateanalRrefid_1">
                            <input type="hidden" name="srateanalRrestypeid_1" value = "" id="srateanalRrestypeid_1">
                        </tr>
                        <tr style="border-bottom:none;">
                            <td style="border-right:none;"></td>
                            <td style="border-right:none;"></td>
                            <td style="border-right:none;"></td>
                            <td style="border-right:none;"></td>
                            <td style="border-right:none;"></td>
                            <td style="border-right:none;" class="rate_pri" align="right">Rate for</td>
                            <td style="border-right:none;"><input class="parent_text text-right" type="text" placeholder="00.0" name="srateanalRtotrate" id="srateanalRtotrate" align="right" readonly/></td>
                            <td style="border-right:none;">&nbsp;</td>
                        </tr>
                        <tr style="border-bottom:none;">
                            <td style="border-right:none; border-top:none;"></td>
                            <td style="border-right:none;border-top:none;"></td>
                            <td style="border-right:none;border-top:none;"></td>
                            <td style="border-right:none;border-top:none;"></td>
                            <td style="border-right:none;border-top:none;"></td>
                            <td style="border-right:none;border-top:none;" align="right" class="rate_pri">Rate per</td>
                            <td style="border-right:none;border-top:none;"><input class="parent_text text-right" type="text" placeholder="00.0" name="srateanalRperrate"id="srateanalRperrate" align="right" readonly/></td>
                            <td style="border-right:none;border-top:none;">&nbsp;</td>
                        </tr>
                        <tr style="border-bottom:none;">
                            <td style="border-right:none; border-top:none;"></td>
                            <td style="border-right:none;border-top:none;"></td>
                            <td style="border-right:none;border-top:none;"></td>
                            <td style="border-right:none;border-top:none;"></td>
                            <td style="border-right:none;border-top:none;"></td>
                            <td style="border-right:none;border-top:none;" align="right" class="rate_pri">Net rate</td>
                            <td style="border-right:none;border-top:none;"><input class="parent_text text-right" type="text" placeholder="00.0" name="srateanalRnetrate" id="srateanalRnetrate" align="right" readonly/></td>
                            <td style="border-right:none;border-top:none;">&nbsp;</td>
                        </tr>
                        </tbody>
                    </table>
                    <input type="hidden" name="srowinfoidR" id="srowinfoidR" value="1">
                </div>
            </div></td>
    </tr>
</div>
<div id="resourcemodal" class="modal fade" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><i class="fa fa-times-circle-o clpot"></i></button>
                <h1>Resource</h1>
            </div>
            <div class="modal-body">
                <input type="hidden" name="resrowid" id="resrowid" >
                <div class="form-group">
                    <label style="margin-bottom: 10px;">Resource Name</label>
                    <input type="text" class="parent_text" name="resname" id="resname" >
                </div>
                <div class="form-group">
                    <label style="margin-bottom: 10px;">Resource Group</label>
                    <input type="text" class="parent_text" name="resgroup" id="resgroup" autocomplete="off">
                    <input type="hidden" name="resgroup_id" id="resgroup_id">
                </div>
                <div class="form-group">
                    <label style="margin-bottom: 10px;">Resource Type</label>
                    <input type="text" class="parent_text"  name="restype" id="restype" readonly>
                </div>
                <div class="form-group">
                    <label style="margin-bottom: 10px;">Unit</label>
                    <input type="text" class="parent_text" name="resunit" id="resunit" autocomplete="off">
                    <input type="hidden" name="resunit_id" id="resunit_id">
                </div>
                <div class="form-group">
                    <label style="margin-bottom: 10px;">Rate</label>
                    <input type="text" class="parent_text" name="resrate" id="resrate" onkeypress="return isDecimal(event,this)">
                    </td>
                    </tr>
                </div>
            </div>
            <div class="modal-footer">
                <a href="#" class="cancel_btn ripple has-ripple" data-dismiss="modal"  data-toggle="tooltip"  title="" data-original-title="Cancel" style="position: relative; overflow: hidden;">Cancel<span class="ripple-wrapper"></span><span class="ripple-wrapper"></span></a>
                <button type="button" class="md_ok" onclick="return ResourceUpdate()" data-dismiss="modal" data-toggle="tooltip" data-original-title="OK">OK</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    $('body').tooltip({
        selector: '.error'
    });
});
var iFocusRowId=1;
var iTransRowId=0;
var bSiteMix=true;
var sWGUpdateMode='Add';
var sResUpdateMode='Add';
var arrres = <?php echo (isset($reslist)) ? json_encode($reslist) : '[]';?>;
var arriowres = <?php echo (isset($resiowlist)) ? json_encode($resiowlist) : '[]';?>;
var arrayreslist1 = $.map(arrres, function (obj) { return {value: obj.value,id:obj.id,type:obj.type, data: { category: 'Resource' }}; });
var arrayreslist2 = $.map(arriowres, function (obj) { return {value: obj.value,id:obj.id,type:obj.type, data: { category: 'IOW' }}; });
var arrayreslist = arrayreslist1.concat(arrayreslist2);
var arrayres = arrayreslist;
var arrayresR = arrayreslist;
var arrayunitlist = <?php echo (isset($unit)) ? json_encode($unit) : '[]';?>;

var arryparentList = <?php echo (isset($parentiow)) ? json_encode($parentiow) : '[]';?>;
arryprojectiowList = <?php echo (isset($parentprojiow)) ? json_encode($parentprojiow) : '[]';?>;
sortedParentList = $.map(arryparentList, function (obj) { return {value: obj.value,id:obj.id,type:'L', data: { category: 'IOW Library' }}; }),
    sortedProjectiowList = $.map(arryprojectiowList, function (obj) { return {value: obj.value,id:obj.id,type:'P', data: { category: 'Project IOW' }}; }),
    arryparentList = sortedProjectiowList.concat(sortedParentList);

var arrayworktype = <?php echo (isset($worktype)) ? json_encode($worktype) : '[]';?>;
var arrayresgroup = <?php echo (isset($resgroup)) ? json_encode($resgroup) : '[]';?>;
var arrayprojworkgroup = <?php echo (isset($projectworkgroup)) ? json_encode($projectworkgroup) : '[]';?>;
var arrActivityAnal= [];
var arrActivityRes= [];
var arrSubIOW= [];
var arrSubIOWAnal= [];

// jqxTree script
var $jqxTree = $('#jqxTree'),
    $iowContent = $('#iow-content'),
    $newIOWRowId = $('#newIOWRowId'),
    dummyTableHeadHTML = $('#dummytableheader').html(),
    dummyTableHTML = $('#dummytable > tbody').html(),
    treePostData = [],
    arrIOWData = [],
    $form = $('#form');

$(function () {
    var proj_id = $('#project_id').val();
    if(proj_id != '' || proj_id != 0) {
        bindJqxTreeGrid(proj_id);
    }

    // iow scripts
    var $formulaExp = $("#formulaexp");
    $('#formula').on('shown.bs.modal', function () {
        $formulaExp.focus();
        $formulaExp.select();
    });

    $('#worktype').autocomplete({
        lookup: arrayworktype,
        multiselect:true,
        lookupFilter: function(suggestion, originalQuery, queryLowerCase) {
            if (queryLowerCase =='*') {
                return suggestion.value;
            }
            else {
                var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                return re.test(suggestion.value);
            }
        },
        onSelect: function(suggestion) {
            if(suggestion) {
                $("#worktype_id").val(suggestion.data);
                $(this).removeClass('error');
            }
        },
        onSearchStart: function(suggestion) {
            $("#worktype_id").val(0);
        },
        onSearchComplete: function (query, suggestions) {
            if(!suggestions.length){
                $(this).addClass('error');
                $("#worktype_id").val(0);
            } else
                $(this).removeClass('error');
        }
    });

    $('#resgroup').autocomplete({
        lookup: arrayresgroup,
        multiselect:true,
        lookupFilter: function(suggestion, originalQuery, queryLowerCase) {
            if (queryLowerCase =='*') {
                return suggestion.value;
            }
            else {
                var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                return re.test(suggestion.value);
            }
        },
        onSelect: function(suggestion) {
            if(suggestion) {
                $("#resgroup_id").val(suggestion.data);
                $('#restype').val(suggestion.TypeName);
                $(this).removeClass('error');
            }
        },
        onSearchStart: function(suggestion) {
            $("#resgroup_id").val(0);
        },
        onSearchComplete: function (query, suggestions) {
            if(!suggestions.length){
                $(this).addClass('error');
                $("#resgroup_id").val(0);
            } else
                $(this).removeClass('error');
        }
    });

    $('#resunit').autocomplete({
        lookup: arrayunitlist,
        multiselect:true,
        lookupFilter: function(suggestion, originalQuery, queryLowerCase) {
            if (queryLowerCase =='*') {
                return suggestion.value;
            }
            else {
                var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                return re.test(suggestion.value);
            }
        },
        onSelect: function(suggestion) {
            if(suggestion) {
                $("#resunit_id").val(suggestion.data);
                $(this).removeClass('error');
            }
        },
        onSearchStart: function(suggestion) {
            $("#resunit_id").val(0);
        },
        onSearchComplete: function (query, suggestions) {
            if(!suggestions.length){
                $(this).addClass('error');
                $("#resunit_id").val(0);
            } else
                $(this).removeClass('error');
        }
    });

    // modal forms on close
    $('#resourcemodal').on('hidden.bs.modal', function () {
        $(this).find('input').val('');
    });

    $('#workgroupmodal').on('hidden.bs.modal', function () {
        $(this).find('input[type=text]').val('');
        $(this).find('input[type=checkbox]').removeAttr('checked');
        $(this).find('input[type=radio]').removeAttr('checked');
    });

});

function bindJqxTreeGrid(proj_id) {
    var $jqxMenu = $('#jqxMenu'),
        url1 = getBaseURL() + 'project/rfc/getrfcwbslist/' + proj_id,
        source =
        {
            async: false,
            datatype: "json",
            editable:true,
            datafields: [
                { name: 'id' },
                { name: 'parentid' },
                { name: 'text' }
            ],
            id: 'id',
            url: url1
        };

    var dataAdapter = new $.jqx.dataAdapter(source);
    dataAdapter.dataBind();
    var records = dataAdapter.getRecordsHierarchy('id', 'parentid', 'items', [{ name: 'text', map: 'label'}]);

    $jqxTree.jqxTree({ source: records, height: 400, width: '100%', allowDrag: true, allowDrop: true, keyboardNavigation: true,
//        dragEnd: function (item, dropItem, args, dropPosition, tree) {
//            if (item.level != dropItem.level && item.parentId != dropItem.parentId)
//                return false;
//            oldParentId = item.parentId;
//            newParentId = dropItem.parentId;
        });

    $jqxTree.css('visibility', 'visible');
    var contextMenu = $jqxMenu.jqxMenu({ width: '150px',  height: '110px', autoOpenPopup: false, mode: 'popup' }),
        clickedItem = null,
        attachContextMenu = function () {
            // open the context menu when the user presses the mouse right button.
            $("#jqxTree li").on('mousedown', function (event) {
                var target = $(event.target).parents('li:first')[0],
                    rightClick = isRightClick(event),
                    $menu_newbs = $('#menu-newwbs'),
                    $menu_showiow = $('#menu-showiow'),
                    $menu_addiow = $('#menu-addiow');

                if (rightClick && target != null) {
                    $jqxTree.jqxTree('selectItem', target);
                    var selItem = $jqxTree.jqxTree('selectedItem'),
                        $window = $(window);

                    // check if is parent and hide add iow
                    if ($(selItem.element).find('ul').length > 0 || arrIOWData.indexOf(selItem.id) >= 0) {
                        $menu_newbs.show();
                        $menu_showiow.hide();
                        $menu_addiow.hide();
                        $jqxMenu.jqxMenu({height: '83px'});
                    } else {
                        $menu_newbs.show();
                        $menu_addiow.show();
                        $jqxMenu.jqxMenu({height: '110px'});
                    }

                    // check if has added iow and remove new wbs option
                    if (arrIOWData.indexOf(selItem.id) >= 0) {
                        $menu_newbs.hide();
                        $menu_showiow.show();
                        $menu_addiow.hide();
                    }

                    contextMenu.jqxMenu('open', parseInt(event.clientX) + 5 + $window.scrollLeft(), parseInt(event.clientY) + 5 + $window.scrollTop());
                    return false;
                }
            });
        };

    attachContextMenu();
    $jqxMenu.on('itemclick', function (event) {
        var item = $.trim($(event.args).text()),
            selectedItem = $jqxTree.jqxTree('selectedItem');
        if (selectedItem == null)
            return;

        switch (item) {
            case "Add WBS":
                $jqxTree.jqxTree('addTo', {label: 'Item'}, selectedItem.element);
                $jqxTree.jqxTree('expandItem', selectedItem.element);
                makeEditableContent(selectedItem.element, true);
                attachContextMenu();
                break;
            case "Edit WBS":
                makeEditableContent(selectedItem.element);
                break;
            case "Remove WBS":
                // check if has iow and with values
                var id = selectedItem.id,
                    index = arrIOWData.indexOf(id),
                    hasValues = checkIOWFieldsHasValues(id);
                if(index  != -1 && hasValues) {
                    alert('Sorry, This WBS cannot be deleted. Since you added a IOW for the same!');
                    return;
                }

                if (confirm('Do you want to Delete')) {
                    // remove other action
                    if(treePostData.length != 0) {
                        $.each(treePostData, function (i, o) {
                            if (o.id == id) {
                                treePostData.splice(i, 1);
                                delete treePostData.length;
                                return;
                            }
                        });
                    }

                    if(id.indexOf('jqxWidget') == -1) {
                        // push data to array
                        treePostData.push({
                            'id': id,
                            'parentid': selectedItem.parentId,
                            'name': selectedItem.label,
                            'action': 'delete'
                        });
                    }

                    $jqxTree.jqxTree('removeItem', selectedItem.element);

                    if(index  != -1 && hasValues == false) {
                        $("#newIOW_" + id).remove();
                        $iowContent.hide();
                        arrIOWData.splice(index,1);
                    }
                    attachContextMenu();
                }
                break;
            case "Add IOW":
                addNewIOW(selectedItem);
                break;
            case "Show IOW":
                showAddedIOW(selectedItem);
                break;
        }
    });

    $(document).on('contextmenu', function (e) {
        if ($(e.target).parents('.jqx-tree').length > 0)
            return false;

        return true;
    });

    $jqxTree.jqxTree('expandAll');
}

// jqxgrid functions start
function checkIOWFieldsHasValues(id) {
    var rowlength = $('#newiow_'+ id +'_rowid').val(),
        isValid = false;

    for (var i=1; i <= rowlength; i++) {
        if ($.trim($('tr#newiow_'+ id +'_irowid_'+ i +' input[type=text]').val()).length >= 1) {
            isValid = true;
            break;
        }
    }

    return isValid;
}

function makeEditableContent(item, isCreate) {
    var $div = $(item).find('> div'),
        oldValue = $div.html(),
        action = 'update',
        id = item.id,
        parentId = item.parentId;

    if (typeof isCreate != 'undefined' && isCreate  == true) {
        $div = $(item).find('> ul li:last-child > div');
        action = 'create';
        id = $div.parent('li').attr('id');
        parentId = item.id;
        item = $(item).find('> ul li:last-child')[0];
    }

    // check and remove old data in array
    var index = getObjectKeyIndex(treePostData, id);
    if (index != null) {
        treePostData.splice(index,1);
    }

    $jqxTree.jqxTree({ keyboardNavigation: false});
    $div.prop('contenteditable', true);
    $div.focus();
    $div.unbind('keydown');
    $div.on('keydown', function(e) {
        if (e.keyCode == 27) {
            $div.html(oldValue);
            $div.prop('contenteditable', false);
            $jqxTree.jqxTree({ keyboardNavigation: true});
        }

        if (e.keyCode == 13) {
            e.preventDefault();
            $div.prop('contenteditable', false);
            $jqxTree.jqxTree({ keyboardNavigation: true});

            var newText =  $div.html();
            $jqxTree.jqxTree('updateItem', item, { label:  newText });

            // push data to array
            treePostData.push({'id': id, 'parentid': parentId, 'name': newText, 'action': action});
            return false;
        }
    });
}

function showTreeGrid() {
    $('#treeWrapper').hide();
    $('#iow-content').hide();
    $('#back-btn').hide();

    $jqxTree.jqxTree('selectItem', null);
    $('#grid-wrapper').show();
    $('#submit-btn').show();
    $('#cancel-btn').show();
}

function addNewIOW(item) {
    var id = item.element.id;
    bindTreeStructure(item);
    // show iow table
    $iowContent.append(dummyTableHeadHTML.replace(/__1/g, '_' + id));
    $('#newIOW_' + id + ' > tbody').html(dummyTableHTML.replace(/__0/g,'_' + id).replace(/__1/g, '_1').replace(/__9/g,'_1'));

    $('.newIOWs').hide();
    $iowContent.show();
    $('#newIOW_' + id).show();

    arrIOWData.push(id);

    bindAutoComplete(true);
    bindResourceAutoComplete(true);
    expandTrFn(true);
}

function showAddedIOW(item) {
    bindTreeStructure(item);
    $iowContent.hide();
    $('.newIOWs').hide();

    if(arrIOWData.indexOf(item.id)  == -1)
        return;

    $iowContent.show();
    $('#newIOW_' + item.id).show();
}

function bindTreeStructure(item) {
    // get element parents
    var parentId = null,
        $element = $jqxTree.jqxTree('getItem', item.parentElement),
        treeli = '';

    while(parentId != 0) {
        if ($element == null)
            break;

        treeli = '<a data-id="'+$element.id+'">'+$element.label+'</a>' + treeli;
        parentId = $element.parentId;
        $element = $jqxTree.jqxTree('getItem', $element.parentElement);
    }
    treeli += '<a class="active" data-id="'+item.id+'">'+item.label+'</a>';

    // hide treeGrid and show IOW Table
    $('#tree-structure').html(treeli);

    $('#treeWrapper').show();
    $('#back-btn').show();

    $('#grid-wrapper').hide();
    $('#submit-btn').hide();
    $('#cancel-btn').hide();
}

// editablecontent text select fn
jQuery.fn.selectText = function(){
    var element = this[0];
    if (document.body.createTextRange) {
        var range = document.body.createTextRange();
        range.moveToElementText(element);
        range.select();
    } else if (window.getSelection) {
        var selection = window.getSelection();
        var range = document.createRange();
        range.selectNodeContents(element);
        selection.removeAllRanges();
        selection.addRange(range);
    }
};

function getObjectKeyIndex(obj, value) {
    var index = null;
    $.each(obj, function(i, o) {
        if (o.id == value) {
            index = i;
            return false;
        }
    });
    return index;
}

function isRightClick(event) {
    var rightclick;
    if (!event) var event = window.event;
    if (event.which) rightclick = (event.which == 3);
    else if (event.button) rightclick = (event.button == 2);
    return rightclick;
}

function DeleteTRFn(id) {
    var keys =  id.split('_'),
        key1= keys[1],
        key2 = keys[3],
        $elem = $(id);

    if (confirm('Do you want to Delete')) {
        var tr_length = $('#newIOW_'+ key1 +' > tbody tr[id*=newiow_'+ key1 +'_irowid_]').length;

        if(tr_length == 1) {
            $('#newiow_'+ key1 +'_rowid').val(0);
            AddNewRowA(id, false);
        }

        $elem.closest('tr').nextAll('.subTr_' + key2)[0].remove();
        $elem.closest('tr').remove();
    }

    return false;
}
// jqxgrid functions end

function submitForm() {
    $('.loading_area').show();
    $form.append("<input type='hidden' name='wbs' value='" + JSON.stringify(treePostData) + "'/>");
    $newIOWRowId.val(JSON.stringify(arrIOWData));

    $form.submit();
}

// iow functions start
function rateUpdate(x) {
    var arrnames = x.split('_'),
        key1 = arrnames[1],
        key2 = arrnames[2],
        rate = parseFloat($('#newiow_'+ key1 +'_rate_' + key2).val()),
        qty = parseFloat($('#newiow_'+ key1 +'_qty_' + key2).val());

    $('#newiow_'+ key1 +'_amt_' + key2).val(rate*qty);
}

function MixRateUpdate(x) {
    var keys = x.split('_'),
        iowId = keys[1],
        iARowid = keys[3],
        sitemix = isNullCheck($('#newiow_'+ iowId +'_sitemixper_' + iARowid).val(),'number'),
        readymix = isNullCheck($('#newiow_'+ iowId +'_readymixper_' + iARowid).val(),'number'),
        dRate = isNullCheck($('#newiow_'+ iowId +'_rateanal_' + iARowid + '_netrate').val(),'number'),
        dRateR = isNullCheck($('#newiow_'+ iowId +'_rateanalR_' + iARowid + '_netrate').val(),'number');

    var totalMix = dRate * (sitemix / 100);
    totalMix += dRateR * (readymix / 100);
    $('#newiow_'+ iowId +'_rate_' + iARowid).val(parseFloat(totalMix).toFixed(2));
    $('#newiow_'+ iowId +'_qty_' + iARowid).trigger('change');
}

function AddNewRowA(id,is_validate) {
    var keys =  id.split('_'),
        key1= keys[1],
        key2 = keys[3],
        $newIOWRowId = $('#newiow_'+ key1 +'_rowid'),
        iRowId = $newIOWRowId.val();

    if($('#newiow_'+ key1 +'_irowid_' + key2).nextAll('tr[id*=newiow_'+ key1 +'_irowid_]').length == 1)
        return;

    if (typeof is_validate == 'undefined' && is_validate != false) {
        if ($('#newiow_'+ key1 +'_parentid_' + key2).val().length == 0)
            return;

        if ($('#newiow_'+ key1 +'_refserialno_' + key2).val().length == 0)
            return;

        if ($('#newiow_'+ key1 +'_unitkeyid_' + key2).val().length == 0 || $('#newiow_'+ key1 +'_unitkeyid_' + key2).val() ==0)
            return;
    }

    var ioRowId =  iRowId,
        iRowId = +iRowId + 1,
        sStr = dummyTableHTML.replace(/__1/g,'_'+ iRowId).replace(/__9/g,'_1').replace(/__0/g,'_' + key1);

    if (ioRowId != 1) {ioRowId = (ioRowId*2)-1 ;}

    $('#newIOW_'+ key1  +' > tbody > tr.subTr_' + key2).after(sStr);
    $('#newIOW_'+ key1  +'_rowrefid_' + iRowId).val(iRowId);
    $newIOWRowId.val(iRowId);

    checkResource(id,"");
    checkResource(id,"R");

    closedetails();
    bindAutoComplete();
    bindResourceAutoComplete();
    expandTrFn(true);
    bindTRDeleteFn(key1, true);
    bindMixSortablefn(true);

    var aSNo = $('#newiow_'+ key1 +'_parentkeyid_' +key2).val().split('.');
    if (aSNo.length >0) GetWorkGroupDetails( isNullCheck(aSNo[0],'number'),id);
}

function expandTrFn(reset) {
    var $mainTRs = $("a[class*=_mainTr_]");

    if (typeof reset !== 'undefined' && reset === true)
        $mainTRs.unbind('click');

    $mainTRs.click(function(e){
        e.preventDefault();

        var name = $(this)[0].className,
            keys= name.split('_'),
            iowId = keys[1],
            key = keys[3];

        if (validateRow(name) == false)
            return false;

        var $subTr = $(this).closest("tr").nextAll(".subTr_" + key),
            $i = $(this).find("i");

        if(!$subTr.is(":visible")){
            $subTr.show();
            $subTr.find(".subDiv").slideDown("slow");
            $i.addClass("tform");
            $('#newiow_'+ iowId +'_rateanal_'+ key +'_restable').show();

            iFocusRowId = key;
            closedetails(key);
        } else {
            $subTr.find(".subDiv").slideUp("slow");
            $subTr.slideUp("slow");
            $i.removeClass("tform");
        }
        return false;
    });
}

function validateRow(x) {
    var keys = x.split("_"),
        iowId = keys[1],
        key2 = keys[3];
    var scurId = "_" + key2,
        sparentId = $('#newiow_'+ iowId +'_parentkeyid' + scurId).val(),
        $sparentId = $('#newiow_'+ iowId +'_parentid' + scurId),
        $sserialno = $('#newiow_'+ iowId +'_refserialno' + scurId),
        $sspec = $('#newiow_'+ iowId +'_spec' + scurId),
        sUnit = $('#newiow_'+ iowId +'_unitkeyid' + scurId).val(),
        $sQty  = $('#newiow_'+ iowId +'_qty' + scurId);

    if (sparentId.length==0) {
        alert("Parent Not Selected");
        $sparentId.focus();
        return false;
    } else if($sserialno.val().length==0) {
        alert("Serial No is Empty");
        $sserialno.focus();
        return false;
    } else if(sUnit.length==0 || sUnit==0) {
        alert("Unit Not Selected");
        $('#newiow_'+ iowId +'_unitid' + scurId).focus();
        return false;
    }

    $sparentId.prop('readonly', true);
    bSiteMix = true;
    CheckShowDetails(x);
    CalculateFull(x);

    var aSNo = $('#newiow_'+ iowId +'_parentkeyid_' +key2).val().split('.');
    GetWorkGroupDetails(aSNo[0],x);
    return true;
}

function expandResSubTr(tr, id) {
    var $subTr = $('#' + tr),
        $i = $('#' + id).find("i"),
        type = id.split('_')[2],
        rateanal = '_rateanal_';

    if (type.substr(type.length - 1) == 'R')
        rateanal = '_rateanalR_';

    if($subTr.length ==0) {
        var sStr = id.split('_');
        $('#newiow_' + sStr[1] + rateanal + sStr[3] +'_resrate_' + sStr[5]).triggerHandler('focus');
        return;
    }

    if(!$subTr.is(":visible")){
        $subTr.show();
        $subTr.find(".subDiv").slideDown("slow");
        $i.addClass("tform");
    } else{
        $subTr.find(".subDiv").slideUp("slow");
        $subTr.slideUp("slow");
        $i.removeClass("tform");
    }
}

function bindAutoComplete() {
    var $parent_ids = $('input[id*=_parentid_]'),
        $unitids = $('input[id*=_unitid_]'),
        $proj_workgroups = $('input[id*=_workgroupname_]');

    // unbind previous autocomplete functionality
    $parent_ids.unbind('autocomplete');
    $unitids.unbind('autocomplete');

    $.each($parent_ids, function (i, obj) {
        var $this = $(this),
            name = $this[0].id;

        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1)
            return;

        var keys = name.split('_'),
            rowId = keys[1],
            key1 =  keys[3];

        $this.autocomplete({
            lookup: arryparentList,
            groupBy: 'category',
            multiselect:true,
            showNoSuggestionNotice:true,
            noSuggestionNotice: 'Do you want to Create New <input type="button" font-weight:bold" name="newiow_'+rowId+'_newworkgroup_'+ key1  +'" class="btn btn-link" id="newiow_'+rowId+'_newworkgroup_'+ key1 +'" value="Work Group" onclick="return AddNewWorkGroup('+name+')" >',
            lookupFilter: function(suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase =='*') {
                    return suggestion.value;
                }
                else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            },
            onSelect: function(suggestion) {
                if(suggestion) {
                    $("#newiow_"+rowId+"_parentkeyid_"+ key1).val(suggestion.id);
                    $("#newiow_"+rowId+"_type_"+ key1).val(suggestion.type);
                    $(this).removeClass('error');
                }
            },
            onSearchStart: function(suggestion) {
                $("#newiow_"+rowId+"_parentkeyid_"+ key1).val(0);
                $("#newiow_"+rowId+"_type_"+ key1).val('');
            },
            onSearchComplete: function (query, suggestions) {
                if(!suggestions.length && query.length > 1){
                    $(this).addClass('error');
                    $("#newiow_"+rowId+"_parentkeyid_"+ key1).val(0);
                    $("#newiow_"+rowId+"_type_"+ key1).val('');
                } else
                    $(this).removeClass('error');
            }
        });
    });

    $.each($unitids, function (i, obj) {
        var $this = $(this),
            name = $this[0].id;

        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1)
            return;

        var keys = name.split('_'),
            rowId = keys[1],
            key1 =  keys[3];

        $this.autocomplete({
            lookup: arrayunitlist,
            showNoSuggestionNotice:true,
            noSuggestionNotice: 'Do you want to Create New <input type="button" font-weight:bold" name="newiow_'+rowId+'_newunit_'+ key1  +'" class="btn btn-link" id="newiow_'+rowId+'_newunit_'+ key1 +'" value="Unit" onclick="return AddNewUnit('+name+')" >',

            lookupFilter: function(suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase =='*') {
                    return suggestion.value;
                }
                else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            },
            onSelect: function(suggestion) {
                if(suggestion) {
                    $("#newiow_"+rowId+"_unitkeyid_" + key1).val(suggestion.data);
                    $(this).removeClass('error');
                }
            },
            onSearchStart: function(suggestion) {
                $("#newiow_"+rowId+"_unitkeyid_" + key1).val(0);
            },
            onSearchComplete: function (query, suggestions) {
                if(!suggestions.length){
                    $(this).addClass('error');
                    $("#newiow_"+rowId+"_unitkeyid_" + key1).val(0);
                }
                else
                {
                    $(this).removeClass('error');
                }
            }
        });
    });

    $.each($proj_workgroups, function (i, obj) {
        var $this = $(this),
            name = $this[0].id;

        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1)
            return;

        var keys = name.split('_'),
            iowId = keys[1],
            key1 =  keys[3];

        $this.autocomplete({
            lookup: arrayprojworkgroup,
            showNoSuggestionNotice:true,
            noSuggestionNotice: 'Do you want to Create New <input type="button" font-weight:bold" name="newprojworkgroup_'+ key1  +'" class="btn btn-link" id="newprojworkgroup_'+ key1 +'" value="Project WorkGroup" onclick="return AddNewProjectWorkGroup('+name+')" >',
            lookupFilter: function(suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase =='*') {
                    return suggestion.value;
                }
                else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            },
            onSelect: function(suggestion) {
                if(suggestion) {
                    $("#newiow_"+iowId+"_workgroupid_"+ key1).val(suggestion.data);
                    $(this).removeClass('error');
                }
            },
            onSearchStart: function(suggestion) {
                $("#newiow_"+iowId+"_workgroupid_"+ key1).val(0);
            },
            onSearchComplete: function (query, suggestions) {
                if(!suggestions.length){
                    $(this).addClass('error');
                    $("#newiow_"+iowId+"_workgroupid_"+ key1).val(0);
                } else
                    $(this).removeClass('error');
            }
        });
    });
}

function bindResourceAutoComplete() {
    var $resids = $('input[id*=_resid_]');

    // unbind previous autocomplete functionality
    $resids.unbind('autocomplete');

    $.each($resids, function (i, obj) {
        var $this = $(this),
            name = $this[0].id;

        if (name.indexOf('__') != -1 || name.indexOf('excel') != -1)
            return;

        var arrname = name.split('_'),
            iowId = arrname[1],
            key1 = arrname[3],
            key2 = arrname[5],
            sname = arrname[2];

        if (sname.substr(sname.length-1) === 'R') {
            var $resunit = $("label[for='newiow_"+iowId+"_rateanalR_" + key1 + "_resunit_"+key2+"']"),
                $resname = $('#newiow_'+iowId+'_rateanalR_' + key1 + '_resid_' + key2);

            $this.autocomplete({
                lookup: arrayresR,
                groupBy: 'category',
                multiselect:true,
                showNoSuggestionNotice:true,

                noSuggestionNotice: 'Do you want to Create New <input type="button" font-weight:bold" name="newiow_'+iowId+ '_rateanalR_' + key1 + '_newres_'+key2+'" class="btn btn-link" id="newiow_'+iowId+ 'rateanalR_' + key1 + '_newres_'+key2+'" value="Resource" onclick="return AddNewResourceR('+name+')" > or <input type="button" font-weight:bold" name="newiow_'+iowId+ 'rateanalR_' + key1 + '_newhead_'+key2+'" class="btn btn-link" id="newiow_'+iowId+ 'rateanalR_' +  key1 +  '_newhead_'+key2+'" value="Header" onclick="return AddNewRowResHeaderR(this)" >',

                lookupFilter: function(suggestion, originalQuery, queryLowerCase) {
                    if (queryLowerCase =='*') {
                        return suggestion.value;
                    }
                    else {
                        var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                        return re.test(suggestion.value);
                    }

                },
                onSelect: function(suggestion) {
                    if(suggestion) {
                        $resname.prop('disabled', true);
                        if (suggestion.data.category == "Resource") {
                            $('#newiow_'+iowId+ '_rateanalR_' + key1 + '_reskeyid_' + key2).val(suggestion.id);
                            $('#newiow_'+iowId+ '_rateanalR_' + key1 + '_iowkeyid_' + key2).val(0);
                            $("#newiow_"+iowId+ "_rateanalR_" + key1 + "_type_" + key2).val('R');
                            cboResChanged(suggestion.id, iowId, key1, key2, "R");
                        }
                        else if (suggestion.data.category == "IOW") {
                            $('#newiow_'+iowId+ '_rateanalR_' + key1 + '_reskeyid_' + key2).val(0);
                            $('#newiow_'+iowId+ '_rateanalR_' + key1 + '_iowkeyid_' + key2).val(suggestion.id);
                            $("#newiow_"+iowId+ "_rateanalR_" + key1 + "_type_" + key2).val('I');
                            cboIOWChanged(suggestion.id, iowId, key1, key2, "R");
                        }

                        if ($('#newiow_'+iowId+ '_rateanalR_' + key1 + '_RowId_' + (parseInt(key2) + 1)).length == 0) {
                            AddNewRowResR('#newiow_'+iowId+'_rateanalR_' + key1 + '_resid_' + key2);
                        }

                        $(this).removeClass('error');
                    }
                },

                onSearchStart: function(suggestion) {
                    //$resunit.html('');
                    //checkResourceR(key2);
                },
                onSearchComplete: function (query, suggestions) {
                    if(!suggestions.length){
                        $(this).addClass('error');
                        $resunit.html('');
                        $('#newiow_'+iowId+ '_rateanalR_' + key1 + '_reskeyid_' + key2).val(0);
                        $('#newiow_'+iowId+ '_rateanalR_' + key1 + '_iowkeyid_' + key2).val(0);
                    }
                    else
                    {
                        $(this).removeClass('error');
                    }
                }
            });
        } else {

            var $resunit = $("label[for='newiow_"+iowId+"_rateanal_" + key1 + "_resunit_"+key2+"']"),
                $resname = $('#newiow_'+iowId+ '_rateanal_' + key1 + '_resid_' + key2);
            $this.autocomplete({
                lookup: arrayres,
                groupBy: 'category',
                multiselect:true,
                showNoSuggestionNotice:true,

                noSuggestionNotice: 'Do you want to Create New <input type="button" font-weight:bold" name="newiow_'+iowId+ 'rateanal_' + key1 + '_newres_'+key2+'" class="btn btn-link" id="newiow_'+iowId+ 'rateanal_' + key1 + '_newres_'+key2+'" value="Resource" onclick="return AddNewResource('+name+')" > or <input type="button" font-weight:bold" name="newiow_'+iowId+ 'rateanal_' + key1 + '_newhead_'+key2+'" class="btn btn-link" id="newiow_'+iowId+ 'rateanal_' +  key1 +  '_newhead_'+key2+'" value="Header" onclick="return AddNewRowResHeader(this)" >',

                lookupFilter: function(suggestion, originalQuery, queryLowerCase) {
                    if (queryLowerCase =='*') {
                        return suggestion.value;
                    }
                    else {
                        var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                        return re.test(suggestion.value);
                    }

                },
                onSelect: function(suggestion) {
                    if(suggestion) {
                        $resname.prop('disabled', true);
                        if (suggestion.data.category == "Resource") {
                            $('#newiow_'+iowId+ '_rateanal_' + key1 + '_reskeyid_' + key2).val(suggestion.id);
                            $('#newiow_'+iowId+ '_rateanal_' + key1 + '_iowkeyid_' + key2).val(0);

                            $("#newiow_"+iowId+ "_rateanal_" + key1 + "_type_" + key2).val('R');
                            cboResChanged(suggestion.id,iowId, key1, key2,"");
                        }
                        else if (suggestion.data.category == "IOW") {
                            $('#newiow_'+iowId+ '_rateanal_' + key1 + '_reskeyid_' + key2).val(0);
                            $('#newiow_'+iowId+ '_rateanal_' + key1 + '_iowkeyid_' + key2).val(suggestion.id);

                            $("#newiow_"+iowId+ "_rateanal_" + key1 + "_type_" + key2).val('I');
                            cboIOWChanged(suggestion.id,iowId, key1, key2,"");
                        }

                        if ($('#newiow_'+iowId+ '_rateanal_'+key1+'_RowId_' + (parseInt(key2) + 1)).length == 0) {
                            AddNewRowRes('#newiow_'+iowId+ '_rateanal_' + key1 + '_resid_' + key2);
                        }

                        $(this).removeClass('error');
                    }
                },

                onSearchStart: function(suggestion) {
                    //$resunit.html('');
                    //checkResource(key1,key2);
                },
                onSearchComplete: function (query, suggestions) {
                    if(!suggestions.length){
                        $(this).addClass('error');
                        $resunit.html('');
                        $('#newiow_'+iowId+ '_rateanal_' + key1 + '_reskeyid_' + key2).val(0);
                        $('#newiow_'+iowId+ '_rateanal_' + key1 + '_iowkeyid_' + key2).val(0);
                    }
                    else
                    {
                        $(this).removeClass('error');
                    }
                }

            });
        }
    });
}

function CheckIOWValid(x) {
    var keys = x.split("_"),
        iowId = keys[1],
        iARowid = keys[3];
    if ($('#newiow_'+iowId+'_iowkeyid_' + iARowid).val() == 0 || $('#iowkeyid_' + iARowid).val().length==0) {
        $('#newiow_'+iowId+'_iowid_' + iARowid).addClass('error');
        $('#newiow_'+iowId+'_qty_' + iARowid).val(0);
        $('#newiow_'+iowId+'_rate_' + iARowid).val(0);
        $('#newiow_'+iowId+'_amount_' + iARowid).val(0);
        $("label[for='newiow_"+iowId+"_unit_" + iARowid + "']").html("");

        $('#newiow_'+iowId+'_qty_' + iARowid).prop('readonly', true);
        $('#rate_' + iARowid).prop('readonly', true);
    } else {
        $('#newiow_'+iowId+'_iowid_' + iARowid).removeClass('error');
        $('#newiow_'+iowId+'_qty_' + iARowid).prop('readonly', false);
        $('#newiow_'+iowId+'_rate_' + iARowid).prop('readonly', false);
    }
}

function DeleteResource(x, e) {
    e.preventDefault();
    var sStr = x.split("_"),
        iowId = sStr[1],
        key1 = sStr[3],
        iARowid = sStr[5];

    var stype =  isNullCheck($('#newiow_'+iowId+'_rateanal_' + key1 + '_type_' + iARowid).val(),'string');
    if (stype =="R"){
        if  (isNullCheck($('#newiow_'+iowId+'_rateanal_' + key1 + '_reskeyid_' + iARowid).val(),'number') ==0){
            return;
        }
    }
    else if (stype=="I"){
        if  (isNullCheck($('#newiow_'+iowId+'_rateanal_' + key1 + '_iowkeyid_' + iARowid).val(),'number') ==0){
            return;
        }
    }
    else if (stype=="H") {
        if  (isNullCheck($('#newiow_'+iowId+'_rateanal_' + key1 + '_resdes_' + iARowid).val(),'string') ==""){
            return;
        }
    }
    else {
        return;
    }

    if (confirm('Do you want to Delete')) {
        var $row = $('#newiow_'+iowId+'_rateanal_' + key1 + '_RowId_' + iARowid),
            $tr_resactivity = $('#newiow_'+iowId+'_resactvity_'+key1+'_RowId_' + iARowid),
            tr_length = $('tr[id*=newiow_'+iowId+'_rateanal_' + key1 + '_RowId_]').length,
            irid =   $('#newiow_'+iowId+'_rowinfoid_' + key1).val(),
            $lrow = $('#newiow_'+iowId+'_rateanal_' + key1 + '_RowId_' + irid),
            $tr_resqty = $('input[id*=newiow_'+iowId+'_rateanal_' + key1 + '_resqty_]');

        if (tr_length > 2) {
            $lrow.remove();
            $row.remove();
            $tr_resactivity.remove();
            $('#newiow_'+iowId+'_rowinfoid_' + key1).val(irid-1);
            AddNewRowRes(x);
            $tr_resqty.trigger('change');
        }
        else {
            $('#newiow_'+iowId+'_rowinfoid_' + key1).val(0);
            if (tr_length != 2) { AddNewRowRes(x) }
            $row.remove();
            $tr_resactivity.remove();
            $tr_resqty.trigger('change');
        }
        SortOrder(x);
    }
    return false;
}

function SortOrder(x) {
    var sStr = x.split("_"),
        iowId = sStr[1],
        key1 = sStr[3],
        irefid=1;
    $.each($('tr[id*=newiow_'+iowId+'_rateanal_'+key1+'_RowId_]'), function() {
        var id = $(this)[0].id;
        var sStr = id.split("_"),
            iowId = sStr[1],
            key1 = sStr[3],
            iARowid = sStr[5];

        $('#newiow_'+iowId+'_rateanal_' + key1 + '_rowrefid_' + iARowid).val(irefid);
        irefid = + irefid+1;
    });
}

function SortOrderR(x) {
    var sStr = x.split("_"),
        iowId = sStr[1],
        key1 = sStr[3],
        irefid=1;
    $.each($('tr[id*=newiow_'+iowId+'_rateanalR_'+key1+'_RowId_]'), function() {
        var id = $(this)[0].id;
        var sStr = id.split("_"),
            iowId = sStr[1],
            key1 = sStr[3],
            iARowid = sStr[5];

        $('#newiow_'+iowId+'_rateanalR_' + key1 + '_rowrefid_' + iARowid).val(irefid);
        irefid = + irefid+1;
    });
}

function IOWRateUpdate(x) {
    var sStr = x.split("_"),
        iowId = sStr[1],
        iARowid = sStr[3],
        sVal = $('#newiow_'+iowId+'_ratetype_' + iARowid).val();

    var dRate=0;
    if (sVal=='R')
        dRate = isNullCheck($('#newiow_'+iowId+'_rateanalR_' + iARowid + '_netrate').val(),'number');
    else
        dRate = isNullCheck($('#newiow_'+iowId+'_rateanal_' + iARowid + '_netrate').val(),'number');

    $('#newiow_'+iowId+'_rate_' + iARowid).val(parseFloat(dRate).toFixed(2));
}

function CheckParentValid(x) {
    var sStr = x.split("_"),
        iowRowId = sStr[1],
        iARowid = sStr[3];

    if ($('#newiow_'+iowRowId+'_parentkeyid_' + iARowid).val() == '0' || $('#newiow_'+iowRowId+'_parentkeyid_' + iARowid).val().length==0) {
        if ($('#newiow_'+iowRowId+'_parentid_' + iARowid).val().length >0){$('#newiow_'+iowRowId+'_parentid_' + iARowid).addClass('error');}
        else {$('#newiow_'+iowRowId+'_unitid_' + iARowid).removeClass('error');}
    } else
        $('#newiow_'+iowRowId+'_parentid_' + iARowid).removeClass('error');
}

function CheckUnitValid(x) {
    var sStr = x.split("_"),
        iowRowId = sStr[1],
        iARowid = sStr[3];

    if ($('#newiow_'+iowRowId+'_unitkeyid_' + iARowid).val() == '0' || $('#newiow_'+iowRowId+'_unitkeyid_' + iARowid).val().length==0) {
        if ($('#newiow_'+iowRowId+'_unitid_' + iARowid).val().length >0){$('#newiow_'+iowRowId+'_unitid_' + iARowid).addClass('error');}
        else {$('#newiow_'+iowRowId+'_unitid_' + iARowid).removeClass('error');}
        $('#newiow_'+iowRowId+'_rate_' + iARowid).val(0);
    } else {
        $('#newiow_'+iowRowId+'_unitid_' + iARowid).removeClass('error');
        $('#newiow_'+iowRowId+'_rate_' + iARowid).val(0);
        AddNewRowA(x);
    }
}

function CheckResValid(x) {
    var keys = x.split("_"),
        iowId = keys[1],
        key1 = keys[3],
        iARowid = keys[5],
        name = '#newiow_'+ iowId +'_'+keys[2]+'_' + key1;

    var sType = $(name + '_type_' + iARowid).val();

    if (sType == "I" || sType=="R") {
        if (sType == "I") {
            if ($(name + '_iowkeyid_' + iARowid).val() == '0' || $(name + '_iowkeyid_' + iARowid).val().length == 0) {
                $(name + '_resid_' + iARowid).addClass('error');
                $(name + '_resqty_' + iARowid).val(0);
                $(name + '_resrate_' + iARowid).val(0);
                $(name + '_resamt_' + iARowid).val(0);

                $(name + '_resqty_' + iARowid).prop('readonly', true);
                $(name + '_resrate_' + iARowid).prop('readonly', true);
            } else {
                $(name + '_resid_' + iARowid).removeClass('error');
                $(name + '_resqty_' + iARowid).prop('readonly', false);
                $(name + '_resrate_' + iARowid).prop('readonly', false);
            }
        } else {
            if ($(name + '_reskeyid_' + iARowid).val() == '0' || $(name + '_reskeyid_' + iARowid).val().length == 0) {
                $(name + '_resid_' + iARowid).addClass('error');
                $(name + '_resqty_' + iARowid).val(0);
                $(name + '_resrate_' + iARowid).val(0);
                $(name + '_resamt_' + iARowid).val(0);

                $(name + '_resqty_' + iARowid).prop('readonly', true);
                $(name + '_resrate_' + iARowid).prop('readonly', true);
            } else {
                $(name + '_resid_' + iARowid).removeClass('error');
                $(name + '_resqty_' + iARowid).prop('readonly', false);
                $(name + '_resrate_' + iARowid).prop('readonly', false);

            }
        }
    }
}


function ShowNewWorkGroup(e) {
    e.preventDefault();
    var $newwg = $('#newwg');
    if ($newwg.is(":hidden"))
        $newwg.show();
    else
        $newwg.hide();

    return false;
}

function ShowRateResource(e) {
    e.preventDefault();
    $("#rateResource").modal('show');
    return false;
}

function ResourceRateUpdate()
{
    var irows = $('#resourcerate tbody tr').length;
    var bFound=false;
    var dRate=0;
    var dOldRate=0;
    var iResid = 0;

    for (var i = 1; i <= irows; i++) {
        iResid= $('#rateresid_' + i).val();
        dRate = $('#rateresrate_' + i).val();
        dOldRate = $('#rateresoldrate_' + i).val();

        if (dRate != dOldRate) {
            UpdateResourceRate(iResid,dRate);
            $('#rateresoldrate_' + i).val(dRate);
            UpdateActivityResourceRate(iResid,dRate);
            UpdateSubIOWResourceRate(iResid,dRate);
        }
    }

}

function UpdateActivityResourceRate(resid,rate)
{
    for(var i=0;i<arrActivityAnal.length;i++) {
        if (arrActivityAnal[i].resourceid == resid) {
            arrActivityAnal[i].rate = rate;
            arrActivityAnal[i].amount = parseFloat(arrActivityAnal[i].qty) * rate;
            UpdateActivityRate(arrActivityAnal[i].activityid);
        }
    }
}

function UpdateActivityRate(iAResid)
{
    var dmAmt = 0, daAmt = 0,dmQty= 0, daQty= 0;

    var objR = $.grep(arrActivityAnal, function (element, index) {
        return element.activityid == iAResid;
    });

    for(var i=0;i<objR.length;i++) {
        if  (objR[i].activitytype =="A")
            daAmt = daAmt + parseFloat(objR[i].amount);
        else
            dmAmt = dmAmt + parseFloat(objR[i].amount);
    }

    for(var i=0;i<arrActivityRes.length;i++) {
        if (arrActivityRes[i].activityid == iAResid) {
            dmQty = parseFloat(arrActivityRes[i].analysisMQty);
            daQty = parseFloat(arrActivityRes[i].analysisAQty);

            if (dmQty==0) { dmQty=1; arrActivityRes[i].AnalysisMQty = dmQty; }
            if (daQty==0) { daQty=1; arrActivityRes[i].AnalysisAQty = dmQty; }

            arrActivityRes[i].mRate = dmAmt/dmQty;
            arrActivityRes[i].aRate = daAmt/daQty;
            UpdateActivityMainRate(iAResid,arrActivityRes[i].lRate,arrActivityRes[i].mRate,arrActivityRes[i].aRate);
            break;
        }
    }
}

function UpdateResourceRate(iResid,dRate)
{
    var $reskeyids = $('input[id*=_reskeyid_][value="'+iResid+'"]');
    $.each($reskeyids, function (j, obj) {
        var name = $(this)[0].id,
            arr_name = name.split('_'),
            iowId = arr_name[1],
            key1 = arr_name[3],
            key2 = arr_name[5];

        $('#newiow_'+ iowId +'_'+ arr_name[2] +'_'+ key1+ '_resrate_' + key2).val(dRate);
        $('#newiow_'+ iowId +'_' +  arr_name[2] + '_' + key1+ '_resqty_' + key2).trigger('change');
    });
}

function UpdateActivityMainRate(iResid,dLRate,dMRate,dARate)
{
    var $reskeyids = $('input[id*=_reskeyid_][value="'+iResid+'"]');
    var dRate=0;
    $.each($reskeyids, function (j, obj) {
        var name = $(this)[0].id,
            arr_name = name.split('_'),
            iowId = arr_name[1],
            key1 = arr_name[3],
            key2 = arr_name[5];

        if ($('#newiow_'+ iowId +'_'+ arr_name[2] +'_'+ key1+ '_ratetype_' + key2).val() == "M") { dRate =  dMRate; }
        else if ($('#newiow_'+ iowId +'_'+ arr_name[2] +'_'+ key1+ '_ratetype_' + key2).val() == "A") { dRate =  dARate; }
        else { dRate =  dLRate; }

        $('#newiow_'+ iowId +'_'+ arr_name[2] +'_'+ key1+ '_resrate_' + key2).val(dRate);
        $('#newiow_'+ iowId +'_' +  arr_name[2] + '_' + key1+ '_resqty_' + key2).trigger('change');
    });
}

function UpdateSubIOWResourceRate(resid,rate)
{
    for(var i=0;i<arrSubIOWAnal.length;i++) {
        if (arrSubIOWAnal[i].resourceid == resid) {
            arrSubIOWAnal[i].rate = rate;
            arrSubIOWAnal[i].amount = parseFloat(arrSubIOWAnal[i].qty) * rate;
            UpdateSubIOWRate(arrSubIOWAnal[i].subiowid);
        }
    }
}

function UpdateSubIOWRate(isubiowid)
{
    var dsAmt = 0, drAmt = 0,dsQty= 0, drQty= 0;

    var objR = $.grep(arrSubIOWAnal, function (element, index) {
        return element.subiowid == isubiowid;
    });

    for(var i=0;i<objR.length;i++) {
        if  (objR[i].mixtype =="R")
            drAmt = drAmt + parseFloat(objR[i].amount);
        else
            dsAmt = dsAmt + parseFloat(objR[i].amount);
    }

    for(var i=0;i<arrSubIOW.length;i++) {
        if (arrSubIOW[i].subiowid == isubiowid) {
            dsQty = parseFloat(arrSubIOW[i].workingqty);
            drQty = parseFloat(arrSubIOW[i].rworkingQty);

            if (dsQty==0) { dsQty=1; arrSubIOW[i].workingqty = dsQty; }
            if (drQty==0) { drQty=1; arrSubIOW[i].rworkingQty = drQty; }

            arrSubIOW[i].srate = dsAmt/dsQty;
            arrSubIOW[i].rrate = drAmt/drQty;

            UpdateSubIOWMainRate(isubiowid,arrSubIOW[i].srate,arrSubIOW[i].rrate)
            break;
        }
    }
}

function UpdateSubIOWMainRate(isubiowid,dSRate,dRRate)
{
    var $reskeyids = $('input[id*=_iowkeyid_][value="'+isubiowid+'"]');
    var dRate=0;
    $.each($reskeyids, function (j, obj) {
        var name = $(this)[0].id,
            arr_name = name.split('_'),
            iowId = arr_name[1],
            key1 = arr_name[3],
            key2 = arr_name[5];

        if ($('#newiow_'+ iowId +'_'+ arr_name[2] +'_'+ key1+ '_ratetype_' + key2).val() == "R") { dRate =  dRRate; }
        else { dRate =  dSRate; }

        $('#newiow_'+ iowId +'_'+ arr_name[2] +'_'+ key1+ '_resrate_' + key2).val(dRate);
        $('#newiow_'+ iowId +'_' +  arr_name[2] + '_' + key1+ '_resqty_' + key2).trigger('change');
    });
}


function ShowNewResource(e) {
    e.preventDefault();
    var $newr = $('#newres');
    if ($newr.is(":hidden"))
        $newr.show();
    else
        $newr.hide();

    return false;
}

function DeleteResourceR(x, e) {
    e.preventDefault();
    var sStr = x.split("_"),
        iowId = sStr[1],
        key1 = sStr[3],
        iARowid = sStr[5];

    var stype =  isNullCheck($('#newiow_'+ iowId +'_rateanalR_' + key1 + '_type_' + iARowid).val(),'string');
    if (stype =="R"){
        if  (isNullCheck($('#newiow_'+ iowId +'_rateanalR_' + key1 + '_reskeyid_' + iARowid).val(),'number') ==0)
            return;
    }
    else if (stype=="I"){
        if  (isNullCheck($('#newiow_'+ iowId +'_rateanalR_' + key1 + '_iowkeyid_' + iARowid).val(),'number') ==0)
            return;
    }
    else if (stype=="H") {
        if  (isNullCheck($('#newiow_'+ iowId +'_rateanalR_' + key1 + '_resdes_' + iARowid).val(),'string') =="")
            return;
    }
    else
        return;

    if (confirm('Do you want to Delete')) {
        var $row = $('#newiow_'+ iowId +'_rateanalR_' + key1 + '_RowId_' + iARowid),
            tr_length = $('tr[id*=newiow_'+ iowId +'_rateanalR_' + key1 + '_RowId_]').length,
            $tr_resactivity = $('#newiow_'+ iowId +'_resactvityR_'+key1+'_RowId_' + iARowid),
            irid = $('#newiow_'+ iowId +'_rowinfoidR_' + key1).val(),
            $lrow = $('#newiow_'+ iowId +'_rateanalR_' + key1 + '_RowId_' + irid),
            $tr_resqty = $('input[id*=newiow_'+ iowId +'_rateanalR_' + key1 + '_resqty_]');


        if (tr_length > 2) {
            $lrow.remove();
            $row.remove();
            $tr_resactivity.remove();
            $('#newiow_'+ iowId +'_rowinfoidR_' + key1).val(irid-1);
            AddNewRowResR(x);
            $tr_resqty.trigger('change');
        }
        else {
            $('#newiow_'+ iowId +'_rowinfoidR_' + key1).val(0);
            if (tr_length != 2) { AddNewRowResR(x);}
            $row.remove();
            $tr_resactivity.remove();
            $tr_resqty.trigger('change');
        }
        SortOrderR(x);
    }
    return false;
}

function bindTRDeleteFn(iowId, reset) {
    var $trDelete = $('a[class*=newiow_'+iowId+'_mainTrDelete_]');
    if (typeof reset !== 'undefined' && reset === true)
        $trDelete.unbind('click');

    $.each($trDelete, function (i, obj) {
        var $this = $(this),
            name = $this[0].className,
            key =  name.split('_')[1];

        if (name.indexOf('__') != -1)
            return;

        $this.on('click', function(e) {
            e.preventDefault();

            if (confirm('Do you want to Delete')) {
                var tr_length = $('#newIOW_'+iowId+' > tbody tr[id*=IOWiRowId_]').length;

                //alert(tr_length);
                if(tr_length == 1) {
                    $('#rowid').val(0);
                    AddNewRowA(name, false);
                }

                $this.closest('tr').nextAll('.subTr_' + key)[0].remove();
                $this.closest('tr').remove();
            }
            return false;
        });

    });
}

function bindMixSortablefn(reset) {
    // ReadyMix sortable function
    var $rBody = $('table[id*=_rateanalR_] tbody.sorting'),
        $sBody = $('table[id*=_rateanal_] tbody.sorting');

    $.each($rBody, function(i, obj){
        if ($(this).parent('table')[0].id.indexOf('__') != -1) {
            $rBody.splice(i, 1);
            $sBody.splice(i, 1);
        }
    });

    var $sRTable = $rBody.find('tr'),
        $sTable = $sBody.find('tr');
    if (typeof reset !== 'undefined' && reset === true) {
        $sRTable.unbind('click', 'dblclick', 'select', 'sortable');
        $sTable.unbind('click', 'dblclick', 'select', 'sortable');
        $rBody.unbind('sortable');
        $sBody.unbind('sortable');
    }

    $sRTable.on( 'dblclick', function () {
        var $this = $(this);

        if ($this.hasClass('selected') == true) {
            $this.toggleClass('selected', false);
        } else
            $this.toggleClass('selected', true);
    });

    $sRTable.on( 'click', function () {
        var $this = $(this);
        $this.closest("tr").siblings().removeClass("highlighted");
        $this.toggleClass('highlighted',true);
    });

    $sRTable.on( 'select', function () {
        var $this = $(this);
        $this.closest("tr").siblings().removeClass("highlighted");
        $this.toggleClass('highlighted',true);
    });

    $rBody.sortable({
        helper: fixHelperModified,
        stop: updateIndex,
        axis: 'y',
        distance: 40,
        update: function( event, ui ) {
            SortOrderR(event.target.children[0].id);
        }
    });

    // SiteMix sortable function
    $sTable.on( 'dblclick', function () {
        var $this = $(this);

        if ($this.hasClass('selected') == true)
            $this.toggleClass('selected', false);
        else
            $this.toggleClass('selected', true);
    });

    $sTable.on( 'click', function () {
        var $this = $(this);
        $this.closest("tr").siblings().removeClass("highlighted");
        $this.toggleClass('highlighted',true);
    });

    $sTable.on( 'select', function () {
        var $this = $(this);
        $this.closest("tr").siblings().removeClass("highlighted");
        $this.toggleClass('highlighted',true);
    });

    $sBody.sortable({
        helper: fixHelperModified,
        stop: updateIndex,
        axis: 'y',
        distance: 40,
        update: function( event, ui ) {
            SortOrder(event.target.children[0].id);
        }
    });
}

function closeIOWAnalysis(x) {
    var sStr = x.split("_"),
        iowId = sStr[1];
    key1 = sStr[3],
        activityName = 'resactvity_';

    if(sStr[2].substr(sStr[2].length - 1) == 'R')
        activityName = 'resactvityR_';

    $('tr[id*=newiow_'+iowId+'_resactvity_' + key1 +'_RowId_]').remove();
    $('tr[id*=newiow_'+iowId+'_resactvityR_' + key1 +'_RowId_]').remove();
    $('a[id*=newiow_'+iowId+'_resactvity_' + key1 +'_resTr_] i').removeClass('tform');
    $('a[id*=newiow_'+iowId+'_resactvityR_' + key1 +'_resTr_] i').removeClass('tform');
}

function showAnalysis(x,mtype) {
    var sStr = x.split("_"),
        iowId = sStr[1],
        key1 = sStr[3],
        iARowid = sStr[5];

    var sName = 'newiow_'+ iowId +'_rateanal_',
        activityName = '_resactvity_';

    if (mtype =="R")  { sName = 'newiow_'+ iowId +'_rateanalR_'; activityName = '_resactvityR_';}

    var iARowid = sStr[5],
        sRateType = $('#' + sName + key1 + '_ratetype_' + iARowid).val(),
        trName = 'newiow_'+ iowId + activityName + key1 + '_RowId_' + iARowid,
        aLink = 'newiow_'+ iowId + activityName + key1 + '_resTr_' + iARowid,
        iResId= 0,
        expandLink = '<a class="resSubTr" id="'+aLink+'" href="javascript: expandResSubTr(\''+trName+'\', \''+aLink+'\')" style="margin-left: 12px;"><i class="fa fa-chevron-circle-down ctls" data-toggle="tooltip" data-placement="top" data-original-title="Expand"></i></a>';

    if($('#' + trName).length != 0)
        return;

    closeIOWAnalysis(x);
    if ($('#' + sName + key1 + '_type_' + iARowid).val() == "R") {
        iResId = isNullCheck($('#' + sName + key1 + '_reskeyid_' + iARowid).val(),'number');

        if (iResId == 0 || $('#' + sName + key1 + '_restypeid_' + iARowid).val() != 4)
            return;

        $('#' + trName).remove();
        $('#' + aLink).remove();
        $('#' + x).closest('tr').after('<tr id="'+trName+'" style="display:none;">').next().append('<td colspan="12" class="paintSubTr">').children('td').append('<div class="subDiv" style="display: none;">').children().html($('#dummyactivity').html());
        $('#' + sName + key1 + '_resdel_' + iARowid).after(expandLink);

        var objR = $.grep(arrActivityRes, function (element, index) {
            return element.activityid == iResId;
        });

        var dmQty =  parseFloat(objR[0].analysisMQty),
            daQty =  parseFloat(objR[0].analysisMQty);
        if (dmQty ==0) { dmQty=1;}
        if (daQty ==0) { daQty=1;}

        if (sRateType != "") { $('#analrate').val(sRateType); }
        else { $('#analrate').val(objR[0].ratetype); }
        $('#analrateL').val(objR[0].lRate);
        $('#analrateM').val(objR[0].mRate);
        $('#analrateA').val(objR[0].aRate);
        $('#activityAnalQty').val(dmQty);
        $('#activityRAnalQty').val(daQty);

        var objAS = $.grep(arrActivityAnal, function (element, index) {
            return element.activityid == iResId && element.activitytype == 'M';
        });

        var k = 0;
        var sOldid = "_1";
        var dmAmt=0;

        for (j = 0; j < objAS.length; j++) {
            k = k + 1;
            var sNewid = "_" + k;
            if (k != 1) {
                $("#activityrestable tbody.sorting tr:last").after("<tr>" + $("#activityrestable tbody tr:first").html() + "</tr>");

                $("#activityrestable tbody.sorting tr:last").find("input:text").each(function () {
                    $(this).attr("name", $(this).attr("name").replace(sOldid, sNewid));
                    $(this).attr("id", $(this).attr("id").replace(sOldid, sNewid));
                });

                $("#activityrestable tbody.sorting tr:last").find("select").each(function () {
                    $(this).attr("name", $(this).attr("name").replace(sOldid, sNewid));
                    $(this).attr("id", $(this).attr("id").replace(sOldid, sNewid));
                });

                $("#activityrestable tbody.sorting tr:last").find("input:hidden").each(function () {
                    $(this).attr("name", $(this).attr("name").replace(sOldid, sNewid));
                    $(this).attr("id", $(this).attr("id").replace(sOldid, sNewid));
                });
            }

            $('#activityresid_' + k).val(objAS[j]['resourcename']);
            $('#activityresunit_' + k).val(objAS[j]['unitname']);
            $('#activityresqty_' + k).val(objAS[j]['qty']);
            $('#activityresrate_' + k).val(objAS[j]['rate']);
            $('#activityresamt_' + k).val(objAS[j]['amount']);

            dmAmt = dmAmt + parseFloat(objAS[j]['amount']);

            $('#arowinfoid').val(k);
        }

        $('#activitytotrate').val(dmAmt.toFixed(2));
        var dmRate = dmAmt/dmQty;
        $('#activityperrate').val(dmRate.toFixed(2));
        $('#analrateM').val(dmRate.toFixed(2));

        var objAR = $.grep(arrActivityAnal, function (element, index) {
            return element.activityid == iResId && element.activitytype == 'A';
        });

        var k = 0;
        var daAmt=0;
        for (j = 0; j < objAR.length; j++) {
            k = k + 1;
            var sNewid = "_" + k;
            if (k != 1) {
                $("#activityRrestable tbody.sorting tr:last").after("<tr>" + $("#activityRrestable tbody tr:first").html() + "</tr>");

                $("#activityRrestable tbody.sorting tr:last").find("input:text").each(function () {
                    $(this).attr("name", $(this).attr("name").replace(sOldid, sNewid));
                    $(this).attr("id", $(this).attr("id").replace(sOldid, sNewid));
                });

                $("#activityRrestable tbody.sorting tr:last").find("select").each(function () {
                    $(this).attr("name", $(this).attr("name").replace(sOldid, sNewid));
                    $(this).attr("id", $(this).attr("id").replace(sOldid, sNewid));
                });


                $("#activityRrestable tbody.sorting tr:last").find("input:hidden").each(function () {
                    $(this).attr("name", $(this).attr("name").replace(sOldid, sNewid));
                    $(this).attr("id", $(this).attr("id").replace(sOldid, sNewid));
                });
            }

            $('#activityRresid_' + k).val(objAR[j]['resourcename']);
            $('#activityRresunit_' + k).val(objAR[j]['unitname']);
            $('#activityRresqty_' + k).val(objAR[j]['qty']);
            $('#activityRresrate_' + k).val(objAR[j]['rate']);
            $('#activityRresamt_' + k).val(objAR[j]['amount']);

            daAmt = daAmt + parseFloat(objAR[j]['amount']);
            $('#arowinfoidR').val(k);
        }

        $('#activityRtotrate').val(daAmt.toFixed(2));
        var daRate = daAmt/daQty;
        $('#activityRperrate').val(daRate.toFixed(2));
        $('#analrateA').val(daRate.toFixed(2));

        $('#activitymachinery').hide();
        $('#activityRrestable').hide();
        $('#activitymanual').show();
        $('#activityrestable').show();
    } else if ($('#' + sName + key1 + '_type_' + iARowid).val() == "I") {

        iResId = isNullCheck($('#' + sName + key1 + '_iowkeyid_' + iARowid).val(),'number');

        if (iResId == 0 ) return;

        $('#' + trName).remove();
        $('#' + aLink).remove();
        $('#'+ x).closest('tr').after('<tr id="'+trName+'" style="display:none;">').next().append('<td colspan="12" class="paintSubTr">').children('td').append('<div class="subDiv" style="display: none;">').children().html($('#dummysubiow').html());
        $('#' + sName + key1 + '_resdel_' + iARowid).after(expandLink);

        var objR = $.grep(arrSubIOW, function (element, index) {
            return element.subiowid == iResId;
        });

        var dsQty =  parseFloat(objR[0].workingqty);
        var drQty =  parseFloat(objR[0].rworkingqty);
        if (dsQty ==0) { dsQty=1;}
        if (drQty ==0) { drQty=1;}

        if (sRateType != "") { $('#analrate').val(sRateType); }
        else { $('#analrate').val(objR[0].mixtype); }
        $('#srateanalAQty').val(objR[0].cementratio);
        $('#srateanalBQty').val(objR[0].sandratio);
        $('#srateanalCQty').val(objR[0].metalratio);
        $('#srateanalthick').val(objR[0].thickqty);

        $('#srateanalAnalQty').val(dsQty);
        $('#srateanalRAnalQty').val(drQty);

        var objAS = $.grep(arrSubIOWAnal, function (element, index) {
            return element.subiowid == iResId && element.mixtype != 'R';
        });

        var dsAmt=0;
        var k = 0;
        var sOldid = "_1"
        for (j = 0; j < objAS.length; j++) {
            k = k + 1;
            var sNewid = "_" + k;
            if (k != 1) {
                $("#srateanalrestable tbody.sorting tr:last").after("<tr>" + $("#srateanalrestable tbody tr:first").html() + "</tr>");

                $("#srateanalrestable tbody.sorting tr:last").find("input:text").each(function () {
                    $(this).attr("name", $(this).attr("name").replace(sOldid, sNewid));
                    $(this).attr("id", $(this).attr("id").replace(sOldid, sNewid));
                });

                $("#srateanalrestable tbody.sorting tr:last").find("select").each(function () {
                    $(this).attr("name", $(this).attr("name").replace(sOldid, sNewid));
                    $(this).attr("id", $(this).attr("id").replace(sOldid, sNewid));
                });

                $("#srateanalrestable tbody.sorting tr:last").find("input:hidden").each(function () {
                    $(this).attr("name", $(this).attr("name").replace(sOldid, sNewid));
                    $(this).attr("id", $(this).attr("id").replace(sOldid, sNewid));
                });
            }

            $('#srateanalinc_' + k).val(objAS[j]['includeflag']);
            $('#srateanalref_' + k).val(objAS[j]['referenceid']);
            $('#srateanalresid_' + k).val(objAS[j]['resourcename']);
            $("label[for='srateanalresunit_" + k + "']").html(objAS[j]['unitname']);
            $('#srateanalresqty_' + k).val(objAS[j]['qty']);
            $('#srateanalresrate_' + k).val(objAS[j]['rate']);
            $('#srateanalresamt_' + k).val(objAS[j]['amount']);
            $('#srateanalformula_' + k).val(objAS[j]['formula']);

            dsAmt = dsAmt + parseFloat(objAS[j]['amount']);

            $('#srowinfoid').val(k);
        }

        $('#srateanaltotrate').val(dsAmt.toFixed(2));
        var dsRate = dsAmt/dsQty;
        $('#srateanalperrate').val(dsRate.toFixed(2));
        $('#srateanalnetrate').val(dsRate.toFixed(2));


        var objAR = $.grep(arrSubIOWAnal, function (element, index) {
            return element.subiowid == iResId && element.mixtype == 'R';
        });

        var drAmt =0;
        var k = 0;
        for (j = 0; j < objAR.length; j++) {
            k = k + 1;
            var sNewid = "_" + k;
            if (k != 1) {
                $("#srateanalRrestable tbody.sorting tr:last").after("<tr>" + $("#srateanalRrestable tbody tr:first").html() + "</tr>");

                $("#srateanalRrestable tbody.sorting tr:last").find("input:text").each(function () {
                    $(this).attr("name", $(this).attr("name").replace(sOldid, sNewid));
                    $(this).attr("id", $(this).attr("id").replace(sOldid, sNewid));
                });

                $("#srateanalRrestable tbody.sorting tr:last").find("select").each(function () {
                    $(this).attr("name", $(this).attr("name").replace(sOldid, sNewid));
                    $(this).attr("id", $(this).attr("id").replace(sOldid, sNewid));
                });

                $("#srateanalRrestable tbody.sorting tr:last").find("input:hidden").each(function () {
                    $(this).attr("name", $(this).attr("name").replace(sOldid, sNewid));
                    $(this).attr("id", $(this).attr("id").replace(sOldid, sNewid));
                });
            }

            $('#srateanalRinc_' + k).val(objAR[j]['includeflag']);
            $('#srateanalRref_' + k).val(objAR[j]['referenceid']);
            $('#srateanalRresid_' + k).val(objAR[j]['resourcename']);
            $("label[for='srateanalRunit_" + k + "']").html(objAR[j]['unitname']);
            $('#srateanalRresqty_' + k).val(objAR[j]['qty']);
            $('#srateanalRresrate_' + k).val(objAR[j]['rate']);
            $('#srateanalRresamt_' + k).val(objAR[j]['amount']);
            $('#srateanalRformula_' + k).val(objAR[j]['formula']);

            drAmt = drAmt + parseFloat(objAR[j]['amount']);

            $('#srowinfoidR').val(k);
        }

        $('#srateanalRtotrate').val(drAmt.toFixed(2));
        var drRate = drAmt/drQty;
        $('#srateanalRperrate').val(dsRate.toFixed(2));
        $('#srateanalRnetrate').val(dsRate.toFixed(2));

        $('#sraworkRtable').hide();
        $('#srateanalRrestable').hide();

        $('#sraworktable').show();
        $('#srateanalrestable').show();
    }
    expandResSubTr(trName, aLink);
}

function DeleteResRow()
{
    var k=0;

    if (bSiteMix == true) {
        var iRows = $('#rowinfoid_' + iFocusRowId).val();
    }
    else {
        var iRows = $('#rowinfoidR_' + key1).val();
    }

    for (i = 1; i <= iRows; i++) {
        if (bSiteMix == true) {
            var sTable = '#rateanal_' + iFocusRowId + 'RowId_' + i;
        }
        else {
            var sTable = '#rateanalR_' + iFocusRowId + 'RowId_' + i;
        }

        if ($(sTable).hasClass('selected') == true) {
            k=+k+1;
            break;
        }
    }

    if (k!=0) {

        if (confirm('Do you want to Delete, Selected Rows')) {
            for (i = 1; i <= iRows; i++) {
                if (bSiteMix == true) {
                    var sTable = '#rateanal_' + iFocusRowId + '_RowId_' + i;
                }
                else {
                    var sTable = '#rateanalR_' + iFocusRowId + '_RowId_' + i;
                }

                if ($(sTable).hasClass('selected') == true) {
                    if (i!=1) {
                        $(sTable).remove();
                    }
                }
            }
        }
    }
    else
    {
        alert ('No Row Selected');
    }
}

var fixHelperModified = function(e, tr) {
        var $originals = tr.children();
        var $helper = tr.clone();
        $helper.children().each(function(index) {
            $(this).width($originals.eq(index).width())
        });
        return $helper;
    },
    updateIndex = function(e, ui) {
        $('td.index', ui.item.parent()).each(function (i) {
            $(this).html(i + 1);
        });
    };

function AddNewRowRes(name) {
    var arrname = name.split('_'),
        iowId = arrname[1],
        key1 = arrname[3];

    var sRow = '#newiow_'+ iowId +'_rowinfoid_' + key1,
        irowinfoId  = $(sRow).val();

    irowinfoId = +irowinfoId + 1;
    var sNewid = "_" + irowinfoId,
        stabelrow = '#newiow_'+ iowId +'_rateanal_'+key1 + '_restable',
        sStr= '<tr id="newiow__0_rateanal__1_RowId__9">' + $("#newiow__0_rateanal__1_RowId__9").html() + '</tr>';

    sStr = sStr.replace(/__0/g,'_'+ iowId);
    sStr = sStr.replace(/__1/g,'_'+ key1);
    sStr = sStr.replace(/__9/g,'_'+ irowinfoId);
    sStr = sStr.replace(/R1/g,'R'+ irowinfoId);
    $(stabelrow+" > tbody.sorting > tr:last-child").after(sStr);
    $('#newiow_'+ iowId +'_rateanal_' + key1 + '_refid_' + irowinfoId).val(irowinfoId);

    checkResource(name,"");
    bindResourceAutoComplete(true);
    bindMixSortablefn(true);

    $(sRow).val(irowinfoId);
    SortOrder(name);

    return true;
}


function AddNewRowIOW()
{
    var sRow = '#rowinfoid_' + iFocusRowId;
    var irowinfoId  = $(sRow).val();
    var sOldid = "_1";
    irowinfoId = +irowinfoId + 1;
    var sNewid = "_" + irowinfoId;

    var stabelrow = '#rateanal_'+iFocusRowId + '_restable';

    var sStr= '<tr id="rateanal__1_RowId__9">' + $("#rateanal__1_iow__9").html() + '</tr>';

    sStr = sStr.replace(/__1/g,'_'+ iFocusRowId);
    sStr = sStr.replace(/__9/g,'_'+ irowinfoId);
    sStr = sStr.replace(/R1/g,'R'+ irowinfoId);

    $(stabelrow+" tbody tr:last").after(sStr);

    $(sRow).val(irowinfoId);
}


function AddNewRowIOWR()
{
    var sRow = '#rowinfoidR_' + iFocusRowId;
    var irowinfoId  = $(sRow).val();
    var sOldid = "_1";
    irowinfoId = +irowinfoId + 1;
    var sNewid = "_" + irowinfoId;

    var stabelrow = '#rateanalR_'+iFocusRowId + 'restable';

    var sStr= '<tr id="rateanalR__1_RowId__9">' + $("#rateanalR__1_iow__9").html() + '</tr>';

    sStr = sStr.replace(/__1/g,'_'+ iFocusRowId);
    sStr = sStr.replace(/__9/g,'_'+ irowinfoId);
    sStr = sStr.replace(/R1/g,'R'+ irowinfoId);
    $(stabelrow+" tbody tr:last").after(sStr);
    $(stabelrow+" tbody tr:last").after(sStr);

    $(sRow).val(irowinfoId);
}

function AddNewRowResHeader(x) {
    var sStr = x.id.split("_"),
        iowId = sStr[1],
        key1 = sStr[3],
        iARowid = sStr[5];
    irowinfoId = iARowid;

    var sValue = $('#newiow_'+ iowId +'_rateanal_' + key1 + '_resid_' + iARowid).val(),
        sOldid = "_1";
    irowinfoId = +irowinfoId + 1;
    var sNewid = "_" + irowinfoId,
        stabelrow = '#newiow_'+ iowId +'_rateanal_'+key1 + '_restable',
        sStr= '<tr id="rateanal__1_RowId__9">' + $("#rateanal__1_header__9").html() + '</tr>';

    sStr = sStr.replace(/__1/g,'_'+ key1);
    sStr = sStr.replace(/__9/g,'_'+ irowinfoId);

    $(stabelrow+" tbody.sorting  tr:nth-child(" + (irowinfoId - 1) + ")").before(sStr);
    $('.autocomplete-suggestions').hide();

    $('#newiow_'+ iowId +'_rateanal_' + key1 + '_resdes_' + (irowinfoId)).val(sValue);
    $('#newiow_'+ iowId +'_rateanal_' + key1 + '_resid_' + iARowid).val("");

    SortOrder(x);
}

function AddNewRowResHeaderR() {
    var sRow = '#rowinfoidR_' + iFocusRowId;
    var irowinfoId  = $(sRow).val();
    var sOldid = "_1";
    irowinfoId = +irowinfoId + 1;
    var sNewid = "_" + irowinfoId;

    var stabelrow = '#rateanalR_'+iFocusRowId + '_restable';

    var sStr= '<tr id="rateanalR__1_RowId__9">' + $("#rateanalR__1_header__9").html() + '</tr>';

    sStr = sStr.replace(/__1/g,'_'+ iFocusRowId);
    sStr = sStr.replace(/__9/g,'_'+ irowinfoId);
    //sStr = sStr.replace(/R1/g,'R'+ irowinfoId);
    $(stabelrow+" tbody.sorting  tr:last").before(sStr);

    $(sRow).val(irowinfoId);
}

function closeactivity() {
    $('#resactvity').remove();
}

function AddNewRowResR(name) {
    var arrname = name.split('_'),
        iowId = arrname[1],
        key1 = arrname[3],
        $sRow = $('#newiow_'+ iowId +'_rowinfoidR_' + key1),
        irowinfoId  = $sRow.val();

    irowinfoId = +irowinfoId + 1;
    var stabelrow = '#newiow_'+ iowId +'_rateanalR_'+key1 + '_restable',
        sStr= '<tr id="newiow__0_rateanalR__1_RowId__9">' + $("#newiow__0_rateanalR__1_RowId__9").html() + '</tr>';

    sStr = sStr.replace(/__0/g,'_'+ iowId);
    sStr = sStr.replace(/__1/g,'_'+ key1);
    sStr = sStr.replace(/__9/g,'_'+ irowinfoId);
    sStr = sStr.replace(/R1/g,'R'+ irowinfoId);
    $(stabelrow+" tbody.sorting > tr:last-child").after(sStr);

    checkResource(name,"R");
    bindResourceAutoComplete();
    bindMixSortablefn(true);
    $sRow.val(irowinfoId);
    SortOrderR(name);
}

function ValueChange(x) {
    var keys = x.split("_"),
        iowId = keys[1],
        key1 = keys[3],
        iARowid = keys[5],
        name = '#newiow_'+ iowId +'_rateanal_' + key1,
        iRows = $('#newiow_'+ iowId +'_rowinfoid_' + key1).val(),
        sname = x.split("_")[2];

    if (sname.substr(sname.length-1) ==  "R") {
        name = '#newiow_'+ iowId +'_rateanalR_' + key1;
        iRows = $('#newiow_'+ iowId +'_rowinfoidR_' + key1).val();
    }

    var dQty =  $(name + "_resqty_" + iARowid).val(),
        dRate =  $(name + "_resrate_" + iARowid).val(),
        dAmt = dQty*dRate;

    $(name + "_resamt_" + iARowid).val(parseFloat(dAmt).toFixed(2));

    var dTAmt = 0;
    for (var i = 1; i <= iRows; i++) {
        if ($(name + '_inc_' + i).is(':checked') == true) {
            var val = ($(name + "_resamt_" + i).val() == "") ? 0 : $(name + "_resamt_" + i).val();
            dTAmt = dTAmt + parseFloat(val);
        }
    }
    $(name + '_totrate').val(parseFloat(dTAmt).toFixed(2));

    var dAnalQty = $(name + '_AnalQty').val();
    if (dAnalQty.length==0 || dAnalQty==0 || dAnalQty == "Working Qty") { dAnalQty = 1; $(name + '_AnalQty').val(dAnalQty);}

    var dNetRate = dTAmt/dAnalQty;

    $(name + '_perrate').val(parseFloat(dNetRate).toFixed(2));
    $(name + '_netrate').val(parseFloat(dNetRate).toFixed(2));

    var dFRate=0;

    if ($('#newiow_'+ iowId +'_mixtab_' + key1).is(":hidden"))
        dFRate = $('#newiow_'+ iowId +'_rateanal_' + key1 + '_netrate').val();
    else {
        var sVal = $('#newiow_'+ iowId +'_ratetype_' + key1).val();
        if (sVal=="R")
            dFRate = $('#newiow_'+ iowId +'_rateanalR_' + key1 + '_netrate').val();
        else
            dFRate = $('#newiow_'+ iowId +'_rateanal_' + key1 + '_netrate').val();
    }
    MixRateUpdate('#newiow_'+ iowId +'_rate_'+ key1);
}

function CalculateFull(x) {
    var keys = x.split("_"),
        iowId = keys[1],
        key1 = keys[3];
    //SiteMix
    var iRows = $('#newiow_'+ iowId +'_rowinfoid_' + key1).val();
    var dTAmt = 0;
    for (i = 1; i <= iRows; i++) {
        var dAmt = parseFloat(  isNullCheck($("#newiow_"+ iowId +"_rateanal_" + key1 + "_resqty_" + i).val(),'number')) *  parseFloat( isNullCheck( $("#newiow_"+ iowId +"_rateanal_" + key1 + "_resrate_" + i).val(),'number'));
        $('#newiow_'+ iowId +'_rateanal_' + key1 + '_resamt_' + i).val(parseFloat(dAmt).toFixed(2));
        if ($('#newiow_'+ iowId +'_rateanal_' + key1 + '_inc_' + i).is(':checked') == true) {
            dTAmt = dTAmt + parseFloat( isNullCheck($("#newiow_"+ iowId +"_rateanal_" + key1 + "_resamt_" + i).val(),'number'));
        }
    }
    $('#newiow_'+ iowId +'_rateanal_' + key1 + '_totrate').val(parseFloat(dTAmt).toFixed(2));

    var dAnalQty = isNullCheck($('#newiow_'+ iowId +'_rateanal_' + key1 + '_AnalQty').val(),'number');
    if (dAnalQty.length==0 || dAnalQty==0) { dAnalQty = 1; $('#newiow_'+ iowId +'_rateanal_' + key1 + '_AnalQty').val(dAnalQty);}

    var sUnit = $('select[name=newiow_'+ iowId +'_unitid_' + key1 + '] option:selected').text();

    $('#newiow_'+ iowId +'_rateanal_' + key1 + 'ltotrate').val('Rate for ' + dAnalQty + ' ' + sUnit);
    $('#newiow_'+ iowId +'_rateanal_' + key1 + 'lperrate').val('Rate per ' + sUnit);

    var dNetRate = dTAmt/dAnalQty;

    $('#newiow_'+ iowId +'_rateanal_' + key1 + '_perrate').val(parseFloat(dNetRate).toFixed(2));
    $('#newiow_'+ iowId +'_rateanal_' + key1 + '_netrate').val(parseFloat(dNetRate).toFixed(2));

    //Readymix
    var iRows = $('#newiow_'+ iowId +'_rowinfoidR_' + key1).val();
    var dTAmt = 0;
    for (i = 1; i <= iRows; i++) {

        var dAmt = parseFloat(isNullCheck($("#newiow_"+ iowId +"_rateanalR_" + key1 + "_resqty_" + i).val(),'number')) *  parseFloat(isNullCheck($("#newiow_"+ iowId +"_rateanalR_" + key1 + "_resrate_" + i).val(),'number'));
        $('#newiow_'+ iowId +'_rateanalR_' + key1 + '_resamt_' + i).val(parseFloat(dAmt).toFixed(2));

        if ($('#newiow_'+ iowId +'_rateanalR_' + key1 + 'inc_' + i).is(':checked') == true) {
            dTAmt = dTAmt + parseFloat( isNullCheck($("#newiow_"+ iowId +"_rateanalR_" + key1 + "_resamt_" + i).val(),'number'));
        }
    }
    $('#newiow_'+ iowId +'_rateanalR_' + key1 + '_totrate').val(parseFloat(dTAmt).toFixed(2));

    var dAnalQty = isNullCheck($('#newiow_'+ iowId +'_rateanalR_' + key1 + '_AnalQty').val(),'number');
    if (dAnalQty.length==0 || dAnalQty==0) { dAnalQty = 1; $('#newiow_'+ iowId +'_rateanalR_' + key1 + '_AnalQty').val(dAnalQty);}

    var sUnit = $('select[name=newiow_'+ iowId +'_unitid_' + key1 + '] option:selected').text();

    $('#newiow_'+ iowId +'_rateanalR_' + key1 + 'ltotrate').val('Rate for ' + dAnalQty + ' ' + sUnit);
    $('#newiow_'+ iowId +'_rateanalR_' + key1 + 'lperrate').val('Rate per ' + sUnit);

    var dNetRate = dTAmt/dAnalQty;

    $('#newiow_'+ iowId +'_rateanalR_' + key1 + '_perrate').val(parseFloat(dNetRate).toFixed(2));
    $('#newiow_'+ iowId +'_rateanalR_' + key1 + '_netrate').val(parseFloat(dNetRate).toFixed(2));

    var dFRate=0;

    if ($('#newiow_'+ iowId +'_mixtab_' + key1).is(":hidden"))
        dFRate = $('#newiow_'+ iowId +'_rateanal_' + key1 + '_netrate').val();
    else {
        var sVal = $('#newiow_'+ iowId +'_ratetype_' + key1).val();
        if (sVal=="R")
            dFRate = $('#newiow_'+ iowId +'_rateanalR_' + key1 + '_netrate').val();
        else
            dFRate = $('#newiow_'+ iowId +'_rateanal_' + key1 + '_netrate').val();
    }
    MixRateUpdate('#newiow_'+ iowId +'_rate_'+ key1);
}

function ChangeIOWs(x)
{
    closedetails();
    var sStr = x.split("_");
    var iowRowId = sStr[1],
        iARowid = sStr[3];

    if ($('#newiow_'+iowRowId+'_unitid_'+iARowid).val().length >0) {
        $('#newiow_'+iowRowId+'_but_'+iARowid).prop('disabled', false);
        $('#newiow_'+iowRowId+'_rate_'+iARowid).prop('readonly', false);
    } else {
        $('#newiow_'+iowRowId+'_unitid_'+iARowid).val(0);
        $('#newiow_'+iowRowId+'_but_'+iARowid).prop('disabled', true);
        $('#newiow_'+iowRowId+'_rate_'+iARowid).prop('readonly', true);
    }
}

function CheckSerialNo(x) {
    var sStr = x.split("_"),
        iowRowId = sStr[1],
        iARowid = sStr[3],
        iParentkeyId = $('#newiow_'+iowRowId+'_parentkeyid_' + iARowid).val(),
        sRefSlNo =  $('#newiow_'+iowRowId+'_refserialno_' + iARowid).val().trim(),
        sSlNo =  $('#newiow_'+iowRowId+'_serialno_' + iARowid).val().trim();

    $.post( getBaseURL() + 'project/rfc/checkserialfound', {serialno:sSlNo}, function( data ) {
        if (data == "Y") {
            $('#newiow_'+iowRowId+'_refserialno_' + iARowid).addClass('error').attr('data-original-title', 'Serial no. already used').attr('data-toggle', 'tooltip');
            $('#newiow_'+iowRowId+'_serialno_' + iARowid).val("");
            return;
        }
    });

    var irows = $('#newIOW_'+iowRowId+' tr').length-1;
    for (var i = 1; i <= irows; i++) {

        $('#newiow_'+iowRowId+'_refserialno_' + iARowid).removeClass('error');

        if (i != iARowid)
        {
            if (iParentkeyId ==  $('#newiow_'+iowRowId+'_parentkeyid_' + i).val())
            {
                if (sRefSlNo == $('#newiow_'+iowRowId+'_refserialno_' + i).val().trim())
                {
                    $('#newiow_'+iowRowId+'_refserialno_' + iARowid).addClass('error').after('<div class="error_tol"><span class="tool-top">Serial No Already Used</span></div>');
                    $('#newiow_'+iowRowId+'_serialno_' + iARowid).val("");
                    break;
                }
            }
        }
    }
}

function SerialUpdate(x) {
    var sStr = x.split("_"),
        iowRowId = sStr[1],
        iARowid = sStr[3],
        sParentText=  $('#newiow_'+iowRowId+'_parentid_'+iARowid).val(),
        sSerialNo = sParentText.split(" ")[0],
        aSNo = sSerialNo.split('.'),
        refserialno = $('#newiow_'+iowRowId+'_refserialno_' + iARowid).val(),
        $serialno = $('#newiow_'+iowRowId+'_serialno_' + iARowid);

    if (aSNo[1] == "0")
        sSerialNo = aSNo[0];

    if (refserialno != ""  && $('#newiow_'+iowRowId+'_parentid_'+ iARowid).val().length>0)
    {
        var sSerialNo = sSerialNo + '.' + refserialno;
        $serialno.val(sSerialNo);
    } else
        $serialno.val("");

    var sField = sStr[0];

    if (sField == "parentid") {
        var iWGId =  aSNo[0];
        if (iWGId != 'Add') {GetWorkGroupDetails(iWGId,x)}
    }

    CheckSerialNo(x);
}

function cboIOWChanged(ival,iowId,ifRowid, iARowid,itype) {
    iFocusRowId = ifRowid;
    var name = "newiow_"+iowId+"_rateanal_";
    if (itype == "R")
        name = "newiow_"+iowId+"_rateanalR_";

    $.ajax({
        url: getBaseURL() + "project/rfc/getiowunit/"+ival,
        async: false,
        type: 'post',
        success: function(data,status) {

            var obj = jQuery.parseJSON(data),
                objD = obj['details'],
                objT = obj['trans'],
                objA = obj['activity'];

            $("label[for='" + name + iFocusRowId + "_resunit_" + iARowid + "']").html(objD[0].UnitName);
            var dIRate=0;
            if (objT['MixType'] == "R") { dIRate= parseFloat(objT['RRate']); }
            else  { dIRate= parseFloat(objT['SRate']); }

            $("#" + name + iFocusRowId + "_resrate_" + iARowid).val(dIRate.toFixed(2));

            var objF = $.grep(arrSubIOW, function (element, index) {
                return element.subiowid == ival;
            });

            if  (objF.length ==0) {

                arrSubIOW.push({
                    subiowid: ival,
                    mixtype: objT['MixType'],
                    srate: objT['SRate'],
                    rrate: objT['RRate'],
                    workingqty: objT['WorkingQty'],
                    cementratio: objT['CementRatio'],
                    metailratio: objT['MetalRatio'],
                    sandratio: objT['SandRatio'],
                    thickqty: objT['ThickQty'],
                    rworkingQty: objT['RWorkingQty']
                });
                for (j = 0; j < objA.length; j++) {

                    var irows = $('#resourcerate tr').length;
                    var bFound=false;
                    var iResid = objA[j]['ResourceId'];
                    var dRate=parseFloat(objA[j]['Rate']);
                    for (i = 1; i <= irows; i++) {
                        if ($('#newiow_'+iowId+'_rateresid').val == iResid) {
                            bFound = true;
                            dRate = parseFloat($('#newiow_'+iowId+'_rateresrate_' + i).val());
                            break;
                        }
                    }

                    if (bFound==false) { RateResourceUpdate(objA[j]['ResourceName'], objA[j]['UnitName'], dRate, iResid); }

                    arrSubIOWAnal.push({
                        subiowid: ival,
                        mixtype: objA[j]['MixType'],
                        includeflag: objA[j]['IncludeFlag'],
                        referenceid: objA[j]['ReferenceId'],
                        code: objA[j]['Code'],
                        resourcename: objA[j]['ResourceName'],
                        unitname: objA[j]['UnitName'],
                        resourceid: objA[j]['ResourceId'],
                        qty: objA[j]['Qty'],
                        rate: objA[j]['Rate'],
                        amount: parseFloat(objA[j]['Qty'])*dRate,
                        formula: objA[j]['Formula']
                    });
                }
            }
        }
    });
}

function cboResChanged(ival,iowId,ifRowid,iARowid,rtype) {
    iFocusRowId=ifRowid;
    if (ival.trim() !='') {

        var irows = $('#resourcerate tr').length;
        var bFound=false;
        var dRate=0;
        for (i = 1; i <= irows; i++) {
            if ($('#newiow_'+iowId+'_rateresid').val == ival) {
                bFound = true;
                dRate = $('#newiow_'+iowId+'_rateresrate_' + i).val();
                break;
            }
        }
        var name = "newiow_"+iowId+"_rateanal_";
        if (rtype == "R")
            name = "newiow_"+iowId+"_rateanalR_";

        $.ajax({
            url: getBaseURL() + "project/rfc/getresourceunit/"+ival,
            async: false,
            type: 'post',
            success: function(data,status) {

                var obj = jQuery.parseJSON(data);
                var objD = obj['details'];

                var objT = obj['trans'];
                var objA = obj['activity'];

                $("label[for= '" + name + iFocusRowId + "_resunit_" + iARowid + "']").html(objD[0].UnitName);
                $("#" + name + iFocusRowId + "_restypeid_" + iARowid).val(objD[0].TypeId);
                if (bFound == true) {
                    $("#" + name + iFocusRowId + "_resrate_" + iARowid).val(parseFloat(dRate).toFixed(2));
                }
                else {
                    $("#" + name + iFocusRowId + "_resrate_" + iARowid).val(parseFloat(objD[0].Rate).toFixed(2));
                    var resName = $("#" + name + iFocusRowId + "_resid_" + iARowid).val();
                    RateResourceUpdate(resName, objD[0].UnitName, parseFloat(objD[0].Rate).toFixed(2), ival)
                }


                var objF = $.grep(arrActivityRes, function (element, index) {
                    return element.activityid == ival;
                });

                if  (objF.length ==0 && objD[0].TypeId==4) {
                    arrActivityRes.push({
                        activityid: ival,
                        ratetype: objT['RateType'],
                        lRate: objT['LRate'],
                        mRate: objT['MRate'],
                        aRate: objT['MRate'],
                        analysisMQty: objT['AnalysisMQty'],
                        analysisAQty: objT['AnalysisAQty']
                    });

                    for (var j = 0; j < objA.length; j++) {
                        var iResid = objA[j]['ResourceId'];
                        bFound=false;
                        var dRate=objA[j]['Rate'];
                        for (var i = 1; i <= irows; i++) {
                            if ($('#newiow_'+iowId+'_rateresid').val == iResid) {
                                bFound = true;
                                dRate = parseFloat($('#newiow_'+iowId+'_rateresrate_' + i).val());
                                break;
                            }
                        }
                        if (bFound==false) { RateResourceUpdate(objA[j]['ResourceName'], objA[j]['UnitName'], dRate, iResid); }

                        arrActivityAnal.push({
                            activityid: ival,
                            activitytype: objA[j]['ActivityType'],
                            resourceid: objA[j]['ResourceId'],
                            resourcename: objA[j]['ResourceName'],
                            unitname: objA[j]['UnitName'],
                            qty: objA[j]['Qty'],
                            rate: dRate,
                            amount: parseFloat(objA[j]['Qty'])*dRate
                        });
                    }
                }
            }
        });
    }
}

function rateUpdate(x){
    var keys = x.split("_"),
        iowId = keys[1],
        key1 = keys[3];
    var qty = parseFloat($('#newiow_'+ iowId +'_qty_' + key1).val()),
        rate = parseFloat($('#newiow_'+ iowId +'_rate_' + key1).val()),
        $amount = $('#newiow_'+ iowId +'_amt_' + key1);

    if (isNaN(rate))
        rate = 0;

    $amount.val(rate*qty);
    AddNewRowA(x);
}

function clickbut(x) {
    var keys = x.split("_"),
        iowId = keys[1],
        key1 = keys[3];

    if ($('#newiow_'+ iowId +'_irowid_'+ key1 +'+.subTr_' + key1).is(':visible'))
        return;

    $('.newiow_'+ iowId +'_mainTr_' + key1).trigger('click');
}

function CheckShowDetails(x) {
    var keys = x.split("_"),
        iowId = keys[1],
        key1 = keys[3],
        $mixtable = $('#newiow_'+ iowId +'_ramixtable_'+key1);

    if ($('#newiow_'+ iowId +'_concrete_' + key1).is(':checked') == false)
        $mixtable.hide();
    else
        $mixtable.show();
}

function closedetails(key) {
    var $mainTRs = $("a[class*=_mainTr_]");

    $.each($mainTRs, function (i, obj) {
        var $this = $(this),
            name = $this[0].className;

        if(name.indexOf('__') != -1)
            return;

        if (typeof key != 'undefined' && $this[0].className.split('_')[3] == key)
            return;

        var $mainTr = $this.find('> i.fa-chevron-circle-down.tform');
        if($mainTr.length != 0)
            $mainTr.trigger('click');
    });
}

function IOWUpdate() {
    var iMRowId = $('#rowid').val();
    ioRowId = iMRowId;
    var iRowTransId=1;
    var irows = $('#excelTable tr').length-1;
    for (i = 1; i <= irows; i++) {
        if ($('#excelrowtype_'+i).val() == "I")
        {
            ioRowId = iMRowId;
            if ($('#spec_' + iMRowId).val() != "") { iMRowId = + iMRowId+1;}

            if (iMRowId !=1) {
                var sStr = $('#dummytable tbody').html();

                sStr = sStr.replace(/__1/g, '_' + iMRowId);
                sStr = sStr.replace(/__9/g, '_1');

                if (ioRowId !=1) {ioRowId = (ioRowId*2)-1 ;}

                $('#sample12 > tbody > tr').eq(ioRowId).after(sStr);


            }

            var pId =$("#excelwgid_"+i).val();
            if ($("#excelparentid_"+i).val() !=0)
            {
                pId = pId + "." + $("#excelparentid_"+i).val()
            }

            $('#parentid_' + iMRowId).val(pId);
            $('#refserialno_' + iMRowId).val($('#excelrefslno_'+i).val());
            $('#serialno_' + iMRowId).val($('#excelserialno_'+ i).val());
            $('#spec_' + iMRowId).val($('#excelspec_'+ i).val());
            $('#unitid_' + iMRowId).val($('#excelunitid_'+ i).val());

            $('#rowid').val(iMRowId);

            iRowTransId=1;
        }
        else
        {
            if (iRowTransId!=1) {
                var stabelrow = '#rateanal_' + iMRowId + '_restable';
                var sStr = '<tr id="rateanal__1_RowId__9">' + $("#rateanal__1_RowId__9").html() + '</tr>';
                sStr = sStr.replace(/__1/g, '_' + iMRowId);
                sStr = sStr.replace(/__9/g, '_' + iRowTransId);
                sStr = sStr.replace(/R1/g, 'R' + iRowTransId);
                $(stabelrow+" tbody tr:nth-child(" + (iRowTransId - 1) + ")").after(sStr);
            }

            $('#rateanal_' + iMRowId + '_code_' + iRowTransId).val($('#excelcode_' + i).val());
            $('#rateanal_' + iMRowId + '_resid_' + iRowTransId).val($('#excelresid_' + i).val());
            $('#rateanal_' + iMRowId + '_resqty_' + iRowTransId).val($('#excelqty_' + i).val());
            $('#rateanal_' + iMRowId + '_resrate_' + iRowTransId).val($('#excelrate_' + i).val());
            $('#rateanal_' + iMRowId + '_resamt_' + iRowTransId).val($('#excelamount_' + i).val());

            $('#rowinfoid_' + iMRowId).val(iRowTransId);

            iRowTransId = +iRowTransId+1;
        }
    }

    bindAutoComplete(true);
    bindResourceAutoComplete(true);
    expandTrFn(true);
}

function fileupload(x)
{
    var bValid=true;
    var formData = new FormData();
    formData.append('file', $('#myfile').prop("files")[0]);
    $.ajax({
        url: getBaseURL() + "project/rfc/uploadiowdata",
        dataType: 'script',
        cache: false,
        contentType: false,
        processData: false,
        data: formData,
        type: 'post',
        success: function(data,status, xhr) {
            var obj = jQuery.parseJSON(data);

            if (obj[0].Valid==true) {

                var irows = $('#excelTable tr').length;
                var irow = irows - 1;
                var sOldid = "_1"

                for (i = 0; i < obj.length; i++) {

                    if ((irow != 1) || ( irow == 1 && $('#excelspec_1').val() != "")) {

                        irow = +irow + 1;
                        var sNewid = "_" + irow;

                        $("#excelTable tbody tr:last").after("<tr>" + $("#excelTable tbody tr:first").html() + "</tr>");

                        $("#excelTable tbody tr:last").find("input:text").each(function () {
                            $(this).attr("name", $(this).attr("name").replace(sOldid, sNewid));
                            $(this).attr("id", $(this).attr("id").replace(sOldid, sNewid));
                        });

                        $("#excelTable tbody tr:last").find("input:hidden").each(function () {
                            $(this).attr("name", $(this).attr("name").replace(sOldid, sNewid));
                            $(this).attr("id", $(this).attr("id").replace(sOldid, sNewid));
                        });
                    }

                    $("#excelserialno_" + irow).val(obj[i].SerialNo);
                    $("#excelcode_" + irow).val(obj[i].Code);
                    $("#excelspec_" + irow).val(obj[i].Specification);
                    $("#exceliows_" + irow).val(obj[i].IOWs);
                    $("#excelunit_" + irow).val(obj[i].UnitName);
                    $("#excelqty_" + irow).val(obj[i].Qty);
                    $("#excelrate_" + irow).val(obj[i].Rate);
                    $("#excelamount_" + irow).val(obj[i].Qty * obj[i].Rate);
                    $("#excelrefslno_" + irow).val(obj[i].RefSerialNo);
                    $("#excelrowtype_" + irow).val(obj[i].RowType);
                    $("#exceliowid_" + irow).val(obj[i].IOWId);
                    $("#excelparentid_" + irow).val(obj[i].ParentId);
                    $("#excelwgid_" + irow).val(obj[i].WGId);
                    $("#excelresid_" + irow).val(obj[i].ResourceId);
                    $("#excelunitid_" + irow).val(obj[i].UnitId);
                }
            }
            else
            {
                bValid=false;
            }

            if (bValid==true) {$("#excelmodal").modal('show');}
            else { alert("Invalid File Format"); }
        },
        error: function(xhr, status, errorThrown) {
            if (xhr.status == 400)
                alert(xhr.responseText);
            else
                alert(errorThrown);
        }
    });
}

function formulacalculation()
{
    var sformula = $("#formulaexp").val();
    var fvaule=0;

    if (sformula.length >0) {
        try {
            if  (bSiteMix==true) {
                var sCement = '#rateanal_' + iFocusRowId + '_AQty';
                var sSand = '#rateanal_' + iFocusRowId + '_BQty';
                var sMetal = '#rateanal_' + iFocusRowId + '_CQty';
                var sThick = '#rateanal_' + iFocusRowId + '_thick';
            }
            else
            {
                var sCement = '#rateanalR_' + iFocusRowId + '_AQty';
                var sSand = '#rateanalR_' + iFocusRowId + '_BQty';
                var sMetal = '#rateanalR_' + iFocusRowId + '_CQty';
                var sThick = '#rateanalR_' + iFocusRowId + '_thick';
            }

            sformula = sformula.replace(/cement/g, $(sCement).val());
            sformula = sformula.replace(/sand/g, $(sSand).val());
            sformula = sformula.replace(/metal/g, $(sMetal).val());
            sformula = sformula.replace(/thick/g, $(sThick).val());


            if  (bSiteMix==true) {
                var rows = $('#rowinfoid_' + iFocusRowId).val();
                for (i = 1; i <= rows; i++) {
                    if (i != iTransRowId) {
                        var sRef = $('label[for=rateanal_' + iFocusRowId + '_ref_' + iTransRowId + ']').html().trim();
                        var dAmt= $('#rateanal_' + iFocusRowId + '_resamt_' + iTransRowId).val();
                        sformula = sformula.replace(new RegExp(sRef, 'g'), dAmt);
                    }
                }
            }
            else
            {
                var rows = $('#rowinfoidR_' + iFocusRowId).val();
                for (i = 1; i <= rows; i++) {
                    if (i != iTransRowId) {
                        var sRef = $('label[for=rateanalR_' + iFocusRowId + '_ref_' + iTransRowId + ']').html().trim();
                        var dAmt= $('#rateanalR_' + iFocusRowId + '_resamt_' + iTransRowId).val();
                        sformula = sformula.replace(new RegExp(sRef, 'g'), dAmt);
                    }
                }
            }


            fvaule = computeEval(sformula);
            $('#btnformula').prop('disabled', false);
        }
        catch (e) {
            res = 'Expression Invalid.';
            $('#btnformula').prop('disabled', true);
            alert(res);
        }
    }
    $("#formulavalue").val(parseFloat(fvaule).toFixed(3));
}

function computeEval(formula) {

    with (document.forms){

        with (Math) {

            A = eval((formula));
        }

    } return A;

}

function showformulaR(x,bshow) {
    bSiteMix=false;
    var keys = x.split("_"),
        iowId = keys[1],
        key1 = keys[3],
        iRowId = keys[5];

    var sExp = "#newiow_"+ iowId +"_rateanalR_" + key1 + "_formula_" + iRowId;

    var sExpression = $(sExp).val();
    $("#formulaexp").val(sExpression)
    var sformula = $("#formulaexp").val();

    var fvaule=0;
    if (sformula.length >0) {
        try {
            var rows = $('#newiow_'+ iowId +'_rowinfoidR_' + key1).val();
            for (i = 1; i <= rows; i++) {
                if (i != iRowId) {
                    var sRef = $('label[for=newiow_'+ iowId +'_rateanalR_' + key1 + '_ref_' + iRowId + ']').html().trim();
                    var dAmt= $('#newiow_"+ iowId +"_rateanalR_' + key1 + '_resamt_' + iRowId).val();
                    sformula = sformula.replace(new RegExp(sRef, 'g'), dAmt);
                }
            }

            //fvaule = eval(sformula);
            fvaule = computeEval(sformula);
            $('#btnformula').prop('disabled', false);
        }
        catch (e) {
            res = 'Expression in invalid.';
            $('#btnformula').prop('disabled', true);
            alert(res);
        }

        $("#newiow_"+ iowId +"_rateanalR_" + key1 + "_resqty_" + iRowId).prop('readonly', true);

        $("#formulavalue").val(parseFloat(fvaule).toFixed(3));
        $("#formula").modal('show');
    } else if (bshow==true) {
        $("#newiow_"+ iowId +"_rateanalR_" + key1 + "_resqty_" + iRowId).prop('readonly', true);
        fvaule = $("#newiow_"+ iowId +"_rateanalR_" + key1 + "_resqty_" + iRowId).val();

        $("#formulaexp").val(fvaule);
        $("#formulavalue").val(parseFloat(fvaule).toFixed(3));
        $("#formula").modal('show');
    } else {
        var stype =  isNullCheck($('#newiow_'+ iowId + '_rateanalR_' + iFocusRowId + '_type_' + iTransRowId).val(),'string');

        if (stype=="R") {
            if ($('#newiow_'+ iowId + '_rateanalR_' + iFocusRowId + '_reskeyid_' + iTransRowId).val() != '0' && $('#newiow_'+ iowId + '_rateanalR_' + iFocusRowId + '_reskeyid_' + iTransRowId).val().length != 0) {
                $("#newiow_"+ iowId +"_rateanalR_" + iFocusRowId + "_resqty_" + iTransRowId).prop('readonly', false);
            }
        }
        else if (stype=="I") {
            if ($('#newiow_'+ iowId + '_rateanalR_' + iFocusRowId + '_iowkeyid_' + iTransRowId).val() != '0' && $('#newiow_'+ iowId + '_rateanalR_' + iFocusRowId + '_iowkeyid_' + iTransRowId).val().length != 0) {
                $("#newiow_"+ iowId +"_rateanalR_" + iFocusRowId + "_resqty_" + iTransRowId).prop('readonly', false);
            }
        }
    }
}

function showF(x,event) {
    if(event.keyCode ==113) {
        var keys = x.split("_"),
            resKeyId = $('#newiow_'+ keys[1] +'_rateanal_' + keys[3] + '_reskeyid_' + keys[5]).val();

        if (resKeyId != '0' && resKeyId.length !=0) {
            showformula(x, true);
        }
        event.preventDefault();

    }
}

function showFR(x,event) {
    if(event.keyCode ==113) {
        var keys = x.split("_"),
            resKeyId = $('#newiow_'+ keys[1] +'_rateanalR_' + keys[3] + '_reskeyid_' + keys[5]).val();

        if (resKeyId != '0' && resKeyId.length !=0) {
            showformulaR(x,true);
        }
        event.preventDefault();
    }
}

function showformula(x,bshow) {
    bSiteMix=true;

    var keys = x.split("_"),
        iowId = keys[1],
        key1 = keys[3],
        iRowId = keys[5];

    var sExp = "#newiow_"+ iowId +"_rateanal_" + key1 + "_formula_" + iRowId;

    var sExpression = $(sExp).val();

    $("#formulaexp").val(sExpression)
    var sformula = $("#formulaexp").val();

    var fvaule=0;
    if (sformula.length >0) {
        try {
            var sCement = '#newiow_'+ iowId + '_rateanal_' + key1 + '_AQty';
            var sSand = '#newiow_'+ iowId + '_rateanal_' + key1 + '_BQty';
            var sMetal = '#newiow_'+ iowId + '_rateanal_' + key1 + '_CQty';
            var sThick = '#newiow_'+ iowId + '_rateanal_' + key1 + '_thick';

            sformula = sformula.replace(/cement/g, $(sCement).val());
            sformula = sformula.replace(/sand/g, $(sSand).val());
            sformula = sformula.replace(/metal/g, $(sMetal).val());
            sformula = sformula.replace(/thick/g, $(sThick).val());

            var rows = $('#newiow_'+ iowId + '_rowinfoid_' + key1).val();
            for (i = 1; i <= rows; i++) {
                if (i != iRowId) {
                    var sRef = $('label[for=newiow_'+ iowId + '_rateanal_' + key1 + '_ref_' + iRowId + ']').html().trim();
                    var dAmt= $('#newiow_'+ iowId + '_rateanal_' + key1 + '_resamt_' + iRowId).val();
                    sformula = sformula.replace(new RegExp(sRef, 'g'), dAmt);
                }
            }

            //fvaule = eval(sformula);
            fvaule = computeEval(sformula);
            $('#btnformula').prop('disabled', false);
        }
        catch (e) {
            res = 'Expression in invalid.';
            $('#btnformula').prop('disabled', true);
            alert(res);
        }

        $("#newiow_"+ iowId + "_rateanal_" + key1 + "_resqty_" + iRowId).prop('readonly', true);

        $("#formulavalue").val(parseFloat(fvaule).toFixed(3));
        $("#formula").modal('show');
    }
    else if (bshow==true)
    {
        $("#newiow_"+ iowId + "_rateanal_" + key1 + "_resqty_" + iRowId).prop('readonly', true);
        fvaule = $("#newiow_"+ iowId + "_rateanal_" + key1 + "_resqty_" + iRowId).val();

        $("#formulaexp").val(fvaule);
        $("#formulavalue").val(parseFloat(fvaule).toFixed(3));
        $("#formula").modal('show');
    } else {
        var stype =  isNullCheck($('#newiow_'+ iowId + '_rateanal_' + key1 + '_type_' + iRowId).val(),'string');
        if (stype=="R") {
            if ($('#newiow_'+ iowId + '_rateanal_' + key1 + '_reskeyid_' + iRowId).val() != '0' && $('#newiow_'+ iowId + '_rateanal_' + key1 + '_reskeyid_' + iRowId).val().length != 0) {
                $("#newiow_"+ iowId + "_rateanal_" + key1 + "_resqty_" + iRowId).prop('readonly', false);
            }
        }
        else if (stype=="I") {
            if ($('#newiow_'+ iowId + '_rateanal_' + key1 + '_iowkeyid_' + iRowId).val() != '0' && $('#newiow_'+ iowId + '_rateanal_' + key1 + '_iowkeyid_' + iRowId).val().length != 0) {
                $("#newiow_"+ iowId + "_rateanal_" + key1 + "_resqty_" + iRowId).prop('readonly', false);
            }
        }
    }
}

function formulaok()
{
    if (bSiteMix == true) {
        var sExp = "#rateanal_" + iFocusRowId + "_formula_" + iTransRowId;
        var sqty = "#rateanal_" + iFocusRowId + "_resqty_" + iTransRowId;

        var sformulaexp = $("#formulaexp").val();
        var sformulaval = $("#formulavalue").val();

        if (sformulaexp != sformulaval) {
            $(sExp).val(sformulaexp);
        }
        else {
            $(sExp).val("");
        }

        $(sqty).val(parseFloat(sformulaval).toFixed(3));

        var sQtyRow = "#rateanal_" + iFocusRowId + "_resqty_" + iTransRowId;
        var sRateRow = "#rateanal_" + iFocusRowId + "_resrate_" + iTransRowId;
        var sAmtRow = "#rateanal_" + iFocusRowId + "_resamt_" + iTransRowId;

        var dQty = $(sQtyRow).val();
        var dRate = $(sRateRow).val();

        var dAmt = dQty * dRate;
        $(sAmtRow).val(parseFloat(dAmt).toFixed(2));

        var iRows = $('#rowinfoid_' + iFocusRowId).val();

        var dTAmt = 0;

        for (i = 1; i <= iRows; i++) {
            if ($('#rateanal_' + iFocusRowId + '_inc_' + i).is(':checked') == true) {
                dTAmt = dTAmt + parseFloat($("#rateanal_" + iFocusRowId + "_resamt_" + i).val());
            }
        }

        $('#rateanal_' + iFocusRowId + 'totrate').val(parseFloat(dTAmt).toFixed(2));

        var dAnalQty = $('#rateanal_' + iFocusRowId + '_AnalQty').val();
        if (dAnalQty.length == 0 || dAnalQty == 0 || dAnalQty == "Working Qty") {
            dAnalQty = 1;
            $('#rateanal_' + iFocusRowId + '_AnalQty').val(dAnalQty);
        }

        var sUnit = $('select[name= unitid_' + iFocusRowId + '] option:selected').text();

        $('#rateanal_' + iFocusRowId + 'ltotrate').val('Rate for ' + dAnalQty + ' ' + sUnit);
        $('#rateanal_' + iFocusRowId + 'lperrate').val('Rate per ' + sUnit);

        var dNetRate = dTAmt / dAnalQty;

        $('#rateanal_' + iFocusRowId + '_perrate').val(parseFloat(dNetRate).toFixed(2));
        $('#rateanal_' + iFocusRowId + '_netrate').val(parseFloat(dNetRate).toFixed(2));

    }
    else {
        var sExp = "#rateanalR_" + iFocusRowId + "_formula_" + iTransRowId;
        var sqty = "#rateanalR_" + iFocusRowId + "_resqty_" + iTransRowId;

        var sformulaexp = $("#formulaexp").val();
        var sformulaval = $("#formulavalue").val();

        if (sformulaexp != sformulaval) {
            $(sExp).val(sformulaexp);
        }
        else {
            $(sExp).val("");
        }

        $(sqty).val(parseFloat(sformulaval).toFixed(3));

        var sQtyRow = "#rateanalR_" + iFocusRowId + "_resqty_" + iTransRowId;
        var sRateRow = "#rateanalR_" + iFocusRowId + "_resrate_" + iTransRowId;
        var sAmtRow = "#rateanalR_" + iFocusRowId + "_resamt_" + iTransRowId;

        var dQty = $(sQtyRow).val();
        var dRate = $(sRateRow).val();

        var dAmt = dQty * dRate;
        $(sAmtRow).val(parseFloat(dAmt).toFixed(2));

        var iRows = $('#rowinfoidR_' + iFocusRowId).val();

        var dTAmt = 0;

        for (i = 1; i <= iRows; i++) {

            if ($('#rateanalR_' + iFocusRowId + '_inc_' + i).is(':checked') == true) {
                dTAmt = dTAmt + parseFloat($("#rateanalR_" + iFocusRowId + "_resamt_" + i).val());
            }
        }
        $('#rateanalR_' + iFocusRowId + '_totrate').val(parseFloat(dTAmt).toFixed(2));

        var dAnalQty = $('#rateanalR_' + iFocusRowId + '_AnalQty').val();
        if (dAnalQty.length == 0 || dAnalQty == 0) {
            dAnalQty = 1;
            $('#rateanalR_' + iFocusRowId + '_AnalQty').val(dAnalQty);
        }

        var sUnit = $('select[name= unitid_' + iFocusRowId + '] option:selected').text();

        $('#rateanalR_' + iFocusRowId + 'ltotrate').val('Rate for ' + dAnalQty + ' ' + sUnit);
        $('#rateanalR_' + iFocusRowId + 'lperrate').val('Rate per ' + sUnit);

        var dNetRate = dTAmt / dAnalQty;

        $('#rateanalR_' + iFocusRowId + '_perrate').val(parseFloat(dNetRate).toFixed(2));
        $('#rateanalR_' + iFocusRowId + '_netrate').val(parseFloat(dNetRate).toFixed(2));

    }
    $('#formula').hide();
}

function showAnalmix(sVal,y,e) {
    e.preventDefault();
    $('#' + y).parent('li').addClass('active').siblings('li').removeClass('active');
    if (sVal=="manual") {
        $('#activitymachinery').hide();
        $('#activityRrestable').hide();
        $('#activitymanual').show();
        $('#activityrestable').show();
    } else {
        $('#activitymanual').hide()
        $('#activityrestable').hide();
        $('#activitymachinery').show();
        $('#activityRrestable').show();
    }
    return false;
}

function showSubIOWMix(sVal,element,event) {
    event.preventDefault();
    $(element).parent('li').addClass('active').siblings('li').removeClass('active');
    if (sVal=="sitemix") {
        $('#sraworkRtable').hide();
        $('#srateanalRrestable').hide();

        $('#sraworktable').show();
        $('#srateanalrestable').show();
    } else {
        $('#sraworktable').hide();
        $('#srateanalrestable').hide();

        $('#sraworkRtable').show();
        $('#srateanalRrestable').show();
    }

    return false;
}

function showmix(x,y,event) {
    event.preventDefault();

    $('#' + y).parent('li').addClass('active').siblings('li').removeClass('active');
    var keys = y.split('_'),
        iowId = keys[1],
        iRowId = keys[3];

    if (x=="readymix") {
        $('#newiow_'+ iowId +'_ramixtable_'+iRowId).show();
        $('#newiow_'+ iowId +'_raworktable_'+iRowId).hide();
        $('#newiow_'+ iowId +'_rabuttable_'+iRowId).hide();
        $('#newiow_'+ iowId +'_rateanal_'+ iRowId + '_restable').hide();


        $('#newiow_'+ iowId +'_raworkRtable_'+iRowId).show();
        $('#newiow_'+ iowId +'_rabutRtable_'+iRowId).show();
        $('#newiow_'+ iowId +'_rateanalR_'+ iRowId + '_restable').show();

        $('#newiow_'+ iowId +'_analtypeRS_'+iRowId).prop("checked", false);
        $('#newiow_'+ iowId +'_analtypeSR_'+iRowId).prop("checked", false);
        $('#newiow_'+ iowId +'_analtypeRR_'+iRowId).prop("checked", true);

        bSiteMix=false;
    } else {
        $('#newiow_'+ iowId +'_raworkRtable_'+iRowId).hide();
        $('#newiow_'+ iowId +'_rabutRtable_'+iRowId).hide();
        $('#newiow_'+ iowId +'_rateanalR_'+ iRowId + '_restable').hide();

        $('#newiow_'+ iowId +'_ramixtable_'+iRowId).show();
        $('#newiow_'+ iowId +'_raworktable_'+iRowId).show();
        $('#newiow_'+ iowId +'_rabuttable_'+iRowId).show();
        $('#newiow_'+ iowId +'_rateanal_'+ iRowId + '_restable').show();

        $('#newiow_'+ iowId +'_analtypeSR_'+iRowId).prop("checked", false);
        $('#newiow_'+ iowId +'_analtypeRS_'+iRowId).prop("checked", false);
        $('#newiow_'+ iowId +'_analtypeSS_'+iRowId).prop("checked", true);
    }

    bSiteMix=true;
}

function AddNewWorkGroup(x)
{
    sWGUpdateMode='Add';
    $("#workgroupmodal").modal('show');
    $('.autocomplete-suggestions').hide();
    $('#workgroup').val($(x).val());
}

function ShowWorkGroup(id)
{
    var irow = id.split('_')[1];

    sWGUpdateMode='Edit';

    $('#wgrowid').val(irow);
    $('#slno').val($('#newwgcode_'+ irow).val());
    $('#workgroup').val($('#newwgname_'+ irow).val());
    $('#worktype').val($('#newwgtypename_'+ irow).val());
    $('#worktype_id').val($('#newwgid_'+ irow).val());

    $('#create-activity').prop('checked', ($('#newwgactivity_'+ irow).val() == 1) ? true : false);
    $('#auto-generate-rate').prop('checked', ($('#newwgrateanal_'+ irow).val() == 1) ? true : false);
    $('#auto-res-create').prop('checked', ($('#newwgactivityres_'+ irow).val() == 1) ? true : false);
    $("#workgroupmodal").modal('show');
}

function ShowResource(id)
{
    var irow = id.split('_')[1];
    sResUpdateMode='Edit';

    $('#resrowid').val(irow);
    $('#resname').val($('#newresname_'+ irow).val());
    $('#resgroup').val($('#newresgroup_'+ irow).val());
    $('#resgroup_id').val($('#newresgroupid_'+ irow).val());
    $('#restype').val($('#newrestype_'+ irow).val());
    $('#resunit').val($('#newresunit_'+ irow).val());
    $('#resunit_id').val($('#newresunitid_'+ irow).val());
    $('#resrate').val($('#newresrate_'+ irow).val());

    $("#resourcemodal").modal('show');
}

function AddNewResource(x)
{
    sResUpdateMode='Add';
    $("#resourcemodal").modal('show');
    $('.autocomplete-suggestions').hide();
    $('#resname').val($(x).val());
}

function WorkGroupUpdate()
{
    if (sWGUpdateMode=='Add')
    {
        var irows = $('#newwg tr').length;
        var irow = irows-1;

        if ((irow !=1) || ( irow==1 && $('#newwgname_1').val() !=""))
        {
            irow = +irow+1;
            var html = $("#newwg tbody tr:first").html().replace(/_1/g, '_' + irow);

            $("#newwg tbody tr:last").after("<tr>" + html + "</tr>");
        }
    } else
        irow = $('#wgrowid').val(irow);

    $('#newwgcode_'+ irow).val($('#slno').val());
    $('#newwgname_'+ irow).val($('#workgroup').val());
    $('#newwgtypename_'+ irow).val($('#worktype').val());
    $('#newwgid_'+ irow).val($('#worktype_id').val());
    $('#newwgactivity_'+ irow).val(($('#create-activity').is(':checked')) ? 1 : 0);
    $('#newwgrateanal_'+ irow).val(($('#auto-generate-rate').is(':checked')) ? 1 : 0);
    $('#newwgactivityres_'+ irow).val(($('#auto-res-create').is(':checked')) ? 1 : 0);
    $('#newitems').show();
    $('#butnewitems').html("New Work Group Created : <i class='fa fa-long-arrow-right'></i> <span class='badge'> " + irow + "</span>").show();
}

function RateResourceUpdate(resName,unit,rate,resId)
{
    var irow = 0;
    var irows = $('#resourcerate tr').length;
    irow = irows-1;

    if ((irow !=1) || ( irow==1 && $('#rateresname_1').val() !=""))
    {
        irow = +irow+1;
        var html = $("#resourcerate tbody tr:first").html().replace(/_1/g, '_' + irow);

        $("#resourcerate tbody tr:last").after("<tr>" + html + "</tr>");
    }

    $('#rateresname_'+ irow).val(resName);
    $('#rateresunit_'+ irow).val(unit);
    $('#rateresrate_'+ irow).val(rate);
    $('#rateresoldrate_'+ irow).val(rate);
    $('#rateresid_'+ irow).val(resId);

    $('#newrateresource').show();
    $('#butnewrateresource').html("Resource Involved " + " : <i class='fa fa-long-arrow-right'></i><span class='badge'> " + irow + "</span>").show();
}

function ResourceUpdate()
{
    var resname = $('#resname').val(),
        resgroupid = $('#resgroup_id').val(),
        resgroup = $('#resgroup').val(),
        resunit = $('#resunit').val(),
        resunitid = $('#resunit_id').val(),
        restype = $('#restype').val(),
        resrate = $('#resrate').val();

    var irow = 0;

    if (sResUpdateMode=='Add')
    {
        var irows = $('#newres tr').length;
        irow = irows-1;

        if ((irow !=1) || ( irow==1 && $('#newresname_1').val() !=""))
        {
            irow = +irow+1;
            var html = $("#newres tbody tr:first").html().replace(/_1/g, '_' + irow);

            $("#newres tbody tr:last").after("<tr>" + html + "</tr>");
        }
    } else
        irow = $('#resrowid').val();

    $('#newresname_'+ irow).val(resname);
    $('#newresgroup_'+ irow).val(resgroup);
    $('#newresgroupid_'+ irow).val(resgroupid);
    $('#newrestype_'+ irow).val(restype);
    $('#newresunit_'+ irow).val(resunit);
    $('#newresunitid_'+ irow).val(resunitid);
    $('#newresrate_'+ irow).val(resrate);

    $('#newresitems').show();
    $('#butnewresitems').html("New Resource Created : <i class='fa fa-long-arrow-right'></i><span class='badge' style='border-radius:none!important;'> " + irow + "</span>").show();

}


function checkIOWUsed(x) {
    var sStr = x.split("_");
    var iARowid = sStr[3];
    var iRows = $('#rowinfoid_'+ iFocusRowId).val();
    for (i = 1; i <= iRows; i++)
    {
        if (i != iARowid) {
            if ($('#rateanal_' + iFocusRowId + '_type_' + i).val() == 'I') {
                var iResId = $('#rateanal_' + iFocusRowId + '_resid_' + i).val();
                $("#rateanal_" + iFocusRowId + "_resid_" + iARowid + " option[value='" + iResId + "']").remove();
            }
        }
    }
}

function checkIOWUsedR(x) {
    var sStr = x.split("_");
    var iARowid = sStr[3];
    var iRows = $('#rowinfoidR_'+ iFocusRowId).val();
    for (i = 1; i <= iRows; i++)
    {
        if (i != iARowid) {
            if ($('#rateanalR_' + iFocusRowId + '_type_' + i).val() == 'I') {
                var iResId = $('#rateanalR_' + iFocusRowId + '_resid_' + i).val();
                $("#rateanalR_" + iFocusRowId + "_resid_" + iARowid + " option[value='" + iResId + "']").remove();
            }
        }
    }
}

function checkResource(x,restype) {
    var arrname = x.split('_'),
        iowId = arrname[1];

    iFocusRowId = arrname[3];
    var $reskeyid ="";
    if (restype=="R") {
        var reskeyid = $('input[id*=newiow_'+iowId+'_rateanalR_' + iFocusRowId + '_reskeyid_]');
        var iowkeyid = $('input[id*=newiow_'+iowId+'_rateanalR_' + iFocusRowId + '_iowkeyid_]');
        arrayresR = arrayreslist;
        arrayresR = $.grep(arrayreslist, function (element, index) {
            var is_selected = true;
            $.each(reskeyid, function (i, obj) {
                if (element.id == $(this).val() && element.data.category == 'Resource') {
                    is_selected = false;
                }
            });

            $.each(iowkeyid, function (i, obj) {
                if (element.id == $(this).val() && element.data.category == 'IOW') {
                    is_selected = false;
                }
            });

            return is_selected;
        });
    } else {
        var reskeyid = $('input[id*=newiow_'+iowId+'_rateanal_' + iFocusRowId + '_reskeyid_]');
        var iowkeyid = $('input[id*=newiow_'+iowId+'_rateanal_' + iFocusRowId + '_iowkeyid_]');
        arrayres = arrayreslist;
        arrayres = $.grep(arrayreslist, function (element, index) {
            var is_selected = true;
            $.each(reskeyid, function (i, obj) {
                if (element.id == $(this).val() && element.data.category == 'Resource') {
                    is_selected = false;
                }
            });
            $.each(reskeyid, function (i, obj) {
                if (element.id == $(this).val() && element.data.category == 'IOW') {
                    is_selected = false;
                }
            });

            return is_selected;
        });

    }
}

function checkIOWUsed(x)
{
    var sStr = x.split("_");
    var iARowid = sStr[3];
    var iRows = $('#rowinfoid_'+ iFocusRowId).val();
    for (i = 1; i <= iRows; i++)
    {
        if (i != iARowid) {
            if ($('#rateanal_' + iFocusRowId + '_type_' + i).val() == 'I') {
                var iResId = $('#rateanal_' + iFocusRowId + '_resid_' + i).val();
                $("#rateanal_" + iFocusRowId + "_resid_" + iARowid + " option[value='" + iResId + "']").remove();
            }
        }
    }
}

function checkIOWUsedR(x)
{
    var sStr = x.split("_");
    var iARowid = sStr[3];
    var iRows = $('#rowinfoidR_'+ iFocusRowId).val();
    for (i = 1; i <= iRows; i++)
    {
        if (i != iARowid) {
            if ($('#rateanalR_' + iFocusRowId + '_type_' + i).val() == 'I') {
                var iResId = $('#rateanalR_' + iFocusRowId + '_resid_' + i).val();
                $("#rateanalR_" + iFocusRowId + "_resid_" + iARowid + " option[value='" + iResId + "']").remove();
            }
        }
    }
}

function entryValidate() {
    var isValid = true,
        $trIOW = $('tr[id*=IOWiRowId_]');

    $.each($trIOW, function (i, obj) {
        var $this = $(this),
            name = $this[0].id,
            key = name.split('_')[1];

        if (name.indexOf('__') != -1)
            return;

        if ($('#parentid_' + key).val().length==0 && $('#serialno_' + key).val().length==0 && $('#spec_' + key).val().length==0 && $('#unitid_' + key).val().length==0)
            return;

        if ($('#parentid_' + key).val().length==0) {
            isValid=false;
            alert("Parent Not Selected");
            $('#parentid_' + key).focus();
            return;
        } else if ($('#serialno_' + key).val().length==0) {
            isValid = false;
            alert("Serial No is Empty");
            $('#refserialno_' + key).focus();
            return;
        } else if ($('#spec_' + key).val().length==0) {
            isValid = false;
            alert("Specification is Empty");
            $('#spec_' + key).focus();
            return;
        } else if ($('#unitid_' + key).val().length==0) {
            isValid = false;
            alert("Unit Not Selected");
            $('#unitid_' + key).focus();
            return;
        }

    });

    return isValid;
}

function entryValidate() {
    var isValid = true,
        $trIOW = $('tr[id*=IOWiRowId_]');

    $.each($trIOW, function (i, obj) {
        var $this = $(this),
            name = $this[0].id,
            key = name.split('_')[1];

        if (name.indexOf('__') != -1)
            return;

        if ($('#parentid_' + key).val().length==0 && $('#serialno_' + key).val().length==0 && $('#spec_' + key).val().length==0 && $('#unitid_' + key).val().length==0)
            return;
        if ($('#parentid_' + key).val().length==0) {
            isValid=false;
            alert("Parent Not Selected");
            $('#parentid_' + key).focus();
            return;
        } else if ($('#serialno_' + key).val().length==0) {
            isValid = false;
            alert("Serial No is Empty");
            $('#refserialno_' + key).focus();
            return;
        } else if ($('#spec_' + key).val().length==0) {
            isValid = false;
            alert("Specification is Empty");
            $('#spec_' + key).focus();
            return;
        } else if ($('#unitkeyid_' + key).val().length==0) {
            isValid = false;
            alert("Unit Not Selected");
            $('#unitid_' + key).focus();
            return;
        }
    });

    return isValid;
}

function MainRateUpdate(x) {
    var sStr = $('#' + $(x).parents('tr')[0].id).prev('tr')[0].id.split("_"),
        iFRowId = sStr[1],
        iTRowId = sStr[3],
        name = sStr[0] + "_";

    $('#' + name + iFRowId + '_ratetype_' + iTRowId).val($('#' + x.id).val());
    var iResId = $('#' + name + iFRowId + '_reskeyid_' + iTRowId).val();

    var rateInputs = $(x).parents('li').siblings('li').find('input[type=text]');

    var dRate = 0;

    if($('#' + x.id).val() == "M") { dRate = $(rateInputs[1]).val(); }
    else if($('#' + x.id).val() == "A") { dRate = $(rateInputs[2]).val(); }
    else { dRate = $(rateInputs[0]).val(); }

    $('#' + name + iFRowId + '_resrate_' + iTRowId).val(dRate);
    ValueChange(name+ iFRowId + '_resrate_' + iTRowId);
}

function MainRateUpdateIOW(x) {
    var sStr = $('#' + $(x).parents('tr')[0].id).prev('tr')[0].id.split("_"),
        iFRowId = sStr[1],
        iTRowId = sStr[3],
        name = sStr[0] + "_";

    $('#' + name + iFRowId + '_ratetype_' + iTRowId).val($('#' + x.id).val());
    var iiowId = $('#' + name + iFRowId + '_iowkeyid_' + iTRowId).val();

    var objAS = $.grep(arrSubIOW, function (element, index) {
        return element.subiowid == iiowId;
    });

    var dRate = 0;

    if (objAS.length >0)
    {
        if ($('#' + x.id).val() == "R") { dRate = objAS[0]["rrate"]; }
        else {dRate = objAS[0]["srate"]; }
    }
    $('#' + name + iFRowId + '_resrate_' + iTRowId).val(dRate);
    ValueChange(name+ iFRowId + '_resrate_' + iTRowId);
}

function isFormula(evt){
//    var charCode = (evt.which) ? evt.which : evt.keyCode
//    if (charCode > 31 && (charCode < 48 || charCode > 57) && charCode !=43 && charCode!=45 && charCode!=47 && charCode!=42 && charCode!=46 && charCode!=65 && charCode!=66 && charCode!=67 && charCode!=40 && charCode!=41 && charCode!=82)
//        return false;
    return true;
}

function GetWorkGroupDetails(ival,x)
{
    if ($('#rfcmode').val().trim() != 'edit' && $('#rfcid').val()!=0)
    {
        $.post( getBaseURL() + 'project/rfc/getworkgroupdetails', {resId:ival}, function( data )
        {
            var obj = jQuery.parseJSON(data);
            var objT =obj['trans'];
            var objA=obj['anal'];

            var sStr = x.split("_");

            var iowId = sStr[1],
                iARowid = sStr[3];

            if (objT['ConcreteMix'] == 1) {$('#newiow_'+ iowId +'_concrete_' + iARowid).prop("checked", true); $('#newiow_'+ iowId +'_mixtab_' + iARowid).show();

                $('#newiow_'+ iowId +'_rateanalR_' + iARowid + '_AnalQty').val(parseFloat(objT['RWorkingQty']).toFixed(3));
            }
            else {
                $('#newiow_'+ iowId +'_mixtab_' + iARowid).hide();
                $('#newiow_'+ iowId +'_rateanalR_' + iARowid + '_AnalQty').hide();
            }

            $('#newiow_'+ iowId +'_rateanal_' + iARowid + '_AnalQty').val(parseFloat(objT['WorkingQty']).toFixed(3));
            $('#newiow_'+ iowId +'_rateanal_' + iARowid + '_AQty').val(parseFloat(objT['CementRatio']).toFixed(3));
            $('#newiow_'+ iowId +'_rateanal_' + iARowid + '_BQty').val(parseFloat(objT['SandRatio']).toFixed(3));
            $('#newiow_'+ iowId +'_rateanal_' + iARowid + '_CQty').val(parseFloat(objT['MetalRatio']).toFixed(3));
            $('newiow_'+ iowId +'_#rateanal_' + iARowid + '_thick').val(parseFloat(objT['ThickQty']).toFixed(3));

            if (objT['Cement'] == 1) { $('#rateanal_' + iARowid + 'AQty_li').show(); }
            else {$('#newiow_'+ iowId +'_rateanal_' + iARowid + 'AQty_li').hide();}

            if (objT['Sand'] == 1) {$('#rateanal_' + iARowid + 'BQty_li').show(); }
            else {$('#newiow_'+ iowId +'_rateanal_' + iARowid + 'BQty_li').hide();}

            if (objT['Metal'] == 1) { $('#rateanal_' + iARowid + 'CQty_li').show(); }
            else { $('#newiow_'+ iowId +'_rateanal_' + iARowid + 'CQty_li').hide();}

            if (objT['Thickness'] == 1) { $('#rateanal_' + iARowid + 'thick_li').show(); }
            else {$('#newiow_'+ iowId +'_rateanal_' + iARowid + 'thick_li').hide(); }

            var objAS = $.grep(objA, function (element, index) {
                return element.Type != 'R';
            });

            var k = 0;
            for (j = 0; j < objAS.length; j++) {
                k = k + 1;
                var sRow = '#newiow_'+ iowId +'_rowinfoid_' + iARowid;
                if (k != 1) {
                    var stabelrow = '#newiow_'+ iowId +'_rateanal_' + iARowid + '_restable';
                    var sStr = '<tr id="newiow_'+ iowId +'_rateanal__1_RowId__9">' + $("#newiow_"+ iowId +"_rateanal__1_RowId__9").html() + '</tr>';
                    sStr = sStr.replace(/__1/g, '_' + iARowid);
                    sStr = sStr.replace(/__9/g, '_' + k);
                    sStr = sStr.replace(/R1/g, 'R' + k);

                    $(stabelrow + " tbody tr:last").after(sStr);
                }

                if (objAS[j]['IncludeFlag'] == 1) {
                    $('#newiow_'+ iowId +'_rateanal_' + iARowid + '_inc_' + k).prop("checked", true);
                }
                else {
                    $('#newiow_'+ iowId +'_rateanal_' + iARowid + '_inc_' + k).prop("checked", false);
                }

                $('#newiow_'+ iowId +'_rateanal_' + iARowid + '_ref_' + k).val('R' + objAS[j]['ReferenceId']);
                $('#newiow_'+ iowId +'_rateanal_' + iARowid + '_code_' + k).val(objAS[j]['Code']);
                $('#newiow_'+ iowId +'_rateanal_' + iARowid + '_resid_' + k).val(objAS[j]['ResourceId']);
                $('#newiow_'+ iowId +'_rateanal_' + iARowid + '_resunit_' + k).val(objAS[j]['UnitName']);
                $('#newiow_'+ iowId +'_rateanal_' + iARowid + '_resqty_' + k).val(parseFloat(objAS[j]['Qty']).toFixed(3));
                $('#newiow_'+ iowId +'_rateanal_' + iARowid + '_resrate_' + k).val(parseFloat(objAS[j]['Rate']).toFixed(2));
                $('#newiow_'+ iowId +'_rateanal_' + iARowid + '_formula_' + k).val(objAS[j]['CFormula']);

                $(sRow).val(k);
            }

            var objAR = $.grep(objA, function (element, index) {
                return element.Type == 'R';
            });

            var k = 0;
            for (j = 0; j < objAR.length; j++) {
                k = k + 1;
                var sRow = '#newiow_'+ iowId +'_rowinfoidR_' + iARowid;

                if (k != 1) {

                    var stabelrow = '#newiow_'+ iowId +'_rateanalR_' + iARowid + '_restable';
                    var sStr = '<tr id="newiow_'+ iowId +'_rateanalR__1_RowId__9">' + $("#newiow_"+ iowId +"_rateanalR__1_RowId__9").html() + '</tr>';
                    sStr = sStr.replace(/__1/g, '_' + iARowid);
                    sStr = sStr.replace(/__9/g, '_' + k);
                    sStr = sStr.replace(/R1/g, 'R' + k);

                    $(stabelrow + " tbody tr:last").after(sStr);
                }

                if (objAR[j]['IncludeFlag'] == 1) {
                    $('#newiow_'+ iowId +'_rateanalR_' + iARowid + '_inc_' + k).prop("checked", true);
                }
                else {
                    $('#newiow_'+ iowId +'_rateanalR_' + iARowid + '_inc_' + k).prop("checked", false);
                }

                $('#newiow_'+ iowId +'_rateanalR_' + iARowid + '_ref_' + k).val('R' + objAR[j]['ReferenceId']);
                $('#newiow_'+ iowId +'_rateanalR_' + iARowid + '_code_' + k).val(objAR[j]['Code']);
                $('#newiow_'+ iowId +'_rateanalR_' + iARowid + '_resid_' + k).val(objAR[j]['ResourceId']);
                $('#newiow_'+ iowId +'_rateanalR_' + iARowid + '_resunit_' + k).val(objAR[j]['UnitName']);
                $('#newiow_'+ iowId +'_rateanalR_' + iARowid + '_resqty_' + k).val(parseFloat(objAR[j]['Qty']).toFixed(3));
                $('#newiow_'+ iowId +'_rateanalR_' + iARowid + '_resrate_' + k).val(parseFloat(objAS[j]['Rate']).toFixed(2));
                $('#newiow_'+ iowId +'_rateanalR_' + iARowid + '_formula_' + k).val(objAR[j]['CFormula']);

                $(sRow).val(k);
            }
        });
    }
}


$(function() {
    $(document).keydown(function(event) {

        if(event.keyCode == 13) {
            event.preventDefault();
        }

        else if(event.ctrlKey && event.keyCode == 78) {
            $("#addbut").trigger("click");
            event.preventDefault();
        }
        else if(event.ctrlKey && event.keyCode == 83) {
            $("#donebut").trigger("click");
            event.preventDefault();
        }
        else if(event.ctrlKey && event.keyCode == 82) {
            if (bSiteMix == true){$("#butresadd").trigger("click");}
            else{$("#butresRadd").trigger("click");}
            event.preventDefault();
        }
        else if(event.ctrlKey && event.keyCode == 67) {

            if (bSiteMix==true){var iRows = $('#rowinfoid_' + iFocusRowId).val();}
            else {var iRows = $('#rowinfoidR_' + iFocusRowId).val();}

            var arr= [];
            var k=0;

            for (i = 1; i <= iRows; i++)
            {
                if (bSiteMix ==true){var sTable = '#rateanal_' + iFocusRowId + '_RowId_' + i;}
                else {var sTable = '#rateanalR_' + iFocusRowId + '_RowId_' + i;}

                if ($(sTable).hasClass('selected') == true) {
                    if (bSiteMix ==true) {
                        arr.push({
                            inc: $('#rateanal_' + iFocusRowId + '_inc_' + i).val(),
                            ref: $('#rateanal_' + iFocusRowId + '_ref_' + i).val(),
                            code: $('#rateanal_' + iFocusRowId + '_code_' + i).val(),
                            resid: $('#rateanal_' + iFocusRowId + '_resid_' + i).val(),
                            resqty: $('#rateanal_' + iFocusRowId + '_resqty_' + i).val(),
                            resunit: $('#rateanal_' + iFocusRowId + '_resunit_' + i).val(),
                            resrate: $('#rateanal_' + iFocusRowId + '_resrate_' + i).val(),
                            resamt: $('#rateanal_' + iFocusRowId + '_resamt_' + i).val(),
                            formula: $('#rateanal_' + iFocusRowId + '_formula_' + i).val()
                        });
                    }
                    else
                    {
                        arr.push({
                            inc: $('#rateanalR_' + iFocusRowId + '_inc_' + i).val(),
                            ref: $('#rateanalR_' + iFocusRowId + '_ref_' + i).val(),
                            code: $('#rateanalR_' + iFocusRowId + '_code_' + i).val(),
                            resid: $('#rateanalR_' + iFocusRowId + '_resid_' + i).val(),
                            resqty: $('#rateanalR_' + iFocusRowId + '_resqty_' + i).val(),
                            resunit: $('#rateanalR_' + iFocusRowId + '_resunit_' + i).val(),
                            resrate: $('#rateanalR_' + iFocusRowId + '_resrate_' + i).val(),
                            resamt: $('#rateanalR_' + iFocusRowId + '_resamt_' + i).val(),
                            formula: $('#rateanalR_' + iFocusRowId + '_formula_' + i).val()
                        });
                    }
                }
            }

            if (arr.length >0) {
                $.post(getBaseURL() + 'project/rfc/updatecopyanalysis', {ids: arr}, function (data) {
                    //alert (data);
                });
            }
            event.preventDefault();
        }
        else if(event.ctrlKey && event.keyCode == 86) {

            $.post(getBaseURL() + 'project/rfc/getcopyanalysis', {ids: arr}, function (data) {
                var obj = jQuery.parseJSON(data);

                if (bSiteMix==true) {

                    var irowinfoId = $('#rowinfoid_' + iFocusRowId).val();

                    for (i = 0; i < obj.length; i++) {
                        if ($('#rateanal_' + iFocusRowId + '_resid_'+ irowinfoId).val().length != 0) {
                            irowinfoId = +irowinfoId + 1;

                            var stabelrow = '#rateanal_'+iFocusRowId + '_restable';
                            var sStr= '<tr id="rateanal__1_RowId__9">' + $("#rateanal__1_RowId__9").html() + '</tr>';

                            sStr = sStr.replace(/__1/g,'_'+ iFocusRowId);
                            sStr = sStr.replace(/__9/g,'_'+ irowinfoId);
                            sStr = sStr.replace(/R1/g,'R'+ irowinfoId);
                            $(stabelrow+" tbody tr:last").after(sStr);

                            $('#rowinfoid_' + iFocusRowId).val(irowinfoId);
                        }
                        $('#rateanal_' + iFocusRowId + '_inc_' + irowinfoId).val(obj[i]['inc']);
                        //$('#rateanal_' + iFocusRowId + 'ref_' + irowinfoId).val(obj[i]['ref']);
                        $('#rateanal_' + iFocusRowId + '_code_' + irowinfoId).val(obj[i]['code']);
                        $('#rateanal_' + iFocusRowId + '_resid_' + irowinfoId).val(obj[i]['resid']);
                        $('#rateanal_' + iFocusRowId + '_resqty_' + irowinfoId).val(obj[i]['resqty']);
                        $('#rateanal_' + iFocusRowId + '_resunit_' + irowinfoId).val(obj[i]['resunit']);
                        $('#rateanal_' + iFocusRowId + '_resrate_' + irowinfoId).val(obj[i]['resrate']);
                        $('#rateanal_' + iFocusRowId + '_resamt_' + irowinfoId).val(obj[i]['resamt']);
                        $('#rateanal_' + iFocusRowId + '_formula_' + irowinfoId).val(obj[i]['formula']);
                    }
                }
                else
                {
                    var irowinfoId = $('#rowinfoidR_' + iFocusRowId).val();

                    for (i = 0; i < obj.length; i++) {
                        if ($('#rateanalR_' + iFocusRowId + '_resid_'+ irowinfoId).val().length != 0) {
                            irowinfoId = +irowinfoId + 1;

                            var stabelrow = '#rateanalR_'+iFocusRowId + '_restable';
                            var sStr= '<tr id="rateanalR__1_RowId__9">' + $("#rateanalR__1_RowId__9").html() + '</tr>';

                            sStr = sStr.replace(/__1/g,'_'+ iFocusRowId);
                            sStr = sStr.replace(/__9/g,'_'+ irowinfoId);
                            sStr = sStr.replace(/R1/g,'R'+ irowinfoId);
                            $(stabelrow+" tbody tr:last").after(sStr);

                            $('#rowinfoid_' + iFocusRowId).val(irowinfoId);
                        }
                        $('#rateanalR_' + iFocusRowId + '_inc_' + irowinfoId).val(obj[i]['inc']);
                        //$('#rateanalR_' + iFocusRowId + 'ref_' + irowinfoId).val(obj[i]['ref']);
                        $('#rateanalR_' + iFocusRowId + '_code_' + irowinfoId).val(obj[i]['code']);
                        $('#rateanalR_' + iFocusRowId + '_resid_' + irowinfoId).val(obj[i]['resid']);
                        $('#rateanalR_' + iFocusRowId + '_resqty_' + irowinfoId).val(obj[i]['resqty']);
                        $('#rateanalR_' + iFocusRowId + '_resunit_' + irowinfoId).val(obj[i]['resunit']);
                        $('#rateanalR_' + iFocusRowId + '_resrate_' + irowinfoId).val(obj[i]['resrate']);
                        $('#rateanalR_' + iFocusRowId + '_resamt_' + irowinfoId).val(obj[i]['resamt']);
                        $('#rateanalR_' + iFocusRowId + '_formula_' + irowinfoId).val(obj[i]['formula']);
                    }
                }
            });
        }
    });
});
</script>