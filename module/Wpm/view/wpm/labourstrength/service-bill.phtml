<link rel="stylesheet" href="<?php echo $this->basePath().'/css/workorder.css'; ?>" />
<link rel="stylesheet" href="<?php echo $this->basePath().'/css/wpm.css'; ?>" />
<style>
    .pl-mi{left:1px; right:inherit}
    .panel {
        border-radius:0px !important;
    }
    .panel-info {
        border:none;border-top:none;
    }
    /*.tooltip{
        margin:8px;
        padding:8px;
        border:1px solid blue;
        background-color:yellow;
        position: absolute;
        z-index: 2;
    }*/
    .top-addtip{width: 168px;left: -80px;top: -58px;height: 74px;z-index: 1000001 !important;visibility: visible;}
    .top-addtip:after{content: ""; display: block; width: 0; height: 0; border-left: 6px solid #7d73b3; border-top: 6px solid transparent; border-bottom: 6px solid transparent; position: absolute; top:32px; left:104%;z-index:1}
    .action_btns li {float: left !important;padding-top: 7px;}
    .table-fixed tbody{max-height:300px;min-height:20px; overflow-y:auto;width:100%}
    .table-fixed thead,.table-fixed tbody,.table-fixed tr,.table-fixed td,.table-fixed th{display:block}
    .table-fixed tbody td,.table-fixed thead>tr>th{float:left; border-bottom:0;position:relative;text-overflow:ellipsis;overflow:hidden;display:inline-block;white-space:nowrap}
</style>
<div class="content_wrapper padlr0">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-12">
                <h1 id="titleTag" class="text-center">Service Bill</h1>
            </div>
            <form method="post" id="formWrapper">
                <div class="col-lg-12">
                    <div class="col-lg-4 col-lg-offset-0 col-md-6 col-md-offset-0 col-sm-6 col-sm-offset-0 col-xs-12 col-xs-offset-0">
                        <input type="hidden" id="costCentreId" name="costCentreId" value="<?php if(isset($costCentre)) { echo $costCentre['CostCentreId']; } elseif(isset($sbRegister)){echo  $sbRegister['CostCentreId'];} else { echo ''; } ?>" />
                        <input type="hidden" id="vendorId" name="vendorId" value="<?php if(isset($vendor)) { echo $vendor['VendorId']; } elseif(isset($sbRegister)){echo  $sbRegister['VendorId'];} else { echo ''; } ?>" />
                        <input type="hidden" id="soRegisterId" name="soRegisterId" value="<?php if(isset($SO)) { echo $SO['SORegisterId']; } elseif(isset($sbRegister)){echo  $sbRegister['SORegisterId'];} else { echo ''; } ?>" />
                        <input type="hidden" name="companyId" id="companyId" value="<?php echo (isset($costCentre)) ? $costCentre['CompanyId'] : ''; ?>">
                        <div class="panel-box zoomIn animated">
                            <ul>
                                <li>
                                    <label>Cost Centre</label>
                                    <span class="sprojName"><?php if(isset($costCentre)) { echo $costCentre['CostCentreName']; } elseif(isset($sbRegister)){echo  $sbRegister['CostCentreName'];} else { echo ''; } ?></span>
                                </li>
                                <li>
                                    <label>Contractor</label>
                                    <span class="sconName"><?php if(isset($vendor)) { echo $vendor['VendorName']; } elseif(isset($sbRegister)){echo  $sbRegister['VendorName'];} else { echo ''; } ?></span>
                                </li>
                                <li id="soLiTag" style="">
                                    <label>Service Order</label>
                                    <span class="ssoName"><?php if(isset($SO)) { echo $SO['SONo']; } elseif(isset($sbRegister) && $sbRegister['SONo']!=''){echo  $sbRegister['SONo'];} else { echo ''; } ?></span>
                                </li>
                                <li>
                                    <label>Service Type</label>
                                    <div class="select-style selected-mu">
                                        <select name="serviceType" id="serviceType"  >
                                            <?php if(isset($service_Types)){
                                                foreach($service_Types as $service_Type){
                                                    ?>
                                                    <option value="<?php echo $service_Type['ServiceTypeId'];?>"><?php echo $service_Type['ServiceTypeName'];?></option>
                                                <?php
                                                }
                                            } ?>
                                        </select>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-lg-4 col-lg-offset-0 col-md-6 col-md-offset-0 col-sm-6 col-sm-offset-0 col-xs-12 col-xs-offset-0">
                        <div class="panel-box box2th zoomIn animated">
                            <ul>
                                <li>
                                    <label>Service Bill Date</label>
                                    <span><input type="text" id="sbDate" name="sbDate" class="date_picker" value="<?php if(isset($sbRegister) && ($sbRegister['SBDate'] != NULL)) { echo date("d-m-Y", strtotime($sbRegister['SBDate'])); } else { echo date("d-m-Y"); } ?>" readonly /></span>
                                </li>
                                <li>
                                    <label>Ref Date</label>
                                    <span><input type="text" id="refDate" name="refDate" class="date_picker" value="<?php if(isset($sbRegister) && ($sbRegister['RefDate'] != NULL)) { echo date("d-m-Y", strtotime($sbRegister['RefDate'])); } else { echo date("d-m-Y"); } ?>" readonly /></span>
                                </li>
                                <li>
                                    <label>From Date</label>
                                    <span><input type="text" id="fromDate" name="fromDate" class="date_picker" value="<?php if(isset($sbRegister) && ($sbRegister['FromDate'] != NULL)) { echo date("d-m-Y", strtotime($sbRegister['FromDate'])); } else { echo date("d-m-Y"); } ?>" readonly /></span>
                                </li>
                                <li>
                                    <label>To Date</label>
                                    <span><input type="text" id="toDate" name="toDate" class="date_picker" value="<?php if(isset($sbRegister) && ($sbRegister['ToDate'] != NULL)) { echo date("d-m-Y", strtotime($sbRegister['ToDate'])); } else { echo date("d-m-Y"); } ?>" readonly /></span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-lg-4 col-lg-offset-0 col-md-6 col-md-offset-0 col-sm-6 col-sm-offset-0 col-xs-12 col-xs-offset-0">
                        <div class="panel-box box3th zoomIn animated">
                            <ul>
                                <li>
                                    <label>Service Bill No</label>
                                    <span><input type="text" id="sbNo" name="sbNo" value="<?php if(isset($sbRegister) && trim($sbRegister['SBNo']) != '') { echo trim($sbRegister['SBNo']); } else { echo ($genType) ? trim($sbNo) : ''; } ?>" readonly /></span>
                                </li>
                                <li>
                                    <label>CC Service Bill No</label>
                                    <span><input type="text" id="ccSbNo" name="ccSbNo" value="<?php if(isset($sbRegister) && trim($sbRegister['SBCCNo']) != '') { echo $sbRegister['SBCCNo']; } else { echo ''; } ?>" /></span>
                                </li>
                                <li>
                                    <label>Comp Service Bill No</label>
                                    <span><input type="text" id="compSbNo" name="compSbNo" value="<?php if(isset($sbRegister) && trim($sbRegister['SBCompNo']) != '') { echo $sbRegister['SBCompNo']; } else { echo ''; } ?>" /></span>
                                </li>
                                <li>
                                    <label>Ref No</label>
                                    <span><input type="text" id="refNo" name="refNo" value="<?php if(isset($genType)) { echo $sbNo; } elseif(isset($sbRegister)){echo  $sbRegister['RefNo'];} else { echo ''; } ?>" /></span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="slic">
                    <ul>
                        <li class="face"><a href="#"></a></li>
                        <li><a href="#"></a></li>
                        <li><a href="#"></a></li>
                    </ul>
                </div>
                <div class="clearfix"></div>
                <div class="col-lg-12 clear animated fadeInUp">
                    <div class="error_message selOne" style="padding-right: 10px;padding-bottom: 10px;"><p>please enter atleast one entry...</p></div>
                    <div class="table-responsive">
                        <table class="table" style="margin-bottom:0px;" id="serviceTable">
                            <thead>
                            <tr>
                                <th>Description</th>
                                <th>Unit</th>
                                <th class="text-right">Qty</th>
                                <th class="text-right">Rate</th>
                                <th class="text-right">Amount</th>
                                <th>&nbsp;</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr class="total" id="serviceBillWrapper">
                                <td colspan="3">&nbsp;</td>
                                <td align="right" class="rate_pri">Base Amount</td>
                                <td width="20%"><input class="parent_text text-right bold-text-clr" type="text" id="totalAmount" name="totalAmount" onblur="return FormatNum(this, 2)" onchange="myfunc($(this).val())" readonly /></td>
                                <td width="5%">&nbsp;</td>
                            </tr>
                            <tr style="border-bottom:none;">
                                <td colspan="4" style="border-right:none;border-top:none;" align="right" class="rate_pri"><label>Qualifier Amount</label></td>
                                <td style="border-right:none;border-top:none;"><input class="parent_text text-right total-clr" type="text" placeholder="00.0" name="qualAmt" id="qualAmt" onblur="return FormatNum(this, 2, true)" value="<?php echo (isset($soRegister)) ? $soRegister['QualifiedAmount'] : '';?>" readonly/></td>
                                <td style="border-right:none;border-top:none;">
                                    <ul class="action_btns">
                                        <li>
                                            <a href="#" class="qualTr">
                                                <span data-original-title="Expand" data-placement="left" data-toggle="tooltip"><i class="fa fa-chevron-circle-down"></i></span>
                                            </a>
                                        </li>
                                    </ul>
                                </td>
                            </tr>
                            <tr style="display:none;" class="qualmainTr">
                                <td colspan="10" style="padding:0px !important; ">
                                    <div class="subDiv" style="display:none;overflow-y:scroll; min-height:100%; max-height:250px;">
                                        <?php echo $qualRHtml;?>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td style="border-top:none !important" class="colspanId" colspan="3">&nbsp;</td>
                                <td style="border-right:none;border-top:none;" align="right" class="rate_pri"><label>Bill Recovery</label></td>
                                <td style="border-right:none;border-top:none;">
                                    <input class="parent_text text-right total-clr" id="recoveryServiceBill" name="recoveryServiceBill" type="text" onkeypress="return isDecimal(event,this);" onblur="return FormatNum(this, 2, true)"  readonly/></td>
                                <td style="border-right:none;border-top:none;">
                                    <ul class="action_btns">
                                        <li>
                                            <a href="#" class="qualTr">
                                                <span data-original-title="Expand" data-placement="left" data-toggle="tooltip"><i class="fa fa-chevron-circle-down"></i></span>
                                            </a>
                                        </li>
                                    </ul>
                                </td>
                            </tr>
                            <tr style="display:none;" class="qualmainTr">
                                <td colspan="10" style="padding:0px !important; ">
                                    <div class="subDiv" style="display:none;margin-left:5px">
                                        <table class="table table-fixed" style=" margin-bottom:0px;">
                                            <thead>
                                            <tr class="col-xs-12" style="padding:0 !important">
                                                <th class="red-ths col-xs-5" width="45%">Recovery type name</th>
                                                <th class="red-ths col-xs-3" width="30%">Account</th>
                                                <th class="red-ths col-xs-3" width="25%" style="text-align:right">Amount</th>
                                                <th class="red-ths col-xs-1" width="5%">&nbsp;</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            <?php
                                            if(isset($recoveryTypes) && count($recoveryTypes) != 0) {
                                                $i = 1;
                                                foreach($recoveryTypes as $recoveryType) {
                                                    ?>
                                                    <tr class="col-xs-12" style="padding:0 !important">
                                                        <td class="col-xs-5" width="30%">
                                                            <input class="parent_text " type="text" name="recoveryName_<?php echo $i; ?>" id="recoveryName_<?php echo $i; ?>"  value="<?php echo $recoveryType['RecoveryTypeName']; ?>" readonly />
                                                            <input type="hidden" name="recoveryId_<?php echo $i; ?>" id="recoveryId_<?php echo $i; ?>" value="<?php echo $recoveryType['RecoveryTypeId']; ?>" />
                                                        </td>
                                                        <td class="col-xs-3"><div class="select-style">
                                                                <select class="parent_text" id="recoveryAccount_<?php echo $i; ?>" name="recoveryAccount_<?php echo $i; ?>" >
                                                                    <option value="">none</option>
                                                                    <?php foreach($recoveryAccounts as $recoveryAccount) { ?>
                                                                        <option value="<?php echo $recoveryAccount['AccountId']; ?>"><?php echo $recoveryAccount['AccountName']; ?></option>
                                                                    <?php } ?>
                                                                </select>
                                                            </div>
                                                        </td>
                                                        <td class="col-xs-3" style="position:relative;padding-right:0 !important"align="right">
                                                            <input class="parent_text text-right amtCh" name="recoveryAmount_<?php echo $i; ?>"  id="recoveryAmount_<?php echo $i; ?>" type="text" onkeypress="return isDecimal(event,this);" onchange="return recoveryTotAmt(this);" onblur="return FormatNum(this, 2, true)" ></td>
                                                        <input type="hidden" name="hiddenRecoveryAmount_<?php echo $i; ?>" id="hiddenRecoveryAmount_<?php echo $i; ?>"  />

                                                        <td class="col-xs-1" style=" overflow: visible;">
																 <span class="pl-mi"align="center">
                                                                                    <?php if($recoveryType['RecoveryTypeId'] == 1 || $recoveryType['RecoveryTypeId'] == 2 || $recoveryType['RecoveryTypeId'] == 3 || $recoveryType['RecoveryTypeId'] == 4) {?>
                                                                                        <i class="fa fa-minus clr-red"></i>
                                                                                    <?php } else if($recoveryType['RecoveryTypeId'] == 5 || $recoveryType['RecoveryTypeId'] == 6 || $recoveryType['RecoveryTypeId'] == 7){ ?>
                                                                                        <i class="fa fa-minus clr-red" id="recoverySpanId_<?php echo $i; ?>" onclick = "recoverySignChange(this);" ></i>
                                                                                    <?php }?>
                                                                                </span>
                                                            <input type="hidden" id="recoverySign_<?php echo $i; ?>" value="-" name="recoverySign_<?php echo $i; ?>">

                                                            <ul class="action_btns">
                                                                <li style="float:right !important">
                                                                    <a class="mainTr" href="#">
                                                                        <i class="fa fa-chevron-circle-down tform" data-toggle="tooltip" data-placement="left" data-original-title="Expand"></i></a></li>
                                                            </ul></td>
                                                    </tr>
                                                    <tr class="subTr col-xs-12" style="display:none;padding:0 !important">
                                                        <td colspan="8" style="padding:0px !important; ">
                                                            <div class="subDiv col-xs-12" style="display: block !important;padding:10px 0 0 0 !important;margin-left:8px">
                                                                <div class="col-lg-12">
                                                                    <div class="table-responsive topsp">
                                                                        <table class="table table-fixed" style="margin-bottom:0px;">
                                                                            <thead>
                                                                            <?php if($recoveryType['RecoveryTypeId']==7) {?>
                                                                                <tr class="col-xs-12" style="padding:0 !important">
                                                                                    <th class="red-ths col-xs-1" > Date</th >
                                                                                    <th class="red-ths col-xs-1" > Ref No .</th >
                                                                                    <th class="red-ths col-xs-2" > Adv . Type</th >
                                                                                    <th class="red-ths col-xs-2" style = "text-align:right" > Total Adv.</th>
                                                                                    <th class="red-ths col-xs-2" style = "text-align:right" > Recovered Amt </th>
                                                                                    <th class="red-ths col-xs-2" style = "text-align:right" > Balance Amt </th>
                                                                                    <th class="red-ths col-xs-2" style = "text-align:right" > Current Amt </th
                                                                                </tr>
                                                                            <?php  }elseif($recoveryType['RecoveryTypeId']==3) {
                                                                                ?>
                                                                                <tr class="col-xs-12" style="padding:0 !important">
                                                                                    <th class="red-ths col-xs-2" style = "text-align:right" > Mob Advance</th >
                                                                                    <th class="red-ths col-xs-2" style = "text-align:right" > Adhoc Advance .</th >
                                                                                    <th class="red-ths col-xs-2" style = "text-align:right" > Total Advance</th >
                                                                                    <th class="red-ths col-xs-3" style = "text-align:right" >Recovery</th >
                                                                                    <th class="red-ths col-xs-3" style = "text-align:right" > Balance </th >
                                                                                </tr>
                                                                            <?php }
                                                                            ?>
                                                                            </thead>
                                                                            <tbody class="main">
                                                                            <?php if($recoveryType['RecoveryTypeId']==7) {?>
                                                                                <tr class="col-xs-12" style="padding:0 !important">
                                                                                    <td class="col-xs-1"><input type="text" class="parent_text text-right" /></td>
                                                                                    <td class="col-xs-1"><input type="text" class="parent_text text-right" /></td>
                                                                                    <td class="col-xs-2"><input type="text" class="parent_text text-right" /></td>
                                                                                    <td class="col-xs-2"><input type="text" class="parent_text text-right" /></td>
                                                                                    <td class="col-xs-2"><input type="text" class="parent_text text-right" /></td>
                                                                                    <td class="col-xs-2"><input type="text" class="parent_text text-right" /></td>
                                                                                    <td class="col-xs-2"><input type="text" class="parent_text text-right" /></td>
                                                                                </tr>
                                                                            <?php } elseif($recoveryType['RecoveryTypeId']==3) {
                                                                                if(isset($advRecv) && count($advRecv) != 0) {
                                                                                    foreach($advRecv as $advRec) {
                                                                                        ?>
                                                                                        <tr class="col-xs-12" style="padding:0 !important">
                                                                                            <td class="col-xs-2"><input type="text" class="parent_text text-right" value="<?php echo $this->commonHelper()->sanitizeNumber($advRec['MobAdvance'],2),0;?>" readonly/></td>
                                                                                            <td class="col-xs-2"><input type="text" class="parent_text text-right" value="<?php echo $this->commonHelper()->sanitizeNumber($advRec['CashAdvance'],2),0;?>" readonly/></td>
                                                                                            <td class="col-xs-2"><input type="text" class="parent_text text-right" value="<?php echo $this->commonHelper()->sanitizeNumber($advRec['TotalAdvance'],2),0;?>" readonly/></td>
                                                                                            <td class="col-xs-3"><input type="text" class="parent_text text-right" value="<?php echo $this->commonHelper()->sanitizeNumber($advRec['Recovery'],2),0;?>" readonly/></td>
                                                                                            <td class="col-xs-3"><input type="text" id="balAdv" class="parent_text text-right" value="<?php echo $this->commonHelper()->sanitizeNumber($advRec['Balance'],2),0;?>" readonly/></td>
                                                                                        </tr>
                                                                                    <?php } }} ?>
                                                                            </tbody>
                                                                            <!--                                                                            <tbody class="total">-->
                                                                            <!--                                                                            <tr class="col-xs-12" style="padding:0 !important">-->
                                                                            <!--                                                                                <td class="col-xs-5" colspan="4">&nbsp;</td>-->
                                                                            <!--                                                                                <td class="rate_pri col-xs-5" align="right">Total</td>-->
                                                                            <!--                                                                                <td class="col-xs-2"colspan="2" width="10%"><input class="parent_text text-right total-clr" readonly="" type="text"></td>-->
                                                                            <!--                                                                            </tr>-->
                                                                            <!--                                                                            </tbody>-->
                                                                        </table>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    <?php   $i++;
                                                }
                                            }?>

                                            <tr class="dont-hide col-xs-12" style="padding:0 !important">
                                                <td class="col-xs-5"colspan="1"> </td>
                                                <td class="rate_pri col-xs-3" align="right">Total</td>
                                                <td class="col-xs-3" colspan="1" width="8%">
                                                    <input class="parent_text text-right total-clr" name="recoveryTotal" id="recoveryTotal" onkeypress="return isDecimal(event,this);" onblur="return FormatNum(this, 2, true)"  type="text" readonly>
                                                </td>
                                                <td class="col-xs-1"></td>
                                            </tr>
                                            </tbody>
                                        </table>
                                        <input type="hidden" name="recoveryRows" id="recoveryRows" value="<?php echo (isset($recoveryTypes) && count($recoveryTypes) != 0) ? count($recoveryTypes) : 1; ?>" />
                                    </div>
                                </td>
                            </tr>
                            <input type="hidden" name="rowid" id="rowid" value="0"/>
                            <input type="hidden" name="deleteids" id="deleteids" value="0"/>

                            <tr style="border-bottom:none; col-xs-12" style="padding:0 !important">
                                <td class="col-xs-8" colspan="4" style="border-right:none;border-top:none;" align="right" class="rate_pri"><label id="rateanal__1_lbltotrate">Net Amount</label></td>
                                <td class="col-xs-3" style="border-right:none;border-top:none;"><input class="parent_text text-right total-clr" type="text" placeholder="00.0" name="totAmount" id="totAmount" onblur="return FormatNum(this, 2, true)" value="<?php echo (isset($soRegister)) ? $soRegister['NetAmount'] : '';?>" readonly/></td>
                                <td class="col-xs-1" style="border-right:none;border-top:none;">&nbsp;</td>
                            </tr>
                            </tbody>
                        </table>
                        <input type="hidden" name="serviceRows" id="serviceRows" value="<?php echo (isset($sbServiceTrans) && count($sbServiceTrans) != 0) ? count($sbServiceTrans) : 1; ?>" />
                    </div>
                </div>
                <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0 col-xs-12 col-xs-offset-0">
                    <div class="col-md-12" style="padding:0 !important;margin-top:30px">
                        <textarea class="lbl_move" style="width:100%; border:1px solid #ddd; height:80px !important;" id="narration"label="Narration" name="narration"><?php if(isset($sbRegister) && $sbRegister['Narration'] != '') { echo $sbRegister['Narration']; } else { echo ''; } ?></textarea>
                    </div>
                </div> <div class="clearfix"></div>
            </form>

        </div>
    </div>
</div><div class="clearfix"></div>
<div id="submitDiv" class="col-lg-12 savebtn_area" style="">
    <ul>
        <li class="dropdown save_btn float_r"><a href="javascript:void(0);" data-toggle="tooltip" class="ripple" title="Submit" onclick="return submitForm();">Submit</a>
            <?php if(isset($sbRegister)){?>
        <li class="cancel_btn cancel_btn_bluecolor float_l"><a href="<?php echo $this->basePath() . '/wpm/workorder/bill-register';?>" class="ripple">Cancel <i class="fa fa-times-circle-o" aria-hidden="true"></i></a></li>
        <?php }else{?>
            <li class="cancel_btn float_r"><a href="<?php echo $this->basePath(); ?>/wpm/workbill/index" class="ripple" title="Go back!" onclick="return showBack('a');">Back</a></li>
        <?php }?>    </ul>
</div>
<script id="I-template" type="text/template" class="hide">
    <tr>
        <td width="30%">
            <input class="parent_text serSuggest" type="text" name="serviceName__" id="serviceName__" onfocus="return checkSBUsed(this);" value=""/>
            <input type="hidden" name="serviceId__" id="serviceId__" />
            <input type="hidden" name="costcentreid__" id="costcentreid__" />
        </td>
        <td width="15%">
            <input type="hidden" name="unitId__" id="unitId__" />
            <input class="parent_text" type="text" name="unitName__" id="unitName__" readonly />
        </td>
        <td width="15%">
            <input class="parent_text text-right" type="text" name="qty__" id="qty__"  onblur="return FormatNum(this, 3),checkqty(this)" onclick="qtyClick(this)"  onkeypress="return isDecimal(event,this);" onchange="return calAmount('__','d');" />
            <div style="position: relative;display:none " id="wfirst__">
                <div class="top-tip top-addtip"style="">
                    <span style="color:white;">EstimateQty:<i id='estimateQty__' style="color:white"></i></span>
                    <span style="color:white;">OrderQty:<i id='orderQty__' style="color:white"></i></span>
                    <span style="color:white;">BilledQty:<i id='billedQty__' style="color:white"></i></span>
                </div>
            </div>
        </td>
        <td width="15%"><input class="parent_text text-right" type="text" name="rate__" id="rate__"  onblur="return FormatNum(this, 2)" onkeypress="return isDecimal(event,this);" onchange="return calAmount('__','d');" readonly/></td>
        <td width="20%">
            <input class="parent_text text-right" type="text" name="amount__" id="amount__" onblur="return FormatNum(this, 2)" readonly />
            <input type="hidden" name="eAmount__" id="eAmount__" />
        </td>
        <td width="5%" align="center" class="action_btns_td">
            <ul class="action_btns">
                <li>
                    <a href="javascript:void(0);" class="serviceDelete__"  id="serviceDelete__" onclick="deleteServiceRow(this, event);" id="" style="display:none;"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i></a>
                </li>
                <li>
                    <a  class="mainTr" id="expandTr__" style="display:none;"> <i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="left" data-original-title="Add lines" ></i></a>
                </li>

            </ul>
        </td>
    </tr>
    <tr id="subTr__" style="display:none;" class="subTr">
        <td colspan="9" style="padding:0px !important; ">
            <div class="subDiv" style="display:none;">
                <div class="col-lg-12">
                    <div class="scrl">
                        <div class="table-responsive topsp">
                            <table class="table" style="margin-bottom:0px;" id="serServiceTable__">
                                <thead>
                                <tr>
                                    <th>SDNo</th>
                                    <th>SDDate</th>
                                    <th>SDQty</th>
                                    <th>Billed Qty</th>
                                    <th>BalQty</th>
                                    <th>CurrentQty</th>
                                    <th></th>
                                </tr>
                                </thead>
                                <tbody class="main">
                                </tbody>
                                <input type="hidden" name="ser___rowid" id="ser___rowid" value="0"/>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </td>
    </tr>
</script>
<script id="II-template"  type="text/template" class="hide">
    <tr>
        <td width="15%">
            <input type="hidden"  name="ser___id_0" id="ser___id_0" readonly/>
            <input type="hidden"  name="ser___transid_0" id="ser___transid_0" readonly/>
            <input class="parent_text border-none" type="text" name="ser___no_0" id="ser___no_0" readonly/>
            <input class="parent_text border-none" type="hidden" name="ser___serviceid_0" id="ser___serviceid_0" readonly/>
        </td>
        <td width="17%">
            <input class="parent_text mainTr" type="text" name="ser___date_0" id="ser___date_0"  style="text-align:right;"  readonly/>
        </td>
        <td width="17%">
            <input class="parent_text mainTr" type="text" name="ser___qty_0" id="ser___qty_0"  style="text-align:right;" onblur="return FormatNum(this, 3)"  readonly/>
        </td>
        <td width="17%">
            <input class="parent_text mainTr" type="text" name="ser___orderqty_0" id="ser___orderqty_0"  style="text-align:right;" onblur="return FormatNum(this, 3)"  readonly/>
        </td>
        <td width="17%">
            <input class="parent_text mainTr" type="text" name="ser___balqty_0" id="ser___balqty_0"  style="text-align:right;" onblur="return FormatNum(this, 3)" readonly/>
        </td>
        <td width="17%">
            <input class="parent_text mainTr" type="text" name="ser___curqty_0" id="ser___curqty_0"  style="text-align:right;" onblur="return FormatNum(this, 3)" onkeypress="return isDecimal(event,this);" onchange="CalcurQty(this)" />
        </td>
    </tr>
</script>
<script>
    $("#backPrev").hide();
    var serviceList = '[]';
    var tmp_serviceList = serviceList;
    var arr_requestResources=<?php echo (isset($arr_requestResources)) ? json_encode($arr_requestResources) : '[]';?>;
    var arr_resources=<?php echo (isset($arr_resources)) ? json_encode($arr_resources) : '[]';?>;

    $(function(){
        $('.ripple').materialripple();
        nextAccordian(1);

        expandQualTrFn();
        bindQualExpandTr();
        bindPopOver();
        getServices();
        $('#serviceType').on('change',function(){
            getServices();
        });
        <?php if($serBillId!= 0){
    $i=1;
    foreach($recoveryTypes as $recoveryType){?>
        $('#recoveryAmount_'+<?php echo $i;?>).val('<?php echo $recoveryType['Amount'];?>').trigger('blur').trigger('change');
        $('#hiddenRecoveryAmount_'+<?php echo $i;?>).val('<?php echo $recoveryType['Amount'];?>');
        $('#recoveryAccount_'+<?php echo $i;?>).val('<?php echo $recoveryType['AccountId'];?>');
        <?php if($recoveryType['Sign'] == "-"){?>
        $('#recoverySpanId_'+<?php echo $i;?>).removeClass('fa fa-plus clr-gre');
        $('#recoverySpanId_'+<?php echo $i;?>).addClass('fa fa-minus clr-red');
        $('#recoverySign_'+<?php echo $i;?>).val('-');
        <?php }else{?>
        $('#recoverySpanId_'+<?php echo $i;?>).removeClass('fa fa-minus clr-red')
        $('#recoverySpanId_'+<?php echo $i;?>).addClass('fa fa-plus clr-gre');
        $('#recoverySign_'+<?php echo $i;?>).val('+');
        <?php } ?>
        <?php  $i++; }?>
        <?php } ?>

        var $serRowId = $('#serviceRows');
        var iTemplate = $('#I-template').html();
        var iiTemplate = $('#II-template').html();
        var srowid = 0;
        if(arr_requestResources.length != 0) {
            $.each(arr_requestResources, function(i, o) {
                srowid += 1;
//                $('#serviceTable tbody').find('.total').before(iTemplate.replace(/__/g, '_' + srowid));
                $('#serviceBillWrapper').before(iTemplate.replace(/__/g, '_' + srowid));
                $('#unitName_'+srowid).val(o.UnitName);
                $('#unitId_'+srowid).val(o.UnitId);
                $('#serviceName_'+srowid).val(o.Desc);
                $('#serviceId_'+srowid).val(o.ServiceId);
//                $('#costcentreid_'+srowid).val(o.CostCentreId);
                $('#qty_'+srowid).val(o.Qty).trigger('change').trigger('blur').attr('readonly',true);
                $('#rate_'+srowid).val(o.Rate).trigger('change').trigger('blur');
                $('#amount_'+srowid).trigger('change').trigger('blur');
                $('#serviceDelete_'+srowid).show();
                $("#serviceType").prop('disabled', true);
                var oQty = 0;
                var bQty = 0;
                var eQty = 0;
                var eAmt = 0;
                $.ajax({
                    url: getBaseURL() + 'wpm/labourstrength/get-order-qty',
                    type: "post",
                    data: {'ccId': $('#costCentreId').val(),soId:$('#SORegisterId').val(),'Type': 'getorderqty',serviceId:o.ServiceId},
                    async: false,
                    success: function (data, textStatus, jqXHR) {
                        if(jqXHR.status == 200) {
                            data = JSON.parse(data);
                            oQty = data.OQty;
                            if (oQty == null) {
                                oQty = 0;
                            }
                            bQty = data.bQty;
                            if (bQty == null) {
                                bQty = 0;
                            }
                            eQty = data.eQty;
                            if (eQty == null) {
                                eQty = 0;
                            }
                            eAmt = data.eAmt;
                            if (eAmt == null) {
                                eAmt = 0;
                            }

                            $('#orderQty_'+ srowid).html(sanitizeNumber(parseFloatVal(oQty),3));
                            $('#billedQty_'+ srowid).html(sanitizeNumber(parseFloatVal(bQty),3));
                            $('#estimateQty_'+ srowid).html(sanitizeNumber(parseFloatVal(eQty),3));
                            $('#eAmount_'+ srowid).val(eAmt);
                        }
                    }, error: function (jqXHR, textStatus, errorThrown) {
                    }
                });
                var reqCount = 0;
                if(arr_resources.length != 0) {
                    $('#expandTr_' + srowid).show();
                    $.each(arr_resources, function (m, n) {
                        if (o.ServiceId != n.ServiceId ) {
                            return;
                        }
                        reqCount = reqCount+1;
                        var reqrowid = parseInt($('#ser_'+ srowid+'_rowid').val()) + 1;
                        $('#serServiceTable_' + srowid).find('tbody.main').append(iiTemplate.replace(/__/g, '_' + srowid).replace(/_0/g, '_' + reqrowid));
                        $('#ser_' + srowid + '_rowid').val(reqrowid);
                        $('#ser_' + srowid + '_id_' + reqrowid).val(n.SDRegisterId);
                        $('#ser_' + srowid + '_serviceid_' + reqrowid).val(n.ServiceId);
                        $('#ser_' + srowid + '_transid_' + reqrowid).val(n.SDServiceTransId);
                        $('#ser_' + srowid + '_no_' + reqrowid).val(n.SDNo);
                        $('#ser_' + srowid + '_date_' + reqrowid).val(n.SDDate);
                        $('#ser_' + srowid + '_qty_' + reqrowid).val(n.Qty).trigger('blur');
                        $('#ser_' + srowid + '_orderqty_' + reqrowid).val(n.SOQty).trigger('blur');
                        $('#ser_' + srowid + '_balqty_' + reqrowid).val(n.BalQty).trigger('blur');
                        $('#ser_' + srowid + '_curqty_' + reqrowid).val(n.CurQty).trigger('blur').trigger('change');
                    });
                }
            });
        }
        addServiceRow(srowid);
        $('.content_wrapper').on('click', '.mainTr', function (e) {
            e.preventDefault();
            if (!$(this).closest("tr").next(".subTr").is(":visible")) {
                $(this).closest("tr").next(".subTr").show();
                $(this).closest("tr").next(".subTr").find(".subDiv").slideDown("slow");
                $(this).find("i").addClass("tform");
            }
            else {
                $(this).closest("tr").next(".subTr").find(".subDiv").slideUp("slow");
                $(this).closest("tr").next(".subTr").slideUp("slow");
                $(this).find("i").removeClass("tform");
            }
        });
        nextAccordian(1);
    });

    $('.cnt_slider .carousel').carousel({
        interval: false
    });

    function CalcurQty(x){
        var $x = $(x);
        var ids = $x[0].id.split('_');
        var rowid = ids[1];
        var reqrowid = ids[3];
        var balQty=$('#ser_'+rowid+'_balqty_'+reqrowid).val();
        var curQty=$('#ser_'+rowid+'_curqty_'+reqrowid).val();
        $('#qty_'+rowid).val(curQty).trigger('blur').trigger('change');
        if(parseFloat(curQty)>parseFloat(balQty)){
            alert("current Qty should not be grater than Balance Qty");
            $('#ser_'+rowid+'_curqty_'+reqrowid).val(0);
            $('#qty_'+rowid).val(0).trigger('blur');
            return false;
        }
        var sumAmt = 0;
        $.each($('input[id^=ser_'+rowid+'_curqty_'), function() {
            var seAmt = parseFloat($(this).val());

            if (isNaN(seAmt))
                return;

            sumAmt += seAmt;
        });
        $('#qty_'+rowid).val(sanitizeNumber(sumAmt,3,true));
    }

    function addServiceRow(x){
        var srowid=x;
        var iTemplate = $('#I-template').html();
        var $serRowId = $('#serviceRows');
        srowid ++;
//        $('#serviceTable tbody').find('.total').before(iTemplate.replace(/__/g, '_' + srowid));
        $('#serviceBillWrapper').before(iTemplate.replace(/__/g, '_' + srowid));
        $serRowId.val(srowid);
    }

    function nextAccordian(id)
    {
        $('#panelheading-' + id).trigger('click');
    }

    var $costCentreId = $('#costCentreId'),
        $vendorId = $('#vendorId'),
        $serBillType = $('#serBillType'),
        $soRegId = $('#soRegId'),
        $sdRegId = $('#sdRegId');

    function validateLabStg()
    {
        $('.error_message').hide();
        var currentIndex = $('#carousel-example-generic .item.active').index();
        if(currentIndex == 0) {
            var lCostCentreId = isNullCheck($costCentreId.val(),'number');
            var lVendorId = isNullCheck($vendorId.val(),'number');

            if (lCostCentreId == 0) {
                $costCentreId.closest('.form-group').find(".error_message").show();
                return;
            } else {
                var projName = $('#costCentreId option:selected').text();
                $('.projName').val(projName);
//			$('.sprojName').html(projName);
                $('#sbDate').val($('#sbeDate').val());
            }

            if (lVendorId == 0) {
                $vendorId.closest('.form-group').find(".error_message").show();
                return;
            } else {
                if ($serBillType.val() != '') {
                    if ($serBillType.val() == 'D') {
                        if ($sdRegId.val() == 0) {
                            $sdRegId.closest('.form-group').find(".error_message").show();
                            return;
                        }
                        var sdName = $('#sdRegId option:selected').text();
                        $('#soDivTag').hide();
                        $('#sdDivTag').show();
                        $('.soName').val('');
                        $('.sdName').val(sdName);
                        $('#soLiTag').hide();
                        $('#sdLiTag').show();
//                    $('.ssoName').html('');
                        $('.ssdName').html(sdName);
                    } else if ($serBillType.val() == 'O') {
                        if ($soRegId.val() == 0) {
                            $soRegId.closest('.form-group').find(".error_message").show();
                            return;
                        }
                        var soName = $('#soRegId option:selected').text();
                        $('#sdDivTag').hide();
                        $('#soDivTag').show();
                        $('.sdName').val('');
                        $('.soName').val(soName);
                        $('#sdLiTag').hide();
                        $('#soLiTag').show();
                        $('.ssdName').html('');
//                    $('.ssoName').html(soName);
                    }
                    var conName = $('#vendorId option:selected').text();
                    $('.conName').val(conName);
//                $('.sconName').html(conName);
                    $('#carousel-example-generic').carousel({
                        slide: "next"
                    });
                }
            }
        }  else {
            finalNext();
        }
    }

    function finalNext()
    {
        $.post(getBaseURL() + 'wpm/labourstrength/get-comp-cc-no', {
                typeId: $('#sbTypeId').val(),
                ccId: $costCentreId.val()
            },
            function (data) {
                var vNo = data.split('###');
                $('#ccSbNo').val($.trim(vNo[0]));
                $('#compSbNo').val$.trim((vNo[1]));
                if($.trim(vNo[0]) != '')
                    $('#ccSbNo').prop('readonly', true);
                if($.trim(vNo[1]) != '')
                    $('#compSbNo').prop('readonly', true);
            });

        var postUrl = '';
        var sdRgId = $sdRegId.val();
        var soRgId = $soRegId.val();

        if(sdRgId != '' && sdRgId != 0 && sdRgId != null) {
            var postUrl = 'wpm/labourstrength/get-done-services';
        } else if(soRgId != '' && soRgId != 0 && soRgId != null) {
            var postUrl = 'wpm/labourstrength/get-order-services';
        }
        if(sdRgId != '' || soRgId != '') {
            $.post(getBaseURL()+postUrl, { sdRegId: sdRgId, soRegId: soRgId },
                function(data) {
                    serviceList = JSON.parse(data);
                    tmp_serviceList = serviceList;
                    bindServiceAutoComplete();
                });
        }
    }

    function submitForm()
    {
        var errFlag = 0;
        var sbRows = $('#serviceRows').val();
        var recoveryRows = $('#recoveryRows').val();
        var sbCnt = 0;
        for(var r=1;r<=recoveryRows;r++){
            var recoveryAmts=$('#recoveryAmount_'+r).val();
            if(recoveryAmts > 0){
                if($('#recoveryAccount_'+r).val() == '' || $('#recoveryAccount_'+r).val() == null){
                    $('#recoveryAccount_'+r).addClass('red_bdr');
                    $('#recoveryAccount_'+r).focus();
                    var recoveryName=$('#recoveryName_'+r).val();
                    alert("Please Select "+recoveryName+" Account Name ");
                    errFlag = 1;
                    return false;
                }
            }
        }
        $('.error_message').hide();
        $('.red_bdr').removeClass('red_bdr');

        if($.trim($('#fromDate').val()) != '' && $.trim($('#toDate').val()) != '') {
            if (!compareDate($('#fromDate').val(), $('#toDate').val())) {
                $('#toDate').addClass('red_bdr');
                $('#toDate').focus();
                errFlag = 1;
                return false;
            }
        }
        if($.trim($('#sbNo').val()) == '') {
            $('#sbNo').addClass('red_bdr');
            $('#sbNo').focus();
            errFlag = 1;
            return false;
        }
        if($.trim($('#ccSbNo').val()) == '') {
            $('#ccSbNo').addClass('red_bdr');
            $('#ccSbNo').focus();
            errFlag = 1;
            return false;
        }
        if($.trim($('#compSbNo').val()) == '') {
            $('#compSbNo').addClass('red_bdr');
            $('#compSbNo').focus();
            errFlag = 1;
            return false;
        }
        if($.trim($('#refNo').val()) == '') {
            $('#refNo').addClass('red_bdr');
            $('#refNo').focus();
            errFlag = 1;
            return false;
        }
        for (var i = 1; i <= sbRows; i++) {
            if($('#serviceId_'+i).val() == '') {
                sbCnt = sbCnt + 1;
            }
        }
        if(sbRows == sbCnt) {
            $(".selOne").show();
            errFlag = 1;
            return false;
        }

        if(errFlag == 0) {
            $('#formWrapper').submit();
        }
    }

    function deleteServiceRow(x,e)
    {
        e.preventDefault();
        if (!confirm('Do you want to Delete'))
            return false;

        var $tr = $(x).closest('tr'),
            $tbody = $tr.parent('tbody');
        var $x = $(x);
        var ids = $x[0].id.split('_');
        var rowid =ids[1];

        if ($tbody.find('> tr:not(.total)').length == rowid) {
            var iTemplate = $('#I-template').html();
            $('#serviceTable tbody').find('.total').before(iTemplate.replace(/__/g, '_' + rowid));
            $('#serviceRows').val(rowid);
        }

        var mqty=parseFloat($('#totalAmount').val())-parseFloat($('#amount_'+rowid).val());
        $('#totalAmount').val(mqty).trigger('blur');
        $('#totAmount').val(mqty).trigger('blur');
        $tr.remove();
        return false;
    }
    function bindreqdetails(x){
        var rowid = $(x)[0].id.split('_')[1];
        var CostCenterId = $('#costcentreid_'+rowid).val();
        var serviceid = $('#serviceId_'+rowid).val();
        $('.loading_area').show();
        $.ajax({
            url: getBaseURL() + 'wpm/labourstrength/service-bill',
            type: "post",
            data: {'CostCenterId': CostCenterId,'serviceid': serviceid},
            async: false,
            success: function (data, textStatus, jqXHR) {
                if (jqXHR.status == 200) {
                    var data = JSON.parse(data);
                    var iiTemplate = $('#II-template').html();
                    $.each(data, function (i, n) {

//                        var findRes = arr_resources.filter(function(obj) {
//                            return (obj.CostCentreId === CostCentreId && obj.ServiceId === l.ServiceId);
//                        });
                        if(data.length > 0) {
                            $('#expandTr_' + rowid).show();
                            var reqrowid = parseInt($('#ser_'+ rowid+'_rowid').val()) + 1;
                            $('#serServiceTable_' + rowid).find('tbody.main').append(iiTemplate.replace(/__/g, '_' + rowid).replace(/_0/g, '_' + reqrowid));
                            $('#ser_' + rowid + '_rowid').val(reqrowid);
                            $('#qty_'+ rowid).trigger('change').attr('readonly',true);
                            $('#ser_' + rowid + '_id_' + reqrowid).val(n.SDRegisterId);
                            $('#ser_' + rowid + '_serviceid_' + reqrowid).val(n.ServiceId);
                            $('#ser_' + rowid + '_transid_' + reqrowid).val(n.SDServiceTransId);
                            $('#ser_' + rowid + '_no_' + reqrowid).val(n.SDNo);
                            $('#ser_' + rowid + '_date_' + reqrowid).val(n.SDDate);
                            $('#ser_' + rowid + '_qty_' + reqrowid).val(n.Qty).trigger('blur');
                            $('#ser_' + rowid + '_orderqty_' + reqrowid).val(n.SOQty).trigger('blur');
                            $('#ser_' + rowid + '_balqty_' + reqrowid).val(n.BalQty).trigger('blur');
                            $('#ser_' + rowid + '_curqty_' + reqrowid).val(n.CurQty).trigger('blur').trigger('change');
                        }
                    });
                }
                $('.loading_area').hide();
            }, error: function (jqXHR, textStatus, errorThrown) {
                $('.loading_area').hide();
            }
        });

    }
    function bindServiceAutoComplete(sdRgId, soRgId)
    {
        $('#serviceTable .serSuggest').autocomplete({
            lookup: tmp_serviceList,
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            }, onSelect: function(suggestion) {
                if(suggestion) {
                    var $this = $(this);
                    var key1 = $this[0].id.split('_')[1];
                    $this.prop('readonly', true).addClass('border-none');
                    $('#serviceId_'+ key1).val(suggestion.data);
                    $('#serviceName_'+ key1).val(suggestion.value);
                    $('#unitId_'+ key1).val(suggestion.UnitId);
                    $('#unitName_'+ key1).val(suggestion.UnitName);
                    $('#costcentreid_'+ key1).val(suggestion.CostCentreId);
                    $('#rate_'+ key1).val(suggestion.Rate).trigger('blur').trigger('change');
//                    $("#workOrPeriod").prop('disabled', true);
                    $("#serviceType").prop('disabled', true);
                    var oQty = 0;
                    var bQty = 0;
                    var eQty = 0;
                    var eAmt = 0;
                    $.ajax({
                        url: getBaseURL() + 'wpm/labourstrength/get-order-qty',
                        type: "post",
                        data: {'ccId': $('#costCentreId').val(),soId:$('#SORegisterId').val(),'Type': 'getorderqty',serviceId:suggestion.data},
                        async: false,
                        success: function (data, textStatus, jqXHR) {
                            if(jqXHR.status == 200) {
                                data = JSON.parse(data);
                                oQty = data.OQty;
                                if (oQty == null) {
                                    oQty = 0;
                                }
                                bQty = data.bQty;
                                if (bQty == null) {
                                    bQty = 0;
                                }
                                eQty = data.eQty;
                                if (eQty == null) {
                                    eQty = 0;
                                }
                                eAmt = data.eAmt;
                                if (eAmt == null) {
                                    eAmt = 0;
                                }
                                $('#orderQty_'+ key1).html(sanitizeNumber(parseFloatVal(oQty),3));
                                $('#billedQty_'+ key1).html(sanitizeNumber(parseFloatVal(bQty),3));
                                $('#estimateQty_'+ key1).html(sanitizeNumber(parseFloatVal(eQty),3));
                                $('#eAmount_'+ key1).val(eAmt);
                            }
                        }, error: function (jqXHR, textStatus, errorThrown) {
                        }
                    });
                    $('#serviceDelete_' + key1).show();
                    addServiceRow(key1);
                    bindreqdetails($this);
                    removeError($(this));
                }
            }, onSearchStart: function(suggestion) {
                var $this = $(this);
                var key1 = $this[0].id.split('_')[1];

                $('#serviceId_'+key1).val('');
                $('#unitId_'+ key1).val('');
                $('#unitName_'+ key1).val('');
            }, onSearchComplete: function (query, suggestions) {
                if(!suggestions.length){
                    $(this).addClass('error');
                } else
                    removeError($(this));
            }
        });
    }

    function checkSBUsed(x) {
        var id = $(x)[0].id.split('_')[1];
        var reskeyid = $('input[id*=serviceId_]');
        tmp_serviceList = serviceList;
        tmp_serviceList = $.grep(serviceList, function (element, index) {
            var is_selected = true;
            $.each(reskeyid, function (i, obj) {
                var $this = $(this),
                    name = $this[0].id;
                var arrname = name.split('_');
                var key1 = arrname[1];
                if (key1 != id) {
                    if (element.data == $this.val()) {
                        is_selected = false;
                        return false;
                    }
                }
            });
            return is_selected;
        });
        bindServiceAutoComplete();
    }

    function getServices()
    {
        var serviceOrderId= $('#soRegisterId').val();
        var CostCentreId= $('#costCentreId').val();
        var serviceType= $('#serviceType').val();
        if(serviceOrderId != '') {
            var serviceOrderId=0;
        }
        $.post(getBaseURL()+'wpm/labourstrength/get-done-services', { soRegId:serviceOrderId,serTypeId:serviceType,costId:CostCentreId },
            function(data) {
                serviceList = JSON.parse(data);
                tmp_serviceList = serviceList;
            });
//        }
    }

    function calAmount(roId,roType)
    {
        var amt = 0;
        if(roType == 'r') {
            rId = roId;
        } else {
            var roIdSp = roId.split('_');
            rId = roIdSp[1];
        }
        if($('#qty_' + rId).val() != '' && $('#rate_' + rId).val() != '') {
            var amt = parseFloat($('#qty_' + rId).val()) * parseFloat($('#rate_' + rId).val());
        }
        $('#amount_'+rId).val(amt).trigger('blur').trigger('change');

        sumAmount();
    }

    function sumAmount()
    {
        var $samt = $('input[id^=amount_]');
        var sumAmt = 0;
        $.each($samt, function() {
            var seAmt = parseFloat($(this).val());

            if (isNaN(seAmt))
                return;

            sumAmt += seAmt;
        });
        $('#totalAmount').val(numberFormat(sumAmt,'C')).trigger('change');
        var totRecovery=$('#recoveryServiceBill').val();
        var totQualifier=$('#qualAmt').val();
        var totBase=$('#totalAmount').val();
        $('#totAmount').val(numberFormat((parseFloatVal(totBase)+parseFloatVal(totQualifier)+parseFloatVal(totRecovery)),'C'));
    }

    <?php if(isset($sbServiceTrans) && count($sbServiceTrans) != 0) { ?>
    getServices();
    $('.cancel_btn').hide();
    <?php if($sbRegister['SDRegisterId'] != '' && $sbRegister['SDRegisterId'] != null && $sbRegister['SDRegisterId'] != 0) { ?>
    $('#sdLiTag').show();
    <?php } else if($sbRegister['SORegisterId'] != '' && $sbRegister['SORegisterId'] != null && $sbRegister['SORegisterId'] != 0) { ?>
    $('#soLiTag').show();
    <?php } ?>
    //insertServiceRow();
    sumAmount();
    <?php } ?>
    /* For Service */

    <?php if($frmInd == 1) { ?>
    $costCentreId.val('<?php echo $ccId; ?>').trigger('change');
    $vendorId.val('<?php echo $venId; ?>').trigger('change');
    $serBillType.val('<?php echo $sbiType; ?>').trigger('change');

    var projName = $('#costCentreId option:selected').text();
    $('.projName').val(projName);
    //$('.sprojName').html(projName);
    $('#sbDate').val($('#sbeDate').val());

    var conName = $('#vendorId option:selected').text();
    $('.conName').val(conName);
    //$('.sconName').html(conName);
    //getServiceOrderOrDone('<?php //echo $srId; ?>//', '<?php //echo $sdrId; ?>//');
    <?php } ?>
    <?php if(isset($sbRegister)){?>
    <?php if($sbRegister['Approve'] == 'Y'){?>
    $('.save_btn').hide();
    <?php } }?>

    //Qualifier start
    function expandQualTrFn(reset) {
        var $mainTRs = $("a[class*=qualTr]");
        if (typeof reset !== 'undefined' && reset === true) $mainTRs.unbind('click');
        $mainTRs.click(function(e){
            e.preventDefault();
            var name = $(this)[0].className;
//            key = name.split('_')[1];
//        if (validateRow(name) == false) return false;
            var $subTr = $(this).closest("tr").nextAll(".qualmainTr"),
                $i = $(this).find("i");
            if(!$subTr.is(":visible")){
                $subTr.show();
                $subTr.find(".subDiv").slideDown("slow");
                $i.removeClass("fa-chevron-circle-down");
                $i.addClass("fa-chevron-circle-up");
//            $('rateanal_'+ key +'_restable').show();
//            iFocusRowId = key;
                closeQualdetails();
            } else {
                $subTr.find(".subDiv").slideUp("slow");
                $subTr.slideUp("slow");
                $i.removeClass("fa-chevron-circle-up");
                $i.addClass("fa-chevron-circle-down");
            }
            return false;
        });
    }

    function closeQualdetails(key) {
        var $mainTRs = $("a[class*=qualTr]");
        $.each($mainTRs, function (i, obj) {
            var $this = $(this),
                $mainTr = $this.find('> i.fa-chevron-circle-down.tform');
//        if (typeof key != 'undefined' && $this[0].className.indexOf(key) != -1) return;
            if($mainTr.length != 0) $mainTr.trigger('click');
        });
    }

    function bindQualExpandTr() {
        var $mainTr = $(".qualmainExp");
        $mainTr.unbind('click');
        $mainTr.click(function (e) {
            e.preventDefault();
            if (!$(this).closest("tr").next(".qualsubTr").is(":visible")) {
                closeQualTr();
                $(this).closest("tr").next(".qualsubTr").show();
                $(this).closest("tr").next(".qualsubTr").find(".subDiv").slideDown("slow");
            }
            else {
                $(this).closest("tr").next(".qualsubTr").find(".subDiv").slideUp("slow");
                $(this).closest("tr").next(".qualsubTr").slideUp("slow");
            }
        });
    }

    function closeQualTr() {
        var $mainTr = $(".qualmainExp");
        $.each($mainTr, function () {
            $(this).closest("tr").next(".qualsubTr").find(".subDiv").slideUp("slow");
            $(this).closest("tr").next(".qualsubTr").slideUp("slow");
        });
    }

    function bindPopOver() {
        var $inputs =  $('input[data-toggle="popover"]');
        $inputs.unbind('popover');
        $inputs.popover({
            placement : 'auto left',
            trigger : 'hover'
        });
    }

    function myfunc(x){
        $(".base").val(x);
        CalcQualifier();
        var $mainTr = $(".qualChange");
        $mainTr.change(function (e) {
            CalcQualifier();
        });
    }

    function CalcQualifier() {
        $.each($(".base"), function () {
            var qId = $(this).attr('id').split('_')[4];
            var iId = $(this).attr('id').split('_')[2];
            var sFormula = isNullCheck($('#QualR__' + iId + '_Exp_' + qId).val(), 'string');
            var dbaseAmt = isNullCheck($('#QualR__' + iId + '_ExpValue_' + qId).val(), 'string');
            var dPer = parseFloatVal(isNullCheck($('#QualR__' + iId + '_ExpPer_' + qId).val(), 'number'));
            var sbaseRef = 'R0';
            if (parseFloatVal(dPer) == 0) dPer = 100;
            var sFormula = sFormula.replace(new RegExp(sbaseRef, 'g'), dbaseAmt);
            var fvaule = computeEval(sFormula);
            var iQualTypeid = $('#QualR__' + iId + '_TypeId_' + qId).val();
            var dAmt=0;
            if (iQualTypeid==1 || iQualTypeid==2) {
                var dTaxablePer = parseFloatVal(isNullCheck($('#QualR__' + iId + '_TaxablePer_' + qId).val(),'number'));
                var dTaxPer = parseFloatVal(isNullCheck($('#QualR__' + iId + '_TaxPer_' + qId).val(),'number'));
                var dCess = parseFloatVal(isNullCheck($('#QualR__' + iId + '_CessPer_' + qId).val(),'number'));
                var dEDCess = parseFloatVal(isNullCheck($('#QualR__' + iId + '_EduCessPer_' + qId).val(),'number'));
                var dHEDCess = parseFloatVal(isNullCheck($('#QualR__' + iId + '_HEduCessPer_' + qId).val(),'number'));
                var dNetPer = dTaxPer + (dTaxPer * (dCess +  dEDCess + dHEDCess))/100;
                $('#QualR__' + iId + '_NetPer_' + qId).val(dNetPer);

                $('#QualR__' + iId + '_NetPer_' + qId).val(numberFormat(dNetPer,'C'));
                $('#QualR__' + iId + '_ExpPer_'+ qId).val(numberFormat(dNetPer,'C'));

                var dTaxableAmt =  fvaule* (dTaxablePer/100);
                var dTaxAmt =  dTaxableAmt* (dTaxPer/100);
                var dCessAmt =  dTaxAmt* (dCess/100);

                var dEDAmt =  dTaxAmt* (dEDCess/100);
                var dHEDAmt =  dTaxAmt* (dHEDCess/100);
                var dNetAmt = dTaxAmt+dCessAmt+dEDAmt+dHEDAmt;

                $('#QualR__' + iId + '_TaxableAmt_'+ qId).val(numberFormat(dTaxableAmt,'C'));
                $('#QualR__' + iId +  '_TaxPerAmt_'+ qId).val(numberFormat(dTaxAmt,'C'));
                $('#QualR__' + iId + '_CessAmt_'+ qId).val(numberFormat(dCessAmt,'C'));
                $('#QualR__' + iId + '_EduCessAmt_'+ qId).val(numberFormat(dEDAmt,'C'));
                $('#QualR__' + iId + '_HEduCessAmt_'+ qId).val(numberFormat(dHEDAmt,'C'));
                $('#QualR__' + iId + '_NetAmt_'+ qId).val(numberFormat(dNetAmt,'C'));

                dAmt = dNetAmt;
            }else{
                dAmt = parseFloatVal(fvaule) * (parseFloatVal(dPer) / 100);
            }
//        var dAmt = parseFloatVal(fvaule) * (parseFloatVal(dPer) / 100);
            $('#QualR__' + iId + '_Amount_' + qId).val(numberFormat(dAmt,'C'));
        });
        sign();
    }

    function sign(){
        var tot=0;
        $.each($(".signCh"), function () {
            var qId = $(this).attr('id').split('_')[4];
            var iId = $(this).attr('id').split('_')[2];
            var cAmt=parseFloatVal($('#QualR__' + iId + '_Amount_' + qId).val());
            var yesNo=$('#QualR__' + iId +'_YesNo_'+ qId).is(':checked');
            var sSign='-';
            if ($('#QualR__' + iId +'_SignC_' + qId).hasClass("fa-plus")) {
                sSign='+';
            }
//        console.log(sSign)

//        console.log(QualRTotalAmt__1)
            if(yesNo== true){
                if (sSign =="-") {
                    tot = tot - parseFloatVal(cAmt);
                } else {
                    tot = tot + parseFloatVal(cAmt);
                }
            }
        });
        $('#QualRTotalAmt__1').val(numberFormat(tot,'C'));
        $('#qualAmt').val(numberFormat(tot,'C'));
        var totRecovery=$('#recoveryServiceBill').val();
        var totQualifier=$('#qualAmt').val();
        var totBase=$('#totalAmount').val();
        $('#totAmount').val(numberFormat((parseFloatVal(totBase)+parseFloatVal(totQualifier)+parseFloatVal(totRecovery)),'C'));
    }

    function signChange(x) {
        var $this = $(x);
        if ($this.hasClass( "fa-plus" )) {
            $this.removeClass('fa-plus clr-gre');
            $this.addClass('fa-minus clr-red');
            var sname= $this[0].id.split('_')[0],
                key1 = $this[0].id.split('_')[1],
                key2 = $this[0].id.split('_')[3];
            $('#' +  sname + '_' + key1 + '_Sign_' + key2).val('-');
        } else {
            $this.removeClass('fa-minus clr-red');
            $this.addClass('fa-plus clr-gre');
            var sname= $this[0].id.split('_')[0],
                key1 = $this[0].id.split('_')[1],
                key2 = $this[0].id.split('_')[3];
            $('#' +  sname + '_' + key1 + '_Sign_' + key2).val('+');
        }
        sign();
    }
    function validPercent(){
        CalcQualifier();
    }
    function yesNo(){
        CalcQualifier();
    }
    //recovery
    function recoverySignChange(x) {
        var $this = $(x);
        if ($this.hasClass( "fa-minus" )) {
            $this.removeClass('fa-minus clr-red');
            $this.addClass('fa-plus clr-gre');
            var sname= $this[0].id.split('_')[0],
                key1 = $this[0].id.split('_')[1];

            $('#recoverySign_'+key1).val('+');
        } else {
            $this.removeClass('fa-plus clr-gre');
            $this.addClass('fa-minus clr-red');
            var sname= $this[0].id.split('_')[0],
                key1 = $this[0].id.split('_')[1];
            $('#recoverySign_'+key1).val('-');
        }
        recoveryTotAmt();
    }
    function recoveryTotAmt()
    {
        var tot=0;
        var balAdv=parseInt($('#balAdv').val());
        $.each($(".amtCh"), function () {
            var qId = $(this).attr('id').split('_')[1];
            if(qId == 3){
                var advAmt=parseInt($('#recoveryAmount_' + qId).val());
                var hiddenAdvAmt=parseInt($('#hiddenRecoveryAmount_' + qId).val());
                if(parseFloat(balAdv+hiddenAdvAmt) < parseFloat(advAmt)){
                    alert("Greater Than Balance Advance Amount");
                    $('#recoveryAmount_' + qId).val(0);
                    return false;
                }
            }
            var sumAmt=parseFloatVal($('#recoveryAmount_' + qId).val());
            var sSign='+';
            if ($('#recoverySign_' +qId).val() == "-") {
                sSign='-';
            }
            if (sSign =="-") {
                tot = tot - parseFloatVal(sumAmt);
            } else {
                tot = tot + parseFloatVal(sumAmt);
            }
        });

        $('#recoveryTotal').val(tot).trigger('blur');
        $('#recoveryServiceBill').val(tot).trigger('blur');
        var totRecovery=$('#recoveryServiceBill').val();
        var totQualifier=$('#qualAmt').val();
        var totBase=$('#totalAmount').val();
        $('#totAmount').val(numberFormat((parseFloatVal(totBase)+parseFloatVal(totQualifier)+parseFloatVal(totRecovery)),'C'));
    }
    //validate
    // qty validate
    function qtyClick(x){
        var $x = $(x);
        var ids = $x[0].id.split('_');
        var rowid =ids[1];
        $('#wfirst_' + rowid).show();
    }
    function checkqty(x,y){
        var $x = $(x);
        var ids = $x[0].id.split('_');
        var rowid =ids[1];
        var eAmt=parseInt($('#eAmount_'+rowid).val());
        var cAmt=parseInt($('#amount_'+rowid).val());
        $('#wfirst_' + rowid).hide();
        if (parseFloat(eAmt) < parseFloat(cAmt)) {
            $('#amount_' + rowid).addClass('red_bdr');
            return false;
        } else {
            $('#amount_' + rowid).removeClass('red_bdr');
        }
//        var etVal=parseInt($('#workingSet_'+rowid).text());
//        var rateVal=parseInt($('#rateSet_'+rowid).text());
//        var cQty=parseInt($('#qty_'+rowid).val());
//        var wQty=parseInt($('#workingQty_'+rowid).val());
//        var wRate=parseInt($('#rate_'+rowid).val());
//        var hId=$('#hireTypeId').val();
//        if(wQty == '' || isNaN(wQty)) wQty=0;
//        if(cQty == '') cQty=0;
//        if(wRate == '') wRate=0;
//        if(eVal == '') eVal=0;
//        if(etVal == '') etVal=0;
//        if(rateVal == '' || isNaN(rateVal)) rateVal=0;
    }
</script>