<!--Handson Table plugin-->
<link type="text/css" rel="stylesheet" href="<?php echo $this->basePath(); ?>/library/handsontable/css/handsontable.full.min.css">
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/library/handsontable/js/handsontable.full.js"></script>
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/library/handsontable/js/RuleJS/lodash.js"></script>
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/library/handsontable/js/RuleJS/underscore.string.js"></script>
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/library/handsontable/js/RuleJS/numeral.js"></script>
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/library/handsontable/js/RuleJS/numeric.js"></script>
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/library/handsontable/js/formula.js"></script>
<script type="text/javascript"src="<?php echo $this->basePath(); ?>/library/handsontable/js/parser.js"></script>
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/library/handsontable/js/ruleJS.all.full.js"></script>
<script type="text/javascript" src="<?php echo $this->basePath(); ?>/library/handsontable/js/handsontable.formula.js"></script>
<!--Handson Table Plugin-->

<!--STYLE-->
<link rel="stylesheet" href="<?php echo $this->basePath() . '/css/workorder.css'; ?>"/>
<link rel="stylesheet" href="<?php echo $this->basePath() . '/css/wpm.css'; ?>"/>
<!--STYLE-->
<style>
    .panel {
        border-radius: 0px !important;
    }

    .panel-info {
        border: none;
        border-top: none;
    }
    #HandsonTableWrapper {height: 100%; width: 100%; overflow: hidden; }
    #HandsonWrapper {display: none;}
    .top-addtip{width: 168px;left: -80px;top: -58px;height: 74px;z-index: 1000001 !important;visibility: visible;}
    .top-addtip:after{content: ""; display: block; width: 0; height: 0; border-left: 6px solid #7d73b3; border-top: 6px solid transparent; border-bottom: 6px solid transparent; position: absolute; top:32px; left:104%;z-index:1}
</style>

<!--content-->
<div class="content_wrapper padlr0">
    <div class="container-fluid">
        <div class="row">
            <form id="formWrapper" method="post" id="formWrapper">
                <input type="hidden" id="BillRegisterId" name="BillRegisterId" value="<?php echo (isset($BillRegisterId)) ? $BillRegisterId : '0';?>">
                <input type="hidden" id="WORegisterId" name="WORegisterId" value="<?php echo (isset($workorder)) ? $workorder['WORegisterId'] : '';?><?php echo (isset($billregister)) ? $billregister['WORegisterId'] : '';?>">
                <input type="hidden" id="CostCentreId" name="CostCentreId" value="<?php echo (isset($workorder)) ? $workorder['CostCentreId'] : '';?><?php echo (isset($billregister)) ? $billregister['CostCentreId'] : '';?>">
                <input type="hidden" id="VendorId"  name="VendorId" value="<?php echo (isset($workorder)) ? $workorder['VendorId'] : '';?><?php echo (isset($billregister)) ? $billregister['VendorId'] : '';?>">
                <input type="hidden" name="WorkType" id="WorkType" value="<?php echo (isset($workorder)) ? $workorder['WOType'] : '';?><?php echo (isset($billregister)) ? $billregister['WOType'] : '';?>">
                <input type="hidden" name="wbTypeId" id="wbTypeId" value="<?php echo (isset($wbTypeId)) ? $wbTypeId : ''; ?>">
                <input type="hidden" name="wbsReq" id="wbsReq" value="<?php echo $wbsReq; ?>">
                <input type="hidden" name="CompanyId" id="CompanyId" value="<?php echo $companyId; ?>">
                <div class="col-lg-12">
                    <h1 class="text-center">Work Bill</h1>
                </div>
                <div class="col-lg-12">
                    <div
                        class="col-lg-4 col-lg-offset-0 col-md-4 col-md-offset-0 col-sm-6 col-sm-offset-0 col-xs-12 col-xs-offset-0">
                        <div class="panel-box">
                            <ul>
                                <li>
                                    <label>Cost Centre</label>
                                    <span><?php echo (isset($workorder)) ? $workorder['CostCentreName'] : ''; ?><?php echo (isset($billregister)) ? $billregister['CostCentreName'] : '';?></span>
                                </li>
                                <li>
                                    <label>Contractor</label>
                                    <span><?php echo (isset($workorder)) ? $workorder['VendorName'] : ''; ?><?php echo (isset($billregister)) ? $billregister['VendorName'] : '';?></span>
                                </li>
                                <li>
                                    <label>Work Order No</label>
                                    <span><?php echo (isset($workorder)) ? $workorder['WONo'] : ''; ?><?php echo (isset($billregister)) ? $billregister['WONo'] : '';?></span>
                                </li>
                                <li>
                                    <label>Work Type</label>
                                    <span><?php echo ((isset($workorder) && $workorder['WOType'] == 'iow') || (isset($billregister) && $billregister['WOType'] == 'iow')) ? 'IOW' : ''; ?><?php
                                        echo ( (isset($workorder) && $workorder['WOType'] == 'activity') || (isset($billregister) && $billregister['WOType'] == 'activity')) ? 'Activity' : ''; ?><?php
                                        echo ( (isset($workorder) && $workorder['WOType'] == 'turn-key') || (isset($billregister) && $billregister['WOType'] == 'turn-key') ) ? 'Turn Key' : ''; ?></span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div
                        class="col-lg-4 col-lg-offset-0 col-md-4 col-md-offset-0 col-sm-6 col-sm-offset-0 col-xs-12 col-xs-offset-0">
                        <div class="panel-box box2th">
                            <ul>
                                <li>
                                    <label>Bill Date</label>
                                    <span><input type="text" placeholder="DD-MM-YYYY" class="date_picker" id="BillDate" name="BillDate" value="<?php echo (isset($billregister)) ? $billregister['BillDate'] : date('d-m-Y');?>" readonly onchange="validateDate(this)"/></span>
                                </li>
                                <li>
                                    <label>Ref Date</label>
                                    <span><input type="text" placeholder="DD-MM-YYYY" class="date_picker"id="RefDate" name="RefDate" value="<?php echo (isset($billregister)) ? $billregister['RefDate'] : date('d-m-Y');?>" onchange="validateDate(this)"/></span>
                                </li>
                                <li>
                                    <label>From Date</label>
                                    <span><input type="text" placeholder="DD-MM-YYYY" class="date_picker" id="FromDate" name="FromDate" value="<?php echo (isset($billregister)) ? $billregister['FDate'] : date('d-m-Y');?>" onchange="validateDate(this)"/></span>
                                </li>
                                <li>
                                    <label>To Date</label>
                                    <span><input type="text" placeholder="DD-MM-YYYY" class="date_picker" id="ToDate" name="ToDate" value="<?php echo (isset($billregister)) ? $billregister['TDate'] : date('d-m-Y');?>" onchange="validateDate(this)"/></span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div
                        class="col-lg-4 col-lg-offset-0 col-md-4 col-md-offset-0 col-sm-6 col-sm-offset-0 col-xs-12 col-xs-offset-0">
                        <div class="panel-box box3th">
                            <ul>
                                <li>
                                    <label>Bill No</label>
                                    <span><input type="text" placeholder="xxxxx" id="BillNo" name="BillNo" value="<?php echo (!isset($billregister) && $genType) ? trim($woNo) : ''; echo (isset($billregister)) ? trim($billregister['BillNo']) : '';?>" <?php echo (isset($workorder) || $genType) ? 'readonly': ''; ?>/></span>
                                </li>
                                <li>
                                    <label>CC Bill No</label>
                                    <span><input type="text" placeholder="xxxxx" id="CCBillNo" name="CCBillNo" value="<?php echo (isset($billregister)) ? $billregister['CCBVNo'] : '';?>"/></span>
                                </li>
                                <li>
                                    <label>Comp Bill No</label>
                                    <span><input type="text" placeholder="xxxxx" id="CompBillNo" name="CompBillNo" value="<?php echo (isset($billregister)) ? $billregister['CompanyBVNo'] : '';?>"/></span>
                                </li>
                                <li>
                                    <label>Ref No</label>
                                    <span><input type="text" placeholder="xxxxx" id="RefNo" name="RefNo" value="<?php echo (isset($billregister)) ? $billregister['RefNo'] : '';?>"/></span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="clearfix"></div>
                <div class="col-lg-12">
                    <h3 class="act-list">Bill Abstract</h3>
                    <div class="table-responsive top-30">
                        <table class="table" id="billAbstractTable">
                            <thead>
                            <tr>
                                <th>Ref No</th>
                                <th>Description</th>
                                <th>Account</th>
                                <th class="text-right">Cumulative</th>
                                <th class="text-right">Previous</th>
                                <th class="text-right">Current</th>
                                <th class="text-center">Sign</th>
                                <th>&nbsp;</th>
                            </tr>
                            </thead>
                            <tbody class="main"></tbody>
                            <tbody class="total">
                            <tr>
                                <td colspan="2">&nbsp;</td>
                                <td class="rate_pri text-right">Total</td>
                                <td><input class="parent_padi05 text-right" type="text" name="totalCumAmount" id="totalCumAmount" readonly/></td>
                                <td><input class="parent_padi05 text-right" type="text" name="totalPrevAmount" id="totalPrevAmount" readonly/></td>
                                <td><input class="parent_padi05 text-right" type="text" name="totalCurAmount" id="totalCurAmount" readonly/></td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                            </tr>
                            </tbody>
                        </table>
                        <input type="hidden" name="rowid" id="rowid" value="0"/>
                    </div>
                </div>
                <div class="clearfix"></div>
                <div class="col-lg-12 form-group" style="padding-top: 20px;">
                    <label>Narration</label>
                    <textarea class="parent_text" id="Narration" name="Narration"><?php echo (isset($billregister)) ? $billregister['Narration'] : '';?></textarea>
                </div>
            </form>

            <!--Handson Table-->
            <div class="col-lg-12" id="HandsonWrapper">
                <div class="md-popup">
                    <div id="HandsonTableModal">
                        <h1>Measurement Sheet</h1>
                        <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0 excel-tbs" style="padding-left:0px !important;">
                            <div class="col-lg-4 col-lg-offset-0 col-md-4 col-md-offset-0 col-sm-4 col-sm-offset-0">
                                <div class="form-group">
                                    <select id="ExcelTemplate" onChange="getExcelTemplate(this);"  style="width:100%;" class="form-control single_dropdown lbl_move hei-43" data-size="5" label="Chooose a Template">
                                        <option></option>
                                        <?php if($exceltemplates):
                                            foreach($exceltemplates as $template):?>
                                                <option value="<?php echo $template['TemplateId']; ?>"><?php echo $template['TemplateName']; ?></option>
                                            <?php endforeach; endif; ?>
                                    </select>
                                </div>
                            </div>
                            <div class="col-lg-4 col-lg-offset-0 col-md-4 col-md-offset-0 col-sm-4 col-sm-offset-0">
                                <div class="form-group">
                                    <select name="columns[]" id="totalcolumns"  style="width:100%;" class="form-control single_dropdown lbl_move sel-mul" data-size="5" label="Choose Column(s)" multiple onchange="summationColumns(true);">
                                        <option></option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-lg-4 col-lg-offset-0 col-md-4 col-md-offset-0 col-sm-4 col-sm-offset-0">
                                <div class="form-group  remove-bt">
                                    <a onClick="removeMSheet(); return false;">Remove Measurement Sheet</a>
                                </div>
                            </div>
                        </div>
                        <div class="clearfix"></div>
                        <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0">
                            <div class="tabs-content" style="margin-top:20px;">
                                <div id="HandsonTableWrapper" class="hot handsontable"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0">
                        <div class="btn-group toal-disgr" data-toggle="buttons" id="summationColumnsWrapper"></div>
                    </div>
                    <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0">
                        <div class="HandsonModalBtns">
                            <button type="button" class="md_cance" onClick="return hideHandsonWrapper()">Cancel</button>
                            <button type="button" class="md_ok" onClick="return updateMSheet()">Update</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="col-lg-12 savebtn_area">
    <ul>
        <li class="dropdown save_btn float_r"><a onclick="submitForm()" data-toggle="tooltip" class="ripple" title="Submit">Submit</a>
            <?php if(isset($billregister)): ?>
        <li class="cancel_btn float_r"><a href="<?php echo $this->basePath();?>/wpm/workorder/bill-register" data-toggle="tooltip" class="ripple" title="Go back!">Cancel</a></li>
        <?php else: ?>
            <li class="cancel_btn float_r"><a href="<?php echo $this->basePath();?>/wpm/workbill/index" data-toggle="tooltip" class="ripple" title="Go back!">Back</a></li>
        <?php endif; ?>
    </ul>
</div>
<div id="lsListModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Modal Header</h4>
            </div>
            <div class="modal-body"><div id="jqxLSList"></div></div>
            <div class="clearfix"></div>
            <div class="modal-footer">
                <button type="button" class="bt-apply" onclick="lsDetailsBind();">Apply</button>
            </div>
        </div>
    </div>
</div>
<!--Formula Modal-->
<div id="FormulaModal" class="modal fade" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><i class="fa fa-times-circle-o clpot"></i></button>
                <h1>Formula</h1>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Formula Expression</label>
                    <input type="text" class="parent_text" name="FormulaExpression" id="FormulaExpression" onchange="return FormulaCalc()" >
                </div>
                <div class="form-group">
                    <input type="text" class="parent_text text-right" name="FormulaVal" id="FormulaVal" readonly >
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="btnRemoveFormula" class="md_cance" onclick="return RemoveFormula()" data-dismiss="modal" data-toggle="tooltip" data-original-title="Remove Formula">Remove Formula</button>
                <button type="button" class="md_ok" onclick="return ApplyFormula();" data-toggle="tooltip" data-original-title="Apply">Apply</button>
            </div>
        </div>
    </div>
</div>
<!-- Part/Full Rate Modal -->
<div id="RateModal" class="modal fade" role="dialog" data-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title popuptit">Rate</h4>
            </div>
            <div class="modal-body">
                <ul class="rate-fullrate">
                    <li>
                        <div class="radio_check part-rad">
                            <p style="padding-top:10px;">
                                <input type="radio" class="radio-partfullrate" name="radio-partfullrate" id="radio-fullrate" value="F" checked>
                                <label for="radio-fullrate">Full rate</label>
                            </p>
                        </div>
                        <input type="text" class="text-right" id="input-fullrate-value" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 2, true)" readonly />
                    </li>
                    <li>
                        <div class="radio_check part-rad">
                            <p style="padding-top:10px;">
                                <input type="radio" class="radio-partfullrate" name="radio-partfullrate" id="radio-partrate" value="P">
                                <label for="radio-partrate">Part rate</label>
                            </p>
                        </div>
                        <input type="text"  class="text-right" id="input-partrate-value" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 2, true)" readonly />
                        <input type="text" class="per-tg" id="input-partrate-per" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 2)" maxlength="6" readonly />
                        <b>%</b>
                    </li>
                </ul>
            </div>
            <div class="clearfix"></div>
            <div class="modal-footer">
                <button type="button" class="rate-cancel" data-dismiss="modal">Cancel</button>
                <button type="button" class="bt-apply" onclick="return ApplyRate();" >Apply</button>
            </div>
        </div>
    </div>
</div>

<script type="text/template" id="billabstract-template">
    <tr id="mainRow__">
        <td width="3%"><p class="ra-t" id="RowName__"></p></td>
        <td width="15%"><p class="dec-ptr" id="TypeName__"></p></td>
        <td width="15%">
            <input class="parent_text accountSuggest" type="text" name="Account__" id="Account__"/>
            <input type="hidden" name="AccountId__" id="AccountId__"/>
        </td>
        <td width="12%"><input class="parent_padi05 text-right" type="text" name="CumAmount__" id="CumAmount__" readonly/></td>
        <td width="12%"><input class="parent_padi05 text-right" type="text" name="PrevAmount__" id="PrevAmount__" readonly/></td>
        <td width="12%"><input class="parent_text text-right mainTr" type="text" name="CurAmount__" id="CurAmount__" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 2, true)" onchange="calcTotal();"/></td>
        <td width="1%" class="text-center"><label><i class="fa" aria-hidden="true" id="SignIcon__"></i></label></td>
        <td width="5%" align="center" class="action_btns_td">
            <ul class="action_btns">
                <li><a href="#" class="mainTr" id="mainExpandTr__" style="display: none;"><i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="left" data-original-title="Expand"></i></a></li>
            </ul>
        </td>
        <input type="hidden" name="WorkBillFormatTransId__" id="WorkBillFormatTransId__" />
        <input type="hidden" name="BillFormatTransId__" id="BillFormatTransId__" />
        <input type="hidden" name="FormatTypeId__" id="FormatTypeId__" />
        <input type="hidden" name="Sign__" id="Sign__"/>
        <input type="hidden" name="Formula__" id="Formula__"/>
        <input type="hidden" name="BillAbsId__" id="BillAbsId__"/>
        <input type="hidden" name="AccountTypeId__" id="AccountTypeId__"/>
        <input type="hidden" name="Header__" id="Header__"/>
    </tr>
</script>
<script type="text/template" id="billabstract-header-template">
    <tr>
        <td width="3%">&nbsp;</td>
        <td colspan="2"><p class="dec-ptr" id="TypeName__"></p></td>
        <td width="12%" class="headerBill__"><input class="parent_padi05 text-right" type="text" name="CumAmount__" id="CumAmount__" readonly/></td>
        <td width="12%" class="headerBill__"><input class="parent_padi05 text-right" type="text" name="PrevAmount__" id="PrevAmount__" readonly/></td>
        <td width="12%" class="headerBill__"><input class="parent_text text-right" type="text" name="CurAmount__" id="CurAmount__" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 2, true)" onchange="calcTotal();"/></td>
        <td colspan="2"></td>
        <input type="hidden" name="WorkBillFormatTransId__" id="WorkBillFormatTransId__" />
        <input type="hidden" name="BillFormatTransId__" id="BillFormatTransId__"/>
        <input type="hidden" name="FormatTypeId__" id="FormatTypeId__"/>
        <input type="hidden" name="Sign__" id="Sign__"/>
        <input type="hidden" name="Formula__" id="Formula__"/>
        <input type="hidden" name="BillAbsId__" id="BillAbsId__"/>
        <input type="hidden" name="AccountTypeId__" id="AccountTypeId__"/>
        <input type="hidden" name="Header__" id="Header__"/>
    </tr>
</script>
<script type="text/template" id="agreement-template">
    <tr style="display:none;" class="subTr">
        <td colspan="9" style="padding:0px !important; ">
            <div class="subDiv" style="display:none;">
                <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"></div>
                <!--<div class="col-lg-12 col-lg-offset-0" style="margin-bottom: 15px;">
                    <p class="clr-flr">Full rate</p>
                    <p class="clr-plr">Part rate</p>
                </div>-->
                <div class="col-lg-12">
                    <div class="table-responsive topsp">
                        <table class="table" style="margin-bottom:0px;"  id="abs___table">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Specification</th>
                                    <th>Unit</th>
                                    <th class="text-right">Qty</th>
                                    <th class="text-right">Rate</th>
                                    <th class="text-right">Amount</th>
                                    <th>Sign</th>
                                    <th>&nbsp;</th>
                                </tr>
                            </thead>
                            <tbody class="main"></tbody>
                        </table>
                        <input type="hidden" name="abs___rowid" id="abs___rowid" value="0"/>
                        <input type="hidden" name="abs___deleteids" id="abs___deleteids"/>
                    </div>
                </div>
            </div>
        </td>
    </tr>
</script>
<script type="text/template" id="agreement-tr-template">
    <tr>
        <td width="15%">{{code}}</td>
        <td width="25%">{{spec}}</td>
        <td width="5%">{{unit}}</td>
        <td width="15%">
            <input class="parent_text text-right <?php if($wbsReq != '' && $wbsReq == 1) { ?>mainTr<?php } ?>" type="text" name="abs___qty_0" id="abs___qty_0" <?php if($wbsReq != '' && $wbsReq == 1) { ?>readonly onchange="calcAbs(this);"<?php } else { ?>onchange="calcQuantityWOWbs(this);" onkeypress="return isDecimal(event,this)" onfocus="return hideShow(this,'s','wo');" onblur="return hideShow(this,'h','wo');"<?php } ?> autocomplete="off" />
            <?php if($wbsReq != '' && $wbsReq == 1) { ?>
            <?php } else { ?>
                <div id="ewbqty__" style="position:relative;display:none;">
                    <div class="top-tip top-addtip">
                        <span>Work Order Qty : <i id="abs___workorderqty_0"></i></span>
                        <span>Work Progress Qty : <i id="abs___wpeqty_0"></i></span>
                        <span>Total Billed Qty : <i id="abs___totbilledqty_0"></i></span>
                    </div>
                </div>
            <?php } ?>
        </td>
        <td width="15%" class="full-rates">
            <input class="parent_text text-right" type="text" name="abs___rate_0" id="abs___rate_0" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 2, true)" onchange="calcAbs(this);" onfocus="showRateModal(this,true);"/>
            <a class="part-rates" id="abs___ratemodal_0" onclick="showRateModal(this);"> <i class="fa fa-plus-circle"></i></a>
        </td>
        <td width="20%"><input class="parent_text text-right" type="text" name="abs___amount_0" id="abs___amount_0" readonly/></td>
        <td width="1%" class="text-center"><label class="mi-pl-ic"><i class="fa fa-plus-circle" aria-hidden="true" id="abs___signicon_0"></i></label></td>
        <td width="4%" align="center" class="action_btns_td">
            <ul class="action_btns">
                <li> <a href="#" class="mainTr" id="abs___ExpandRow_0"> <i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="left" data-original-title="Show" ></i></a> </li>
                <li> <a id="abs___DeleteRow_0" onclick="deleteRow(this, event);"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
            </ul>
        </td>
        <input type="hidden" name="abs___WorkBillTransId_0" id="abs___WorkBillTransId_0" value="0"/>
        <input type="hidden" name="abs___UpdateBillRow_0" id="abs___UpdateBillRow_0" value="0"/>
        <input type="hidden" name="abs___transid_0" id="abs___transid_0" value="0"/>
        <input type="hidden" name="abs___sign_0" id="abs___sign_0" value="+"/>
        <input type="hidden" name="abs___iowid_0" id="abs___iowid_0"/>
        <input type="hidden" name="abs___resourceid_0" id="abs___resourceid_0"/>
        <input type="hidden" name="abs___ratetype_0" id="abs___ratetype_0" value="F"/>
        <input type="hidden" name="abs___partrateper_0" id="abs___partrateper_0" value="0"/>
        <input type="hidden" name="abs___partrate_0" id="abs___partrate_0" value="0"/>
        <input type="hidden" name="abs___actualrate_0" id="abs___actualrate_0" value="0"/>
        <input type="hidden" name="abs___actualqty_0" id="abs___actualqty_0" value="0"/>
    </tr>
    <tr style="display:none;" class="subTr">
        <td colspan="9" style="padding:0px !important; ">
            <div class="subDiv" style="display:none;">
                <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"> </div>
                <div class="col-lg-12">
                    <div class="table-responsive topsp">
                        <table class="table" style="margin-bottom:0px;" id="abs___table_0">
                            <thead>
                                <tr>
                                    <!--<th>Agt No</th>
                                    <th>Specification</th>-->
                                    <th>WBS</th>
                                    <th class="text-right">Qty</th>
                                    <th class="text-right">Rate</th>
                                    <th class="text-right">Amount</th>
                                    <th>Sign</th>
                                </tr>
                            </thead>
                            <tbody class="main"></tbody>
                            <!--<tbody class="total">
                                <tr>
                                    <td colspan="6">
                                        <ul class="total-qty">
                                            <li>
                                                <label>Estimate Qty : </label>
                                                <input class="parent_text text-right" type="text" name="abs___act_0_estqty" id="abs___act_0_estqty" readonly/>
                                            </li>
                                            <li>
                                                <label>Work Order Qty : </label>
                                                <input class="parent_text text-right" type="text" name="abs___act_0_woqty" id="abs___act_0_woqty" readonly/>
                                            </li>
                                            <li>
                                                <label>Total Billed Qty : </label>
                                                <input class="parent_text text-right" type="text" name="abs___act_0_totalbillqty" id="abs___act_0_totalbillqty" readonly/>
                                            </li>
                                        </ul>
                                    </td>
                                </tr>
                            </tbody>-->
                        </table>
                        <input type="hidden" name="abs___act_0_rowid" id="abs___act_0_rowid" value="0"/>
                    </div>
                </div>
            </div>
        </td>
    </tr>
</script>
<script type="text/template" id="agreement-subtr-template">
    <tr>
        <td width="15%">{{wbs}}</td>
        <td width="8%">
            <input class="parent_text text-right" type="text" name="abs___act_0_qty_1" id="abs___act_0_qty_1" onkeypress="return isDecimal(event,this)" onchange="calcAct(this);" onfocus="showHandsonTableModal('1', this);" onblur="return hideShow(this,'h','w');" autocomplete="off" />
            <div id="abs___act_0_ewbqty_1" style="position:relative;display:none;">
                <div class="top-tip top-addtip">
                    <span>Work Order Qty : <i name="abs___act_0_workorderqty_1" id="abs___act_0_workorderqty_1"></i></span>
                    <span>Work Progress Qty : <i name="abs___act_0_wpeqty_1" id="abs___act_0_wpeqty_1"></i></span>
                    <span>Total Billed Qty : <i name="abs___act_0_totbilledqty_1" id="abs___act_0_totbilledqty_1"></i></span>
                </div>
            </div>
        </td>
        <td width="8%"><input class="parent_text text-right" type="text" name="abs___act_0_rate_1" id="abs___act_0_rate_1" onkeypress="return isDecimal(event,this)" onchange="calcAct(this);" /></td>
        <td width="9%"><input class="parent_text text-right" type="text" name="abs___act_0_amount_1" id="abs___act_0_amount_1" readonly /></td>
        <td width="1%" class="text-center"><label class="mi-pl-ic"><i class="fa fa-plus-circle" aria-hidden="true" id="abs___act_0_signicon_1" onclick="toggleRateSign(this);"></i></label></td>
        <input type="hidden" name="abs___act_0_TransId_1" id="abs___act_0_TransId_1"/>
        <input type="hidden" name="abs___act_0_Measurement_1" id="abs___act_0_Measurement_1"/>
        <input type="hidden" name="abs___act_0_CellName_1" id="abs___act_0_CellName_1"/>
        <input type="hidden" name="abs___act_0_SelectedColumns_1" id="abs___act_0_SelectedColumns_1"/>
        <input type="hidden" name="abs___act_0_iowid_1" id="abs___act_0_iowid_1"/>
        <input type="hidden" name="abs___act_0_wbsid_1" id="abs___act_0_wbsid_1"/>
        <input type="hidden" name="abs___act_0_sign_1" id="abs___act_0_sign_1" value="+"/>
        <input type="hidden" name="abs___act_0_UpdateRow_1" id="abs___act_0_UpdateRow_1" value="0"/>
    </tr>
</script>
<script type="text/template" id="material-recovery-template">
    <tr style="display:none;" class="subTr">
        <td colspan="9" style="padding:0px !important; ">
            <div class="subDiv" style="display:none;">
                <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"></div>
                <div class="col-lg-12">
                    <div class="table-responsive topsp">
                        <table class="table" style="margin-bottom:0px;"  id="abs___table">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Specification</th>
                                    <th>Unit</th>
                                    <th>Issue No.</th>
                                    <th>Issue Date</th>
                                    <th>Qty</th>
                                    <th class="text-right">Rate</th>
                                    <th class="text-right">Amount</th>
                                    <th>&nbsp;</th>
                                </tr>
                            </thead>
                            <tbody class="main"></tbody>
                        </table>
                        <input type="hidden" name="abs___rowid" id="abs___rowid" value="0"/>
                        <input type="hidden" name="abs___deleteids" id="abs___deleteids"/>
                    </div>
                </div>
            </div>
        </td>
    </tr>
</script>
<script type="text/template" id="material-recovery-tr-template">
    <tr>
        <td width="5%">{{code}}</td>
        <td width="13%">{{spec}}</td>
        <td width="5%">{{unit}}</td>
        <td width="5%"><input class="parent_padi05" type="text" name="abs___issueno_0" id="abs___issueno_0" readonly/></td>
        <td width="5%"><input class="parent_padi05" type="text" name="abs___issuedate_0" id="abs___issuedate_0" readonly/></td>
        <td width="8%"><input class="parent_text" type="text" name="abs___qty_0" id="abs___qty_0" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 3, true)" onchange="calcAbs(this, '3');" autocomplete="off" /></td>
        <td width="10%"><input class="parent_padi05 text-right" type="text" name="abs___rate_0" id="abs___rate_0" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 2, true)" onchange="calcAbs(this);" readonly/></td>
        <td width="15%"><input class="parent_padi05 text-right" type="text" name="abs___amount_0" id="abs___amount_0" readonly/></td>
        <td width="4%" align="center" class="action_btns_td">
            <ul class="action_btns">
                <li> <a id="abs___DeleteRow_0" onclick="deleteRow(this, event);"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
            </ul>
        </td>
        <input type="hidden" name="abs___WorkBillMaterialRecoveryId_0" id="abs___WorkBillMaterialRecoveryId_0" value="0"/>
        <input type="hidden" name="abs___UpdateRow_0" id="abs___UpdateRow_0" value="0"/>
        <input type="hidden" name="abs___resourceid_0" id="abs___resourceid_0" value="0"/>
        <input type="hidden" name="abs___transid_0" id="abs___transid_0" value="0"/>
        <input type="hidden" name="abs___unitid_0" id="abs___unitid_0"/>
        <input type="hidden" name="abs___issueid_0" id="abs___issueid_0"/>
        <input type="hidden" name="abs___typeid_0" id="abs___typeid_0"/>
        <input type="hidden" id="abs___availqty_0"/>
        <input type="hidden" name="abs___cumqty_0" id="abs___cumqty_0"/>
    </tr>
</script>
<script type="text/template" id="labour-template">
    <tr style="display:none;" class="subTr">
        <td colspan="9" style="padding:0px !important; ">
            <div class="subDiv" style="display:none;">
                <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;">
                    <button type="button" class="wb-popup" onclick="showLsModal(this);" id="abs___lsmodalbtn">LS List</button>
                </div>
                <div class="col-lg-12">
                    <div class="table-responsive topsp">
                        <table class="table" style="margin-bottom:0px;"  id="abs___table">
                            <thead>
                                <tr>
                                    <th>WBS</th>
                                    <th>Total Qty</th>
                                    <th class="text-right">Amount</th>
                                    <th>OT Hrs</th>
                                    <th class="text-right">OT Amount</th>
                                    <th class="text-right">Net Amount</th>
                                    <th>&nbsp;</th>
                                </tr>
                            </thead>
                            <tbody class="main"></tbody>
                        </table>
                        <input type="hidden" name="abs___rowid" id="abs___rowid" value="0"/>
                        <input type="hidden" name="abs___deleteids" id="abs___deleteids"/>
                    </div>
                </div>
            </div>
        </td>
    </tr>
</script>
<script type="text/template" id="labour-tr-template">
    <tr id="abs___subRowRowId_0">
        <input type="hidden" name="abs___WorkBillLSTransId_0" id="abs___WorkBillLSTransId_0" value="0"/>
        <input type="hidden" name="abs___UpdateRow_0" id="abs___UpdateRow_0" value="0"/>
        <td width="25%">
            <input class="parent_text" type="text" name="abs___wbsName_0" id="abs___wbsName_0" readonly/>
            <input type="hidden" name="abs___wbsId_0" id="abs___wbsId_0" />
            <input type="hidden" name="abs___lsRegisterId_0" id="abs___lsRegisterId_0" />
            <input type="hidden" name="abs___lsWbsTransId_0" id="abs___lsWbsTransId_0" />
            <input type="hidden" name="abs___typeId_0" id="abs___typeId_0" />
        </td>
        <td width="10%"><input class="parent_text" type="text" name="abs___wbsQty_0" id="abs___wbsQty_0" readonly /></td>
        <td width="15%"><input class="parent_text text-right" type="text" name="abs___wbsAmount_0" id="abs___wbsAmount_0" readonly /></td>
        <td width="14%"><input class="parent_text text-center" type="text" name="abs___wbsOtHrs_0" id="abs___wbsOtHrs_0" readonly /></td>
        <td width="15%"><input class="parent_text text-right" type="text" name="abs___wbsOtAmount_0" id="abs___wbsOtAmount_0" readonly /></td>
        <td width="15%"><input class="parent_text text-right" type="text" name="abs___wbsNetAmount_0" id="abs___wbsNetAmount_0" readonly /></td>
        <td width="6%" align="center" class="action_btns_td">
            <ul class="action_btns">
                <li><a href="#" class="mainTr"> <i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="left" data-original-title="Show" ></i></a></li>
                <li><a id="abs___DeleteRow_0" onclick="deleteRow(this, event);"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i></a></li>
            </ul>
        </td>
    </tr>
    <tr style="display:none;" class="subTr">
        <td colspan="7" style="padding:0px !important;">
            <div class="subDiv" style="display:none;">
                <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"></div>
                <div class="col-lg-12">
                    <div class="table-responsive topsp">
                        <table class="table" style="margin-bottom:0px;" id="abs___table_0">
                            <thead>
                                <tr>
                                    <th>Labour Type Name</th>
                                    <th>Qty</th>
                                    <th class="text-right">Rate</th>
                                    <th class="text-right">Amount</th>
                                    <th>OT Hrs</th>
                                    <th class="text-right">OT Rate</th>
                                    <th class="text-right">OT Amount</th>
                                    <th class="text-right">Total Amount</th>
                                </tr>
                            </thead>
                            <tbody class="main"></tbody>
                        </table>
                        <input type="hidden" name="abs___type_0_rowid" id="abs___type_0_rowid" value="0"/>
                    </div>
                </div>
            </div>
        </td>
    </tr>
</script>
<script type="text/template" id="labour-type-tr-template">
    <tr>
        <input type="hidden" name="abs___WorkBillLSTransId_0" id="abs___type_0_TransId_1" value="0"/>
        <input type="hidden" name="abs___UpdateRow_0" id="abs___type_0_UpdateRow_1" value="0"/>
        <input type="hidden" name="abs___type_0_labid_1" id="abs___type_0_labid_1"/>
        <input type="hidden" name="abs___type_0_labname_1" id="abs___type_0_labname_1"/>
        <td width="15%">{{name}}</td>
        <td width="10%"><input class="parent_text text-right" type="text" name="abs___type_0_labqty_1" id="abs___type_0_labqty_1" onchange="calcLsType(this);"/></td>
        <td width="10%"><input class="parent_text text-right" type="text" name="abs___type_0_labrate_1" id="abs___type_0_labrate_1" readonly/></td>
        <td width="15%"><input class="parent_tex text-right" type="text" name="abs___type_0_labamt_1" id="abs___type_0_labamt_1" readonly/></td>
        <td width="10%"><input class="parent_text text-center" type="text" name="abs___type_0_labothrs_1" id="abs___type_0_labothrs_1" readonly/></td>
        <td width="10%"><input class="parent_text text-right" type="text" name="abs___type_0_labotrate_1" id="abs___type_0_labotrate_1" readonly/></td>
        <td width="15%"><input class="parent_text text-right" type="text" name="abs___type_0_labotamt_1" id="abs___type_0_labotamt_1" readonly/></td>
        <td width="15%"><input class="parent_text text-right" type="text" name="abs___type_0_labnetamt_1" id="abs___type_0_labnetamt_1" readonly/></td>
    </tr>
</script>
<script type="text/template" id="tds-template">
    <tr style="display:none;" class="subTr">
        <td colspan="9" style="padding:0px !important; ">
            <div class="subDiv" style="display:none;">
                <table class="table" style=" margin-bottom:0px;">
                    <thead>
                        <tr>
                            <th>Expression</th>
                            <th style="text-align:right">Base Value</th>
                            <th style="text-align:right">Percentage (%)</th>
                            <th style="text-align:right">Amount</th>
                            <th>&nbsp;</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="padi05" colspan="6">
                            <input type="hidden" name="abs___WorkBillTDSTransId" id="abs___WorkBillTDSTransId" value="0"/>
                            <input type="hidden" name="abs___UpdateRow" id="abs___UpdateRow" value="0"/>
                            <td width="10%"><input class="parent_text qualmainTrInput qualChange mainTr" type="text" name="abs___tdsexpression" id="abs___tdsexpression" onkeypress="return isFormula(event);" onchange="calcTax(this);"></td>
                            <td width="10%"><input class="parent_padi05 text-right qualmainTrInput" type="text" name="abs___tdsexpvalue" id="abs___tdsexpvalue" readonly></td>
                            <td width="2%"><input class="parent_padi05 text-right qualmainTrInput qualChange" type="text" name="abs___tdsper" id="abs___tdsper" readonly></td>
                            <td width="15%" style="position:relative;"><input class="parent_padi05 text-right qualmainTrInput" type="text" name="abs___tdsamt" id="abs___tdsamt" readonly></td>
                            <td width="4%" align="center" class="action_btns_td">
                                <ul class="action_btns"><li> <a href="#" class="mainTr"> <i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="left" data-original-title="Show" ></i></a></li></ul>
                            </td>
                        </tr>

                        <tr style="display:none;" class="subTr">
                            <td colspan="9" style="padding:0px !important; ">
                                <div class="subDiv" style="display:none;">
                                    <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"></div>
                                    <div class="col-lg-12">
                                        <div class="table-responsive topsp">
                                            <table class="table" style="margin-bottom:0px;"  id="abs___table">
                                                <thead>
                                                <tr>
                                                    <th>&nbsp;</th>
                                                    <th style="text-align:right">Taxable</th>
                                                    <th style="text-align:right">Tax</th>
                                                    <th style="text-align:right">Cess</th>
                                                    <th style="text-align:right">Edu. Cess</th>
                                                    <th style="text-align:right">H.Edu.cess	</th>
                                                    <th style="text-align:right">Net</th>
                                                </tr>
                                                </thead>
                                                <tbody class="main">
                                                <tr class="padi05">
                                                    <td width="8%">Percentage (%)</td>
                                                    <td width="10%"><input class="parent_text text-right" type="text"  name="abs___taxable" id="abs___taxable" onkeypress="return isDecimal(event,this)" onchange="calcTax(this);"></td>
                                                    <td width="9%"><input class="parent_text text-right" type="text" name="abs___tax" id="abs___tax" onkeypress="return isDecimal(event,this)" onchange="calcTax(this);"></td>
                                                    <td width="7%"><input class="parent_text text-right" type="text" name="abs___cess"  id="abs___cess" onkeypress="return isDecimal(event,this)" onchange="calcTax(this);"></td>
                                                    <td width="7%"><input class="parent_text text-right" type="text" name="abs___educess" id="abs___educess" onkeypress="return isDecimal(event,this)" onchange="calcTax(this);"></td>
                                                    <td width="7%"><input class="parent_text text-right" type="text" name="abs___heducess" id="abs___heducess" onkeypress="return isDecimal(event,this)" onchange="calcTax(this);"></td>
                                                    <td width="7%"><input class="parent_text text-right" type="text" name="abs___nettax" id="abs___nettax" onkeypress="return isDecimal(event,this)" readonly></td>
                                                </tr>
                                                <tr class="padi05">
                                                    <td width="8%">Amount</td>
                                                    <td width="8%"><input class="parent_padi05 text-right" type="text" name="abs___taxableamt" id="abs___taxableamt"readonly /></td>
                                                    <td width="8%"><input class="parent_padi05 text-right" type="text" name="abs___taxamt" id="abs___taxamt" readonly/></td>
                                                    <td width="8%"><input class="parent_padi05 text-right" type="text" name="abs___cessamt" id="abs___cessamt" readonly/></td>
                                                    <td width="8%"><input class="parent_padi05 text-right" type="text" name="abs___educessamt" id="abs___educessamt" readonly/></td>
                                                    <td width="8%"><input class="parent_padi05 text-right" type="text" name="abs___heducessamt" id="abs___heducessamt" readonly/></td>
                                                    <td width="10%"><input class="parent_padi05 text-right" type="text" name="abs___netamt" id="abs___netamt" readonly /></td>
                                                </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </td>
    </tr>
</script>
<script type="text/template" id="service-tax-template">
    <tr style="display:none;" class="subTr">
        <td colspan="9" style="padding:0px !important; ">
            <div class="subDiv" style="display:none;">
                <table class="table" style=" margin-bottom:0px;">
                    <thead>
                        <tr>
                            <th>Expression</th>
                            <th style="text-align:right">Base Value</th>
                            <th style="text-align:right">Percentage (%)</th>
                            <th style="text-align:right">Amount</th>
                            <th>&nbsp;</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="padi05" colspan="6">
                            <input type="hidden" name="abs___WorkBillServiceTaxTransId" id="abs___WorkBillServiceTaxTransId" value="0"/>
                            <input type="hidden" name="abs___UpdateRow" id="abs___UpdateRow" value="0"/>
                            <td width="10%"><input class="parent_text qualmainTrInput qualChange mainTr" type="text" name="abs___tdsexpression" id="abs___tdsexpression" onkeypress="return isFormula(event);" onchange="calcTax(this);"></td>
                            <td width="10%"><input class="parent_padi05 text-right qualmainTrInput" type="text" name="abs___tdsexpvalue" id="abs___tdsexpvalue" readonly></td>
                            <td width="2%"><input class="parent_padi05 text-right qualmainTrInput qualChange" type="text" name="abs___tdsper" id="abs___tdsper" readonly></td>
                            <td width="15%" style="position:relative;"><input class="parent_padi05 text-right qualmainTrInput" type="text" name="abs___tdsamt" id="abs___tdsamt" readonly></td>
                            <td width="4%" align="center" class="action_btns_td">
                                <ul class="action_btns"><li> <a href="#" class="mainTr"> <i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="left" data-original-title="Show" ></i></a></li></ul>
                            </td>
                        </tr>
                        <tr style="display:none;" class="subTr">
                            <td colspan="9" style="padding:0px !important; ">
                                <div class="subDiv" style="display:none;">
                                    <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"></div>
                                    <div class="col-lg-12">
                                        <div class="table-responsive topsp">
                                            <table class="table" style="margin-bottom:0px;"  id="abs___table">
                                                <thead>
                                                <tr>
                                                    <th>&nbsp;</th>
                                                    <th style="text-align:right">Taxable</th>
                                                    <th style="text-align:right">Tax</th>
                                                    <th style="text-align:right">KK Cess</th>
                                                    <th style="text-align:right">SB Cess</th>
                                                    <th style="text-align:right">Net Tax</th>
                                                    <th style="text-align:right">Reverse Tax</th>
                                                </tr>
                                                </thead>
                                                <tbody class="main">
                                                <tr class="padi05">
                                                    <td width="8%">Percentage (%)</td>
                                                    <td width="10%"><input class="parent_text text-right" type="text"  name="abs___taxable" id="abs___taxable" onkeypress="return isDecimal(event,this)" onchange="calcTax(this);"></td>
                                                    <td width="9%"><input class="parent_text text-right" type="text" name="abs___tax" id="abs___tax" onkeypress="return isDecimal(event,this)" onchange="calcTax(this);"></td>
                                                    <td width="7%"><input class="parent_text text-right" type="text" name="abs___kkcess"  id="abs___kkcess" onkeypress="return isDecimal(event,this)" onchange="calcTax(this);"></td>
                                                    <td width="7%"><input class="parent_text text-right" type="text" name="abs___sbcess" id="abs___sbcess" onkeypress="return isDecimal(event,this)" onchange="calcTax(this);"></td>
                                                    <td width="7%"><input class="parent_text text-right" type="text" name="abs___nettax" id="abs___nettax" onkeypress="return isDecimal(event,this)" readonly></td>
                                                    <td width="7%"><input class="parent_text text-right" type="text" name="abs___reversetax" id="abs___reversetax" onkeypress="return isDecimal(event,this)" onchange="calcTax(this);"></td>
                                                </tr>
                                                <tr class="padi05">
                                                    <td width="8%">Amount</td>
                                                    <td width="8%"><input class="parent_padi05 text-right" type="text" name="abs___taxableamt" id="abs___taxableamt"readonly /></td>
                                                    <td width="8%"><input class="parent_padi05 text-right" type="text" name="abs___taxamt" id="abs___taxamt" readonly/></td>
                                                    <td width="8%"><input class="parent_padi05 text-right" type="text" name="abs___kkcessamt" id="abs___kkcessamt" readonly/></td>
                                                    <td width="8%"><input class="parent_padi05 text-right" type="text" name="abs___sbcessamt" id="abs___sbcessamt" readonly/></td>
                                                    <td width="10%"><input class="parent_padi05 text-right" type="text" name="abs___netamt" id="abs___netamt" readonly /></td>
                                                    <td width="10%"><input class="parent_padi05 text-right" type="text" name="abs___reversetaxamt" id="abs___reversetaxamt" readonly /></td>
                                                </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </td>
    </tr>
</script>
<script type="text/template" id="adv-recovery-template">
    <tr style="display:none;" class="subTr">
        <td colspan="9" style="padding:0px !important; ">
            <div class="subDiv" style="display:none;">
                <table class="table" style=" margin-bottom:0px;" id="abs___table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Ref No.</th>
                            <th>Adv. Type</th>
                            <th style="text-align:right">Total Adv.</th>
                            <th style="text-align:right">Recovered Amt</th>
                            <th style="text-align:right">Balance Amt</th>
                            <th style="text-align:right">Current Amt</th>
                        </tr>
                    </thead>
                    <tbody class="main"></tbody>
                    <tbody class="total">
                        <tr>
                            <td colspan="5">&nbsp;</td>
                            <td align="right" class="rate_pri">Total</td>
                            <td width="10%"><input class="parent_padi05 text-right" type="text" name="advmattotalcuramt" id="advmattotalcuramt" readonly/></td>
                        </tr>
                    </tbody>
                </table>
                <input type="hidden" name="abs___rowid" id="abs___rowid" value="0"/>
            </div>
        </td>
    </tr>
</script>
<script type="text/template" id="adv-recovery-tr-template">
    <tr class="padi05" colspan="6">
        <input type="hidden" name="abs___WorkBillAdvMaterialTransId_0" id="abs___WorkBillAdvMaterialTransId_0" value="0"/>
        <input type="hidden" name="abs___UpdateRow_0" id="abs___UpdateRow_0" value="0"/>
        <input type="hidden" name="abs___ARRegisterId_0" id="abs___ARRegisterId_0" />
        <input type="hidden" name="abs___typeid_0" id="abs___typeid_0" />
        <td width="5%">{{date}}</td>
        <td width="5%">{{refno}}</td>
        <td width="6%">{{advtype}}</td>
        <td width="8%" style="text-align:right" id="abs___advmattotamt_0">{{totalamt}}</td>
        <td width="8%" style="text-align:right" id="abs___advmatrecamt_0">0</td>
        <td width="8%" style="text-align:right" id="abs___advmatbalamt_0">0</td>
        <td width="10%" style="position:relative;"><input class="parent_text text-right qualmainTrInput" type="text" name="abs___advmatcuramt_0" id="abs___advmatcuramt_0" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 2, true)" onchange="calcAdvRec(this);"></td>
    </tr>
</script>
<script type="text/template" id="wct-template">
    <tr style="display:none;" class="subTr">
        <td colspan="9" style="padding:0px !important; ">
            <div class="subDiv" style="display:none;">
                <table class="table" style=" margin-bottom:0px;" id="abs___table">
                    <thead>
                        <tr>
                            <th>Expression</th>
                            <th style="text-align:right">Exp. Value</th>
                            <th style="text-align:right">Percentage (%)</th>
                            <th style="text-align:right">Net Tax</th>
                            <th>&nbsp;</th>
                        </tr>
                    </thead>
                    <tbody class="main"></tbody>
                    <tbody class="total">
                        <tr>
                            <td colspan="2">&nbsp;</td>
                            <td align="right" class="rate_pri">Total</td>
                            <td width="10%"><input class="parent_padi05 text-right" type="text" name="wcttotalnettax" id="wcttotalnettax" readonly/></td>
                            <td>&nbsp;</td>
                        </tr>
                    </tbody>
                </table>
                <input type="hidden" name="abs___rowid" id="abs___rowid" value="0"/>
            </div>
        </td>
    </tr>
</script>
<script type="text/template" id="wct-tr-template">
    <tr class="padi05" colspan="6">
        <input type="hidden" name="abs___WorkBillWCTTransId_0" id="abs___WorkBillWCTTransId_0" value="0"/>
        <input type="hidden" name="abs___UpdateRow_0" id="abs___UpdateRow_0" value="0"/>
        <td width="10%"><input class="parent_text qualmainTrInput qualChange" type="text" name="abs___wctexpression_0" id="abs___wctexpression_0" onkeypress="return isFormula(event);" onchange="calcWCT(this);"></td>
        <td width="10%"><input class="parent_padi05 text-right qualmainTrInput" type="text" name="abs___wctexpvalue_0" id="abs___wctexpvalue_0" readonly></td>
        <td width="10%"><input class="parent_text text-right qualmainTrInput qualChange" type="text" name="abs___wctper_0" id="abs___wctper_0" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 2)" onchange="calcWCT(this);"></td>
        <td width="10%" style="position:relative;"><input class="parent_padi05 text-right qualmainTrInput" type="text" name="abs___wctnettax_0" id="abs___wctnettax_0" readonly></td>
        <td width="3%" align="center" class="action_btns_td">
            <ul class="action_btns">
                <li><a id="abs___DeleteRow_0" onclick="deleteRow(this, event);" style="display: none;"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i></a></li>
            </ul>
        </td>
    </tr>
</script>
<script type="text/template" id="vat-template">
    <tr style="display:none;" class="subTr">
        <td colspan="9" style="padding:0px !important; ">
            <div class="subDiv" style="display:none;">
                <table class="table" style=" margin-bottom:0px;" id="abs___table">
                    <thead>
                        <tr>
                            <th>Expression</th>
                            <th style="text-align:right">Exp. Value</th>
                            <th style="text-align:right">Percentage (%)</th>
                            <th style="text-align:right">Net Tax</th>
                        </tr>
                    </thead>
                    <tbody class="main"></tbody>
                    <tbody class="total">
                        <tr>
                            <td colspan="2">&nbsp;</td>
                            <td align="right" class="rate_pri">Total</td>
                            <td width="10%"><input class="parent_padi05 text-right" type="text" name="vattotalnettax" id="vattotalnettax" readonly/></td>
                        </tr>
                    </tbody>
                </table>
                <input type="hidden" name="abs___rowid" id="abs___rowid" value="0"/>
            </div>
        </td>
    </tr>
</script>
<script type="text/template" id="vat-tr-template">
    <tr class="padi05" colspan="6">
        <input type="hidden" name="abs___WorkBillVATTransId_0" id="abs___WorkBillVATTransId_0" value="0"/>
        <input type="hidden" name="abs___UpdateRow_0" id="abs___UpdateRow_0" value="0"/>
        <td width="10%"><input class="parent_text qualmainTrInput qualChange" type="text" name="abs___vatexpression_0" id="abs___vatexpression_0" onkeypress="return isFormula(event);" onchange="calcVat(this);"></td>
        <td width="10%"><input class="parent_padi05 text-right qualmainTrInput" type="text" name="abs___vatexpvalue_0" id="abs___vatexpvalue_0" readonly></td>
        <td width="10%"><input class="parent_text text-right qualmainTrInput qualChange" type="text" name="abs___vatper_0" id="abs___vatper_0" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 2)" onchange="calcVat(this);"></td>
        <td width="10%" style="position:relative;"><input class="parent_padi05 text-right qualmainTrInput" type="text" name="abs___vatnettax_0" id="abs___vatnettax_0" readonly></td>
    </tr>
</script>
<script type="text/template" id="price-esc-template">
    <tr style="display:none;" class="subTr">
        <td colspan="9" style="padding:0px !important; ">
            <div class="subDiv" style="display:none;">
                <table class="table" style=" margin-bottom:0px;" id="abs___table">
                    <thead>
                        <tr>
                            <th>Material Name</th>
                            <th>Unit</th>
                            <th>Qty</th>
                            <th style="text-align:right">Base Rate</th>
                            <th style="text-align:right">Escalation %</th>
                            <th style="text-align:right">Esc. Rate</th>
                            <th style="text-align:right">Amount</th>
                            <th>&nbsp;</th>
                        </tr>
                    </thead>
                    <tbody class="main"></tbody>
                    <tbody class="total">
                        <tr>
                            <td colspan="5">&nbsp;</td>
                            <td align="right" class="rate_pri">Total</td>
                            <td width="10%"><input class="parent_padi05 text-right" type="text" name="priceesctotal" id="priceesctotal" readonly/></td>
                            <td>&nbsp;</td>
                        </tr>
                    </tbody>
                </table>
                <input type="hidden" name="abs___rowid" id="abs___rowid" value="0"/>
            </div>
        </td>
    </tr>
</script>
<script type="text/template" id="price-esc-tr-template">
    <tr class="padi05" colspan="6">
        <input type="hidden" name="abs___WorkBillPriceEscTransId_0" id="abs___WorkBillPriceEscTransId_0" value="0"/>
        <input type="hidden" name="abs___UpdateRow_0" id="abs___UpdateRow_0" value="0"/>
        <td width="18%">
            <input class="parent_text price-esc-mat" type="text" id="abs___priceescmatname_0" onfocus="checkPriceEscMaterialUsed(this);">
            <input type="hidden" id="abs___priceescmatid_0" name="abs___priceescmatid_0" value="0"/>
        </td>
        <td width="10%">
            <input class="parent_padi05" type="text" id="abs___priceescunit_0" readonly>
            <input type="hidden" id="abs___priceescunitid_0" />
        </td>
        <td width="10%"><input class="parent_text" type="text" name="abs___priceescqty_0" id="abs___priceescqty_0" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 3)" onchange="calcPriceEsc(this);"></td>
        <td width="10%"><input class="parent_padi05 text-right" type="text" name="abs___priceescbaserate_0" id="abs___priceescbaserate_0" readonly></td>
        <td width="10%"><input class="parent_padi05 text-right" type="text" name="abs___priceescper_0" id="abs___priceescper_0" readonly></td>
        <td width="10%"><input class="parent_padi05 text-right" type="text" name="abs___priceescrate_0" id="abs___priceescrate_0" readonly></td>
        <td width="10%"><input class="parent_padi05 text-right" type="text" name="abs___priceescamt_0" id="abs___priceescamt_0" readonly></td>
        <td width="3%" align="center" class="action_btns_td">
            <ul class="action_btns">
                <li><a id="abs___DeleteRow_0" onclick="deleteRow(this, event);" style="display: none;"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i></a></li>
            </ul>
        </td>
        <input type="hidden" id="abs___priceescactualrate_0" name="abs___priceescactualrate_0" value="0"/>
    </tr>
</script>
<script type="text/template" id="excess-mat-template">
    <tr style="display:none;" class="subTr">
        <td colspan="9" style="padding:0px !important; ">
            <div class="subDiv" style="display:none;">
                <table class="table" style=" margin-bottom:0px;" id="abs___table">
                    <thead>
                        <tr>
                            <th>Material Name</th>
                            <th>Unit</th>
                            <th>Qty</th>
                            <th style="text-align:right">Rate</th>
                            <th style="text-align:right">Amount</th>
                            <th>&nbsp;</th>
                        </tr>
                    </thead>
                    <tbody class="main"></tbody>
                    <tbody class="total">
                        <tr>
                            <td colspan="3">&nbsp;</td>
                            <td align="right" class="rate_pri">Total</td>
                            <td width="10%"><input class="parent_padi05 text-right" type="text" name="excessmattotal" id="excessmattotal" readonly/></td>
                            <td>&nbsp;</td>
                        </tr>
                    </tbody>
                </table>
                <input type="hidden" name="abs___rowid" id="abs___rowid" value="0"/>
            </div>
        </td>
    </tr>
</script>
<script type="text/template" id="excess-mat-tr-template">
    <tr class="padi05" colspan="6">
        <input type="hidden" name="abs___WorkBillExcessMaterialTransId_0" id="abs___WorkBillExcessMaterialTransId_0" value="0"/>
        <input type="hidden" name="abs___UpdateRow_0" id="abs___UpdateRow_0" value="0"/>
        <td width="18%">
            <input class="parent_text excess-mat" type="text" id="abs___excessmatname_0" onfocus="checkExcessMatMaterialUsed(this);">
            <input type="hidden" id="abs___excessmatid_0" name="abs___excessmatid_0" value="0"/>
        </td>
        <td width="10%">
            <input class="parent_padi05" type="text" id="abs___excessmatunit_0" readonly>
            <input type="hidden" id="abs___excessmatunitid_0"/>
        </td>
        <td width="10%"><input class="parent_text" type="text" name="abs___excessmatqty_0" id="abs___excessmatqty_0" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 3)" onchange="calcExcessMat(this);"></td>
        <td width="10%"><input class="parent_text text-right" type="text" name="abs___excessmatrate_0" id="abs___excessmatrate_0" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 2, true)" onchange="calcExcessMat(this);"></td>
        <td width="10%"><input class="parent_padi05 text-right" type="text" name="abs___excessmatamt_0" id="abs___excessmatamt_0" readonly></td>
        <td width="3%" align="center" class="action_btns_td">
            <ul class="action_btns">
                <li><a id="abs___DeleteRow_0" onclick="deleteRow(this, event);" style="display: none;"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i></a></li>
            </ul>
        </td>
    </tr>
</script>
<script type="text/template" id="theo-mat-template">
    <tr style="display:none;" class="subTr">
        <td colspan="9" style="padding:0px !important; ">
            <div class="subDiv" style="display:none;">
                <table class="table" style=" margin-bottom:0px;" id="abs___table">
                    <thead>
                        <tr>
                            <th>Material Name</th>
                            <th>Unit</th>
                            <th>Qty</th>
                            <th style="text-align:right">Rate</th>
                            <th style="text-align:right">Amount</th>
                            <th>&nbsp;</th>
                        </tr>
                    </thead>
                    <tbody class="main"></tbody>
                    <tbody class="total">
                        <tr>
                            <td colspan="3">&nbsp;</td>
                            <td align="right" class="rate_pri">Total</td>
                            <td width="10%"><input class="parent_padi05 text-right" type="text" name="theomattotal" id="theomattotal" readonly/></td>
                            <td>&nbsp;</td>
                        </tr>
                    </tbody>
                </table>
                <input type="hidden" name="abs___rowid" id="abs___rowid" value="0"/>
            </div>
        </td>
    </tr>
</script>
<script type="text/template" id="theo-mat-tr-template">
    <tr class="padi05" colspan="6">
        <input type="hidden" name="abs___WorkBillExcessMaterialTransId_0" id="abs___WorkBillTheorecticalMaterialTransId_0" value="0"/>
        <input type="hidden" name="abs___UpdateRow_0" id="abs___UpdateRow_0" value="0"/>
        <td width="18%">
            <input class="parent_text theo-mat" type="text" id="abs___theomatname_0" onfocus="checkTheoMatMaterialUsed(this);">
            <input type="hidden" id="abs___theomatid_0" name="abs___theomatid_0" value="0"/>
        </td>
        <td width="10%">
            <input class="parent_padi05" type="text" id="abs___theomatunit_0" readonly>
            <input type="hidden" id="abs___theomatunitid_0"/>
        </td>
        <td width="10%"><input class="parent_text" type="text" name="abs___theomatqty_0" id="abs___theomatqty_0" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 3)" onchange="calcTheoMat(this);"></td>
        <td width="10%"><input class="parent_text text-right" type="text" name="abs___theomatrate_0" id="abs___theomatrate_0" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 2, true)" onchange="calcTheoMat(this);"></td>
        <td width="10%"><input class="parent_padi05 text-right" type="text" name="abs___theomatamt_0" id="abs___theomatamt_0" readonly></td>
        <td width="3%" align="center" class="action_btns_td">
            <ul class="action_btns">
                <li><a id="abs___DeleteRow_0" onclick="deleteRow(this, event);" style="display: none;"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i></a></li>
            </ul>
        </td>
    </tr>
</script>
<script type="text/template" id='recert-agreement-template'>
    <tr style="display:none;" class="subTr">
        <td colspan="9" style="padding:0px !important; ">
            <div class="subDiv" style="display:none;">
                <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"></div>
                <div class="col-lg-12">
                    <div class="table-responsive topsp">
                        <table class="table" style="margin-bottom:0px;"  id="abs___table">
                            <thead>
                                <tr>
                                    <th>Specification</th>
                                    <th>Unit</th>
                                    <th>Qty</th>
                                    <th class="text-right">Rate</th>
                                    <th class="text-right">Amount</th>
                                    <th>Sign</th>
                                    <th>&nbsp;</th>
                                </tr>
                            </thead>
                            <tbody class="main"></tbody>
                        </table>
                        <input type="hidden" name="abs___rowid" id="abs___rowid" value="0"/>
                        <input type="hidden" name="abs___deleteids" id="abs___deleteids"/>
                    </div>
                </div>
            </div>
        </td>
    </tr>
</script>
<script type="text/template" id='recert-agreement-tr-template'>
    <tr>
        <td width="13%">
            <input class="parent_text recert-agree" type="text" name="abs___desc_0" id="abs___desc_0" onfocus="checkRecertAgreementUsed(this);" data-type="{{recerttype}}"/>
            <input type="hidden" name="abs___descid_0" id="abs___descid_0"/>
        </td>
        <td width="5%"><input class="parent_padi05" type="text" id='abs___unit_0' readonly/></td>
        <td width="5%"><input class="parent_padi05" type="text" name="abs___qty_0" id="abs___qty_0" readonly/></td>
        <td width="5%" class="full-rates">
            <input class="parent_padi05 text-right" type="text" name="abs___rate_0" id="abs___rate_0" readonly/>
        </td>
        <td width="5%"><input class="parent_padi05 text-right" type="text" name="abs___amount_0" id="abs___amount_0" readonly/></td>
        <td width="1%" class="text-center"><label class="mi-pl-ic"><i class="fa fa-plus-circle" aria-hidden="true" id="abs___signicon_0"></i></label></td>
        <td width="4%" align="center" class="action_btns_td">
            <ul class="action_btns">
                <li> <a href="#" class="mainTr" id="abs___MainTr_0" style="display: none;"> <i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="left" data-original-title="Show" ></i></a> </li>
                <li> <a id="abs___DeleteRow_0" onclick="deleteRow(this, event);" style="display: none;"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
            </ul>
        </td>
        <input type="hidden" name="abs___WorkBillTransId_0" id="abs___WorkBillTransId_0" value="0"/>
        <input type="hidden" name="abs___UpdateBillRow_0" id="abs___UpdateBillRow_0" value="0"/>
        <input type="hidden" name="abs___transid_0" id="abs___transid_0" value="0"/>
        <input type="hidden" name="abs___sign_0" id="abs___sign_0" value="+"/>
        <input type="hidden" name="abs___iowid_0" id="abs___iowid_0"/>
        <input type="hidden" name="abs___resourceid_0" id="abs___resourceid_0"/>
        <input type="hidden" name="abs___ReCerTransId_0" id="abs___ReCerTransId_0"/>
    </tr>
    <tr style="display:none;" class="subTr">
        <td colspan="9" style="padding:0px !important; ">
            <div class="subDiv" style="display:none;">
                <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"> </div>
                <div class="col-lg-12">
                    <div class="table-responsive topsp">
                        <table class="table" style="margin-bottom:0px;" id="abs___table_0">
                            <thead>
                                <tr>
                                    <th>Agt No</th>
                                    <th>Specification</th>
                                    <th>WBS</th>
                                    <th>Unit</th>
                                    <th>Qty</th>
                                    <th>Sign</th>
                                    <th>&nbsp;</th>
                                </tr>
                            </thead>
                            <tbody class="main"></tbody>
                        </table>
                        <input type="hidden" name="abs___act_0_rowid" id="abs___act_0_rowid" value="0"/>
                    </div>
                </div>
            </div>
        </td>
    </tr>
</script>
<script type="text/template" id="recert-agreement-subtr-template">
    <tr>
        <td width="10%">{{agtno}}</td>
        <td width="10%">{{spec}}</td>
        <td width="10%">{{wbs}}</td>
        <td width="10%">{{unit}}</td>
        <td width="10%"><input class="parent_padi05" type="text" name="abs___act_0_qty_1" id="abs___act_0_qty_1" readonly/></td>
        <td width="1%" class="text-center"><label class="mi-pl-ic"><i class="fa fa-plus-circle" aria-hidden="true" id="abs___act_0_signicon_1"></i></label></td>
        <td width="4%" align="center" class="action_btns_td">
            <ul class="action_btns">
                <li> <a href="#" class="mainTr"> <i class="fa fa-chevron-circle-down" data-toggle="tooltip" data-placement="left" data-original-title="Show" ></i></a> </li>
            </ul>
        </td>
        <input type="hidden" name="abs___act_0_iowid_1" id="abs___act_0_iowid_1"/>
        <input type="hidden" name="abs___act_0_wbsid_1" id="abs___act_0_wbsid_1"/>
        <input type="hidden" name="abs___act_0_sign_1" id="abs___act_0_sign_1" value="+"/>
    </tr>
    <tr style="display:none;" class="subTr">
        <td colspan="9" style="padding:0px !important; ">
            <div class="subDiv" style="display:none;">
                <div class="col-lg-12 col-lg-offset-0 rdbt" style="margin-top:5px;"> </div>
                <div class="col-lg-12">
                    <div class="table-responsive topsp">
                        <table class="table" style="margin-bottom:0px;" id="abs___certtable_0">
                            <thead>
                                <tr>
                                    <th>Bill Date</th>
                                    <th>Bill No.</th>
                                    <th>Qty</th>
                                    <th>Adj. Qty</th>
                                    <th>Bal. Qty</th>
                                    <th>Cur. Qty</th>
                                </tr>
                            </thead>
                            <tbody class="main"></tbody>
                        </table>
                        <input type="hidden" name="abs___act_0_recertrowid" id="abs___act_0_recertrowid" value="0"/>
                    </div>
                </div>
            </div>
        </td>
    </tr>
</script>
<script type="text/template" id="recert-agreement-billentry-subtr-template">
    <tr>
        <td width="10%">{{billdate}}</td>
        <td width="10%">{{billno}}</td>
        <td width="10%">{{qty}}</td>
        <td width="10%">{{adjqty}}</td>
        <td width="10%" id="abs___act_0_recert_1_balqty_9">{{balqty}}</td>
        <td width="10%"><input class="parent_text" type="text" name="abs___act_0_recert_1_qty_9" id="abs___act_0_recert_1_qty_9" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 3)" onchange="calcRecertQty(this);"/></td>
        <input type="hidden" name="abs___act_0_recert_1_billiowtransid_9" id="abs___act_0_recert_1_billiowtransid_9"/>
        <input type="hidden" name="abs___act_0_recert_1_billwbstransid_9" id="abs___act_0_recert_1_billwbstransid_9"/>
        <input type="hidden" name="abs___act_0_recert_1_billtransid_9" id="abs___act_0_recert_1_billtransid_9"/>
    </tr>
</script>
<script type="text/template" id="turnkey-agreement-template">
    <tr style="display:none;" class="subTr">
        <td colspan="12" style="padding:0px !important; ">
            <div class="subDiv" style=" display:block;">
                <div class="col-lg-12">
                    <div class="table-responsive topsp">
                        <table class="table" id="abs___table">
                            <thead>
                                <tr>
                                    <th>Desc</th>
                                    <th class="txt_right">Area</th>
                                    <th class="txt_right">WO Rate</th>
                                    <th class="txt_right">WO Amt</th>
                                    <th class="txt_right">Cum Rate</th>
                                    <th class="txt_right">Cum Amt</th>
                                    <th class="txt_right">Prev Rate</th>
                                    <th class="txt_right">Prev Amt</th>
                                    <th class="txt_right">Cur Rate</th>
                                    <th class="txt_right">Cur Amt</th>
                                    <th>&nbsp;</th>
                                </tr>
                            </thead>
                            <tbody class="main"></tbody>
                            <tbody class="total">
                                <tr>
                                    <td colspan="3">&nbsp;</td>
                                    <td class="tbl_input_td">
                                        <input class="tbl_input border-none text-right" type="text" name="abs___woAmtTotal" id="abs___woAmtTotal" readonly/>
                                    </td>
                                    <td colspan="1">&nbsp;</td>
                                    <td class="tbl_input_td" >
                                        <input class="tbl_input border-none text-right" type="text" name="abs___cumAmtTotal" id="abs___cumAmtTotal" readonly/>
                                    </td>
                                    <td colspan="1">&nbsp;</td>
                                    <td class="tbl_input_td">
                                        <input class="tbl_input border-none text-right" type="text" name=abs___prevAmtTotal"" id="abs___prevAmtTotal" readonly/>
                                    </td>
                                    <td colspan="1">&nbsp;</td>
                                    <td class="tbl_input_td">
                                        <input class="tbl_input border-none text-right" type="text" name="abs___curAmtTotal" id="abs___curAmtTotal" readonly/>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <input type="hidden" name="abs___rowid" id="abs___rowid" value="0"/>
                        <input type="hidden" name="abs___deleteids" id="abs___deleteids"/>
                    </div>
                </div>
            </div>
        </td>
    </tr>
</script>
<script type="text/template" id="turnkey-agreement-tr-template">
    <tr>
        <td width="10%" class="tbl_input_td">{{desc}}</td>
        <td width="5%" class="tbl_input_td"><input class="tbl_input txt_right" type="text" id="abs___area_0" readonly/></td>
        <td width="5%" class="tbl_input_td"><input class="tbl_input txt_right" type="text" id="abs___worate_0" readonly/></td>
        <td width="5%" class="tbl_input_td"><input class="tbl_input txt_right" type="text" id="abs___woamount_0" readonly/></td>
        <td width="5%" class="tbl_input_td"><input class="tbl_input txt_right" type="text" id="abs___cumrate_0" readonly/></td>
        <td width="5%" class="tbl_input_td"><input class="tbl_input txt_right" id="abs___cumamount_0" readonly/></td>
        <td width="5%" class="tbl_input_td"><input class="tbl_input txt_right" id="abs___prevrate_0" readonly/></td>
        <td width="5%" class="tbl_input_td"><input class="tbl_input txt_right" id="abs___prevamount_0" readonly/></td>
        <td width="5%" class="tbl_input_td"><input class="tbl_input txt_right" name="abs___rate_0" id="abs___rate_0" onkeypress="return isDecimal(event,this)" onblur="return FormatNum(this, 3)" onchange="calcTurnKey(this);"/></td>
        <td width="5%" class="tbl_input_td"><input class="tbl_input txt_right" type="text" name="abs___amount_0" id="abs___amount_0" readonly/></td>
        <td width="2%" align="center" class="action_btns_td">
            <ul class="action_btns">
                <li> <a id="abs___DeleteRow_0" onclick="deleteRow(this, event);"><i class="fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="Delete"></i> </a> </li>
            </ul>
        </td>
        <input type="hidden" name="abs___WorkBillTransId_0" id="abs___WorkBillTransId_0" value="0"/>
        <input type="hidden" name="abs___UpdateBillRow_0" id="abs___UpdateBillRow_0" value="0"/>
        <input type="hidden" name="abs___sign_0" id="abs___sign_0" value="+"/>
        <input type="hidden" name="abs___wbsid_0" id="abs___wbsid_0"/>
    </tr>
</script>

<script type="text/javascript">
    var isBillEditable = true;
    var $confirmToolTipTemplate = '<div class="on-focus clearfix" style="position:relative;" id="FormulaConfirmationToolTip">'
        + '<div class="top-tip">'
        + '<span>Do You Need Formula?</span>'
        + '<a href="#" onclick="setFormula(); return false;" class="colgreen"><i class="fa fa-check"></i> Yes</a>'
        + '<a href="#" onclick="removeTooltip(); return false;" class="colred"><i class="fa fa-times"></i> No</a>'
        + '</div>'
        +'</div>';
    var $mSheetConfirmToolTipTemplate = '<div class="on-focus clearfix" style="position:relative;" id="MSheetConfirmationToolTip">'
        + '<div class="top-tip">'
        + '<span>Do You Need Measurement Sheet?</span>'
        + '<a href="#" onclick="setMSheet(); return false;" class="colgreen"><i class="fa fa-check"></i> Yes</a>'
        + '<a href="#" onclick="removeTooltip(); return false;" class="colred"><i class="fa fa-times"></i> No</a>'
        + '</div>'
        +'</div>';
    var $HandsonWrapper = $('#HandsonWrapper'),
        $formWrapper = $('#formWrapper');

    var $jqxLSList = $("#jqxLSList");
    var arr_billformats = <?php echo (isset($arr_billformats)) ? json_encode($arr_billformats) : '[]'; ?>;
    var womateriallists = <?php echo (isset($womateriallists)) ? json_encode($womateriallists) : '[]'; ?>;
    var tmp_womateriallists = womateriallists;
    var excessmateriallists = <?php echo (isset($materiallists)) ? json_encode($materiallists) : '[]'; ?>;
    var tmp_excessmateriallists = excessmateriallists;
    var theomateriallists = <?php echo (isset($materiallists)) ? json_encode($materiallists) : '[]'; ?>;
    var tmp_theomateriallists = theomateriallists;

    // recertification lists
    var recert_agreement = <?php echo (isset($recert_agreement)) ? json_encode($recert_agreement) : '[]'; ?>;
    var tmp_recert_agreement = recert_agreement;
    var recert_nonagreement = <?php echo (isset($recert_nonagreement)) ? json_encode($recert_nonagreement) : '[]'; ?>;
    var tmp_recert_nonagreement = recert_nonagreement;

    var WorkType = $('#WorkType').val();
    var arrReadOnlyFormats = ['1','2','3','8','11','12','13','14','19','39','29','38','33','34'];
    $(function () {
        var $rowid = $('#rowid');
        var template = $('#billabstract-template').html();
        var header_template = $('#billabstract-header-template').html();
        var rowid = 0;
        var $tbody = $('#billAbstractTable').find('> tbody.main');
        $.each(arr_billformats, function (i, o) {
            rowid++;

            if (o.BillFormatId == 0 || o.BillFormatId == '' || o.BillFormatId == null) {
                $tbody.append(header_template.replace(/__/g, '_' + rowid));
                $('#TypeName_' + rowid).html(o.Description);
                if(o.BillFormatId == 0 && ($.trim(o.Slno) == '' || $.trim(o.Slno) == null)) {
                    $('.headerBill_' + rowid).html('');
                } else {
                    $('#CurAmount_' + rowid).prop('readonly', true).attr('onfocus', 'showFormulaModal(this.id)');
                }
                if(o.Bold == 1) {
                    $('#TypeName_' + rowid).css("font-weight", "bold");
                }
                if(o.Italic == 1) {
                    $('#TypeName_' + rowid).css("font-style", "italic");
                }
                if(o.Underline == 1) {
                    $('#TypeName_' + rowid).css("text-decoration", "underline");
                }
                $('#Formula_' + rowid).val($.trim(o.Formula));
            } else {
                $tbody.append(template.replace(/__/g, '_' + rowid));
                $('#RowName_' + rowid).html('R' + o.BillFormatId);
                $('#Formula_' + rowid).val($.trim(o.Formula));
                $('#Sign_' + rowid).val(o.Sign);
                $('#FormatTypeId_' + rowid).val(o.BillFormatId);
                $('#AccountTypeId_' + rowid).val(o.AccountTypeId);
                $('#AccountId_' + rowid).val(o.AccountId);
                $('#Account_' + rowid).val(o.AccountName);
                $('#Header_' + rowid).val(o.Header);

                if ($.trim(o.Description).length != 0)
                    $('#TypeName_' + rowid).html(o.Description);
                else
                    $('#TypeName_' + rowid).html(o.TypeName);

                // current amt readonly
                if ($.inArray($.trim(o.BillFormatId), arrReadOnlyFormats) != -1) {
                    $('#CurAmount_' + rowid).prop('readonly', true);
                    $('#CurAmount_' + rowid).attr('onfocus', 'onFocusOther()');
                } else {
                    $('#CurAmount_' + rowid).attr('onfocus', 'showFormulaModal(this.id)');
                }
                var $mainRow = $('#mainRow_' + rowid);
                switch (o.BillFormatId) {
                    case '1':
                    case '2': // agreement & non-agreement
                        if (WorkType == 'turn-key') {
                            $mainRow.after($('#turnkey-agreement-template').html().replace(/__/g, '_' + rowid));
                            $('#mainExpandTr_' + rowid).show();

                            // add rows (turn key)
                            var absrowid = 0;
                            if (typeof o.AddRow != 'undefined') {
                                var agrTrTemplate = $('#turnkey-agreement-tr-template').html();
                                $.each(o.AddRow, function (j, r) {
                                    if(r.WorkBillFormatTransId != 'undefined' && o.WorkBillFormatTransId != r.WorkBillFormatTransId) {
                                        return;
                                    }
                                    absrowid++;
                                    $('#abs_' + rowid + '_table > tbody.main').append(agrTrTemplate.replace(/_0/g, '_' + absrowid)
                                        .replace(/__/g, '_' + rowid)
                                        .replace(/\{\{desc\}\}/g, r.Desc));
                                    $('#abs_' + rowid + '_wbsid_' + absrowid).val(r.WBSId);
                                    $('#abs_' + rowid + '_area_' + absrowid).val(sanitizeNumber(r.Area, 3, true));
                                    $('#abs_' + rowid + '_worate_' + absrowid).val(sanitizeNumber(r.WORate, 2, true));
                                    $('#abs_' + rowid + '_woamount_' + absrowid).val(sanitizeNumber(r.WOAmount, 2, true));
                                    $('#abs_' + rowid + '_cumrate_' + absrowid).val(sanitizeNumber(r.CumRate, 2, true));
                                    $('#abs_' + rowid + '_cumamount_' + absrowid).val(sanitizeNumber(r.CumAmount, 2, true));
                                    $('#abs_' + rowid + '_prevrate_' + absrowid).val(sanitizeNumber(r.PrevRate, 2, true));
                                    $('#abs_' + rowid + '_prevamount_' + absrowid).val(sanitizeNumber(r.PrevAmount, 2, true));

                                    if (typeof r.WorkBillTurnKeyTransId != 'undefined' && r.BillFormatId == o.BillFormatTransId) {
                                        $('#abs_' + rowid + '_WorkBillTransId_' + absrowid).val(r.WorkBillTurnKeyTransId);
                                        $('#abs_' + rowid + '_rate_' + absrowid).val(sanitizeNumber(r.CurRate, 2, true)).trigger('change');
                                        $('#abs_' + rowid + '_amount_' + absrowid).val(sanitizeNumber(r.CurAmount, 2, true));
                                    } else {
                                        $('#abs_' + rowid + '_rate_' + absrowid).trigger('change');
                                    }
                                });
                            }
                            $('#abs_' + rowid + '_rowid').val(absrowid);
                        } else {
                            $mainRow.after($('#agreement-template').html().replace(/__/g, '_' + rowid));
                            $('#mainExpandTr_' + rowid).show();

                            // add rows
                            var absrowid = 0;
                            var totAmt = 0;
                            if (typeof o.AddRow != 'undefined') {
                                var agrTrTemplate = $('#agreement-tr-template').html();
                                var agrSubTrTemplate = $('#agreement-subtr-template').html();
                                // row (resource / iow)
                                $.each(o.AddRow, function (j, r) {
                                    if (typeof r.WorkBillFormatTransId != 'undefined' && r.WorkBillFormatTransId != o.WorkBillFormatTransId) {
                                        return;
                                    }

                                    absrowid++;
                                    $('#abs_' + rowid + '_table > tbody.main').append(agrTrTemplate.replace(/_0/g, '_' + absrowid)
                                            .replace(/__/g, '_' + rowid)
                                            .replace(/\{\{code\}\}/g, r.Code)
                                            .replace(/\{\{spec\}\}/g, r.Specification)
                                            .replace(/\{\{unit\}\}/g, r.UnitName)
                                    );
                                    $('#abs_' + rowid + '_transid_' + absrowid).val(r.DPETransId);
                                    $('#abs_' + rowid + '_iowid_' + absrowid).val(r.IOWId);
                                    $('#abs_' + rowid + '_resourceid_' + absrowid).val(r.ResourceId);

                                    $('#abs_' + rowid + '_actualrate_' + absrowid).val(r.Rate);
                                    $('#abs_' + rowid + '_act_' + absrowid + '_woqty').val(r.WOQty);
                                    $('#abs_' + rowid + '_act_' + absrowid + '_estqty').val(r.EstQty);

                                    $('#abs_' + rowid + '_qty_' + absrowid).val(sanitizeNumber(r.Qty,3));
                                    $('#abs_' + rowid + '_actualqty_' + absrowid).val(r.Qty);
                                    $('#abs_' + rowid + '_rate_' + absrowid).val(sanitizeNumber(r.Rate, 2, true));

                                    var amount = (parseFloatVal(r.Qty) * parseFloatVal(r.Rate));
                                    $('#abs_' + rowid + '_amount_' + absrowid).val(sanitizeNumber(amount, 2, true));
                                    if(typeof r.WorkBillTransId != 'undefined') {
                                        $('#abs_' + rowid + '_WorkBillTransId_' + absrowid).val(r.WorkBillTransId);
                                        $('#abs_' + rowid + '_qty_' + absrowid).val(sanitizeNumber(r.Qty,3));
                                        $('#abs_' + rowid + '_rate_' + absrowid).val(sanitizeNumber(r.Rate,2));
                                        $('#abs_' + rowid + '_amount_' + absrowid).val(sanitizeNumber(r.Amount, 2, true));
                                        $('#abs_' + rowid + '_ratetype_' + absrowid).val(r.RateType);
                                        $('#abs_' + rowid + '_partrateper_' + absrowid).val(r.PartRatePer);
                                        $('#abs_' + rowid + '_partrate_' + absrowid).val(r.PartRate);
                                        $('#abs_' + rowid + '_actualrate_' + absrowid).val(r.Rate);
                                        $('#abs_' + rowid + '_actualqty_' + absrowid).val(r.Qty);
                                        $('#abs_' + rowid + '_UpdateBillRow_' + absrowid).val(1);
                                    }

                                    totAmt += amount;

                                    if($('#wbsReq').val() != '' && $('#wbsReq').val() == 1) {
                                        // subrow (iow / wbs)
                                        var iowrowid = 0;
                                        if (typeof o.AddSubRow != 'undefined') {
                                            $.each(o.AddSubRow, function (k, s) {
                                                /*if ((typeof s.WorkBillTransId == 'undefined' && r.DPETransId != s.DPETransId)
                                                    || (typeof s.WorkBillTransId != 'undefined' && r.WorkBillTransId != s.WorkBillTransId))
                                                    return;*/
                                                if($('#BillRegisterId').val() != 0) {
                                                    var chkAddRowId = r.WorkBillTransId;
                                                    var chkAddSubRowId = s.WorkBillTransId;
                                                } else {
                                                    var chkAddRowId = r.DPETransId;
                                                    var chkAddSubRowId = s.DPETransId;
                                                }

                                                if(chkAddRowId == chkAddSubRowId) {
                                                    iowrowid++;
                                                    $('#abs_' + rowid + '_table_' + absrowid + ' > tbody.main').append(agrSubTrTemplate.replace(/_1/g, '_' + iowrowid)
                                                            .replace(/_0/g, '_' + absrowid)
                                                            .replace(/__/g, '_' + rowid)
                                                            //.replace(/\{\{agtno\}\}/g, s.RefSerialNo)
                                                            //.replace(/\{\{spec\}\}/g, s.Specification)
                                                            .replace(/\{\{wbs\}\}/g, s.ParentText + '->' + s.WBSName)
                                                        //.replace(/\{\{unit\}\}/g, s.UnitName)
                                                    );
                                                    $('#abs_' + rowid + '_act_' + absrowid + '_iowid_' + iowrowid).val(s.ProjectIOWId);
                                                    $('#abs_' + rowid + '_act_' + absrowid + '_wbsid_' + iowrowid).val(s.WBSId);
                                                    $('#abs_' + rowid + '_act_' + absrowid + '_qty_' + iowrowid).val(sanitizeNumber(s.Qty, 3));

                                                    if (typeof s.WorkBillTransId != 'undefined') {
                                                        $('#abs_' + rowid + '_act_' + absrowid + '_TransId_' + iowrowid).val(s.TransId);
                                                        $('#abs_' + rowid + '_act_' + absrowid + '_UpdateRow_' + iowrowid).val(1);
                                                        $('#abs_' + rowid + '_act_' + absrowid + '_rate_' + iowrowid).val(s.Rate);
                                                        $('#abs_' + rowid + '_act_' + absrowid + '_amount_' + iowrowid).val(s.Amount);
                                                    } else {
                                                        if (s.Rate == 0) {
                                                            $('#abs_' + rowid + '_act_' + absrowid + '_rate_' + iowrowid).val($('#abs_' + rowid + '_rate_' + absrowid).val());
                                                        } else {
                                                            $('#abs_' + rowid + '_act_' + absrowid + '_rate_' + iowrowid).val(s.Rate);
                                                            $('#abs_' + rowid + '_act_' + absrowid + '_amount_' + iowrowid).val(s.Amount);
                                                        }
                                                    }

                                                    if (r.ResourceId != 0) {
                                                        var desId = r.ResourceId;
                                                    } else {
                                                        var desId = r.IOWId;
                                                    }

                                                    var woeQty = 0;
                                                    var wpeQty = 0;
                                                    var wbeQty = 0;
                                                    $.ajax({
                                                        url: getBaseURL() + 'wpm/workbill/entry',
                                                        type: "post",
                                                        data: {
                                                            'ResourceId': desId,
                                                            'ccId': $('#CostCentreId').val(),
                                                            'IOWId': s.ProjectIOWId,
                                                            'WBSId': s.WBSId,
                                                            'Type': 'getwoqty',
                                                            'WOType': WorkType,
                                                            'woRegId': $('#WORegisterId').val()
                                                        },
                                                        async: false,
                                                        success: function (data, textStatus, jqXHR) {
                                                            if (jqXHR.status == 200) {
                                                                data = JSON.parse(data);
                                                                woeQty = data.WOQty;
                                                                wpeQty = data.WPQty;
                                                                wbeQty = data.WBQty;
                                                                if (woeQty == null) {
                                                                    woeQty = 0;
                                                                }
                                                                if (wpeQty == null) {
                                                                    wpeQty = 0;
                                                                }
                                                                if (wbeQty == null) {
                                                                    wbeQty = 0;
                                                                }
                                                                $('#abs_' + rowid + '_act_' + absrowid + '_workorderqty_' + iowrowid).html(parseFloatVal(woeQty));
                                                                $('#abs_' + rowid + '_act_' + absrowid + '_wpeqty_' + iowrowid).html(parseFloatVal(wpeQty));
                                                                $('#abs_' + rowid + '_act_' + absrowid + '_totbilledqty_' + iowrowid).html(parseFloatVal(wbeQty));
                                                            }
                                                        }, error: function (jqXHR, textStatus, errorThrown) {
                                                        }
                                                    });
                                                }
                                            });
                                        }
                                    } else {
                                        $('#abs_' + rowid + '_ExpandRow_' + absrowid).hide();
                                        bindWithoutWbs(rowid,absrowid,2);
                                    }
                                    $('#abs_' + rowid + '_act_' + absrowid + '_rowid').val(iowrowid);
                                });
                            }
                            $('#abs_' + rowid + '_rowid').val(absrowid);
                            $('#CurAmount_' + rowid).val(totAmt);
                        }
                        break;
                    case '3': // material recovery
                        $mainRow.after($('#material-recovery-template').html().replace(/__/g, '_' + rowid));
                        $('#mainExpandTr_' + rowid).show();

                        // add rows
                        var absrowid = 0;
                        if (typeof o.AddRow != 'undefined') {
                            var trTemplate = $('#material-recovery-tr-template').html();
                            $.each(o.AddRow, function (j, r) {
                                absrowid++;
                                $('#abs_' + rowid + '_table > tbody.main').append(trTemplate.replace(/_0/g, '_' + absrowid)
                                        .replace(/__/g, '_' + rowid)
                                        .replace(/\{\{code\}\}/g, r.Code)
                                        .replace(/\{\{spec\}\}/g, r.ResourceName)
                                        .replace(/\{\{unit\}\}/g, r.UnitName)
                                );
                                $('#abs_' + rowid + '_resourceid_' + absrowid).val(r.ResourceId);
                                $('#abs_' + rowid + '_issueid_' + absrowid).val(r.TransId);
                                $('#abs_' + rowid + '_issueno_' + absrowid).val(r.IssueNo);
                                $('#abs_' + rowid + '_issuedate_' + absrowid).val(r.IssueDate);
                                $('#abs_' + rowid + '_typeid_' + absrowid).val(r.IssueType);
                                $('#abs_' + rowid + '_unitid_' + absrowid).val(r.UnitId);

                                var cumQty = 0,
                                    qty = r.Qty,
                                    amount = r.Amount;
                                if (typeof o.Recovery != 'undefined') {
                                    $.each(o.Recovery, function (k, rec) {
                                        if (rec.ResourceId != r.ResourceId)
                                            return;

                                        cumQty = rec.CumQty;
                                        qty -= cumQty;
                                        amount = parseFloatVal(r.Rate) * qty;
                                    });
                                }

                                $('#abs_' + rowid + '_cumqty_' + absrowid).val(cumQty);
                                $('#abs_' + rowid + '_availqty_' + absrowid).val(qty);
                                $('#abs_' + rowid + '_qty_' + absrowid).val(sanitizeNumber(qty, 3));
                                $('#abs_' + rowid + '_rate_' + absrowid).val(sanitizeNumber(r.Rate, 2, true));
                                $('#abs_' + rowid + '_amount_' + absrowid).val(sanitizeNumber(amount, 2, true));

                                if(typeof r.WorkBillMaterialRecoveryId != 'undefined') {
                                    $('#abs_' + rowid + '_WorkBillMaterialRecoveryId_' + absrowid).val(r.WorkBillMaterialRecoveryId);
                                }
                            });
                        }
                        $('#abs_' + rowid + '_rowid').val(absrowid);
                        break;
                    case '8': // labour
                        $mainRow.after($('#labour-template').html().replace(/__/g, '_' + rowid));
                        $('#mainExpandTr_' + rowid).show();
                        // add rows
                        var absrowid = 0;
                        if(typeof o.AddRow != 'undefined' && o.AddRow != 0) {
                            var trTemplate = $('#labour-tr-template').html();
                            var netTotal = 0;
                            var subTrTemplate = $('#labour-type-tr-template').html();
                            $.each(o.AddRow, function (j, r) {
                                absrowid++;
                                $('#abs_'+rowid+'_table > tbody.main' ).append(trTemplate.replace(/_0/g, '_'+absrowid)
                                        .replace(/__/g, '_'+rowid)
                                );
                                $('#abs_'+rowid+'_lsRegisterId_'+absrowid).val(r.LSRegisterId);
                                $('#abs_'+rowid+'_lsWbsTransId_'+absrowid).val(r.LSWBSTransId);
                                $('#abs_'+rowid+'_typeId_'+absrowid).val(r.TypeId);
                                $('#abs_'+rowid+'_wbsId_'+absrowid).val(r.WBSId);
                                $('#abs_'+rowid+'_wbsName_'+absrowid).val(r.WBSName);
                                $('#abs_'+rowid+'_wbsQty_'+absrowid).val(sanitizeNumber(r.Qty,3));
                                $('#abs_'+rowid+'_wbsAmount_'+absrowid).val(sanitizeNumber(r.Amount,2,true));
                                $('#abs_'+rowid+'_wbsOtHrs_'+absrowid).val(r.OTHrs);
                                $('#abs_'+rowid+'_wbsOtAmount_'+absrowid).val(sanitizeNumber(r.OTAmount,2,true));
                                $('#abs_'+rowid+'_wbsNetAmount_'+absrowid).val(sanitizeNumber(r.NetAmount,2,true));
                                netTotal += r.NetAmount;

                                if(typeof r.WorkBillLSTransId != 'undefined') {
                                    $('#abs_'+rowid+'_WorkBillLSTransId_'+absrowid).val(r.WorkBillLSTransId);
                                }
                                // subrow (labour types)
                                var iowrowid = 0;
                                if(typeof o.AddSubRow != 'undefined') {
                                    $.each(o.AddSubRow, function (k, s) {
                                        if( (typeof r.WorkBillLSTransId == 'undefined' && r.DPETransId != s.DPETransId)
                                        || (typeof r.WorkBillLSTransId != 'undefined' && r.WorkBillLSTransId != s.WorkBillLSTransId))
                                            return;

                                        iowrowid++;
                                        $('#abs_'+rowid+'_table_'+absrowid+' > tbody.main').append(subTrTemplate.replace(/_1/g, '_'+iowrowid)
                                                .replace(/_0/g, '_'+absrowid)
                                                .replace(/__/g, '_'+rowid)
                                                .replace(/\{\{name\}\}/g, s.ResourceName)
                                        );
                                        $('#abs_'+rowid+'_type_'+absrowid+'_labid_' + iowrowid).val(s.ResourceId);
                                        $('#abs_'+rowid+'_type_'+absrowid+'_labname_' + iowrowid).val(s.ResourceName);
                                        $('#abs_'+rowid+'_type_'+absrowid+'_labqty_' + iowrowid).val(sanitizeNumber(s.Qty,3));
                                        $('#abs_'+rowid+'_type_'+absrowid+'_labrate_' + iowrowid).val(sanitizeNumber(s.Rate,2,true));
                                        $('#abs_'+rowid+'_type_'+absrowid+'_labamt_' + iowrowid).val(sanitizeNumber(s.Amount,2,true));
                                        $('#abs_'+rowid+'_type_'+absrowid+'_labothrs_' + iowrowid).val(s.OTHrs);
                                        $('#abs_'+rowid+'_type_'+absrowid+'_labotrate_' + iowrowid).val(sanitizeNumber(s.OTRate,2,true));
                                        $('#abs_'+rowid+'_type_'+absrowid+'_labotamt_' + iowrowid).val(sanitizeNumber(s.OTAmount,2,true));
                                        $('#abs_'+rowid+'_type_'+absrowid+'_labnetamt_' + iowrowid).val(sanitizeNumber(s.NetAmount,2,true));

                                        if(typeof s.WorkBillLSTypeTransId != 'undefined') {
                                            $('#abs_'+rowid+'_type_'+absrowid+'_TransId_' + iowrowid).val(s.WorkBillLSTypeTransId);
                                        }
                                    });
                                }
                                $('#abs_' + rowid + '_type_' + absrowid + '_rowid').val(iowrowid);
                            });
                            $('#CurAmount_' + rowid).val(sanitizeNumber(netTotal,2,true));
                        }
                        $('#abs_'+rowid+'_rowid').val(absrowid);

                        //bind ls list
                        if (typeof o.LSRegister != 'undefined') {
                            var lsListSource = {
                                localdata: o.LSRegister,
                                dataType: "json",
                                dataFields: [
                                    {name: 'LSRegisterId', type: 'int'},
                                    {name: 'Include', type: 'boolean'},
                                    {name: 'LsDate', type: 'string'},
                                    {name: 'LSNo', type: 'string'}
                                ],
                                id: 'LSRegisterId'
                            };
                            var lsListAdapter = new $.jqx.dataAdapter(lsListSource);
                            $jqxLSList.jqxGrid({
                                width: '100%',
                                pageable: true,
                                rowsheight: 35,
                                selectionMode: 'singleRow',
                                pagerButtonsCount: 6,
                                autoheight: true,
                                source: lsListAdapter,
                                editable: true,
                                columns: [
                                    {
                                        text: '',
                                        dataField: 'Include',
                                        columntype: 'checkbox',
                                        align: 'center',
                                        width: '5%'
                                    },
                                    {text: 'LS Date', dataField: 'LSDate', width: '45%', editable: false},
                                    {text: 'LS No.', dataField: 'LSNo', width: '50%', editable: false}
                                ]
                            });
                        }
                        break;
                    case '13': // TDS
                        $mainRow.after($('#tds-template').html().replace(/__/g, '_' + rowid));
                        $('#mainExpandTr_' + rowid).show();

                        if (typeof o.data != 'undefined') {
                            $('#abs_'+rowid+'_WorkBillTDSTransId').val(o.data.WorkBillTDSTransId);
                            $('#abs_'+rowid+'_tdsexpression').val(o.data.Expression);
                            $('#abs_'+rowid+'_tdsexpvalue').val(o.data.BaseAmt);
                            $('#abs_'+rowid+'_tdsper').val(o.data.TDSNetPer);
                            $('#abs_'+rowid+'_tdsamt').val(o.data.TDSNetAmt);
                            $('#abs_'+rowid+'_taxable').val(o.data.TaxablePer);
                            $('#abs_'+rowid+'_taxableamt').val(o.data.TaxableAmt);
                            $('#abs_'+rowid+'_tax').val(o.data.TaxPer);
                            $('#abs_'+rowid+'_taxamt').val(o.data.TaxAmt);
                            $('#abs_'+rowid+'_cess').val(o.data.CessPer);
                            $('#abs_'+rowid+'_cessamt').val(o.data.CessAmt);
                            $('#abs_'+rowid+'_educess').val(o.data.EduCessPer);
                            $('#abs_'+rowid+'_educessamt').val(o.data.EduCessAmt);
                            $('#abs_'+rowid+'_heducess').val(o.data.HEduCessPer);
                            $('#abs_'+rowid+'_heducessamt').val(o.data.HEduCessAmt);
                        }
                        $('#abs_' + rowid + '_taxable').trigger('change');
                        break;
                    case '11': // Service Tax
                        $mainRow.after($('#service-tax-template').html().replace(/__/g, '_' + rowid));
                        $('#mainExpandTr_' + rowid).show();

                        if (typeof o.data != 'undefined') {
                            $('#abs_'+rowid+'_tdsexpression').val(o.data.Expression);
                            $('#abs_'+rowid+'_tdsexpvalue').val(o.data.BaseAmt);
                            $('#abs_'+rowid+'_tdsper').val(o.data.TDSNetPer);
                            $('#abs_'+rowid+'_tdsamt').val(o.data.TDSNetAmt);
                            $('#abs_'+rowid+'_taxable').val(o.data.TaxablePer);
                            $('#abs_'+rowid+'_taxableamt').val(o.data.TaxableAmt);
                            $('#abs_'+rowid+'_tax').val(o.data.TaxPer);
                            $('#abs_'+rowid+'_taxamt').val(o.data.TaxAmt);
                            $('#abs_'+rowid+'_kkcess').val(o.data.KKCessPer);
                            $('#abs_'+rowid+'_kkcessamt').val(o.data.KKCessAmt);
                            $('#abs_'+rowid+'_sbcess').val(o.data.SBCessPer);
                            $('#abs_'+rowid+'_sbcessamt').val(o.data.SBCessAmt);
                            $('#abs_'+rowid+'_reversetax').val(o.data.ReverseTaxPer);
                            $('#abs_'+rowid+'_reverseamt').val(o.data.ReverseTaxAmt);
                        }
                        $('#abs_' + rowid + '_taxable').trigger('change');
                        break;
                    case '15': //retention recovery
                        $('#CurAmount_' + rowid).val(sanitizeNumber(formulaParser(o.Formula), 2, true));
                        break;
                    case '14': // advance recovery
                        $mainRow.after($('#adv-recovery-template').html().replace(/__/g, '_' + rowid));
                        $('#mainExpandTr_' + rowid).show();

                        var absrowid = 0;
                        if (typeof o.AddRow != 'undefined') {
                            var trTemplate = $('#adv-recovery-tr-template').html();
                            $.each(o.AddRow, function (j, r) {
                                absrowid++;
                                $('#abs_' + rowid + '_table > tbody.main').append(trTemplate.replace(/_0/g, '_' + absrowid)
                                    .replace(/__/g, '_' + rowid)
                                    .replace(/\{\{date\}\}/g, r.RefDate)
                                    .replace(/\{\{refno\}\}/g, r.RefNo)
                                    .replace(/\{\{advtype\}\}/g, r.TypeName)
                                    .replace(/\{\{totalamt\}\}/g, sanitizeNumber(r.TotalAmt, 2, true)));
                                $('#abs_' + rowid + '_typeid_' + absrowid).val(r.TypeId);
                                $('#abs_' + rowid + '_ARRegisterId_' + absrowid).val(r.ARRegisterId);

                                if(typeof r.WorkBillAdvRecoveryId != 'undefined') {
                                    $('#abs_' + rowid + '_WorkBillAdvMaterialTransId_' + absrowid).val(r.WorkBillAdvRecoveryId);
                                    $('#abs_' + rowid + '_advmatcuramt_' + absrowid).val(sanitizeNumber(r.Amount,2,true));
                                }

                                if (typeof o.Recovery != 'undefined') {
                                    $.each(o.Recovery, function (k, rec) {
                                        if (rec.ARRegisterId != r.ARRegisterId)
                                            return;

                                        var balamt = parseFloatVal(r.TotalAmt) - parseFloatVal(rec.RecAmount);
                                        $('#abs_' + rowid + '_advmatrecamt_' + absrowid).html(sanitizeNumber(rec.RecAmount, 2, true));
                                        $('#abs_' + rowid + '_advmatbalamt_' + absrowid).html(sanitizeNumber(balamt, 2, true));
                                    });
                                }
                            });
                        }
                        $('#abs_' + rowid + '_rowid').val(absrowid);
                        break;
                    case '23': // rounding off
                        $('#SignIcon_' + rowid).attr('onclick', 'toggleSign(this);');
                        break;
                    case '19': // wct
                        $mainRow.after($('#wct-template').html().replace(/__/g, '_' + rowid));
                        $('#mainExpandTr_' + rowid).show();

                        var absrowid = 0;
                        var trTemplate = $('#wct-tr-template').html();
                        if (typeof o.AddRow != 'undefined') {
                            $.each(o.AddRow, function (j, r) {
                                absrowid++;
                                $('#abs_' + rowid + '_table > tbody.main').append(trTemplate.replace(/__/g, '_' + rowid)
                                    .replace(/_0/g, '_' + absrowid));
                                $('#abs_' + rowid + '_WorkBillWCTTransId_' + absrowid).val(r.WorkBillWctTransId);
                                $('#abs_' + rowid + '_wctexpression_' + absrowid).val(r.Expression);
                                $('#abs_' + rowid + '_wctexpvalue_' + absrowid).val(sanitizeNumber(r.ExpValue,2,true));
                                $('#abs_' + rowid + '_wctper_' + absrowid).val(sanitizeNumber(r.VATPer,2));
                                $('#abs_' + rowid + '_wctnettax_' + absrowid).val(sanitizeNumber(r.NetValue,2,true));

                                $('#abs_'+rowid+'_DeleteRow_'+absrowid).show();
                            });
                        }
                        absrowid++;
                        $('#abs_' + rowid + '_table > tbody.main').append(trTemplate.replace(/__/g, '_' + rowid)
                            .replace(/_0/g, '_' + absrowid));
                        $('#abs_' + rowid + '_wctper_' + absrowid).trigger('change');
                        $('#abs_' + rowid + '_rowid').val(absrowid);
                        break;
                    case '12': // vat
                        $mainRow.after($('#vat-template').html().replace(/__/g, '_' + rowid));
                        $('#mainExpandTr_' + rowid).show();

                        var absrowid = 0;
                        var trTemplate = $('#vat-tr-template').html();
                        if (typeof o.AddRow != 'undefined') {
                            $.each(o.AddRow, function (j, r) {
                                absrowid++;
                                $('#abs_' + rowid + '_table > tbody.main').append(trTemplate.replace(/__/g, '_' + rowid)
                                    .replace(/_0/g, '_' + absrowid));
                                $('#abs_' + rowid + '_WorkBillVATTransId_' + absrowid).val(r.WorkBillVatTransId);
                                $('#abs_' + rowid + '_vatexpression_' + absrowid).val(r.Expression);
                                $('#abs_' + rowid + '_vatexpvalue_' + absrowid).val(sanitizeNumber(r.ExpValue,2,true));
                                $('#abs_' + rowid + '_vatper_' + absrowid).val(sanitizeNumber(r.VATPer,2));
                                $('#abs_' + rowid + '_vatnettax_' + absrowid).val(sanitizeNumber(r.NetValue,2,true));

                                $('#abs_'+rowid+'_DeleteRow_'+absrowid).show();
                            });
                        }
                        absrowid++;
                        $('#abs_' + rowid + '_table > tbody.main').append(trTemplate.replace(/__/g, '_' + rowid)
                            .replace(/_0/g, '_' + absrowid));
                        $('#abs_' + rowid + '_vatper_' + absrowid).trigger('change');
                        $('#abs_' + rowid + '_rowid').val(absrowid);
                        break;
                    case '39': // price escalation
                        $mainRow.after($('#price-esc-template').html().replace(/__/g, '_' + rowid));
                        $('#mainExpandTr_' + rowid).show();

                        var absrowid = 0;
                        var trTemplate = $('#price-esc-tr-template').html();
                        if (typeof o.AddRow != 'undefined') {
                            $.each(o.AddRow, function (j, r) {
                                absrowid++;
                                $('#abs_' + rowid + '_table > tbody.main').append(trTemplate.replace(/__/g, '_' + rowid)
                                    .replace(/_0/g, '_' + absrowid));
                                $('#abs_' + rowid + '_WorkBillPriceEscTransId_' + absrowid).val(r.WorkBillPriceEscTransId);
                                $('#abs_' + rowid + '_priceescmatname_' + absrowid).val(r.ResourceName);
                                $('#abs_' + rowid + '_priceescmatid_' + absrowid).val(r.ResourceId);
                                $('#abs_' + rowid + '_priceescunit_' + absrowid).val(r.UnitName);
                                $('#abs_' + rowid + '_priceescunitd_' + absrowid).val(r.UnitId);
                                $('#abs_' + rowid + '_priceescqty_' + absrowid).val(sanitizeNumber(r.Qty,3,true));
                                $('#abs_' + rowid + '_priceescbaserate_' + absrowid).val(sanitizeNumber(r.BaseRate,2,true));
                                $('#abs_' + rowid + '_priceescactualrate_' + absrowid).val(sanitizeNumber(r.ActualRate,2,true));
                                $('#abs_' + rowid + '_priceescper_' + absrowid).val(sanitizeNumber(r.Escalation,2,true));
                                $('#abs_' + rowid + '_priceescrate_' + absrowid).val(sanitizeNumber(r.Rate,2,true));
                                $('#abs_' + rowid + '_priceescamt_' + absrowid).val(sanitizeNumber(r.Amount,2,true));

                                $('#abs_'+rowid+'_DeleteRow_'+absrowid).show();
                            });
                        }
                        absrowid++;
                        $('#abs_' + rowid + '_table > tbody.main').append(trTemplate.replace(/__/g, '_' + rowid)
                            .replace(/_0/g, '_' + absrowid));
                        $('#abs_' + rowid + '_priceescqty_' + absrowid).trigger('change');
                        $('#abs_' + rowid + '_rowid').val(absrowid);
                        bindPriceEscAutocomplete();
                        break;
                    case '38': // excess material
                        $mainRow.after($('#excess-mat-template').html().replace(/__/g, '_' + rowid));
                        $('#mainExpandTr_' + rowid).show();

                        var absrowid = 0;
                        var trTemplate = $('#excess-mat-tr-template').html();
                        if (typeof o.AddRow != 'undefined') {
                            $.each(o.AddRow, function (j, r) {
                                absrowid++;
                                $('#abs_' + rowid + '_table > tbody.main').append(trTemplate.replace(/__/g, '_' + rowid)
                                    .replace(/_0/g, '_' + absrowid));
                                $('#abs_' + rowid + '_WorkBillExcessMaterialTransId_' + absrowid).val(r.WorkBillExcessMaterialTransId);
                                $('#abs_' + rowid + '_excessmatname_' + absrowid).val(r.ResourceName);
                                $('#abs_' + rowid + '_excessmatid_' + absrowid).val(r.ResourceId);
                                $('#abs_' + rowid + '_excessmatunit_' + absrowid).val(r.UnitName);
                                $('#abs_' + rowid + '_excessmatunitid_' + absrowid).val(r.UnitId);
                                $('#abs_' + rowid + '_excessmatqty_' + absrowid).val(sanitizeNumber(r.Qty,3,true));
                                $('#abs_' + rowid + '_excessmatrate_' + absrowid).val(sanitizeNumber(r.Rate,2,true));
                                $('#abs_' + rowid + '_excessmatamt_' + absrowid).val(sanitizeNumber(r.Amount,2,true));

                                $('#abs_'+rowid+'_DeleteRow_'+absrowid).show();
                            });
                        }
                        absrowid++;
                        $('#abs_' + rowid + '_table > tbody.main').append(trTemplate.replace(/__/g, '_' + rowid)
                            .replace(/_0/g, '_' + absrowid));
                        $('#abs_' + rowid + '_excessmatqty_' + absrowid).trigger('change');
                        $('#abs_' + rowid + '_rowid').val(absrowid);
                        bindExcessMatAutocomplete();
                        break;
                    case '29': // theorectical material
                        $('#SignIcon_' + rowid).remove();
                        $('#Sign_' + rowid).val('');

                        $mainRow.after($('#theo-mat-template').html().replace(/__/g, '_' + rowid));
                        $('#mainExpandTr_' + rowid).show();

                        var absrowid = 0;
                        var trTemplate = $('#theo-mat-tr-template').html();
                        if (typeof o.AddRow != 'undefined') {
                            $.each(o.AddRow, function (j, r) {
                                absrowid++;
                                $('#abs_' + rowid + '_table > tbody.main').append(trTemplate.replace(/__/g, '_' + rowid)
                                    .replace(/_0/g, '_' + absrowid));
                                $('#abs_' + rowid + '_WorkBillTheorecticalMaterialTransId_' + absrowid).val(r.TransId);
                                $('#abs_' + rowid + '_theomatname_' + absrowid).val(r.ResourceName);
                                $('#abs_' + rowid + '_theomatid_' + absrowid).val(r.ResourceId);
                                $('#abs_' + rowid + '_theomatunit_' + absrowid).val(r.UnitName);
                                $('#abs_' + rowid + '_theomatunitid_' + absrowid).val(r.UnitId);
                                $('#abs_' + rowid + '_theomatqty_' + absrowid).val(sanitizeNumber(r.Qty,3,true));
                                $('#abs_' + rowid + '_theomatrate_' + absrowid).val(sanitizeNumber(r.Rate,2,true));
                                $('#abs_' + rowid + '_theomatamt_' + absrowid).val(sanitizeNumber(r.Amount,2,true));

                                $('#abs_'+rowid+'_DeleteRow_'+absrowid).show();
                            });
                        }
                        absrowid++;
                        $('#abs_' + rowid + '_table > tbody.main').append(trTemplate.replace(/__/g, '_' + rowid)
                            .replace(/_0/g, '_' + absrowid));
                        $('#abs_' + rowid + '_theomatqty_' + absrowid).trigger('change');
                        $('#abs_' + rowid + '_rowid').val(absrowid);
                        bindTheoMatAutocomplete();
                        break;
                    case '33':
                        $mainRow.after($('#recert-agreement-template').html().replace(/__/g, '_' + rowid));
                        $('#mainExpandTr_' + rowid).show();

                        var absrowid = 0;
                        var trTemplate = $('#recert-agreement-tr-template').html();
                        var agrSubTrTemplate = $('#recert-agreement-subtr-template').html();
                        var agrBillSubTrTemplate = $('#recert-agreement-billentry-subtr-template').html();
                        if (typeof o.AddRow != 'undefined') {
                            $.each(o.AddRow, function (j, r) {
                                absrowid++;
                                $('#abs_' + rowid + '_table > tbody.main').append(trTemplate.replace(/__/g, '_' + rowid)
                                    .replace(/_0/g, '_' + absrowid)
                                    .replace(/\{\{recerttype\}\}/g, 'agreement'));

                                $('#abs_'+rowid+'_desc_'+absrowid).val(r.desc).addClass('border-none').prop('readonly',true);
                                $('#abs_'+rowid+'_descid_'+absrowid).val(r.descid);
                                $('#abs_'+rowid+'_unit_'+absrowid).val(r.UnitName);
                                $('#abs_'+rowid+'_qty_'+absrowid).val(sanitizeNumber(r.CurQty,3));
                                $('#abs_'+rowid+'_rate_'+absrowid).val(sanitizeNumber(r.Rate,2,true));
                                $('#abs_'+rowid+'_amount_'+absrowid).val(sanitizeNumber(r.CurAmount,2,true));
                                $('#abs_'+rowid+'_ReCerTransId_'+absrowid).val(r.RecertTransId);
                                $('#abs_'+rowid+'_MainTr_'+absrowid).show();
                                $('#abs_'+rowid+'_DeleteRow_'+absrowid).show();

                                // subrow (iow / wbs)
                                var iowrowid = 0;
                                if (typeof o.AddSubRow != 'undefined') {
                                    $.each(o.AddSubRow, function (k, s) {
                                        if (r.WorkBillTransId != s.WorkBillTransId)
                                            return;

                                        iowrowid++;
                                        $('#abs_' + rowid + '_table_' + absrowid + ' > tbody.main').append(agrSubTrTemplate.replace(/_1/g, '_' + iowrowid)
                                                .replace(/_0/g, '_' + absrowid)
                                                .replace(/__/g, '_' + rowid)
                                                .replace(/\{\{agtno\}\}/g, s.RefSerialNo)
                                                .replace(/\{\{spec\}\}/g, s.Specification)
                                                .replace(/\{\{wbs\}\}/g, s.WBSName)
                                                .replace(/\{\{unit\}\}/g, s.UnitName)
                                        );
                                        $('#abs_' + rowid + '_act_' + absrowid + '_iowid_' + iowrowid).val(s.ProjectIOWId);
                                        $('#abs_' + rowid + '_act_' + absrowid + '_wbsid_' + iowrowid).val(s.WBSId);

                                        if(typeof s.WorkBillTransId != 'undefined') {
                                            $('#abs_' + rowid + '_act_' + absrowid + '_TransId_' + iowrowid).val(s.TransId);
                                            $('#abs_' + rowid + '_act_' + absrowid + '_qty_' + iowrowid).val(sanitizeNumber(s.Qty,3));
                                        }

                                        // bills
                                        var recertrowid = 0;
                                        $.each(o.Bills, function (l,b) {
                                            if(b.WorkBillTransId != s.WorkBillTransId)
                                                return;

                                            recertrowid++;
                                            $('#abs_'+rowid+'_certtable_'+absrowid+' > tbody.main').append(agrBillSubTrTemplate.replace(/_9/g, '_'+recertrowid)
                                                    .replace(/_1/g, '_'+iowrowid)
                                                    .replace(/_0/g, '_'+absrowid)
                                                    .replace(/__/g, '_'+rowid)
                                                    .replace(/\{\{billdate\}\}/g, b.BillDate)
                                                    .replace(/\{\{billno\}\}/g, b.BillNo)
                                                    .replace(/\{\{qty\}\}/g, sanitizeNumber(parseFloatVal(b.Qty),3))
                                                    .replace(/\{\{adjqty\}\}/g, sanitizeNumber((parseFloatVal(b.AdjQty) - parseFloatVal(b.CerQty)),3))
                                                    .replace(/\{\{balqty\}\}/g, sanitizeNumber((parseFloatVal(b.Qty)- (parseFloatVal(b.AdjQty) - parseFloatVal(b.CerQty)) ),3))
                                            );
                                            $('#abs_'+rowid+'_act_'+absrowid+'_recert_' + iowrowid+ '_billiowtransid_'+recertrowid).val(b.WorkBillIOWTransId);
                                            $('#abs_'+rowid+'_act_'+absrowid+'_recert_' + iowrowid+ '_billwbstransid_'+recertrowid).val(b.WorkBillWBSTransId);
                                            $('#abs_'+rowid+'_act_'+absrowid+'_recert_' + iowrowid+ '_billtransid_'+recertrowid).val(b.WorkBillTransId);
                                            $('#abs_'+rowid+'_act_'+absrowid+'_recert_' + iowrowid+ '_qty_'+recertrowid).val(sanitizeNumber(b.CerQty,3)).trigger('change');
                                        });
                                        $('#abs_' + rowid + '_act_' + absrowid + '_recertrowid').val(recertrowid);
                                    });
                                }
                            });
                        }
                        absrowid++;
                        $('#abs_' + rowid + '_table > tbody.main').append(trTemplate.replace(/__/g, '_' + rowid)
                            .replace(/_0/g, '_' + absrowid)
                            .replace(/\{\{recerttype\}\}/g, 'agreement'));
                        $('#abs_' + rowid + '_rowid').val(absrowid);
                        bindRecertificationAutocomplete();
                        break;
                    case '34':
                        $mainRow.after($('#recert-agreement-template').html().replace(/__/g, '_' + rowid));
                        $('#mainExpandTr_' + rowid).show();

                        var absrowid = 0;
                        var trTemplate = $('#recert-agreement-tr-template').html();
                        var agrSubTrTemplate = $('#recert-agreement-subtr-template').html();
                        var agrBillSubTrTemplate = $('#recert-agreement-billentry-subtr-template').html();
                        if (typeof o.AddRow != 'undefined') {
                            $.each(o.AddRow, function (j, r) {
                                absrowid++;
                                $('#abs_' + rowid + '_table > tbody.main').append(trTemplate.replace(/__/g, '_' + rowid)
                                    .replace(/_0/g, '_' + absrowid)
                                    .replace(/\{\{recerttype\}\}/g, 'non-agreement'));
                                $('#abs_'+rowid+'_desc_'+absrowid).val(r.desc).addClass('border-none').prop('readonly',true);
                                $('#abs_'+rowid+'_descid_'+absrowid).val(r.descid);
                                $('#abs_'+rowid+'_unit_'+absrowid).val(r.UnitName);
                                $('#abs_'+rowid+'_qty_'+absrowid).val(sanitizeNumber(r.CurQty,3));
                                $('#abs_'+rowid+'_rate_'+absrowid).val(sanitizeNumber(r.Rate,2,true));
                                $('#abs_'+rowid+'_amount_'+absrowid).val(sanitizeNumber(r.CurAmount,2,true));
                                $('#abs_'+rowid+'_ReCerTransId_'+absrowid).val(r.RecertTransId);
                                $('#abs_'+rowid+'_MainTr_'+absrowid).show();
                                $('#abs_'+rowid+'_DeleteRow_'+absrowid).show();

                                // subrow (iow / wbs)
                                var iowrowid = 0;
                                if (typeof o.AddSubRow != 'undefined') {
                                    $.each(o.AddSubRow, function (k, s) {
                                        if (r.WorkBillTransId != s.WorkBillTransId)
                                            return;

                                        iowrowid++;
                                        $('#abs_' + rowid + '_table_' + absrowid + ' > tbody.main').append(agrSubTrTemplate.replace(/_1/g, '_' + iowrowid)
                                                .replace(/_0/g, '_' + absrowid)
                                                .replace(/__/g, '_' + rowid)
                                                .replace(/\{\{agtno\}\}/g, s.RefSerialNo)
                                                .replace(/\{\{spec\}\}/g, s.Specification)
                                                .replace(/\{\{wbs\}\}/g, s.WBSName)
                                                .replace(/\{\{unit\}\}/g, s.UnitName)
                                        );
                                        $('#abs_' + rowid + '_act_' + absrowid + '_iowid_' + iowrowid).val(s.ProjectIOWId);
                                        $('#abs_' + rowid + '_act_' + absrowid + '_wbsid_' + iowrowid).val(s.WBSId);

                                        if(typeof s.WorkBillTransId != 'undefined') {
                                            $('#abs_' + rowid + '_act_' + absrowid + '_TransId_' + iowrowid).val(s.TransId);
                                            $('#abs_' + rowid + '_act_' + absrowid + '_qty_' + iowrowid).val(sanitizeNumber(s.Qty,3));
                                        }

                                        // bills
                                        var recertrowid = 0;
                                        $.each(o.Bills, function (l,b) {
                                            if(b.WorkBillTransId != s.WorkBillTransId)
                                                return;

                                            recertrowid++;
                                            $('#abs_'+rowid+'_certtable_'+absrowid+' > tbody.main').append(agrBillSubTrTemplate.replace(/_9/g, '_'+recertrowid)
                                                    .replace(/_1/g, '_'+iowrowid)
                                                    .replace(/_0/g, '_'+absrowid)
                                                    .replace(/__/g, '_'+rowid)
                                                    .replace(/\{\{billdate\}\}/g, b.BillDate)
                                                    .replace(/\{\{billno\}\}/g, b.BillNo)
                                                    .replace(/\{\{qty\}\}/g, sanitizeNumber(parseFloatVal(b.Qty),3))
                                                    .replace(/\{\{adjqty\}\}/g, sanitizeNumber((parseFloatVal(b.AdjQty) - parseFloatVal(b.CerQty)),3))
                                                    .replace(/\{\{balqty\}\}/g, sanitizeNumber((parseFloatVal(b.Qty)- (parseFloatVal(b.AdjQty) - parseFloatVal(b.CerQty)) ),3))
                                            );
                                            $('#abs_'+rowid+'_act_'+absrowid+'_recert_' + iowrowid+ '_billiowtransid_'+recertrowid).val(b.WorkBillIOWTransId);
                                            $('#abs_'+rowid+'_act_'+absrowid+'_recert_' + iowrowid+ '_billwbstransid_'+recertrowid).val(b.WorkBillWBSTransId);
                                            $('#abs_'+rowid+'_act_'+absrowid+'_recert_' + iowrowid+ '_billtransid_'+recertrowid).val(b.WorkBillTransId);
                                            $('#abs_'+rowid+'_act_'+absrowid+'_recert_' + iowrowid+ '_qty_'+recertrowid).val(sanitizeNumber(b.CerQty,3)).trigger('change');
                                        });
                                        $('#abs_' + rowid + '_act_' + absrowid + '_recertrowid').val(recertrowid);
                                    });
                                }
                            });
                        }
                        absrowid++;
                        $('#abs_' + rowid + '_table > tbody.main').append(trTemplate.replace(/__/g, '_' + rowid)
                            .replace(/_0/g, '_' + absrowid)
                            .replace(/\{\{recerttype\}\}/g, 'non-agreement'));
                        $('#abs_' + rowid + '_rowid').val(absrowid);
                        bindRecertificationAutocomplete();
                        break;
                }
            }
            $('#BillFormatTransId_' + rowid).val(o.BillFormatTransId);
            if(typeof o.WorkBillFormatTransId != 'undefined') {
                $('#WorkBillFormatTransId_' + rowid).val(o.WorkBillFormatTransId);
                $('#PrevAmount_'+rowid).val(sanitizeNumber(o.PrevAmount,2,true));
                $('#CumAmount_'+rowid).val(sanitizeNumber( ( parseFloatVal(o.Amount) + parseFloatVal(o.PrevAmount) ) ,2,true));
                $('#CurAmount_'+rowid).val(sanitizeNumber(o.Amount,2,true));
            }

            // Sign icon
            if(o.Sign == '-') {
                $('#SignIcon_'+rowid).addClass('fa-minus-circle').parent('label').addClass('pl-mi-ic');
            } else if(o.Sign == '+') {
                $('#SignIcon_'+rowid).addClass('fa-plus-circle').parent('label').addClass('mi-pl-ic');
            }
        });
        $rowid.val(rowid);
        //calcTotal();

        $('.content_wrapper').on('click','.mainTr',function (e) {
            e.preventDefault();
            if (!$(this).closest("tr").next(".subTr").is(":visible")) {
                $(this).closest("tr").next(".subTr").show();
                $(this).closest("tr").next(".subTr").find(".subDiv").slideDown("slow");
                $(this).find("i").addClass("tform");
            }
            else {
                $(this).closest("tr").next(".subTr").find(".subDiv").slideUp("slow");
                $(this).closest("tr").next(".subTr").slideUp("slow");
                $(this).find("i").removeClass("tform");
            }
        });

        // full/part rate
        $('.radio-partfullrate').on('change', function () {
            var type = $(this).val();
            if(type == 'F') {
                //$('#input-fullrate-value').prop('readonly', false);
                $('#input-partrate-value').prop('readonly', true);
                $('#input-partrate-per').prop('readonly', true);
            } else {
                $('#input-fullrate-value').prop('readonly', true);
                $('#input-partrate-value').prop('readonly', false);
                $('#input-partrate-per').prop('readonly', false);
            }
        });

        $('#input-partrate-value,#input-partrate-per').on('change', function () {
            var $rate = $('#input-fullrate-value'),
                $per = $('#input-partrate-per'),
                $part = $('#input-partrate-value'),
                rate = parseFloatVal($rate.val()),
                prate = parseFloatVal($part.val()),
                per = parseFloatVal($per.val()),
                actualrate = parseFloatVal($('#RateModal').attr('data-rate'));

            if(per > 100) {
                showError($per, 'Exceeds 100%');
                return false;
            }
            removeError($per);
            if($(this)[0].id == 'input-partrate-value') {
                per = Math.abs(( (prate - actualrate) / actualrate ) * 100);
                $per.val(sanitizeNumber( (100- per), 2, true));
            } else {
                rate = rate * (per / 100);
                $part.val(sanitizeNumber(rate, 2, true));
            }
        });
    });

    function calcTurnKey(x) {
        var idx = $(x)[0].id.split('_'),
            key = idx[1],
            rowid = idx[3];

        $('#abs_'+key+'_amount_'+rowid).val(sanitizeNumber(parseFloatVal($('#abs_'+key+'_rate_'+rowid).val()) * parseFloatVal($('#abs_'+key+'_area_'+rowid).val()),2,true));

        // calc total
        var woAmtTotal = 0,
            cumAmtTotal = 0,
            prevAmtTotal = 0,
            curAmtTotal = 0;
        $.each($('input[id^=abs_'+key+'_amount_]'), function () {
            var idx = $(this)[0].id.split('_'),
                key = idx[1],
                rowid = idx[3];
            woAmtTotal += parseFloatVal($('#abs_'+key+'_woamount_'+rowid).val());
            cumAmtTotal += parseFloatVal($('#abs_'+key+'_cumamount_'+rowid).val());
            prevAmtTotal += parseFloatVal($('#abs_'+key+'_prevamount_'+rowid).val());
            curAmtTotal += parseFloatVal($('#abs_'+key+'_amount_'+rowid).val());
        });
        $('#abs_'+key+'_woAmtTotal').val(sanitizeNumber(woAmtTotal,2,true));
        $('#abs_'+key+'_cumAmtTotal').val(sanitizeNumber(cumAmtTotal,2,true));
        $('#abs_'+key+'_prevAmtTotal').val(sanitizeNumber(prevAmtTotal,2,true));
        $('#abs_'+key+'_curAmtTotal').val(sanitizeNumber(curAmtTotal,2,true));

        calcCurAmt(rowid);
    }

    function bindRecertificationAutocomplete() {
        $('.recert-agree[data-type="agreement"]').autocomplete({
            lookup: tmp_recert_agreement,
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            }, onSelect: function (suggestion) {
                if (suggestion) {
                    var $this = $(this);
                    var ids = $this[0].id.split('_');
                    var rowid = ids[1];
                    var id = ids[3];
                    $this.prop('readonly', true).addClass('border-none');
                    $('#abs_'+rowid+'_transid_'+id).val(suggestion.data);
                    $('#abs_'+rowid+'_unit_'+id).val(suggestion.UnitName);
                    $('#abs_'+rowid+'_iowid_'+id).val(suggestion.IOWId);
                    $('#abs_'+rowid+'_resourceid_'+id).val(suggestion.ResourceId);
                    $('#abs_'+rowid+'_rate_'+id).val(sanitizeNumber(suggestion.Rate,2,true));

                    addNewRecertificationRow($this);
                    $('#abs_'+rowid+'_MainTr_'+id).show();
                    $('#abs_'+rowid+'_DeleteRow_'+id).show();
                    $('.loading_area').show();
                    var transIOWOrWBSId = suggestion.TransIOWId;
                    var resType = 'Resource';
                    var formatId = 1;

                    if (typeof suggestion.IOWId != 'undefined' && suggestion.IOWId != 0) {
                        transIOWOrWBSId = suggestion.TransWBSId;
                        resType = 'IOW';
                    }
                    if($this.attr('data-type') == 'non-agreement') {
                        formatId = 2;
                    }

                    $.ajax({
                        url: getBaseURL() + 'wpm/workbill/entry',
                        type: "post",
                        data: {'TransId': suggestion.data,'TransIOWOrWBSId': transIOWOrWBSId, 'Type': 'getDPETransDetails', 'ResType': resType, 'FormatId': formatId
                            , 'CostCentreId': $('#CostCentreId').val(), 'WORegisterId': $('#WORegisterId').val(),'VendorId': $('#VendorId').val()},
                        dataType: "json",
                        success: function (data, textStatus, jqXHR) {
                            var agrSubTrTemplate = $('#recert-agreement-subtr-template').html();
                            var agrBillSubTrTemplate = $('#recert-agreement-billentry-subtr-template').html();
                            // subrow (iow / wbs)
                            var iowrowid = 0;
                            if(typeof data.iow != 'undefined' && data.iow.length != 0) {
                                $.each(data.iow, function (k, s) {
                                    iowrowid++;
                                    $('#abs_'+rowid+'_table_'+id+' > tbody.main').append(agrSubTrTemplate.replace(/_1/g, '_'+iowrowid)
                                            .replace(/_0/g, '_'+id)
                                            .replace(/__/g, '_'+rowid)
                                            .replace(/\{\{agtno\}\}/g, s.RefSerialNo)
                                            .replace(/\{\{spec\}\}/g, s.Specification)
                                            .replace(/\{\{wbs\}\}/g, s.WBSName)
                                            .replace(/\{\{unit\}\}/g, s.UnitName)
                                    );
                                    $('#abs_'+rowid+'_act_'+id+'_iowid_' + iowrowid).val(s.ProjectIOWId);
                                    $('#abs_'+rowid+'_act_'+id+'_wbsid_' + iowrowid).val(s.WBSId);

                                    // bills
                                    var recertrowid = 0;
                                    $.each(data.bills, function (l,b) {
                                        if(b.IOWId != s.ProjectIOWId)
                                            return;

                                        recertrowid++;
                                        $('#abs_'+rowid+'_certtable_'+id+' > tbody.main').append(agrBillSubTrTemplate.replace(/_9/g, '_'+recertrowid)
                                                .replace(/_1/g, '_'+iowrowid)
                                                .replace(/_0/g, '_'+id)
                                                .replace(/__/g, '_'+rowid)
                                                .replace(/\{\{billdate\}\}/g, b.BillDate)
                                                .replace(/\{\{billno\}\}/g, b.BillNo)
                                                .replace(/\{\{qty\}\}/g, sanitizeNumber(parseFloatVal(b.Qty),3))
                                                .replace(/\{\{adjqty\}\}/g, sanitizeNumber(parseFloatVal(b.AdjQty),3))
                                                .replace(/\{\{balqty\}\}/g, sanitizeNumber((parseFloatVal(b.Qty)-parseFloatVal(b.AdjQty)),3))
                                        );
                                        $('#abs_'+rowid+'_act_'+id+'_recert_' + iowrowid+ '_billiowtransid_'+recertrowid).val(b.WorkBillIOWTransId);
                                        $('#abs_'+rowid+'_act_'+id+'_recert_' + iowrowid+ '_billwbstransid_'+recertrowid).val(b.WorkBillWBSTransId);
                                        $('#abs_'+rowid+'_act_'+id+'_recert_' + iowrowid+ '_billtransid_'+recertrowid).val(b.WorkBillTransId);
                                    });
                                    $('#abs_' + rowid + '_act_' + id + '_recertrowid').val(recertrowid);
                                });
                            }
                            $('#abs_' + rowid + '_act_' + id + '_rowid').val(iowrowid);
                            $('.loading_area').hide();
                        }, error: function() {
                            $('.loading_area').hide();
                        }
                    });
                }
            }, onSearchStart: function (suggestion) {
                var ids = $(this)[0].id.split('_');
                var rowid = ids[1];
                var id = ids[3];
                $('#abs_'+rowid+'_transid_'+id).val(0);
                $('#abs_'+rowid+'_unit_'+id).val('');
                $('#abs_'+rowid+'_qty_'+id).val('');
                $('#abs_'+rowid+'_rate_'+id).val('');
                $('#abs_'+rowid+'_amount_'+id).val('');
            }, onSearchComplete: function (query, suggestions) {
                if(!suggestions.length) {
                    var ids = $(this)[0].id.split('_');
                    var rowid = ids[1];
                    var id = ids[3];
                    $('#abs_'+rowid+'_transid_'+id).val(0);
                    $('#abs_'+rowid+'_unit_'+id).val('');
                    $('#abs_'+rowid+'_qty_'+id).val('');
                    $('#abs_'+rowid+'_rate_'+id).val('');
                    $('#abs_'+rowid+'_amount_'+id).val('');
                }
            }
        });

        $('.recert-agree[data-type="non-agreement"]').autocomplete({
            lookup: tmp_recert_nonagreement,
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            }, onSelect: function (suggestion) {
                if (suggestion) {
                    var $this = $(this);
                    var ids = $this[0].id.split('_');
                    var rowid = ids[1];
                    var id = ids[3];
                    $this.prop('readonly', true).addClass('border-none');
                    $('#abs_'+rowid+'_transid_'+id).val(suggestion.data);
                    $('#abs_'+rowid+'_unit_'+id).val(suggestion.UnitName);
                    $('#abs_'+rowid+'_iowid_'+id).val(suggestion.IOWId);
                    $('#abs_'+rowid+'_resourceid_'+id).val(suggestion.ResourceId);
                    $('#abs_'+rowid+'_rate_'+id).val(sanitizeNumber(suggestion.Rate,2,true));

                    addNewRecertificationRow($this);
                    $('#abs_'+rowid+'_MainTr_'+id).show();
                    $('#abs_'+rowid+'_DeleteRow_'+id).show();
                    $('.loading_area').show();
                    var transIOWOrWBSId = suggestion.TransIOWId;
                    var resType = 'Resource';
                    var formatId = 1;

                    if (typeof suggestion.IOWId != 'undefined' && suggestion.IOWId != 0) {
                        transIOWOrWBSId = suggestion.TransWBSId;
                        resType = 'IOW';
                    }
                    if($this.attr('data-type') == 'non-agreement') {
                        formatId = 2;
                    }

                    $.ajax({
                        url: getBaseURL() + 'wpm/workbill/entry',
                        type: "post",
                        data: {'TransId': suggestion.data,'TransIOWOrWBSId': transIOWOrWBSId, 'Type': 'getDPETransDetails', 'ResType': resType, 'FormatId': formatId
                            , 'CostCentreId': $('#CostCentreId').val(), 'WORegisterId': $('#WORegisterId').val(),'VendorId': $('#VendorId').val()},
                        dataType: "json",
                        success: function (data, textStatus, jqXHR) {
                            var agrSubTrTemplate = $('#recert-agreement-subtr-template').html();
                            var agrBillSubTrTemplate = $('#recert-agreement-billentry-subtr-template').html();
                            // subrow (iow / wbs)
                            var iowrowid = 0;
                            if(typeof data.iow != 'undefined' && data.iow.length != 0) {
                                $.each(data.iow, function (k, s) {
                                    iowrowid++;
                                    $('#abs_'+rowid+'_table_'+id+' > tbody.main').append(agrSubTrTemplate.replace(/_1/g, '_'+iowrowid)
                                            .replace(/_0/g, '_'+id)
                                            .replace(/__/g, '_'+rowid)
                                            .replace(/\{\{agtno\}\}/g, s.RefSerialNo)
                                            .replace(/\{\{spec\}\}/g, s.Specification)
                                            .replace(/\{\{wbs\}\}/g, s.WBSName)
                                            .replace(/\{\{unit\}\}/g, s.UnitName)
                                    );
                                    $('#abs_'+rowid+'_act_'+id+'_iowid_' + iowrowid).val(s.ProjectIOWId);
                                    $('#abs_'+rowid+'_act_'+id+'_wbsid_' + iowrowid).val(s.WBSId);

                                    // bills
                                    var recertrowid = 0;
                                    $.each(data.bills, function (l,b) {
                                        if(b.IOWId != s.ProjectIOWId)
                                            return;

                                        recertrowid++;
                                        $('#abs_'+rowid+'_certtable_'+id+' > tbody.main').append(agrBillSubTrTemplate.replace(/_9/g, '_'+recertrowid)
                                                .replace(/_1/g, '_'+iowrowid)
                                                .replace(/_0/g, '_'+id)
                                                .replace(/__/g, '_'+rowid)
                                                .replace(/\{\{billdate\}\}/g, b.BillDate)
                                                .replace(/\{\{billno\}\}/g, b.BillNo)
                                                .replace(/\{\{qty\}\}/g, sanitizeNumber(parseFloatVal(b.Qty),3))
                                                .replace(/\{\{adjqty\}\}/g, sanitizeNumber(parseFloatVal(b.AdjQty),3))
                                                .replace(/\{\{balqty\}\}/g, sanitizeNumber((parseFloatVal(b.Qty)-parseFloatVal(b.AdjQty)),3))
                                        );
                                        $('#abs_'+rowid+'_act_'+id+'_recert_' + iowrowid+ '_billiowtransid_'+recertrowid).val(b.WorkBillIOWTransId);
                                        $('#abs_'+rowid+'_act_'+id+'_recert_' + iowrowid+ '_billwbstransid_'+recertrowid).val(b.WorkBillWBSTransId);
                                        $('#abs_'+rowid+'_act_'+id+'_recert_' + iowrowid+ '_billtransid_'+recertrowid).val(b.WorkBillTransId);
                                    });
                                    $('#abs_' + rowid + '_act_' + id + '_recertrowid').val(recertrowid);
                                });
                            }
                            $('#abs_' + rowid + '_act_' + id + '_rowid').val(iowrowid);
                            $('.loading_area').hide();
                        }, error: function() {
                            $('.loading_area').hide();
                        }
                    });
                }
            }, onSearchStart: function (suggestion) {
                var ids = $(this)[0].id.split('_');
                var rowid = ids[1];
                var id = ids[3];
                $('#abs_'+rowid+'_transid_'+id).val(0);
                $('#abs_'+rowid+'_unit_'+id).val('');
                $('#abs_'+rowid+'_qty_'+id).val('');
                $('#abs_'+rowid+'_rate_'+id).val('');
                $('#abs_'+rowid+'_amount_'+id).val('');
            }, onSearchComplete: function (query, suggestions) {
                if(!suggestions.length) {
                    var ids = $(this)[0].id.split('_');
                    var rowid = ids[1];
                    var id = ids[3];
                    $('#abs_'+rowid+'_transid_'+id).val(0);
                    $('#abs_'+rowid+'_unit_'+id).val('');
                    $('#abs_'+rowid+'_qty_'+id).val('');
                    $('#abs_'+rowid+'_rate_'+id).val('');
                    $('#abs_'+rowid+'_amount_'+id).val('');
                }
            }
        });
    }

    function calcRecertQty(x) {
        var $x = $(x),
            ids = $x[0].id.split('_'),
            absid = ids[1],
            actid = ids[3],
            recertid = ids[5],
            rowid = ids[7];

        var balQty = parseFloatVal($.trim($('#abs_'+absid+'_act_'+actid+'_recert_'+recertid+'_balqty_'+rowid).html()));
        if(parseFloatVal($x.val()) > balQty) {
            showError($x, 'Qty should not be greater than Bal. Qty!');
            return false;
        }
        removeError($x);

        var qtyTotal = 0;
        //recert total calc
        $.each($('input[id^=abs_'+absid+'_act_'+actid+'_recert_'+recertid+'_qty_]'), function () {
            qtyTotal += parseFloatVal($(this).val());
        });
        $('#abs_'+absid+'_act_'+actid+'_qty_'+recertid).val(sanitizeNumber(qtyTotal,3));

        // iow total calc
        qtyTotal = 0;
        $.each($('input[id^=abs_'+absid+'_act_'+actid+'_qty_]'), function () {
            qtyTotal += parseFloatVal($(this).val());
        });
        $('#abs_'+absid+'_qty_'+actid).val(sanitizeNumber(qtyTotal,3));
        var totalAmt = (qtyTotal * parseFloatVal($('#abs_'+absid+'_rate_'+actid).val()));
        $('#abs_'+absid+'_amount_'+actid).val(sanitizeNumber(totalAmt ,2,true));
        $('#CurAmount_'+absid).val(sanitizeNumber(totalAmt ,2,true)).trigger('change');
    }

    function checkRecertAgreementUsed (x) {
        var $x = $(x);
        var rowid = $x[0].id.split('_')[1];
        var id = $x[0].id.split('_')[3];
        var reskeyid = $('input[id^=abs_'+rowid+'_transid_]');

        if($x.attr('data-type') == 'agreement') {
            tmp_recert_agreement = recert_agreement;
            tmp_recert_agreement = $.grep(recert_agreement, function (element, index) {
                var is_selected = true;
                $.each(reskeyid, function (i, obj) {
                    var $this = $(this),
                        name = $this[0].id;
                    var arrname = name.split('_');
                    var key1 = arrname[3];
                    if (key1 != id) {
                        if (element.data == $this.val()) {
                            is_selected = false;
                            return false;
                        }
                    }
                });
                return is_selected;
            });
        } else {
            tmp_recert_nonagreement = recert_nonagreement;
            tmp_recert_nonagreement = $.grep(recert_nonagreement, function (element, index) {
                var is_selected = true;
                $.each(reskeyid, function (i, obj) {
                    var $this = $(this),
                        name = $this[0].id;
                    var arrname = name.split('_');
                    var key1 = arrname[3];
                    if (key1 != id) {
                        if (element.data == $this.val()) {
                            is_selected = false;
                            return false;
                        }
                    }
                });
                return is_selected;
            });
        }

        bindRecertificationAutocomplete();
    }

    function bindPriceEscAutocomplete() {
        $('.price-esc-mat').autocomplete({
            lookup: tmp_womateriallists,
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            }, onSelect: function (suggestion) {
                if (suggestion) {
                    var $this = $(this);
                    var ids = $this[0].id.split('_');
                    var rowid = ids[1];
                    var id = ids[3];
                    $this.prop('readonly', true).addClass('border-none');
                    $('#abs_'+rowid+'_priceescmatid_'+id).val(suggestion.data);
                    $('#abs_'+rowid+'_priceescunit_'+id).val(suggestion.UnitName);
                    $('#abs_'+rowid+'_priceescunitid_'+id).val(suggestion.UnitId);
                    $('#abs_'+rowid+'_priceescper_'+id).val(sanitizeNumber(suggestion.EscalationPer,2))
                        .attr('data-condition', suggestion.RateCondition);
                    $('#abs_'+rowid+'_priceescactualrate_'+id).val(suggestion.ActualRate);
                    $('#abs_'+rowid+'_priceescbaserate_'+id).val(sanitizeNumber(suggestion.Rate,2,true));

                    addNewPriceEscRow($this);
                }
            }, onSearchStart: function (suggestion) {
                var ids = $(this)[0].id.split('_');
                var rowid = ids[1];
                var id = ids[3];
                $('#abs_'+rowid+'_priceescmatid_'+id).val(0);
                $('#abs_'+rowid+'_priceescunit_'+id).val('');
                $('#abs_'+rowid+'_priceescunitid_'+id).val(0);
                $('#abs_'+rowid+'_priceescper_'+id).val('');
                $('#abs_'+rowid+'_priceescbaserate_'+id).val('');
            }, onSearchComplete: function (query, suggestions) {
                if(!suggestions.length) {
                    var ids = $(this)[0].id.split('_');
                    var rowid = ids[1];
                    var id = ids[3];
                    $('#abs_'+rowid+'_priceescmatid_'+id).val(0);
                    $('#abs_'+rowid+'_priceescunit_'+id).val('');
                    $('#abs_'+rowid+'_priceescunitid_'+id).val(0);
                    $('#abs_'+rowid+'_priceescper_'+id).val('');
                    $('#abs_'+rowid+'_priceescbaserate_'+id).val('');
                }
            }
        });
    }

    function checkPriceEscMaterialUsed(x) {
        var id = $(x)[0].id.split('_')[3];
        var reskeyid = $('input[id*=_priceescmatid_]');
        tmp_womateriallists = womateriallists;
        tmp_womateriallists = $.grep(womateriallists, function (element, index) {
            var is_selected = true;
            $.each(reskeyid, function (i, obj) {
                var $this = $(this),
                    name = $this[0].id;
                var arrname = name.split('_');
                var key1 = arrname[3];
                if (key1 != id) {
                    if (element.data == $this.val()) {
                        is_selected = false;
                        return false;
                    }
                }
            });
            return is_selected;
        });
        bindPriceEscAutocomplete();
    }

    function calcPriceEsc(x) {
        var ids = $(x)[0].id.split('_'),
            rowid = ids[1],
            id = ids[3];

        var qty = parseFloatVal($('#abs_' + rowid+ '_priceescqty_' + id).val());
        var rate = parseFloatVal($('#abs_'+rowid+'_priceescbaserate_' + id).val());

        $('#abs_'+rowid+'_priceescamt_' + id).val(sanitizeNumber( rate * qty ,2,true));

        var dPer = parseFloatVal($('#abs_'+rowid+'_priceescper_' + id).val());
        var sRateCondition = $('#abs_'+rowid+'_priceescper_' + id).attr('data-condition');
        var dORate = parseFloatVal($('#abs_'+rowid+'_priceescactualrate_' + id).val());
        var dbaseRate = rate;
        var dpurRate = parseFloatVal($('#abs_'+rowid+'_priceescamt_' + id).val());
        var dActualRate=0;
        if (dpurRate != dbaseRate && dbaseRate !=0) {
            var divPer = ((dpurRate-dbaseRate)/dbaseRate) *100;
            if (sRateCondition == '>') { if (divPer > dPer) { if (dORate==0) dActualRate=dpurRate-dbaseRate; else dActualRate=dbaseRate-dORate; } }
            if (sRateCondition == '<') { if (divPer < dPer) { if (dORate==0) dActualRate=dbaseRate-dpurRate; else dActualRate=dbaseRate-dORate; } }
        }
        $('#abs_'+rowid+'_priceescrate_'+id).val(sanitizeNumber(dActualRate,2,true));

        // calc total
        var total = 0;
        $.each($('input[id^=abs_'+rowid+'_priceescamt_]'), function (i,o) {
            total += parseFloatVal($(this).val());
        });
        $('#priceesctotal').val(sanitizeNumber(total,2,true));
        $('#CurAmount_'+rowid).val(sanitizeNumber(total,2,true)).trigger('change');

        addNewPriceEscRow(x);
    }

    function addNewPriceEscRow(x) {
        var ids = $(x)[0].id.split('_'),
            rowid = ids[1],
            id = ids[3];

        // add new row
        var $tr = $(x).closest('tr');
        var qty = parseFloatVal($('#abs_' + rowid+ '_priceescqty_' + id).val());
        var matid = $('#abs_'+rowid+'_priceescmatid_' + id).val();
        if ($tr.next('tr').length != 0 || qty == 0 || matid == 0 || matid == '')
            return;

        $('#abs_'+rowid+'_DeleteRow_'+id).show();
        var $rowid = $('#abs_'+rowid+'_rowid');
        var count = parseInt($rowid.val()) + 1;
        $tr.parent('tbody:not(.total)').append($('#price-esc-tr-template').html().replace(/__/g, '_'+rowid).replace(/_0/g, '_'+count));
        $rowid.val(count);
        bindPriceEscAutocomplete();
    }
    function addNewRecertificationRow(x) {
        var $x = $(x),
            ids = $x[0].id.split('_'),
            rowid = ids[1],
            id = ids[3];

        // add new row
        var $tr = $(x).closest('tr');
        var transid = $('#abs_'+rowid+'_transid_' + id).val();
        if ($tr.next('tr:not(.subTr)').length != 0 || transid == 0 || transid == '')
            return;

        var $rowid = $('#abs_'+rowid+'_rowid');
        var count = parseInt($rowid.val()) + 1;
        $tr.parent('tbody:not(.total)').append($('#recert-agreement-tr-template').html()
            .replace(/__/g, '_'+rowid)
            .replace(/\{\{recerttype\}\}/g, $x.attr('data-type')));
        $rowid.val(count);
        bindRecertificationAutocomplete();
    }


    function bindExcessMatAutocomplete() {
        $('.excess-mat').autocomplete({
            lookup: tmp_excessmateriallists,
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            }, onSelect: function (suggestion) {
                if (suggestion) {
                    var $this = $(this);
                    var ids = $this[0].id.split('_');
                    var rowid = ids[1];
                    var id = ids[3];
                    $this.prop('readonly', true).addClass('border-none');
                    $('#abs_'+rowid+'_excessmatid_'+id).val(suggestion.data);
                    $('#abs_'+rowid+'_excessmatunit_'+id).val(suggestion.UnitName);
                    $('#abs_'+rowid+'_excessmatunitid_'+id).val(suggestion.UnitId);
                    $('#abs_'+rowid+'_excessmatrate_'+id).val(sanitizeNumber(suggestion.Rate,2,true));

                    addNewExcessMatRow($this);
                }
            }, onSearchStart: function (suggestion) {
                var ids = $(this)[0].id.split('_');
                var rowid = ids[1];
                var id = ids[3];
                $('#abs_'+rowid+'_excessmatid_'+id).val(0);
                $('#abs_'+rowid+'_excessmatunit_'+id).val('');
                $('#abs_'+rowid+'_excessmatunitid_'+id).val(0);
                $('#abs_'+rowid+'_excessmatrate_'+id).val('');
            }, onSearchComplete: function (query, suggestions) {
                if(!suggestions.length) {
                    var ids = $(this)[0].id.split('_');
                    var rowid = ids[1];
                    var id = ids[3];
                    $('#abs_'+rowid+'_excessmatid_'+id).val(0);
                    $('#abs_'+rowid+'_excessmatunit_'+id).val('');
                    $('#abs_'+rowid+'_excessmatunitid_'+id).val(0);
                    $('#abs_'+rowid+'_excessmatrate_'+id).val('');
                }
            }
        });
    }

    function checkExcessMatMaterialUsed(x) {
        var id = $(x)[0].id.split('_')[3];
        var reskeyid = $('input[id*=_excessmatid_]');
        tmp_excessmateriallists = excessmateriallists;
        tmp_excessmateriallists = $.grep(excessmateriallists, function (element, index) {
            var is_selected = true;
            $.each(reskeyid, function (i, obj) {
                var $this = $(this),
                    name = $this[0].id;
                var arrname = name.split('_');
                var key1 = arrname[3];
                if (key1 != id) {
                    if (element.data == $this.val()) {
                        is_selected = false;
                        return false;
                    }
                }
            });
            return is_selected;
        });
        bindExcessMatAutocomplete();
    }

    function calcExcessMat(x) {
        var ids = $(x)[0].id.split('_'),
            rowid = ids[1],
            id = ids[3];

        var qty = parseFloatVal($('#abs_' + rowid+ '_excessmatqty_' + id).val());
        var rate = parseFloatVal($('#abs_'+rowid+'_excessmatrate_' + id).val());

        $('#abs_'+rowid+'_excessmatamt_' + id).val(sanitizeNumber( rate * qty ,2,true));

        // calc total
        var total = 0;
        $.each($('input[id^=abs_'+rowid+'_excessmatamt_]'), function (i,o) {
            total += parseFloatVal($(this).val());
        });
        $('#excessmattotal').val(sanitizeNumber(total,2,true));
        $('#CurAmount_'+rowid).val(sanitizeNumber(total,2,true)).trigger('change');

        addNewExcessMatRow(x);
    }

    function addNewExcessMatRow(x) {
        var ids = $(x)[0].id.split('_'),
            rowid = ids[1],
            id = ids[3];

        // add new row
        var $tr = $(x).closest('tr');
        var qty = parseFloatVal($('#abs_' + rowid+ '_excessmatqty_' + id).val());
        var matid = $('#abs_'+rowid+'_excessmatid_' + id).val();
        if ($tr.next('tr').length != 0 || qty == 0 || matid == 0 || matid == '')
            return;

        $('#abs_'+rowid+'_DeleteRow_'+id).show();
        var $rowid = $('#abs_'+rowid+'_rowid');
        var count = parseInt($rowid.val()) + 1;
        $tr.parent('tbody:not(.total)').append($('#excess-mat-tr-template').html().replace(/__/g, '_'+rowid).replace(/_0/g, '_'+count));
        $rowid.val(count);
        bindExcessMatAutocomplete();
    }

    function bindTheoMatAutocomplete() {
        $('.theo-mat').autocomplete({
            lookup: tmp_theomateriallists,
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            }, onSelect: function (suggestion) {
                if (suggestion) {
                    var $this = $(this);
                    var ids = $this[0].id.split('_');
                    var rowid = ids[1];
                    var id = ids[3];
                    $this.prop('readonly', true).addClass('border-none');
                    $('#abs_'+rowid+'_theomatid_'+id).val(suggestion.data);
                    $('#abs_'+rowid+'_theomatunit_'+id).val(suggestion.UnitName);
                    $('#abs_'+rowid+'_theomatunitid_'+id).val(suggestion.UnitId);
                    $('#abs_'+rowid+'_theomatrate_'+id).val(sanitizeNumber(suggestion.Rate,2,true));

                    addNewTheoMatRow($this);
                }
            }, onSearchStart: function (suggestion) {
                var ids = $(this)[0].id.split('_');
                var rowid = ids[1];
                var id = ids[3];
                $('#abs_'+rowid+'_theomatid_'+id).val(0);
                $('#abs_'+rowid+'_theomatunit_'+id).val('');
                $('#abs_'+rowid+'_theomatunitid_'+id).val(0);
                $('#abs_'+rowid+'_theomatrate_'+id).val('');
            }, onSearchComplete: function (query, suggestions) {
                if(!suggestions.length) {
                    var ids = $(this)[0].id.split('_');
                    var rowid = ids[1];
                    var id = ids[3];
                    $('#abs_'+rowid+'_theomatid_'+id).val(0);
                    $('#abs_'+rowid+'_theomatunit_'+id).val('');
                    $('#abs_'+rowid+'_theomatunitid_'+id).val(0);
                    $('#abs_'+rowid+'_theomatrate_'+id).val('');
                }
            }
        });
    }

    function checkTheoMatMaterialUsed(x) {
        var id = $(x)[0].id.split('_')[3];
        var reskeyid = $('input[id*=_theomatid_]');
        tmp_theomateriallists = theomateriallists;
        tmp_theomateriallists = $.grep(theomateriallists, function (element, index) {
            var is_selected = true;
            $.each(reskeyid, function (i, obj) {
                var $this = $(this),
                    name = $this[0].id;
                var arrname = name.split('_');
                var key1 = arrname[3];
                if (key1 != id) {
                    if (element.data == $this.val()) {
                        is_selected = false;
                        return false;
                    }
                }
            });
            return is_selected;
        });
        bindTheoMatAutocomplete();
    }

    function calcTheoMat(x) {
        var ids = $(x)[0].id.split('_'),
            rowid = ids[1],
            id = ids[3];

        var qty = parseFloatVal($('#abs_' + rowid+ '_theomatqty_' + id).val());
        var rate = parseFloatVal($('#abs_'+rowid+'_theomatrate_' + id).val());

        $('#abs_'+rowid+'_theomatamt_' + id).val(sanitizeNumber( rate * qty ,2,true));

        // calc total
        var total = 0;
        $.each($('input[id^=abs_'+rowid+'_theomatamt_]'), function (i,o) {
            total += parseFloatVal($(this).val());
        });
        $('#theomattotal').val(sanitizeNumber(total,2,true));
        $('#CurAmount_'+rowid).val(sanitizeNumber(total,2,true)).trigger('change');

        addNewTheoMatRow(x);
    }

    function addNewTheoMatRow(x) {
        var ids = $(x)[0].id.split('_'),
            rowid = ids[1],
            id = ids[3];

        // add new row
        var $tr = $(x).closest('tr');
        var qty = parseFloatVal($('#abs_' + rowid+ '_theomatqty_' + id).val());
        var matid = $('#abs_'+rowid+'_theomatid_' + id).val();
        if ($tr.next('tr').length != 0 || qty == 0 || matid == 0 || matid == '')
            return;

        $('#abs_'+rowid+'_DeleteRow_'+id).show();
        var $rowid = $('#abs_'+rowid+'_rowid');
        var count = parseInt($rowid.val()) + 1;
        $tr.parent('tbody:not(.total)').append($('#theo-mat-tr-template').html().replace(/__/g, '_'+rowid).replace(/_0/g, '_'+count));
        $rowid.val(count);
        bindTheoMatAutocomplete();
    }

    function toggleSign(x) {
        var rowid = $(x)[0].id.split('_')[1];
        var $Sign = $('#Sign_' + rowid);
        var $SignIcon = $('#SignIcon_' + rowid);
        if($.trim($Sign.val()) == '-') {
            $Sign.val('+');
            $SignIcon.removeClass('fa-minus-circle').parent('label').removeClass('pl-mi-ic');
            $SignIcon.addClass('fa-plus-circle').parent('label').addClass('mi-pl-ic');
        } else {
            $Sign.val('-');
            $SignIcon.removeClass('fa-plus-circle').parent('label').removeClass('mi-pl-ic');
            $SignIcon.addClass('fa-minus-circle').parent('label').addClass('pl-mi-ic');
        }
        $('#CurAmount_'+rowid).trigger('change');
    }

    function toggleRateSign(x) {
        var ids = $(x)[0].id.split('_');
        var absid = ids[1];
        var rowid = ids[3];
        var id = ids[5];
        var $Sign = $('#abs_'+absid+'_act_'+rowid+'_sign_' + id);
        var $SignIcon = $('#abs_'+absid+'_act_'+rowid+'_signicon_' + id);
        if($.trim($Sign.val()) == '-') {
            $Sign.val('+');
            $SignIcon.removeClass('fa-minus-circle').parent('label').removeClass('pl-mi-ic');
            $SignIcon.addClass('fa-plus-circle').parent('label').addClass('mi-pl-ic');
        } else {
            $Sign.val('-');
            $SignIcon.removeClass('fa-plus-circle').parent('label').removeClass('mi-pl-ic');
            $SignIcon.addClass('fa-minus-circle').parent('label').addClass('pl-mi-ic');
        }
        $('#abs_'+absid+'_act_'+rowid+'_qty_' + id).trigger('change');
    }

    function formulaParser(Formula, isReturnExp) {
        var sFormula = isNullCheck($.trim(Formula),'string'),
            rows = $('#rowid').val();
        if(sFormula.length == 0)
            return 0;

        for (var j = 1; j <= rows; j++) {
            if($('#RowName_' + j).length != 0) {

                var sFRef = $('#RowName_' + j).html().trim();
                var dFamt = parseFloatVal(isNullCheck($('#CurAmount_' + j).val(), 'number'));
                sFormula = sFormula.replace(new RegExp('\\b('+sFRef+')\\b', 'gi'), dFamt);
            }
        }
        sFormula = sFormula.replace(/R[0-9]+/gi, 0); // replace 0 for R(X) values not found
        sFormula = sFormula.replace(/%/gi, '/100'); // replace % to / 100
        if(typeof isReturnExp != 'undefined' && isReturnExp) {
            return sFormula;
        }

        var fvalue = 0;
        try {
            fvalue = computeEval(sFormula);
        } catch (e) {
        }

        return fvalue;
    }
    function calcTax(x) {
        var rowid = $(x)[0].id.split('_')[1];

        var $expression = $('#abs_' + rowid+ '_tdsexpression');
        removeError($expression);
        var fvalue = 0;
        try {
            fvalue = computeEval(formulaParser($expression.val(), true));
        } catch (e) {
            showError($expression, 'Invalid Expression!');
        }
        $('#abs_'+rowid+'_tdsexpvalue').val(sanitizeNumber( fvalue ,2,true));
        var taxable = parseFloatVal($('#abs_'+rowid+'_taxable').val()),
            tax = parseFloatVal($('#abs_'+rowid+'_tax').val()),
            kkcess = parseFloatVal($('#abs_'+rowid+'_kkcess').val()),
            sbcess = parseFloatVal($('#abs_'+rowid+'_sbcess').val());

        // tds columns
        var cess = parseFloatVal($('#abs_'+rowid+'_cess').val());
        var educess = parseFloatVal($('#abs_'+rowid+'_educess').val());
        var heducess = parseFloatVal($('#abs_'+rowid+'_heducess').val());

        var taxableamt = fvalue * (taxable / 100);
        var taxamt = taxableamt * (tax / 100);
        var kkcessamt = taxableamt * (kkcess / 100);
        var sbcessamt = taxableamt * (sbcess / 100);

        var cessamt = taxableamt * (cess / 100);
        var educessamt = taxableamt * (educess / 100);
        var heducessamt = taxableamt * (heducess / 100);

        var netamt = taxamt + kkcessamt + sbcessamt + cessamt + educessamt + heducessamt;
        var totaltax = tax + kkcess + sbcess + cess + educess + heducess;
        $('#abs_'+rowid+'_tdsper').val(sanitizeNumber( totaltax ,2,true));
        $('#abs_'+rowid+'_tdsamt').val(sanitizeNumber( netamt ,2,true));

        $('#abs_'+rowid+'_nettax').val(sanitizeNumber( totaltax ,2,true));
        $('#abs_'+rowid+'_taxableamt').val(sanitizeNumber(taxableamt,2,true));
        $('#abs_'+rowid+'_taxamt').val(sanitizeNumber(taxamt,2,true));
        $('#abs_'+rowid+'_kkcessamt').val(sanitizeNumber(kkcessamt,2,true));
        $('#abs_'+rowid+'_sbcessamt').val(sanitizeNumber(sbcessamt,2,true));
        $('#CurAmount_'+rowid).val(sanitizeNumber(netamt,2,true)).trigger('change');

        $('#abs_'+rowid+'_netamt').val(sanitizeNumber(netamt,2,true));

        var reversetax = parseFloatVal($('#abs_'+rowid+'_reversetax').val());
        var reversetaxamt = netamt * (reversetax / 100);
        $('#abs_'+rowid+'_reversetaxamt').val(sanitizeNumber(reversetaxamt,2,true));
        var $serviceTaxDed = $('input[id^=FormatTypeId_][value='+22+']');
        if($serviceTaxDed.length != 0) {
            $('#CurAmount_' + $serviceTaxDed[0].id.split('_')[1]).val(sanitizeNumber(reversetaxamt,2,true));
        }

        $('#abs_'+rowid+'_cessamt').val(sanitizeNumber(cessamt,2,true));
        $('#abs_'+rowid+'_educessamt').val(sanitizeNumber(educessamt,2,true));
        $('#abs_'+rowid+'_heducessamt').val(sanitizeNumber(heducessamt,2,true));
    }

    function calcWCT(x) {
        var ids = $(x)[0].id.split('_'),
            rowid = ids[1],
            id = ids[3];

        var $expression = $('#abs_' + rowid+ '_wctexpression_' + id);
        removeError($expression);
        var fvalue = 0;
        try {
            fvalue = computeEval(formulaParser($expression.val(), true));
        } catch (e) {
            showError($expression, 'Invalid Expression!');
        }
        var fper = parseFloatVal($('#abs_'+rowid+'_wctper_' + id).val());
        $('#abs_'+rowid+'_wctexpvalue_' + id).val(sanitizeNumber( fvalue ,2,true));
        $('#abs_'+rowid+'_wctnettax_' + id).val(sanitizeNumber( (fvalue * (fper / 100)) ,2,true));

        // calc total
        var total = 0;
        $.each($('input[id^=abs_'+rowid+'_wctnettax_]'), function (i,o) {
            total += parseFloatVal($(this).val());
        });
        $('#wcttotalnettax').val(sanitizeNumber(total,2,true));
        $('#CurAmount_'+rowid).val(sanitizeNumber(total,2,true)).trigger('change');


        // add new row
        var $tr = $(x).closest('tr');
        if ($tr.next('tr').length != 0 || fvalue == 0 || fper == 0)
            return;

        $('#abs_'+rowid+'_DeleteRow_'+id).show();
        var $rowid = $('#abs_'+rowid+'_rowid');
        var count = parseInt($rowid.val()) + 1;
        $tr.parent('tbody:not(.total)').append($('#wct-tr-template').html().replace(/__/g, '_'+rowid).replace(/_0/g, '_'+count));
        $rowid.val(count);
    }

    function calcVat(x) {
        var ids = $(x)[0].id.split('_'),
            rowid = ids[1],
            id = ids[3];

        var $expression = $('#abs_' + rowid+ '_vatexpression_' + id);
        removeError($expression);
        var fvalue = 0;
        try {
            fvalue = computeEval(formulaParser($expression.val(), true));
        } catch (e) {
            showError($expression, 'Invalid Expression!');
        }
        var fper = parseFloatVal($('#abs_'+rowid+'_vatper_' + id).val());
        $('#abs_'+rowid+'_vatexpvalue_' + id).val(sanitizeNumber( fvalue ,2,true));
        $('#abs_'+rowid+'_vatnettax_' + id).val(sanitizeNumber( (fvalue * (fper / 100)) ,2,true));

        // calc total
        var total = 0;
        $.each($('input[id^=abs_'+rowid+'_vatnettax_]'), function (i,o) {
            total += parseFloatVal($(this).val());
        });
        $('#vattotalnettax').val(sanitizeNumber(total,2,true));
        $('#CurAmount_'+rowid).val(sanitizeNumber(total,2,true)).trigger('change');


        // add new row
        var $tr = $(x).closest('tr');
        if ($tr.next('tr').length != 0 || fvalue == 0 || fper == 0)
            return;

        var $rowid = $('#abs_'+rowid+'_rowid');
        var count = parseInt($rowid.val()) + 1;
        $tr.parent('tbody:not(.total)').append($('#vat-tr-template').html().replace(/__/g, '_'+rowid).replace(/_0/g, '_'+count));
        $rowid.val(count);
    }

    function calcAbs(x, billFormat) {
        var idx = $(x)[0].id.split('_'),
            key = idx[1],
            rowid = idx[3];

        if(parseFloatVal($('#abs_'+key+'_actualrate_'+rowid).val()) >= parseFloatVal($('#abs_'+key+'_rate_'+rowid).val())) {
            $('#abs_' + key + '_amount_' + rowid).val(sanitizeNumber(parseFloatVal($('#abs_' + key + '_rate_' + rowid).val()) * parseFloatVal($('#abs_' + key + '_qty_' + rowid).val()), 2, true));

            if (typeof billFormat != 'undefined' && billFormat == '8') {
                var $qty = $('#abs_' + key + '_qty_' + rowid);
                var availQty = parseFloatVal($('#abs_' + key + '_availqty_' + rowid).val());
                var qty = parseFloatVal($qty.val());
                if (qty > availQty)
                    showError($qty, 'Qty should not exceed ' + availQty + '!');
                else
                    removeError($qty)
            }

            calcCurAmt(key);
        } else {
            $('#abs_'+key+'_rate_'+rowid).val($('#abs_'+key+'_actualrate_'+rowid).val());
            alert('Rate exceeds');
        }
    }

    function calcCurAmt(rowid) {
        var total = 0;
        $.each($('input[id^=abs_'+rowid+'_amount_]'), function (i,o) {
            total += parseFloatVal($(this).val());
        });
        $('#CurAmount_'+rowid).val(sanitizeNumber(total,2,true)).trigger('change');
    }

    function calcAdvRec(x) {
        var idx = $(x)[0].id.split('_'),
            key = idx[1],
            rowid = idx[3];

        var $curamt = $('#abs_'+key+'_advmatcuramt_'+rowid);
        var curamt = parseFloatVal($curamt.val());
        var balamt = parseFloatVal($('#abs_'+key+'_advmatbalamt_'+rowid).html());
        if(curamt > balamt) {
            showError($curamt, 'Current Amount should not exceed Balance Amt!');
        } else {
            removeError($curamt);
        }

        var total = 0;
        $.each($('input[id^=abs_'+key+'_advmatcuramt_'+rowid), function (i,o) {
            total += parseFloatVal($(this).val());
        });
        $('#advmattotalcuramt').val(sanitizeNumber(total,2,true));
        $('#CurAmount_' + key).val(sanitizeNumber(total,2,true)).trigger('change');
    }

    function calcAct(x) {
        var $x = $(x),
            idx = $x[0].id.split('_'),
            absid = idx[1],
            actid = idx[3],
            rowid = idx[5];

        var chkQty = 0;
        var thisQty = parseFloat($('#abs_'+absid+'_act_'+actid+'_qty_'+rowid).val());
        var woeQty = parseFloat($('#abs_'+absid+'_act_'+actid+'_workorderqty_'+rowid).html());
        var wpeQty = parseFloat($('#abs_'+absid+'_act_'+actid+'_wpeqty_'+rowid).html());
        var totbillQty = parseFloat($('#abs_'+absid+'_act_'+actid+'_totbilledqty_'+rowid).html());

        if(wpeQty != 0)
            chkQty = (wpeQty - totbillQty);
        else
            chkQty = (woeQty - totbillQty);

        //if(woeQty >= thisQty || wpeQty >= thisQty) {
        if(chkQty >= thisQty) {
            $('#abs_'+absid+'_act_'+actid+'_qty_'+rowid).val(sanitizeNumber(thisQty, 3));

            var totalQty=0;
            $.each($('input[id^=abs_'+absid+'_act_'+actid+'_qty_]'), function(i,o) {
                var $this = $(this);
                totalQty += parseFloatVal($this.val());
                removeError($this);
            });

            $('#abs_'+absid+'_qty_'+actid).val(sanitizeNumber(totalQty,3)).trigger('change');
        } else {
            $('#abs_'+absid+'_act_'+actid+'_qty_'+rowid).val('');
            alert('Qty exceeds');
            return false;
        }

        var thisrate = parseFloatVal($('#abs_'+absid+'_act_'+actid+'_rate_'+rowid).val());
        var actrate = parseFloatVal($('#abs_'+absid+'_rate_'+actid).val());
        if(actrate >= thisrate) {
            $('#abs_'+absid+'_act_'+actid+'_rate_'+rowid).removeClass('red_bdr');
            $('#abs_'+absid+'_act_'+actid+'_amount_'+rowid).val(sanitizeNumber(thisQty * thisrate));

            var subtotal = 0;
            $.each($('input[id^=abs_'+absid+'_act_'+actid+'_amount_]'), function (i,o) {
                subtotal += parseFloatVal($(this).val());
            });
            $('#abs_'+absid+'_amount_'+actid).val(sanitizeNumber(subtotal,2,true));
            calcCurAmt(absid);
        } else {
            $('#abs_'+absid+'_act_'+actid+'_rate_'+rowid).addClass('red_bdr');
            $('#abs_'+absid+'_act_'+actid+'_amount_'+rowid).val(0);
            alert('Rate exceeds');
        }

        /*var totalQty=0;
        $.each($('input[id^=abs_'+absid+'_act_'+actid+'_qty_]'), function(i,o) {
            var $this = $(this);
            totalQty += parseFloatVal($this.val());
            removeError($this);
        });

        $('#abs_'+absid+'_act_'+actid+'_totalbillqty').val(sanitizeNumber(totalQty,3));
        $('#abs_'+absid+'_qty_'+actid).val(sanitizeNumber(totalQty,3)).trigger('change');

        var estBillQty = parseFloatVal($('#abs_'+absid+'_act_'+actid+'_estqty').val());
        var woBillQty = parseFloatVal($('#abs_'+absid+'_act_'+actid+'_woqty').val());
        if(woBillQty != 0 && totalQty > woBillQty)
            showError($x,'Qty should not exceed than Workorder Qty!');
        else if(estBillQty != 0 && totalQty > estBillQty)
            showError($x,'Qty should not exceed than Estimate Qty!');*/
    }

    function calcTotal() {
        var formats = ['22'];
        var prevtotal = 0,
            total = 0;
        $.each($('input[id^=CurAmount_]'), function (i,o) {
            var $this = $(this);
            var rowid = $this[0].id.split('_')[1];

            // check for formula
            var Formula = $.trim($('#Formula_'+rowid).val());
            if(Formula.length != 0 && $.inArray(o.BillFormatId, formats) == -1) {
                $this.val(sanitizeNumber(formulaParser(Formula), 2,true));
            }

            var amt = parseFloatVal($this.val());
            // calculate sign wise
            var sign = $.trim($('#Sign_'+rowid).val());
            if(sign == '-')
                total -= amt;
            else if(sign == '+')
                total += amt;

            $('#CumAmount_'+rowid).val(sanitizeNumber( (parseFloatVal($('#PrevAmount_'+rowid).val()) + amt),2,true));
            prevtotal += parseFloatVal($('#PrevAmount_'+rowid).val());
        });
        $('#totalCumAmount').val(sanitizeNumber( (prevtotal + total),2,true));
        $('#totalPrevAmount').val(sanitizeNumber(prevtotal,2,true));
        $('#totalCurAmount').val(sanitizeNumber(total,2,true));
    }

    function deleteRow(x,e,deleteFlag) {
        e.preventDefault();
        var $x = $(x),
            keys = $x[0].id.split('_'),
            key = keys[1],
            rowid = keys[3];

        if (!confirm('Do you want to Delete?'))
            return false;

        var transIdField = 'WorkBillTransId';
        switch($('#FormatTypeId_'+key).val()) {
            case '1':
            case '2':
            case '35':
                transIdField = 'WorkBillTransId';
                break;
            case '3':
                transIdField = 'WorkBillMaterialRecoveryId';
                break;
            case '8':
                transIdField = 'WorkBillLSTransId';
                break;
            case '19':
                transIdField = 'WorkBillWCTTransId';
                break;
            case '39':
                transIdField = 'WorkBillPriceEscTransId';
                break;
            case '38':
                transIdField = 'WorkBillExcessMaterialTransId';
                break;
            case '29':
                transIdField = 'WorkBillTheorecticalMaterialTransId';
                break;
            case '33':
            case '34':
                transIdField = 'ReCerTransId';
                break;
        }
        var $transId = $('#abs_'+key+'_'+transIdField+'_'+rowid);
        if(typeof $transId != 'undefined' && $transId.val() != 0 && $transId.val() != '') {
            var $ids = $('#abs_'+key+'_deleteids'),
                ids = $ids.val();
            if(ids.length != 0)
                ids = ids + ',';

            $ids.val(ids + $transId.val());
        }

        var $tr = $x.closest('tr');
        $tr.next('.subTr').remove();
        $tr.remove();

        $tr.find('input[id*=qty]').trigger('change');
        if($('#FormatTypeId_'+key).val() == '8') {
            var netTotal = 0;
            $.each($('#input[id^=abs_'+key+'_wbsNetAmount_]'), function () {
                netTotal  += parseFloatVal($(this).val());
            });
            $('#CurAmount_'+key).val(sanitizeNumber(netTotal,2,true)).trigger('change');
        }

        return false;
    }

    function showLsModal(x) {
        $('#lsListModal').attr('data-rowid', $(x)[0].id.split('_')[1]).modal('show');
    }

    function showRateModal(x, isCheckPartType) {
        var ids = $(x)[0].id.split('_');
        if(typeof isCheckPartType != 'undefined' && isCheckPartType && $('#abs_'+ids[1]+'_ratetype_'+ids[3]).val() == 'F') {
            return;
        }

        var rate = $('#abs_'+ids[1]+'_actualrate_'+ids[3]).val();
        $('#RateModal').attr('data-absid', ids[1]).attr('data-rowid', ids[3]).attr('data-rate',rate).modal('show');

        $('#input-fullrate-value').val(sanitizeNumber(rate,2,true));

        if($('#abs_'+ids[1]+'_ratetype_'+ids[3]).val() == 'F') {
            $('#input-partrate-value').val(sanitizeNumber(rate,2,true));
            $('#input-partrate-per').val(100);
            $('#radio-fullrate').prop('checked',true).trigger('change');
        } else {
            $('#input-partrate-per').val(sanitizeNumber($('#abs_'+ids[1]+'_partrateper_'+ids[3]).val(),2));
            $('#input-partrate-value').val(sanitizeNumber($('#abs_'+ids[1]+'_partrate_'+ids[3]).val(),2,true));
            $('#radio-partrate').prop('checked',true).trigger('change');
        }
    }

    function ApplyRate() {
        var $rateModal = $('#RateModal');
        var absid = $rateModal.attr('data-absid');
        var rowid = $rateModal.attr('data-rowid');
        var type = $('.radio-partfullrate:checked').val();

        var fullrate = parseFloatVal($('#input-fullrate-value').val()),
            partrate = parseFloatVal($('#input-partrate-value').val()),
            per = parseFloatVal($('#input-partrate-per').val());

        var actualRate = parseFloatVal($rateModal.attr('data-rate'));
        removeError($('#input-partrate-value'));
        if(per > 100) {
            showError($per, 'Exceeds 100%');
            return false;
        }
        removeError($('#input-partrate-per'));

        if(type == 'P' && partrate > actualRate) {
            showError($('#input-partrate-value'), 'Part Rate should be less than Full Rate');
            return;
        } else if (type == 'P' && partrate == actualRate) {
            $('#abs_' + absid + '_ratetype_' + rowid).val('F');
            $('#abs_' + absid + '_rate_' + rowid).val(sanitizeNumber(fullrate,2,true));
            $('#abs_' + absid + '_partrate_' + rowid).val(0);
            $('#abs_' + absid + '_partrateper_' + rowid).val(0);
            $rateModal.modal('hide');
            return;
        }

        var rate = 0,
            rateper = 0;
        if(type == 'F') {
            rate = fullrate;
            $('#abs_' + absid + '_rate_' + rowid).prop('readonly', false);
        } else {
            rate = partrate;
            rateper = parseFloatVal($('#input-partrate-per').val());
            $('#abs_' + absid + '_rate_' + rowid).prop('readonly', true);
        }

        $('#abs_' + absid + '_ratetype_' + rowid).val(type);
        $('#abs_' + absid + '_rate_' + rowid).val(sanitizeNumber(rate,2,true)).trigger('change');
        $('#abs_' + absid + '_partrate_' + rowid).val(rate);
        $('#abs_' + absid + '_partrateper_' + rowid).val(rateper);
        $rateModal.modal('hide');
    }

    function lsDetailsBind() {
        var rows = $jqxLSList.jqxGrid('getrows');
        var $lsListModal = $('#lsListModal');
        var rowid = $lsListModal.attr('data-rowid');
        var ids = '';
        $.each(rows, function (i,o) {
            if(!o.Include)
                return;

            ids += o.LSRegisterId+',';
        });
        $('.loading_area').show();
        if(ids.length != 0) {
            ids = ids.substr(0, (ids.length - 1));
            $.ajax({
                url:getBaseURL()+'wpm/workbill/entry',
                type:"post",
                data:{'LSRegisterIds': ids, 'Type': 'getLSDetails'},
                dataType:"json",
                success:function(data, textStatus, jqXHR){
                    $('#abs_'+rowid+'_table > tbody.main').html('');
                    $('#abs_'+rowid+'_rowid').val(0);
                    $('#abs_'+rowid+'_deleteids').val('');
                    if(jqXHR.status == 200) {
                        // add rows
                        var absrowid = 0;
                        if(typeof data.wbs != 'undefined' && data.wbs != 0) {
                            var trTemplate = $('#labour-tr-template').html();
                            var netTotal = 0;
                            var subTrTemplate = $('#labour-type-tr-template').html();
                            $.each(data.wbs, function (j, r) {
                                absrowid++;
                                $('#abs_'+rowid+'_table > tbody.main' ).append(trTemplate.replace(/_0/g, '_'+absrowid)
                                        .replace(/__/g, '_'+rowid)
                                );
                                $('#abs_'+rowid+'_lsRegisterId_'+absrowid).val(r.LSRegisterId);
                                $('#abs_'+rowid+'_lsWbsTransId_'+absrowid).val(r.LSWBSTransId);
                                $('#abs_'+rowid+'_typeId_'+absrowid).val(r.TypeId);
                                $('#abs_'+rowid+'_wbsId_'+absrowid).val(r.WBSId);
                                $('#abs_'+rowid+'_wbsName_'+absrowid).val(r.WBSName);
                                $('#abs_'+rowid+'_wbsQty_'+absrowid).val(sanitizeNumber(r.Qty,3));
                                $('#abs_'+rowid+'_wbsAmount_'+absrowid).val(sanitizeNumber(r.Amount,2,true));
                                $('#abs_'+rowid+'_wbsOtHrs_'+absrowid).val(r.OTHrs);
                                $('#abs_'+rowid+'_wbsOtAmount_'+absrowid).val(sanitizeNumber(r.OTAmount,2,true));
                                $('#abs_'+rowid+'_wbsNetAmount_'+absrowid).val(sanitizeNumber(r.NetAmount,2,true));
                                netTotal += r.NetAmount;

                                // subrow (labour types)
                                var iowrowid = 0;
                                if(typeof data.lstype != 'undefined') {
                                    $.each(data.lstype, function (k, s) {
                                        if(r.DPETransId != s.DPETransId)
                                            return;

                                        iowrowid++;
                                        $('#abs_'+rowid+'_table_'+absrowid+' > tbody.main').append(subTrTemplate.replace(/_1/g, '_'+iowrowid)
                                                .replace(/_0/g, '_'+absrowid)
                                                .replace(/__/g, '_'+rowid)
                                                .replace(/\{\{name\}\}/g, s.ResourceName)
                                        );
                                        $('#abs_'+rowid+'_type_'+absrowid+'_labid_' + iowrowid).val(s.ResourceId);
                                        $('#abs_'+rowid+'_type_'+absrowid+'_labname_' + iowrowid).val(s.ResourceName);
                                        $('#abs_'+rowid+'_type_'+absrowid+'_labqty_' + iowrowid).val(sanitizeNumber(s.Qty,3));
                                        $('#abs_'+rowid+'_type_'+absrowid+'_labrate_' + iowrowid).val(sanitizeNumber(s.Rate,2,true));
                                        $('#abs_'+rowid+'_type_'+absrowid+'_labamt_' + iowrowid).val(sanitizeNumber(s.Amount,2,true));
                                        $('#abs_'+rowid+'_type_'+absrowid+'_labothrs_' + iowrowid).val(s.OTHrs);
                                        $('#abs_'+rowid+'_type_'+absrowid+'_labotrate_' + iowrowid).val(sanitizeNumber(s.OTRate,2,true));
                                        $('#abs_'+rowid+'_type_'+absrowid+'_labotamt_' + iowrowid).val(sanitizeNumber(s.OTAmount,2,true));
                                        $('#abs_'+rowid+'_type_'+absrowid+'_labnetamt_' + iowrowid).val(sanitizeNumber(s.NetAmount,2,true));
                                    });
                                }
                                $('#abs_' + rowid + '_type_' + absrowid + '_rowid').val(iowrowid);
                            });
                            $('#CurAmount_' + rowid).val(sanitizeNumber(netTotal,2,true));
                        }
                        $('#abs_'+rowid+'_rowid').val(absrowid);
                    }
                    $lsListModal.modal('hide');
                    $('.loading_area').hide();
                }, error: function() {
                    $('#abs_'+rowid+'_table  > tbody.main').html('');
                    $('#abs_'+rowid+'_rowid').val(0);
                    $('#abs_'+rowid+'_deleteids').val('');
                    $('#lsListModal').modal('hide');
                    $('.loading_area').hide();
                }
            });
        } else {
            $('#abs_'+rowid+'_table  > tbody.main').html('');
            $('#abs_'+rowid+'_rowid').val(0);
            $('#abs_'+rowid+'_deleteids').val('');
            $('#lsListModal').modal('hide');
            $('.loading_area').hide();
        }
    }

    function calcLsType(x) {
        var idx = $(x)[0].id.split('_'),
            key = idx[1],
            rowid = idx[3],
            typerowid = idx[5];

        $('#abs_'+key+'_type_'+rowid+'_labamt_'+typerowid).val(sanitizeNumber(parseFloatVal($('#abs_'+key+'_type_'+rowid+'_labrate_'+typerowid).val()) * parseFloatVal($('#abs_'+key+'_type_'+rowid+'_labqty_'+typerowid).val()),2,true));
    }

    function showFormulaModal(id, isForceShow) {
        closeMainTr();
        var key = id.split('_')[1],
            formartId = parseFloatVal($('#FormatTypeId_' + key).val());

        var $curAmt = $('#CurAmount_' + key),
            curAmt = parseFloatVal($curAmt.val()),
            formula = $('#Formula_' + key).val();

        if(typeof isForceShow != 'undefined' && isForceShow && isBillEditable) {
            $('#btnRemoveFormula').hide();
            $('#FormulaModal').data('rowid', key).modal('show');
            $('#FormulaExpression').val(formula);
            $('#FormulaVal').val(curAmt);
            return;
        }

        if ($.inArray(formartId, arrReadOnlyFormats) != -1)
            return false;

        // if submitted or certified remove tooltip
        if(formula.length == 0 && isBillEditable) {
            removeTooltip();
            $curAmt.prop('readonly', false);
            $curAmt.after($confirmToolTipTemplate);
            $('#FormulaConfirmationToolTip').data('id', key);
            return;
        } else if (formula.length == 0 && !isBillEditable) {
            return;
        }

        $curAmt.prop('readonly', true);
        $('#btnRemoveFormula').show();
        $('#FormulaModal').data('rowid', key).modal('show');
        $('#FormulaExpression').val(formula);
        $('#FormulaVal').val(curAmt);
    }
    function removeTooltip() {
        $('#FormulaConfirmationToolTip').remove();
        $('#MSheetConfirmationToolTip').remove();
    }
    function setFormula() {
        var id = '#Formula_' + $('#FormulaConfirmationToolTip').data('id');
        $(id).val(0);
        showFormulaModal(id);
        removeTooltip();
    }
    function ApplyFormula() {
        FormulaCalc();

        if($('#FormulaExpression').hasClass('error')) {
            alert('Invalid expression');
            return false;
        }

        $('#FormulaModal').modal('hide');
    }
    function RemoveFormula() {
        var key = $('#FormulaModal').data('rowid');
        $('#CurAmount_' + key).val('');
        $('#Formula_' + key).val('');

        $('#FormulaModal').modal('hide');
        $('#CurAmount_' + key).trigger('change').focus();
    }
    function FormulaCalc() {
        var $FExpression = $("#FormulaExpression"),
            sFormula = $FExpression.val(),
            fvalue= 0,
            key = $('#FormulaModal').data('rowid'),
            $Formula = $('#Formula_' + key);
        if (sFormula.length > 0) {
            $Formula.val(sFormula);
            removeError($FExpression);
            try {
                fvalue = computeEval(formulaParser(sFormula, true));
            } catch (e) {
                showError($FExpression, 'Invalid Expression!');
                $("#FormulaVal").val('N/A');
                return false;
            }

            $('#CurAmount_' + key).val(sanitizeNumber(fvalue,2,true,true));
        }
        $("#FormulaVal").val(sanitizeNumber(fvalue));
        calcTotal();
    }

    <!--Handson Script-->
    var handsonTableData =  [[]],
        handsonTable = null,
        $HandsonTableWrapper = document.getElementById('HandsonTableWrapper'),
        HandsonTableSettings = {
            colHeaders:true,
            rowHeaders: true,
            contextMenu: true,
            minRows: 25,
            minCols: 10,
            minSpareRows: 1,
            stretchH: 'all',
            formulas: true,
            manualColumnResize: true,
            fixedRowsTop: 1,
            fixedRowsBottom: 1,
            manualRowResize: true,
            fillHandle: true,
            data: handsonTableData,
            beforeChange: function(changes, source) {
                if(source == 'paste') {
                    var changesJSON = JSON.parse(JSON.stringify(changes));
                    for(var i=0; i<changesJSON.length; i++) {
                        var row = changesJSON[i][0],
                            value = changesJSON[i][3];

                        if(value.indexOf('=') == -1)
                            return;

                        changes[i][3] = value.replace(/\d+/g, function(n){return  parseInt(row + 1, 10); });
                    }
                }
            },
            afterRender: function() {
                summationColumns();
            },
            cells: function (row, col, prop) {
                var cellProperties = {};

                if (row === 0) {
                    cellProperties.renderer = firstRowRenderer;
                }

                return cellProperties;
            }
        };
    function firstRowRenderer(instance, td, row, col, prop, value, cellProperties) {
        Handsontable.renderers.TextRenderer.apply(this, arguments);
        td.style.fontWeight = 'bold';
    }
    var summationColumn = '',
        selColumns = [],
        tempSelectedCol = [];
    function showHandsonTableModal(mtype, x, forceShowTable) {
        if(mtype == 1) {
            hideShow(x, 's', 'w');
        }
        var $x = $(x),
            spilts = $x[0].id.split('_'),
            absid = spilts[1],
            actid = spilts[3],
            rowid = spilts[5];

        var measurement = isNullCheck($.trim($('#abs_'+absid+'_act_'+actid+'_Measurement_'+rowid).val()), 'string');
        // if bill not editable and measurement empty
        if(typeof forceShowTable == 'undefined' && measurement == '' && !isBillEditable) {
            return;
        }

        if(typeof forceShowTable == 'undefined' && measurement == '' && isBillEditable) {
            $x.prop('readonly', false);
            var $qty = $('#abs_'+absid+'_act_'+actid +'_qty_'+rowid);
            // show prompt
            removeTooltip();
            $qty.prop('readonly', false);
            $qty.after($mSheetConfirmToolTipTemplate);
            $('#MSheetConfirmationToolTip').data('absid', absid).data('actid', actid).data('rowid', rowid);
        } else {
            $x.prop('readonly', true);

            if(measurement == '')
                handsonTableData = [[]];
            else
                handsonTableData = $.parseJSON(measurement);

            summationColumn = $.trim($('#abs_'+absid+'_act_'+actid +'_CellName_' + rowid).val());
            selColumns = ($.trim($('#abs_'+absid+'_act_'+actid +'_SelectedColumns_' + rowid).val())).split(',');
            tempSelectedCol = [];
            renderHandsonTable();

            $('#ExcelTemplate').find('option:first-child').prop('selected', true).siblings('option').removeAttr('selected');
            $formWrapper.hide();
            $HandsonWrapper.data('absid', absid).data('actid', actid).data('rowid', rowid).fadeIn();
        }
    }
    // Measurement Sheet toptip
    function setMSheet() {
        var $tooltip = $('#MSheetConfirmationToolTip'),
            id = '#abs_'+$tooltip.data('absid')+'_act_'+$tooltip.data('actid')+'_Measurement_'+$tooltip.data('rowid');
        showHandsonTableModal('2', id, true);
        removeTooltip();
        handsonTableData  = [[]];
        renderHandsonTable();
    }
    function removeMSheet() {
        var rowid = $HandsonWrapper.data('rowid'),
            actid = $HandsonWrapper.data('actid'),
            absid = $HandsonWrapper.data('absid'),
            $qty = $('#abs_'+absid+'_act_'+actid +'_qty_' + rowid);
        $qty.val('');
        $('#abs_'+absid+'_act_'+actid +'_Measurement_' + rowid).val('');
        $HandsonWrapper.hide();
        $formWrapper.fadeIn();
        $qty.focus();
    }
    document.addEventListener("DOMContentLoaded", function() {
        handsonTable = new Handsontable($HandsonTableWrapper, HandsonTableSettings);
    });

    function updateMSheet() {
        var $totalcolumns = $('#totalcolumns'),
            columns = $totalcolumns.val();

        if(columns == null) {
            alert('Choose aleast one Column!');
            return false;
        }

        var $checkedColumn = $('input[type=radio][name=summationColumns]:checked');
        if($checkedColumn.length == 0) {
            alert('Summation Column is Required!');
            return false;
        }

        var selColumn = $checkedColumn.val(),
            total = $checkedColumn.data('total');


        var rowid = $HandsonWrapper.data('rowid'),
            absid = $HandsonWrapper.data('absid'),
            actid = $HandsonWrapper.data('actid'),
            data = filterArray(handsonTable.getData()),
            jsonData = JSON.stringify(data);
        if(jsonData == '[]')
            jsonData = '[[]]';

        $('#abs_'+absid+'_act_'+actid +'_Measurement_' + rowid).val(jsonData);
        $('#abs_'+absid+'_act_'+actid +'_qty_' + rowid).val(total).trigger('change');
        $('#abs_'+absid+'_act_'+actid +'_CellName_' + rowid).val(selColumn);
        $('#abs_'+absid+'_act_'+actid +'_SelectedColumns_' + rowid).val(columns.join());
        $HandsonWrapper.hide();
        $formWrapper.fadeIn();
    }

    function hideHandsonWrapper(){
        $HandsonWrapper.hide();
        $formWrapper.fadeIn();
    }
    // Filter all empty rows
    function filterArray(arr) {
        var checkNull = true;
        arr =  $.grep($(arr).toArray().reverse(), function (n,i) {
            var isValid = false;

            if(!checkNull)
                return true;

            $.each(n, function(j,obj) {
                if(obj != null) {
                    isValid = true;
                    checkNull = false;
                    return false;
                }
            });

            return isValid;
        });
        return arr.reverse();
    }

    function getExcelTemplate(x) {
        var templateId = $(x).val();
        $.ajax({
            url:getBaseURL()+ 'cb/clientbilling/getexceltemplate',
            type:"post",
            data: {'TemplateId': templateId, csrf: "<?php echo isset($csrf)?$csrf:''; ?>"},
            async: false,
            success:function(data, textStatus, jqXHR){
                if(data != '') {
                    var json_data = $.parseJSON(data);
                    handsonTableData = $.parseJSON(json_data.Description);
                    selColumns = ($.trim(json_data.SelectedColumns)).split(',');
                    summationColumn = json_data.CellName;
                } else {
                    handsonTableData = [[]];
                    selColumns = [];
                    summationColumn = '';
                }

                renderHandsonTable();
            }, error:function(jqXHR, textStatus, errorThrown){
                return false;
            }
        });
    }

    function renderHandsonTable() {
        if(typeof handsonTableData != 'object')
            handsonTableData  = [[]];

        handsonTable.loadData(handsonTableData);
        handsonTable.render();

        summationColumns();
    }

    function summationColumns(calcOnly) {
        if(handsonTable == null)
            return;

        var $totalColumns = $('#totalcolumns'),
            rowCount = handsonTable.countRows();

        if(typeof calcOnly == 'undefined') {
            //set columns header
            var options = '';
            $.each(handsonTable.getDataAtRow (0), function (i, obj) {
                var value = $.trim(obj),
                    sel = '';
                if (value.length == 0 || value == "" || value.indexOf('=') != -1)
                    return;

                var colName = handsonTable.getColHeader(i);
                if($.inArray(colName, tempSelectedCol) != -1 || $.inArray(colName, selColumns) != -1)
                    sel = 'selected';

                options += '<option value="' + colName + '" '+sel +'>' + value + '</option>';
            });
            $totalColumns.html(options).triggerHandler('change');
        }

        // calculate columns
        var arr_columns = $totalColumns.find(':selected');
        if(arr_columns.length == 0) {
            $('#summationColumnsWrapper').html('');
            return;
        }

        // selected summation columns
        tempSelectedCol = [];
        var totalLabels = '';
        $.each(arr_columns, function(i, obj) {
            var $this = $(this),
                col = $this.val(),
                columnData = handsonTable.plugin.helper.cellRangeValue(col+'1',col+ rowCount),
                total = 0;

            // push to temp sel col
            tempSelectedCol.push(col);

            // selected columns datas
            $.each(columnData[0], function(j, val) {
                if(/^[0-9\.]+$/.test(val) == false)
                    return;

                total += parseFloatVal(val);
            });

            if(total == '')
                total = 0;

            if(col == summationColumn) {
                totalLabels += '<label class="btn btn-primary tot-dis active">'
                + '<input type="radio" name="summationColumns" autocomplete="off" value="'+col+'" data-total="'+total+'" checked><label>'+ $this.html() +' </label><p>'+total+'</p>'
                + '</label>';
            } else {
                totalLabels += '<label class="btn btn-primary tot-dis">'
                + '<input type="radio" name="summationColumns" autocomplete="off" value="'+col+'" data-total="'+total+'"><label>'+ $this.html() +' </label><p>'+total+'</p>'
                + '</label>';
            }
        });
        $('#summationColumnsWrapper').html(totalLabels);
    }

    function getAccount(aTypeId, rowid)
    {
        $.post(getBaseURL()+'wpm/workbill/get-account', { aTypeId: aTypeId },
            function(data) {
                var tmp_accMaster = JSON.parse(data);
                if(tmp_accMaster.length == 1){
                    $('#Account_' + rowid).val(tmp_accMaster[0].value);
                    $('#AccountId_' + rowid).val(tmp_accMaster[0].data);
                }
                bindAccountAutocomplete(tmp_accMaster);
            });
    }

    $('.content_wrapper').on('click','.accountSuggest',function (e) {
        var $this = $(this);
        var rowid = $this[0].id.split('_')[1];
        getAccount($('#AccountTypeId_' + rowid).val(), rowid);
    });

    function bindAccountAutocomplete(tmp_accMaster) {
        $('#billAbstractTable .accountSuggest').autocomplete({
            lookup: tmp_accMaster,
            lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                if (queryLowerCase == '*') {
                    return suggestion.value;
                } else {
                    var re = new RegExp($.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                    return re.test(suggestion.value);
                }
            }, onSelect: function (suggestion) {
                if (suggestion) {
                    var $this = $(this);
                    var rowid = $this[0].id.split('_')[1];
                    $('#AccountId_' + rowid).val(suggestion.data);
                }
            }, onSearchStart: function (suggestion) {
                var rowid = $(this)[0].id.split('_')[1];
                $('#AccountId_' + rowid).val('');
            }, onSearchComplete: function (query, suggestions) {
                if(!suggestions.length) {
                    var rowid = $(this)[0].id.split('_')[1];
                    $('#AccountId_' + rowid).val('');
                }
            }
        });
    }

    function submitForm() {
        if(!validateLength($('#BillDate')))
            return false;

        if(!validateLength($('#RefDate')))
            return false;

        if(!validateLength($('#FromDate')))
            return false;

        if(!validateLength($('#ToDate')))
            return false;

        if(!validateLength($('#CCBillNo')))
            return false;

        if(!validateLength($('#CompBillNo')))
            return false;

        if(!validateLength($('#RefNo')))
            return false;

        var rows = $('#rowid').val();
        for (var k = 1; k <= rows; k++) {
            if ($('#AccountTypeId_' + k).val() != 0 && $('#Header_' + k).val() == 0 && parseFloatVal($('#CurAmount_' + k).val()) != 0 && $('#AccountId_' + k).val() == '') {
                showError($('#Account_' + k), 'required');
                scrTop($('#Account_' + k));
                return false;
            } else {
                removeError($('#Account_' + k));
            }
        }

        // check for error(s)
        var $err_inputs = $('.error');
        if($err_inputs.length != 0) {
            alert('Kindly notice the errors');
            $.each($err_inputs, function () {
                var $this = $(this),
                    $subTr = $this.closest('.subTr'),
                    $subDivTr = $subTr.closest('.subDiv').parents('.subTr');

                if(!$subTr.is(':visible')) {
                    $subTr.prev('tr').find('.mainTr').trigger('click');
                }

                // SubDivs Parent
                if($subDivTr.length != 0 && !$subDivTr.is(':visible')) {
                    $subDivTr.prev('tr').find('.mainTr').trigger('click');
                }
            });
            return false;
        }
        $('#formWrapper').submit();
    }

    function scrTop(divId)
    {
        $('html, body').animate({
            scrollTop: divId.offset().top-100
        }, 'slow');
    }

    function validateLength($input) {
        if($.trim($input.val()).length == 0) {
            showError($input, 'required');
            scrTop($input);
            return false;
        }

        removeError($input);
        return true;
    }

    if($('#wbTypeId').val() != '') {
        $.post(getBaseURL() + 'wpm/labourstrength/get-comp-cc-no', {
                typeId: $('#wbTypeId').val(),
                ccId: $('#CostCentreId').val()
            },
            function (data) {
                var vNo = data.split('###');
                $('#CCBillNo').val($.trim(vNo[0]));
                $('#CompBillNo').val($.trim(vNo[1]));
                if($.trim(vNo[0]) != '')
                    $('#CCBillNo').prop('readonly', true);
                if($.trim(vNo[1]) != '')
                    $('#CompBillNo').prop('readonly', true);
            });
    }

    function bindWithoutWbs(xro,xabs,xty) {
        if(xty == 1) {
            var rowid = $(x)[0].id.split('_')[1];
        } else if(xty == 2) {
            var rowid = xro;
            var absrowid = xabs;
        }
        var wiowId = $('#abs_' + rowid + '_iowid_' + absrowid).val();
        var resId = $('#abs_' + rowid + '_resourceid_' + absrowid).val();

        var woeQty = 0;
        var wpeQty = 0;
        var wbeQty = 0;

        if(WorkType == 'activity') {
            wiowId = 0;
        } else if (WorkType == 'iow') {
            resId = 0;
        }

        $.ajax({
            url: getBaseURL() + 'wpm/workbill/entry',
            type: "post",
            data: {'ResourceId': resId, 'ccId': $('#CostCentreId').val(), 'woRegId': $('#WORegisterId').val(), 'IOWId': wiowId, 'Type': 'getqtywio'},
            async: false,
            success: function (data, textStatus, jqXHR) {
                if(jqXHR.status == 200) {
                    data = JSON.parse(data);
                    woeQty = data.WOQty;
                    wpeQty = data.WPQty;
                    wbeQty = data.WBQty;
                    if (woeQty == null) {
                        woeQty = 0;
                    }
                    if (wpeQty == null) {
                        wpeQty = 0;
                    }
                    if (wbeQty == null) {
                        wbeQty = 0;
                    }
                    $('#abs_' + rowid + '_workorderqty_' + absrowid).html(parseFloatVal(woeQty));
                    $('#abs_' + rowid + '_wpeqty_' + absrowid).html(parseFloatVal(wpeQty));
                    $('#abs_' + rowid + '_totbilledqty_' + absrowid).html(parseFloatVal(wbeQty));
                }
                $('.loading_area').hide();
            }, error: function (jqXHR, textStatus, errorThrown) {
                $('.loading_area').hide();
            }
        });
    }

    function hideShow(x,hsType,wiType)
    {
        var $x = $(x);
        var ids = $x[0].id.split('_');
        var rowid = ids[1];

        if(wiType == 'w') {
            var absrowid = ids[3];
            var iowrowid = ids[5];

            if (hsType == 's')
                $('#abs_' + rowid + '_act_' + absrowid + '_ewbqty_' + iowrowid).show();
            else if (hsType == 'h')
                $('#abs_' + rowid + '_act_' + absrowid + '_ewbqty_' + iowrowid).hide();
        } else if(wiType == 'wo') {
            if (hsType == 's')
                $('#ewbqty_' + rowid).show();
            else if (hsType == 'h')
                $('#ewbqty_' + rowid).hide();
        }
    }

    function calcQuantityWOWbs(x)
    {
        var $x = $(x);
        var ids = $x[0].id.split('_');
        var rowid = ids[1];
        var absrowid = ids[3];

        var chkQty = 0;
        var thisQty = parseFloat($('#abs_' + rowid + '_qty_' + absrowid).val());
        var woeQty = parseFloat($('#abs_' + rowid + '_workorderqty_' + absrowid).html());
        var wpeQty = parseFloat($('#abs_' + rowid + '_wpeqty_' + absrowid).html());
        var totbillQty = parseFloat($('#abs_' + rowid + '_totbilledqty_' + absrowid).html());

        if(wpeQty != 0)
            chkQty = (wpeQty - totbillQty);
        else
            chkQty = (woeQty - totbillQty);

        //if(woeQty >= thisQty || wpeQty >= thisQty) {
        if(chkQty >= thisQty) {
            $('#abs_' + rowid + '_qty_' + absrowid).val(sanitizeNumber(thisQty, 3));
            calcAbs(x);
        } else {
            if($('#BillRegisterId').val() != 0) {
                $('#abs_' + rowid + '_qty_' + absrowid).val($('#abs_' + rowid + '_actualqty_' + absrowid).val());
            } else {
                $('#abs_' + rowid + '_qty_' + absrowid).val('');
            }
            alert('Qty exceeds');
        }
    }

    function onFocusOther()
    {
        closeMainTr();
    }

    function closeMainTr()
    {
        var $mainTr = $(".mainTr");
        $.each($mainTr, function () {
            $(this).closest("tr").next(".subTr").find(".subDiv").slideUp("slow");
            $(this).closest("tr").next(".subTr").slideUp("slow");
            $(this).find("i").removeClass("tform");
        });
    }
</script>